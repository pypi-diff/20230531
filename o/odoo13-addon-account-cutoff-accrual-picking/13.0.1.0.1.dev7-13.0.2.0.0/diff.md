# Comparing `tmp/odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7-py3-none-any.whl.zip` & `tmp/odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,26 +1,26 @@
-Zip file size: 185357 bytes, number of entries: 24
--rw-r--r--  2.0 unx     4529 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/README.rst
--rw-r--r--  2.0 unx       21 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/__init__.py
--rw-r--r--  2.0 unx      906 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/__manifest__.py
--rw-r--r--  2.0 unx     4063 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/i18n/account_cutoff_accrual_picking.pot
--rw-r--r--  2.0 unx     4858 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/i18n/de.po
--rw-r--r--  2.0 unx    68628 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_done.jpg
--rw-r--r--  2.0 unx    70829 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_draft.jpg
--rw-r--r--  2.0 unx    52323 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_journal_entry.jpg
--rw-r--r--  2.0 unx       85 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/models/__init__.py
--rw-r--r--  2.0 unx    12547 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/models/account_cutoff.py
--rw-r--r--  2.0 unx      810 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/models/company.py
--rw-r--r--  2.0 unx      562 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/models/res_config_settings.py
--rw-r--r--  2.0 unx      124 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/readme/CONFIGURE.rst
--rw-r--r--  2.0 unx       50 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx     1422 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx     9455 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/static/description/icon.png
--rw-r--r--  2.0 unx    14006 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/static/description/index.html
--rw-r--r--  2.0 unx     5975 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/static/src/img/icon.png
--rw-r--r--  2.0 unx     1158 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/views/account_cutoff.xml
--rw-r--r--  2.0 unx      923 b- defN 20-May-28 02:37 odoo/addons/account_cutoff_accrual_picking/views/res_config_settings.xml
--rw-r--r--  2.0 unx     5128 b- defN 20-May-28 02:38 odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 20-May-28 02:38 odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 20-May-28 02:38 odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2948 b- defN 20-May-28 02:38 odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/RECORD
-24 files, 261447 bytes uncompressed, 180221 bytes compressed:  31.1%
+Zip file size: 187453 bytes, number of entries: 24
+-rw-r--r--  2.0 unx     5783 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/__init__.py
+-rw-r--r--  2.0 unx      900 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/__manifest__.py
+-rw-r--r--  2.0 unx     5145 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/i18n/account_cutoff_accrual_picking.pot
+-rw-r--r--  2.0 unx     4858 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/i18n/de.po
+-rw-r--r--  2.0 unx    68628 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_done.jpg
+-rw-r--r--  2.0 unx    70829 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_draft.jpg
+-rw-r--r--  2.0 unx    52323 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/images/accrued_expense_journal_entry.jpg
+-rw-r--r--  2.0 unx       85 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/models/__init__.py
+-rw-r--r--  2.0 unx    20792 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/models/account_cutoff.py
+-rw-r--r--  2.0 unx     1051 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/models/company.py
+-rw-r--r--  2.0 unx      583 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/models/res_config_settings.py
+-rw-r--r--  2.0 unx      124 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/readme/CONFIGURE.rst
+-rw-r--r--  2.0 unx       50 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx     2700 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/static/description/icon.png
+-rw-r--r--  2.0 unx    15383 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/static/description/index.html
+-rw-r--r--  2.0 unx     5975 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/static/src/img/icon.png
+-rw-r--r--  2.0 unx      868 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/views/account_cutoff.xml
+-rw-r--r--  2.0 unx     1172 b- defN 23-May-30 17:41 odoo/addons/account_cutoff_accrual_picking/views/res_config_settings.xml
+-rw-r--r--  2.0 unx     6417 b- defN 23-May-30 17:41 odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-30 17:41 odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-May-30 17:41 odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2929 b- defN 23-May-30 17:41 odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/RECORD
+24 files, 276168 bytes uncompressed, 182357 bytes compressed:  34.0%
```

## zipnote {}

```diff
@@ -54,20 +54,20 @@
 
 Filename: odoo/addons/account_cutoff_accrual_picking/views/account_cutoff.xml
 Comment: 
 
 Filename: odoo/addons/account_cutoff_accrual_picking/views/res_config_settings.xml
 Comment: 
 
-Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/METADATA
+Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/WHEEL
+Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/top_level.txt
+Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/RECORD
+Filename: odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/account_cutoff_accrual_picking/README.rst

```diff
@@ -1,10 +1,10 @@
-===============================
-Account Cut-off Accrual Picking
-===============================
+=======================
+Account Cut-off Picking
+=======================
 
 .. !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
@@ -21,27 +21,37 @@
     :alt: Translate me on Weblate
 .. |badge5| image:: https://img.shields.io/badge/runbot-Try%20me-875A7B.png
     :target: https://runbot.odoo-community.org/runbot/89/13.0
     :alt: Try me on Runbot
 
 |badge1| |badge2| |badge3| |badge4| |badge5| 
 
-This module generates expense and revenue accruals based on the status of
-orders, pickings and invoices.
+This module generates expense/revenue accruals and prepaid expense/revenue based on the status of orders, pickings and invoices. The module is named *account_cutoff_accrual_picking* because it initially only supported accruals ; support for prepaid expense/revenue was added later (it should be renamed in later versions).
 
 To understand the behavior of this module, let's take the example of an expense accrual. When you click on the button *Re-Generate Lines* of an *Expense Accrual*:
 
-1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date* (for performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 3 months will not be taken into account (this limit can be easily changed via a method inheritance). It will go to the stock moves of this picking and see if they are linked to a purchase order line.
+1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date*. For performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the stock moves of those pickings and see if they are linked to a purchase order line.
 2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential expense accrual.
 3. For each of these purchase order lines, Odoo will:
 
    - scan the related stock moves in *done* state and check their transfer date,
-   - scan the related invoices lines in *open* or *paid* state and check their invoice date.
+   - scan the related invoices lines and check their invoice date.
 
-4. If, for a particular purchase order line, the quantity of products shipped before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+4. If, for a particular purchase order line, the quantity of products received before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+
+Now, let's take the example of a prepaid expense. When you click on the button *Re-Generate Lines* of a *Prepaid Expense*:
+
+1. Odoo will look for all vendor bills dated before (or equal to) *Cut-off Date*. For performance reasons, by default, the vendor bills dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the invoice lines of those vendor bills and see if they are linked to a purchase order line.
+2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential prepaid expense.
+3. For each of these purchase order lines, Odoo will:
+
+   - scan the related stock moves in *done* state and check their transfer date,
+   - scan the related invoices lines and check their invoice date.
+
+4. If, for a particular purchase order line, the quantity of products invoiced before the cutoff-date (or on the same day) minus the quantity of products received before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
 
 This module should work well with multiple units of measure (including products purchased and invoiced in different units of measure) and in multi-currency.
 
 **Table of contents**
 
 .. contents::
    :local:
```

## odoo/addons/account_cutoff_accrual_picking/__manifest__.py

```diff
@@ -1,17 +1,17 @@
 # Copyright 2013-2020 Akretion France (http://www.akretion.com)
 # @author Alexis de Lattre <alexis.delattre@akretion.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
 {
-    "name": "Account Cut-off Accrual Picking",
-    "version": "13.0.1.0.0",
+    "name": "Account Cut-off Picking",
+    "version": "13.0.2.0.0",
     "category": "Accounting",
     "license": "AGPL-3",
-    "summary": "Accrued expense & accrued revenue from pickings",
+    "summary": "Accrued and prepaid expense/revenue from pickings",
     "author": "Akretion,Odoo Community Association (OCA)",
     "maintainers": ["alexis-via"],
     "website": "https://github.com/OCA/account-closing",
     "depends": ["account_cutoff_accrual_base", "purchase_stock", "sale_stock"],
     "data": ["views/res_config_settings.xml", "views/account_cutoff.xml"],
     "images": [
         "images/accrued_expense_draft.jpg",
```

## odoo/addons/account_cutoff_accrual_picking/i18n/account_cutoff_accrual_picking.pot

```diff
@@ -12,101 +12,129 @@
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: \n"
 "Plural-Forms: \n"
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "%s line ID %d"
+msgid " • %s %s (picking %s transfered on %s from %s to %s)"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "%s line ID %d: %s"
+msgid "%s: %s"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: model:ir.model,name:account_cutoff_accrual_picking.model_account_cutoff
 msgid "Account Cut-off"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
+#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_account_cutoff__picking_interval_days
+#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_res_company__default_cutoff_accrual_picking_interval_days
+#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_res_config_settings__dft_cutoff_accrual_picking_interval_days
+msgid "Analysis Interval"
+msgstr ""
+
+#. module: account_cutoff_accrual_picking
+#: model:ir.model,name:account_cutoff_accrual_picking.model_res_company
+msgid "Companies"
+msgstr ""
+
+#. module: account_cutoff_accrual_picking
+#: model:ir.model,name:account_cutoff_accrual_picking.model_res_config_settings
+msgid "Config Settings"
+msgstr ""
+
+#. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "Accrued Expense Tax Account"
+msgid ""
+"Missing expense account on product '%s' or on its related product category "
+"'%s'."
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "Accrued Revenue Tax Account"
+msgid ""
+"Missing income account on product '%s' or on its related product category "
+"'%s'."
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
-#: model:ir.model,name:account_cutoff_accrual_picking.model_res_company
-msgid "Companies"
+#: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
+#, python-format
+msgid "Pre-cutoff delivered quantity details:"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
-#: model:ir.model,name:account_cutoff_accrual_picking.model_res_config_settings
-msgid "Config Settings"
+#: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
+#, python-format
+msgid "Pre-cutoff delivered quantity minus invoiced quantity:"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "Invoice %s line ID %d"
+msgid "Pre-cutoff delivered quantity:"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid "Missing '%s' on tax '%s'."
+msgid "Pre-cutoff invoiced quantity details:"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
-msgid ""
-"Missing expense account on product '%s' or on its related product category "
-"'%s'."
+msgid "Pre-cutoff invoiced quantity minus delivered quantity:"
+msgstr ""
+
+#. module: account_cutoff_accrual_picking
+#: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
+#, python-format
+msgid "Pre-cutoff invoiced quantity:"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
 #, python-format
 msgid ""
-"Missing income account on product '%s' or on its related product category "
-"'%s'."
+"Purchase order %s confirmed on %s\n"
+"Purchase Order Line: %s (ordered qty: %s %s)"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
-#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_account_cutoff__picking_interval_days
-#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_res_company__default_cutoff_accrual_picking_interval_days
-#: model:ir.model.fields,field_description:account_cutoff_accrual_picking.field_res_config_settings__dft_cutoff_accrual_picking_interval_days
-msgid "Picking Analysis Interval"
+#: code:addons/account_cutoff_accrual_picking/models/account_cutoff.py:0
+#, python-format
+msgid ""
+"Sale order %s confirmed on %s\n"
+"Sale Order Line: %s (ordered qty: %s %s)"
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: model:ir.model.constraint,message:account_cutoff_accrual_picking.constraint_account_cutoff_picking_interval_days_positive
 #: model:ir.model.constraint,message:account_cutoff_accrual_picking.constraint_res_company_cutoff_picking_interval_days_positive
-msgid ""
-"The value of the field 'Picking Analysis Interval' must be strictly "
-"positive."
+msgid "The value of the field 'Analysis Interval' must be strictly positive."
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: model:ir.model.fields,help:account_cutoff_accrual_picking.field_account_cutoff__picking_interval_days
 #: model:ir.model.fields,help:account_cutoff_accrual_picking.field_res_company__default_cutoff_accrual_picking_interval_days
 #: model:ir.model.fields,help:account_cutoff_accrual_picking.field_res_config_settings__dft_cutoff_accrual_picking_interval_days
 msgid ""
-"To generate the accruals based on pickings, Odoo will analyse all the "
-"pickings between the cutoff date and N days before. N is the Picking "
-"Analysis Interval."
+"To generate the accrual/prepaid revenue/expenses based on picking dates vs "
+"invoice dates, Odoo will analyse all the pickings/invoices from N days "
+"before the cutoff date up to the cutoff date. N is the Analysis Interval. If"
+" you increase the analysis interval, Odoo will take more time to generate "
+"the cutoff lines."
 msgstr ""
 
 #. module: account_cutoff_accrual_picking
 #: model_terms:ir.ui.view,arch_db:account_cutoff_accrual_picking.account_cutoff_form
 #: model_terms:ir.ui.view,arch_db:account_cutoff_accrual_picking.res_config_settings_view_form
 msgid "days"
 msgstr ""
```

### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

## odoo/addons/account_cutoff_accrual_picking/models/account_cutoff.py

```diff
@@ -1,298 +1,482 @@
 # Copyright 2013-2020 Akretion France (http://www.akretion.com/)
 # @author: Alexis de Lattre <alexis.delattre@akretion.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
+from datetime import datetime
+
+import pytz
 from dateutil.relativedelta import relativedelta
 
 from odoo import _, api, fields, models
 from odoo.exceptions import UserError
 from odoo.tools import float_compare, float_is_zero
+from odoo.tools.misc import format_date, format_datetime, formatLang
 
 
 class AccountCutoff(models.Model):
     _inherit = "account.cutoff"
 
     picking_interval_days = fields.Integer(
-        string="Picking Analysis Interval",
+        string="Analysis Interval",
+        states={"done": [("readonly", True)]},
+        tracking=True,
         default=lambda self: self._default_picking_interval_days(),
-        help="To generate the accruals based on pickings, Odoo will "
-        "analyse all the pickings between the cutoff date and N "
-        "days before. N is the Picking Analysis Interval.",
+        help="To generate the accrual/prepaid revenue/expenses based on picking "
+        "dates vs invoice dates, Odoo will analyse all the pickings/invoices from "
+        "N days before the cutoff date up to the cutoff date. "
+        "N is the Analysis Interval. If you increase the analysis interval, "
+        "Odoo will take more time to generate the cutoff lines.",
     )
 
     _sql_constraints = [
         (
             "picking_interval_days_positive",
             "CHECK(picking_interval_days > 0)",
-            "The value of the field 'Picking Analysis Interval' must "
-            "be strictly positive.",
+            "The value of the field 'Analysis Interval' must be strictly positive.",
         )
     ]
 
     @api.model
     def _default_picking_interval_days(self):
-        return self.env.user.company_id.default_cutoff_accrual_picking_interval_days
+        return self.env.company.default_cutoff_accrual_picking_interval_days
 
     def picking_prepare_cutoff_line(self, vdict, account_mapping):
-        ato = self.env["account.tax"]
         dpo = self.env["decimal.precision"]
-        assert self.cutoff_type in (
-            "accrued_expense",
-            "accrued_revenue",
-        ), "The field 'cutoff_type' has a wrong value"
         qty_prec = dpo.precision_get("Product Unit of Measure")
-        cur_rprec = vdict["currency"].rounding
-        qty = vdict["precut_delivered_qty"] - vdict["precut_invoiced_qty"]
-        if float_is_zero(qty, precision_digits=qty_prec):
+        if self.cutoff_type in ("accrued_expense", "accrued_revenue"):
+            qty = vdict["precut_delivered_qty"] - vdict["precut_invoiced_qty"]
+            qty_label = _("Pre-cutoff delivered quantity minus invoiced quantity:")
+        elif self.cutoff_type in ("prepaid_expense", "prepaid_revenue"):
+            qty = vdict["precut_invoiced_qty"] - vdict["precut_delivered_qty"]
+            qty_label = _("Pre-cutoff invoiced quantity minus delivered quantity:")
+
+        if float_compare(qty, 0, precision_digits=qty_prec) <= 0:
             return False
 
         company_currency = self.company_currency_id
         currency = vdict["currency"]
-        sign = self.cutoff_type == "accrued_expense" and -1 or 1
+        sign = self.cutoff_type in ("accrued_expense", "prepaid_revenue") and -1 or 1
         amount = qty * vdict["price_unit"] * sign
         amount_company_currency = vdict["currency"]._convert(
             amount, company_currency, self.company_id, self.cutoff_date
         )
 
-        tax_line_ids = []
-        tax_res = vdict["taxes"].compute_all(
-            vdict["price_unit"],
-            currency=currency,
-            quantity=qty,
-            product=vdict["product"],
-            partner=vdict["partner"],
-        )
-        for tax_line in tax_res["taxes"]:
-            tax = ato.browse(tax_line["id"])
-            if float_is_zero(tax_line["amount"], precision_rounding=cur_rprec):
-                continue
-            if self.cutoff_type == "accrued_expense":
-                tax_accrual_account_id = tax.account_accrued_expense_id.id
-                tax_account_field_label = _("Accrued Expense Tax Account")
-            elif self.cutoff_type == "accrued_revenue":
-                tax_accrual_account_id = tax.account_accrued_revenue_id.id
-                tax_account_field_label = _("Accrued Revenue Tax Account")
-            if not tax_accrual_account_id:
-                raise UserError(
-                    _("Missing '%s' on tax '%s'.")
-                    % (tax_account_field_label, tax.display_name)
-                )
-            tax_amount = tax_line["amount"] * sign
-            tax_accrual_amount = currency._convert(
-                tax_amount, company_currency, self.company_id, self.cutoff_date
-            )
-            tax_line_ids.append(
-                (
-                    0,
-                    0,
-                    {
-                        "tax_id": tax_line["id"],
-                        "base": tax_line["base"],
-                        "amount": tax_amount,
-                        "sequence": tax_line["sequence"],
-                        "cutoff_account_id": tax_accrual_account_id,
-                        "cutoff_amount": tax_accrual_amount,
-                    },
-                )
-            )
-
         # Use account mapping
         account_id = vdict["account_id"]
         if account_id in account_mapping:
-            accrual_account_id = account_mapping[account_id]
+            cutoff_account_id = account_mapping[account_id]
         else:
-            accrual_account_id = account_id
+            cutoff_account_id = account_id
+        uom_name = vdict["product"].uom_id.name
+        notes = vdict["notes"]
+        precut_delivered_qty_fl = formatLang(
+            self.env, vdict.get("precut_delivered_qty", 0), dp="Product Unit of Measure"
+        )
+        notes += (
+            "\n"
+            + _("Pre-cutoff delivered quantity:")
+            + " %s %s" % (precut_delivered_qty_fl, uom_name,)
+        )
+        if vdict.get("precut_delivered_logs"):
+            notes += (
+                "\n"
+                + _("Pre-cutoff delivered quantity details:")
+                + "\n%s" % "\n".join(vdict["precut_delivered_logs"])
+            )
+        precut_invoiced_qty_fl = formatLang(
+            self.env, vdict.get("precut_invoiced_qty", 0), dp="Product Unit of Measure"
+        )
+        notes += (
+            "\n"
+            + _("Pre-cutoff invoiced quantity:")
+            + " %s %s" % (precut_invoiced_qty_fl, uom_name)
+        )
+        if vdict.get("precut_invoiced_logs"):
+            notes += (
+                "\n"
+                + _("Pre-cutoff invoiced quantity details:")
+                + "\n%s" % "\n".join(vdict["precut_invoiced_logs"])
+            )
+        qty_fl = formatLang(self.env, qty, dp="Product Unit of Measure")
+        notes += "\n%s %s %s" % (qty_label, qty_fl, uom_name)
+
         vals = {
             "parent_id": self.id,
             "partner_id": vdict["partner"].id,
             "name": vdict["name"],
             "account_id": account_id,
-            "cutoff_account_id": accrual_account_id,
+            "cutoff_account_id": cutoff_account_id,
             "analytic_account_id": vdict["analytic_account_id"],
             "currency_id": vdict["currency"].id,
             "quantity": qty,
             "price_unit": vdict["price_unit"],
             "tax_ids": [(6, 0, vdict["taxes"].ids)],
             "amount": amount,
             "cutoff_amount": amount_company_currency,
-            "tax_line_ids": tax_line_ids,
             "price_origin": vdict.get("price_origin"),
+            "notes": notes,
         }
+
+        if (
+            self.cutoff_type in ("accrued_expense", "accrued_revenue")
+            and vdict["taxes"]
+            and self.company_id.accrual_taxes
+        ):
+            # vdict["price_unit"] is a price without tax,
+            # so I set handle_price_include=False
+            tax_compute_all_res = vdict["taxes"].compute_all(
+                vdict["price_unit"],
+                currency=currency,
+                quantity=qty * sign,
+                product=vdict["product"],
+                partner=vdict["partner"],
+                handle_price_include=False,
+            )
+            vals["tax_line_ids"] = self._prepare_tax_lines(
+                tax_compute_all_res, self.company_currency_id
+            )
         return vals
 
-    def order_line_update_oline_dict(self, order_line, order_type, oline_dict):
+    def order_line_update_oline_dict(
+        self, order_line, order_type, oline_dict, cutoff_datetime
+    ):
         assert order_line not in oline_dict
-        dpo = self.env["decimal.precision"]
-        qty_prec = dpo.precision_get("Product Unit of Measure")
-        # These fields have the same name on PO and SO
-        order = order_line.order_id
-        product = order_line.product_id
-        product_uom = product.uom_id
-        moves = order_line.move_ids
-        ilines = order_line.invoice_lines
+        order = order_line.order_id  # same on PO and SO
         oline_dict[order_line] = {
             "precut_delivered_qty": 0.0,  # in product_uom
+            "precut_delivered_logs": [],
             "precut_invoiced_qty": 0.0,  # in product_uom
-            "name": _("%s line ID %d: %s")
-            % (order.name, order_line.id, order_line.name),
-            "product": product,
+            "precut_invoiced_logs": [],
+            "name": _("%s: %s") % (order.name, order_line.name),
+            "product": order_line.product_id,
             "partner": order.partner_id.commercial_partner_id,
+            "notes": "",
+            "price_unit": 0.0,
+            "price_origin": False,
+            "currency": False,
+            "analytic_account_id": False,
+            "account_id": False,
+            "taxes": False,
         }
+        self.order_line_update_oline_dict_from_stock_moves(
+            order_line, order_type, oline_dict, cutoff_datetime
+        )
+        self.order_line_update_oline_dict_from_invoice_lines(
+            order_line, order_type, oline_dict, cutoff_datetime
+        )
+        if not oline_dict[order_line]["price_origin"]:
+            self.order_line_update_oline_dict_price_fallback(
+                order_line, order_type, oline_dict
+            )
+
+    def order_line_update_oline_dict_from_stock_moves(
+        self, order_line, order_type, oline_dict, cutoff_datetime
+    ):
+        wdict = oline_dict[order_line]
+        # These fields/methods have the same name on PO and SO
+        order = order_line.order_id
+        product = order_line.product_id
+        product_uom = product.uom_id
+        outgoing_moves, incoming_moves = order_line._get_outgoing_incoming_moves()
         if order_type == "purchase":
-            invoice_type = "in_invoice"
+            ordered_qty = order_line.product_uom._compute_quantity(
+                order_line.product_qty, product_uom
+            )
+            wdict["notes"] = _(
+                "Purchase order %s confirmed on %s\n"
+                "Purchase Order Line: %s (ordered qty: %s %s)"
+            ) % (
+                order.name,
+                format_datetime(self.env, order.date_approve),
+                order_line.name,
+                formatLang(self.env, ordered_qty, dp="Product Unit of Measure"),
+                product_uom.name,
+            )
         elif order_type == "sale":
-            invoice_type = "out_invoice"
-        for move in moves:
-            # TODO: improve comparaison of date and datetime
-            # for our friends far away from GMT
-            if move.state == "done" and move.date.date() <= self.cutoff_date:
-                move_qty = move.product_uom._compute_quantity(
-                    move.product_uom_qty, product_uom
+            ordered_qty = order_line.product_uom._compute_quantity(
+                order_line.product_uom_qty, product_uom
+            )
+            wdict["notes"] = _(
+                "Sale order %s confirmed on %s\n"
+                "Sale Order Line: %s (ordered qty: %s %s)"
+            ) % (
+                order.name,
+                format_datetime(self.env, order.date_order),
+                order_line.name,
+                formatLang(self.env, ordered_qty, dp="Product Unit of Measure"),
+                product_uom.name,
+            )
+        move_logs = []
+        for out_move in outgoing_moves.filtered(
+            lambda m: m.state == "done" and m.date <= cutoff_datetime
+        ):
+            sign = order_type == "purchase" and -1 or 1
+            move_qty = out_move.product_uom._compute_quantity(
+                out_move.quantity_done * sign, product_uom
+            )
+            move_logs.append((out_move, move_qty))
+        for in_move in incoming_moves.filtered(
+            lambda m: m.state == "done" and m.date <= cutoff_datetime
+        ):
+            sign = order_type == "sale" and -1 or 1
+            move_qty = in_move.product_uom._compute_quantity(
+                in_move.quantity_done * sign, product_uom
+            )
+            move_logs.append((in_move, move_qty))
+        move_logs_sorted = sorted(move_logs, key=lambda to_sort: to_sort[0].date)
+        for (move, move_qty_signed) in move_logs_sorted:
+            wdict["precut_delivered_qty"] += move_qty_signed
+            move_qty_signed_formatted = formatLang(
+                self.env, move_qty_signed, dp="Product Unit of Measure"
+            )
+            wdict["precut_delivered_logs"].append(
+                _(" • %s %s (picking %s transfered on %s from %s to %s)")
+                % (
+                    move_qty_signed_formatted,
+                    move.product_id.uom_id.name,
+                    move.picking_id.name or "none",
+                    format_datetime(self.env, move.date),
+                    move.location_id.display_name,
+                    move.location_dest_id.display_name,
                 )
-                oline_dict[order_line]["precut_delivered_qty"] += move_qty
-        price_origin = False
+            )
+
+    def order_line_update_oline_dict_from_invoice_lines(
+        self, order_line, order_type, oline_dict, cutoff_datetime
+    ):
+        wdict = oline_dict[order_line]
+        dpo = self.env["decimal.precision"]
+        qty_prec = dpo.precision_get("Product Unit of Measure")
+        move_type2label = dict(
+            self.env["account.move"].fields_get("type", "selection")["type"][
+                "selection"
+            ]
+        )
+        # These fields have the same name on PO and SO
+        product = order_line.product_id
+        product_uom = product.uom_id
+        if self.source_move_state == "posted":
+            ilines = order_line.invoice_lines.filtered(
+                lambda x: x.parent_state == "posted"
+            )
+        else:
+            ilines = order_line.invoice_lines.filtered(
+                lambda x: x.parent_state in ("draft", "posted")
+            )
         for iline in ilines:
             invoice = iline.move_id
-            if (
-                invoice.type == invoice_type
-                and float_compare(iline.quantity, 0, precision_digits=qty_prec) > 0
-            ):
+            if not float_is_zero(iline.quantity, precision_digits=qty_prec):
+                sign = invoice.type in ("out_refund", "in_refund") and -1 or 1
                 iline_qty_puom = iline.product_uom_id._compute_quantity(
-                    iline.quantity, product_uom
+                    iline.quantity * sign, product_uom
                 )
                 if invoice.date <= self.cutoff_date:
-                    oline_dict[order_line]["precut_invoiced_qty"] += iline_qty_puom
-                # Most recent invoice line used for price_unit, account,...
-                price_unit = iline.price_subtotal / iline_qty_puom
-                price_origin = _("Invoice %s line ID %d") % (invoice.name, iline.id)
-                currency = invoice.currency_id
-                account_id = iline.account_id.id
-                analytic_account_id = iline.analytic_account_id.id
-                taxes = iline.tax_ids
-        if not price_origin:
-            if order_type == "purchase":
-                oline_qty_puom = order_line.product_uom._compute_quantity(
-                    order_line.product_qty, product_uom
-                )
-                price_unit = order_line.price_subtotal / oline_qty_puom
-                price_origin = _("%s line ID %d") % (order.name, order_line.id)
-                currency = order.currency_id
-                analytic_account_id = order_line.account_analytic_id.id
-                taxes = order_line.taxes_id
-                account = product.product_tmpl_id._get_product_accounts()["expense"]
-                if not account:
-                    raise UserError(
-                        _(
-                            "Missing expense account on product '%s' or on its "
-                            "related product category '%s'."
+                    wdict["precut_invoiced_qty"] += iline_qty_puom
+                    iline_qty_puom_formatted = formatLang(
+                        self.env, iline_qty_puom, dp="Product Unit of Measure"
+                    )
+                    wdict["precut_invoiced_logs"].append(
+                        " • %s %s (%s %s dated %s)"
+                        % (
+                            iline_qty_puom_formatted,
+                            iline.product_id.uom_id.name,
+                            move_type2label[invoice.type],
+                            invoice.name,
+                            format_date(self.env, invoice.date),
                         )
-                        % (product.display_name, product.categ_id.display_name)
                     )
-                account_id = order.fiscal_position_id.map_account(account).id
-            elif order_type == "sale":
-                oline_qty_puom = order_line.product_uom._compute_quantity(
-                    order_line.product_uom_qty, product_uom
+                # Most recent invoice line used for price_unit, account,...
+                wdict["price_unit"] = iline.price_subtotal / iline_qty_puom
+                wdict["price_origin"] = invoice.name
+                wdict["currency"] = invoice.currency_id
+                wdict["account_id"] = iline.account_id.id
+                wdict["analytic_account_id"] = iline.analytic_account_id.id
+                wdict["taxes"] = iline.tax_ids
+
+    def order_line_update_oline_dict_price_fallback(
+        self, order_line, order_type, oline_dict
+    ):
+        wdict = oline_dict[order_line]
+        order = order_line.order_id
+        product = order_line.product_id
+        if order_type == "purchase":
+            oline_qty_puom = order_line.product_uom._compute_quantity(
+                order_line.product_qty, product.uom_id
+            )
+            wdict["price_unit"] = order_line.price_subtotal / oline_qty_puom
+            wdict["price_origin"] = order.name
+            wdict["currency"] = order.currency_id
+            wdict["analytic_account_id"] = order_line.account_analytic_id.id
+            wdict["taxes"] = order_line.taxes_id
+            account = product.product_tmpl_id._get_product_accounts()["expense"]
+            if not account:
+                raise UserError(
+                    _(
+                        "Missing expense account on product '%s' or on its "
+                        "related product category '%s'."
+                    )
+                    % (product.display_name, product.categ_id.display_name)
                 )
-                price_unit = order_line.price_subtotal / oline_qty_puom
-                price_origin = "%s line ID %d" % (order.name, order_line.id)
-                currency = order.currency_id
-                analytic_account_id = order.analytic_account_id.id
-                taxes = order_line.tax_id
-                account = product.product_tmpl_id._get_product_accounts()["income"]
-                if not account:
-                    raise UserError(
-                        _(
-                            "Missing income account on product '%s' or on its "
-                            "related product category '%s'."
-                        )
-                        % (product.display_name, product.categ_id.display_name)
+            wdict["account_id"] = order.fiscal_position_id.map_account(account).id
+        elif order_type == "sale":
+            oline_qty_puom = order_line.product_uom._compute_quantity(
+                order_line.product_uom_qty, product.uom_id
+            )
+            wdict["price_unit"] = order_line.price_subtotal / oline_qty_puom
+            wdict["price_origin"] = order.name
+            wdict["currency"] = order.currency_id
+            wdict["analytic_account_id"] = order.analytic_account_id.id
+            wdict["taxes"] = order_line.tax_id
+            account = product.product_tmpl_id._get_product_accounts()["income"]
+            if not account:
+                raise UserError(
+                    _(
+                        "Missing income account on product '%s' or on its "
+                        "related product category '%s'."
                     )
-                account_id = order.fiscal_position_id.map_account(account).id
-
-        oline_dict[order_line].update(
-            {
-                "price_unit": price_unit,
-                "price_origin": price_origin,
-                "currency": currency,
-                "analytic_account_id": analytic_account_id,
-                "account_id": account_id,
-                "taxes": taxes,
-            }
-        )
+                    % (product.display_name, product.categ_id.display_name)
+                )
+            wdict["account_id"] = order.fiscal_position_id.map_account(account).id
 
-    def stock_move_update_oline_dict(self, move_line, oline_dict):
+    def stock_move_update_oline_dict(self, move_line, oline_dict, cutoff_datetime):
         dpo = self.env["decimal.precision"]
         qty_prec = dpo.precision_get("Product Unit of Measure")
         if self.cutoff_type == "accrued_expense":
             if (
                 move_line.purchase_line_id
                 and move_line.purchase_line_id not in oline_dict
                 and not float_is_zero(
                     move_line.purchase_line_id.product_qty, precision_digits=qty_prec
                 )
             ):
                 self.order_line_update_oline_dict(
-                    move_line.purchase_line_id, "purchase", oline_dict
+                    move_line.purchase_line_id, "purchase", oline_dict, cutoff_datetime
                 )
         elif self.cutoff_type == "accrued_revenue":
             if (
                 move_line.sale_line_id
                 and move_line.sale_line_id not in oline_dict
                 and not float_is_zero(
                     move_line.sale_line_id.product_uom_qty, precision_digits=qty_prec
                 )
             ):
                 self.order_line_update_oline_dict(
-                    move_line.sale_line_id, "sale", oline_dict
+                    move_line.sale_line_id, "sale", oline_dict, cutoff_datetime
+                )
+
+    def invoice_line_update_oline_dict(self, inv_line, oline_dict, cutoff_datetime):
+        dpo = self.env["decimal.precision"]
+        qty_prec = dpo.precision_get("Product Unit of Measure")
+        if self.cutoff_type == "prepaid_expense":
+            if (
+                inv_line.purchase_line_id
+                and inv_line.purchase_line_id not in oline_dict
+                and not float_is_zero(
+                    inv_line.purchase_line_id.product_qty, precision_digits=qty_prec
+                )
+            ):
+                self.order_line_update_oline_dict(
+                    inv_line.purchase_line_id, "purchase", oline_dict, cutoff_datetime
                 )
+        elif self.cutoff_type == "prepaid_revenue":
+            for so_line in inv_line.sale_line_ids:
+                if so_line not in oline_dict and not float_is_zero(
+                    so_line.product_uom_qty, precision_digits=qty_prec
+                ):
+                    self.order_line_update_oline_dict(
+                        so_line, "sale", oline_dict, cutoff_datetime
+                    )
 
     def get_lines(self):
         res = super().get_lines()
-        spo = self.env["stock.picking"]
         aclo = self.env["account.cutoff.line"]
-        acmo = self.env["account.cutoff.mapping"]
 
-        pick_type_map = {
-            "accrued_revenue": "outgoing",
-            "accrued_expense": "incoming",
-        }
-        cutoff_type = self.cutoff_type
-        if cutoff_type not in pick_type_map:
-            return res
-
-        # Create account mapping dict
-        account_mapping = acmo._get_mapping_dict(self.company_id.id, cutoff_type)
-
-        min_date_dt = self.cutoff_date - relativedelta(days=self.picking_interval_days)
-
-        # TODO date_done is a Datetime field, so maybe we need more clever code
-        # for our friends which are far away from GMT
-        pickings = spo.search(
-            [
-                ("picking_type_code", "=", pick_type_map[cutoff_type]),
-                ("state", "=", "done"),
-                ("date_done", "<=", self.cutoff_date),
-                ("date_done", ">=", min_date_dt),
-                ("company_id", "=", self.company_id.id),
-            ]
+        account_mapping = self.env["account.cutoff.mapping"]._get_mapping_dict(
+            self.company_id.id
         )
+        cutoff_type = self.cutoff_type
+        cutoff_datetime = self._get_cutoff_datetime()
 
         oline_dict = {}  # order line dict
         # key = PO line or SO line recordset
         # value = {
         #   'precut_delivered_qty': 1.0,
         #   'precut_invoiced_qty': 0.0,
         #   'price_unit': 12.42,
         #   }
-        # -> we use precut_delivered_qty - precut_invoiced_qty
-        for p in pickings:
-            for move in p.move_lines.filtered(lambda m: m.state == "done"):
-                self.stock_move_update_oline_dict(move, oline_dict)
+
+        # ACCRUAL :
+        # starting point : picking
+        # then, go to order line. From order line, go to stock moves and invoices lines
+        # => gen cutoff line if precut_delivered_qty - precut_invoiced_qty > 0
+        # PREPAID :
+        # starting point : invoice
+        # then, go to order line. From order line, go to stock moves and invoices lines
+        # => gen cutoff line if precut_invoiced_qty - precut_delivered_qty > 0
+
+        # ACCURAL
+        if cutoff_type in ("accrued_revenue", "accrued_expense"):
+            pick_type_map = {
+                "accrued_revenue": "outgoing",
+                "accrued_expense": "incoming",
+            }
+
+            min_date_dt = cutoff_datetime - relativedelta(
+                days=self.picking_interval_days
+            )
+
+            pickings = self.env["stock.picking"].search(
+                [
+                    ("picking_type_code", "=", pick_type_map[cutoff_type]),
+                    ("state", "=", "done"),
+                    ("date_done", "<=", cutoff_datetime),
+                    ("date_done", ">=", min_date_dt),
+                    ("company_id", "=", self.company_id.id),
+                ]
+            )
+
+            for p in pickings:
+                for move in p.move_lines.filtered(lambda m: m.state == "done"):
+                    self.stock_move_update_oline_dict(move, oline_dict, cutoff_datetime)
+        elif cutoff_type in ("prepaid_revenue", "prepaid_expense"):
+            move_type_map = {
+                "prepaid_revenue": ("out_invoice", "out_refund"),
+                "prepaid_expense": ("in_invoice", "in_refund"),
+            }
+            min_date = self.cutoff_date - relativedelta(days=self.picking_interval_days)
+            inv_domain = [
+                ("type", "in", move_type_map[cutoff_type]),
+                ("date", "<=", self.cutoff_date),
+                ("date", ">=", min_date),
+                ("company_id", "=", self.company_id.id),
+            ]
+            if self.source_move_state == "posted":
+                inv_domain.append(("state", "=", "posted"))
+            else:
+                inv_domain.append(("state", "in", ("draft", "posted")))
+            invoices = self.env["account.move"].search(inv_domain)
+            for invoice in invoices:
+                for iline in invoice.invoice_line_ids.filtered(
+                    lambda x: not x.display_type
+                    and x.product_id.type in ("product", "consu")
+                ):
+                    self.invoice_line_update_oline_dict(
+                        iline, oline_dict, cutoff_datetime
+                    )
 
         # from pprint import pprint
         # pprint(oline_dict)
         for vdict in oline_dict.values():
             vals = self.picking_prepare_cutoff_line(vdict, account_mapping)
             if vals:
                 aclo.create(vals)
         return res
+
+    def _get_cutoff_datetime(self):
+        self.ensure_one()
+        cutoff_date = datetime.combine(self.cutoff_date, datetime.max.time())
+        tz = self.env.user.tz and pytz.timezone(self.env.user.tz) or pytz.utc
+        cutoff_datetime_aware = tz.localize(cutoff_date)
+        cutoff_datetime_utc = cutoff_datetime_aware.astimezone(pytz.utc)
+        cutoff_datetime_utc_naive = cutoff_datetime_utc.replace(tzinfo=None)
+        return cutoff_datetime_utc_naive
```

### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

## odoo/addons/account_cutoff_accrual_picking/models/company.py

```diff
@@ -1,25 +1,27 @@
-# Copyright 2020 Akretion France
+# Copyright 2020-2021 Akretion France (http://www.akretion.com/)
+# @author: Alexis de Lattre <alexis.delattre@akretion.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
 
 from odoo import fields, models
 
 
 class ResCompany(models.Model):
     _inherit = "res.company"
 
     default_cutoff_accrual_picking_interval_days = fields.Integer(
-        string="Picking Analysis Interval",
-        help="To generate the accruals based on pickings, Odoo will "
-        "analyse all the pickings between the cutoff date and N "
-        "days before. N is the Picking Analysis Interval.",
+        string="Analysis Interval",
+        help="To generate the accrual/prepaid revenue/expenses based on picking "
+        "dates vs invoice dates, Odoo will analyse all the pickings/invoices from "
+        "N days before the cutoff date up to the cutoff date. "
+        "N is the Analysis Interval. If you increase the analysis interval, "
+        "Odoo will take more time to generate the cutoff lines.",
         default=90,
     )
 
     _sql_constraints = [
         (
             "cutoff_picking_interval_days_positive",
             "CHECK(default_cutoff_accrual_picking_interval_days > 0)",
-            "The value of the field 'Picking Analysis Interval' must "
-            "be strictly positive.",
+            "The value of the field 'Analysis Interval' must " "be strictly positive.",
         )
     ]
```

## odoo/addons/account_cutoff_accrual_picking/models/res_config_settings.py

```diff
@@ -4,13 +4,13 @@
 
 from odoo import fields, models
 
 
 class ResConfigSettings(models.TransientModel):
     _inherit = "res.config.settings"
 
-    # I can't name it default_cutoff_journal_id
-    # because default_ is a special prefix
+    # I can't name it default_cutoff_accrual_picking_interval_days
+    # because 'default_' is a special prefix
     dft_cutoff_accrual_picking_interval_days = fields.Integer(
         related="company_id.default_cutoff_accrual_picking_interval_days",
         readonly=False,
     )
```

## odoo/addons/account_cutoff_accrual_picking/readme/DESCRIPTION.rst

```diff
@@ -1,15 +1,25 @@
-This module generates expense and revenue accruals based on the status of
-orders, pickings and invoices.
+This module generates expense/revenue accruals and prepaid expense/revenue based on the status of orders, pickings and invoices. The module is named *account_cutoff_accrual_picking* because it initially only supported accruals ; support for prepaid expense/revenue was added later (it should be renamed in later versions).
 
 To understand the behavior of this module, let's take the example of an expense accrual. When you click on the button *Re-Generate Lines* of an *Expense Accrual*:
 
-1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date* (for performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 3 months will not be taken into account (this limit can be easily changed via a method inheritance). It will go to the stock moves of this picking and see if they are linked to a purchase order line.
+1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date*. For performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the stock moves of those pickings and see if they are linked to a purchase order line.
 2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential expense accrual.
 3. For each of these purchase order lines, Odoo will:
 
    - scan the related stock moves in *done* state and check their transfer date,
-   - scan the related invoices lines in *open* or *paid* state and check their invoice date.
+   - scan the related invoices lines and check their invoice date.
 
-4. If, for a particular purchase order line, the quantity of products shipped before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+4. If, for a particular purchase order line, the quantity of products received before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+
+Now, let's take the example of a prepaid expense. When you click on the button *Re-Generate Lines* of a *Prepaid Expense*:
+
+1. Odoo will look for all vendor bills dated before (or equal to) *Cut-off Date*. For performance reasons, by default, the vendor bills dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the invoice lines of those vendor bills and see if they are linked to a purchase order line.
+2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential prepaid expense.
+3. For each of these purchase order lines, Odoo will:
+
+   - scan the related stock moves in *done* state and check their transfer date,
+   - scan the related invoices lines and check their invoice date.
+
+4. If, for a particular purchase order line, the quantity of products invoiced before the cutoff-date (or on the same day) minus the quantity of products received before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
 
 This module should work well with multiple units of measure (including products purchased and invoiced in different units of measure) and in multi-currency.
```

## odoo/addons/account_cutoff_accrual_picking/static/description/index.html

### odoo/addons/account_cutoff_accrual_picking/static/description/index.html

```diff
@@ -2,15 +2,15 @@
 <!DOCTYPE html
   PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'
   'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
   <head>
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
     <meta name="generator" content="Docutils 0.15.1: http://docutils.sourceforge.net/"/>
-    <title>Account Cut-off Accrual Picking</title>
+    <title>Account Cut-off Picking</title>
     <style type="text/css">/*
 :Author: David Goodger (goodger@python.org)
 :Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
 :Copyright: This stylesheet has been placed in the public domain.
 
 Default cascading style sheet for the HTML output of Docutils.
 
@@ -354,16 +354,16 @@
 h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
   font-size: 100% }
 
 ul.auto-toc {
   list-style-type: none }</style>
   </head>
   <body>
-    <div class="document" id="account-cut-off-accrual-picking">
-      <h1 class="title">Account Cut-off Accrual Picking</h1>
+    <div class="document" id="account-cut-off-picking">
+      <h1 class="title">Account Cut-off Picking</h1>
       <!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 !! This file is generated by oca-gen-addon-readme !!
 !! changes will be overwritten.                   !!
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
       <p>
         <a class="reference external" href="https://odoo-community.org/page/development-status">
           <img alt="Beta" src="https://img.shields.io/badge/maturity-Beta-yellow.png"/>
@@ -377,52 +377,82 @@
         <a class="reference external" href="https://translation.odoo-community.org/projects/account-closing-13-0/account-closing-13-0-account_cutoff_accrual_picking">
           <img alt="Translate me on Weblate" src="https://img.shields.io/badge/weblate-Translate%20me-F47D42.png"/>
         </a>
         <a class="reference external" href="https://runbot.odoo-community.org/runbot/89/13.0">
           <img alt="Try me on Runbot" src="https://img.shields.io/badge/runbot-Try%20me-875A7B.png"/>
         </a>
       </p>
-      <p>This module generates expense and revenue accruals based on the status of
-orders, pickings and invoices.</p>
+      <p>
+        This module generates expense/revenue accruals and prepaid expense/revenue based on the status of orders, pickings and invoices. The module is named
+        <em>account_cutoff_accrual_picking</em>
+        because it initially only supported accruals ; support for prepaid expense/revenue was added later (it should be renamed in later versions).
+      </p>
       <p>
         To understand the behavior of this module, let’s take the example of an expense accrual. When you click on the button
         <em>Re-Generate Lines</em>
         of an
         <em>Expense Accrual</em>
         :
       </p>
       <ol class="arabic simple">
         <li>
           Odoo will look for all incoming picking in Done state with a
           <em>Transfer Date</em>
           &lt;=
           <em>Cut-off Date</em>
-          (for performance reasons, by default, the incoming picking dated before
+          . For performance reasons, by default, the incoming picking dated before
           <em>Cut-off Date</em>
-          minus 3 months will not be taken into account (this limit can be easily changed via a method inheritance). It will go to the stock moves of this picking and see if they are linked to a purchase order line.
+          minus 90 days will not be taken into account (this limit is configurable via the field
+          <em>Picking Analysis</em>
+          ). It will go to the stock moves of those pickings and see if they are linked to a purchase order line.
         </li>
         <li>Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential expense accrual.</li>
         <li>
           For each of these purchase order lines, Odoo will:
           <ul>
             <li>
               scan the related stock moves in
               <em>done</em>
               state and check their transfer date,
             </li>
+            <li>scan the related invoices lines and check their invoice date.</li>
+          </ul>
+        </li>
+        <li>If, for a particular purchase order line, the quantity of products received before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.</li>
+      </ol>
+      <p>
+        Now, let’s take the example of a prepaid expense. When you click on the button
+        <em>Re-Generate Lines</em>
+        of a
+        <em>Prepaid Expense</em>
+        :
+      </p>
+      <ol class="arabic simple">
+        <li>
+          Odoo will look for all vendor bills dated before (or equal to)
+          <em>Cut-off Date</em>
+          . For performance reasons, by default, the vendor bills dated before
+          <em>Cut-off Date</em>
+          minus 90 days will not be taken into account (this limit is configurable via the field
+          <em>Picking Analysis</em>
+          ). It will go to the invoice lines of those vendor bills and see if they are linked to a purchase order line.
+        </li>
+        <li>Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential prepaid expense.</li>
+        <li>
+          For each of these purchase order lines, Odoo will:
+          <ul>
             <li>
-              scan the related invoices lines in
-              <em>open</em>
-              or
-              <em>paid</em>
-              state and check their invoice date.
+              scan the related stock moves in
+              <em>done</em>
+              state and check their transfer date,
             </li>
+            <li>scan the related invoices lines and check their invoice date.</li>
           </ul>
         </li>
-        <li>If, for a particular purchase order line, the quantity of products shipped before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.</li>
+        <li>If, for a particular purchase order line, the quantity of products invoiced before the cutoff-date (or on the same day) minus the quantity of products received before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.</li>
       </ol>
       <p>This module should work well with multiple units of measure (including products purchased and invoiced in different units of measure) and in multi-currency.</p>
       <p>
         <strong>Table of contents</strong>
       </p>
       <div class="contents local topic" id="contents">
         <ul class="simple">
```

## odoo/addons/account_cutoff_accrual_picking/views/account_cutoff.xml

### odoo/addons/account_cutoff_accrual_picking/views/account_cutoff.xml

```diff
@@ -1,22 +1,22 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
-  Copyright 2020 Akretion France (http://www.akretion.com/)
+  Copyright 2020-2021 Akretion France (http://www.akretion.com/)
   @author Alexis de Lattre <alexis.delattre@akretion.com>
   License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
 -->
 <odoo>
   <record id="account_cutoff_form" model="ir.ui.view">
     <field name="name">accrual.picking.account_cutoff_form</field>
     <field name="model">account.cutoff</field>
     <field name="inherit_id" ref="account_cutoff_base.account_cutoff_form"/>
     <field name="arch" type="xml">
       <field name="cutoff_date" position="after">
-        <label for="picking_interval_days" attrs="{'invisible': [('cutoff_type', 'not in', ('accrued_expense', 'accrued_revenue'))]}"/>
-        <div name="picking_interval_days" attrs="{'invisible': [('cutoff_type', 'not in', ('accrued_expense', 'accrued_revenue'))]}">
+        <label for="picking_interval_days"/>
+        <div name="picking_interval_days">
           <field name="picking_interval_days" class="oe_inline"/>
           days
         </div>
       </field>
     </field>
   </record>
 </odoo>
```

## odoo/addons/account_cutoff_accrual_picking/views/res_config_settings.xml

### odoo/addons/account_cutoff_accrual_picking/views/res_config_settings.xml

```diff
@@ -1,19 +1,22 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
-  Copyright 2013-2018 Akretion (Alexis de Lattre <alexis.delattre@akretion.com>)
+  Copyright 2013-2021 Akretion France (http://www.akretion.com/)
+  @author: Alexis de Lattre <alexis.delattre@akretion.com>
   License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 -->
 <odoo>
   <record id="res_config_settings_view_form" model="ir.ui.view">
     <field name="name">accrual.picking.account.config.form</field>
     <field name="model">res.config.settings</field>
     <field name="inherit_id" ref="account_cutoff_accrual_base.res_config_settings_view_form"/>
     <field name="arch" type="xml">
-      <field name="accrual_taxes" position="after">
-        <label for="dft_cutoff_accrual_picking_interval_days" class="col-lg-3 o_light_label"/>
-        <field name="dft_cutoff_accrual_picking_interval_days"/>
-        days
-      </field>
+      <div id="accrual_taxes" position="after">
+        <div class="row" id="dft_cutoff_accrual_picking_interval_days">
+          <label for="dft_cutoff_accrual_picking_interval_days" class="col-lg-4 o_light_label"/>
+          <field name="dft_cutoff_accrual_picking_interval_days" class="col-lg-1"/>
+          days
+        </div>
+      </div>
     </field>
   </record>
 </odoo>
```

## Comparing `odoo13_addon_account_cutoff_accrual_picking-13.0.1.0.1.dev7.dist-info/METADATA` & `odoo13_addon_account_cutoff_accrual_picking-13.0.2.0.0.dist-info/METADATA`

 * *Files 14% similar despite different names*

```diff
@@ -1,26 +1,27 @@
 Metadata-Version: 2.1
 Name: odoo13-addon-account-cutoff-accrual-picking
-Version: 13.0.1.0.1.dev7
-Summary: Accrued expense & accrued revenue from pickings
+Version: 13.0.2.0.0
+Summary: Accrued and prepaid expense/revenue from pickings
 Home-page: https://github.com/OCA/account-closing
 Author: Akretion,Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Framework :: Odoo
+Classifier: Framework :: Odoo :: 13.0
 Classifier: License :: OSI Approved :: GNU Affero General Public License v3
 Requires-Python: >=3.5
 Requires-Dist: odoo13-addon-account-cutoff-accrual-base
 Requires-Dist: odoo (<13.1dev,>=13.0a)
 
-===============================
-Account Cut-off Accrual Picking
-===============================
+=======================
+Account Cut-off Picking
+=======================
 
 .. !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
@@ -37,27 +38,37 @@
     :alt: Translate me on Weblate
 .. |badge5| image:: https://img.shields.io/badge/runbot-Try%20me-875A7B.png
     :target: https://runbot.odoo-community.org/runbot/89/13.0
     :alt: Try me on Runbot
 
 |badge1| |badge2| |badge3| |badge4| |badge5| 
 
-This module generates expense and revenue accruals based on the status of
-orders, pickings and invoices.
+This module generates expense/revenue accruals and prepaid expense/revenue based on the status of orders, pickings and invoices. The module is named *account_cutoff_accrual_picking* because it initially only supported accruals ; support for prepaid expense/revenue was added later (it should be renamed in later versions).
 
 To understand the behavior of this module, let's take the example of an expense accrual. When you click on the button *Re-Generate Lines* of an *Expense Accrual*:
 
-1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date* (for performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 3 months will not be taken into account (this limit can be easily changed via a method inheritance). It will go to the stock moves of this picking and see if they are linked to a purchase order line.
+1. Odoo will look for all incoming picking in Done state with a *Transfer Date* <= *Cut-off Date*. For performance reasons, by default, the incoming picking dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the stock moves of those pickings and see if they are linked to a purchase order line.
 2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential expense accrual.
 3. For each of these purchase order lines, Odoo will:
 
    - scan the related stock moves in *done* state and check their transfer date,
-   - scan the related invoices lines in *open* or *paid* state and check their invoice date.
+   - scan the related invoices lines and check their invoice date.
 
-4. If, for a particular purchase order line, the quantity of products shipped before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+4. If, for a particular purchase order line, the quantity of products received before the cutoff-date (or on the same day) minus the quantity of products invoiced before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
+
+Now, let's take the example of a prepaid expense. When you click on the button *Re-Generate Lines* of a *Prepaid Expense*:
+
+1. Odoo will look for all vendor bills dated before (or equal to) *Cut-off Date*. For performance reasons, by default, the vendor bills dated before *Cut-off Date* minus 90 days will not be taken into account (this limit is configurable via the field *Picking Analysis*). It will go to the invoice lines of those vendor bills and see if they are linked to a purchase order line.
+2. Once this analysis is completed, Odoo has a list of purchase order lines to analyse for potential prepaid expense.
+3. For each of these purchase order lines, Odoo will:
+
+   - scan the related stock moves in *done* state and check their transfer date,
+   - scan the related invoices lines and check their invoice date.
+
+4. If, for a particular purchase order line, the quantity of products invoiced before the cutoff-date (or on the same day) minus the quantity of products received before the cut-off date (or on the same day) is positive, Odoo will generate a cut-off line.
 
 This module should work well with multiple units of measure (including products purchased and invoiced in different units of measure) and in multi-currency.
 
 **Table of contents**
 
 .. contents::
    :local:
```

