# Comparing `tmp/mautrix-facebook-0.4.1.tar.gz` & `tmp/mautrix-facebook-0.5.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "mautrix-facebook-0.4.1.tar", last modified: Tue Nov 15 15:12:45 2022, max compression
+gzip compressed data, was "mautrix-facebook-0.5.0.tar", last modified: Wed May 31 20:47:28 2023, max compression
```

## Comparing `mautrix-facebook-0.4.1.tar` & `mautrix-facebook-0.5.0.tar`

### file list

```diff
@@ -1,122 +1,126 @@
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4647 2022-11-15 15:07:49.000000 mautrix-facebook-0.4.1/CHANGELOG.md
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    34523 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/LICENSE
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      114 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/MANIFEST.in
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2448 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/PKG-INFO
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1399 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/README.md
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      123 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/__init__.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/http/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      205 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     9081 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/api.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    10965 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/base.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2881 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/errors.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     9297 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/login.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    17984 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/post_login.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5743 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/upload.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    15954 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/http/zstd-dict.dat
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/mqtt/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      118 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    28227 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/conn.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      911 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/events.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     3103 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/otclient.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1931 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/subscription.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     6009 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/mqtt/topics.json
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1493 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/proxy.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5342 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/state.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/thrift/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      154 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/thrift/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4452 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/thrift/autospec.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    13209 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/thrift/read.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2223 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/thrift/type.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5797 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/thrift/write.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/types/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1123 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1362 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/common.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/types/graphql/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1464 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/graphql/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     7180 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/graphql/queries.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    19245 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/graphql/responses.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2083 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/login.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1387 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/media.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/maufbapi/types/mqtt/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      907 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/mqtt/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     3297 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/mqtt/client_info.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    23221 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/mqtt/message.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5216 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/maufbapi/types/mqtt/requests.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.392880 mautrix-facebook-0.4.1/mautrix_facebook/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       70 2022-11-15 15:07:49.000000 mautrix-facebook-0.4.1/mautrix_facebook/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     7825 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/__main__.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/commands/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      119 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     7238 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/auth.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     3318 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/conn.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2044 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/facebook.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1247 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/handler.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      282 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/commands/typehint.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     6464 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/config.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/db/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      548 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5776 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/message.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4929 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/portal.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4514 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/puppet.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4288 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/reaction.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      279 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     9116 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v01_initial_revision.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2181 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v02_message_oti.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1380 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v03_portal_meta_set.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1034 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v04_relay_mode.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2020 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v05_remove_communities.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1125 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v06_store_user_seq_id.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1031 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v07_store_reaction_timestamp.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     3384 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/user.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2784 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/db/user_portal.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    17283 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/example-config.yaml
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/formatter/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       90 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/formatter/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     6714 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/formatter/from_facebook.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4526 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/formatter/from_matrix.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1440 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/get_version.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     6545 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/matrix.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    90058 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/portal.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2345 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/presence.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    10861 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/puppet.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    44407 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/user.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/util/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       38 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/util/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1119 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/util/color_log.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      128 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/util/interval.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      175 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook/version.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/web/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       40 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/__init__.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)    15318 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/public.py
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      948 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/segment_analytics.py
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/web/static/
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     7554 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/asn1hex-1.1.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1207 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/htm-3.0.4.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     9427 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/jsbn.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     8893 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/milligram-1.4.1.min.css
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1817 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/normalize-8.0.1.min.css
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     9979 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/preact-10.5.12.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1932 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/rng.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1479 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/rsa.min.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2647 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/spinner.css
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2075 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/api.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     5605 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/app.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     4670 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/crypto.js
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      160 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/index.css
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     1826 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/mautrix_facebook/web/static/login.html
-drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2448 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/PKG-INFO
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     3319 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/SOURCES.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)        1 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/dependency_links.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      536 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/requires.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       26 2022-11-15 15:12:45.000000 mautrix-facebook-0.4.1/mautrix_facebook.egg-info/top_level.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      349 2022-11-15 15:08:34.000000 mautrix-facebook-0.4.1/optional-requirements.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      203 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/pyproject.toml
--rw-rw-r--   0 tulir     (1000) tulir     (1000)      186 2022-11-15 15:08:25.000000 mautrix-facebook-0.4.1/requirements.txt
--rw-rw-r--   0 tulir     (1000) tulir     (1000)       38 2022-11-15 15:12:45.396880 mautrix-facebook-0.4.1/setup.cfg
--rw-rw-r--   0 tulir     (1000) tulir     (1000)     2336 2022-11-07 15:02:53.000000 mautrix-facebook-0.4.1/setup.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.294844 mautrix-facebook-0.5.0/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5593 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/CHANGELOG.md
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    34523 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/LICENSE
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      114 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/MANIFEST.in
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2411 2023-05-31 20:47:28.294844 mautrix-facebook-0.5.0/PKG-INFO
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1399 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/README.md
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.282844 mautrix-facebook-0.5.0/maufbapi/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       91 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/__init__.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.282844 mautrix-facebook-0.5.0/maufbapi/http/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      205 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    14751 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/api.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    12332 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/base.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     3015 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/errors.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     9503 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/login.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    17868 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/post_login.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4785 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/upload.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    15954 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/http/zstd-dict.dat
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.282844 mautrix-facebook-0.5.0/maufbapi/mqtt/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      190 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    30953 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/conn.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      911 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/events.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     3103 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/otclient.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1953 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/subscription.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     6058 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/mqtt/topics.json
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5446 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/state.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/maufbapi/thrift/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      154 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/thrift/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4452 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/thrift/autospec.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    13209 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/thrift/read.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2223 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/thrift/type.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5797 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/thrift/write.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/maufbapi/types/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1192 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1390 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/common.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/maufbapi/types/graphql/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1554 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/graphql/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     8151 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/graphql/queries.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    20461 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/graphql/responses.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2083 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/login.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1387 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/media.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/maufbapi/types/mqtt/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      936 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/mqtt/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     3304 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/mqtt/client_info.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    23741 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/mqtt/message.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5258 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/maufbapi/types/mqtt/requests.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/mautrix_facebook/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       70 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/mautrix_facebook/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     8132 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/mautrix_facebook/__main__.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/mautrix_facebook/commands/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      119 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/commands/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     7528 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/commands/auth.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4036 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/commands/conn.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2564 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/commands/facebook.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      282 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/commands/typehint.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     7498 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/config.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/db/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      611 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5684 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/backfill_queue.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     6375 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/message.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5072 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/portal.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4298 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/puppet.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4288 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/reaction.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      439 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     9116 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v01_initial_revision.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2181 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v02_message_oti.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1380 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v03_portal_meta_set.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1034 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v04_relay_mode.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2020 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v05_remove_communities.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1125 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v06_store_user_seq_id.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1031 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v07_store_reaction_timestamp.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1987 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v08_backfill_queue.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1243 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v09_portal_infinite_backfill.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1194 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v10_user_thread_sync_status.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1112 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v11_user_thread_sync_done_flag.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1099 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v12_puppet_contact_info_set.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     3938 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/user.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2784 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/db/user_portal.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    21595 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/example-config.yaml
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/formatter/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       90 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/formatter/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     6714 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/formatter/from_facebook.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4526 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/formatter/from_matrix.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1440 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/get_version.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     7005 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/matrix.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)   107789 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/mautrix_facebook/portal.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2345 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/presence.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    12536 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/puppet.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1106 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/mautrix_facebook/segment_analytics.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    60129 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/user.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/util/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       38 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/util/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1119 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/util/color_log.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      128 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/util/interval.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      175 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook/version.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/web/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       40 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/__init__.py
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)    15507 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/public.py
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/web/static/
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.290844 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     7554 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/asn1hex-1.1.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1207 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/htm-3.0.4.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     9427 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/jsbn.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     8893 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/milligram-1.4.1.min.css
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1817 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/normalize-8.0.1.min.css
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     9979 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/preact-10.5.12.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1932 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/rng.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1479 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/rsa.min.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2647 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/spinner.css
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.294844 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2075 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/api.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     5605 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/app.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     4670 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/crypto.js
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      160 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/index.css
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     1826 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/mautrix_facebook/web/static/login.html
+drwxrwxr-x   0 tulir     (1000) tulir     (1000)        0 2023-05-31 20:47:28.286844 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2411 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/PKG-INFO
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     3588 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/SOURCES.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)        1 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/dependency_links.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      537 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/requires.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       26 2023-05-31 20:47:28.000000 mautrix-facebook-0.5.0/mautrix_facebook.egg-info/top_level.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      349 2023-05-31 20:46:53.000000 mautrix-facebook-0.5.0/optional-requirements.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      203 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/pyproject.toml
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)      187 2023-05-31 20:47:00.000000 mautrix-facebook-0.5.0/requirements.txt
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)       38 2023-05-31 20:47:28.294844 mautrix-facebook-0.5.0/setup.cfg
+-rw-rw-r--   0 tulir     (1000) tulir     (1000)     2336 2023-05-14 10:31:31.000000 mautrix-facebook-0.5.0/setup.py
```

### Comparing `mautrix-facebook-0.4.1/CHANGELOG.md` & `mautrix-facebook-0.5.0/CHANGELOG.md`

 * *Files 18% similar despite different names*

```diff
@@ -1,7 +1,28 @@
+# v0.5.0 (2023-05-31)
+
+* Added config option to disable bridging `m.notice` messages
+  (thanks to [@jzapataikono] in [#280]).
+* Added options to automatically ratchet/delete megolm sessions to minimize
+  access to old messages.
+* Added option to not set room name/avatar even in encrypted rooms.
+* Added option to disable reply fallbacks entirely.
+* Added notice message when a call is received on Messenger.
+* Redid backfill system to support MSC2716.
+  * Note that using Synapse's MSC2716 implementation is not recommended, and
+    the bridge can still backfill messages without MSC2716.
+* Implemented appservice pinging using MSC2659.
+* Possibly improved MQTT connection handling.
+* Fixed bridging profile pictures for Instagram users.
+* Fixed MQTT connection failing in certain cases when Facebook returned weird
+  data in the chat list.
+
+[@jzapataikono]: https://github.com/jzapataikono
+[#280]: https://github.com/mautrix/facebook/pull/280
+
 # v0.4.1 (2022-11-15)
 
 * Improved unsupported message fallbacks and added support for more message
   types from Facebook.
   * Powerup messages, descriptions in story attachments, facebook pay messages
     and group join links among other things should be bridged now.
 * Added support for dynamically fetching a proxy URL.
```

### Comparing `mautrix-facebook-0.4.1/LICENSE` & `mautrix-facebook-0.5.0/LICENSE`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/PKG-INFO` & `mautrix-facebook-0.5.0/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,17 +1,15 @@
 Metadata-Version: 2.1
 Name: mautrix-facebook
-Version: 0.4.1
+Version: 0.5.0
 Summary: A Matrix-Facebook Messenger puppeting bridge.
 Home-page: https://github.com/mautrix/facebook
 Author: Tulir Asokan
 Author-email: tulir@maunium.net
-License: UNKNOWN
 Project-URL: Changelog, https://github.com/mautrix/facebook/blob/master/CHANGELOG.md
-Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: License :: OSI Approved :: GNU Affero General Public License v3 or later (AGPLv3+)
 Classifier: Topic :: Communications :: Chat
 Classifier: Framework :: AsyncIO
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.8
@@ -49,9 +47,7 @@
 
 ### Features & Roadmap
 [ROADMAP.md](https://github.com/mautrix/facebook/blob/master/ROADMAP.md)
 contains a general overview of what is supported by the bridge.
 
 ## Discussion
 Matrix room: [`#facebook:maunium.net`](https://matrix.to/#/#facebook:maunium.net)
-
-
```

### Comparing `mautrix-facebook-0.4.1/README.md` & `mautrix-facebook-0.5.0/README.md`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/http/api.py` & `mautrix-facebook-0.5.0/maufbapi/http/login.py`

 * *Files 23% similar despite different names*

```diff
@@ -11,238 +11,213 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
-from uuid import uuid4
+import base64
+import io
+import struct
+import time
+
+from Crypto.Cipher import AES, PKCS1_v1_5
+from Crypto.PublicKey import RSA
+from Crypto.Random import get_random_bytes
 
-from yarl import URL
-import attr
+from ..types import LoginResponse, MobileConfig, PasswordKeyResponse
+from .base import BaseAndroidAPI
+from .errors import TwoFactorRequired
 
-from mautrix.types import JSON
 
-from ..types import (
-    DownloadImageFragment,
-    FbIdToCursorQuery,
-    FetchStickersWithPreviewsQuery,
-    FileAttachmentUrlQuery,
-    FileAttachmentURLResponse,
-    ImageFragment,
-    MessageList,
-    MessageReactionMutation,
-    MessageUndoSend,
-    MessageUnsendResponse,
-    MoreMessagesQuery,
-    ReactionAction,
-    SearchEntitiesNamedQuery,
-    SearchEntitiesResponse,
-    StickerPreviewResponse,
-    SubsequentMediaQuery,
-    SubsequentMediaResponse,
-    ThreadListQuery,
-    ThreadListResponse,
-    ThreadQuery,
-    ThreadQueryResponse,
-)
-from ..types.graphql import OwnInfo, PageInfo, Thread, ThreadMessageID
-from .base import BaseAndroidAPI
-from .login import LoginAPI
-from .post_login import PostLoginAPI
-from .upload import UploadAPI
-
-
-class AndroidAPI(LoginAPI, PostLoginAPI, UploadAPI, BaseAndroidAPI):
-    _file_url_cache: dict[ThreadMessageID, FileAttachmentURLResponse]
-
-    async def fetch_thread_list(self, **kwargs) -> ThreadListResponse:
-        return await self.graphql(
-            ThreadListQuery(**kwargs),
-            response_type=ThreadListResponse,
-            path=["data", "viewer", "message_threads"],
-        )
-
-    async def fetch_thread_info(self, *thread_ids: str | int, **kwargs) -> list[Thread]:
-        resp = await self.graphql(
-            ThreadQuery(thread_ids=[str(i) for i in thread_ids], **kwargs),
-            path=["data"],
-            response_type=ThreadQueryResponse,
-        )
-        return resp.message_threads
-
-    async def fetch_messages(self, thread_id: int, before_time_ms: int, **kwargs) -> MessageList:
-        return await self.graphql(
-            MoreMessagesQuery(
-                thread_id=str(thread_id), before_time_ms=str(before_time_ms), **kwargs
-            ),
-            path=["data", "message_thread", "messages"],
-            response_type=MessageList,
-        )
-
-    async def fetch_stickers(self, ids: list[int], **kwargs) -> StickerPreviewResponse:
-        kwargs["sticker_ids"] = [str(id) for id in ids]
-        return await self.graphql(
-            FetchStickersWithPreviewsQuery(**kwargs),
-            path=["data"],
-            response_type=StickerPreviewResponse,
-            b=True,
-        )
-
-    async def unsend(self, message_id: str) -> MessageUnsendResponse:
-        return await self.graphql(
-            MessageUndoSend(
-                message_id=message_id,
-                client_mutation_id=str(uuid4()),
-                actor_id=str(self.state.session.uid),
-            ),
-            path=["data", "message_undo_send"],
-            response_type=MessageUnsendResponse,
-        )
-
-    async def react(self, message_id: str, reaction: str | None) -> None:
-        action = ReactionAction.ADD if reaction else ReactionAction.REMOVE
-        await self.graphql(
-            MessageReactionMutation(
-                message_id=message_id,
-                reaction=reaction,
-                action=action,
-                client_mutation_id=str(uuid4()),
-                actor_id=str(self.state.session.uid),
-            ),
-            response_type=JSON,
-        )
-
-    async def fetch_image(self, media_id: int | str) -> ImageFragment:
-        return await self.graphql(
-            DownloadImageFragment(fbid=str(media_id)),
-            path=["data", "node"],
-            response_type=ImageFragment,
-        )
-
-    async def fbid_to_cursor(self, thread_id: int | str, media_id: int | str) -> PageInfo:
-        return await self.graphql(
-            FbIdToCursorQuery(fbid=str(media_id), thread_id=str(thread_id)),
-            path=["data", "message_thread", "message_shared_media", "page_info"],
-            response_type=PageInfo,
-        )
-
-    async def media_query(
-        self, thread_id: int | str, cursor: str | None = None
-    ) -> SubsequentMediaResponse:
-        return await self.graphql(
-            SubsequentMediaQuery(thread_id=str(thread_id), cursor_id=cursor),
-            path=["data", "message_thread", "mediaResult"],
-            response_type=SubsequentMediaResponse,
-        )
-
-    async def search(self, query: str, **kwargs) -> SearchEntitiesResponse:
-        return await self.graphql(
-            SearchEntitiesNamedQuery(search_query=query, **kwargs),
-            path=["data", "entities_named"],
-            response_type=SearchEntitiesResponse,
-        )
-
-    async def get_image_url(
-        self,
-        message_id: str,
-        attachment_id: int | str,
-        preview: bool = False,
-        max_width: int = 384,
-        max_height: int = 480,
-    ) -> str | None:
-        query = {
-            "method": "POST",
-            "redirect": "true",
-            "access_token": self.state.session.access_token,
-            "mid": f"m_{message_id}",
-            "aid": str(attachment_id),
-        }
-        if preview:
-            query["preview"] = "1"
-            query["max_width"] = max_width
-            query["max_height"] = max_height
-        headers = {
-            "referer": f"fbapp://{self.state.application.client_id}/messenger_thread_photo",
-            "x-fb-friendly-name": "image",
+class LoginAPI(BaseAndroidAPI):
+    async def pwd_key_fetch(self) -> PasswordKeyResponse:
+        req = {
+            "device_id": self.state.device.uuid,
+            "version": "2",
+            "flow": "CONTROLLER_INITIALIZATION",
+            **self._params,
+            "method": "GET",
+            "fb_api_req_friendly_name": "pwdKeyFetch",
+            "fb_api_caller_class": "AuthOperations",
+            "access_token": self.state.application.access_token,
         }
-        resp = await self.get(
-            (self.graph_url / "messaging_get_attachment").with_query(query),
-            headers=headers,
-            include_auth=False,
-            allow_redirects=False,
+        req_data = self.format(req, sign=False)
+        resp = await self.http_post(
+            self.graph_url.with_path("//pwd_key_fetch"), headers=self._headers, data=req_data
         )
-        # TODO handle errors more properly?
-        try:
-            return resp.headers["Location"]
-        except KeyError:
-            return None
-
-    async def get_file_url(
-        self, thread_id: str | int, message_id: str, attachment_id: str | int
-    ) -> URL | None:
-        attachment_id = str(attachment_id)
-        msg_id = ThreadMessageID(thread_id=str(thread_id), message_id=message_id)
-        try:
-            resp = self._file_url_cache[msg_id]
-        except KeyError:
-            resp = await self.graphql(
-                FileAttachmentUrlQuery(thread_msg_id=msg_id),
-                path=["data", "message"],
-                response_type=FileAttachmentURLResponse,
-            )
-            if len(resp.blob_attachments) > 1:
-                self._file_url_cache[msg_id] = resp
-        for attachment in resp.blob_attachments:
-            if attachment.attachment_fbid == attachment_id:
-                url = URL(resp.blob_attachments[0].url)
-                if url.host == "l.facebook.com":
-                    url = URL(url.query["u"])
-                return url
-        return None
-
-    async def get_self(self) -> OwnInfo:
-        fields = ",".join(field.name for field in attr.fields(OwnInfo))
-        url = (self.graph_url / str(self.state.session.uid)).with_query({"fields": fields})
-        async with self.get(url) as resp:
-            json_data = await self._handle_response(resp)
-        return OwnInfo.deserialize(json_data)
-
-    async def logout(self) -> bool:
+        json_data = await self._handle_response(resp)
+        parsed = PasswordKeyResponse.deserialize(json_data)
+        self.state.session.password_encryption_pubkey = parsed.public_key
+        self.state.session.password_encryption_key_id = parsed.key_id
+        return parsed
+
+    async def mobile_config_sessionless(self) -> MobileConfig:
+        req = {
+            "query_hash": "0a97d448717ed4434c5f3c152f7f94893cfa691f2f9a5c40d8783ea30da6bbe9",
+            "one_query_hash": "52b26867babb064b6b8ff8147bc59f98351c38418b8a500b79c9448f73770bc3",
+            "bool_opt_policy": "3",
+            "device_id": self.state.device.uuid,
+            "api_version": "8",
+            "fetch_type": "SYNC_FULL",
+            "unit_type": "1",
+            "access_token": self.state.application.access_token,
+            **self._params,
+        }
+        req_data = self.format(req, sign=False)
         headers = {
             **self._headers,
-            "x-fb-friendly-name": "logout",
+            "x-fb-friendly-name": "mobile_config_request:mobileconfigsessionless",
+            "x-fb-request-analytics-tags": "FBMobileConfigTigonFetcher",
         }
+        headers.pop("x-fb-rmd", None)
+        resp = await self.http_post(
+            self.b_graph_url / "mobileconfigsessionless", headers=headers, data=req_data
+        )
+        json_data = await self._handle_response(resp)
+        parsed = MobileConfig.deserialize(json_data)
+        self.state.session.password_encryption_key_id = parsed.find(15712, 1).i64
+        self.state.session.password_encryption_pubkey = parsed.find(15712, 2).str
+        return parsed
+
+    async def login(
+        self, email: str, password: str | None = None, encrypted_password: str | None = None
+    ) -> LoginResponse:
+        if password:
+            if encrypted_password:
+                raise ValueError("Only one of password or encrypted_password must be provided")
+            encrypted_password = self._encrypt_password(password)
+        elif not encrypted_password:
+            raise ValueError("One of password or encrypted_password is required")
+        return await self._login(
+            email=email, password=encrypted_password, credentials_type="password"
+        )
+
+    async def login_2fa(self, email: str, code: str) -> LoginResponse:
+        if not self.state.session.login_first_factor:
+            raise ValueError("No two-factor login in progress")
+        return await self._login(
+            email=email,
+            password=code,
+            twofactor_code=code,
+            encrypted_msisdn="",
+            currently_logged_in_userid="0",
+            userid=str(self.state.session.uid),
+            machine_id=self.state.session.machine_id,
+            first_factor=self.state.session.login_first_factor,
+            credentials_type="two_factor",
+        )
+
+    async def login_approved(self) -> LoginResponse:
+        if not self.state.session.transient_auth_token:
+            raise ValueError("No two-factor login in progress")
+        return await self._login(
+            password=self.state.session.transient_auth_token,
+            email=str(self.state.session.uid),
+            encrypted_msisdn="",
+            credentials_type="transient_token",
+        )
+
+    async def check_approved_machine(self) -> bool:
         req: dict[str, str] = {
+            "u": str(self.state.session.uid),
+            "m": self.state.session.machine_id,
             **self._params,
-            "fb_api_req_friendly_name": "logout",
-            "fb_api_caller_class": "AuthOperations",
+            "method": "GET",
+            "fb_api_req_friendly_name": "checkApprovedMachine",
+            "fb_api_caller_class": "TwoFacServiceHandler",
+            "access_token": self.state.application.access_token,
         }
-        resp = await self.http.post(
-            url=self.b_graph_url / "auth" / "expire_session", headers=headers, data=req
+        headers = {
+            **self._headers,
+            "content-type": "application/x-www-form-urlencoded",
+            "x-fb-friendly-name": req["fb_api_req_friendly_name"],
+        }
+        resp = await self.http_post(
+            url=self.graph_url / "check_approved_machine", headers=headers, data=req
         )
-        resp.raise_for_status()
-        return await resp.text() == "true"
+        json_data = await self._handle_response(resp)
+        return json_data["data"][0]["approved"]
 
-    async def cdn_rmd(self, prev_token: str = "", reason: str = "TIMER_EXPIRED") -> str:
-        # reasons: TIMER_EXPIRED, APP_START, APP_RESUME
+    async def _login(self, **kwargs) -> LoginResponse:
+        req: dict[str, str] = {
+            **self._params,
+            "adid": self.state.device.adid,
+            "api_key": self.state.application.client_id,
+            "community_id": "",
+            "secure_family_device_id": "",
+            "cpl": "true",
+            "currently_logged_in_userid": "0",
+            "device_id": self.state.device.uuid,
+            "fb_api_caller_class": "AuthOperations$PasswordAuthOperation",
+            "fb_api_req_friendly_name": "authenticate",
+            "enroll_misauth": "false",
+            "format": "json",
+            "generate_analytics_claim": "1",
+            "generate_machine_id": "1",
+            "generate_session_cookies": "1",
+            "jazoest": self._jazoest,
+            "meta_inf_fbmeta": "NO_FILE",
+            "source": "login",
+            "try_num": "1",  # TODO maybe cache this somewhere?
+            **kwargs,
+        }
+        req_data = self.format(req, sign=True, access_token=self.state.application.access_token)
         headers = {
             **self._headers,
             "content-type": "application/x-www-form-urlencoded",
-            "x-fb-friendly-name": "rmd-mapfetcher",
-            "x-fb-request-analytics-tags": "rmd",
-            "accept-encoding": "x-fb-dz;d=1, gzip, deflate",
-        }
-        query = {
-            "net_iface": self.state.device.net_iface,
-            "reason": reason,
-        }
-        if prev_token:
-            query["prev_token"] = prev_token
-        resp = await self.http.post(
-            url=(self.graph_url / "v3.2" / "cdn_rmd").with_query(query),
-            headers=headers,
+            "x-fb-friendly-name": req["fb_api_req_friendly_name"],
+        }
+        headers.pop("x-fb-rmd", None)
+        resp = await self.http_post(
+            url=self.b_graph_url / "auth" / "login", headers=headers, data=req_data
         )
-        await self._decompress_zstd(resp)
-        self.log.trace(f"cdn_rmd response: {await resp.text()}")
-        json_data = await self._handle_response(resp)
-        return json_data["token"]
+        self.log.trace(f"Login response: {resp.status} {await resp.text()}")
+        try:
+            json_data = await self._handle_response(resp)
+        except TwoFactorRequired as e:
+            self.state.session.machine_id = e.machine_id
+            self.state.session.uid = e.uid
+            self.state.session.login_first_factor = e.login_first_factor
+            self.state.session.transient_auth_token = e.auth_token
+            raise
+        parsed = LoginResponse.deserialize(json_data)
+        self.state.session.access_token = parsed.access_token
+        self.state.session.uid = parsed.uid
+        self.state.session.machine_id = parsed.machine_id
+        self.state.session.login_first_factor = None
+        # TODO maybe store the cookies and other data too?
+        return parsed
+
+    def _encrypt_password(self, password: str) -> str:
+        # Key and IV for AES encryption
+        rand_key = get_random_bytes(32)
+        iv = get_random_bytes(12)
+
+        # Encrypt AES key with Facebook's RSA public key
+        pubkey_bytes = self.state.session.password_encryption_pubkey
+        pubkey = RSA.import_key(pubkey_bytes)
+        cipher_rsa = PKCS1_v1_5.new(pubkey)
+        encrypted_rand_key = cipher_rsa.encrypt(rand_key)
+
+        cipher_aes = AES.new(rand_key, AES.MODE_GCM, nonce=iv)
+        # Add the current time to the additional authenticated data (AAD) section
+        current_time = int(time.time())
+        cipher_aes.update(str(current_time).encode("utf-8"))
+        # Encrypt the password and get the AES MAC auth tag
+        encrypted_passwd, auth_tag = cipher_aes.encrypt_and_digest(password.encode("utf-8"))
+
+        buf = io.BytesIO()
+        # 1 is presumably the version
+        buf.write(bytes([1, int(self.state.session.password_encryption_key_id)]))
+        buf.write(iv)
+        # Length of the encrypted AES key as a little-endian 16-bit int
+        buf.write(struct.pack("<h", len(encrypted_rand_key)))
+        buf.write(encrypted_rand_key)
+        buf.write(auth_tag)
+        buf.write(encrypted_passwd)
+        encoded = base64.b64encode(buf.getvalue()).decode("utf-8")
+        return f"#PWD_MSGR:1:{current_time}:{encoded}"
+
+    @property
+    def _jazoest(self) -> str:
+        return f"2{sum(ord(i) for i in self.state.device.uuid)}"
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/http/base.py` & `mautrix-facebook-0.5.0/maufbapi/http/base.py`

 * *Files 6% similar despite different names*

```diff
@@ -11,16 +11,17 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
-from typing import Type, TypeVar
+from typing import Awaitable, Callable, Type, TypeVar
 from contextlib import asynccontextmanager
+from functools import partial
 from urllib.parse import quote, urlparse
 import base64
 import hashlib
 import json
 import logging
 import pkgutil
 import random
@@ -30,16 +31,16 @@
 from aiohttp.client import _RequestContextManager
 from yarl import URL
 import aiohttp
 import zstandard as zstd
 
 from mautrix.types import JSON
 from mautrix.util.logging import TraceLogger
+from mautrix.util.proxy import ProxyHandler, proxy_with_retry
 
-from ..proxy import ProxyHandler
 from ..state import AndroidState
 from ..types import GraphQLMutation, GraphQLQuery
 from .errors import GraphQLError, ResponseError, ResponseTypeError, error_class_map, error_code_map
 
 try:
     from aiohttp_socks import ProxyConnector
 except ImportError:
@@ -78,30 +79,42 @@
     _tid: int
 
     def __init__(
         self,
         state: AndroidState,
         log: TraceLogger | None = None,
         proxy_handler: ProxyHandler | None = None,
+        on_proxy_update: Callable[[], Awaitable[None]] | None = None,
     ) -> None:
         self.log = log or logging.getLogger("maufbapi.http")
 
         self.proxy_handler = proxy_handler
+        self.on_proxy_update = on_proxy_update
         self.setup_http()
 
         self.state = state
         self._cid = ""
         self._cid_ts = 0
         self.freeze_cid = False
         self.nid = base64.b64encode(
             bytes([random.getrandbits(8) for _ in range(9)]),
         ).decode("utf-8")
         self._tid = 0
         self._file_url_cache = {}
 
+        self.proxy_with_retry = partial(
+            proxy_with_retry,
+            logger=self.log,
+            proxy_handler=self.proxy_handler,
+            on_proxy_change=self.on_proxy_update,
+            # Wait 1s * errors, max 10s for fast failure
+            max_wait_seconds=10,
+            multiply_wait_seconds=1,
+        )
+
     @property
     def tid(self) -> int:
         self._tid += 1
         return self._tid
 
     @property
     def cid(self) -> str:
@@ -163,15 +176,15 @@
                 connector = ProxyConnector.from_url(http_proxy)
             else:
                 self.log.warning("http_proxy is set, but aiohttp-socks is not installed")
 
         self.http = ClientSession(connector=connector)
         return None
 
-    def get(
+    def raw_http_get(
         self,
         url: str | URL,
         headers: dict[str, str] | None = None,
         include_auth: bool = True,
         sandbox: bool = False,
         **kwargs,
     ) -> _RequestContextManager:
@@ -192,14 +205,26 @@
             )
         if not url.host.endswith(".facebook.com") or not include_auth:
             headers.pop("authorization")
             if sandbox:
                 return sandboxed_get(url)
         return self.http.get(url, headers=headers, **kwargs)
 
+    async def http_get(self, *args, **kwargs) -> ClientResponse:
+        return await self.proxy_with_retry(
+            "AndroidAPI.get",
+            lambda: self.raw_http_get(*args, **kwargs),
+        )
+
+    async def http_post(self, *args, **kwargs) -> ClientResponse:
+        return await self.proxy_with_retry(
+            "AndroidAPI.post",
+            lambda: self.http.post(*args, **kwargs),
+        )
+
     async def graphql(
         self,
         req: GraphQLQuery,
         headers: dict[str, str] | None = None,
         response_type: Type[T] | None = JSON,
         path: list[str] | None = None,
         b: bool = True,
@@ -215,34 +240,39 @@
         variables = req.serialize()
         if isinstance(req, GraphQLMutation):
             variables = {"input": variables}
         params = {
             **self._params,
             "variables": json.dumps(variables),
             "method": "post",
+            "client_doc_id": req.client_doc_id,
             "doc_id": req.doc_id,
             "format": "json",
             "pretty": "false",
             # "query_name": req.__class__.__name__,
             "strip_defaults": "false",
             "strip_nulls": "false",
             "fb_api_req_friendly_name": req.__class__.__name__,
             "fb_api_caller_class": req.caller_class,
             "fb_api_analytics_tags": json.dumps(req.analytics_tags),
             "server_timestamps": "true",
         }
+        if params["doc_id"]:
+            del params["client_doc_id"]
+        else:
+            del params["doc_id"]
         if not req.include_client_country_code:
             params.pop("client_country_code")
-        resp = await self.http.post(
+        resp = await self.http_post(
             url=(self.b_graph_url if b else self.graph_url) / "graphql",
             data=params,
             headers=headers,
         )
         await self._decompress_zstd(resp)
-        self.log.trace(f"GraphQL {req} response: {await resp.text()}")
+        self.log.trace(f"GraphQL {req} response {resp.status}: {await resp.text()}")
         if response_type is None:
             self._handle_response_headers(resp)
             return None
         json_data = await self._handle_response(resp)
         if path:
             for item in path:
                 json_data = json_data[item]
@@ -273,25 +303,32 @@
             raise ResponseTypeError(resp.status, await resp.text()) from e
         if isinstance(body, list) and batch_index is not None:
             body = body[batch_index][1].get("body", {})
         error = body.get("error", None)
         errors = body.get("errors", [])
         if error:
             self.log.trace("Got error object in response data: %s", error)
-            error_class = (
-                error_code_map.get(error["code"])
-                or error_class_map.get(error["type"])
-                or ResponseError
-            )
-            raise error_class(error)
+            self._handle_error(error)
         elif errors:
             self.log.warning("Got list of errors in response data: %s", errors)
             if resp.status >= 400 or not body.get("data"):
+                if len(errors) == 1:
+                    self.log.trace("Got single error object in list: %s", errors[0])
+                    self._handle_error(errors[0])
+
                 try:
                     raise GraphQLError(errors[0], errors[1:])
                 except KeyError as e:
                     raise Exception("Unknown response error") from e
         return body
 
+    def _handle_error(self, error: JSON):
+        error_class = (
+            error_code_map.get(error.get("code"))
+            or error_class_map.get(error.get("type"))
+            or ResponseError
+        )
+        raise error_class(error)
+
     def _handle_response_headers(self, resp: ClientResponse) -> None:
         # TODO if needed
         pass
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/http/errors.py` & `mautrix-facebook-0.5.0/maufbapi/http/errors.py`

 * *Files 4% similar despite different names*

```diff
@@ -63,29 +63,35 @@
     def __init__(self, data: dict[str, Any]) -> None:
         super().__init__(data)
         tfa_data = data["error_data"]
         self.login_first_factor = tfa_data["login_first_factor"]
         self.machine_id = tfa_data.get("machine_id")
         self.auth_token = tfa_data["auth_token"]
         self.uid = tfa_data["uid"]
+        self.user_message = data["error_user_msg"]
 
 
 class InvalidEmail(OAuthException):
     pass
 
 
 class IncorrectPassword(OAuthException):
     pass
 
 
 class GraphMethodException(ResponseError):
     pass
 
 
+class RateLimitExceeded(ResponseError):
+    pass
+
+
 error_code_map = {
     190: InvalidAccessToken,
     400: InvalidEmail,
     401: IncorrectPassword,
     406: TwoFactorRequired,
+    3252001: RateLimitExceeded,
 }
 _error_classes = (OAuthException, GraphMethodException)
 error_class_map = {clazz.__name__: clazz for clazz in _error_classes}
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/http/post_login.py` & `mautrix-facebook-0.5.0/maufbapi/http/post_login.py`

 * *Files 2% similar despite different names*

```diff
@@ -50,15 +50,15 @@
             "x-zero-state": "unknown",
             "x-fb-request-analytics-tags": "unknown",
             "x-fb-friendly-name": req_data["fb_api_req_friendly_name"],
             "accept-encoding": "x-fb-dz;d=1, gzip, deflate",
             **self._headers,
         }
         headers.pop("x-fb-rmd", None)
-        resp = await self.http.post(url=url, headers=headers, data=req_data)
+        resp = await self.http_post(url=url, headers=headers, data=req_data)
         await self._decompress_zstd(resp)
         self.log.trace(f"Fetch logged in user response: {await resp.text()}")
         resp_data = await self._handle_response(resp, batch_index=2 if post_login else 0)
         if not post_login:
             # The second batch will sometimes contain errors that the first one doesn't.
             await self._handle_response(resp, batch_index=1)
         try:
@@ -84,15 +84,15 @@
                         "profile_pic_small_size": 110,
                         "profile_pic_medium_size": 258,
                         "profile_pic_large_size": 1080,
                         "is_for_messenger": True,
                         "fetch_story_holdout": False,
                     }, separators=(",", ":")),
                     "method": "post",
-                    "doc_id": "4043011582467507",
+                    "client_doc_id": "56206677010285874795217511352",
                     "query_name": "GetLoggedInUserQuery",
                     "strip_defaults": "true",
                     "strip_nulls": "true",
                     "locale": self.state.device.language,
                     "client_country_code": self.state.device.country_code,
                     "fb_api_req_friendly_name": "GetLoggedInUserQuery",
                 }),
@@ -100,15 +100,15 @@
                 "omit_response_on_success": False,
                 "relative_url": "graphql",
             },
             {
                 "method": "POST",
                 "body": urlencode({
                     "method": "post",
-                    "doc_id": "5263028057057401",
+                    "client_doc_id": "125947233810637883624289000760",
                     "query_name": "FetchFacebookEmployeeStatusQuery",
                     "strip_defaults": "true",
                     "strip_nulls": "true",
                     "locale": self.state.device.language,
                     "client_country_code": self.state.device.country_code,
                     "fb_api_req_friendly_name": "FetchFacebookEmployeeStatusQuery",
                 }),
@@ -151,38 +151,39 @@
             },
             self._resync_params[0],
             {
                 "method": "POST",
                 "body": urlencode({
                     "variables": json.dumps({
                         "nux_ids": [
-                            "9151", "9580", "8587", "5551", "5477", "7441", "6199", "8409", "8330",
-                            "6504", "7785", "8435", "6671", "8166", "8071", "10187", "10018",
-                            "9682", "10010", "9717", "8432", "8460", "8538", "4442", "9871",
-                            "9877", "10186", "9582", "10087", "9890", "7685", "7093", "7841",
-                            "6778", "8588", "8266", "9849", "9485", "9455", "9790", "10112",
-                            "6849", "3931", "9891", "7721", "7066", "9821", "6762", "5665", "5677",
-                            "9606", "9856", "7859", "7826", "7764", "7951", "8478", "7830", "7829",
-                            "10003", "6522", "6563", "6005", "7842", "6006", "7979", "7915",
-                            "9956", "8449", "5290", "5291", "4828", "7004", "7615", "4745", "4744",
-                            "4743", "2415", "4408", "8470", "3545", "5579", "3543", "5411", "8729",
-                            "9045", "9808", "9785", "7896", "9608", "8216", "8279", "9423", "7198",
-                            "7199", "7190", "7654", "9172", "4541", "9280", "8026", "7987", "8214",
-                            "7435", "1820", "9054", "8375", "8543", "4320", "8311", "6389", "4757",
-                            "9807", "5131", "4327"
+                            "9151", "7441", "6199", "8409", "8330", "10365", "7785", "8435",
+                            "6671", "8166", "8071", "10187", "10018", "9682", "8432", "4442",
+                            "10186", "10465", "9890", "7685", "7093", "6778", "8588", "8266",
+                            "9849", "9485", "9455", "10112", "7640", "7227", "6732", "7051",
+                            "8538", "8531", "8990", "7072", "9027", "6812", "7805", "6849", "3931",
+                            "9891", "7721", "7066", "9821", "6762", "9606", "9856", "7859", "7826",
+                            "7764", "7951", "10003", "6522", "6563", "6005", "7842", "6006",
+                            "7979", "7915", "9956", "8449", "5290", "5291", "10508", "4828",
+                            "7004", "7615", "4745", "4744", "4743", "10944", "2415", "4408",
+                            "8470", "3545", "10896", "5579", "3543", "5411", "10206", "8729",
+                            "9045", "7896", "10349", "9608", "8216", "8279", "7198", "7199",
+                            "7190", "7654", "9172", "9280", "8026", "7987", "8214", "7435",
+                            "11105", "10936", "1820", "9054", "8375", "8543", "4320", "8311",
+                            "6389", "4757", "5131", "4327"
                         ],
                         "device_id": self.state.device.uuid,
                         "nt_context": NTContext().serialize(),
                         "avatar_nux_image_width": 1080,
                         "is_from_internal_tool": False,
+                        "is_caa": False,
                         "family_device_id": self.state.device.fdid,
                         "scale": "3",
                     }, separators=(",", ":")),
                     "method": "post",
-                    "doc_id": "4618754314834440",
+                    "client_doc_id": "95960657013802827385295698902",
                     "query_name": "FetchInterstitials",
                     "strip_defaults": "true",
                     "strip_nulls": "true",
                     "locale": self.state.device.language,
                     "client_country_code": self.state.device.country_code,
                     "fb_api_req_friendly_name": "FetchInterstitials"
                 }),
@@ -193,15 +194,15 @@
             {
                 "method": "POST",
                 "body": urlencode({
                     "client_country_code": self.state.device.country_code,
                     "fb_api_req_friendly_name": "fetchGKInfo",
                     "format": "json",
                     "locale": self.state.device.language,
-                    "query": "android_aborthooks_enabled,android_actionbar_panel_kb_workaround,android_allow_user_cert_override,android_always_play_live_cached_data,android_analytics_listener_bg_handler,android_block_drm_playback_hdmi,android_block_drm_screen_capture,android_chat_head_hw_accel_disabled,android_chat_heads_app_state,android_cm_holiday_card_render,android_disable_messenger_ineedinits,android_drm_blacklisted_devices,android_enable_maxwidth_prefilter,android_enable_oxygen_crash_reporter,android_enable_terminate_handler,android_enable_vod_prefetch_qs_fix,android_fb4a_enable_zero_ip_test,android_fbns_dumpsys_ids,android_game_tab_badging,android_granular_exposures_navigation,android_headspin_logging,android_invite_link_phone_confirm_enable_gk,android_large_payload_support,android_learn_startvideosession_uri,android_legacy_logging_framework_gk,android_litho_enable_thread_tracing_stacktrace,android_litho_opt_visibility_handlers,android_litho_transitions_extension_290,android_loaded_library_reporting,android_messenger_add_contacts_redesign_gk,android_messenger_android_auto_support,android_messenger_avoid_ipc_logging,android_messenger_background_contact_logs_upload,android_messenger_background_contacts_upload,android_messenger_banner_triggers_omnistore,android_messenger_bug_report_on_instacrash_loop,android_messenger_camera_selfie_effect_gk,android_messenger_composer_lightweight_actions,android_messenger_contact_upload_progress_screens,android_messenger_dark_mode_opt_in,android_messenger_dark_mode_rollout,android_messenger_data_saver_mode,android_messenger_delay_analytics_during_startup,android_messenger_delay_periodic_reporters,android_messenger_employee_default_beta_web_tier,android_messenger_explicitly_adding_extensions,android_messenger_file_based_logger,android_messenger_hole_check_disabled,android_messenger_inapp_browser,android_messenger_instrumented_drawable,android_messenger_log_messaging_debug_events,android_messenger_multiple_requests_money_fab,android_messenger_omnistore_debug_uploader_flytrap,android_messenger_omnistore_rage_shake_sqlite,android_messenger_p2p_payment,android_messenger_periodic_effect_prefetch_enabled,android_messenger_platform_20141218,android_messenger_platform_20150311,android_messenger_platform_20150314,android_messenger_post_capture_effect_gk,android_messenger_privacy_aware_logger,android_messenger_profile_view_redirect_target,android_messenger_rage_shake_enable_loom,android_messenger_rage_shake_in_chat_heads,android_messenger_recipient_holdout_filter,android_messenger_reddit_link,android_messenger_send_or_request_money_fab,android_messenger_show_onboarding_flow,android_messenger_skip_messages_update_on_paused,android_messenger_skip_startup_prefetch,android_messenger_sms_invites_gk,android_messenger_store_in_private_storage,android_mobile_config_sampled_access_disabled,android_mqtt_fast_send,android_mqtt_log_time,android_mqtt_new_wake_lock,android_mqtt_pendingmessage_connect,android_mqtt_reconnect_back_off_fix,android_mqtt_report_connect_sent_state,android_mqttlite_health_stats_sampling,android_mqttlite_log_sampling,android_omnistore_init_using_critical_path_task,android_professional_services_booking,android_qpl_use_freemode_stats,android_qpl_use_image_stats,android_qpl_use_mobile_infra_memory_stats,android_qpl_use_mobileboost_usage,android_qpl_use_msys_info,android_qpl_use_navigation_data,android_qpl_use_nt_stats,android_qpl_use_sapienz_data,android_qpl_use_thermal_stats,android_qpl_use_traffic_transport_monitor_metadata,android_qpl_use_user_perceptible_scopes,android_qpl_use_yoga_provider,android_reliability_lacrima_gk,android_rtc_msqrd_supported,android_run_gc_on_trim,android_show_whitehat_settings,android_soft_error_disabled,android_soft_error_write_to_qpl,android_trusted_tester,android_two_phase_video_spinner,android_video_abr_instrumentation_sampling,android_video_cache_refresh_rate,android_video_delayed_vps_session_release,android_video_detect_plugin_multi_container,android_video_enable_adaptive_caption,android_video_fallback_when_no_reps,android_video_fix_social_player_reload_same_video,android_video_hash_url,android_video_init_constraints_with_highest_format,android_video_live_current_null_as_low_buffer,android_video_live_trace,android_video_live_use_contextual_parameters,android_video_log_stall_detail_event,android_video_playback_getserializable_blacklist,android_video_prefetch_when_no_reps,android_video_profiler_marauder_logging,android_video_refresh_expired_url,android_video_report_prefetch_abr_decision,android_video_resolve_cc_per_process,android_video_resolve_cc_per_video,android_video_rvp_deprecation_notice,android_video_scale_tv_at_ui_thread,android_video_send_debug_headers_to_cdn,android_video_skip_bug_report_extra,android_video_skip_texture_view_get_bitmap,android_video_treat_current_null_as_low_buffer,android_video_use_contextual_network_aware_params,android_video_use_contextual_parameters,android_video_wall_time_protect,android_video_warm_codec,android_whistle_liger_merge,android_whistle_proxy_support,android_whitehat_setting_intercept_traffic,android_zero_optin_graphql_fetch,android_zero_rating_header_request,app_module_download,boost_counters_activity_thread,boost_counters_binder,boost_counters_blockidlejobs,boost_counters_cpuboost,boost_counters_delayedanalytics,boost_counters_graphql,boost_counters_io_thread_periodic,boost_counters_litho_layout_thread,boost_counters_renderthreadboost,boost_counters_smart_fsync,boost_counters_smartgc,boost_counters_softkeyboard,boost_counters_threadaffinity,boost_counters_ui_thread,boost_counters_ui_thread_periodic,campaign_api_use_backup_rules,ccu_content_01,ctm_in_thread_warning_show_report,debug_logs_defaulted_on_android,dialtone_android_eligibility,disable_zero_h_conditional_worker,disable_zero_optin_conditional_worker,disable_zero_token_conditional_worker,enable_crashreport_gk_dump,enable_crashreport_mobileconfig_dump,enable_multi_sso_logging_killswitch,enable_rewrite_for_heroplayer_killswitch,fb4a_allow_carrier_signal_on_wifi,fb4a_enable_io_logging_across_add_dexes,fb4a_internal_relogin_gk,fb4a_report_low_memory_event,fb4a_sample_prefetch_abr_at_qpl_logger,fb_app_zero_rating,fbandroid_disable_memory_trimmable,fbandroid_network_data_logger_add_enabled_features,gk_player_service_blacklist,is_employee,is_employee_public,killswitch_zero_h_ping_conditional_worker,litho_error_boundaries,ls_enable_community_messaging,m2a_overall_calling_killswitch,m4a_nux_pna_target_country,marauder_mobile_power_metrics_logging,mature_content_rating,message_attachment_size_control,messages_android_quickcam_profile,messenger_chat_head_notif_info_action_disabled,messenger_chat_heads_android,messenger_client_analytics_android,messenger_force_full_reliability_logging_android,messenger_inbox_unit_visibility_history_logging,messenger_internal_prefs_android,messenger_list_creator_debugger,messenger_marketplace_rating_use_webview,messenger_new_friend_bump_updated_launch,messenger_new_message_anchor,messenger_notification_working_group,messenger_opened_thread_from_notif_kill_switch,messenger_preload_startup_classes_asap,messenger_sms_takeover_rollout,messenger_sticker_search_android,messenger_wear_enable,mn_cowatching_android_device_eligibility,mobile_native_soft_errors,mobile_zero_show_use_data_or_stay_free_screen,mqtt_client_network_tracing,mqtt_whistle_android_unified_client_logging,msgr_android_employee_viewability_logging_debug,msgr_nux_pna_allowlist,multidexclassloader_artnative_modelspecific,orca_invite_banner_killswitch_gk,p2p_allow_product_override,p2p_android_request_eligible,p2p_android_send,p2p_android_settings,p2p_enabled_in_groups_android,p2p_has_user_added_credential_before,p2p_v2_group_requests_android,p2p_v2_local_bubble,pages_call_deflection_upsell_card_killswitch,payments_settings_p2p_entry_point,prefetch_inbox2_only_if_necessary,prefetch_thread_list_only_if_necessary,preinflate_message_item_view,rtc_android_openh264_kill_switch,rtc_coex_script_logging,rtc_fb4a_openh264_voltron_kill_switch,rtc_h264_android_device_blacklist,rtc_h265_android_device_blacklist,rtc_use_sdp_renegotiation,services_admin_export_to_calendar,skip_mount_setvisibilityhint,sms_takeover_legacy_fallback_devices,top_level_voip_call_button,use_bootstrap_zero_native,video_inline_android_shutoff,video_prefetch_fb4a,voip_audio_mode_in_call_android,voip_audio_mode_normal_android,webrtc_disable_diagnostics_folder,whistle_android,zero_backup_rewrite_rules,zero_fb4a_timespent_fix,zero_header_send_state,zero_rating_enabled_on_wifi,zero_token_header_response,zero_token_new_unknown_state_flow,zero_torque_traffic_enforcement",
-                    "query_hash": "B2B524B9816B08FC2F38E8BAA941A8F9E02CF453",
+                    "query": "android_aborthooks_enabled,android_actionbar_panel_kb_workaround,android_allow_user_cert_override,android_always_play_live_cached_data,android_analytics_listener_bg_handler,android_block_drm_playback_hdmi,android_block_drm_screen_capture,android_chat_head_hw_accel_disabled,android_chat_heads_app_state,android_cm_holiday_card_render,android_disable_messenger_ineedinits,android_drm_blacklisted_devices,android_enable_maxwidth_prefilter,android_enable_oxygen_crash_reporter,android_enable_terminate_handler,android_enable_vod_prefetch_qs_fix,android_fb4a_enable_zero_ip_test,android_fbns_dumpsys_ids,android_game_tab_badging,android_headspin_logging,android_invite_link_phone_confirm_enable_gk,android_large_payload_support,android_learn_startvideosession_uri,android_legacy_logging_framework_gk,android_litho_enable_thread_tracing_stacktrace,android_litho_opt_visibility_handlers,android_litho_transitions_extension_290,android_loaded_library_reporting,android_messenger_android_auto_support,android_messenger_avoid_ipc_logging,android_messenger_background_contacts_upload,android_messenger_banner_triggers_omnistore,android_messenger_bug_report_on_instacrash_loop,android_messenger_camera_selfie_effect_gk,android_messenger_composer_lightweight_actions,android_messenger_contact_upload_progress_screens,android_messenger_dark_mode_opt_in,android_messenger_dark_mode_rollout,android_messenger_data_saver_mode,android_messenger_delay_analytics_during_startup,android_messenger_delay_periodic_reporters,android_messenger_employee_default_beta_web_tier,android_messenger_explicitly_adding_extensions,android_messenger_file_based_logger,android_messenger_hole_check_disabled,android_messenger_inapp_browser,android_messenger_instrumented_drawable,android_messenger_log_messaging_debug_events,android_messenger_omnistore_rage_shake_sqlite,android_messenger_p2p_payment,android_messenger_periodic_effect_prefetch_enabled,android_messenger_platform_20141218,android_messenger_platform_20150311,android_messenger_platform_20150314,android_messenger_post_capture_effect_gk,android_messenger_profile_view_redirect_target,android_messenger_rage_shake_enable_loom,android_messenger_rage_shake_in_chat_heads,android_messenger_recipient_holdout_filter,android_messenger_show_onboarding_flow,android_messenger_skip_messages_update_on_paused,android_messenger_skip_startup_prefetch,android_messenger_sms_invites_gk,android_messenger_store_in_private_storage,android_mobile_config_sampled_access_disabled,android_mqtt_fast_send,android_mqtt_log_time,android_mqtt_new_wake_lock,android_mqtt_pendingmessage_connect,android_mqtt_reconnect_back_off_fix,android_mqtt_report_connect_sent_state,android_mqtt_rtc_msg_processing_priority_urgent,android_mqttlite_health_stats_sampling,android_mqttlite_log_sampling,android_omnistore_init_using_critical_path_task,android_qpl_use_advanced_crypto_transport_info,android_qpl_use_freemode_stats,android_qpl_use_image_stats,android_qpl_use_mobile_infra_memory_stats,android_qpl_use_mobileboost_usage,android_qpl_use_msys_info,android_qpl_use_nt_stats,android_qpl_use_sapienz_data,android_qpl_use_thermal_stats,android_qpl_use_traffic_transport_monitor_metadata,android_qpl_use_user_perceptible_scopes,android_qpl_use_yoga_provider,android_reliability_lacrima_gk,android_rtc_anr_media_player,android_rtc_anr_perf_fix,android_rtc_anr_ringtone_play,android_rtc_anr_ringtone_stop,android_rtc_async_bluetooth_sco,android_rtc_async_toggle_bluetooth,android_rtc_bluetooth_check,android_run_gc_on_trim,android_show_whitehat_settings,android_soft_error_disabled,android_soft_error_write_to_qpl,android_trusted_tester,android_two_phase_video_spinner,android_video_abr_instrumentation_sampling,android_video_cache_refresh_rate,android_video_delayed_vps_session_release,android_video_enable_adaptive_caption,android_video_fallback_when_no_reps,android_video_hash_url,android_video_init_constraints_with_highest_format,android_video_live_current_null_as_low_buffer,android_video_live_trace,android_video_live_use_contextual_parameters,android_video_log_stall_detail_event,android_video_playback_getserializable_blacklist,android_video_prefetch_when_no_reps,android_video_profiler_marauder_logging,android_video_refresh_expired_url,android_video_report_prefetch_abr_decision,android_video_resolve_cc_per_process,android_video_resolve_cc_per_video,android_video_rvp_deprecation_notice,android_video_scale_tv_at_ui_thread,android_video_send_debug_headers_to_cdn,android_video_skip_bug_report_extra,android_video_skip_texture_view_get_bitmap,android_video_treat_current_null_as_low_buffer,android_video_use_contextual_network_aware_params,android_video_use_contextual_parameters,android_video_wall_time_protect,android_video_warm_codec,android_whistle_liger_merge,android_whistle_proxy_support,android_whitehat_setting_intercept_traffic,android_zero_optin_graphql_fetch,android_zero_rating_header_request,app_module_download,boost_counters_activity_thread,boost_counters_binder,boost_counters_blockidlejobs,boost_counters_cpuboost,boost_counters_delayedanalytics,boost_counters_graphql,boost_counters_io_thread_periodic,boost_counters_litho_layout_thread,boost_counters_renderthreadboost,boost_counters_smart_fsync,boost_counters_smartgc,boost_counters_softkeyboard,boost_counters_threadaffinity,boost_counters_ui_thread,boost_counters_ui_thread_periodic,ccu_content_01,ci_m4a_bloks_migration,cm_users_who_have_joined_chats,ctm_in_thread_warning_show_report,debug_logs_defaulted_on_android,dialtone_android_eligibility,disable_zero_h_conditional_worker,disable_zero_optin_conditional_worker,disable_zero_token_conditional_worker,enable_crashreport_gk_dump,enable_crashreport_mobileconfig_dump,enable_multi_sso_logging_killswitch,enable_rewrite_for_heroplayer_killswitch,fb4a_allow_carrier_signal_on_wifi,fb4a_enable_io_logging_across_add_dexes,fb4a_internal_relogin_gk,fb4a_sample_prefetch_abr_at_qpl_logger,fb_app_zero_rating,fbandroid_disable_memory_trimmable,fbandroid_network_data_logger_add_enabled_features,gk_player_service_blacklist,is_employee,is_employee_public,killswitch_zero_h_ping_conditional_worker,litho_error_boundaries,ls_enable_community_messaging,m2a_overall_calling_killswitch,m4a_nux_pna_target_country,marauder_mobile_power_metrics_logging,mature_content_rating,message_attachment_size_control,messages_android_quickcam_profile,messenger_chat_head_notif_info_action_disabled,messenger_chat_heads_android,messenger_client_analytics_android,messenger_force_full_reliability_logging_android,messenger_inbox_unit_visibility_history_logging,messenger_internal_prefs_android,messenger_list_creator_debugger,messenger_marketplace_rating_use_webview,messenger_new_message_anchor,messenger_notification_working_group,messenger_opened_thread_from_notif_kill_switch,messenger_preload_startup_classes_asap,messenger_sms_takeover_rollout,messenger_sticker_search_android,messenger_wear_enable,mn_cowatching_android_device_eligibility,mobile_native_soft_errors,mobile_zero_show_use_data_or_stay_free_screen,mqtt_client_network_tracing,mqtt_whistle_android_unified_client_logging,msgr_android_employee_viewability_logging_debug,msgr_nux_pna_allowlist,multidexclassloader_artnative_modelspecific,orca_invite_banner_killswitch_gk,p2p_allow_product_override,p2p_android_request_eligible,p2p_android_send,p2p_android_settings,p2p_enabled_in_groups_android,p2p_has_user_added_credential_before,p2p_v2_group_requests_android,p2p_v2_local_bubble,pages_call_deflection_upsell_card_killswitch,payments_settings_p2p_entry_point,prefetch_inbox2_only_if_necessary,prefetch_thread_list_only_if_necessary,preinflate_message_item_view,redirect_app_update_settings_to_appmanager_gk,remove_install_successfully_notification_setting,rtc_android_openh264_kill_switch,rtc_coex_script_logging,rtc_fb4a_openh264_voltron_kill_switch,rtc_h264_android_device_blacklist,rtc_h265_android_device_blacklist,rtc_use_sdp_renegotiation,services_admin_export_to_calendar,skip_mount_setvisibilityhint,sms_takeover_legacy_fallback_devices,use_bootstrap_zero_native,video_inline_android_shutoff,video_prefetch_fb4a,voip_audio_mode_in_call_android,voip_audio_mode_normal_android,volume_change_fix_gk,webrtc_disable_diagnostics_folder,whistle_android,zero_backup_rewrite_rules,zero_fb4a_timespent_fix,zero_header_send_state,zero_rating_enabled_on_wifi,zero_token_header_response,zero_token_new_unknown_state_flow,zero_torque_traffic_enforcement",
+                    "query_hash": "C656879E40177E5980282D66764186A24ACAB564",
                 }),
                 "name": "gk",
                 "omit_response_on_success": False,
                 "relative_url": "mobile_gatekeepers",
             },
         ]
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/http/zstd-dict.dat` & `mautrix-facebook-0.5.0/maufbapi/http/zstd-dict.dat`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/mqtt/conn.py` & `mautrix-facebook-0.5.0/maufbapi/mqtt/conn.py`

 * *Files 3% similar despite different names*

```diff
@@ -25,22 +25,22 @@
 import re
 import time
 import zlib
 
 from yarl import URL
 import paho.mqtt.client as pmc
 
+from mautrix.util import background_task
 from mautrix.util.logging import TraceLogger
+from mautrix.util.proxy import ProxyHandler, proxy_with_retry
 
-from ..proxy import ProxyHandler
 from ..state import AndroidState
 from ..thrift import ThriftObject
 from ..types import (
     MarkReadRequest,
-    MessageSyncError,
     MessageSyncPayload,
     NTContext,
     PHPOverride,
     RealtimeClientInfo,
     RealtimeConfig,
     RegionHintPayload,
     ResumeQueueRequest,
@@ -58,26 +58,33 @@
     import socks
 except ImportError:
     socks = None
 
 T = TypeVar("T")
 no_prefix_topics = (RealtimeTopic.TYPING_NOTIFICATION, RealtimeTopic.ORCA_PRESENCE)
 fb_topic_regex = re.compile(r"^(?P<topic>/[a-z_]+|\d+)(?P<extra>[|/#].+)?$")
-REQUEST_TIMEOUT = 60
+
+REQUEST_TIMEOUT = 60 * 3
+DEFAULT_KEEPALIVE = 60
+REQUEST_KEEPALIVE = 5
 
 
 # TODO add some custom stuff in these?
 class MQTTNotLoggedIn(Exception):
     pass
 
 
 class MQTTNotConnected(Exception):
     pass
 
 
+class MQTTReconnectionError(Exception):
+    pass
+
+
 class AndroidMQTT:
     _loop: asyncio.AbstractEventLoop
     _client: MQTToTClient
     log: TraceLogger
     state: AndroidState
     seq_id: int | None
     seq_id_update_callback: Callable[[int], None] | None
@@ -89,14 +96,15 @@
     _publish_waiters: dict[int, asyncio.Future]
     _response_waiters: dict[RealtimeTopic, asyncio.Future]
     _response_waiter_locks: dict[RealtimeTopic, asyncio.Lock]
     _disconnect_error: Exception | None
     _event_handlers: dict[Type[T], list[Callable[[T], Awaitable[None]]]]
     _outgoing_events: asyncio.Queue
     _event_dispatcher_task: asyncio.Task | None
+    _post_connect_task: asyncio.Task | None
 
     # region Initialization
 
     def __init__(
         self,
         state: AndroidState,
         loop: asyncio.AbstractEventLoop | None = None,
@@ -113,14 +121,15 @@
         self._opened_thread = None
         self._publish_waiters = {}
         self._response_waiters = {}
         self._disconnect_error = None
         self._response_waiter_locks = defaultdict(lambda: asyncio.Lock())
         self._event_handlers = defaultdict(lambda: [])
         self._event_dispatcher_task = None
+        self._post_connect_task = None
         self._outgoing_events = asyncio.Queue()
         self.log = log or logging.getLogger("maufbapi.mqtt")
         self._loop = loop or asyncio.get_event_loop()
         self.state = state
         self._client = MQTToTClient(
             client_id=self._form_client_id(),
             clean_session=True,
@@ -163,34 +172,26 @@
                     proxy_type=proxy_type,
                     proxy_addr=proxy_url.host,
                     proxy_port=proxy_url.port,
                     proxy_username=proxy_url.user,
                     proxy_password=proxy_url.password,
                 )
 
-    def _clear_response_waiters(self) -> None:
-        for waiter in self._response_waiters.values():
-            if not waiter.done():
-                waiter.set_exception(
-                    MQTTNotConnected("MQTT disconnected before request returned response")
-                )
+    def _clear_publish_waiters(self) -> None:
         for waiter in self._publish_waiters.values():
             if not waiter.done():
-                waiter.set_exception(
-                    MQTTNotConnected("MQTT disconnected before request was published")
-                )
-        self._response_waiters = {}
+                waiter.set_exception(MQTTNotConnected("MQTT disconnected before PUBACK received"))
         self._publish_waiters = {}
 
     def _form_client_id(self, force_password: bool = False) -> bytes:
         subscribe_topics = [
-            "/t_assist_rp",
+            RealtimeTopic.PRESENCE,
             "/t_rtc",
-            "/webrtc_response",
             "/t_rtc_log",
+            "/webrtc_response",
             RealtimeTopic.MESSAGE_SYNC,
             "/pp",
             "/webrtc",
             "/quick_promotion_refresh",
             "/t_omnistore_sync_low_pri",
             "/get_media_resp",
             "/t_dr_response",
@@ -198,16 +199,17 @@
             "/t_push",
             "/ixt_trigger",
             "/rs_resp",
             RealtimeTopic.REGION_HINT,
             "/t_trace",
             RealtimeTopic.TYPING_NOTIFICATION,
             "/sr_res",
-            "/ls_resp",
+            "/t_sp",
             "/t_rtc_multi",
+            "/ls_resp",
             # RealtimeTopic.SEND_MESSAGE_RESP,
             # RealtimeTopic.MARK_THREAD_READ_RESPONSE,
         ]
 
         if self.enable_web_presence:
             subscribe_topics.append(RealtimeTopic.ORCA_PRESENCE)
 
@@ -216,30 +218,30 @@
             for topic in subscribe_topics
         ]
         cfg = RealtimeConfig(
             client_identifier=self.state.device.uuid[:20],
             client_info=RealtimeClientInfo(
                 user_id=self.state.session.uid,
                 user_agent=self.state.user_agent_meta,
-                client_capabilities=0b1100001110110111,
+                client_capabilities=0b110110111,
                 endpoint_capabilities=0b1011010,
                 publish_format=2,
                 no_automatic_foreground=True,
                 make_user_available_in_foreground=False,
                 device_id=self.state.device.uuid,
                 is_initially_foreground=True,
                 network_type=1 if self.state.device.connection_type == "WIFI" else 0,
                 network_subtype=0 if self.state.device.connection_type == "WIFI" else 13,
                 client_mqtt_session_id=int(time.time() * 1000) & 0xFFFFFFFF,
                 subscribe_topics=topic_ids,
                 client_type="",
                 app_id=int(self.state.application.client_id),
                 region_preference=self.state.session.region_hint,
                 device_secret="",
-                client_stack=4,
+                client_stack=3,
                 network_type_info=7 if self.state.device.connection_type == "WIFI" else 4,
             ),
             password=self.state.session.access_token,
             app_specific_info={
                 "ls_sv": str(self.state.application.version_id),
                 "ls_fdid": self.state.device.fdid,
             },
@@ -285,25 +287,28 @@
                 if (
                     rc == pmc.CONNACK_REFUSED_NOT_AUTHORIZED
                     and self.connection_unauthorized_callback
                 ):
                     self.connection_unauthorized_callback()
             return
 
-        asyncio.create_task(self._post_connect())
+        self._post_connect_task = background_task.create(self._post_connect())
 
     def _on_disconnect_handler(self, client: MQTToTClient, _: Any, rc: int) -> None:
         err_str = "Generic error." if rc == pmc.MQTT_ERR_NOMEM else pmc.error_string(rc)
-        self.log.debug(f"MQTT disconnection code %d: %s", rc, err_str)
-        self._clear_response_waiters()
+        self.log.debug("MQTT disconnection code %d: %s", rc, err_str)
+        self._clear_publish_waiters()
+        if self._post_connect_task:
+            self._post_connect_task.cancel()
+            self._post_connect_task = None
 
     @property
     def _sync_queue_params(self) -> dict[str, Any]:
         return {
-            "client_delta_sync_bitmask": "CAvV/nxib6vRgAV/ss2A",
+            "client_delta_sync_bitmask": "1AgP1f58Ym+r0YAFf7LNgA",
             "graphql_query_hashes": {"xma_query_id": "0"},
             "graphql_query_params": {
                 "0": {
                     "xma_id": "<ID>",
                     "small_preview_width": 716,
                     "small_preview_height": 358,
                     "large_preview_width": 1500,
@@ -312,15 +317,15 @@
                     "full_screen_height": 4096,
                     "blur": 0,
                     "nt_context": {
                         "styles_id": NTContext().styles_id,
                         "pixel_ratio": 3,
                     },
                     "use_oss_id": True,
-                    "client_doc_id": "222672581515007895135860332111",
+                    "client_doc_id": "22267258153674992339648494933",
                 }
             },
         }
 
     @property
     def _sync_create_queue_data(self) -> dict[str, Any]:
         return {
@@ -355,17 +360,17 @@
     def _sync_resume_queue_data(self) -> ResumeQueueRequest:
         return ResumeQueueRequest(
             last_seq_id=self.seq_id,
             sync_api_version=10,
             queue_params=json.dumps(self._sync_queue_params, separators=(",", ":")),
         )
 
-    async def _post_connect(self) -> None:
+    async def _unsafe_post_connect(self) -> None:
         self._opened_thread = None
-        self.log.debug("Re-creating sync queue after reconnect")
+        self.log.debug(f"Re-creating sync queue after reconnect (seq_id={self.seq_id})")
         await self._dispatch(Connect())
         await self.publish(
             "/ls_req",
             {
                 "label": "1",
                 "payload": json.dumps(
                     {
@@ -379,14 +384,27 @@
         if self.connect_token_hash is not None:
             await self.publish(
                 RealtimeTopic.SYNC_RESUME_QUEUE, self._sync_resume_queue_data, prefix=b"\x00"
             )
         else:
             await self.publish(RealtimeTopic.SYNC_CREATE_QUEUE, self._sync_create_queue_data)
 
+    async def _post_connect(self) -> None:
+        while True:
+            try:
+                await self._unsafe_post_connect()
+            except Exception:
+                # If we ever connect, but fail to send the SYNC_* message, we end up stuck with a "working"
+                # MQTT connection but no data flowing. Always retry in this situation. The listen method
+                # should detect & raise any connection issues, so looping here is OK.
+                self.log.exception("Error publishing MQTT queue SYNC request, retrying in 5s!")
+                await asyncio.sleep(5)
+            else:
+                return
+
     def _on_publish_handler(self, client: MQTToTClient, _: Any, mid: int) -> None:
         try:
             waiter = self._publish_waiters.pop(mid)
         except KeyError:
             return
         if not waiter.done():
             waiter.set_result(None)
@@ -402,33 +420,33 @@
         try:
             parsed = MessageSyncPayload.from_thrift(payload)
         except Exception:
             self.log.debug("Failed to parse message sync payload %s", payload, exc_info=True)
             return
         self._update_seq_id(parsed)
         if parsed.error:
-            asyncio.create_task(self._dispatch(parsed.error))
+            background_task.create(self._dispatch(parsed.error))
         for item in parsed.items:
             for event in item.get_parts():
                 self._outgoing_events.put_nowait(event)
         if parsed.items and not self._event_dispatcher_task:
             self._event_dispatcher_task = asyncio.create_task(self._dispatcher_loop())
 
     def _on_typing_notification(self, payload: bytes) -> None:
         try:
             parsed = TypingNotification.from_thrift(payload)
         except Exception:
             self.log.debug("Failed to parse typing notification %s", payload, exc_info=True)
             return
-        asyncio.create_task(self._dispatch(parsed))
+        background_task.create(self._dispatch(parsed))
 
     def _on_presence(self, payload: bytes) -> None:
         try:
             presence = Presence.deserialize(json.loads(payload))
-            asyncio.create_task(self._dispatch(presence))
+            background_task.create(self._dispatch(presence))
         except Exception:
             self.log.debug("Failed to parse presence payload %s", payload, exc_info=True)
             return
 
     def _on_region_hint(self, payload: bytes) -> None:
         rhp = RegionHintPayload.from_thrift(payload)
         if self.region_hint_callback:
@@ -452,14 +470,17 @@
 
             if topic == RealtimeTopic.MESSAGE_SYNC:
                 self._on_message_sync(message.payload)
             elif topic == RealtimeTopic.TYPING_NOTIFICATION:
                 self._on_typing_notification(message.payload)
             elif topic == RealtimeTopic.ORCA_PRESENCE:
                 self._on_presence(message.payload)
+            elif topic == RealtimeTopic.PRESENCE:
+                # TODO remove orca_presence support and use this instead
+                self.log.trace("Got presence payload: %s", message.payload)
             elif topic == RealtimeTopic.REGION_HINT:
                 self._on_region_hint(message.payload)
             else:
                 try:
                     waiter = self._response_waiters.pop(topic)
                 except KeyError:
                     self.log.debug("No handler for MQTT message in %s: %s", topic, message.payload)
@@ -476,18 +497,18 @@
             self.log.exception("Error in incoming MQTT message handler")
             self.log.trace("Errored MQTT payload: %s", message.payload)
 
     # endregion
 
     async def _reconnect(self) -> None:
         try:
-            self.log.trace("Trying to reconnect to MQTT")
             self._client.reconnect()
         except (SocketError, OSError, pmc.WebsocketConnectionError) as e:
-            raise MQTTNotLoggedIn("MQTT reconnection failed") from e
+            self.log.exception("Error reconnecting to MQTT")
+            raise MQTTReconnectionError("MQTT reconnection failed") from e
 
     def add_event_handler(
         self, evt_type: Type[T], handler: Callable[[T], Awaitable[None]]
     ) -> None:
         self._event_handlers[evt_type].append(handler)
 
     async def _dispatch(self, evt: T) -> None:
@@ -517,81 +538,107 @@
                 )
             while not tasks.empty():
                 await self._dispatch(tasks.get_nowait())
             raise
         finally:
             self.log.debug(f"Dispatcher loop {loop_id} stopped")
 
-    async def listen(self, seq_id: int, retry_limit: int = 5) -> None:
+    async def listen(self, seq_id: int, retry_limit: int = 10) -> None:
         self.seq_id = seq_id
 
         self.log.debug("Connecting to Messenger MQTT")
-        await self._reconnect()
-        connection_retries = 0
 
-        while True:
-            try:
-                await asyncio.sleep(1)
-            except asyncio.CancelledError:
-                self.disconnect()
-                # this might not be necessary
-                self._client.loop_misc()
-                break
-            rc = self._client.loop_misc()
-
-            # If disconnect() has been called
-            # Beware, internal API, may have to change this to something more stable!
-            if self._client._state == pmc.mqtt_cs_disconnecting:
-                break  # Stop listening
-
-            if rc != pmc.MQTT_ERR_SUCCESS:
-                # If known/expected error
-                if rc == pmc.MQTT_ERR_CONN_LOST:
-                    await self._dispatch(Disconnect(reason="Connection lost, retrying"))
-                elif rc == pmc.MQTT_ERR_NOMEM:
-                    # This error is wrongly classified
-                    # See https://github.com/eclipse/paho.mqtt.python/issues/340
-                    await self._dispatch(Disconnect(reason="Connection lost, retrying"))
-                elif rc == pmc.MQTT_ERR_CONN_REFUSED:
-                    raise MQTTNotLoggedIn("MQTT connection refused")
-                elif rc == pmc.MQTT_ERR_NO_CONN:
-                    if connection_retries > retry_limit:
-                        raise MQTTNotConnected(f"Connection failed {connection_retries} times")
-                    if self.proxy_handler.update_proxy_url():
-                        self.setup_proxy()
-                        await self._dispatch(ProxyUpdate())
-                    sleep = connection_retries * 2
-                    msg = f"MQTT Error: no connection, retrying in {connection_retries} seconds"
-                    await self._dispatch(Disconnect(reason=msg))
-                    await asyncio.sleep(sleep)
-                else:
-                    err = pmc.error_string(rc)
-                    self.log.error("MQTT Error: %s", err)
-                    await self._dispatch(Disconnect(reason=f"MQTT Error: {err}, retrying"))
+        async def connect_and_watch():
+            await self._reconnect()
+
+            while True:
+                try:
+                    await asyncio.sleep(1)
+                except asyncio.CancelledError:
+                    self.disconnect()
+                    # this might not be necessary
+                    self._client.loop_misc()
+                    return
+                rc = self._client.loop_misc()
+
+                # If disconnect() has been called
+                # Beware, internal API, may have to change this to something more stable!
+                if self._client._state == pmc.mqtt_cs_disconnecting:
+                    return  # Stop listening
+
+                if rc != pmc.MQTT_ERR_SUCCESS:
+                    # If known/expected error
+                    if rc == pmc.MQTT_ERR_CONN_LOST:
+                        await self._dispatch(Disconnect(reason="Connection lost, retrying"))
+                        raise MQTTNotConnected("MQTT_ERR_CONN_LOST")
+                    elif rc == pmc.MQTT_ERR_NOMEM:
+                        # This error is wrongly classified
+                        # See https://github.com/eclipse/paho.mqtt.python/issues/340
+                        await self._dispatch(Disconnect(reason="Connection lost, retrying"))
+                        raise MQTTNotConnected("MQTT_ERR_NOMEM")
+                    elif rc == pmc.MQTT_ERR_CONN_REFUSED:
+                        await self._dispatch(Disconnect(reason="Connection refused, retrying"))
+                        raise MQTTNotLoggedIn("MQTT_ERR_CONN_REFUSED")
+                    elif rc == pmc.MQTT_ERR_NO_CONN:
+                        await self._dispatch(Disconnect(reason="Connection dropped, retrying"))
+                        raise MQTTNotConnected("MQTT_ERR_NO_CONN")
+                    else:
+                        err = pmc.error_string(rc)
+                        self.log.error("MQTT Error: %s", err)
+                        await self._dispatch(Disconnect(reason=f"MQTT Error: {err}, retrying"))
+                        raise MQTTNotConnected(err)
+
+        await proxy_with_retry(
+            "mqtt.listen",
+            lambda: connect_and_watch(),
+            logger=self.log,
+            proxy_handler=self.proxy_handler,
+            on_proxy_change=lambda: self._dispatch(ProxyUpdate()),
+            max_retries=retry_limit,
+            retryable_exceptions=(MQTTNotConnected, MQTTReconnectionError),
+            # Wait 1s * errors, max 5s for fast reconnect or die
+            max_wait_seconds=5,
+            multiply_wait_seconds=1,
+            # If connection stable for >1h, reset the error counter
+            reset_after_seconds=3600,
+        )
 
-                await self._reconnect()
-                connection_retries += 1
-            else:
-                connection_retries = 0
         if self._event_dispatcher_task:
             self._event_dispatcher_task.cancel()
             self._event_dispatcher_task = None
         if self._disconnect_error:
             self.log.info("disconnect_error is set, raising and clearing variable")
             err = self._disconnect_error
             self._disconnect_error = None
             raise err
 
     # region Basic outgoing MQTT
 
     @staticmethod
-    def _cancel_later(fut: asyncio.Future) -> None:
+    def _publish_cancel_later(fut: asyncio.Future) -> None:
+        if not fut.done():
+            fut.set_exception(asyncio.TimeoutError("MQTT publish timed out"))
+
+    @staticmethod
+    def _request_cancel_later(fut: asyncio.Future) -> None:
         if not fut.done():
             fut.set_exception(asyncio.TimeoutError("MQTT request timed out"))
 
+    # The following two functions mutate the client keepalive (cheeky) to temporarily increase
+    # ping attempts during read/write to MQTT. If things are flowing this should change nothing,
+    # as pings only send when idle. It should, however, allow the client to detect a bad MQTT
+    # connection much quicker than the default keepalive.
+    def set_request_keepalive(self):
+        self._client._keepalive = REQUEST_KEEPALIVE
+
+    def maybe_reset_keepalive(self):
+        # Reset the keepalive back to the default value if we have no pending publish/receive
+        if not self._response_waiters and not self._publish_waiters:
+            self._client._keepalive = DEFAULT_KEEPALIVE
+
     def publish(
         self,
         topic: RealtimeTopic | str,
         payload: str | bytes | dict | ThriftObject,
         prefix: bytes = b"",
         compress: bool = True,
     ) -> asyncio.Future:
@@ -601,36 +648,44 @@
             payload = payload.encode("utf-8")
         if isinstance(payload, ThriftObject):
             payload = payload.to_thrift()
         if compress:
             payload = zlib.compress(prefix + payload, level=9)
         elif prefix:
             payload = prefix + payload
+        self.set_request_keepalive()
         info = self._client.publish(
             topic.encoded if isinstance(topic, RealtimeTopic) else topic, payload, qos=1
         )
         fut = self._loop.create_future()
-        timeout_handle = self._loop.call_later(REQUEST_TIMEOUT, self._cancel_later, fut)
-        fut.add_done_callback(timeout_handle.cancel)
+        timeout_handle = self._loop.call_later(REQUEST_TIMEOUT, self._publish_cancel_later, fut)
+        fut.add_done_callback(lambda _: timeout_handle.cancel())
+        fut.add_done_callback(lambda _: self.maybe_reset_keepalive())
         self._publish_waiters[info.mid] = fut
         return fut
 
     async def request(
         self,
         topic: RealtimeTopic,
         response: RealtimeTopic,
         payload: str | bytes | dict | ThriftObject,
         prefix: bytes = b"",
     ) -> pmc.MQTTMessage:
         async with self._response_waiter_locks[response]:
             fut = self._loop.create_future()
             self._response_waiters[response] = fut
-            await self.publish(topic, payload, prefix)
-            timeout_handle = self._loop.call_later(REQUEST_TIMEOUT, self._cancel_later, fut)
-            fut.add_done_callback(timeout_handle.cancel)
+            background_task.create(self.publish(topic, payload, prefix))
+            self.log.debug(
+                f"Request publish to {topic.value} queued, waiting for response {response.name}"
+            )
+            timeout_handle = self._loop.call_later(
+                REQUEST_TIMEOUT, self._request_cancel_later, fut
+            )
+            fut.add_done_callback(lambda _: timeout_handle.cancel())
+            fut.add_done_callback(lambda _: self.maybe_reset_keepalive())
             return await fut
 
     @staticmethod
     def generate_offline_threading_id() -> int:
         rand = format(int(random.random() * 4294967295), "022b")[-22:]
         return int(f"{int(time.time() * 1000):b}{rand}", 2)
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/mqtt/events.py` & `mautrix-facebook-0.5.0/maufbapi/mqtt/events.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/mqtt/otclient.py` & `mautrix-facebook-0.5.0/maufbapi/mqtt/otclient.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/mqtt/subscription.py` & `mautrix-facebook-0.5.0/maufbapi/mqtt/subscription.py`

 * *Files 5% similar despite different names*

```diff
@@ -35,14 +35,15 @@
     REGION_HINT = "/t_region_hint"
     MARK_THREAD_READ = "/t_mt_req"
     MARK_THREAD_READ_RESPONSE = "/t_mt_resp"
     OPENED_THREAD = "/opened_thread"
     TYPING_NOTIFICATION = "/t_tn"
     SET_TYPING = "/t_st"
     ORCA_PRESENCE = "/orca_presence"
+    PRESENCE = "/t_p"
 
     @property
     def encoded(self) -> str:
         return topic_map[self.value]
 
     @staticmethod
     def decode(val: str) -> RealtimeTopic | str:
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/mqtt/topics.json` & `mautrix-facebook-0.5.0/maufbapi/mqtt/topics.json`

 * *Files 2% similar despite different names*

#### Pretty-printed

 * *Similarity: 0.995260663507109%*

 * *Differences: {"'/ig_large_scale_fire_and_forget_sync'": '279'}*

```diff
@@ -36,14 +36,15 @@
     "/get_media_resp": 90,
     "/graphql": 9,
     "/group_msg": 10,
     "/group_msgs_unseen": 12,
     "/group_notifs_unseen": 11,
     "/groups_landing_updates": 93,
     "/ig_conn_update": 164,
+    "/ig_large_scale_fire_and_forget_sync": 279,
     "/ig_message_sync": 146,
     "/ig_msg_dr": 165,
     "/ig_realtime_sub": 149,
     "/ig_region_hint_rp": 161,
     "/ig_send_message": 132,
     "/ig_send_message_response": 133,
     "/ig_snapshot_response": 136,
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/state.py` & `mautrix-facebook-0.5.0/maufbapi/state.py`

 * *Files 2% similar despite different names*

```diff
@@ -23,19 +23,19 @@
 
 from mautrix.types import SerializableAttrs
 
 
 @dataclass
 class AndroidApplication(SerializableAttrs):
     name: str = "Orca-Android"
-    version: str = "346.0.0.7.117"
+    version: str = "388.0.0.23.106"
     id: str = "com.facebook.orca"
     locale: str = "en_US"
-    build: int = 348143456
-    version_id: int = 4663247527104165
+    build: int = 423808514
+    version_id: int = 5840539252670510
 
     client_id = "256002347743983"
     client_secret = "374e60f8b9bb6b8cbb30f78030438895"
 
     @classmethod
     def deserialize(cls, data) -> "AndroidApplication":
         data.pop("build", None)
@@ -49,18 +49,18 @@
 
 
 @dataclass
 class AndroidDevice(SerializableAttrs):
     manufacturer: str = "Google"
     builder: str = "google"
     name: str = "Pixel 3"
-    software: str = "11"
+    software: str = "12"
     architecture: str = "arm64-v8a:null"
     dimensions: str = "{density=2.75,width=1080,height=2028}"
-    user_agent: str = "Dalvik/2.1.0 (Linux; U; Android 11; Pixel 3 Build/RQ3A.211001.001)"
+    user_agent: str = "Dalvik/2.1.0 (Linux; U; Android 12; Pixel 3 Build/SP1A.210812.016.C2)"
 
     connection_type: str = "WIFI"
     connection_quality: str = "EXCELLENT"
     language: str = "en_US"
     country_code: str = "US"
 
     uuid: Optional[str] = None
@@ -145,14 +145,18 @@
             "FBCR": self.carrier.name,
             "FBMF": self.device.manufacturer,
             "FBBD": self.device.builder,
             "FBDV": self.device.name,
             "FBSV": self.device.software,
             "FBCA": self.device.architecture,
             "FBDM": self.device.dimensions,
+            # MQTT only?
+            "FBBK": "1",
+            "FBLR": "0",
+            # HTTP only?
             "FB_FW": "1",
         }
 
     @property
     def user_agent_meta(self) -> str:
         ua_meta = ";".join(f"{key}/{value}" for key, value in self._ua_parts.items())
         return f"[{ua_meta};]"
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/thrift/autospec.py` & `mautrix-facebook-0.5.0/maufbapi/thrift/autospec.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/thrift/read.py` & `mautrix-facebook-0.5.0/maufbapi/thrift/read.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/thrift/type.py` & `mautrix-facebook-0.5.0/maufbapi/thrift/type.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/thrift/write.py` & `mautrix-facebook-0.5.0/maufbapi/thrift/write.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/__init__.py` & `mautrix-facebook-0.5.0/maufbapi/types/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -8,27 +8,30 @@
     GraphQLMutation,
     GraphQLQuery,
     ImageFragment,
     MessageList,
     MessageReactionMutation,
     MessageUndoSend,
     MessageUnsendResponse,
+    MinimalThreadListResponse,
     MoreMessagesQuery,
+    MoreThreadsQuery,
     NTContext,
     ReactionAction,
     SearchEntitiesNamedQuery,
     SearchEntitiesResponse,
     StickerPreviewResponse,
     SubsequentMediaQuery,
     SubsequentMediaResponse,
     ThreadListQuery,
     ThreadListResponse,
     ThreadNameMutation,
     ThreadQuery,
     ThreadQueryResponse,
+    UsersQuery,
 )
 from .login import LoginResponse, MobileConfig, PasswordKeyResponse
 from .media import UploadErrorData, UploadResponse
 from .mqtt import (
     MarkReadRequest,
     MessageSyncError,
     MessageSyncPayload,
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/common.py` & `mautrix-facebook-0.5.0/maufbapi/types/common.py`

 * *Files 5% similar despite different names*

```diff
@@ -27,7 +27,8 @@
 
 
 class ThreadFolder(SerializableEnum):
     INBOX = "INBOX"
     PENDING = "PENDING"
     ARCHIVED = "ARCHIVED"
     OTHER = "OTHER"
+    COMMUNITY = "COMMUNITY"
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/graphql/__init__.py` & `mautrix-facebook-0.5.0/maufbapi/types/graphql/__init__.py`

 * *Files 12% similar despite different names*

```diff
@@ -4,23 +4,25 @@
     FetchStickersWithPreviewsQuery,
     FileAttachmentUrlQuery,
     GraphQLMutation,
     GraphQLQuery,
     MessageReactionMutation,
     MessageUndoSend,
     MoreMessagesQuery,
+    MoreThreadsQuery,
     NTContext,
     ReactionAction,
     SearchEntitiesNamedQuery,
     SubsequentMediaQuery,
     ThreadListQuery,
     ThreadMessageID,
     ThreadNameMutation,
     ThreadNameMutationSource,
     ThreadQuery,
+    UsersQuery,
 )
 from .responses import (
     Attachment,
     AttachmentType,
     Coordinates,
     Dimensions,
     ExtensibleAttachment,
@@ -36,21 +38,23 @@
     MessageRange,
     MessageSender,
     MessageText,
     MessageUnsendResponse,
     MinimalMessage,
     MinimalParticipant,
     MinimalSticker,
+    MinimalThreadListResponse,
     MontageReplyData,
     OwnInfo,
     PageInfo,
     Participant,
     ParticipantID,
     ParticipantList,
     ParticipantNode,
+    ParticipantType,
     Picture,
     Reaction,
     ReadReceipt,
     ReadReceiptList,
     Reply,
     ReplyStatus,
     SearchEntitiesResponse,
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/graphql/queries.py` & `mautrix-facebook-0.5.0/maufbapi/types/graphql/queries.py`

 * *Files 11% similar despite different names*

```diff
@@ -26,35 +26,37 @@
 _analytics_tags_2 = ["nav_attribution_id=null", "visitation_id=null", "GraphServices"]
 
 
 class GraphQLQuery(ABC, Serializable):
     caller_class: ClassVar[str] = "graphservice"
     analytics_tags: ClassVar[List[str]] = ["GraphServices"]
     include_client_country_code: ClassVar[bool] = False
-    doc_id: ClassVar[int]
+    client_doc_id: ClassVar[int] = None
+    doc_id: ClassVar[Optional[int]] = None
 
 
 class GraphQLMutation(GraphQLQuery, ABC):
     pass
 
 
 @dataclass
 class NTContext(SerializableAttrs):
-    styles_id: str = "632609037bc0e06f1115e7af19c2feae"
+    styles_id: str = "f0533d91def8d61a3313ed598b05d1c6"
     using_white_navbar: bool = True
     pixel_ratio: int = 3
-    bloks_version: str = "b1ddbd8ab663f5139265edaa2524450988475f61c5fcd3b06eb7fa9fb1033586"
+    bloks_version: str = "fc56cdee608566949092d23ea9734b8278cc3cf04203956a29db3898eca10b9e"
+    is_push_on: bool = True
 
 
 @dataclass
 class ThreadQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 5123202644403703
+    client_doc_id: ClassVar[int] = 261428482816184255718129058618
 
     thread_ids: List[str]
-    msg_count: int = 20
+    msg_count: int = 20  # 100
 
     blur: int = 0
 
     nt_context: NTContext = attr.ib(factory=lambda: NTContext())
     include_full_user_info: str = "true"
     include_message_info: str = "true"
     include_booking_requests: bool = True
@@ -65,19 +67,20 @@
     large_preview_height: int = 750
     medium_preview_width: int = 962
     medium_preview_height: int = 481
     small_preview_width: int = 716
     small_preview_height: int = 358
     profile_pic_large_size: int = 880
     profile_pic_small_size: int = 138
+    scale: str = "3"
 
 
 @dataclass
 class ThreadListQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 4669664453079908
+    client_doc_id: ClassVar[int] = 42489038484109023297878016725
 
     msg_count: int = 20
     thread_count: int = 20
     include_thread_info: str = "true"
     include_message_info: str = "true"
     fetch_users_separately: str = "false"
     filter_to_groups: str = "false"
@@ -91,19 +94,41 @@
     theme_icon_size_small: int = 66
     reaction_static_asset_size_small: int = 39
     profile_pic_medium_size: int = 220
     profile_pic_large_size: int = 880
     profile_pic_small_size: int = 138
     theme_background_size: int = 2048
     theme_icon_size_large: int = 138
+    scale: str = "3"
+
+
+@dataclass
+class MoreThreadsQuery(GraphQLQuery, SerializableAttrs):
+    client_doc_id: ClassVar[int] = 101371284010298159468949651434
+
+    after_time_ms: str
+
+    msg_count: int = 20
+    thread_count: int = 20
+    include_full_user_info: str = "true"
+    fetch_users_separately: str = "false"
+    filter_to_groups: str = "false"
+    include_message_info: str = "true"
+
+    profile_pic_medium_size: int = 220
+    profile_pic_large_size: int = 880
+    profile_pic_small_size: int = 138
+    scale: str = "3"
+
+    nt_context: NTContext = attr.ib(factory=lambda: NTContext())
 
 
 @dataclass
 class MoreMessagesQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 5045216125512296
+    client_doc_id: ClassVar[int] = 26340105474757789559325557719
 
     before_time_ms: str
     thread_id: str
     msg_count: int = 20
     blur: int = 0
 
     nt_context: NTContext = attr.ib(factory=lambda: NTContext())
@@ -112,92 +137,93 @@
     full_screen_height: int = 4096
     large_preview_width: int = 1500
     large_preview_height: int = 750
     medium_preview_width: int = 962
     medium_preview_height: int = 481
     small_preview_width: int = 716
     small_preview_height: int = 358
+    scale: str = "3"
 
 
 class ThreadNameMutationSource(SerializableEnum):
     SETTINGS = "SETTINGS"
 
 
 @dataclass
 class ThreadNameMutation(GraphQLMutation, SerializableAttrs):
-    doc_id: ClassVar[int] = 4678460715515343
+    client_doc_id: ClassVar[int] = 245687281615266693919061310962
 
     new_thread_name: str
     thread_id: str
     client_mutation_id: str
     actor_id: str
     source: ThreadNameMutationSource = ThreadNameMutationSource.SETTINGS
 
 
 @dataclass
 class FetchStickersWithPreviewsQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 4028336233932975
+    client_doc_id: ClassVar[int] = 401999615114001344821502923121
     caller_class: ClassVar[str] = "NewMessageHandlerHelper"
     include_client_country_code: ClassVar[bool] = True
 
     sticker_ids: List[str]
     preview_size: int = 165
     animated_media_type: str = "image/webp"
     media_type: str = "image/webp"
     scaling_factor: str = "2.75"
     sticker_labels_enabled: bool = False
     sticker_state_enabled: bool = False
 
 
 @dataclass
 class MessageUndoSend(GraphQLMutation, SerializableAttrs):
-    doc_id: ClassVar[int] = 1015037405287590
+    client_doc_id: ClassVar[int] = 651600610198736392087694690
     analytics_tags: ClassVar[List[str]] = _analytics_tags_2
 
     message_id: str
     client_mutation_id: str
     actor_id: str
 
 
 class ReactionAction(SerializableEnum):
     ADD = "ADD_REACTION"
     REMOVE = "REMOVE_REACTION"
 
 
 @dataclass
 class MessageReactionMutation(GraphQLMutation, SerializableAttrs):
-    doc_id: ClassVar[int] = 4581961245172668
+    client_doc_id: ClassVar[int] = 3059927964988005121571400082
     analytics_tags: ClassVar[List[str]] = _analytics_tags_2
 
     message_id: str
     client_mutation_id: str
     actor_id: str
     action: ReactionAction
     reaction: Optional[str] = None
 
 
 @dataclass
 class DownloadImageFragment(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 3063616537053520
+    client_doc_id: ClassVar[int] = 2226154139486245861670820706
 
     fbid: str
     img_size: str = "0"
 
 
 @dataclass
 class FbIdToCursorQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 2015407048575350
+    client_doc_id: ClassVar[int] = 2985653443947768641342601552
 
     fbid: str
     thread_id: str
 
 
 @dataclass
 class SubsequentMediaQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 4376490155778570
+    client_doc_id: ClassVar[int] = 42018352655156159811465888541
 
     thread_id: str
     cursor_id: Optional[str] = None
     fetch_size: int = 99
     thumbnail_size: int = 540
     height: int = 2088
     width: int = 1080
@@ -207,22 +233,22 @@
 class ThreadMessageID(SerializableAttrs):
     thread_id: str
     message_id: str
 
 
 @dataclass
 class FileAttachmentUrlQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 3200288700012393
+    client_doc_id: ClassVar[int] = 172089622313141855796265222507
 
     thread_msg_id: ThreadMessageID
 
 
 @dataclass
 class SearchEntitiesNamedQuery(GraphQLQuery, SerializableAttrs):
-    doc_id: ClassVar[int] = 4883329948399448
+    client_doc_id: ClassVar[int] = 412264286114708880472128431895
 
     search_query: str
     session_id: Optional[str] = None
 
     results_limit: int = 20
     num_users_query: int = 20
     num_group_threads_query: int = 20
@@ -238,14 +264,15 @@
 
     profile_pic_large_size: int = 880
     profile_pic_medium_size: int = 220
     profile_pic_small_size: int = 138
 
 
 @dataclass
-class UpdateThreadCopresence(GraphQLMutation, SerializableAttrs):
-    doc_id: ClassVar[int] = 3020568468070941
-    analytics_tags: ClassVar[List[str]] = _analytics_tags_2
+class UsersQuery(GraphQLQuery, SerializableAttrs):
+    client_doc_id: ClassVar[int] = 12889174649061980331350648993
+
+    user_fbids: List[str]
 
-    thread_key: str
-    presence_state: str = "IN_THREAD"
-    capabilities: int = 1
+    profile_pic_large_size: int = 880
+    profile_pic_medium_size: int = 220
+    profile_pic_small_size: int = 138
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/graphql/responses.py` & `mautrix-facebook-0.5.0/maufbapi/types/graphql/responses.py`

 * *Files 2% similar despite different names*

```diff
@@ -108,14 +108,15 @@
     REACHABLE = "REACHABLE"
     UNREACHABLE_USER_TYPE = "UNREACHABLE_USER_TYPE"
 
 
 class ParticipantType(ExtensibleEnum):
     USER = "User"
     PAGE = "Page"
+    INSTAGRAM = "InstagramMessagingUser"
 
 
 @dataclass(kw_only=True)
 class Participant(MinimalParticipant, SerializableAttrs):
     typename: ParticipantType = attr.ib(metadata={"json": "__typename"})
 
     username: Optional[str] = None
@@ -357,38 +358,71 @@
 class ActionLink(SerializableAttrs):
     typename_str: str = field(json="__typename")  # e.g. GroupJoinActionLink
     title: Optional[str] = None
     url: Optional[str] = None
 
 
 @dataclass
+class CallToAction(SerializableAttrs):
+    # attachment_fbid: str
+    # message_id: str
+    # thread_key: str
+    # title: str
+    type: Optional[str] = None  # xma_open_native
+    action_url: Optional[str] = None
+    native_url: Optional[str] = None
+    # target_id: str
+
+
+@dataclass
+class XMATemplateExtra(SerializableAttrs):
+    # preview_image_decoration_type: str
+    # max_title_lines: int
+    default_cta: Optional[CallToAction] = None
+
+
+@dataclass
 class StoryAttachment(SerializableAttrs):
     title: str
     url: Optional[str] = None
     # TODO enum? share, message_location, attached_story, photo, games_app, messenger_native_templates, unavailable, fallback, marketplace_generic_xma
     style_list: List[str] = attr.ib(factory=lambda: [])
     title_with_entities: Optional[ExtensibleText] = None
     description: Optional[ExtensibleText] = None
     source: Optional[ExtensibleText] = None
     subtitle: Optional[str] = None
     target: Optional[StoryTarget] = None
     deduplication_key: Optional[str] = None
     media: Optional[StoryMediaAttachment] = None
     action_links: List[ActionLink] = None
+    xma_tpl_extra: Optional[XMATemplateExtra] = field(
+        default=None, json="messenger_generic_xma_template_extra_info"
+    )
 
     @property
     def clean_url(self) -> URL:
         url = URL(self.url)
         if url.host == "l.facebook.com":
             url = URL(url.query["u"])
         elif url.scheme == "fbrpc" and url.host == "facebook" and url.path == "/nativethirdparty":
             url = URL(url.query["target_url"])
         return url
 
     @property
+    def xma_tpl_url(self) -> Optional[URL]:
+        if not self.xma_tpl_extra or not self.xma_tpl_extra.default_cta:
+            return None
+        url = (
+            self.xma_tpl_extra.default_cta.native_url or self.xma_tpl_extra.default_cta.action_url
+        )
+        if not url:
+            return None
+        return URL(url).with_query(None)
+
+    @property
     def is_likely_bridgeable(self) -> bool:
         return bool(
             (self.target and self.target.typename == AttachmentType.EXTERNAL_URL)
             or (self.url and self.title)
             or self.media
         )
 
@@ -530,15 +564,15 @@
     unread_count: int
     unsend_limit: int
     mute_until: Optional[int]
     privacy_mode: int
     thread_pin_timestamp: int
     thread_queue_enabled: bool
     thread_unsendability_status: MessageUnsendability
-    update_time_precise: Optional[str] = None
+    updated_time_precise: str
 
     last_message: MessageList
     messages: MessageList
     read_receipts: ReadReceiptList
     all_participants: ParticipantList
     customization_info: ThreadCustomizationInfo
 
@@ -552,23 +586,33 @@
     is_ignored_by_viewer: bool
     is_pinned: bool
     is_viewer_allowed_to_add_members: bool
     is_viewer_subscribed: bool
     can_viewer_reply: bool
     can_participants_claim_admin: bool
 
+    sync_sequence_id: Optional[str] = None
+
+    @property
+    def updated_timestamp(self) -> int:
+        return int(self.updated_time_precise)
+
 
 @dataclass
-class ThreadListResponse(SerializableAttrs):
+class MinimalThreadListResponse(SerializableAttrs):
+    nodes: List[Thread]
+    page_info: PageInfo
+
+
+@dataclass
+class ThreadListResponse(MinimalThreadListResponse, SerializableAttrs):
     count: int
     unread_count: int
     unseen_count: int
     mute_until: int
-    nodes: List[Thread]
-    page_info: PageInfo
     sync_sequence_id: str
 
 
 @dataclass
 class ThreadQueryResponse(SerializableAttrs):
     message_threads: List[Thread]
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/login.py` & `mautrix-facebook-0.5.0/maufbapi/types/login.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/media.py` & `mautrix-facebook-0.5.0/maufbapi/types/media.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/mqtt/__init__.py` & `mautrix-facebook-0.5.0/maufbapi/types/mqtt/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 from .client_info import PHPOverride, RealtimeClientInfo, RealtimeConfig, UnknownStruct
 from .message import (
     AddMember,
     AddMemberParticipant,
     Attachment,
     AudioInfo,
     AvatarChange,
+    DeltaRTCMultiwayMessage,
     ExtendedAddMember,
     ExtendedAddMemberParticipant,
     ExtendedMessage,
     ForcedFetch,
     ImageInfo,
     Mention,
     MentionType,
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/mqtt/client_info.py` & `mautrix-facebook-0.5.0/maufbapi/types/mqtt/client_info.py`

 * *Files 2% similar despite different names*

```diff
@@ -38,15 +38,15 @@
     client_mqtt_session_id: int = field(TType.I64)
     client_ip_address: str = None
     subscribe_topics: List[int] = field(TType.LIST, item_type=TType.I32)
     client_type: str
     app_id: int = field(TType.I64)
     override_nectar_logging: bool = None
     connect_token_hash: bytes = None
-    region_preference: str
+    region_preference: str = None
     device_secret: str
     client_stack: int = field(TType.BYTE)
     fbns_connection_key: int = field(TType.I64, default=None)
     fbns_connection_secret: str = None
     fbns_device_id: str = None
     fbns_device_secret: str = None
     luid: int = field(TType.I64, default=None)
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/mqtt/message.py` & `mautrix-facebook-0.5.0/maufbapi/types/mqtt/message.py`

 * *Files 2% similar despite different names*

```diff
@@ -325,14 +325,22 @@
     timestamp: int = field(TType.I64)
     user_id: int = field(TType.I64)
     # index 5: unknown int64 (ex: 0)
 
 
 @autospec
 @dataclass(kw_only=True)
+class DeltaRTCMultiwayMessage(ThriftObject):
+    data: bytes
+    timestamp: int = field(TType.I64)
+    event: str = field(index=3)
+
+
+@autospec
+@dataclass(kw_only=True)
 class PowerUpMessageWrap(ThriftObject):
     message: Message
 
 
 @autospec
 @dataclass(kw_only=True)
 class PowerUpMessage(ThriftObject):
@@ -425,15 +433,15 @@
     # 63: deltaMessagingFolderSettingUpdate
     # 64: deltaThreadConnectivityStatusUpdate
     # 65: deltaMessengerThreadActivityBannerUpdate
     # 66: deltaLivingRoomStatusUpdate
     unsend_message: UnsendMessage = field(index=67, default=None)  # deltaRecallMessageData
     # 68: deltaMentorshipUpdate
     # 69: deltaPageUnSubscribeStatus
-    # 70: deltaRTCMultiwayMessage
+    delta_rtc_multiway_message: DeltaRTCMultiwayMessage = field(index=70, default=None)
     # 71: deltaMessengerRelationshipEventEligibilityUpdate
     # 72: deltaSchoolChatShouldShowInviteScreenUpdate
     # 73: deltaMessengerAdsConversionUpdate
     # 74: deltaUpdateSavedMessage
     # 75: deltaTweensAnswerWouldYouRather
     # 76: deltaMessageVoiceTranscription
     # 77: deltaPageBlurredImageStatus
@@ -553,14 +561,19 @@
 
     # action_data:
     #    'added_option_ids': '<option ids>' (this is a string with a list inside)
     #    'removed_option_ids': '<option ids>' (this is a string with a list inside)
     #    'question_json': JSON of the question
     POLL = "group_poll"
 
+    # action_data:
+    #    'event': 'group_call_started', 'group_call_ended', 'missed_call'
+    #    'video': '1' or '0'
+    CALL_LOG = "messenger_call_log"
+
 
 @autospec
 @dataclass(kw_only=True)
 class ThreadChange(ThriftObject):
     metadata: MessageMetadata
     action: ThreadChangeAction = field(TType.BINARY)
     action_data: Dict[str, str] = field(
@@ -694,22 +707,24 @@
                 parts += [
                     inner_item.reaction,
                     inner_item.extended_message,
                     inner_item.unsend_message,
                     inner_item.powerup_message.wrapped.message
                     if inner_item.powerup_message
                     else None,
+                    inner_item.delta_rtc_multiway_message,
                 ]
         return [part for part in parts if part is not None]
 
 
 class MessageSyncError(ExtensibleEnum):
     QUEUE_OVERFLOW = "ERROR_QUEUE_OVERFLOW"
     QUEUE_UNDERFLOW = "ERROR_QUEUE_UNDERFLOW"
     QUEUE_NOT_FOUND = "ERROR_QUEUE_NOT_FOUND"
+    ERROR_QUEUE_TEMPORARY_NOT_AVAILABLE = "ERROR_QUEUE_TEMPORARY_NOT_AVAILABLE"
 
 
 @autospec
 @dataclass(kw_only=True)
 class MessageSyncPayload(ThriftObject):
     items: List[MessageSyncEvent] = field(factory=lambda: [])
     first_seq_id: int = field(TType.I64, default=None)
```

### Comparing `mautrix-facebook-0.4.1/maufbapi/types/mqtt/requests.py` & `mautrix-facebook-0.5.0/maufbapi/types/mqtt/requests.py`

 * *Files 1% similar despite different names*

```diff
@@ -66,14 +66,15 @@
     reply_to: str = field(index=28, default=None)  # reply_to_message_id
     # log_info: dict
     # is_self_forwarded: bool
     # message_powerup_data: struct(powerUpStyle: enum(NONE=0, LOVE, GIFT_WRAP, CELEBRATION, FIRE))
     # sound_bite_id: int = field(TType.I64)
     # forward_score: int = field(TType.I32)
     # is_forwarded: bool
+    # unknown_i32: int = field(TType.I32)
 
 
 @autospec
 @dataclass(kw_only=True)
 class MarkReadRequest(ThriftObject):
     receipt_type: str = "read"
     state: bool = True
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/__main__.py` & `mautrix-facebook-0.5.0/mautrix_facebook/__main__.py`

 * *Files 8% similar despite different names*

```diff
@@ -25,23 +25,26 @@
 
 from .config import Config
 from .db import init as init_db, upgrade_table
 from .matrix import MatrixHandler
 from .portal import Portal
 from .presence import PresenceUpdater
 from .puppet import Puppet
+from .segment_analytics import init as init_segment
 from .user import User
 from .util.interval import get_interval
 from .version import linkified_version, version
 from .web import PublicBridgeWebsite
 
 
 class MessengerBridge(Bridge):
     name = "mautrix-facebook"
     module = "mautrix_facebook"
+    beeper_service_name = "facebook"
+    beeper_network_name = "facebook"
     command = "python -m mautrix-facebook"
     description = "A Matrix-Facebook Messenger puppeting bridge."
     repo_url = "https://github.com/mautrix/facebook"
     version = version
     markdown_version = linkified_version
     config_class = Config
     matrix_class = MatrixHandler
@@ -59,18 +62,20 @@
         init_db(self.db)
 
     def prepare_bridge(self) -> None:
         super().prepare_bridge()
         if self.config["appservice.public.enabled"]:
             secret = self.config["appservice.public.shared_secret"]
             segment_key = self.config["appservice.public.segment_key"]
+            segment_user_id = self.config["appservice.public.segment_user_id"]
+            if segment_key:
+                init_segment(segment_key, segment_user_id)
             self.public_website = PublicBridgeWebsite(
                 loop=self.loop,
                 shared_secret=secret,
-                segment_key=segment_key,
             )
             self.az.app.add_subapp(
                 self.config["appservice.public.prefix"], self.public_website.app
             )
         else:
             self.public_website = None
         self.periodic_reconnect_task = None
@@ -84,14 +89,15 @@
         self.log.debug("Stopping puppet syncers")
         for puppet in Puppet.by_custom_mxid.values():
             puppet.stop()
         self.log.debug("Stopping facebook listeners")
         User.shutdown = True
         for user in User.by_fbid.values():
             user.stop_listen()
+            user.stop_backfill_tasks()
         self.add_shutdown_actions(user.save() for user in User.by_mxid.values())
 
     async def start(self) -> None:
         self.add_startup_actions(User.init_cls(self))
         self.add_startup_actions(Puppet.init_cls(self))
         Portal.init_cls(self)
         if self.config["bridge.resend_bridge_info"]:
@@ -152,15 +158,15 @@
                     log.debug("No reconnecting %s: connected too recently", user.mxid)
                     continue
                 log.debug("Executing periodic reconnect for %s", user.mxid)
                 try:
                     if mode == "refresh":
                         await user.refresh()
                     elif mode == "reconnect":
-                        await user.reconnect()
+                        await user.reconnect(update_proxy=True)
                 except asyncio.CancelledError:
                     log.debug("Periodic reconnect loop stopped")
                     return
                 except Exception:
                     log.exception("Error while reconnecting %s", user.mxid)
 
     async def get_portal(self, room_id: RoomID) -> Portal:
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/commands/auth.py` & `mautrix-facebook-0.5.0/mautrix_facebook/commands/auth.py`

 * *Files 2% similar despite different names*

```diff
@@ -98,14 +98,15 @@
     password = evt.content.body
 
     state = evt.sender.generate_state()
     api = AndroidAPI(
         state,
         log=evt.sender.log.getChild("login-api"),
         proxy_handler=evt.sender.proxy_handler,
+        on_proxy_update=evt.sender.on_proxy_update,
     )
     try:
         await api.mobile_config_sessionless()
         await api.login(email, password)
         await evt.sender.on_logged_in(state)
         evt.sender.command_status = None
         await evt.reply("Successfully logged in")
@@ -177,14 +178,20 @@
         evt.sender.command_status = None
     except Exception as e:
         evt.log.exception("Failed to log in")
         evt.sender.command_status = None
         await evt.reply(f"Failed to log in: {e}")
 
 
-@command_handler(needs_auth=True, help_section=SECTION_AUTH, help_text="Log out of Facebook")
+@command_handler(help_section=SECTION_AUTH, help_text="Log out of Facebook")
 async def logout(evt: CommandEvent) -> None:
-    puppet = await pu.Puppet.get_by_fbid(evt.sender.fbid)
+    seems_logged_in = bool(evt.sender.client)
+    puppet = await pu.Puppet.get_by_fbid(evt.sender.fbid) if evt.sender.fbid else None
     await evt.sender.logout()
-    if puppet.is_real_user:
+    if puppet and puppet.is_real_user:
         await puppet.switch_mxid(None, None)
-    await evt.reply("Successfully logged out")
+    if seems_logged_in:
+        await evt.reply("Successfully logged out")
+    else:
+        await evt.reply(
+            "You didn't seem to be logged in, but auth state was cleared again just to be safe"
+        )
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/commands/conn.py` & `mautrix-facebook-0.5.0/mautrix_facebook/commands/conn.py`

 * *Files 20% similar despite different names*

```diff
@@ -85,11 +85,27 @@
         await evt.reply("The Messenger MQTT listener is connected.")
 
 
 @command_handler(
     needs_auth=True,
     management_only=True,
     help_section=SECTION_CONNECTION,
-    help_text="Resync chats and reconnect to MQTT",
+    help_text=(
+        "Resync chats and reconnect to MQTT. If --full is provided, the bridge will also resync "
+        "older chats in the background (up to max_conversations in config)"
+    ),
+    help_args="[--full]",
 )
 async def refresh(evt: CommandEvent) -> None:
+    if "--full" in evt.args:
+        evt.sender.oldest_backfilled_thread_ts = None
+        evt.sender.total_backfilled_portals = None
+        evt.sender.thread_sync_completed = False
+        max_conversations = evt.config["bridge.backfill.max_conversations"]
+        background_sync = True
+    else:
+        max_conversations = 0
+        background_sync = False
     await evt.sender.refresh(force_notice=True)
+    if background_sync:
+        limit = f"Up to {max_conversations}" if max_conversations >= 0 else "All"
+        await evt.reply(f"{limit} old chats will be synced in the background")
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/commands/facebook.py` & `mautrix-facebook-0.5.0/mautrix_facebook/commands/facebook.py`

 * *Files 22% similar despite different names*

```diff
@@ -16,15 +16,15 @@
 from __future__ import annotations
 
 import asyncio
 
 from maufbapi.types import graphql
 from mautrix.bridge.commands import HelpSection, command_handler
 
-from .. import puppet as pu, user as u
+from .. import portal as po, puppet as pu, user as u
 from .typehint import CommandEvent
 
 SECTION_MISC = HelpSection("Miscellaneous", 40, "")
 
 
 async def _get_search_result_puppet(source: u.User, node: graphql.Participant) -> pu.Puppet:
     puppet = await pu.Puppet.get_by_fbid(node.id)
@@ -52,7 +52,22 @@
     results = "".join(
         f"* [{puppet.name}](https://matrix.to/#/{puppet.default_mxid})\n" for puppet in puppets
     )
     if results:
         await evt.reply(f"Search results:\n\n{results}")
     else:
         await evt.reply("No results :(")
+
+
+@command_handler(
+    needs_auth=True,
+    management_only=False,
+    help_section=SECTION_MISC,
+    help_text="Backfill the current chat",
+)
+async def backfill(evt: CommandEvent) -> None:
+    if not evt.config["bridge.backfill.msc2716"]:
+        await evt.reply("MSC2716 backfill is not enabled on this bridge")
+        return
+    portal: po.Portal = await po.Portal.get_by_mxid(evt.room_id)
+    await portal.enqueue_immediate_backfill(evt.sender, 0)
+    await evt.reply("Enqueued backfill for portal")
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/commands/handler.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v07_store_reaction_timestamp.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,26 +1,23 @@
 # mautrix-facebook - A Matrix-Facebook Messenger puppeting bridge.
-# Copyright (C) 2021 Tulir Asokan
+# Copyright (C) 2022 Tulir Asokan
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
-from typing import NamedTuple
+from mautrix.util.async_db import Connection
 
-from mautrix.bridge.commands import HelpSection
+from . import upgrade_table
 
-HelpCacheKey = NamedTuple("FBHelpCacheKey", is_management=bool, is_admin=bool, is_logged_in=bool)
 
-SECTION_AUTH = HelpSection("Authentication", 10, "")
-SECTION_CONNECTION = HelpSection("Connection management", 15, "")
-SECTION_CREATING_PORTALS = HelpSection("Creating portals", 20, "")
-SECTION_PORTAL_MANAGEMENT = HelpSection("Portal management", 30, "")
-SECTION_ADMIN = HelpSection("Administration", 50, "")
+@upgrade_table.register(description="Store timestamps for reactions")
+async def upgrade_v7(conn: Connection) -> None:
+    await conn.execute("ALTER TABLE reaction ADD COLUMN mx_timestamp BIGINT")
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/config.py` & `mautrix-facebook-0.5.0/mautrix_facebook/config.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,9 +1,9 @@
 # mautrix-facebook - A Matrix-Facebook Messenger puppeting bridge.
-# Copyright (C) 2022 Tulir Asokan
+# Copyright (C) 2023 Tulir Asokan
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
@@ -50,24 +50,24 @@
         copy("appservice.public.external")
         if self["appservice.public.shared_secret"] == "generate":
             base["appservice.public.shared_secret"] = self._new_token()
         else:
             copy("appservice.public.shared_secret")
         copy("appservice.public.allow_matrix_login")
         copy("appservice.public.segment_key")
+        copy("appservice.public.segment_user_id")
 
         copy("metrics.enabled")
         copy("metrics.listen_port")
 
         copy("bridge.username_template")
         copy("bridge.displayname_template")
         copy("bridge.displayname_preference")
         copy("bridge.command_prefix")
 
-        copy("bridge.initial_chat_sync")
         copy("bridge.invite_own_puppet_to_pm")
         copy("bridge.sync_with_custom_puppets")
         copy("bridge.sync_direct_chat_list")
         copy("bridge.double_puppet_server_map")
         copy("bridge.double_puppet_allow_discovery")
         if "bridge.login_shared_secret" in self:
             base["bridge.login_shared_secret_map"] = {
@@ -78,30 +78,45 @@
         copy("bridge.presence_from_facebook")
         copy("bridge.update_avatar_initial_sync")
         copy("bridge.delivery_receipts")
         copy("bridge.delivery_error_reports")
         copy("bridge.message_status_events")
         copy("bridge.federate_rooms")
         copy("bridge.allow_invites")
-        copy("bridge.backfill.invite_own_puppet")
-        copy("bridge.backfill.initial_limit")
-        copy("bridge.backfill.missed_limit")
-        copy("bridge.backfill.disable_notifications")
+        copy("bridge.backfill.enable")
+        copy("bridge.backfill.msc2716")
+        copy("bridge.backfill.double_puppet_backfill")
+        if "bridge.initial_chat_sync" in self:
+            initial_chat_sync = self["bridge.initial_chat_sync"]
+            base["bridge.backfill.max_conversations"] = self.get(
+                "bridge.backfill.max_conversations", initial_chat_sync
+            )
+        else:
+            copy("bridge.backfill.max_conversations")
+        copy("bridge.backfill.min_sync_thread_delay")
+        copy("bridge.backfill.unread_hours_threshold")
+        copy("bridge.backfill.backoff.thread_list")
+        copy("bridge.backfill.backoff.message_history")
+        copy("bridge.backfill.incremental.max_pages")
+        copy("bridge.backfill.incremental.max_total_pages")
+        copy("bridge.backfill.incremental.page_delay")
+        copy("bridge.backfill.incremental.post_batch_delay")
         if "bridge.periodic_reconnect_interval" in self:
             base["bridge.periodic_reconnect.interval"] = self["bridge.periodic_reconnect_interval"]
             base["bridge.periodic_reconnect.mode"] = self["bridge.periodic_reconnect_mode"]
         else:
             copy("bridge.periodic_reconnect.interval")
             copy("bridge.periodic_reconnect.mode")
             copy("bridge.periodic_reconnect.always")
             copy("bridge.periodic_reconnect.min_connected_time")
         copy("bridge.resync_max_disconnected_time")
-        copy("bridge.sync_on_startup")
+        copy("bridge.max_startup_thread_sync_count")
         copy("bridge.temporary_disconnect_notices")
         copy("bridge.disable_bridge_notices")
+        copy("bridge.bridge_matrix_notices")
         if "bridge.refresh_on_reconnection_fail" in self:
             base["bridge.on_reconnection_fail.action"] = (
                 "refresh" if self["bridge.refresh_on_reconnection_fail"] else None
             )
             base["bridge.on_reconnection_fail.wait_for"] = 0
         elif "bridge.on_reconnection_fail.refresh" in self:
             base["bridge.on_reconnection_fail.action"] = (
@@ -115,14 +130,18 @@
         copy("bridge.mute_bridging")
         copy("bridge.tag_only_on_create")
         copy("bridge.sandbox_media_download")
 
         copy_dict("bridge.permissions")
 
         copy("bridge.get_proxy_api_url")
+        copy("bridge.private_chat_portal_meta")
+        if base["bridge.private_chat_portal_meta"] not in ("default", "always", "never"):
+            base["bridge.private_chat_portal_meta"] = "default"
+        copy("bridge.disable_reply_fallbacks")
 
         for key in (
             "bridge.periodic_reconnect.interval",
             "bridge.on_reconnection_fail.wait_for",
         ):
             value = base.get(key, None)
             if isinstance(value, list) and len(value) != 2:
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/__init__.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/__init__.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,26 +1,28 @@
 from mautrix.util.async_db import Database
 
+from .backfill_queue import Backfill
 from .message import Message
 from .portal import Portal, ThreadType
 from .puppet import Puppet
 from .reaction import Reaction
 from .upgrade import upgrade_table
 from .user import User
 from .user_portal import UserPortal
 
 
 def init(db: Database) -> None:
-    for table in (Portal, Message, Reaction, User, Puppet, UserPortal):
+    for table in (Portal, Message, Reaction, User, Puppet, UserPortal, Backfill):
         table.db = db
 
 
 __all__ = [
     "upgrade_table",
     "init",
+    "Backfill",
     "Message",
     "Reaction",
     "Portal",
     "ThreadType",
     "Puppet",
     "User",
     "UserPortal",
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/message.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/message.py`

 * *Files 10% similar despite different names*

```diff
@@ -15,14 +15,15 @@
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
 from typing import TYPE_CHECKING, ClassVar
 
 from asyncpg import Record
 from attr import dataclass
+import attr
 
 from mautrix.types import EventID, RoomID
 from mautrix.util.async_db import Database, Scheme
 
 fake_db = Database.create("") if TYPE_CHECKING else None
 
 
@@ -79,14 +80,28 @@
     @classmethod
     async def get_by_mxid(cls, mxid: EventID, mx_room: RoomID) -> Message | None:
         q = f"SELECT {cls.columns} FROM message WHERE mxid=$1 AND mx_room=$2"
         row = await cls.db.fetchrow(q, mxid, mx_room)
         return cls._from_row(row)
 
     @classmethod
+    async def get_first_in_chat(cls, fb_chat: int, fb_receiver: int) -> Message | None:
+        q = f"""
+        SELECT {cls.columns}
+        FROM message
+        WHERE fb_chat=$1
+            AND fb_receiver=$2
+            AND fbid IS NOT NULL
+        ORDER BY timestamp ASC
+        LIMIT 1
+        """
+        row = await cls.db.fetchrow(q, fb_chat, fb_receiver)
+        return cls._from_row(row)
+
+    @classmethod
     async def get_most_recent(cls, fb_chat: int, fb_receiver: int) -> Message | None:
         q = (
             f"SELECT {cls.columns} "
             "FROM message WHERE fb_chat=$1 AND fb_receiver=$2 AND fbid IS NOT NULL "
             "ORDER BY timestamp DESC LIMIT 1"
         )
         row = await cls.db.fetchrow(q, fb_chat, fb_receiver)
@@ -107,38 +122,43 @@
     _insert_query = (
         'INSERT INTO message (mxid, mx_room, fbid, fb_txn_id, "index", fb_chat, fb_receiver, '
         "                     fb_sender, timestamp) "
         "VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)"
     )
 
     @classmethod
-    async def bulk_create(
+    async def bulk_create_parts(
         cls,
         fbid: str,
         oti: int,
         fb_chat: int,
         fb_receiver: int,
         fb_sender: int,
         event_ids: list[EventID],
         timestamp: int,
         mx_room: RoomID,
     ) -> list[Message]:
         if not event_ids:
             return []
-        columns = [col.strip('"') for col in cls.columns.split(", ")]
-        records = [
-            (mxid, mx_room, fbid, oti, index, fb_chat, fb_receiver, fb_sender, timestamp)
+        messages = [
+            Message(mxid, mx_room, fbid, oti, index, fb_chat, fb_receiver, fb_sender, timestamp)
             for index, mxid in enumerate(event_ids)
         ]
+        await cls.bulk_insert(messages)
+        return messages
+
+    @classmethod
+    async def bulk_insert(cls, messages: list[Message]) -> None:
+        columns = [col.strip('"') for col in cls.columns.split(", ")]
+        records = [attr.astuple(message) for message in messages]
         async with cls.db.acquire() as conn, conn.transaction():
             if cls.db.scheme == Scheme.POSTGRES:
                 await conn.copy_records_to_table("message", records=records, columns=columns)
             else:
                 await conn.executemany(cls._insert_query, records)
-        return [Message(*record) for record in records]
 
     async def insert(self) -> None:
         q = self._insert_query
         await self.db.execute(
             q,
             self.mxid,
             self.mx_room,
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/portal.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/portal.py`

 * *Files 11% similar despite different names*

```diff
@@ -19,15 +19,15 @@
 from enum import Enum
 
 from asyncpg import Record
 from attr import dataclass
 
 from maufbapi.types.graphql import ThreadKey as GraphQLThreadKey
 from maufbapi.types.mqtt import ThreadKey as MQTTThreadKey
-from mautrix.types import ContentURI, RoomID, UserID
+from mautrix.types import BatchID, ContentURI, EventID, RoomID, UserID
 from mautrix.util.async_db import Database
 
 fake_db = Database.create("") if TYPE_CHECKING else None
 
 
 class ThreadType(Enum):
     USER = "USER"
@@ -56,60 +56,66 @@
     name: str | None
     photo_id: str | None
     avatar_url: ContentURI | None
     encrypted: bool
     name_set: bool
     avatar_set: bool
     relay_user_id: UserID | None
+    first_event_id: EventID | None
+    next_batch_id: BatchID | None
+    historical_base_insertion_event_id: EventID | None
 
     @classmethod
     def _from_row(cls, row: Record | None) -> Portal | None:
         if row is None:
             return None
         data = {**row}
         fb_type = ThreadType(data.pop("fb_type"))
         return cls(**data, fb_type=fb_type)
 
+    column_names = ",".join(
+        (
+            "fbid",
+            "fb_receiver",
+            "fb_type",
+            "mxid",
+            "name",
+            "photo_id",
+            "avatar_url",
+            "encrypted",
+            "name_set",
+            "avatar_set",
+            "relay_user_id",
+            "first_event_id",
+            "next_batch_id",
+            "historical_base_insertion_event_id",
+        )
+    )
+
     @classmethod
     async def get_by_fbid(cls, fbid: int, fb_receiver: int) -> Portal | None:
-        q = """
-            SELECT fbid, fb_receiver, fb_type, mxid, name, photo_id, avatar_url, encrypted,
-                   name_set, avatar_set, relay_user_id
-            FROM portal WHERE fbid=$1 AND fb_receiver=$2
-        """
+        q = f"SELECT {cls.column_names} FROM portal WHERE fbid=$1 AND fb_receiver=$2"
         row = await cls.db.fetchrow(q, fbid, fb_receiver)
         return cls._from_row(row)
 
     @classmethod
     async def get_by_mxid(cls, mxid: RoomID) -> Portal | None:
-        q = """
-            SELECT fbid, fb_receiver, fb_type, mxid, name, photo_id, avatar_url, encrypted,
-                   name_set, avatar_set, relay_user_id
-            FROM portal WHERE mxid=$1
-        """
+        q = f"SELECT {cls.column_names} FROM portal WHERE mxid=$1"
         row = await cls.db.fetchrow(q, mxid)
         return cls._from_row(row)
 
     @classmethod
     async def get_all_by_receiver(cls, fb_receiver: int) -> list[Portal]:
-        q = """
-            SELECT fbid, fb_receiver, fb_type, mxid, name, photo_id, avatar_url, encrypted,
-                   name_set, avatar_set, relay_user_id
-            FROM portal WHERE fb_receiver=$1 AND fb_type='USER'
-        """
+        q = f"SELECT {cls.column_names} FROM portal WHERE fb_receiver=$1 AND fb_type='USER'"
         rows = await cls.db.fetch(q, fb_receiver)
         return [cls._from_row(row) for row in rows]
 
     @classmethod
     async def all(cls) -> list[Portal]:
-        q = """
-            SELECT fbid, fb_receiver, fb_type, mxid, name, photo_id, avatar_url, encrypted,
-                   name_set, avatar_set, relay_user_id
-            FROM portal
-        """
+        q = f"SELECT {cls.column_names} FROM portal"
         rows = await cls.db.fetch(q)
         return [cls._from_row(row) for row in rows]
 
     @property
     def _values(self):
         return (
             self.fbid,
@@ -119,28 +125,32 @@
             self.name,
             self.photo_id,
             self.avatar_url,
             self.encrypted,
             self.name_set,
             self.avatar_set,
             self.relay_user_id,
+            self.first_event_id,
+            self.next_batch_id,
+            self.historical_base_insertion_event_id,
         )
 
     async def insert(self) -> None:
-        q = """
-        INSERT INTO portal (fbid, fb_receiver, fb_type, mxid, name, photo_id, avatar_url,
-                            encrypted, name_set, avatar_set, relay_user_id)
-        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
+        q = f"""
+        INSERT INTO portal ({self.column_names})
+        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
         """
         await self.db.execute(q, *self._values)
 
     async def delete(self) -> None:
         q = "DELETE FROM portal WHERE fbid=$1 AND fb_receiver=$2"
         await self.db.execute(q, self.fbid, self.fb_receiver)
 
     async def save(self) -> None:
         q = """
             UPDATE portal SET fb_type=$3, mxid=$4, name=$5, photo_id=$6, avatar_url=$7,
-                              encrypted=$8, name_set=$9, avatar_set=$10, relay_user_id=$11
+                              encrypted=$8, name_set=$9, avatar_set=$10, relay_user_id=$11,
+                              first_event_id=$12, next_batch_id=$13,
+                              historical_base_insertion_event_id=$14
             WHERE fbid=$1 AND fb_receiver=$2
         """
         await self.db.execute(q, *self._values)
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/puppet.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/puppet.py`

 * *Files 12% similar despite different names*

```diff
@@ -33,98 +33,91 @@
 
     fbid: int
     name: str | None
     photo_id: str | None
     photo_mxc: ContentURI | None
     name_set: bool
     avatar_set: bool
+    contact_info_set: bool
     is_registered: bool
 
     custom_mxid: UserID | None
     access_token: str | None
     next_batch: SyncToken | None
     base_url: URL | None
 
+    columns: ClassVar[str] = (
+        "fbid, name, photo_id, photo_mxc, name_set, avatar_set, contact_info_set, is_registered, "
+        "custom_mxid, access_token, next_batch, base_url "
+    )
+
     @classmethod
     def _from_row(cls, row: Record | None) -> Puppet | None:
         if row is None:
             return None
         data = {**row}
         base_url = data.pop("base_url", None)
         return cls(**data, base_url=URL(base_url) if base_url else None)
 
     @classmethod
     async def get_by_fbid(cls, fbid: int) -> Puppet | None:
-        q = (
-            "SELECT fbid, name, photo_id, photo_mxc, name_set, avatar_set, is_registered, "
-            "       custom_mxid, access_token, next_batch, base_url "
-            "FROM puppet WHERE fbid=$1"
-        )
-        row = await cls.db.fetchrow(q, fbid)
-        return cls._from_row(row)
+        q = f"SELECT {cls.columns} FROM puppet WHERE fbid=$1"
+        return cls._from_row(await cls.db.fetchrow(q, fbid))
 
     @classmethod
     async def get_by_name(cls, name: str) -> Puppet | None:
-        q = (
-            "SELECT fbid, name, photo_id, photo_mxc, name_set, avatar_set, is_registered, "
-            "       custom_mxid, access_token, next_batch, base_url "
-            "FROM puppet WHERE name=$1"
-        )
-        row = await cls.db.fetchrow(q, name)
-        return cls._from_row(row)
+        q = f"SELECT {cls.columns} FROM puppet WHERE name=$1"
+        return cls._from_row(await cls.db.fetchrow(q, name))
 
     @classmethod
     async def get_by_custom_mxid(cls, mxid: UserID) -> Puppet | None:
-        q = (
-            "SELECT fbid, name, photo_id, photo_mxc, name_set, avatar_set, is_registered, "
-            "       custom_mxid, access_token, next_batch, base_url "
-            "FROM puppet WHERE custom_mxid=$1"
-        )
-        row = await cls.db.fetchrow(q, mxid)
-        return cls._from_row(row)
+        q = f"SELECT {cls.columns} FROM puppet WHERE custom_mxid=$1"
+        return cls._from_row(await cls.db.fetchrow(q, mxid))
+
+    @classmethod
+    async def get_all(cls) -> list[Puppet]:
+        q = f"SELECT {cls.columns} FROM puppet"
+        return [cls._from_row(row) for row in await cls.db.fetch(q)]
 
     @classmethod
     async def get_all_with_custom_mxid(cls) -> list[Puppet]:
-        q = (
-            "SELECT fbid, name, photo_id, photo_mxc, name_set, avatar_set, is_registered, "
-            "       custom_mxid, access_token, next_batch, base_url "
-            "FROM puppet WHERE custom_mxid<>''"
-        )
-        rows = await cls.db.fetch(q)
-        return [cls._from_row(row) for row in rows]
+        q = f"SELECT {cls.columns} FROM puppet WHERE custom_mxid<>''"
+        return [cls._from_row(row) for row in await cls.db.fetch(q)]
 
     @property
     def _values(self):
         return (
             self.fbid,
             self.name,
             self.photo_id,
             self.photo_mxc,
             self.name_set,
             self.avatar_set,
+            self.contact_info_set,
             self.is_registered,
             self.custom_mxid,
             self.access_token,
             self.next_batch,
             str(self.base_url) if self.base_url else None,
         )
 
     async def insert(self) -> None:
         q = """
             INSERT INTO puppet (fbid, name, photo_id, photo_mxc, name_set, avatar_set,
-                                is_registered, custom_mxid, access_token, next_batch, base_url)
-            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
+                                contact_info_set, is_registered, custom_mxid, access_token,
+                                next_batch, base_url)
+            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
         """
         await self.db.execute(q, *self._values)
 
     async def delete(self) -> None:
         q = "DELETE FROM puppet WHERE fbid=$1"
         await self.db.execute(q, self.fbid)
 
     async def save(self) -> None:
         q = """
             UPDATE puppet SET name=$2, photo_id=$3, photo_mxc=$4, name_set=$5, avatar_set=$6,
-                              is_registered=$7, custom_mxid=$8, access_token=$9, next_batch=$10,
-                              base_url=$11
+                              contact_info_set=$7, is_registered=$8, custom_mxid=$9,
+                              access_token=$10, next_batch=$11, base_url=$12
             WHERE fbid=$1
         """
         await self.db.execute(q, *self._values)
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/reaction.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/reaction.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v01_initial_revision.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v01_initial_revision.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v02_message_oti.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v02_message_oti.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v03_portal_meta_set.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v03_portal_meta_set.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v04_relay_mode.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v04_relay_mode.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v05_remove_communities.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v05_remove_communities.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v06_store_user_seq_id.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v06_store_user_seq_id.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/upgrade/v07_store_reaction_timestamp.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/upgrade/v11_user_thread_sync_done_flag.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,9 +1,9 @@
 # mautrix-facebook - A Matrix-Facebook Messenger puppeting bridge.
-# Copyright (C) 2022 Tulir Asokan
+# Copyright (C) 2022 Tulir Asokan, Sumner Evans
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU Affero General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
@@ -14,10 +14,12 @@
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from mautrix.util.async_db import Connection
 
 from . import upgrade_table
 
 
-@upgrade_table.register(description="Store timestamps for reactions")
-async def upgrade_v7(conn: Connection) -> None:
-    await conn.execute("ALTER TABLE reaction ADD COLUMN mx_timestamp BIGINT")
+@upgrade_table.register(description="Add flag for users to mark thread sync as completed")
+async def upgrade_v11(conn: Connection) -> None:
+    await conn.execute(
+        'ALTER TABLE "user" ADD COLUMN thread_sync_completed BOOLEAN NOT NULL DEFAULT false'
+    )
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/user.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/user.py`

 * *Files 20% similar despite different names*

```diff
@@ -33,28 +33,43 @@
 
     mxid: UserID
     fbid: int | None
     state: AndroidState | None
     notice_room: RoomID | None
     seq_id: int | None
     connect_token_hash: bytes | None
+    oldest_backfilled_thread_ts: int | None
+    total_backfilled_portals: int | None
+    thread_sync_completed: bool
 
     @property
     def _state_json(self) -> str | None:
         return self.state.json() if self.state else None
 
     @classmethod
     def _from_row(cls, row: Record | None) -> User | None:
         if row is None:
             return None
         data = {**row}
         state = data.pop("state", None)
         return cls(**data, state=AndroidState.parse_json(state) if state else None)
 
-    _columns = "mxid, fbid, state, notice_room, seq_id, connect_token_hash"
+    _columns = ",".join(
+        (
+            "mxid",
+            "fbid",
+            "state",
+            "notice_room",
+            "seq_id",
+            "connect_token_hash",
+            "oldest_backfilled_thread_ts",
+            "total_backfilled_portals",
+            "thread_sync_completed",
+        )
+    )
 
     @classmethod
     async def all_logged_in(cls) -> list[User]:
         q = f'SELECT {cls._columns} FROM "user" WHERE fbid<>0'
         rows = await cls.db.fetch(q)
         return [cls._from_row(row) for row in rows]
 
@@ -75,28 +90,33 @@
         return (
             self.mxid,
             self.fbid,
             self._state_json,
             self.notice_room,
             self.seq_id,
             self.connect_token_hash,
+            self.oldest_backfilled_thread_ts,
+            self.total_backfilled_portals,
+            self.thread_sync_completed,
         )
 
     async def insert(self) -> None:
-        q = """
-            INSERT INTO "user" (mxid, fbid, state, notice_room, seq_id, connect_token_hash)
-            VALUES ($1, $2, $3, $4, $5, $6)
+        q = f"""
+            INSERT INTO "user" ({self._columns})
+            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
         """
         await self.db.execute(q, *self._values)
 
     async def delete(self) -> None:
         await self.db.execute('DELETE FROM "user" WHERE mxid=$1', self.mxid)
 
     async def save(self) -> None:
         q = """
-            UPDATE "user" SET fbid=$2, state=$3, notice_room=$4, seq_id=$5, connect_token_hash=$6
-            WHERE mxid=$1
+        UPDATE "user"
+        SET fbid=$2, state=$3, notice_room=$4, seq_id=$5, connect_token_hash=$6,
+            oldest_backfilled_thread_ts=$7, total_backfilled_portals=$8, thread_sync_completed=$9
+        WHERE mxid=$1
         """
         await self.db.execute(q, *self._values)
 
     async def save_seq_id(self) -> None:
         await self.db.execute('UPDATE "user" SET seq_id=$2 WHERE mxid=$1', self.mxid, self.seq_id)
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/db/user_portal.py` & `mautrix-facebook-0.5.0/mautrix_facebook/db/user_portal.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/example-config.yaml` & `mautrix-facebook-0.5.0/mautrix_facebook/example-config.yaml`

 * *Files 20% similar despite different names*

```diff
@@ -63,14 +63,16 @@
         # If null, integration manager access to the API will not be possible.
         shared_secret: generate
         # Allow logging in within Matrix. If false, users can only log in using the web interface.
         allow_matrix_login: true
         # Segment API key to enable analytics tracking for web server endpoints. Set to null to disable.
         # Currently the only events are login start, success and fail.
         segment_key: null
+        # Optional user_id to use when sending Segment events. If null, defaults to using mxID.
+        segment_user_id: null
 
     # The unique ID of this appservice.
     id: facebook
     # Username of the appservice bot.
     bot_username: facebookbot
     # Display name and avatar for bot. Set to "remove" to remove display name/avatar, leave empty
     # to leave display name/avatar as-is.
@@ -121,17 +123,14 @@
     displayname_preference:
     - name
     - first_name
 
     # The prefix for commands. Only required in non-management rooms.
     command_prefix: "!fb"
 
-    # Number of chats to sync (and create portals for) on startup/login.
-    # Set 0 to disable automatic syncing.
-    initial_chat_sync: 20
     # Whether or not the Facebook users of logged in Matrix users should be
     # invited to private chats when the user sends a message from another client.
     invite_own_puppet_to_pm: false
     # Whether or not to use /sync to get presence, read receipts and typing notifications
     # when double puppeting is enabled
     sync_with_custom_puppets: false
     # Whether or not to update the m.direct account data event when double puppeting is enabled.
@@ -168,28 +167,77 @@
     # Whether to allow inviting arbitrary mxids to portal rooms
     allow_invites: false
     # Whether or not created rooms should have federation enabled.
     # If false, created portal rooms will never be federated.
     federate_rooms: true
     # Settings for backfilling messages from Facebook.
     backfill:
-        # Whether or not the Facebook users of logged in Matrix users should be
-        # invited to private chats when backfilling history from Facebook. This is
-        # usually needed to prevent rate limits and to allow timestamp massaging.
-        invite_own_puppet: true
-        # Maximum number of messages to backfill initially.
-        # Set to 0 to disable backfilling when creating portal.
-        initial_limit: 0
-        # Maximum number of messages to backfill if messages were missed while
-        # the bridge was disconnected.
-        # Set to 0 to disable backfilling missed messages.
-        missed_limit: 1000
-        # If using double puppeting, should notifications be disabled
-        # while the initial backfill is in progress?
-        disable_notifications: false
+        # Allow backfilling at all?
+        enable: true
+        # Use MSC2716 for backfilling? If this is disabled, backfilling only happens when syncing threads,
+        # and the incremental settings below don't apply.
+        #
+        # This requires a server with MSC2716 support, which is currently an experimental feature in Synapse.
+        # It can be enabled by setting experimental_features -> msc2716_enabled to true in homeserver.yaml.
+        msc2716: false
+        # Use double puppets for backfilling?
+        #
+        # If using MSC2716, the double puppets must be in the appservice's user ID namespace
+        # (because the bridge can't use the double puppet access token with batch sending).
+        #
+        # Even without MSC2716, bridging old messages with correct timestamps requires the double
+        # puppets to be in an appservice namespace, or the server to be modified to allow
+        # overriding timestamps anyway.
+        double_puppet_backfill: false
+        # The maximum number of conversations that should be synced.
+        # Other conversations will be backfilled on demand when the start PM
+        # provisioning endpoint is used or when a message comes in from that
+        # chat.
+        # If set to -1, all conversations will by synced.
+        max_conversations: 20
+        # The minimum amount of time to wait between syncing each thread. This
+        # helps avoid situations where you sync too quickly.
+        min_sync_thread_delay: 5
+        # If this value is greater than 0, then if the conversation's last
+        # message was more than this number of hours ago, then the conversation
+        # will automatically be marked it as read.
+        # Conversations that have a last message that is less than this number
+        # of hours ago will have their unread status synced from Facebook.
+        unread_hours_threshold: 0
+
+        # Settings for how quickly to backoff when rate-limits are encountered
+        # while backfilling.
+        backoff:
+            # How many seconds to wait after getting rate limited during a
+            # thread list fetch.
+            thread_list: 300
+            # How many seconds to wait after getting rate limited during a
+            # message history fetch.
+            message_history: 300
+
+        # Settings for backfills.
+        #
+        # During initial/incremental sync, the entirety of the thread that is
+        # available will be backfilled. For example, on initial sync, about 20
+        # messages are included for each thread in the thread list returned by
+        # the server. After that, incremental backfills will be run for each of
+        # the portals in a round-robin fashion until all portals have been
+        # backfilled as configured below.
+        incremental:
+            # The maximum number of pages to backfill per batch.
+            max_pages: 10
+            # The maximum number of total pages to backfill per portal.
+            # If set to -1, infinite pages will be synced.
+            max_total_pages: -1
+            # The number of seconds to wait between backfilling each page.
+            page_delay: 5
+            # The number of seconds to wait after backfilling the batch of
+            # messages.
+            post_batch_delay: 20
+
     periodic_reconnect:
         # Interval in seconds in which to automatically reconnect all users.
         # This can be used to automatically mitigate the bug where Facebook stops sending messages.
         # Set to -1 to disable periodic reconnections entirely.
         # Set to a list of two items to randomize the interval (min, max).
         interval: -1
         # What to do in periodic reconnects. Either "refresh" or "reconnect"
@@ -198,22 +246,25 @@
         always: false
         # Only reconnect if the user has been connected for longer than this value
         min_connected_time: 0
     # The number of seconds that a disconnection can last without triggering an automatic re-sync
     # and missed message backfilling when reconnecting.
     # Set to 0 to always re-sync, or -1 to never re-sync automatically.
     resync_max_disconnected_time: 5
-    # Should the bridge do a resync on startup?
-    sync_on_startup: true
+    # The maximum number of conversations that should be synced when we get a
+    # message sync error. In general, 1 page (20) is sufficient.
+    max_startup_thread_sync_count: 20
     # Whether or not temporary disconnections should send notices to the notice room.
     # If this is false, disconnections will never send messages and connections will only send
     # messages if it was disconnected for more than resync_max_disconnected_time seconds.
     temporary_disconnect_notices: false
     # Disable bridge notices entirely
     disable_bridge_notices: false
+    # Should Matrix m.notice-type messages be bridged to Facebook?
+    bridge_matrix_notices: true
     on_reconnection_fail:
         # What to do if a reconnection attempt fails? Options: reconnect, refresh, null
         action: reconnect
         # Seconds to wait before attempting to refresh the connection, set a list of two items to
         # to randomize the interval (min, max).
         wait_for: 0
     # Set this to true to tell the bridge to re-send m.bridge events to all rooms on the next run.
@@ -225,14 +276,22 @@
     # Whether or not mute status and tags should only be bridged when the portal room is created.
     tag_only_on_create: true
     # If set to true, downloading media from the CDN will use a plain aiohttp client without the usual headers or
     # other configuration. This may be useful if you don't want to use the default proxy for large files.
     sandbox_media_download: false
     # URL to call to retrieve a proxy URL from (defaults to the http_proxy environment variable).
     get_proxy_api_url: null
+    # Whether to explicitly set the avatar and room name for private chat portal rooms.
+    # If set to `default`, this will be enabled in encrypted rooms and disabled in unencrypted rooms.
+    # If set to `always`, all DM rooms will have explicit names and avatars set.
+    # If set to `never`, DM rooms will never have names and avatars set.
+    private_chat_portal_meta: default
+    # Disable generating reply fallbacks? Some extremely bad clients still rely on them,
+    # but they're being phased out and will be completely removed in the future.
+    disable_reply_fallbacks: false
 
     # End-to-bridge encryption support options.
     #
     # See https://docs.mau.fi/bridges/general/end-to-bridge-encryption.html for more info.
     encryption:
         # Allow encryption, work in group chat rooms with e2ee enabled
         allow: false
@@ -242,14 +301,31 @@
         # Whether to use MSC2409/MSC3202 instead of /sync long polling for receiving encryption-related data.
         appservice: false
         # Require encryption, drop any unencrypted messages.
         require: false
         # Enable key sharing? If enabled, key requests for rooms where users are in will be fulfilled.
         # You must use a client that supports requesting keys from other users to use this feature.
         allow_key_sharing: false
+        # Options for deleting megolm sessions from the bridge.
+        delete_keys:
+            # Beeper-specific: delete outbound sessions when hungryserv confirms
+            # that the user has uploaded the key to key backup.
+            delete_outbound_on_ack: false
+            # Don't store outbound sessions in the inbound table.
+            dont_store_outbound: false
+            # Ratchet megolm sessions forward after decrypting messages.
+            ratchet_on_decrypt: false
+            # Delete fully used keys (index >= max_messages) after decrypting messages.
+            delete_fully_used_on_decrypt: false
+            # Delete previous megolm sessions from same device when receiving a new one.
+            delete_prev_on_new_session: false
+            # Delete megolm sessions received from a device when the device is deleted.
+            delete_on_device_delete: false
+            # Periodically delete megolm sessions when 2x max_age has passed since receiving the session.
+            periodically_delete_expired: false
         # What level of device verification should be required from users?
         #
         # Valid levels:
         #   unverified - Send keys to all device in the room.
         #   cross-signed-untrusted - Require valid cross-signing, but trust all cross-signing keys.
         #   cross-signed-tofu - Require valid cross-signing, trust cross-signing keys on first use (and reject changes).
         #   cross-signed-verified - Require valid cross-signing, plus a valid user signature from the bridge bot.
@@ -304,16 +380,16 @@
         # Available variables:
         #   $sender_displayname - The display name of the sender (e.g. Example User)
         #   $sender_username    - The username (Matrix ID localpart) of the sender (e.g. exampleuser)
         #   $sender_mxid        - The Matrix ID of the sender (e.g. @exampleuser:example.com)
         #   $message            - The message content
         message_formats:
             m.text: '<b>$sender_displayname</b>: $message'
-            m.notice: '<b>$sender_displayname<b>: $message'
-            m.emote: '* <b>$sender_displayname<b> $message'
+            m.notice: '<b>$sender_displayname</b>: $message'
+            m.emote: '* <b>$sender_displayname</b> $message'
             m.file: '<b>$sender_displayname</b> sent a file'
             m.image: '<b>$sender_displayname</b> sent an image'
             m.audio: '<b>$sender_displayname</b> sent an audio file'
             m.video: '<b>$sender_displayname</b> sent a video'
             m.location: '<b>$sender_displayname</b> sent a location'
 
 facebook:
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/formatter/from_facebook.py` & `mautrix-facebook-0.5.0/mautrix_facebook/formatter/from_facebook.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/formatter/from_matrix.py` & `mautrix-facebook-0.5.0/mautrix_facebook/formatter/from_matrix.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/get_version.py` & `mautrix-facebook-0.5.0/mautrix_facebook/get_version.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/matrix.py` & `mautrix-facebook-0.5.0/mautrix_facebook/matrix.py`

 * *Files 4% similar despite different names*

```diff
@@ -12,52 +12,64 @@
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
 from typing import TYPE_CHECKING
+import sys
 import time
 
 from mautrix.bridge import BaseMatrixHandler
-from mautrix.errors import MatrixError
 from mautrix.types import (
     Event,
     EventID,
     EventType,
-    MessageType,
     PresenceEvent,
-    PresenceEventContent,
     ReactionEvent,
     ReactionEventContent,
     ReceiptEvent,
     RedactionEvent,
     RelationType,
     RoomID,
     SingleReceiptEventContent,
-    TextMessageEventContent,
     TypingEvent,
     UserID,
 )
 
-from . import portal as po, puppet as pu, user as u
+from . import portal as po, user as u
 from .db import Message as DBMessage, ThreadType
 
 if TYPE_CHECKING:
     from .__main__ import MessengerBridge
 
 
 class MatrixHandler(BaseMatrixHandler):
     def __init__(self, bridge: "MessengerBridge") -> None:
         prefix, suffix = bridge.config["bridge.username_template"].format(userid=":").split(":")
         homeserver = bridge.config["homeserver.domain"]
         self.user_id_prefix = f"@{prefix}"
         self.user_id_suffix = f"{suffix}:{homeserver}"
         super().__init__(bridge=bridge)
 
+    async def check_versions(self) -> None:
+        await super().check_versions()
+        if self.config["bridge.backfill.msc2716"] and not (
+            support := self.versions.supports("org.matrix.msc2716")
+        ):
+            self.log.fatal(
+                "MSC2716 backfilling is enabled in bridge config, but "
+                + (
+                    "batch sending is not enabled on homeserver"
+                    if support is False
+                    else "homeserver does not support batch sending"
+                )
+            )
+            sys.exit(18)
+
     async def send_welcome_message(self, room_id: RoomID, inviter: u.User) -> None:
         await super().send_welcome_message(room_id, inviter)
         if not inviter.notice_room:
             inviter.notice_room = room_id
             await inviter.save()
             await self.az.intent.send_notice(
                 room_id, "This room has been marked as your Facebook Messenger bridge notice room."
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/portal.py` & `mautrix-facebook-0.5.0/mautrix_facebook/portal.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 00000000: 2320 6d61 7574 7269 782d 6661 6365 626f  # mautrix-facebo
 00000010: 6f6b 202d 2041 204d 6174 7269 782d 4661  ok - A Matrix-Fa
 00000020: 6365 626f 6f6b 204d 6573 7365 6e67 6572  cebook Messenger
 00000030: 2070 7570 7065 7469 6e67 2062 7269 6467   puppeting bridg
 00000040: 652e 0a23 2043 6f70 7972 6967 6874 2028  e..# Copyright (
-00000050: 4329 2032 3032 3220 5475 6c69 7220 4173  C) 2022 Tulir As
+00000050: 4329 2032 3032 3320 5475 6c69 7220 4173  C) 2023 Tulir As
 00000060: 6f6b 616e 0a23 0a23 2054 6869 7320 7072  okan.#.# This pr
 00000070: 6f67 7261 6d20 6973 2066 7265 6520 736f  ogram is free so
 00000080: 6674 7761 7265 3a20 796f 7520 6361 6e20  ftware: you can 
 00000090: 7265 6469 7374 7269 6275 7465 2069 7420  redistribute it 
 000000a0: 616e 642f 6f72 206d 6f64 6966 790a 2320  and/or modify.# 
 000000b0: 6974 2075 6e64 6572 2074 6865 2074 6572  it under the ter
 000000c0: 6d73 206f 6620 7468 6520 474e 5520 4166  ms of the GNU Af
@@ -47,5583 +47,6691 @@
 000002e0: 7777 2e67 6e75 2e6f 7267 2f6c 6963 656e  ww.gnu.org/licen
 000002f0: 7365 732f 3e2e 0a66 726f 6d20 5f5f 6675  ses/>..from __fu
 00000300: 7475 7265 5f5f 2069 6d70 6f72 7420 616e  ture__ import an
 00000310: 6e6f 7461 7469 6f6e 730a 0a66 726f 6d20  notations..from 
 00000320: 7479 7069 6e67 2069 6d70 6f72 7420 5459  typing import TY
 00000330: 5045 5f43 4845 434b 494e 472c 2041 6e79  PE_CHECKING, Any
 00000340: 2c20 4173 796e 6347 656e 6572 6174 6f72  , AsyncGenerator
-00000350: 2c20 4177 6169 7461 626c 652c 2050 6174  , Awaitable, Pat
-00000360: 7465 726e 2c20 6361 7374 0a66 726f 6d20  tern, cast.from 
-00000370: 636f 6c6c 6563 7469 6f6e 7320 696d 706f  collections impo
-00000380: 7274 2064 6571 7565 0a66 726f 6d20 6874  rt deque.from ht
-00000390: 6d6c 2069 6d70 6f72 7420 6573 6361 7065  ml import escape
-000003a0: 0a66 726f 6d20 696f 2069 6d70 6f72 7420  .from io import 
-000003b0: 4279 7465 7349 4f0a 696d 706f 7274 2061  BytesIO.import a
-000003c0: 7379 6e63 696f 0a69 6d70 6f72 7420 6261  syncio.import ba
-000003d0: 7365 3634 0a69 6d70 6f72 7420 6a73 6f6e  se64.import json
-000003e0: 0a69 6d70 6f72 7420 6d69 6d65 7479 7065  .import mimetype
-000003f0: 730a 696d 706f 7274 2072 650a 696d 706f  s.import re.impo
-00000400: 7274 2074 696d 650a 0a66 726f 6d20 7961  rt time..from ya
-00000410: 726c 2069 6d70 6f72 7420 5552 4c0a 0a66  rl import URL..f
-00000420: 726f 6d20 6d61 7566 6261 7069 2e74 7970  rom maufbapi.typ
-00000430: 6573 2069 6d70 6f72 7420 6772 6170 6871  es import graphq
-00000440: 6c2c 206d 7174 740a 6672 6f6d 206d 6175  l, mqtt.from mau
-00000450: 7472 6978 2e61 7070 7365 7276 6963 6520  trix.appservice 
-00000460: 696d 706f 7274 2044 4f55 424c 455f 5055  import DOUBLE_PU
-00000470: 5050 4554 5f53 4f55 5243 455f 4b45 592c  PPET_SOURCE_KEY,
-00000480: 2049 6e74 656e 7441 5049 0a66 726f 6d20   IntentAPI.from 
-00000490: 6d61 7574 7269 782e 6272 6964 6765 2069  mautrix.bridge i
-000004a0: 6d70 6f72 7420 4261 7365 506f 7274 616c  mport BasePortal
-000004b0: 2c20 4e6f 7469 6669 6361 7469 6f6e 4469  , NotificationDi
-000004c0: 7361 626c 6572 2c20 6173 796e 635f 6765  sabler, async_ge
-000004d0: 7474 6572 5f6c 6f63 6b0a 6672 6f6d 206d  tter_lock.from m
-000004e0: 6175 7472 6978 2e65 7272 6f72 7320 696d  autrix.errors im
-000004f0: 706f 7274 2049 6e74 656e 7445 7272 6f72  port IntentError
-00000500: 2c20 4d61 7472 6978 4572 726f 722c 204d  , MatrixError, M
-00000510: 466f 7262 6964 6465 6e2c 204d 4e6f 7446  Forbidden, MNotF
-00000520: 6f75 6e64 2c20 5365 7373 696f 6e4e 6f74  ound, SessionNot
-00000530: 466f 756e 640a 6672 6f6d 206d 6175 7472  Found.from mautr
-00000540: 6978 2e74 7970 6573 2069 6d70 6f72 7420  ix.types import 
-00000550: 280a 2020 2020 4175 6469 6f49 6e66 6f2c  (.    AudioInfo,
-00000560: 0a20 2020 2042 6565 7065 724d 6573 7361  .    BeeperMessa
-00000570: 6765 5374 6174 7573 4576 656e 7443 6f6e  geStatusEventCon
-00000580: 7465 6e74 2c0a 2020 2020 436f 6e74 656e  tent,.    Conten
-00000590: 7455 5249 2c0a 2020 2020 456e 6372 7970  tURI,.    Encryp
-000005a0: 7465 6446 696c 652c 0a20 2020 2045 7665  tedFile,.    Eve
-000005b0: 6e74 4944 2c0a 2020 2020 4576 656e 7454  ntID,.    EventT
-000005c0: 7970 652c 0a20 2020 2046 696c 6549 6e66  ype,.    FileInf
-000005d0: 6f2c 0a20 2020 2046 6f72 6d61 742c 0a20  o,.    Format,. 
-000005e0: 2020 2049 6d61 6765 496e 666f 2c0a 2020     ImageInfo,.  
-000005f0: 2020 4c6f 6361 7469 6f6e 4d65 7373 6167    LocationMessag
-00000600: 6545 7665 6e74 436f 6e74 656e 742c 0a20  eEventContent,. 
-00000610: 2020 204d 6564 6961 4d65 7373 6167 6545     MediaMessageE
-00000620: 7665 6e74 436f 6e74 656e 742c 0a20 2020  ventContent,.   
-00000630: 204d 656d 6265 7273 6869 702c 0a20 2020   Membership,.   
-00000640: 204d 656d 6265 7253 7461 7465 4576 656e   MemberStateEven
-00000650: 7443 6f6e 7465 6e74 2c0a 2020 2020 4d65  tContent,.    Me
-00000660: 7373 6167 6545 7665 6e74 436f 6e74 656e  ssageEventConten
-00000670: 742c 0a20 2020 204d 6573 7361 6765 5374  t,.    MessageSt
-00000680: 6174 7573 2c0a 2020 2020 4d65 7373 6167  atus,.    Messag
-00000690: 6553 7461 7475 7352 6561 736f 6e2c 0a20  eStatusReason,. 
-000006a0: 2020 204d 6573 7361 6765 5479 7065 2c0a     MessageType,.
-000006b0: 2020 2020 5265 6c61 7465 7354 6f2c 0a20      RelatesTo,. 
-000006c0: 2020 2052 656c 6174 696f 6e54 7970 652c     RelationType,
-000006d0: 0a20 2020 2052 6f6f 6d49 442c 0a20 2020  .    RoomID,.   
-000006e0: 2054 6578 744d 6573 7361 6765 4576 656e   TextMessageEven
-000006f0: 7443 6f6e 7465 6e74 2c0a 2020 2020 5573  tContent,.    Us
-00000700: 6572 4944 2c0a 2020 2020 5669 6465 6f49  erID,.    VideoI
-00000710: 6e66 6f2c 0a29 0a66 726f 6d20 6d61 7574  nfo,.).from maut
-00000720: 7269 782e 7574 696c 2069 6d70 6f72 7420  rix.util import 
-00000730: 6666 6d70 6567 2c20 6d61 6769 632c 2076  ffmpeg, magic, v
-00000740: 6172 6961 7469 6f6e 5f73 656c 6563 746f  ariation_selecto
-00000750: 720a 6672 6f6d 206d 6175 7472 6978 2e75  r.from mautrix.u
-00000760: 7469 6c2e 666f 726d 6174 7465 7220 696d  til.formatter im
-00000770: 706f 7274 2070 6172 7365 5f68 746d 6c0a  port parse_html.
-00000780: 6672 6f6d 206d 6175 7472 6978 2e75 7469  from mautrix.uti
-00000790: 6c2e 6d65 7373 6167 655f 7365 6e64 5f63  l.message_send_c
-000007a0: 6865 636b 706f 696e 7420 696d 706f 7274  heckpoint import
-000007b0: 204d 6573 7361 6765 5365 6e64 4368 6563   MessageSendChec
-000007c0: 6b70 6f69 6e74 5374 6174 7573 0a66 726f  kpointStatus.fro
-000007d0: 6d20 6d61 7574 7269 782e 7574 696c 2e73  m mautrix.util.s
-000007e0: 696d 706c 655f 6c6f 636b 2069 6d70 6f72  imple_lock impor
-000007f0: 7420 5369 6d70 6c65 4c6f 636b 0a0a 6672  t SimpleLock..fr
-00000800: 6f6d 202e 2069 6d70 6f72 7420 6d61 7472  om . import matr
-00000810: 6978 2061 7320 6d2c 2070 7570 7065 7420  ix as m, puppet 
-00000820: 6173 2070 2c20 7573 6572 2061 7320 750a  as p, user as u.
-00000830: 6672 6f6d 202e 636f 6e66 6967 2069 6d70  from .config imp
-00000840: 6f72 7420 436f 6e66 6967 0a66 726f 6d20  ort Config.from 
-00000850: 2e64 6220 696d 706f 7274 2028 0a20 2020  .db import (.   
-00000860: 204d 6573 7361 6765 2061 7320 4442 4d65   Message as DBMe
-00000870: 7373 6167 652c 0a20 2020 2050 6f72 7461  ssage,.    Porta
-00000880: 6c20 6173 2044 4250 6f72 7461 6c2c 0a20  l as DBPortal,. 
-00000890: 2020 2052 6561 6374 696f 6e20 6173 2044     Reaction as D
-000008a0: 4252 6561 6374 696f 6e2c 0a20 2020 2054  BReaction,.    T
-000008b0: 6872 6561 6454 7970 652c 0a20 2020 2055  hreadType,.    U
-000008c0: 7365 7250 6f72 7461 6c20 6173 2055 7365  serPortal as Use
-000008d0: 7250 6f72 7461 6c2c 0a29 0a66 726f 6d20  rPortal,.).from 
-000008e0: 2e66 6f72 6d61 7474 6572 2069 6d70 6f72  .formatter impor
-000008f0: 7420 6661 6365 626f 6f6b 5f74 6f5f 6d61  t facebook_to_ma
-00000900: 7472 6978 2c20 6d61 7472 6978 5f74 6f5f  trix, matrix_to_
-00000910: 6661 6365 626f 6f6b 0a0a 6966 2054 5950  facebook..if TYP
-00000920: 455f 4348 4543 4b49 4e47 3a0a 2020 2020  E_CHECKING:.    
-00000930: 6672 6f6d 202e 5f5f 6d61 696e 5f5f 2069  from .__main__ i
-00000940: 6d70 6f72 7420 4d65 7373 656e 6765 7242  mport MessengerB
-00000950: 7269 6467 650a 0a74 7279 3a0a 2020 2020  ridge..try:.    
-00000960: 6672 6f6d 2050 494c 2069 6d70 6f72 7420  from PIL import 
-00000970: 496d 6167 650a 6578 6365 7074 2049 6d70  Image.except Imp
-00000980: 6f72 7445 7272 6f72 3a0a 2020 2020 496d  ortError:.    Im
-00000990: 6167 6520 3d20 4e6f 6e65 0a0a 7472 793a  age = None..try:
-000009a0: 0a20 2020 2066 726f 6d20 6d61 7574 7269  .    from mautri
-000009b0: 782e 6372 7970 746f 2e61 7474 6163 686d  x.crypto.attachm
-000009c0: 656e 7473 2069 6d70 6f72 7420 6465 6372  ents import decr
-000009d0: 7970 745f 6174 7461 6368 6d65 6e74 2c20  ypt_attachment, 
-000009e0: 656e 6372 7970 745f 6174 7461 6368 6d65  encrypt_attachme
-000009f0: 6e74 0a65 7863 6570 7420 496d 706f 7274  nt.except Import
-00000a00: 4572 726f 723a 0a20 2020 2064 6563 7279  Error:.    decry
-00000a10: 7074 5f61 7474 6163 686d 656e 7420 3d20  pt_attachment = 
-00000a20: 656e 6372 7970 745f 6174 7461 6368 6d65  encrypt_attachme
-00000a30: 6e74 203d 204e 6f6e 650a 0a67 656f 5f75  nt = None..geo_u
-00000a40: 7269 5f72 6567 6578 3a20 5061 7474 6572  ri_regex: Patter
-00000a50: 6e20 3d20 7265 2e63 6f6d 7069 6c65 2872  n = re.compile(r
-00000a60: 225e 6765 6f3a 282d 3f5c 642b 2e5c 642b  "^geo:(-?\d+.\d+
-00000a70: 292c 282d 3f5c 642b 2e5c 642b 2924 2229  ),(-?\d+.\d+)$")
-00000a80: 0a0a 0a63 6c61 7373 2046 616b 654c 6f63  ...class FakeLoc
-00000a90: 6b3a 0a20 2020 2061 7379 6e63 2064 6566  k:.    async def
-00000aa0: 205f 5f61 656e 7465 725f 5f28 7365 6c66   __aenter__(self
-00000ab0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00000ac0: 2020 2070 6173 730a 0a20 2020 2061 7379     pass..    asy
-00000ad0: 6e63 2064 6566 205f 5f61 6578 6974 5f5f  nc def __aexit__
-00000ae0: 2873 656c 662c 2065 7863 5f74 7970 652c  (self, exc_type,
-00000af0: 2065 7863 2c20 7462 2920 2d3e 204e 6f6e   exc, tb) -> Non
-00000b00: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
-00000b10: 0a0a 5374 6174 6542 7269 6467 6520 3d20  ..StateBridge = 
-00000b20: 4576 656e 7454 7970 652e 6669 6e64 2822  EventType.find("
-00000b30: 6d2e 6272 6964 6765 222c 2045 7665 6e74  m.bridge", Event
-00000b40: 5479 7065 2e43 6c61 7373 2e53 5441 5445  Type.Class.STATE
-00000b50: 290a 5374 6174 6548 616c 6653 686f 7442  ).StateHalfShotB
-00000b60: 7269 6467 6520 3d20 4576 656e 7454 7970  ridge = EventTyp
-00000b70: 652e 6669 6e64 2822 756b 2e68 616c 662d  e.find("uk.half-
-00000b80: 7368 6f74 2e62 7269 6467 6522 2c20 4576  shot.bridge", Ev
-00000b90: 656e 7454 7970 652e 436c 6173 732e 5354  entType.Class.ST
-00000ba0: 4154 4529 0a0a 0a63 6c61 7373 2050 6f72  ATE)...class Por
-00000bb0: 7461 6c28 4442 506f 7274 616c 2c20 4261  tal(DBPortal, Ba
-00000bc0: 7365 506f 7274 616c 293a 0a20 2020 2069  sePortal):.    i
-00000bd0: 6e76 6974 655f 6f77 6e5f 7075 7070 6574  nvite_own_puppet
-00000be0: 5f74 6f5f 706d 3a20 626f 6f6c 203d 2046  _to_pm: bool = F
-00000bf0: 616c 7365 0a20 2020 2062 795f 6d78 6964  alse.    by_mxid
-00000c00: 3a20 6469 6374 5b52 6f6f 6d49 442c 2050  : dict[RoomID, P
-00000c10: 6f72 7461 6c5d 203d 207b 7d0a 2020 2020  ortal] = {}.    
-00000c20: 6279 5f66 6269 643a 2064 6963 745b 7475  by_fbid: dict[tu
-00000c30: 706c 655b 696e 742c 2069 6e74 5d2c 2050  ple[int, int], P
-00000c40: 6f72 7461 6c5d 203d 207b 7d0a 2020 2020  ortal] = {}.    
-00000c50: 6d61 7472 6978 3a20 6d2e 4d61 7472 6978  matrix: m.Matrix
-00000c60: 4861 6e64 6c65 720a 2020 2020 636f 6e66  Handler.    conf
-00000c70: 6967 3a20 436f 6e66 6967 0a0a 2020 2020  ig: Config..    
-00000c80: 5f6d 6169 6e5f 696e 7465 6e74 3a20 496e  _main_intent: In
-00000c90: 7465 6e74 4150 4920 7c20 4e6f 6e65 0a20  tentAPI | None. 
-00000ca0: 2020 205f 6372 6561 7465 5f72 6f6f 6d5f     _create_room_
-00000cb0: 6c6f 636b 3a20 6173 796e 6369 6f2e 4c6f  lock: asyncio.Lo
-00000cc0: 636b 0a20 2020 205f 6465 6475 703a 2064  ck.    _dedup: d
-00000cd0: 6571 7565 5b73 7472 5d0a 2020 2020 5f6f  eque[str].    _o
-00000ce0: 7469 5f64 6564 7570 3a20 6469 6374 5b69  ti_dedup: dict[i
-00000cf0: 6e74 2c20 4442 4d65 7373 6167 655d 0a20  nt, DBMessage]. 
-00000d00: 2020 205f 7365 6e64 5f6c 6f63 6b73 3a20     _send_locks: 
-00000d10: 6469 6374 5b69 6e74 2c20 6173 796e 6369  dict[int, asynci
-00000d20: 6f2e 4c6f 636b 5d0a 2020 2020 5f6e 6f6f  o.Lock].    _noo
-00000d30: 705f 6c6f 636b 3a20 4661 6b65 4c6f 636b  p_lock: FakeLock
-00000d40: 203d 2046 616b 654c 6f63 6b28 290a 2020   = FakeLock().  
-00000d50: 2020 5f74 7970 696e 673a 2073 6574 5b55    _typing: set[U
-00000d60: 7365 7249 445d 0a20 2020 2062 6163 6b66  serID].    backf
-00000d70: 696c 6c5f 6c6f 636b 3a20 5369 6d70 6c65  ill_lock: Simple
-00000d80: 4c6f 636b 0a20 2020 205f 6261 636b 6669  Lock.    _backfi
-00000d90: 6c6c 5f6c 6561 7665 3a20 7365 745b 496e  ll_leave: set[In
-00000da0: 7465 6e74 4150 495d 207c 204e 6f6e 650a  tentAPI] | None.
-00000db0: 2020 2020 5f73 6c65 6570 696e 675f 746f      _sleeping_to
-00000dc0: 5f72 6573 796e 633a 2062 6f6f 6c0a 2020  _resync: bool.  
-00000dd0: 2020 5f73 6368 6564 756c 6564 5f72 6573    _scheduled_res
-00000de0: 796e 633a 2061 7379 6e63 696f 2e54 6173  ync: asyncio.Tas
-00000df0: 6b20 7c20 4e6f 6e65 0a20 2020 205f 7265  k | None.    _re
-00000e00: 7379 6e63 5f74 6172 6765 7473 3a20 6469  sync_targets: di
-00000e10: 6374 5b69 6e74 2c20 702e 5075 7070 6574  ct[int, p.Puppet
-00000e20: 5d0a 0a20 2020 2064 6566 205f 5f69 6e69  ]..    def __ini
-00000e30: 745f 5f28 0a20 2020 2020 2020 2073 656c  t__(.        sel
-00000e40: 662c 0a20 2020 2020 2020 2066 6269 643a  f,.        fbid:
-00000e50: 2069 6e74 2c0a 2020 2020 2020 2020 6662   int,.        fb
-00000e60: 5f72 6563 6569 7665 723a 2069 6e74 2c0a  _receiver: int,.
-00000e70: 2020 2020 2020 2020 6662 5f74 7970 653a          fb_type:
-00000e80: 2054 6872 6561 6454 7970 652c 0a20 2020   ThreadType,.   
-00000e90: 2020 2020 206d 7869 643a 2052 6f6f 6d49       mxid: RoomI
-00000ea0: 4420 7c20 4e6f 6e65 203d 204e 6f6e 652c  D | None = None,
-00000eb0: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
-00000ec0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00000ed0: 2c0a 2020 2020 2020 2020 7068 6f74 6f5f  ,.        photo_
-00000ee0: 6964 3a20 7374 7220 7c20 4e6f 6e65 203d  id: str | None =
-00000ef0: 204e 6f6e 652c 0a20 2020 2020 2020 2061   None,.        a
-00000f00: 7661 7461 725f 7572 6c3a 2043 6f6e 7465  vatar_url: Conte
-00000f10: 6e74 5552 4920 7c20 4e6f 6e65 203d 204e  ntURI | None = N
-00000f20: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
-00000f30: 7279 7074 6564 3a20 626f 6f6c 203d 2046  rypted: bool = F
-00000f40: 616c 7365 2c0a 2020 2020 2020 2020 6e61  alse,.        na
-00000f50: 6d65 5f73 6574 3a20 626f 6f6c 203d 2046  me_set: bool = F
-00000f60: 616c 7365 2c0a 2020 2020 2020 2020 6176  alse,.        av
-00000f70: 6174 6172 5f73 6574 3a20 626f 6f6c 203d  atar_set: bool =
-00000f80: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-00000f90: 7265 6c61 795f 7573 6572 5f69 643a 2055  relay_user_id: U
-00000fa0: 7365 7249 4420 7c20 4e6f 6e65 203d 204e  serID | None = N
-00000fb0: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
-00000fc0: 6e65 3a0a 2020 2020 2020 2020 7375 7065  ne:.        supe
-00000fd0: 7228 292e 5f5f 696e 6974 5f5f 280a 2020  r().__init__(.  
-00000fe0: 2020 2020 2020 2020 2020 6662 6964 2c0a            fbid,.
-00000ff0: 2020 2020 2020 2020 2020 2020 6662 5f72              fb_r
-00001000: 6563 6569 7665 722c 0a20 2020 2020 2020  eceiver,.       
-00001010: 2020 2020 2066 625f 7479 7065 2c0a 2020       fb_type,.  
-00001020: 2020 2020 2020 2020 2020 6d78 6964 2c0a            mxid,.
-00001030: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00001040: 2c0a 2020 2020 2020 2020 2020 2020 7068  ,.            ph
-00001050: 6f74 6f5f 6964 2c0a 2020 2020 2020 2020  oto_id,.        
-00001060: 2020 2020 6176 6174 6172 5f75 726c 2c0a      avatar_url,.
-00001070: 2020 2020 2020 2020 2020 2020 656e 6372              encr
-00001080: 7970 7465 642c 0a20 2020 2020 2020 2020  ypted,.         
-00001090: 2020 206e 616d 655f 7365 742c 0a20 2020     name_set,.   
-000010a0: 2020 2020 2020 2020 2061 7661 7461 725f           avatar_
-000010b0: 7365 742c 0a20 2020 2020 2020 2020 2020  set,.           
-000010c0: 2072 656c 6179 5f75 7365 725f 6964 2c0a   relay_user_id,.
-000010d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000010e0: 2020 7365 6c66 2e6c 6f67 203d 2073 656c    self.log = sel
-000010f0: 662e 6c6f 672e 6765 7443 6869 6c64 2873  f.log.getChild(s
-00001100: 656c 662e 6662 6964 5f6c 6f67 290a 0a20  elf.fbid_log).. 
-00001110: 2020 2020 2020 2073 656c 662e 5f6d 6169         self._mai
-00001120: 6e5f 696e 7465 6e74 203d 204e 6f6e 650a  n_intent = None.
-00001130: 2020 2020 2020 2020 7365 6c66 2e5f 6372          self._cr
-00001140: 6561 7465 5f72 6f6f 6d5f 6c6f 636b 203d  eate_room_lock =
-00001150: 2061 7379 6e63 696f 2e4c 6f63 6b28 290a   asyncio.Lock().
-00001160: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
-00001170: 6475 7020 3d20 6465 7175 6528 6d61 786c  dup = deque(maxl
-00001180: 656e 3d31 3030 290a 2020 2020 2020 2020  en=100).        
-00001190: 7365 6c66 2e5f 6f74 695f 6465 6475 7020  self._oti_dedup 
-000011a0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-000011b0: 662e 5f73 656e 645f 6c6f 636b 7320 3d20  f._send_locks = 
-000011c0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-000011d0: 5f74 7970 696e 6720 3d20 7365 7428 290a  _typing = set().
-000011e0: 2020 2020 2020 2020 7365 6c66 2e5f 736c          self._sl
-000011f0: 6565 7069 6e67 5f74 6f5f 7265 7379 6e63  eeping_to_resync
-00001200: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00001210: 2073 656c 662e 5f73 6368 6564 756c 6564   self._scheduled
-00001220: 5f72 6573 796e 6320 3d20 4e6f 6e65 0a20  _resync = None. 
-00001230: 2020 2020 2020 2073 656c 662e 5f72 6573         self._res
-00001240: 796e 635f 7461 7267 6574 7320 3d20 7b7d  ync_targets = {}
-00001250: 0a0a 2020 2020 2020 2020 7365 6c66 2e62  ..        self.b
-00001260: 6163 6b66 696c 6c5f 6c6f 636b 203d 2053  ackfill_lock = S
-00001270: 696d 706c 654c 6f63 6b28 0a20 2020 2020  impleLock(.     
-00001280: 2020 2020 2020 2022 5761 6974 696e 6720         "Waiting 
-00001290: 666f 7220 6261 636b 6669 6c6c 696e 6720  for backfilling 
-000012a0: 746f 2066 696e 6973 6820 6265 666f 7265  to finish before
-000012b0: 2068 616e 646c 696e 6720 2573 222c 206c   handling %s", l
-000012c0: 6f67 3d73 656c 662e 6c6f 670a 2020 2020  og=self.log.    
-000012d0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-000012e0: 6c66 2e5f 6261 636b 6669 6c6c 5f6c 6561  lf._backfill_lea
-000012f0: 7665 203d 204e 6f6e 650a 0a20 2020 2020  ve = None..     
-00001300: 2020 2073 656c 662e 5f72 656c 6179 5f75     self._relay_u
-00001310: 7365 7220 3d20 4e6f 6e65 0a0a 2020 2020  ser = None..    
-00001320: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-00001330: 2064 6566 2069 6e69 745f 636c 7328 636c   def init_cls(cl
-00001340: 732c 2062 7269 6467 653a 2022 4d65 7373  s, bridge: "Mess
-00001350: 656e 6765 7242 7269 6467 6522 2920 2d3e  engerBridge") ->
-00001360: 204e 6f6e 653a 0a20 2020 2020 2020 2042   None:.        B
-00001370: 6173 6550 6f72 7461 6c2e 6272 6964 6765  asePortal.bridge
-00001380: 203d 2062 7269 6467 650a 2020 2020 2020   = bridge.      
-00001390: 2020 636c 732e 617a 203d 2062 7269 6467    cls.az = bridg
-000013a0: 652e 617a 0a20 2020 2020 2020 2063 6c73  e.az.        cls
-000013b0: 2e63 6f6e 6669 6720 3d20 6272 6964 6765  .config = bridge
-000013c0: 2e63 6f6e 6669 670a 2020 2020 2020 2020  .config.        
-000013d0: 636c 732e 6c6f 6f70 203d 2062 7269 6467  cls.loop = bridg
-000013e0: 652e 6c6f 6f70 0a20 2020 2020 2020 2063  e.loop.        c
-000013f0: 6c73 2e6d 6174 7269 7820 3d20 6272 6964  ls.matrix = brid
-00001400: 6765 2e6d 6174 7269 780a 2020 2020 2020  ge.matrix.      
-00001410: 2020 636c 732e 696e 7669 7465 5f6f 776e    cls.invite_own
-00001420: 5f70 7570 7065 745f 746f 5f70 6d20 3d20  _puppet_to_pm = 
-00001430: 636c 732e 636f 6e66 6967 5b22 6272 6964  cls.config["brid
-00001440: 6765 2e69 6e76 6974 655f 6f77 6e5f 7075  ge.invite_own_pu
-00001450: 7070 6574 5f74 6f5f 706d 225d 0a20 2020  ppet_to_pm"].   
-00001460: 2020 2020 204e 6f74 6966 6963 6174 696f       Notificatio
-00001470: 6e44 6973 6162 6c65 722e 7075 7070 6574  nDisabler.puppet
-00001480: 5f63 6c73 203d 2070 2e50 7570 7065 740a  _cls = p.Puppet.
-00001490: 2020 2020 2020 2020 4e6f 7469 6669 6361          Notifica
-000014a0: 7469 6f6e 4469 7361 626c 6572 2e63 6f6e  tionDisabler.con
-000014b0: 6669 675f 656e 6162 6c65 6420 3d20 636c  fig_enabled = cl
-000014c0: 732e 636f 6e66 6967 5b22 6272 6964 6765  s.config["bridge
-000014d0: 2e62 6163 6b66 696c 6c2e 6469 7361 626c  .backfill.disabl
-000014e0: 655f 6e6f 7469 6669 6361 7469 6f6e 7322  e_notifications"
-000014f0: 5d0a 0a20 2020 2023 2072 6567 696f 6e20  ]..    # region 
-00001500: 4442 2063 6f6e 7665 7273 696f 6e0a 0a20  DB conversion.. 
-00001510: 2020 2061 7379 6e63 2064 6566 2064 656c     async def del
-00001520: 6574 6528 7365 6c66 2920 2d3e 204e 6f6e  ete(self) -> Non
-00001530: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
-00001540: 6c66 2e6d 7869 643a 0a20 2020 2020 2020  lf.mxid:.       
-00001550: 2020 2020 2061 7761 6974 2044 424d 6573       await DBMes
-00001560: 7361 6765 2e64 656c 6574 655f 616c 6c5f  sage.delete_all_
-00001570: 6279 5f72 6f6f 6d28 7365 6c66 2e6d 7869  by_room(self.mxi
-00001580: 6429 0a20 2020 2020 2020 2020 2020 2061  d).            a
-00001590: 7761 6974 2044 4252 6561 6374 696f 6e2e  wait DBReaction.
-000015a0: 6465 6c65 7465 5f61 6c6c 5f62 795f 726f  delete_all_by_ro
-000015b0: 6f6d 2873 656c 662e 6d78 6964 290a 2020  om(self.mxid).  
-000015c0: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000015d0: 795f 6d78 6964 2e70 6f70 2873 656c 662e  y_mxid.pop(self.
-000015e0: 6d78 6964 2c20 4e6f 6e65 290a 2020 2020  mxid, None).    
-000015f0: 2020 2020 7365 6c66 2e62 795f 6662 6964      self.by_fbid
-00001600: 2e70 6f70 2873 656c 662e 6662 6964 5f66  .pop(self.fbid_f
-00001610: 756c 6c2c 204e 6f6e 6529 0a20 2020 2020  ull, None).     
-00001620: 2020 2073 656c 662e 6d78 6964 203d 204e     self.mxid = N
-00001630: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-00001640: 2e6e 616d 655f 7365 7420 3d20 4661 6c73  .name_set = Fals
-00001650: 650a 2020 2020 2020 2020 7365 6c66 2e61  e.        self.a
-00001660: 7661 7461 725f 7365 7420 3d20 4661 6c73  vatar_set = Fals
-00001670: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
-00001680: 656c 6179 5f75 7365 725f 6964 203d 204e  elay_user_id = N
-00001690: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-000016a0: 2e65 6e63 7279 7074 6564 203d 2046 616c  .encrypted = Fal
-000016b0: 7365 0a20 2020 2020 2020 2061 7761 6974  se.        await
-000016c0: 2073 7570 6572 2829 2e73 6176 6528 290a   super().save().
-000016d0: 0a20 2020 2023 2065 6e64 7265 6769 6f6e  .    # endregion
-000016e0: 0a20 2020 2023 2072 6567 696f 6e20 5072  .    # region Pr
-000016f0: 6f70 6572 7469 6573 0a0a 2020 2020 4070  operties..    @p
-00001700: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00001710: 6662 6964 5f66 756c 6c28 7365 6c66 2920  fbid_full(self) 
-00001720: 2d3e 2074 7570 6c65 5b69 6e74 2c20 696e  -> tuple[int, in
-00001730: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
-00001740: 726e 2073 656c 662e 6662 6964 2c20 7365  rn self.fbid, se
-00001750: 6c66 2e66 625f 7265 6365 6976 6572 0a0a  lf.fb_receiver..
-00001760: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00001770: 2020 6465 6620 6662 6964 5f6c 6f67 2873    def fbid_log(s
-00001780: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-00001790: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-000017a0: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
-000017b0: 2020 2020 7265 7475 726e 2066 227b 7365      return f"{se
-000017c0: 6c66 2e66 6269 647d 3c2d 3e7b 7365 6c66  lf.fbid}<->{self
-000017d0: 2e66 625f 7265 6365 6976 6572 7d22 0a20  .fb_receiver}". 
-000017e0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-000017f0: 7228 7365 6c66 2e66 6269 6429 0a0a 2020  r(self.fbid)..  
-00001800: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00001810: 6465 6620 6d71 7474 5f6b 6579 2873 656c  def mqtt_key(sel
-00001820: 6629 202d 3e20 6d71 7474 2e54 6872 6561  f) -> mqtt.Threa
-00001830: 644b 6579 3a0a 2020 2020 2020 2020 6966  dKey:.        if
-00001840: 2073 656c 662e 6662 5f74 7970 6520 3d3d   self.fb_type ==
-00001850: 2054 6872 6561 6454 7970 652e 5553 4552   ThreadType.USER
-00001860: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00001870: 7475 726e 206d 7174 742e 5468 7265 6164  turn mqtt.Thread
-00001880: 4b65 7928 6f74 6865 725f 7573 6572 5f69  Key(other_user_i
-00001890: 643d 7365 6c66 2e66 6269 6429 0a20 2020  d=self.fbid).   
-000018a0: 2020 2020 2065 6c69 6620 7365 6c66 2e66       elif self.f
-000018b0: 625f 7479 7065 203d 3d20 5468 7265 6164  b_type == Thread
-000018c0: 5479 7065 2e47 524f 5550 3a0a 2020 2020  Type.GROUP:.    
-000018d0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-000018e0: 7174 742e 5468 7265 6164 4b65 7928 7468  qtt.ThreadKey(th
-000018f0: 7265 6164 5f66 6269 643d 7365 6c66 2e66  read_fbid=self.f
-00001900: 6269 6429 0a20 2020 2020 2020 2065 6c73  bid).        els
-00001910: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00001920: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00001930: 2255 6e73 7570 706f 7274 6564 2074 6872  "Unsupported thr
-00001940: 6561 6420 7479 7065 2229 0a0a 2020 2020  ead type")..    
-00001950: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00001960: 6620 6772 6170 6871 6c5f 6b65 7928 7365  f graphql_key(se
-00001970: 6c66 2920 2d3e 2067 7261 7068 716c 2e54  lf) -> graphql.T
-00001980: 6872 6561 644b 6579 3a0a 2020 2020 2020  hreadKey:.      
-00001990: 2020 6966 2073 656c 662e 6662 5f74 7970    if self.fb_typ
-000019a0: 6520 3d3d 2054 6872 6561 6454 7970 652e  e == ThreadType.
-000019b0: 5553 4552 3a0a 2020 2020 2020 2020 2020  USER:.          
-000019c0: 2020 7265 7475 726e 2067 7261 7068 716c    return graphql
-000019d0: 2e54 6872 6561 644b 6579 286f 7468 6572  .ThreadKey(other
-000019e0: 5f75 7365 725f 6964 3d73 7472 2873 656c  _user_id=str(sel
-000019f0: 662e 6662 6964 2929 0a20 2020 2020 2020  f.fbid)).       
-00001a00: 2065 6c69 6620 7365 6c66 2e66 625f 7479   elif self.fb_ty
-00001a10: 7065 203d 3d20 5468 7265 6164 5479 7065  pe == ThreadType
-00001a20: 2e47 524f 5550 3a0a 2020 2020 2020 2020  .GROUP:.        
-00001a30: 2020 2020 7265 7475 726e 2067 7261 7068      return graph
-00001a40: 716c 2e54 6872 6561 644b 6579 2874 6872  ql.ThreadKey(thr
-00001a50: 6561 645f 6662 6964 3d73 7472 2873 656c  ead_fbid=str(sel
-00001a60: 662e 6662 6964 2929 0a20 2020 2020 2020  f.fbid)).       
-00001a70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00001a80: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00001a90: 726f 7228 2255 6e73 7570 706f 7274 6564  ror("Unsupported
-00001aa0: 2074 6872 6561 6420 7479 7065 2229 0a0a   thread type")..
+00000350: 2c20 4177 6169 7461 626c 652c 204c 6974  , Awaitable, Lit
+00000360: 6572 616c 2c20 5061 7474 6572 6e2c 2054  eral, Pattern, T
+00000370: 7570 6c65 2c20 6361 7374 0a66 726f 6d20  uple, cast.from 
+00000380: 636f 6c6c 6563 7469 6f6e 7320 696d 706f  collections impo
+00000390: 7274 2064 6571 7565 0a66 726f 6d20 6874  rt deque.from ht
+000003a0: 6d6c 2069 6d70 6f72 7420 6573 6361 7065  ml import escape
+000003b0: 0a66 726f 6d20 696f 2069 6d70 6f72 7420  .from io import 
+000003c0: 4279 7465 7349 4f0a 696d 706f 7274 2061  BytesIO.import a
+000003d0: 7379 6e63 696f 0a69 6d70 6f72 7420 6261  syncio.import ba
+000003e0: 7365 3634 0a69 6d70 6f72 7420 6861 7368  se64.import hash
+000003f0: 6c69 620a 696d 706f 7274 206a 736f 6e0a  lib.import json.
+00000400: 696d 706f 7274 206d 696d 6574 7970 6573  import mimetypes
+00000410: 0a69 6d70 6f72 7420 7265 0a69 6d70 6f72  .import re.impor
+00000420: 7420 7469 6d65 0a0a 6672 6f6d 2079 6172  t time..from yar
+00000430: 6c20 696d 706f 7274 2055 524c 0a0a 6672  l import URL..fr
+00000440: 6f6d 206d 6175 6662 6170 692e 6874 7470  om maufbapi.http
+00000450: 2e65 7272 6f72 7320 696d 706f 7274 2052  .errors import R
+00000460: 6174 654c 696d 6974 4578 6365 6564 6564  ateLimitExceeded
+00000470: 0a66 726f 6d20 6d61 7566 6261 7069 2e74  .from maufbapi.t
+00000480: 7970 6573 2069 6d70 6f72 7420 6772 6170  ypes import grap
+00000490: 6871 6c2c 206d 7174 740a 6672 6f6d 206d  hql, mqtt.from m
+000004a0: 6175 7472 6978 2e61 7070 7365 7276 6963  autrix.appservic
+000004b0: 6520 696d 706f 7274 2044 4f55 424c 455f  e import DOUBLE_
+000004c0: 5055 5050 4554 5f53 4f55 5243 455f 4b45  PUPPET_SOURCE_KE
+000004d0: 592c 2049 6e74 656e 7441 5049 0a66 726f  Y, IntentAPI.fro
+000004e0: 6d20 6d61 7574 7269 782e 6272 6964 6765  m mautrix.bridge
+000004f0: 2069 6d70 6f72 7420 4261 7365 506f 7274   import BasePort
+00000500: 616c 2c20 6173 796e 635f 6765 7474 6572  al, async_getter
+00000510: 5f6c 6f63 6b0a 6672 6f6d 206d 6175 7472  _lock.from mautr
+00000520: 6978 2e65 7272 6f72 7320 696d 706f 7274  ix.errors import
+00000530: 2044 6563 7279 7074 696f 6e45 7272 6f72   DecryptionError
+00000540: 2c20 496e 7465 6e74 4572 726f 722c 204d  , IntentError, M
+00000550: 6174 7269 7845 7272 6f72 2c20 4d46 6f72  atrixError, MFor
+00000560: 6269 6464 656e 2c20 4d4e 6f74 466f 756e  bidden, MNotFoun
+00000570: 640a 6672 6f6d 206d 6175 7472 6978 2e74  d.from mautrix.t
+00000580: 7970 6573 2069 6d70 6f72 7420 280a 2020  ypes import (.  
+00000590: 2020 4175 6469 6f49 6e66 6f2c 0a20 2020    AudioInfo,.   
+000005a0: 2042 6174 6368 4944 2c0a 2020 2020 4261   BatchID,.    Ba
+000005b0: 7463 6853 656e 6445 7665 6e74 2c0a 2020  tchSendEvent,.  
+000005c0: 2020 4261 7463 6853 656e 6453 7461 7465    BatchSendState
+000005d0: 4576 656e 742c 0a20 2020 2042 6565 7065  Event,.    Beepe
+000005e0: 724d 6573 7361 6765 5374 6174 7573 4576  rMessageStatusEv
+000005f0: 656e 7443 6f6e 7465 6e74 2c0a 2020 2020  entContent,.    
+00000600: 436f 6e74 656e 7455 5249 2c0a 2020 2020  ContentURI,.    
+00000610: 456e 6372 7970 7465 6446 696c 652c 0a20  EncryptedFile,. 
+00000620: 2020 2045 7665 6e74 4944 2c0a 2020 2020     EventID,.    
+00000630: 4576 656e 7454 7970 652c 0a20 2020 2046  EventType,.    F
+00000640: 696c 6549 6e66 6f2c 0a20 2020 2046 6f72  ileInfo,.    For
+00000650: 6d61 742c 0a20 2020 2049 6d61 6765 496e  mat,.    ImageIn
+00000660: 666f 2c0a 2020 2020 4c6f 6361 7469 6f6e  fo,.    Location
+00000670: 4d65 7373 6167 6545 7665 6e74 436f 6e74  MessageEventCont
+00000680: 656e 742c 0a20 2020 204d 6564 6961 4d65  ent,.    MediaMe
+00000690: 7373 6167 6545 7665 6e74 436f 6e74 656e  ssageEventConten
+000006a0: 742c 0a20 2020 204d 656d 6265 7273 6869  t,.    Membershi
+000006b0: 702c 0a20 2020 204d 656d 6265 7253 7461  p,.    MemberSta
+000006c0: 7465 4576 656e 7443 6f6e 7465 6e74 2c0a  teEventContent,.
+000006d0: 2020 2020 4d65 7373 6167 6545 7665 6e74      MessageEvent
+000006e0: 436f 6e74 656e 742c 0a20 2020 204d 6573  Content,.    Mes
+000006f0: 7361 6765 5374 6174 7573 2c0a 2020 2020  sageStatus,.    
+00000700: 4d65 7373 6167 6553 7461 7475 7352 6561  MessageStatusRea
+00000710: 736f 6e2c 0a20 2020 204d 6573 7361 6765  son,.    Message
+00000720: 5479 7065 2c0a 2020 2020 5265 6163 7469  Type,.    Reacti
+00000730: 6f6e 4576 656e 7443 6f6e 7465 6e74 2c0a  onEventContent,.
+00000740: 2020 2020 5265 6c61 7465 7354 6f2c 0a20      RelatesTo,. 
+00000750: 2020 2052 656c 6174 696f 6e54 7970 652c     RelationType,
+00000760: 0a20 2020 2052 6f6f 6d49 442c 0a20 2020  .    RoomID,.   
+00000770: 2054 6578 744d 6573 7361 6765 4576 656e   TextMessageEven
+00000780: 7443 6f6e 7465 6e74 2c0a 2020 2020 5573  tContent,.    Us
+00000790: 6572 4944 2c0a 2020 2020 5669 6465 6f49  erID,.    VideoI
+000007a0: 6e66 6f2c 0a29 0a66 726f 6d20 6d61 7574  nfo,.).from maut
+000007b0: 7269 782e 7574 696c 2069 6d70 6f72 7420  rix.util import 
+000007c0: 6261 636b 6772 6f75 6e64 5f74 6173 6b2c  background_task,
+000007d0: 2066 666d 7065 672c 206d 6167 6963 2c20   ffmpeg, magic, 
+000007e0: 7661 7269 6174 696f 6e5f 7365 6c65 6374  variation_select
+000007f0: 6f72 0a66 726f 6d20 6d61 7574 7269 782e  or.from mautrix.
+00000800: 7574 696c 2e66 6f72 6d61 7474 6572 2069  util.formatter i
+00000810: 6d70 6f72 7420 7061 7273 655f 6874 6d6c  mport parse_html
+00000820: 0a66 726f 6d20 6d61 7574 7269 782e 7574  .from mautrix.ut
+00000830: 696c 2e6d 6573 7361 6765 5f73 656e 645f  il.message_send_
+00000840: 6368 6563 6b70 6f69 6e74 2069 6d70 6f72  checkpoint impor
+00000850: 7420 4d65 7373 6167 6553 656e 6443 6865  t MessageSendChe
+00000860: 636b 706f 696e 7453 7461 7475 730a 0a66  ckpointStatus..f
+00000870: 726f 6d20 2e20 696d 706f 7274 206d 6174  rom . import mat
+00000880: 7269 7820 6173 206d 2c20 7075 7070 6574  rix as m, puppet
+00000890: 2061 7320 702c 2075 7365 7220 6173 2075   as p, user as u
+000008a0: 0a66 726f 6d20 2e63 6f6e 6669 6720 696d  .from .config im
+000008b0: 706f 7274 2043 6f6e 6669 670a 6672 6f6d  port Config.from
+000008c0: 202e 6462 2069 6d70 6f72 7420 280a 2020   .db import (.  
+000008d0: 2020 4261 636b 6669 6c6c 2c0a 2020 2020    Backfill,.    
+000008e0: 4d65 7373 6167 6520 6173 2044 424d 6573  Message as DBMes
+000008f0: 7361 6765 2c0a 2020 2020 506f 7274 616c  sage,.    Portal
+00000900: 2061 7320 4442 506f 7274 616c 2c0a 2020   as DBPortal,.  
+00000910: 2020 5265 6163 7469 6f6e 2061 7320 4442    Reaction as DB
+00000920: 5265 6163 7469 6f6e 2c0a 2020 2020 5468  Reaction,.    Th
+00000930: 7265 6164 5479 7065 2c0a 2020 2020 5573  readType,.    Us
+00000940: 6572 506f 7274 616c 2061 7320 5573 6572  erPortal as User
+00000950: 506f 7274 616c 2c0a 290a 6672 6f6d 202e  Portal,.).from .
+00000960: 666f 726d 6174 7465 7220 696d 706f 7274  formatter import
+00000970: 2066 6163 6562 6f6f 6b5f 746f 5f6d 6174   facebook_to_mat
+00000980: 7269 782c 206d 6174 7269 785f 746f 5f66  rix, matrix_to_f
+00000990: 6163 6562 6f6f 6b0a 6672 6f6d 202e 7365  acebook.from .se
+000009a0: 676d 656e 745f 616e 616c 7974 6963 7320  gment_analytics 
+000009b0: 696d 706f 7274 2074 7261 636b 0a0a 6966  import track..if
+000009c0: 2054 5950 455f 4348 4543 4b49 4e47 3a0a   TYPE_CHECKING:.
+000009d0: 2020 2020 6672 6f6d 202e 5f5f 6d61 696e      from .__main
+000009e0: 5f5f 2069 6d70 6f72 7420 4d65 7373 656e  __ import Messen
+000009f0: 6765 7242 7269 6467 650a 0a74 7279 3a0a  gerBridge..try:.
+00000a00: 2020 2020 6672 6f6d 2050 494c 2069 6d70      from PIL imp
+00000a10: 6f72 7420 496d 6167 650a 6578 6365 7074  ort Image.except
+00000a20: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
+00000a30: 2020 496d 6167 6520 3d20 4e6f 6e65 0a0a    Image = None..
+00000a40: 7472 793a 0a20 2020 2066 726f 6d20 6d61  try:.    from ma
+00000a50: 7574 7269 782e 6372 7970 746f 2e61 7474  utrix.crypto.att
+00000a60: 6163 686d 656e 7473 2069 6d70 6f72 7420  achments import 
+00000a70: 6465 6372 7970 745f 6174 7461 6368 6d65  decrypt_attachme
+00000a80: 6e74 2c20 656e 6372 7970 745f 6174 7461  nt, encrypt_atta
+00000a90: 6368 6d65 6e74 0a65 7863 6570 7420 496d  chment.except Im
+00000aa0: 706f 7274 4572 726f 723a 0a20 2020 2064  portError:.    d
+00000ab0: 6563 7279 7074 5f61 7474 6163 686d 656e  ecrypt_attachmen
+00000ac0: 7420 3d20 656e 6372 7970 745f 6174 7461  t = encrypt_atta
+00000ad0: 6368 6d65 6e74 203d 204e 6f6e 650a 0a67  chment = None..g
+00000ae0: 656f 5f75 7269 5f72 6567 6578 3a20 5061  eo_uri_regex: Pa
+00000af0: 7474 6572 6e20 3d20 7265 2e63 6f6d 7069  ttern = re.compi
+00000b00: 6c65 2872 225e 6765 6f3a 282d 3f5c 642b  le(r"^geo:(-?\d+
+00000b10: 2e5c 642b 292c 282d 3f5c 642b 2e5c 642b  .\d+),(-?\d+.\d+
+00000b20: 2924 2229 0a0a 0a63 6c61 7373 2046 616b  )$")...class Fak
+00000b30: 654c 6f63 6b3a 0a20 2020 2061 7379 6e63  eLock:.    async
+00000b40: 2064 6566 205f 5f61 656e 7465 725f 5f28   def __aenter__(
+00000b50: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+00000b60: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00000b70: 2061 7379 6e63 2064 6566 205f 5f61 6578   async def __aex
+00000b80: 6974 5f5f 2873 656c 662c 2065 7863 5f74  it__(self, exc_t
+00000b90: 7970 652c 2065 7863 2c20 7462 2920 2d3e  ype, exc, tb) ->
+00000ba0: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00000bb0: 6173 730a 0a0a 5374 6174 6542 7269 6467  ass...StateBridg
+00000bc0: 6520 3d20 4576 656e 7454 7970 652e 6669  e = EventType.fi
+00000bd0: 6e64 2822 6d2e 6272 6964 6765 222c 2045  nd("m.bridge", E
+00000be0: 7665 6e74 5479 7065 2e43 6c61 7373 2e53  ventType.Class.S
+00000bf0: 5441 5445 290a 5374 6174 6548 616c 6653  TATE).StateHalfS
+00000c00: 686f 7442 7269 6467 6520 3d20 4576 656e  hotBridge = Even
+00000c10: 7454 7970 652e 6669 6e64 2822 756b 2e68  tType.find("uk.h
+00000c20: 616c 662d 7368 6f74 2e62 7269 6467 6522  alf-shot.bridge"
+00000c30: 2c20 4576 656e 7454 7970 652e 436c 6173  , EventType.Clas
+00000c40: 732e 5354 4154 4529 0a0a 506f 7274 616c  s.STATE)..Portal
+00000c50: 4372 6561 7465 4475 6d6d 7920 3d20 4576  CreateDummy = Ev
+00000c60: 656e 7454 7970 652e 6669 6e64 2822 6669  entType.find("fi
+00000c70: 2e6d 6175 2e64 756d 6d79 2e70 6f72 7461  .mau.dummy.porta
+00000c80: 6c5f 6372 6561 7465 6422 2c20 4576 656e  l_created", Even
+00000c90: 7454 7970 652e 436c 6173 732e 4d45 5353  tType.Class.MESS
+00000ca0: 4147 4529 0a48 6973 746f 7279 5379 6e63  AGE).HistorySync
+00000cb0: 4d61 726b 6572 4d65 7373 6167 6520 3d20  MarkerMessage = 
+00000cc0: 4576 656e 7454 7970 652e 6669 6e64 2822  EventType.find("
+00000cd0: 6f72 672e 6d61 7472 6978 2e6d 7363 3237  org.matrix.msc27
+00000ce0: 3136 2e6d 6172 6b65 7222 2c20 4576 656e  16.marker", Even
+00000cf0: 7454 7970 652e 436c 6173 732e 4d45 5353  tType.Class.MESS
+00000d00: 4147 4529 0a0a 436f 6e76 6572 7465 644d  AGE)..ConvertedM
+00000d10: 6573 7361 6765 203d 2054 7570 6c65 5b45  essage = Tuple[E
+00000d20: 7665 6e74 5479 7065 2c20 4d65 7373 6167  ventType, Messag
+00000d30: 6545 7665 6e74 436f 6e74 656e 745d 0a0a  eEventContent]..
+00000d40: 0a63 6c61 7373 2050 6f72 7461 6c28 4442  .class Portal(DB
+00000d50: 506f 7274 616c 2c20 4261 7365 506f 7274  Portal, BasePort
+00000d60: 616c 293a 0a20 2020 2069 6e76 6974 655f  al):.    invite_
+00000d70: 6f77 6e5f 7075 7070 6574 5f74 6f5f 706d  own_puppet_to_pm
+00000d80: 3a20 626f 6f6c 203d 2046 616c 7365 0a20  : bool = False. 
+00000d90: 2020 2062 795f 6d78 6964 3a20 6469 6374     by_mxid: dict
+00000da0: 5b52 6f6f 6d49 442c 2050 6f72 7461 6c5d  [RoomID, Portal]
+00000db0: 203d 207b 7d0a 2020 2020 6279 5f66 6269   = {}.    by_fbi
+00000dc0: 643a 2064 6963 745b 7475 706c 655b 696e  d: dict[tuple[in
+00000dd0: 742c 2069 6e74 5d2c 2050 6f72 7461 6c5d  t, int], Portal]
+00000de0: 203d 207b 7d0a 2020 2020 6d61 7472 6978   = {}.    matrix
+00000df0: 3a20 6d2e 4d61 7472 6978 4861 6e64 6c65  : m.MatrixHandle
+00000e00: 720a 2020 2020 636f 6e66 6967 3a20 436f  r.    config: Co
+00000e10: 6e66 6967 0a20 2020 2070 7269 7661 7465  nfig.    private
+00000e20: 5f63 6861 745f 706f 7274 616c 5f6d 6574  _chat_portal_met
+00000e30: 613a 204c 6974 6572 616c 5b22 6465 6661  a: Literal["defa
+00000e40: 756c 7422 2c20 2261 6c77 6179 7322 2c20  ult", "always", 
+00000e50: 226e 6576 6572 225d 0a20 2020 2064 6973  "never"].    dis
+00000e60: 6162 6c65 5f72 6570 6c79 5f66 616c 6c62  able_reply_fallb
+00000e70: 6163 6b73 3a20 626f 6f6c 0a0a 2020 2020  acks: bool..    
+00000e80: 5f6d 6169 6e5f 696e 7465 6e74 3a20 496e  _main_intent: In
+00000e90: 7465 6e74 4150 4920 7c20 4e6f 6e65 0a20  tentAPI | None. 
+00000ea0: 2020 205f 6372 6561 7465 5f72 6f6f 6d5f     _create_room_
+00000eb0: 6c6f 636b 3a20 6173 796e 6369 6f2e 4c6f  lock: asyncio.Lo
+00000ec0: 636b 0a20 2020 205f 6465 6475 703a 2064  ck.    _dedup: d
+00000ed0: 6571 7565 5b73 7472 5d0a 2020 2020 5f6f  eque[str].    _o
+00000ee0: 7469 5f64 6564 7570 3a20 6469 6374 5b69  ti_dedup: dict[i
+00000ef0: 6e74 2c20 4442 4d65 7373 6167 655d 0a20  nt, DBMessage]. 
+00000f00: 2020 205f 7365 6e64 5f6c 6f63 6b73 3a20     _send_locks: 
+00000f10: 6469 6374 5b69 6e74 2c20 6173 796e 6369  dict[int, asynci
+00000f20: 6f2e 4c6f 636b 5d0a 2020 2020 5f6e 6f6f  o.Lock].    _noo
+00000f30: 705f 6c6f 636b 3a20 4661 6b65 4c6f 636b  p_lock: FakeLock
+00000f40: 203d 2046 616b 654c 6f63 6b28 290a 2020   = FakeLock().  
+00000f50: 2020 5f74 7970 696e 673a 2073 6574 5b55    _typing: set[U
+00000f60: 7365 7249 445d 0a20 2020 205f 736c 6565  serID].    _slee
+00000f70: 7069 6e67 5f74 6f5f 7265 7379 6e63 3a20  ping_to_resync: 
+00000f80: 626f 6f6c 0a20 2020 205f 7363 6865 6475  bool.    _schedu
+00000f90: 6c65 645f 7265 7379 6e63 3a20 6173 796e  led_resync: asyn
+00000fa0: 6369 6f2e 5461 736b 207c 204e 6f6e 650a  cio.Task | None.
+00000fb0: 2020 2020 5f72 6573 796e 635f 7461 7267      _resync_targ
+00000fc0: 6574 733a 2064 6963 745b 696e 742c 2070  ets: dict[int, p
+00000fd0: 2e50 7570 7065 745d 0a0a 2020 2020 6465  .Puppet]..    de
+00000fe0: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
+00000ff0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00001000: 2020 6662 6964 3a20 696e 742c 0a20 2020    fbid: int,.   
+00001010: 2020 2020 2066 625f 7265 6365 6976 6572       fb_receiver
+00001020: 3a20 696e 742c 0a20 2020 2020 2020 2066  : int,.        f
+00001030: 625f 7479 7065 3a20 5468 7265 6164 5479  b_type: ThreadTy
+00001040: 7065 2c0a 2020 2020 2020 2020 6d78 6964  pe,.        mxid
+00001050: 3a20 526f 6f6d 4944 207c 204e 6f6e 6520  : RoomID | None 
+00001060: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00001070: 6e61 6d65 3a20 7374 7220 7c20 4e6f 6e65  name: str | None
+00001080: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00001090: 2070 686f 746f 5f69 643a 2073 7472 207c   photo_id: str |
+000010a0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000010b0: 2020 2020 2020 6176 6174 6172 5f75 726c        avatar_url
+000010c0: 3a20 436f 6e74 656e 7455 5249 207c 204e  : ContentURI | N
+000010d0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+000010e0: 2020 2020 656e 6372 7970 7465 643a 2062      encrypted: b
+000010f0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00001100: 2020 2020 206e 616d 655f 7365 743a 2062       name_set: b
+00001110: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00001120: 2020 2020 2061 7661 7461 725f 7365 743a       avatar_set:
+00001130: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00001140: 2020 2020 2020 2072 656c 6179 5f75 7365         relay_use
+00001150: 725f 6964 3a20 5573 6572 4944 207c 204e  r_id: UserID | N
+00001160: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00001170: 2020 2020 6669 7273 745f 6576 656e 745f      first_event_
+00001180: 6964 3a20 4576 656e 7449 4420 7c20 4e6f  id: EventID | No
+00001190: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+000011a0: 2020 206e 6578 745f 6261 7463 685f 6964     next_batch_id
+000011b0: 3a20 4261 7463 6849 4420 7c20 4e6f 6e65  : BatchID | None
+000011c0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+000011d0: 2068 6973 746f 7269 6361 6c5f 6261 7365   historical_base
+000011e0: 5f69 6e73 6572 7469 6f6e 5f65 7665 6e74  _insertion_event
+000011f0: 5f69 643a 2045 7665 6e74 4944 207c 204e  _id: EventID | N
+00001200: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00001210: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00001220: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00001230: 745f 5f28 0a20 2020 2020 2020 2020 2020  t__(.           
+00001240: 2066 6269 642c 0a20 2020 2020 2020 2020   fbid,.         
+00001250: 2020 2066 625f 7265 6365 6976 6572 2c0a     fb_receiver,.
+00001260: 2020 2020 2020 2020 2020 2020 6662 5f74              fb_t
+00001270: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+00001280: 206d 7869 642c 0a20 2020 2020 2020 2020   mxid,.         
+00001290: 2020 206e 616d 652c 0a20 2020 2020 2020     name,.       
+000012a0: 2020 2020 2070 686f 746f 5f69 642c 0a20       photo_id,. 
+000012b0: 2020 2020 2020 2020 2020 2061 7661 7461             avata
+000012c0: 725f 7572 6c2c 0a20 2020 2020 2020 2020  r_url,.         
+000012d0: 2020 2065 6e63 7279 7074 6564 2c0a 2020     encrypted,.  
+000012e0: 2020 2020 2020 2020 2020 6e61 6d65 5f73            name_s
+000012f0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00001300: 6176 6174 6172 5f73 6574 2c0a 2020 2020  avatar_set,.    
+00001310: 2020 2020 2020 2020 7265 6c61 795f 7573          relay_us
+00001320: 6572 5f69 642c 0a20 2020 2020 2020 2020  er_id,.         
+00001330: 2020 2066 6972 7374 5f65 7665 6e74 5f69     first_event_i
+00001340: 642c 0a20 2020 2020 2020 2020 2020 206e  d,.            n
+00001350: 6578 745f 6261 7463 685f 6964 2c0a 2020  ext_batch_id,.  
+00001360: 2020 2020 2020 2020 2020 6869 7374 6f72            histor
+00001370: 6963 616c 5f62 6173 655f 696e 7365 7274  ical_base_insert
+00001380: 696f 6e5f 6576 656e 745f 6964 2c0a 2020  ion_event_id,.  
+00001390: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000013a0: 7365 6c66 2e6c 6f67 203d 2073 656c 662e  self.log = self.
+000013b0: 6c6f 672e 6765 7443 6869 6c64 2873 656c  log.getChild(sel
+000013c0: 662e 6662 6964 5f6c 6f67 290a 0a20 2020  f.fbid_log)..   
+000013d0: 2020 2020 2073 656c 662e 5f6d 6169 6e5f       self._main_
+000013e0: 696e 7465 6e74 203d 204e 6f6e 650a 2020  intent = None.  
+000013f0: 2020 2020 2020 7365 6c66 2e5f 6372 6561        self._crea
+00001400: 7465 5f72 6f6f 6d5f 6c6f 636b 203d 2061  te_room_lock = a
+00001410: 7379 6e63 696f 2e4c 6f63 6b28 290a 2020  syncio.Lock().  
+00001420: 2020 2020 2020 7365 6c66 2e5f 6465 6475        self._dedu
+00001430: 7020 3d20 6465 7175 6528 6d61 786c 656e  p = deque(maxlen
+00001440: 3d31 3030 290a 2020 2020 2020 2020 7365  =100).        se
+00001450: 6c66 2e5f 6f74 695f 6465 6475 7020 3d20  lf._oti_dedup = 
+00001460: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00001470: 5f73 656e 645f 6c6f 636b 7320 3d20 7b7d  _send_locks = {}
+00001480: 0a20 2020 2020 2020 2073 656c 662e 5f74  .        self._t
+00001490: 7970 696e 6720 3d20 7365 7428 290a 2020  yping = set().  
+000014a0: 2020 2020 2020 7365 6c66 2e5f 736c 6565        self._slee
+000014b0: 7069 6e67 5f74 6f5f 7265 7379 6e63 203d  ping_to_resync =
+000014c0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+000014d0: 656c 662e 5f73 6368 6564 756c 6564 5f72  elf._scheduled_r
+000014e0: 6573 796e 6320 3d20 4e6f 6e65 0a20 2020  esync = None.   
+000014f0: 2020 2020 2073 656c 662e 5f72 6573 796e       self._resyn
+00001500: 635f 7461 7267 6574 7320 3d20 7b7d 0a20  c_targets = {}. 
+00001510: 2020 2020 2020 2073 656c 662e 5f72 656c         self._rel
+00001520: 6179 5f75 7365 7220 3d20 4e6f 6e65 0a0a  ay_user = None..
+00001530: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00001540: 0a20 2020 2064 6566 2069 6e69 745f 636c  .    def init_cl
+00001550: 7328 636c 732c 2062 7269 6467 653a 2022  s(cls, bridge: "
+00001560: 4d65 7373 656e 6765 7242 7269 6467 6522  MessengerBridge"
+00001570: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00001580: 2020 2042 6173 6550 6f72 7461 6c2e 6272     BasePortal.br
+00001590: 6964 6765 203d 2062 7269 6467 650a 2020  idge = bridge.  
+000015a0: 2020 2020 2020 636c 732e 617a 203d 2062        cls.az = b
+000015b0: 7269 6467 652e 617a 0a20 2020 2020 2020  ridge.az.       
+000015c0: 2063 6c73 2e63 6f6e 6669 6720 3d20 6272   cls.config = br
+000015d0: 6964 6765 2e63 6f6e 6669 670a 2020 2020  idge.config.    
+000015e0: 2020 2020 636c 732e 6c6f 6f70 203d 2062      cls.loop = b
+000015f0: 7269 6467 652e 6c6f 6f70 0a20 2020 2020  ridge.loop.     
+00001600: 2020 2063 6c73 2e6d 6174 7269 7820 3d20     cls.matrix = 
+00001610: 6272 6964 6765 2e6d 6174 7269 780a 2020  bridge.matrix.  
+00001620: 2020 2020 2020 636c 732e 696e 7669 7465        cls.invite
+00001630: 5f6f 776e 5f70 7570 7065 745f 746f 5f70  _own_puppet_to_p
+00001640: 6d20 3d20 636c 732e 636f 6e66 6967 5b22  m = cls.config["
+00001650: 6272 6964 6765 2e69 6e76 6974 655f 6f77  bridge.invite_ow
+00001660: 6e5f 7075 7070 6574 5f74 6f5f 706d 225d  n_puppet_to_pm"]
+00001670: 0a20 2020 2020 2020 2063 6c73 2e70 7269  .        cls.pri
+00001680: 7661 7465 5f63 6861 745f 706f 7274 616c  vate_chat_portal
+00001690: 5f6d 6574 6120 3d20 636c 732e 636f 6e66  _meta = cls.conf
+000016a0: 6967 5b22 6272 6964 6765 2e70 7269 7661  ig["bridge.priva
+000016b0: 7465 5f63 6861 745f 706f 7274 616c 5f6d  te_chat_portal_m
+000016c0: 6574 6122 5d0a 2020 2020 2020 2020 636c  eta"].        cl
+000016d0: 732e 6469 7361 626c 655f 7265 706c 795f  s.disable_reply_
+000016e0: 6661 6c6c 6261 636b 7320 3d20 636c 732e  fallbacks = cls.
+000016f0: 636f 6e66 6967 5b22 6272 6964 6765 2e64  config["bridge.d
+00001700: 6973 6162 6c65 5f72 6570 6c79 5f66 616c  isable_reply_fal
+00001710: 6c62 6163 6b73 225d 0a0a 2020 2020 2320  lbacks"]..    # 
+00001720: 7265 6769 6f6e 2044 4220 636f 6e76 6572  region DB conver
+00001730: 7369 6f6e 0a0a 2020 2020 6173 796e 6320  sion..    async 
+00001740: 6465 6620 6465 6c65 7465 2873 656c 6629  def delete(self)
+00001750: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00001760: 2020 6966 2073 656c 662e 6d78 6964 3a0a    if self.mxid:.
+00001770: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00001780: 7420 4442 4d65 7373 6167 652e 6465 6c65  t DBMessage.dele
+00001790: 7465 5f61 6c6c 5f62 795f 726f 6f6d 2873  te_all_by_room(s
+000017a0: 656c 662e 6d78 6964 290a 2020 2020 2020  elf.mxid).      
+000017b0: 2020 2020 2020 6177 6169 7420 4442 5265        await DBRe
+000017c0: 6163 7469 6f6e 2e64 656c 6574 655f 616c  action.delete_al
+000017d0: 6c5f 6279 5f72 6f6f 6d28 7365 6c66 2e6d  l_by_room(self.m
+000017e0: 7869 6429 0a20 2020 2020 2020 2020 2020  xid).           
+000017f0: 2073 656c 662e 6279 5f6d 7869 642e 706f   self.by_mxid.po
+00001800: 7028 7365 6c66 2e6d 7869 642c 204e 6f6e  p(self.mxid, Non
+00001810: 6529 0a20 2020 2020 2020 2061 7761 6974  e).        await
+00001820: 2042 6163 6b66 696c 6c2e 6465 6c65 7465   Backfill.delete
+00001830: 5f66 6f72 5f70 6f72 7461 6c28 7365 6c66  _for_portal(self
+00001840: 2e66 6269 642c 2073 656c 662e 6662 5f72  .fbid, self.fb_r
+00001850: 6563 6569 7665 7229 0a20 2020 2020 2020  eceiver).       
+00001860: 2073 656c 662e 6279 5f66 6269 642e 706f   self.by_fbid.po
+00001870: 7028 7365 6c66 2e66 6269 645f 6675 6c6c  p(self.fbid_full
+00001880: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+00001890: 7365 6c66 2e6d 7869 6420 3d20 4e6f 6e65  self.mxid = None
+000018a0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
+000018b0: 6d65 5f73 6574 203d 2046 616c 7365 0a20  me_set = False. 
+000018c0: 2020 2020 2020 2073 656c 662e 6176 6174         self.avat
+000018d0: 6172 5f73 6574 203d 2046 616c 7365 0a20  ar_set = False. 
+000018e0: 2020 2020 2020 2073 656c 662e 7265 6c61         self.rela
+000018f0: 795f 7573 6572 5f69 6420 3d20 4e6f 6e65  y_user_id = None
+00001900: 0a20 2020 2020 2020 2073 656c 662e 656e  .        self.en
+00001910: 6372 7970 7465 6420 3d20 4661 6c73 650a  crypted = False.
+00001920: 2020 2020 2020 2020 7365 6c66 2e66 6972          self.fir
+00001930: 7374 5f65 7665 6e74 5f69 6420 3d20 4e6f  st_event_id = No
+00001940: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00001950: 6e65 7874 5f62 6174 6368 5f69 6420 3d20  next_batch_id = 
+00001960: 4e6f 6e65 0a20 2020 2020 2020 2061 7761  None.        awa
+00001970: 6974 2073 7570 6572 2829 2e73 6176 6528  it super().save(
+00001980: 290a 0a20 2020 2023 2065 6e64 7265 6769  )..    # endregi
+00001990: 6f6e 0a20 2020 2023 2072 6567 696f 6e20  on.    # region 
+000019a0: 5072 6f70 6572 7469 6573 0a0a 2020 2020  Properties..    
+000019b0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+000019c0: 6620 6662 6964 5f66 756c 6c28 7365 6c66  f fbid_full(self
+000019d0: 2920 2d3e 2074 7570 6c65 5b69 6e74 2c20  ) -> tuple[int, 
+000019e0: 696e 745d 3a0a 2020 2020 2020 2020 7265  int]:.        re
+000019f0: 7475 726e 2073 656c 662e 6662 6964 2c20  turn self.fbid, 
+00001a00: 7365 6c66 2e66 625f 7265 6365 6976 6572  self.fb_receiver
+00001a10: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00001a20: 2020 2020 6465 6620 6662 6964 5f6c 6f67      def fbid_log
+00001a30: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+00001a40: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00001a50: 735f 6469 7265 6374 3a0a 2020 2020 2020  s_direct:.      
+00001a60: 2020 2020 2020 7265 7475 726e 2066 227b        return f"{
+00001a70: 7365 6c66 2e66 6269 647d 3c2d 3e7b 7365  self.fbid}<->{se
+00001a80: 6c66 2e66 625f 7265 6365 6976 6572 7d22  lf.fb_receiver}"
+00001a90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001aa0: 7374 7228 7365 6c66 2e66 6269 6429 0a0a  str(self.fbid)..
 00001ab0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00001ac0: 2020 6465 6620 6973 5f64 6972 6563 7428    def is_direct(
-00001ad0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
-00001ae0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00001af0: 6c66 2e66 625f 7479 7065 203d 3d20 5468  lf.fb_type == Th
-00001b00: 7265 6164 5479 7065 2e55 5345 520a 0a20  readType.USER.. 
-00001b10: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00001b20: 2064 6566 206d 6169 6e5f 696e 7465 6e74   def main_intent
-00001b30: 2873 656c 6629 202d 3e20 496e 7465 6e74  (self) -> Intent
-00001b40: 4150 493a 0a20 2020 2020 2020 2069 6620  API:.        if 
-00001b50: 6e6f 7420 7365 6c66 2e5f 6d61 696e 5f69  not self._main_i
-00001b60: 6e74 656e 743a 0a20 2020 2020 2020 2020  ntent:.         
-00001b70: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00001b80: 726f 7228 2250 6f72 7461 6c20 6d75 7374  ror("Portal must
-00001b90: 2062 6520 706f 7374 696e 6974 2829 6564   be postinit()ed
-00001ba0: 2062 6566 6f72 6520 6d61 696e 5f69 6e74   before main_int
-00001bb0: 656e 7420 6361 6e20 6265 2075 7365 6422  ent can be used"
-00001bc0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00001bd0: 2073 656c 662e 5f6d 6169 6e5f 696e 7465   self._main_inte
-00001be0: 6e74 0a0a 2020 2020 6173 796e 6320 6465  nt..    async de
-00001bf0: 6620 6765 745f 646d 5f70 7570 7065 7428  f get_dm_puppet(
-00001c00: 7365 6c66 2920 2d3e 2070 2e50 7570 7065  self) -> p.Puppe
-00001c10: 7420 7c20 4e6f 6e65 3a0a 2020 2020 2020  t | None:.      
-00001c20: 2020 6966 206e 6f74 2073 656c 662e 6973    if not self.is
-00001c30: 5f64 6972 6563 743a 0a20 2020 2020 2020  _direct:.       
-00001c40: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00001c50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00001c60: 6177 6169 7420 702e 5075 7070 6574 2e67  await p.Puppet.g
-00001c70: 6574 5f62 795f 6662 6964 2873 656c 662e  et_by_fbid(self.
-00001c80: 6662 6964 290a 0a20 2020 2023 2065 6e64  fbid)..    # end
-00001c90: 7265 6769 6f6e 0a20 2020 2023 2072 6567  region.    # reg
-00001ca0: 696f 6e20 4368 6174 2069 6e66 6f20 7570  ion Chat info up
-00001cb0: 6461 7469 6e67 0a0a 2020 2020 6465 6620  dating..    def 
-00001cc0: 7363 6865 6475 6c65 5f72 6573 796e 6328  schedule_resync(
-00001cd0: 7365 6c66 2c20 736f 7572 6365 3a20 752e  self, source: u.
-00001ce0: 5573 6572 2c20 7461 7267 6574 3a20 702e  User, target: p.
-00001cf0: 5075 7070 6574 2920 2d3e 204e 6f6e 653a  Puppet) -> None:
-00001d00: 0a20 2020 2020 2020 2073 656c 662e 5f72  .        self._r
-00001d10: 6573 796e 635f 7461 7267 6574 735b 7461  esync_targets[ta
-00001d20: 7267 6574 2e66 6269 645d 203d 2074 6172  rget.fbid] = tar
-00001d30: 6765 740a 2020 2020 2020 2020 6966 2028  get.        if (
-00001d40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001d50: 662e 5f73 6c65 6570 696e 675f 746f 5f72  f._sleeping_to_r
-00001d60: 6573 796e 630a 2020 2020 2020 2020 2020  esync.          
-00001d70: 2020 616e 6420 7365 6c66 2e5f 7363 6865    and self._sche
-00001d80: 6475 6c65 645f 7265 7379 6e63 0a20 2020  duled_resync.   
-00001d90: 2020 2020 2020 2020 2061 6e64 206e 6f74           and not
-00001da0: 2073 656c 662e 5f73 6368 6564 756c 6564   self._scheduled
-00001db0: 5f72 6573 796e 632e 646f 6e65 2829 0a20  _resync.done(). 
-00001dc0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00001dd0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00001de0: 2020 2020 2073 656c 662e 5f73 6c65 6570       self._sleep
-00001df0: 696e 675f 746f 5f72 6573 796e 6320 3d20  ing_to_resync = 
-00001e00: 5472 7565 0a20 2020 2020 2020 2073 656c  True.        sel
-00001e10: 662e 6c6f 672e 6465 6275 6728 6622 5363  f.log.debug(f"Sc
-00001e20: 6865 6475 6c69 6e67 2072 6573 796e 6320  heduling resync 
-00001e30: 7468 726f 7567 6820 7b73 6f75 7263 652e  through {source.
-00001e40: 6d78 6964 7d2f 7b73 6f75 7263 652e 6662  mxid}/{source.fb
-00001e50: 6964 7d22 290a 2020 2020 2020 2020 7365  id}").        se
-00001e60: 6c66 2e5f 7363 6865 6475 6c65 645f 7265  lf._scheduled_re
-00001e70: 7379 6e63 203d 2061 7379 6e63 696f 2e63  sync = asyncio.c
-00001e80: 7265 6174 655f 7461 736b 2873 656c 662e  reate_task(self.
-00001e90: 5f73 6c65 6570 5f61 6e64 5f72 6573 796e  _sleep_and_resyn
-00001ea0: 6328 736f 7572 6365 2c20 3130 2929 0a0a  c(source, 10))..
-00001eb0: 2020 2020 6173 796e 6320 6465 6620 5f73      async def _s
-00001ec0: 6c65 6570 5f61 6e64 5f72 6573 796e 6328  leep_and_resync(
-00001ed0: 7365 6c66 2c20 736f 7572 6365 3a20 752e  self, source: u.
-00001ee0: 5573 6572 2c20 736c 6565 703a 2069 6e74  User, sleep: int
-00001ef0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00001f00: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-00001f10: 2e73 6c65 6570 2873 6c65 6570 290a 2020  .sleep(sleep).  
-00001f20: 2020 2020 2020 7461 7267 6574 7320 3d20        targets = 
-00001f30: 7365 6c66 2e5f 7265 7379 6e63 5f74 6172  self._resync_tar
-00001f40: 6765 7473 0a20 2020 2020 2020 2073 656c  gets.        sel
-00001f50: 662e 5f73 6c65 6570 696e 675f 746f 5f72  f._sleeping_to_r
-00001f60: 6573 796e 6320 3d20 4661 6c73 650a 2020  esync = False.  
-00001f70: 2020 2020 2020 7365 6c66 2e5f 7265 7379        self._resy
-00001f80: 6e63 5f74 6172 6765 7473 203d 207b 7d0a  nc_targets = {}.
-00001f90: 2020 2020 2020 2020 666f 7220 7075 7070          for pupp
-00001fa0: 6574 2069 6e20 7461 7267 6574 732e 7661  et in targets.va
-00001fb0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00001fc0: 2020 2020 6966 206e 6f74 2070 7570 7065      if not puppe
-00001fd0: 742e 6e61 6d65 206f 7220 6e6f 7420 7075  t.name or not pu
-00001fe0: 7070 6574 2e6e 616d 655f 7365 743a 0a20  ppet.name_set:. 
-00001ff0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00002000: 7265 616b 0a20 2020 2020 2020 2065 6c73  reak.        els
-00002010: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00002020: 656c 662e 6c6f 672e 6465 6275 6728 0a20  elf.log.debug(. 
-00002030: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00002040: 2243 616e 6365 6c6c 6564 2072 6573 796e  "Cancelled resyn
-00002050: 6320 7468 726f 7567 6820 7b73 6f75 7263  c through {sourc
-00002060: 652e 6d78 6964 7d2f 7b73 6f75 7263 652e  e.mxid}/{source.
-00002070: 6662 6964 7d2c 2061 6c6c 2070 7570 7065  fbid}, all puppe
-00002080: 7473 2068 6176 6520 6e61 6d65 7322 0a20  ts have names". 
-00002090: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000020a0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000020b0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000020c0: 2e64 6562 7567 2866 2252 6573 796e 6369  .debug(f"Resynci
-000020d0: 6e67 2063 6861 7420 7468 726f 7567 6820  ng chat through 
-000020e0: 7b73 6f75 7263 652e 6d78 6964 7d2f 7b73  {source.mxid}/{s
-000020f0: 6f75 7263 652e 6662 6964 7d20 6166 7465  ource.fbid} afte
-00002100: 7220 736c 6565 7069 6e67 2229 0a20 2020  r sleeping").   
-00002110: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-00002120: 7570 6461 7465 5f69 6e66 6f28 736f 7572  update_info(sour
-00002130: 6365 290a 2020 2020 2020 2020 7365 6c66  ce).        self
-00002140: 2e5f 7363 6865 6475 6c65 645f 7265 7379  ._scheduled_resy
-00002150: 6e63 203d 204e 6f6e 650a 2020 2020 2020  nc = None.      
-00002160: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
-00002170: 2866 2243 6f6d 706c 6574 6564 2073 6368  (f"Completed sch
-00002180: 6564 756c 6564 2072 6573 796e 6320 7468  eduled resync th
-00002190: 726f 7567 6820 7b73 6f75 7263 652e 6d78  rough {source.mx
-000021a0: 6964 7d2f 7b73 6f75 7263 652e 6662 6964  id}/{source.fbid
-000021b0: 7d22 290a 0a20 2020 2061 7379 6e63 2064  }")..    async d
-000021c0: 6566 2075 7064 6174 655f 696e 666f 280a  ef update_info(.
-000021d0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000021e0: 2020 2020 2020 736f 7572 6365 3a20 752e        source: u.
-000021f0: 5573 6572 207c 204e 6f6e 6520 3d20 4e6f  User | None = No
-00002200: 6e65 2c0a 2020 2020 2020 2020 696e 666f  ne,.        info
-00002210: 3a20 6772 6170 6871 6c2e 5468 7265 6164  : graphql.Thread
-00002220: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00002230: 2020 2020 2020 2020 666f 7263 655f 7361          force_sa
-00002240: 7665 3a20 626f 6f6c 203d 2046 616c 7365  ve: bool = False
-00002250: 2c0a 2020 2020 2920 2d3e 2067 7261 7068  ,.    ) -> graph
-00002260: 716c 2e54 6872 6561 6420 7c20 4e6f 6e65  ql.Thread | None
-00002270: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00002280: 2069 6e66 6f3a 0a20 2020 2020 2020 2020   info:.         
-00002290: 2020 2073 656c 662e 6c6f 672e 6465 6275     self.log.debu
-000022a0: 6728 2243 616c 6c65 6420 7570 6461 7465  g("Called update
-000022b0: 5f69 6e66 6f20 7769 7468 206e 6f20 696e  _info with no in
-000022c0: 666f 2c20 6665 7463 6869 6e67 2074 6872  fo, fetching thr
-000022d0: 6561 6420 696e 666f 2e2e 2e22 290a 2020  ead info...").  
-000022e0: 2020 2020 2020 2020 2020 7468 7265 6164            thread
-000022f0: 7320 3d20 6177 6169 7420 736f 7572 6365  s = await source
-00002300: 2e63 6c69 656e 742e 6665 7463 685f 7468  .client.fetch_th
-00002310: 7265 6164 5f69 6e66 6f28 7365 6c66 2e66  read_info(self.f
-00002320: 6269 6429 0a20 2020 2020 2020 2020 2020  bid).           
-00002330: 2069 6620 6e6f 7420 7468 7265 6164 733a   if not threads:
-00002340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002350: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00002360: 2020 2020 2020 2020 2065 6c69 6620 7468           elif th
-00002370: 7265 6164 735b 305d 2e74 6872 6561 645f  reads[0].thread_
-00002380: 6b65 792e 6964 2021 3d20 7365 6c66 2e66  key.id != self.f
-00002390: 6269 643a 0a20 2020 2020 2020 2020 2020  bid:.           
-000023a0: 2020 2020 2073 656c 662e 6c6f 672e 7761       self.log.wa
-000023b0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-000023c0: 2020 2020 2020 2020 2020 2022 6665 7463             "fetc
-000023d0: 685f 7468 7265 6164 5f69 6e66 6f20 7265  h_thread_info re
-000023e0: 7370 6f6e 7365 2063 6f6e 7461 696e 6564  sponse contained
-000023f0: 2064 6966 6665 7265 6e74 2049 4420 2825   different ID (%
-00002400: 7329 2074 6861 6e20 6578 7065 6374 6564  s) than expected
-00002410: 2028 2573 2922 2c0a 2020 2020 2020 2020   (%s)",.        
-00002420: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-00002430: 6164 735b 305d 2e74 6872 6561 645f 6b65  ads[0].thread_ke
-00002440: 792e 6964 2c0a 2020 2020 2020 2020 2020  y.id,.          
-00002450: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00002460: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
-00002470: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00002480: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-00002490: 6465 6275 6728 6622 4e75 6d62 6572 206f  debug(f"Number o
-000024a0: 6620 7468 7265 6164 7320 696e 2075 6e65  f threads in une
-000024b0: 7870 6563 7465 6420 7265 7370 6f6e 7365  xpected response
-000024c0: 3a20 7b6c 656e 2874 6872 6561 6473 297d  : {len(threads)}
-000024d0: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-000024e0: 6e66 6f20 3d20 7468 7265 6164 735b 305d  nfo = threads[0]
-000024f0: 0a20 2020 2020 2020 2069 6620 696e 666f  .        if info
-00002500: 2e74 6872 6561 645f 6b65 7920 213d 2073  .thread_key != s
-00002510: 656c 662e 6772 6170 6871 6c5f 6b65 793a  elf.graphql_key:
-00002520: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00002530: 662e 6c6f 672e 7761 726e 696e 6728 0a20  f.log.warning(. 
-00002540: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00002550: 476f 7420 6469 6666 6572 656e 7420 4944  Got different ID
-00002560: 2028 2573 2920 7468 616e 2077 6861 7420   (%s) than what 
-00002570: 6173 6b65 6420 666f 7220 2825 7329 2077  asked for (%s) w
-00002580: 6865 6e20 6665 7463 6869 6e67 2069 6e66  hen fetching inf
-00002590: 6f22 2c0a 2020 2020 2020 2020 2020 2020  o",.            
-000025a0: 2020 2020 696e 666f 2e74 6872 6561 645f      info.thread_
-000025b0: 6b65 792e 6964 2c0a 2020 2020 2020 2020  key.id,.        
-000025c0: 2020 2020 2020 2020 7365 6c66 2e66 6269          self.fbi
-000025d0: 642c 0a20 2020 2020 2020 2020 2020 2029  d,.            )
-000025e0: 0a20 2020 2020 2020 2063 6861 6e67 6564  .        changed
-000025f0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00002600: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
-00002610: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
-00002620: 2020 2020 6368 616e 6765 6420 3d20 616e      changed = an
-00002630: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-00002640: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-00002650: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
-00002660: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00002670: 662e 5f75 7064 6174 655f 6e61 6d65 2869  f._update_name(i
-00002680: 6e66 6f2e 6e61 6d65 292c 0a20 2020 2020  nfo.name),.     
-00002690: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000026a0: 656c 662e 5f75 7064 6174 655f 7068 6f74  elf._update_phot
-000026b0: 6f28 736f 7572 6365 2c20 696e 666f 2e69  o(source, info.i
-000026c0: 6d61 6765 292c 0a20 2020 2020 2020 2020  mage),.         
-000026d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000026e0: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
-000026f0: 6861 6e67 6564 203d 2061 7761 6974 2073  hanged = await s
-00002700: 656c 662e 5f75 7064 6174 655f 7061 7274  elf._update_part
-00002710: 6963 6970 616e 7473 2873 6f75 7263 652c  icipants(source,
-00002720: 2069 6e66 6f29 206f 7220 6368 616e 6765   info) or change
-00002730: 640a 2020 2020 2020 2020 6966 2063 6861  d.        if cha
-00002740: 6e67 6564 206f 7220 666f 7263 655f 7361  nged or force_sa
-00002750: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00002760: 6177 6169 7420 7365 6c66 2e75 7064 6174  await self.updat
-00002770: 655f 6272 6964 6765 5f69 6e66 6f28 290a  e_bridge_info().
-00002780: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00002790: 7420 7365 6c66 2e73 6176 6528 290a 2020  t self.save().  
-000027a0: 2020 2020 2020 7265 7475 726e 2069 6e66        return inf
-000027b0: 6f0a 0a20 2020 2040 7374 6174 6963 6d65  o..    @staticme
-000027c0: 7468 6f64 0a20 2020 2064 6566 2067 6574  thod.    def get
-000027d0: 5f70 686f 746f 5f69 6428 7068 6f74 6f3a  _photo_id(photo:
-000027e0: 2067 7261 7068 716c 2e50 6963 7475 7265   graphql.Picture
-000027f0: 207c 2073 7472 207c 204e 6f6e 6529 202d   | str | None) -
-00002800: 3e20 7374 7220 7c20 4e6f 6e65 3a0a 2020  > str | None:.  
-00002810: 2020 2020 2020 6966 206e 6f74 2070 686f        if not pho
-00002820: 746f 3a0a 2020 2020 2020 2020 2020 2020  to:.            
-00002830: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-00002840: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00002850: 6e63 6528 7068 6f74 6f2c 2067 7261 7068  nce(photo, graph
-00002860: 716c 2e50 6963 7475 7265 293a 0a20 2020  ql.Picture):.   
-00002870: 2020 2020 2020 2020 2070 686f 746f 203d           photo =
-00002880: 2070 686f 746f 2e75 7269 0a20 2020 2020   photo.uri.     
-00002890: 2020 2070 6174 6820 3d20 5552 4c28 7068     path = URL(ph
-000028a0: 6f74 6f29 2e70 6174 680a 2020 2020 2020  oto).path.      
-000028b0: 2020 7265 7475 726e 2070 6174 685b 7061    return path[pa
-000028c0: 7468 2e72 6669 6e64 2822 2f22 2920 2b20  th.rfind("/") + 
-000028d0: 3120 3a5d 0a0a 2020 2020 4063 6c61 7373  1 :]..    @class
-000028e0: 6d65 7468 6f64 0a20 2020 2061 7379 6e63  method.    async
-000028f0: 2064 6566 205f 7265 7570 6c6f 6164 5f66   def _reupload_f
-00002900: 625f 6669 6c65 280a 2020 2020 2020 2020  b_file(.        
-00002910: 636c 732c 0a20 2020 2020 2020 2075 726c  cls,.        url
-00002920: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-00002930: 6f75 7263 653a 2075 2e55 7365 722c 0a20  ource: u.User,. 
-00002940: 2020 2020 2020 2069 6e74 656e 743a 2049         intent: I
-00002950: 6e74 656e 7441 5049 2c0a 2020 2020 2020  ntentAPI,.      
-00002960: 2020 2a2c 0a20 2020 2020 2020 2066 696c    *,.        fil
-00002970: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
-00002980: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00002990: 2020 656e 6372 7970 743a 2062 6f6f 6c20    encrypt: bool 
-000029a0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000029b0: 2072 6566 6572 6572 3a20 7374 7220 3d20   referer: str = 
-000029c0: 226d 6573 7365 6e67 6572 5f74 6872 6561  "messenger_threa
-000029d0: 645f 7068 6f74 6f22 2c0a 2020 2020 2020  d_photo",.      
-000029e0: 2020 6669 6e64 5f73 697a 653a 2062 6f6f    find_size: boo
-000029f0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00002a00: 2020 2063 6f6e 7665 7274 5f61 7564 696f     convert_audio
-00002a10: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00002a20: 2020 2020 2920 2d3e 2074 7570 6c65 5b43      ) -> tuple[C
-00002a30: 6f6e 7465 6e74 5552 492c 2046 696c 6549  ontentURI, FileI
-00002a40: 6e66 6f20 7c20 5669 6465 6f49 6e66 6f20  nfo | VideoInfo 
-00002a50: 7c20 4175 6469 6f49 6e66 6f20 7c20 496d  | AudioInfo | Im
-00002a60: 6167 6549 6e66 6f2c 2045 6e63 7279 7074  ageInfo, Encrypt
-00002a70: 6564 4669 6c65 207c 204e 6f6e 655d 3a0a  edFile | None]:.
-00002a80: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
-00002a90: 726c 3a0a 2020 2020 2020 2020 2020 2020  rl:.            
-00002aa0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00002ab0: 2822 5552 4c20 6e6f 7420 7072 6f76 6964  ("URL not provid
-00002ac0: 6564 2229 0a20 2020 2020 2020 2068 6561  ed").        hea
-00002ad0: 6465 7273 203d 207b 2272 6566 6572 6572  ders = {"referer
-00002ae0: 223a 2066 2266 6261 7070 3a2f 2f7b 736f  ": f"fbapp://{so
-00002af0: 7572 6365 2e73 7461 7465 2e61 7070 6c69  urce.state.appli
-00002b00: 6361 7469 6f6e 2e63 6c69 656e 745f 6964  cation.client_id
-00002b10: 7d2f 7b72 6566 6572 6572 7d22 7d0a 2020  }/{referer}"}.  
-00002b20: 2020 2020 2020 7361 6e64 626f 7820 3d20        sandbox = 
-00002b30: 636c 732e 636f 6e66 6967 5b22 6272 6964  cls.config["brid
-00002b40: 6765 2e73 616e 6462 6f78 5f6d 6564 6961  ge.sandbox_media
-00002b50: 5f64 6f77 6e6c 6f61 6422 5d0a 2020 2020  _download"].    
-00002b60: 2020 2020 636c 732e 6c6f 672e 7472 6163      cls.log.trac
-00002b70: 6528 2252 6575 706c 6f61 6469 6e67 2066  e("Reuploading f
-00002b80: 696c 6520 2573 222c 2075 726c 290a 2020  ile %s", url).  
-00002b90: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-00002ba0: 2073 6f75 7263 652e 636c 6965 6e74 2e67   source.client.g
-00002bb0: 6574 2875 726c 2c20 6865 6164 6572 733d  et(url, headers=
-00002bc0: 6865 6164 6572 732c 2073 616e 6462 6f78  headers, sandbox
-00002bd0: 3d73 616e 6462 6f78 2920 6173 2072 6573  =sandbox) as res
-00002be0: 703a 0a20 2020 2020 2020 2020 2020 206c  p:.            l
-00002bf0: 656e 6774 6820 3d20 696e 7428 7265 7370  ength = int(resp
-00002c00: 2e68 6561 6465 7273 5b22 436f 6e74 656e  .headers["Conten
-00002c10: 742d 4c65 6e67 7468 225d 290a 2020 2020  t-Length"]).    
-00002c20: 2020 2020 2020 2020 6966 206c 656e 6774          if lengt
-00002c30: 6820 3e20 636c 732e 6d61 7472 6978 2e6d  h > cls.matrix.m
-00002c40: 6564 6961 5f63 6f6e 6669 672e 7570 6c6f  edia_config.uplo
-00002c50: 6164 5f73 697a 653a 0a20 2020 2020 2020  ad_size:.       
-00002c60: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00002c70: 616c 7565 4572 726f 7228 2246 696c 6520  alueError("File 
-00002c80: 6e6f 7420 6176 6169 6c61 626c 653a 2074  not available: t
-00002c90: 6f6f 206c 6172 6765 2229 0a20 2020 2020  oo large").     
-00002ca0: 2020 2020 2020 2064 6174 6120 3d20 6177         data = aw
-00002cb0: 6169 7420 7265 7370 2e72 6561 6428 290a  ait resp.read().
-00002cc0: 2020 2020 2020 2020 6d69 6d65 203d 206d          mime = m
-00002cd0: 6167 6963 2e6d 696d 6574 7970 6528 6461  agic.mimetype(da
-00002ce0: 7461 290a 2020 2020 2020 2020 6966 2063  ta).        if c
-00002cf0: 6f6e 7665 7274 5f61 7564 696f 2061 6e64  onvert_audio and
-00002d00: 206d 696d 6520 213d 2022 6175 6469 6f2f   mime != "audio/
-00002d10: 6f67 6722 3a0a 2020 2020 2020 2020 2020  ogg":.          
-00002d20: 2020 6461 7461 203d 2061 7761 6974 2066    data = await f
-00002d30: 666d 7065 672e 636f 6e76 6572 745f 6279  fmpeg.convert_by
-00002d40: 7465 7328 0a20 2020 2020 2020 2020 2020  tes(.           
-00002d50: 2020 2020 2064 6174 612c 2022 2e6f 6767       data, ".ogg
-00002d60: 222c 206f 7574 7075 745f 6172 6773 3d28  ", output_args=(
-00002d70: 222d 633a 6122 2c20 226c 6962 6f70 7573  "-c:a", "libopus
-00002d80: 2229 2c20 696e 7075 745f 6d69 6d65 3d6d  "), input_mime=m
-00002d90: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-00002da0: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
-00002db0: 6d65 203d 2022 6175 6469 6f2f 6f67 6722  me = "audio/ogg"
-00002dc0: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
-00002dd0: 4669 6c65 496e 666f 286d 696d 6574 7970  FileInfo(mimetyp
-00002de0: 653d 6d69 6d65 2c20 7369 7a65 3d6c 656e  e=mime, size=len
-00002df0: 2864 6174 6129 290a 2020 2020 2020 2020  (data)).        
-00002e00: 6966 2049 6d61 6765 2061 6e64 206d 696d  if Image and mim
-00002e10: 652e 7374 6172 7473 7769 7468 2822 696d  e.startswith("im
-00002e20: 6167 652f 2229 2061 6e64 2066 696e 645f  age/") and find_
-00002e30: 7369 7a65 3a0a 2020 2020 2020 2020 2020  size:.          
-00002e40: 2020 7769 7468 2049 6d61 6765 2e6f 7065    with Image.ope
-00002e50: 6e28 4279 7465 7349 4f28 6461 7461 2929  n(BytesIO(data))
-00002e60: 2061 7320 696d 673a 0a20 2020 2020 2020   as img:.       
-00002e70: 2020 2020 2020 2020 2077 6964 7468 2c20           width, 
-00002e80: 6865 6967 6874 203d 2069 6d67 2e73 697a  height = img.siz
-00002e90: 650a 2020 2020 2020 2020 2020 2020 696e  e.            in
-00002ea0: 666f 203d 2049 6d61 6765 496e 666f 286d  fo = ImageInfo(m
-00002eb0: 696d 6574 7970 653d 6d69 6d65 2c20 7369  imetype=mime, si
-00002ec0: 7a65 3d6c 656e 2864 6174 6129 2c20 7769  ze=len(data), wi
-00002ed0: 6474 683d 7769 6474 682c 2068 6569 6768  dth=width, heigh
-00002ee0: 743d 6865 6967 6874 290a 2020 2020 2020  t=height).      
-00002ef0: 2020 7570 6c6f 6164 5f6d 696d 655f 7479    upload_mime_ty
-00002f00: 7065 203d 206d 696d 650a 2020 2020 2020  pe = mime.      
-00002f10: 2020 6465 6372 7970 7469 6f6e 5f69 6e66    decryption_inf
-00002f20: 6f20 3d20 4e6f 6e65 0a20 2020 2020 2020  o = None.       
-00002f30: 2069 6620 656e 6372 7970 7420 616e 6420   if encrypt and 
-00002f40: 656e 6372 7970 745f 6174 7461 6368 6d65  encrypt_attachme
-00002f50: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-00002f60: 6461 7461 2c20 6465 6372 7970 7469 6f6e  data, decryption
-00002f70: 5f69 6e66 6f20 3d20 656e 6372 7970 745f  _info = encrypt_
-00002f80: 6174 7461 6368 6d65 6e74 2864 6174 6129  attachment(data)
-00002f90: 0a20 2020 2020 2020 2020 2020 2075 706c  .            upl
-00002fa0: 6f61 645f 6d69 6d65 5f74 7970 6520 3d20  oad_mime_type = 
-00002fb0: 2261 7070 6c69 6361 7469 6f6e 2f6f 6374  "application/oct
-00002fc0: 6574 2d73 7472 6561 6d22 0a20 2020 2020  et-stream".     
-00002fd0: 2020 2020 2020 2066 696c 656e 616d 6520         filename 
-00002fe0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2075  = None.        u
-00002ff0: 726c 203d 2061 7761 6974 2069 6e74 656e  rl = await inten
-00003000: 742e 7570 6c6f 6164 5f6d 6564 6961 280a  t.upload_media(.
-00003010: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00003020: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-00003030: 6d65 5f74 7970 653d 7570 6c6f 6164 5f6d  me_type=upload_m
-00003040: 696d 655f 7479 7065 2c0a 2020 2020 2020  ime_type,.      
-00003050: 2020 2020 2020 6669 6c65 6e61 6d65 3d66        filename=f
-00003060: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
-00003070: 2020 2020 2061 7379 6e63 5f75 706c 6f61       async_uploa
-00003080: 643d 636c 732e 636f 6e66 6967 5b22 686f  d=cls.config["ho
-00003090: 6d65 7365 7276 6572 2e61 7379 6e63 5f6d  meserver.async_m
-000030a0: 6564 6961 225d 2c0a 2020 2020 2020 2020  edia"],.        
-000030b0: 290a 2020 2020 2020 2020 6966 2064 6563  ).        if dec
-000030c0: 7279 7074 696f 6e5f 696e 666f 3a0a 2020  ryption_info:.  
-000030d0: 2020 2020 2020 2020 2020 6465 6372 7970            decryp
-000030e0: 7469 6f6e 5f69 6e66 6f2e 7572 6c20 3d20  tion_info.url = 
-000030f0: 7572 6c0a 2020 2020 2020 2020 7265 7475  url.        retu
-00003100: 726e 2075 726c 2c20 696e 666f 2c20 6465  rn url, info, de
-00003110: 6372 7970 7469 6f6e 5f69 6e66 6f0a 0a20  cryption_info.. 
-00003120: 2020 2061 7379 6e63 2064 6566 205f 7570     async def _up
-00003130: 6461 7465 5f6e 616d 6528 7365 6c66 2c20  date_name(self, 
-00003140: 6e61 6d65 3a20 7374 7229 202d 3e20 626f  name: str) -> bo
-00003150: 6f6c 3a0a 2020 2020 2020 2020 6966 206e  ol:.        if n
-00003160: 6f74 206e 616d 653a 0a20 2020 2020 2020  ot name:.       
-00003170: 2020 2020 2073 656c 662e 6c6f 672e 7761       self.log.wa
-00003180: 726e 696e 6728 2247 6f74 2065 6d70 7479  rning("Got empty
-00003190: 206e 616d 6520 696e 205f 7570 6461 7465   name in _update
-000031a0: 5f6e 616d 6520 6361 6c6c 2229 0a20 2020  _name call").   
-000031b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000031c0: 4661 6c73 650a 2020 2020 2020 2020 6966  False.        if
-000031d0: 2073 656c 662e 6e61 6d65 2021 3d20 6e61   self.name != na
-000031e0: 6d65 206f 7220 6e6f 7420 7365 6c66 2e6e  me or not self.n
-000031f0: 616d 655f 7365 743a 0a20 2020 2020 2020  ame_set:.       
-00003200: 2020 2020 2073 656c 662e 6c6f 672e 7472       self.log.tr
-00003210: 6163 6528 2255 7064 6174 696e 6720 6e61  ace("Updating na
-00003220: 6d65 2025 7320 2d3e 2025 7322 2c20 7365  me %s -> %s", se
-00003230: 6c66 2e6e 616d 652c 206e 616d 6529 0a20  lf.name, name). 
-00003240: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003250: 6e61 6d65 203d 206e 616d 650a 2020 2020  name = name.    
-00003260: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00003270: 6d78 6964 2061 6e64 2028 7365 6c66 2e65  mxid and (self.e
-00003280: 6e63 7279 7074 6564 206f 7220 6e6f 7420  ncrypted or not 
-00003290: 7365 6c66 2e69 735f 6469 7265 6374 293a  self.is_direct):
-000032a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000032b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000032c0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000032d0: 7365 6c66 2e6d 6169 6e5f 696e 7465 6e74  self.main_intent
-000032e0: 2e73 6574 5f72 6f6f 6d5f 6e61 6d65 2873  .set_room_name(s
-000032f0: 656c 662e 6d78 6964 2c20 7365 6c66 2e6e  elf.mxid, self.n
-00003300: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00003310: 2020 2020 2020 2020 2073 656c 662e 6e61           self.na
-00003320: 6d65 5f73 6574 203d 2054 7275 650a 2020  me_set = True.  
-00003330: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00003340: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00003350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003360: 2020 2020 7365 6c66 2e6c 6f67 2e65 7863      self.log.exc
-00003370: 6570 7469 6f6e 2822 4661 696c 6564 2074  eption("Failed t
-00003380: 6f20 7365 7420 726f 6f6d 206e 616d 6522  o set room name"
-00003390: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000033a0: 2020 2020 2020 7365 6c66 2e6e 616d 655f        self.name_
-000033b0: 7365 7420 3d20 4661 6c73 650a 2020 2020  set = False.    
-000033c0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-000033d0: 7275 650a 2020 2020 2020 2020 7265 7475  rue.        retu
-000033e0: 726e 2046 616c 7365 0a0a 2020 2020 6173  rn False..    as
-000033f0: 796e 6320 6465 6620 5f75 7064 6174 655f  ync def _update_
-00003400: 7068 6f74 6f28 7365 6c66 2c20 736f 7572  photo(self, sour
-00003410: 6365 3a20 752e 5573 6572 2c20 7068 6f74  ce: u.User, phot
-00003420: 6f3a 2067 7261 7068 716c 2e50 6963 7475  o: graphql.Pictu
-00003430: 7265 2920 2d3e 2062 6f6f 6c3a 0a20 2020  re) -> bool:.   
-00003440: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-00003450: 6469 7265 6374 2061 6e64 206e 6f74 2073  direct and not s
-00003460: 656c 662e 656e 6372 7970 7465 643a 0a20  elf.encrypted:. 
-00003470: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003480: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-00003490: 7068 6f74 6f5f 6964 203d 2073 656c 662e  photo_id = self.
-000034a0: 6765 745f 7068 6f74 6f5f 6964 2870 686f  get_photo_id(pho
-000034b0: 746f 290a 2020 2020 2020 2020 6966 2073  to).        if s
-000034c0: 656c 662e 7068 6f74 6f5f 6964 2021 3d20  elf.photo_id != 
-000034d0: 7068 6f74 6f5f 6964 206f 7220 6e6f 7420  photo_id or not 
-000034e0: 7365 6c66 2e61 7661 7461 725f 7365 743a  self.avatar_set:
-000034f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00003500: 662e 7068 6f74 6f5f 6964 203d 2070 686f  f.photo_id = pho
-00003510: 746f 5f69 640a 2020 2020 2020 2020 2020  to_id.          
-00003520: 2020 6966 2070 686f 746f 3a0a 2020 2020    if photo:.    
-00003530: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00003540: 656c 662e 7068 6f74 6f5f 6964 2021 3d20  elf.photo_id != 
-00003550: 7068 6f74 6f5f 6964 206f 7220 6e6f 7420  photo_id or not 
-00003560: 7365 6c66 2e61 7661 7461 725f 7572 6c3a  self.avatar_url:
-00003570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003580: 2020 2020 2023 2052 6573 6574 2061 7661       # Reset ava
-00003590: 7461 725f 7572 6c20 6669 7273 7420 696e  tar_url first in
-000035a0: 2063 6173 6520 7468 6520 7570 6c6f 6164   case the upload
-000035b0: 2066 6169 6c73 0a20 2020 2020 2020 2020   fails.         
-000035c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000035d0: 6176 6174 6172 5f75 726c 203d 204e 6f6e  avatar_url = Non
-000035e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000035f0: 2020 2020 2020 7365 6c66 2e61 7661 7461        self.avata
-00003600: 725f 7572 6c20 3d20 6177 6169 7420 702e  r_url = await p.
-00003610: 5075 7070 6574 2e72 6575 706c 6f61 645f  Puppet.reupload_
-00003620: 6176 6174 6172 280a 2020 2020 2020 2020  avatar(.        
-00003630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003640: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00003650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003660: 7365 6c66 2e6d 6169 6e5f 696e 7465 6e74  self.main_intent
-00003670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003680: 2020 2020 2020 2020 2020 7068 6f74 6f2e            photo.
-00003690: 7572 692c 0a20 2020 2020 2020 2020 2020  uri,.           
-000036a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000036b0: 662e 6662 6964 2c0a 2020 2020 2020 2020  f.fbid,.        
-000036c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036d0: 7573 655f 6772 6170 683d 7365 6c66 2e69  use_graph=self.i
-000036e0: 735f 6469 7265 6374 2061 6e64 2028 7068  s_direct and (ph
-000036f0: 6f74 6f2e 6865 6967 6874 206f 7220 3029  oto.height or 0)
-00003700: 203c 2035 3030 2c0a 2020 2020 2020 2020   < 500,.        
-00003710: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00003720: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00003730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003740: 7365 6c66 2e61 7661 7461 725f 7572 6c20  self.avatar_url 
-00003750: 3d20 436f 6e74 656e 7455 5249 2822 2229  = ContentURI("")
-00003760: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00003770: 7365 6c66 2e6d 7869 643a 0a20 2020 2020  self.mxid:.     
-00003780: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00003790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037a0: 2020 2020 6177 6169 7420 7365 6c66 2e6d      await self.m
-000037b0: 6169 6e5f 696e 7465 6e74 2e73 6574 5f72  ain_intent.set_r
-000037c0: 6f6f 6d5f 6176 6174 6172 2873 656c 662e  oom_avatar(self.
-000037d0: 6d78 6964 2c20 7365 6c66 2e61 7661 7461  mxid, self.avata
-000037e0: 725f 7572 6c29 0a20 2020 2020 2020 2020  r_url).         
-000037f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003800: 6176 6174 6172 5f73 6574 203d 2054 7275  avatar_set = Tru
-00003810: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00003820: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00003830: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00003840: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00003850: 2e65 7863 6570 7469 6f6e 2822 4661 696c  .exception("Fail
-00003860: 6564 2074 6f20 7365 7420 726f 6f6d 2061  ed to set room a
-00003870: 7661 7461 7222 290a 2020 2020 2020 2020  vatar").        
-00003880: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00003890: 2e61 7661 7461 725f 7365 7420 3d20 4661  .avatar_set = Fa
-000038a0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-000038b0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
-000038c0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-000038d0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000038e0: 5f75 7064 6174 655f 7068 6f74 6f5f 6672  _update_photo_fr
-000038f0: 6f6d 5f70 7570 7065 7428 7365 6c66 2c20  om_puppet(self, 
-00003900: 7075 7070 6574 3a20 702e 5075 7070 6574  puppet: p.Puppet
-00003910: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-00003920: 2020 2069 6620 7365 6c66 2e70 686f 746f     if self.photo
-00003930: 5f69 6420 3d3d 2070 7570 7065 742e 7068  _id == puppet.ph
-00003940: 6f74 6f5f 6964 2061 6e64 2073 656c 662e  oto_id and self.
-00003950: 6176 6174 6172 5f73 6574 3a0a 2020 2020  avatar_set:.    
-00003960: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00003970: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
-00003980: 662e 7068 6f74 6f5f 6964 203d 2070 7570  f.photo_id = pup
-00003990: 7065 742e 7068 6f74 6f5f 6964 0a20 2020  pet.photo_id.   
-000039a0: 2020 2020 2069 6620 7075 7070 6574 2e70       if puppet.p
-000039b0: 686f 746f 5f6d 7863 3a0a 2020 2020 2020  hoto_mxc:.      
-000039c0: 2020 2020 2020 7365 6c66 2e61 7661 7461        self.avata
-000039d0: 725f 7572 6c20 3d20 7075 7070 6574 2e70  r_url = puppet.p
-000039e0: 686f 746f 5f6d 7863 0a20 2020 2020 2020  hoto_mxc.       
-000039f0: 2065 6c69 6620 7365 6c66 2e70 686f 746f   elif self.photo
-00003a00: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
-00003a10: 2070 726f 6669 6c65 203d 2061 7761 6974   profile = await
-00003a20: 2073 656c 662e 6d61 696e 5f69 6e74 656e   self.main_inten
-00003a30: 742e 6765 745f 7072 6f66 696c 6528 7075  t.get_profile(pu
-00003a40: 7070 6574 2e64 6566 6175 6c74 5f6d 7869  ppet.default_mxi
-00003a50: 6429 0a20 2020 2020 2020 2020 2020 2073  d).            s
-00003a60: 656c 662e 6176 6174 6172 5f75 726c 203d  elf.avatar_url =
-00003a70: 2070 726f 6669 6c65 2e61 7661 7461 725f   profile.avatar_
-00003a80: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
-00003a90: 7075 7070 6574 2e70 686f 746f 5f6d 7863  puppet.photo_mxc
-00003aa0: 203d 2070 726f 6669 6c65 2e61 7661 7461   = profile.avata
-00003ab0: 725f 7572 6c0a 2020 2020 2020 2020 656c  r_url.        el
-00003ac0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00003ad0: 7365 6c66 2e61 7661 7461 725f 7572 6c20  self.avatar_url 
-00003ae0: 3d20 436f 6e74 656e 7455 5249 2822 2229  = ContentURI("")
-00003af0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00003b00: 2e6d 7869 643a 0a20 2020 2020 2020 2020  .mxid:.         
-00003b10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00003b20: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00003b30: 6c66 2e6d 6169 6e5f 696e 7465 6e74 2e73  lf.main_intent.s
-00003b40: 6574 5f72 6f6f 6d5f 6176 6174 6172 2873  et_room_avatar(s
-00003b50: 656c 662e 6d78 6964 2c20 7365 6c66 2e61  elf.mxid, self.a
-00003b60: 7661 7461 725f 7572 6c29 0a20 2020 2020  vatar_url).     
-00003b70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003b80: 6176 6174 6172 5f73 6574 203d 2054 7275  avatar_set = Tru
-00003b90: 650a 2020 2020 2020 2020 2020 2020 6578  e.            ex
-00003ba0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00003bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bc0: 7365 6c66 2e6c 6f67 2e65 7863 6570 7469  self.log.excepti
-00003bd0: 6f6e 2822 4661 696c 6564 2074 6f20 7365  on("Failed to se
-00003be0: 7420 726f 6f6d 2061 7661 7461 7222 290a  t room avatar").
-00003bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c00: 7365 6c66 2e61 7661 7461 725f 7365 7420  self.avatar_set 
-00003c10: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00003c20: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-00003c30: 2061 7379 6e63 2064 6566 2075 7064 6174   async def updat
-00003c40: 655f 696e 666f 5f66 726f 6d5f 7075 7070  e_info_from_pupp
-00003c50: 6574 2873 656c 662c 2070 7570 7065 743a  et(self, puppet:
-00003c60: 2070 2e50 7570 7065 7420 7c20 4e6f 6e65   p.Puppet | None
-00003c70: 203d 204e 6f6e 6529 202d 3e20 626f 6f6c   = None) -> bool
-00003c80: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00003c90: 2073 656c 662e 6973 5f64 6972 6563 743a   self.is_direct:
-00003ca0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00003cb0: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
-00003cc0: 2020 6966 206e 6f74 2070 7570 7065 743a    if not puppet:
-00003cd0: 0a20 2020 2020 2020 2020 2020 2070 7570  .            pup
-00003ce0: 7065 7420 3d20 6177 6169 7420 7365 6c66  pet = await self
-00003cf0: 2e67 6574 5f64 6d5f 7075 7070 6574 2829  .get_dm_puppet()
-00003d00: 0a20 2020 2020 2020 2063 6861 6e67 6564  .        changed
-00003d10: 203d 2061 7761 6974 2073 656c 662e 5f75   = await self._u
-00003d20: 7064 6174 655f 6e61 6d65 2870 7570 7065  pdate_name(puppe
-00003d30: 742e 6e61 6d65 290a 2020 2020 2020 2020  t.name).        
-00003d40: 6368 616e 6765 6420 3d20 6177 6169 7420  changed = await 
-00003d50: 7365 6c66 2e5f 7570 6461 7465 5f70 686f  self._update_pho
-00003d60: 746f 5f66 726f 6d5f 7075 7070 6574 2870  to_from_puppet(p
-00003d70: 7570 7065 7429 206f 7220 6368 616e 6765  uppet) or change
-00003d80: 640a 2020 2020 2020 2020 7265 7475 726e  d.        return
-00003d90: 2063 6861 6e67 6564 0a0a 2020 2020 6173   changed..    as
-00003da0: 796e 6320 6465 6620 7379 6e63 5f70 6572  ync def sync_per
-00003db0: 5f72 6f6f 6d5f 6e69 636b 2873 656c 662c  _room_nick(self,
-00003dc0: 2070 7570 7065 743a 2070 2e50 7570 7065   puppet: p.Puppe
-00003dd0: 742c 206e 616d 653a 2073 7472 2920 2d3e  t, name: str) ->
-00003de0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00003df0: 6e74 656e 7420 3d20 7075 7070 6574 2e69  ntent = puppet.i
-00003e00: 6e74 656e 745f 666f 7228 7365 6c66 290a  ntent_for(self).
-00003e10: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-00003e20: 3d20 4d65 6d62 6572 5374 6174 6545 7665  = MemberStateEve
-00003e30: 6e74 436f 6e74 656e 7428 0a20 2020 2020  ntContent(.     
-00003e40: 2020 2020 2020 206d 656d 6265 7273 6869         membershi
-00003e50: 703d 4d65 6d62 6572 7368 6970 2e4a 4f49  p=Membership.JOI
-00003e60: 4e2c 0a20 2020 2020 2020 2020 2020 2061  N,.            a
-00003e70: 7661 7461 725f 7572 6c3d 7075 7070 6574  vatar_url=puppet
-00003e80: 2e70 686f 746f 5f6d 7863 2c0a 2020 2020  .photo_mxc,.    
-00003e90: 2020 2020 2020 2020 6469 7370 6c61 796e          displayn
-00003ea0: 616d 653d 6e61 6d65 206f 7220 7075 7070  ame=name or pupp
-00003eb0: 6574 2e6e 616d 652c 0a20 2020 2020 2020  et.name,.       
-00003ec0: 2029 0a20 2020 2020 2020 2063 6f6e 7465   ).        conte
-00003ed0: 6e74 5b44 4f55 424c 455f 5055 5050 4554  nt[DOUBLE_PUPPET
-00003ee0: 5f53 4f55 5243 455f 4b45 595d 203d 2073  _SOURCE_KEY] = s
-00003ef0: 656c 662e 6272 6964 6765 2e6e 616d 650a  elf.bridge.name.
-00003f00: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00003f10: 7374 6174 6520 3d20 6177 6169 7420 696e  state = await in
-00003f20: 7465 6e74 2e73 7461 7465 5f73 746f 7265  tent.state_store
-00003f30: 2e67 6574 5f6d 656d 6265 7228 7365 6c66  .get_member(self
-00003f40: 2e6d 7869 642c 2069 6e74 656e 742e 6d78  .mxid, intent.mx
-00003f50: 6964 290a 2020 2020 2020 2020 6966 206e  id).        if n
-00003f60: 6f74 2063 7572 7265 6e74 5f73 7461 7465  ot current_state
-00003f70: 206f 7220 6375 7272 656e 745f 7374 6174   or current_stat
-00003f80: 652e 6469 7370 6c61 796e 616d 6520 213d  e.displayname !=
-00003f90: 2063 6f6e 7465 6e74 2e64 6973 706c 6179   content.display
-00003fa0: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-00003fb0: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
-00003fc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00003fd0: 2020 2253 796e 6369 6e67 2025 7327 7320    "Syncing %s's 
-00003fe0: 7065 722d 726f 6f6d 206e 6963 6b20 2573  per-room nick %s
-00003ff0: 2074 6f20 7468 6520 726f 6f6d 222c 0a20   to the room",. 
-00004000: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00004010: 7570 7065 742e 6662 6964 2c0a 2020 2020  uppet.fbid,.    
-00004020: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00004030: 656e 742e 6469 7370 6c61 796e 616d 652c  ent.displayname,
-00004040: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00004050: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00004060: 2069 6e74 656e 742e 7365 6e64 5f73 7461   intent.send_sta
-00004070: 7465 5f65 7665 6e74 280a 2020 2020 2020  te_event(.      
-00004080: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00004090: 7869 642c 2045 7665 6e74 5479 7065 2e52  xid, EventType.R
-000040a0: 4f4f 4d5f 4d45 4d42 4552 2c20 636f 6e74  OOM_MEMBER, cont
-000040b0: 656e 742c 2073 7461 7465 5f6b 6579 3d69  ent, state_key=i
-000040c0: 6e74 656e 742e 6d78 6964 0a20 2020 2020  ntent.mxid.     
-000040d0: 2020 2020 2020 2029 0a0a 2020 2020 6173         )..    as
-000040e0: 796e 6320 6465 6620 5f75 7064 6174 655f  ync def _update_
-000040f0: 7061 7274 6963 6970 616e 7428 0a20 2020  participant(.   
-00004100: 2020 2020 2073 656c 662c 2073 6f75 7263       self, sourc
-00004110: 653a 2075 2e55 7365 722c 2070 6172 7469  e: u.User, parti
-00004120: 6369 7061 6e74 3a20 6772 6170 6871 6c2e  cipant: graphql.
-00004130: 5061 7274 6963 6970 616e 744e 6f64 652c  ParticipantNode,
-00004140: 206e 6963 6b5f 6d61 703a 2064 6963 745b   nick_map: dict[
-00004150: 696e 742c 2073 7472 5d0a 2020 2020 2920  int, str].    ) 
-00004160: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00004170: 2073 656c 662e 6c6f 672e 7472 6163 6528   self.log.trace(
-00004180: 2253 796e 6369 6e67 2070 6172 7469 6369  "Syncing partici
-00004190: 7061 6e74 2025 7322 2c20 7061 7274 6963  pant %s", partic
-000041a0: 6970 616e 742e 6964 290a 2020 2020 2020  ipant.id).      
-000041b0: 2020 7075 7070 6574 203d 2061 7761 6974    puppet = await
-000041c0: 2070 2e50 7570 7065 742e 6765 745f 6279   p.Puppet.get_by
-000041d0: 5f66 6269 6428 696e 7428 7061 7274 6963  _fbid(int(partic
-000041e0: 6970 616e 742e 6964 2929 0a20 2020 2020  ipant.id)).     
-000041f0: 2020 2061 7761 6974 2070 7570 7065 742e     await puppet.
-00004200: 7570 6461 7465 5f69 6e66 6f28 736f 7572  update_info(sour
-00004210: 6365 2c20 7061 7274 6963 6970 616e 742e  ce, participant.
-00004220: 6d65 7373 6167 696e 675f 6163 746f 7229  messaging_actor)
-00004230: 0a20 2020 2020 2020 2063 6861 6e67 6564  .        changed
-00004240: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00004250: 2069 6620 7365 6c66 2e69 735f 6469 7265   if self.is_dire
-00004260: 6374 2061 6e64 2073 656c 662e 6662 6964  ct and self.fbid
-00004270: 203d 3d20 7075 7070 6574 2e66 6269 6420   == puppet.fbid 
-00004280: 616e 6420 7365 6c66 2e65 6e63 7279 7074  and self.encrypt
-00004290: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-000042a0: 6368 616e 6765 6420 3d20 6177 6169 7420  changed = await 
-000042b0: 7365 6c66 2e75 7064 6174 655f 696e 666f  self.update_info
-000042c0: 5f66 726f 6d5f 7075 7070 6574 2870 7570  _from_puppet(pup
-000042d0: 7065 7429 206f 7220 6368 616e 6765 640a  pet) or changed.
-000042e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000042f0: 6d78 6964 3a0a 2020 2020 2020 2020 2020  mxid:.          
-00004300: 2020 6966 2070 7570 7065 742e 6662 6964    if puppet.fbid
-00004310: 2021 3d20 7365 6c66 2e66 625f 7265 6365   != self.fb_rece
-00004320: 6976 6572 206f 7220 7075 7070 6574 2e69  iver or puppet.i
-00004330: 735f 7265 616c 5f75 7365 723a 0a20 2020  s_real_user:.   
-00004340: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00004350: 6974 2070 7570 7065 742e 696e 7465 6e74  it puppet.intent
-00004360: 5f66 6f72 2873 656c 6629 2e65 6e73 7572  _for(self).ensur
-00004370: 655f 6a6f 696e 6564 2873 656c 662e 6d78  e_joined(self.mx
-00004380: 6964 2c20 626f 743d 7365 6c66 2e6d 6169  id, bot=self.mai
-00004390: 6e5f 696e 7465 6e74 290a 2020 2020 2020  n_intent).      
-000043a0: 2020 2020 2020 6966 2070 7570 7065 742e        if puppet.
-000043b0: 6662 6964 2069 6e20 6e69 636b 5f6d 6170  fbid in nick_map
-000043c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000043d0: 2020 6177 6169 7420 7365 6c66 2e73 796e    await self.syn
-000043e0: 635f 7065 725f 726f 6f6d 5f6e 6963 6b28  c_per_room_nick(
-000043f0: 7075 7070 6574 2c20 6e69 636b 5f6d 6170  puppet, nick_map
-00004400: 5b70 7570 7065 742e 6662 6964 5d29 0a20  [puppet.fbid]). 
-00004410: 2020 2020 2020 2072 6574 7572 6e20 6368         return ch
-00004420: 616e 6765 640a 0a20 2020 2061 7379 6e63  anged..    async
-00004430: 2064 6566 205f 7570 6461 7465 5f70 6172   def _update_par
-00004440: 7469 6369 7061 6e74 7328 7365 6c66 2c20  ticipants(self, 
-00004450: 736f 7572 6365 3a20 752e 5573 6572 2c20  source: u.User, 
-00004460: 696e 666f 3a20 6772 6170 6871 6c2e 5468  info: graphql.Th
-00004470: 7265 6164 2920 2d3e 2062 6f6f 6c3a 0a20  read) -> bool:. 
-00004480: 2020 2020 2020 206e 6963 6b5f 6d61 7020         nick_map 
-00004490: 3d20 696e 666f 2e63 7573 746f 6d69 7a61  = info.customiza
-000044a0: 7469 6f6e 5f69 6e66 6f2e 6e69 636b 6e61  tion_info.nickna
-000044b0: 6d65 5f6d 6170 2069 6620 696e 666f 2e63  me_map if info.c
-000044c0: 7573 746f 6d69 7a61 7469 6f6e 5f69 6e66  ustomization_inf
-000044d0: 6f20 656c 7365 207b 7d0a 2020 2020 2020  o else {}.      
-000044e0: 2020 7379 6e63 5f74 6173 6b73 203d 205b    sync_tasks = [
-000044f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00004500: 662e 5f75 7064 6174 655f 7061 7274 6963  f._update_partic
-00004510: 6970 616e 7428 736f 7572 6365 2c20 7063  ipant(source, pc
-00004520: 702c 206e 6963 6b5f 6d61 7029 2066 6f72  p, nick_map) for
-00004530: 2070 6370 2069 6e20 696e 666f 2e61 6c6c   pcp in info.all
-00004540: 5f70 6172 7469 6369 7061 6e74 732e 6e6f  _participants.no
-00004550: 6465 730a 2020 2020 2020 2020 5d0a 2020  des.        ].  
-00004560: 2020 2020 2020 6368 616e 6765 6420 3d20        changed = 
-00004570: 616e 7928 6177 6169 7420 6173 796e 6369  any(await asynci
-00004580: 6f2e 6761 7468 6572 282a 7379 6e63 5f74  o.gather(*sync_t
-00004590: 6173 6b73 2929 0a20 2020 2020 2020 2072  asks)).        r
-000045a0: 6574 7572 6e20 6368 616e 6765 640a 0a20  eturn changed.. 
-000045b0: 2020 2023 2065 6e64 7265 6769 6f6e 0a20     # endregion. 
-000045c0: 2020 2023 2072 6567 696f 6e20 4d61 7472     # region Matr
-000045d0: 6978 2072 6f6f 6d20 6372 6561 7469 6f6e  ix room creation
-000045e0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000045f0: 7570 6461 7465 5f6d 6174 7269 785f 726f  update_matrix_ro
-00004600: 6f6d 2873 656c 662c 2073 6f75 7263 653a  om(self, source:
-00004610: 2075 2e55 7365 722c 2069 6e66 6f3a 2067   u.User, info: g
-00004620: 7261 7068 716c 2e54 6872 6561 6420 7c20  raphql.Thread | 
-00004630: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
-00004640: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
-00004650: 793a 0a20 2020 2020 2020 2020 2020 2061  y:.            a
-00004660: 7761 6974 2073 656c 662e 5f75 7064 6174  wait self._updat
-00004670: 655f 6d61 7472 6978 5f72 6f6f 6d28 736f  e_matrix_room(so
-00004680: 7572 6365 2c20 696e 666f 290a 2020 2020  urce, info).    
-00004690: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000046a0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000046b0: 2020 7365 6c66 2e6c 6f67 2e65 7863 6570    self.log.excep
-000046c0: 7469 6f6e 2822 4661 696c 6564 2074 6f20  tion("Failed to 
-000046d0: 7570 6461 7465 2070 6f72 7461 6c22 290a  update portal").
-000046e0: 0a20 2020 2064 6566 205f 6765 745f 696e  .    def _get_in
-000046f0: 7669 7465 5f63 6f6e 7465 6e74 2873 656c  vite_content(sel
-00004700: 662c 2064 6f75 626c 655f 7075 7070 6574  f, double_puppet
-00004710: 3a20 702e 5075 7070 6574 207c 204e 6f6e  : p.Puppet | Non
-00004720: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
-00004730: 416e 795d 3a0a 2020 2020 2020 2020 696e  Any]:.        in
-00004740: 7669 7465 5f63 6f6e 7465 6e74 203d 207b  vite_content = {
-00004750: 7d0a 2020 2020 2020 2020 6966 2064 6f75  }.        if dou
-00004760: 626c 655f 7075 7070 6574 3a0a 2020 2020  ble_puppet:.    
-00004770: 2020 2020 2020 2020 696e 7669 7465 5f63          invite_c
-00004780: 6f6e 7465 6e74 5b22 6669 2e6d 6175 2e77  ontent["fi.mau.w
-00004790: 696c 6c5f 6175 746f 5f61 6363 6570 7422  ill_auto_accept"
-000047a0: 5d20 3d20 5472 7565 0a20 2020 2020 2020  ] = True.       
-000047b0: 2069 6620 7365 6c66 2e69 735f 6469 7265   if self.is_dire
-000047c0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-000047d0: 696e 7669 7465 5f63 6f6e 7465 6e74 5b22  invite_content["
-000047e0: 6973 5f64 6972 6563 7422 5d20 3d20 5472  is_direct"] = Tr
-000047f0: 7565 0a20 2020 2020 2020 2072 6574 7572  ue.        retur
-00004800: 6e20 696e 7669 7465 5f63 6f6e 7465 6e74  n invite_content
-00004810: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00004820: 5f75 7064 6174 655f 6d61 7472 6978 5f72  _update_matrix_r
-00004830: 6f6f 6d28 0a20 2020 2020 2020 2073 656c  oom(.        sel
-00004840: 662c 2073 6f75 7263 653a 2075 2e55 7365  f, source: u.Use
-00004850: 722c 2069 6e66 6f3a 2067 7261 7068 716c  r, info: graphql
-00004860: 2e54 6872 6561 6420 7c20 4e6f 6e65 203d  .Thread | None =
-00004870: 204e 6f6e 650a 2020 2020 2920 2d3e 204e   None.    ) -> N
-00004880: 6f6e 653a 0a20 2020 2020 2020 2070 7570  one:.        pup
-00004890: 7065 7420 3d20 6177 6169 7420 702e 5075  pet = await p.Pu
-000048a0: 7070 6574 2e67 6574 5f62 795f 6375 7374  ppet.get_by_cust
-000048b0: 6f6d 5f6d 7869 6428 736f 7572 6365 2e6d  om_mxid(source.m
-000048c0: 7869 6429 0a20 2020 2020 2020 2061 7761  xid).        awa
-000048d0: 6974 2073 656c 662e 6d61 696e 5f69 6e74  it self.main_int
-000048e0: 656e 742e 696e 7669 7465 5f75 7365 7228  ent.invite_user(
-000048f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00004900: 662e 6d78 6964 2c0a 2020 2020 2020 2020  f.mxid,.        
-00004910: 2020 2020 736f 7572 6365 2e6d 7869 642c      source.mxid,
-00004920: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-00004930: 636b 5f63 6163 6865 3d54 7275 652c 0a20  ck_cache=True,. 
-00004940: 2020 2020 2020 2020 2020 2065 7874 7261             extra
-00004950: 5f63 6f6e 7465 6e74 3d73 656c 662e 5f67  _content=self._g
-00004960: 6574 5f69 6e76 6974 655f 636f 6e74 656e  et_invite_conten
-00004970: 7428 7075 7070 6574 292c 0a20 2020 2020  t(puppet),.     
-00004980: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-00004990: 7075 7070 6574 3a0a 2020 2020 2020 2020  puppet:.        
-000049a0: 2020 2020 6469 645f 6a6f 696e 203d 2061      did_join = a
-000049b0: 7761 6974 2070 7570 7065 742e 696e 7465  wait puppet.inte
-000049c0: 6e74 2e65 6e73 7572 655f 6a6f 696e 6564  nt.ensure_joined
-000049d0: 2873 656c 662e 6d78 6964 290a 2020 2020  (self.mxid).    
-000049e0: 2020 2020 2020 2020 6966 2064 6964 5f6a          if did_j
-000049f0: 6f69 6e20 616e 6420 7365 6c66 2e69 735f  oin and self.is_
-00004a00: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
-00004a10: 2020 2020 2020 2020 6177 6169 7420 736f          await so
-00004a20: 7572 6365 2e75 7064 6174 655f 6469 7265  urce.update_dire
-00004a30: 6374 5f63 6861 7473 287b 7365 6c66 2e6d  ct_chats({self.m
-00004a40: 6169 6e5f 696e 7465 6e74 2e6d 7869 643a  ain_intent.mxid:
-00004a50: 205b 7365 6c66 2e6d 7869 645d 7d29 0a0a   [self.mxid]})..
-00004a60: 2020 2020 2020 2020 696e 666f 203d 2061          info = a
-00004a70: 7761 6974 2073 656c 662e 7570 6461 7465  wait self.update
-00004a80: 5f69 6e66 6f28 736f 7572 6365 2c20 696e  _info(source, in
-00004a90: 666f 290a 2020 2020 2020 2020 6966 206e  fo).        if n
-00004aa0: 6f74 2069 6e66 6f3a 0a20 2020 2020 2020  ot info:.       
-00004ab0: 2020 2020 2073 656c 662e 6c6f 672e 7761       self.log.wa
-00004ac0: 726e 696e 6728 2243 616e 6365 6c69 6e67  rning("Canceling
-00004ad0: 205f 7570 6461 7465 5f6d 6174 7269 785f   _update_matrix_
-00004ae0: 726f 6f6d 2061 7320 7570 6461 7465 5f69  room as update_i
-00004af0: 6e66 6f20 6469 646e 2774 2072 6574 7572  nfo didn't retur
-00004b00: 6e20 696e 666f 2229 0a20 2020 2020 2020  n info").       
-00004b10: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00004b20: 2020 2020 2061 7761 6974 2055 7365 7250       await UserP
-00004b30: 6f72 7461 6c28 0a20 2020 2020 2020 2020  ortal(.         
-00004b40: 2020 2075 7365 723d 736f 7572 6365 2e66     user=source.f
-00004b50: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
-00004b60: 2070 6f72 7461 6c3d 7365 6c66 2e66 6269   portal=self.fbi
-00004b70: 642c 0a20 2020 2020 2020 2020 2020 2070  d,.            p
-00004b80: 6f72 7461 6c5f 7265 6365 6976 6572 3d73  ortal_receiver=s
-00004b90: 656c 662e 6662 5f72 6563 6569 7665 722c  elf.fb_receiver,
-00004ba0: 0a20 2020 2020 2020 2029 2e75 7073 6572  .        ).upser
-00004bb0: 7428 290a 2020 2020 2020 2020 6177 6169  t().        awai
-00004bc0: 7420 7365 6c66 2e5f 7379 6e63 5f72 6561  t self._sync_rea
-00004bd0: 645f 7265 6365 6970 7473 2869 6e66 6f2e  d_receipts(info.
-00004be0: 7265 6164 5f72 6563 6569 7074 732e 6e6f  read_receipts.no
-00004bf0: 6465 732c 2072 6561 6374 696f 6e73 3d46  des, reactions=F
-00004c00: 616c 7365 290a 0a20 2020 2061 7379 6e63  alse)..    async
-00004c10: 2064 6566 205f 7379 6e63 5f72 6561 645f   def _sync_read_
-00004c20: 7265 6365 6970 7473 280a 2020 2020 2020  receipts(.      
-00004c30: 2020 7365 6c66 2c20 7265 6365 6970 7473    self, receipts
-00004c40: 3a20 6c69 7374 5b67 7261 7068 716c 2e52  : list[graphql.R
-00004c50: 6561 6452 6563 6569 7074 5d2c 2072 6561  eadReceipt], rea
-00004c60: 6374 696f 6e73 3a20 626f 6f6c 0a20 2020  ctions: bool.   
-00004c70: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00004c80: 2020 2020 666f 7220 7265 6365 6970 7420      for receipt 
-00004c90: 696e 2072 6563 6569 7074 733a 0a20 2020  in receipts:.   
-00004ca0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00004cb0: 7265 6365 6970 742e 6163 746f 723a 0a20  receipt.actor:. 
-00004cc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00004cd0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00004ce0: 2020 2020 6d65 7373 6167 6520 3d20 6177      message = aw
-00004cf0: 6169 7420 4442 4d65 7373 6167 652e 6765  ait DBMessage.ge
-00004d00: 745f 636c 6f73 6573 745f 6265 666f 7265  t_closest_before
-00004d10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00004d20: 2020 7365 6c66 2e66 6269 642c 2073 656c    self.fbid, sel
-00004d30: 662e 6662 5f72 6563 6569 7665 722c 2072  f.fb_receiver, r
-00004d40: 6563 6569 7074 2e74 696d 6573 7461 6d70  eceipt.timestamp
-00004d50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00004d60: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00004d70: 7420 6d65 7373 6167 653a 0a20 2020 2020  t message:.     
-00004d80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00004d90: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00004da0: 7075 7070 6574 203d 2061 7761 6974 2070  puppet = await p
-00004db0: 2e50 7570 7065 742e 6765 745f 6279 5f66  .Puppet.get_by_f
-00004dc0: 6269 6428 7265 6365 6970 742e 6163 746f  bid(receipt.acto
-00004dd0: 722e 6964 2c20 6372 6561 7465 3d46 616c  r.id, create=Fal
-00004de0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-00004df0: 6966 206e 6f74 2070 7570 7065 743a 0a20  if not puppet:. 
-00004e00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00004e10: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00004e20: 2020 2020 6d73 6769 645f 7465 7874 203d      msgid_text =
-00004e30: 206d 6573 7361 6765 2e6d 7869 640a 2020   message.mxid.  
-00004e40: 2020 2020 2020 2020 2020 6966 2072 6561            if rea
-00004e50: 6374 696f 6e73 2061 6e64 206d 6573 7361  ctions and messa
-00004e60: 6765 2e66 6269 643a 0a20 2020 2020 2020  ge.fbid:.       
-00004e70: 2020 2020 2020 2020 2072 6561 6374 696f           reactio
-00004e80: 6e20 3d20 6177 6169 7420 4442 5265 6163  n = await DBReac
-00004e90: 7469 6f6e 2e67 6574 5f6c 6173 745f 666f  tion.get_last_fo
-00004ea0: 725f 6d65 7373 6167 6528 6d65 7373 6167  r_message(messag
-00004eb0: 652e 6662 6964 2c20 6d65 7373 6167 652e  e.fbid, message.
-00004ec0: 6662 5f72 6563 6569 7665 7229 0a20 2020  fb_receiver).   
-00004ed0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00004ee0: 7265 6163 7469 6f6e 3a0a 2020 2020 2020  reaction:.      
-00004ef0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00004f00: 6769 645f 7465 7874 203d 2066 227b 6d65  gid_text = f"{me
-00004f10: 7373 6167 652e 6d78 6964 7d20 2d3e 206c  ssage.mxid} -> l
-00004f20: 6173 7420 7265 6163 7469 6f6e 207b 7265  ast reaction {re
-00004f30: 6163 7469 6f6e 2e6d 7869 647d 220a 2020  action.mxid}".  
-00004f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f50: 2020 6d65 7373 6167 6520 3d20 7265 6163    message = reac
-00004f60: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00004f70: 2073 656c 662e 6c6f 672e 6465 6275 6728   self.log.debug(
-00004f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004f90: 2022 2573 2068 6173 2072 6561 6420 6d65   "%s has read me
-00004fa0: 7373 6167 6573 2075 7020 746f 2025 6420  ssages up to %d 
-00004fb0: 2d3e 2025 7322 2c20 7075 7070 6574 2e6d  -> %s", puppet.m
-00004fc0: 7869 642c 2072 6563 6569 7074 2e74 696d  xid, receipt.tim
-00004fd0: 6573 7461 6d70 2c20 6d73 6769 645f 7465  estamp, msgid_te
-00004fe0: 7874 0a20 2020 2020 2020 2020 2020 2029  xt.            )
-00004ff0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00005000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005010: 2020 6177 6169 7420 7075 7070 6574 2e69    await puppet.i
-00005020: 6e74 656e 745f 666f 7228 7365 6c66 292e  ntent_for(self).
-00005030: 6d61 726b 5f72 6561 6428 6d65 7373 6167  mark_read(messag
-00005040: 652e 6d78 5f72 6f6f 6d2c 206d 6573 7361  e.mx_room, messa
-00005050: 6765 2e6d 7869 6429 0a20 2020 2020 2020  ge.mxid).       
-00005060: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00005070: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-00005080: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-00005090: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-000050a0: 2020 2020 2020 2020 2020 2020 2066 2246               f"F
-000050b0: 6169 6c65 6420 746f 206d 6172 6b20 7b6d  ailed to mark {m
-000050c0: 6573 7361 6765 2e6d 7869 647d 2069 6e20  essage.mxid} in 
-000050d0: 7b6d 6573 7361 6765 2e6d 785f 726f 6f6d  {message.mx_room
-000050e0: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-000050f0: 2020 2020 2020 2020 6622 6173 2072 6561          f"as rea
-00005100: 6420 6279 207b 7075 7070 6574 2e69 6e74  d by {puppet.int
-00005110: 656e 742e 6d78 6964 7d22 2c0a 2020 2020  ent.mxid}",.    
-00005120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005130: 6578 635f 696e 666f 3d54 7275 652c 0a20  exc_info=True,. 
-00005140: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00005150: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00005160: 6372 6561 7465 5f6d 6174 7269 785f 726f  create_matrix_ro
-00005170: 6f6d 280a 2020 2020 2020 2020 7365 6c66  om(.        self
-00005180: 2c20 736f 7572 6365 3a20 752e 5573 6572  , source: u.User
-00005190: 2c20 696e 666f 3a20 6772 6170 6871 6c2e  , info: graphql.
-000051a0: 5468 7265 6164 207c 204e 6f6e 6520 3d20  Thread | None = 
-000051b0: 4e6f 6e65 0a20 2020 2029 202d 3e20 526f  None.    ) -> Ro
-000051c0: 6f6d 4944 207c 204e 6f6e 653a 0a20 2020  omID | None:.   
-000051d0: 2020 2020 2069 6620 7365 6c66 2e6d 7869       if self.mxi
-000051e0: 643a 0a20 2020 2020 2020 2020 2020 2074  d:.            t
-000051f0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00005200: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-00005210: 7570 6461 7465 5f6d 6174 7269 785f 726f  update_matrix_ro
-00005220: 6f6d 2873 6f75 7263 652c 2069 6e66 6f29  om(source, info)
-00005230: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00005240: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00005250: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00005260: 656c 662e 6c6f 672e 6578 6365 7074 696f  elf.log.exceptio
-00005270: 6e28 2246 6169 6c65 6420 746f 2075 7064  n("Failed to upd
-00005280: 6174 6520 706f 7274 616c 2229 0a20 2020  ate portal").   
-00005290: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000052a0: 7365 6c66 2e6d 7869 640a 2020 2020 2020  self.mxid.      
-000052b0: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
-000052c0: 662e 5f63 7265 6174 655f 726f 6f6d 5f6c  f._create_room_l
-000052d0: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
-000052e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000052f0: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-00005300: 6974 2073 656c 662e 5f63 7265 6174 655f  it self._create_
-00005310: 6d61 7472 6978 5f72 6f6f 6d28 736f 7572  matrix_room(sour
-00005320: 6365 2c20 696e 666f 290a 2020 2020 2020  ce, info).      
-00005330: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00005340: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00005350: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00005360: 2e65 7863 6570 7469 6f6e 2822 4661 696c  .exception("Fail
-00005370: 6564 2074 6f20 6372 6561 7465 2070 6f72  ed to create por
-00005380: 7461 6c22 290a 2020 2020 2020 2020 2020  tal").          
-00005390: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000053a0: 650a 0a20 2020 2040 7072 6f70 6572 7479  e..    @property
-000053b0: 0a20 2020 2064 6566 2062 7269 6467 655f  .    def bridge_
-000053c0: 696e 666f 5f73 7461 7465 5f6b 6579 2873  info_state_key(s
-000053d0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-000053e0: 2020 2020 2072 6574 7572 6e20 6622 6e65       return f"ne
-000053f0: 742e 6d61 756e 6975 6d2e 6661 6365 626f  t.maunium.facebo
-00005400: 6f6b 3a2f 2f66 6163 6562 6f6f 6b2f 7b73  ok://facebook/{s
-00005410: 656c 662e 6662 6964 7d22 0a0a 2020 2020  elf.fbid}"..    
-00005420: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00005430: 6620 6272 6964 6765 5f69 6e66 6f28 7365  f bridge_info(se
-00005440: 6c66 2920 2d3e 2064 6963 745b 7374 722c  lf) -> dict[str,
-00005450: 2041 6e79 5d3a 0a20 2020 2020 2020 2072   Any]:.        r
-00005460: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-00005470: 2020 2020 2262 7269 6467 6562 6f74 223a      "bridgebot":
-00005480: 2073 656c 662e 617a 2e62 6f74 5f6d 7869   self.az.bot_mxi
-00005490: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-000054a0: 6372 6561 746f 7222 3a20 7365 6c66 2e6d  creator": self.m
-000054b0: 6169 6e5f 696e 7465 6e74 2e6d 7869 642c  ain_intent.mxid,
-000054c0: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
-000054d0: 6f74 6f63 6f6c 223a 207b 0a20 2020 2020  otocol": {.     
-000054e0: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
-000054f0: 2022 6661 6365 626f 6f6b 222c 0a20 2020   "facebook",.   
-00005500: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-00005510: 7370 6c61 796e 616d 6522 3a20 2246 6163  splayname": "Fac
-00005520: 6562 6f6f 6b20 4d65 7373 656e 6765 7222  ebook Messenger"
-00005530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005540: 2020 2261 7661 7461 725f 7572 6c22 3a20    "avatar_url": 
-00005550: 7365 6c66 2e63 6f6e 6669 675b 2261 7070  self.config["app
-00005560: 7365 7276 6963 652e 626f 745f 6176 6174  service.bot_avat
-00005570: 6172 225d 2c0a 2020 2020 2020 2020 2020  ar"],.          
-00005580: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-00005590: 2022 6368 616e 6e65 6c22 3a20 7b0a 2020   "channel": {.  
-000055a0: 2020 2020 2020 2020 2020 2020 2020 2269                "i
-000055b0: 6422 3a20 7374 7228 7365 6c66 2e66 6269  d": str(self.fbi
-000055c0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-000055d0: 2020 2020 2264 6973 706c 6179 6e61 6d65      "displayname
-000055e0: 223a 2073 656c 662e 6e61 6d65 2c0a 2020  ": self.name,.  
-000055f0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
-00005600: 7661 7461 725f 7572 6c22 3a20 7365 6c66  vatar_url": self
-00005610: 2e61 7661 7461 725f 7572 6c2c 0a20 2020  .avatar_url,.   
-00005620: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00005630: 2020 2020 7d0a 0a20 2020 2061 7379 6e63      }..    async
-00005640: 2064 6566 2075 7064 6174 655f 6272 6964   def update_brid
-00005650: 6765 5f69 6e66 6f28 7365 6c66 2920 2d3e  ge_info(self) ->
-00005660: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00005670: 6620 6e6f 7420 7365 6c66 2e6d 7869 643a  f not self.mxid:
-00005680: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00005690: 662e 6c6f 672e 6465 6275 6728 224e 6f74  f.log.debug("Not
-000056a0: 2075 7064 6174 696e 6720 6272 6964 6765   updating bridge
-000056b0: 2069 6e66 6f3a 206e 6f20 4d61 7472 6978   info: no Matrix
-000056c0: 2072 6f6f 6d20 6372 6561 7465 6422 290a   room created").
-000056d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000056e0: 726e 0a20 2020 2020 2020 2074 7279 3a0a  rn.        try:.
-000056f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005700: 2e6c 6f67 2e64 6562 7567 2822 5570 6461  .log.debug("Upda
-00005710: 7469 6e67 2062 7269 6467 6520 696e 666f  ting bridge info
-00005720: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
-00005730: 2020 6177 6169 7420 7365 6c66 2e6d 6169    await self.mai
-00005740: 6e5f 696e 7465 6e74 2e73 656e 645f 7374  n_intent.send_st
-00005750: 6174 655f 6576 656e 7428 0a20 2020 2020  ate_event(.     
-00005760: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005770: 6d78 6964 2c20 5374 6174 6542 7269 6467  mxid, StateBridg
-00005780: 652c 2073 656c 662e 6272 6964 6765 5f69  e, self.bridge_i
-00005790: 6e66 6f2c 2073 656c 662e 6272 6964 6765  nfo, self.bridge
-000057a0: 5f69 6e66 6f5f 7374 6174 655f 6b65 790a  _info_state_key.
-000057b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000057c0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-000057d0: 2072 656d 6f76 6520 7468 6973 206f 6e63   remove this onc
-000057e0: 6520 6874 7470 733a 2f2f 6769 7468 7562  e https://github
-000057f0: 2e63 6f6d 2f6d 6174 7269 782d 6f72 672f  .com/matrix-org/
-00005800: 6d61 7472 6978 2d64 6f63 2f70 756c 6c2f  matrix-doc/pull/
-00005810: 3233 3436 2069 7320 696e 2073 7065 630a  2346 is in spec.
-00005820: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00005830: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
-00005840: 6e74 2e73 656e 645f 7374 6174 655f 6576  nt.send_state_ev
-00005850: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-00005860: 2020 2020 2073 656c 662e 6d78 6964 2c20       self.mxid, 
-00005870: 5374 6174 6548 616c 6653 686f 7442 7269  StateHalfShotBri
-00005880: 6467 652c 2073 656c 662e 6272 6964 6765  dge, self.bridge
-00005890: 5f69 6e66 6f2c 2073 656c 662e 6272 6964  _info, self.brid
-000058a0: 6765 5f69 6e66 6f5f 7374 6174 655f 6b65  ge_info_state_ke
-000058b0: 790a 2020 2020 2020 2020 2020 2020 290a  y.            ).
-000058c0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-000058d0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-000058e0: 2020 2020 2020 7365 6c66 2e6c 6f67 2e77        self.log.w
-000058f0: 6172 6e69 6e67 2822 4661 696c 6564 2074  arning("Failed t
-00005900: 6f20 7570 6461 7465 2062 7269 6467 6520  o update bridge 
-00005910: 696e 666f 222c 2065 7863 5f69 6e66 6f3d  info", exc_info=
-00005920: 5472 7565 290a 0a20 2020 2061 7379 6e63  True)..    async
-00005930: 2064 6566 205f 6372 6561 7465 5f6d 6174   def _create_mat
-00005940: 7269 785f 726f 6f6d 280a 2020 2020 2020  rix_room(.      
-00005950: 2020 7365 6c66 2c20 736f 7572 6365 3a20    self, source: 
-00005960: 752e 5573 6572 2c20 696e 666f 3a20 6772  u.User, info: gr
-00005970: 6170 6871 6c2e 5468 7265 6164 207c 204e  aphql.Thread | N
-00005980: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-00005990: 202d 3e20 526f 6f6d 4944 207c 204e 6f6e   -> RoomID | Non
-000059a0: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
-000059b0: 6c66 2e6d 7869 643a 0a20 2020 2020 2020  lf.mxid:.       
-000059c0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-000059d0: 5f75 7064 6174 655f 6d61 7472 6978 5f72  _update_matrix_r
-000059e0: 6f6f 6d28 736f 7572 6365 2c20 696e 666f  oom(source, info
-000059f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00005a00: 7475 726e 2073 656c 662e 6d78 6964 0a0a  turn self.mxid..
-00005a10: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00005a20: 2e64 6562 7567 2866 2243 7265 6174 696e  .debug(f"Creatin
-00005a30: 6720 4d61 7472 6978 2072 6f6f 6d22 290a  g Matrix room").
-00005a40: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
-00005a50: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
-00005a60: 2020 2020 2020 2020 696e 6974 6961 6c5f          initial_
-00005a70: 7374 6174 6520 3d20 5b0a 2020 2020 2020  state = [.      
-00005a80: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00005a90: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-00005aa0: 7374 7228 5374 6174 6542 7269 6467 6529  str(StateBridge)
-00005ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005ac0: 2020 2273 7461 7465 5f6b 6579 223a 2073    "state_key": s
-00005ad0: 656c 662e 6272 6964 6765 5f69 6e66 6f5f  elf.bridge_info_
-00005ae0: 7374 6174 655f 6b65 792c 0a20 2020 2020  state_key,.     
-00005af0: 2020 2020 2020 2020 2020 2022 636f 6e74             "cont
-00005b00: 656e 7422 3a20 7365 6c66 2e62 7269 6467  ent": self.bridg
-00005b10: 655f 696e 666f 2c0a 2020 2020 2020 2020  e_info,.        
-00005b20: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00005b30: 2020 2023 2054 4f44 4f20 7265 6d6f 7665     # TODO remove
-00005b40: 2074 6869 7320 6f6e 6365 2068 7474 7073   this once https
-00005b50: 3a2f 2f67 6974 6875 622e 636f 6d2f 6d61  ://github.com/ma
-00005b60: 7472 6978 2d6f 7267 2f6d 6174 7269 782d  trix-org/matrix-
-00005b70: 646f 632f 7075 6c6c 2f32 3334 3620 6973  doc/pull/2346 is
-00005b80: 2069 6e20 7370 6563 0a20 2020 2020 2020   in spec.       
-00005b90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00005ba0: 2020 2020 2020 2022 7479 7065 223a 2073         "type": s
-00005bb0: 7472 2853 7461 7465 4861 6c66 5368 6f74  tr(StateHalfShot
-00005bc0: 4272 6964 6765 292c 0a20 2020 2020 2020  Bridge),.       
-00005bd0: 2020 2020 2020 2020 2022 7374 6174 655f           "state_
-00005be0: 6b65 7922 3a20 7365 6c66 2e62 7269 6467  key": self.bridg
-00005bf0: 655f 696e 666f 5f73 7461 7465 5f6b 6579  e_info_state_key
-00005c00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005c10: 2020 2263 6f6e 7465 6e74 223a 2073 656c    "content": sel
-00005c20: 662e 6272 6964 6765 5f69 6e66 6f2c 0a20  f.bridge_info,. 
-00005c30: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00005c40: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00005c50: 696e 7669 7465 7320 3d20 5b5d 0a20 2020  invites = [].   
-00005c60: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
-00005c70: 6669 675b 2262 7269 6467 652e 656e 6372  fig["bridge.encr
-00005c80: 7970 7469 6f6e 2e64 6566 6175 6c74 225d  yption.default"]
-00005c90: 2061 6e64 2073 656c 662e 6d61 7472 6978   and self.matrix
-00005ca0: 2e65 3265 653a 0a20 2020 2020 2020 2020  .e2ee:.         
-00005cb0: 2020 2073 656c 662e 656e 6372 7970 7465     self.encrypte
-00005cc0: 6420 3d20 5472 7565 0a20 2020 2020 2020  d = True.       
-00005cd0: 2020 2020 2069 6e69 7469 616c 5f73 7461       initial_sta
-00005ce0: 7465 2e61 7070 656e 6428 0a20 2020 2020  te.append(.     
-00005cf0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00005d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d10: 2022 7479 7065 223a 2022 6d2e 726f 6f6d   "type": "m.room
-00005d20: 2e65 6e63 7279 7074 696f 6e22 2c0a 2020  .encryption",.  
-00005d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d40: 2020 2263 6f6e 7465 6e74 223a 2073 656c    "content": sel
-00005d50: 662e 6765 745f 656e 6372 7970 7469 6f6e  f.get_encryption
-00005d60: 5f73 7461 7465 5f65 7665 6e74 5f6a 736f  _state_event_jso
-00005d70: 6e28 292c 0a20 2020 2020 2020 2020 2020  n(),.           
-00005d80: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00005d90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00005da0: 2069 6620 7365 6c66 2e69 735f 6469 7265   if self.is_dire
-00005db0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-00005dc0: 2020 2020 696e 7669 7465 732e 6170 7065      invites.appe
-00005dd0: 6e64 2873 656c 662e 617a 2e62 6f74 5f6d  nd(self.az.bot_m
-00005de0: 7869 6429 0a0a 2020 2020 2020 2020 696e  xid)..        in
-00005df0: 666f 203d 2061 7761 6974 2073 656c 662e  fo = await self.
-00005e00: 7570 6461 7465 5f69 6e66 6f28 736f 7572  update_info(sour
-00005e10: 6365 3d73 6f75 7263 652c 2069 6e66 6f3d  ce=source, info=
-00005e20: 696e 666f 290a 2020 2020 2020 2020 6966  info).        if
-00005e30: 206e 6f74 2069 6e66 6f3a 0a20 2020 2020   not info:.     
-00005e40: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-00005e50: 6465 6275 6728 2275 7064 6174 655f 696e  debug("update_in
-00005e60: 666f 2829 2064 6964 6e27 7420 7265 7475  fo() didn't retu
-00005e70: 726e 2069 6e66 6f2c 2063 616e 6365 6c6c  rn info, cancell
-00005e80: 696e 6720 726f 6f6d 2063 7265 6174 696f  ing room creatio
-00005e90: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
-00005ea0: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-00005eb0: 2020 2020 2069 6620 7365 6c66 2e65 6e63       if self.enc
-00005ec0: 7279 7074 6564 206f 7220 6e6f 7420 7365  rypted or not se
-00005ed0: 6c66 2e69 735f 6469 7265 6374 3a0a 2020  lf.is_direct:.  
-00005ee0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
-00005ef0: 2073 656c 662e 6e61 6d65 0a20 2020 2020   self.name.     
-00005f00: 2020 2020 2020 2069 6e69 7469 616c 5f73         initial_s
-00005f10: 7461 7465 2e61 7070 656e 6428 0a20 2020  tate.append(.   
-00005f20: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00005f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f40: 2020 2022 7479 7065 223a 2073 7472 2845     "type": str(E
-00005f50: 7665 6e74 5479 7065 2e52 4f4f 4d5f 4156  ventType.ROOM_AV
-00005f60: 4154 4152 292c 0a20 2020 2020 2020 2020  ATAR),.         
-00005f70: 2020 2020 2020 2020 2020 2022 636f 6e74             "cont
-00005f80: 656e 7422 3a20 7b22 7572 6c22 3a20 7365  ent": {"url": se
-00005f90: 6c66 2e61 7661 7461 725f 7572 6c7d 2c0a  lf.avatar_url},.
-00005fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fb0: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
-00005fc0: 0a20 2020 2020 2020 2023 2057 6520 6c6f  .        # We lo
-00005fd0: 636b 2062 6163 6b66 696c 6c20 6c6f 636b  ck backfill lock
-00005fe0: 2068 6572 6520 736f 2061 6e79 206d 6573   here so any mes
-00005ff0: 7361 6765 7320 7468 6174 2063 6f6d 6520  sages that come 
-00006000: 6265 7477 6565 6e20 7468 6520 726f 6f6d  between the room
-00006010: 2062 6569 6e67 2063 7265 6174 6564 0a20   being created. 
-00006020: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
-00006030: 2069 6e69 7469 616c 2062 6163 6b66 696c   initial backfil
-00006040: 6c20 6669 6e69 7368 696e 6720 776f 756c  l finishing woul
-00006050: 646e 2774 2062 6520 6272 6964 6765 6420  dn't be bridged 
-00006060: 6265 666f 7265 2074 6865 2062 6163 6b66  before the backf
-00006070: 696c 6c20 6d65 7373 6167 6573 2e0a 2020  ill messages..  
-00006080: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00006090: 6261 636b 6669 6c6c 5f6c 6f63 6b3a 0a20  backfill_lock:. 
-000060a0: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-000060b0: 696f 6e5f 636f 6e74 656e 7420 3d20 7b7d  ion_content = {}
-000060c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000060d0: 6e6f 7420 7365 6c66 2e63 6f6e 6669 675b  not self.config[
-000060e0: 2262 7269 6467 652e 6665 6465 7261 7465  "bridge.federate
-000060f0: 5f72 6f6f 6d73 225d 3a0a 2020 2020 2020  _rooms"]:.      
-00006100: 2020 2020 2020 2020 2020 6372 6561 7469            creati
-00006110: 6f6e 5f63 6f6e 7465 6e74 5b22 6d2e 6665  on_content["m.fe
-00006120: 6465 7261 7465 225d 203d 2046 616c 7365  derate"] = False
-00006130: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006140: 662e 6d78 6964 203d 2061 7761 6974 2073  f.mxid = await s
-00006150: 656c 662e 6d61 696e 5f69 6e74 656e 742e  elf.main_intent.
-00006160: 6372 6561 7465 5f72 6f6f 6d28 0a20 2020  create_room(.   
-00006170: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-00006180: 653d 6e61 6d65 2c0a 2020 2020 2020 2020  e=name,.        
-00006190: 2020 2020 2020 2020 6973 5f64 6972 6563          is_direc
-000061a0: 743d 7365 6c66 2e69 735f 6469 7265 6374  t=self.is_direct
-000061b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000061c0: 2020 696e 6974 6961 6c5f 7374 6174 653d    initial_state=
-000061d0: 696e 6974 6961 6c5f 7374 6174 652c 0a20  initial_state,. 
-000061e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000061f0: 6e76 6974 6565 733d 696e 7669 7465 732c  nvitees=invites,
-00006200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006210: 2063 7265 6174 696f 6e5f 636f 6e74 656e   creation_conten
-00006220: 743d 6372 6561 7469 6f6e 5f63 6f6e 7465  t=creation_conte
-00006230: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00006240: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00006250: 206e 6f74 2073 656c 662e 6d78 6964 3a0a   not self.mxid:.
-00006260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006270: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-00006280: 2246 6169 6c65 6420 746f 2063 7265 6174  "Failed to creat
-00006290: 6520 726f 6f6d 3a20 6e6f 206d 7869 6420  e room: no mxid 
-000062a0: 7265 7475 726e 6564 2229 0a0a 2020 2020  returned")..    
-000062b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000062c0: 656e 6372 7970 7465 6420 616e 6420 7365  encrypted and se
-000062d0: 6c66 2e6d 6174 7269 782e 6532 6565 2061  lf.matrix.e2ee a
-000062e0: 6e64 2073 656c 662e 6973 5f64 6972 6563  nd self.is_direc
-000062f0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00006300: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00006310: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00006320: 7420 7365 6c66 2e61 7a2e 696e 7465 6e74  t self.az.intent
-00006330: 2e65 6e73 7572 655f 6a6f 696e 6564 2873  .ensure_joined(s
-00006340: 656c 662e 6d78 6964 290a 2020 2020 2020  elf.mxid).      
-00006350: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00006360: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006380: 7365 6c66 2e6c 6f67 2e77 6172 6e69 6e67  self.log.warning
-00006390: 2866 2246 6169 6c65 6420 746f 2061 6464  (f"Failed to add
-000063a0: 2062 7269 6467 6520 626f 7420 746f 206e   bridge bot to n
-000063b0: 6577 2070 7269 7661 7465 2063 6861 7420  ew private chat 
-000063c0: 7b73 656c 662e 6d78 6964 7d22 290a 0a20  {self.mxid}").. 
-000063d0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000063e0: 2073 656c 662e 7361 7665 2829 0a20 2020   self.save().   
-000063f0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00006400: 672e 6465 6275 6728 6622 4d61 7472 6978  g.debug(f"Matrix
-00006410: 2072 6f6f 6d20 6372 6561 7465 643a 207b   room created: {
-00006420: 7365 6c66 2e6d 7869 647d 2229 0a20 2020  self.mxid}").   
-00006430: 2020 2020 2020 2020 2073 656c 662e 6279           self.by
-00006440: 5f6d 7869 645b 7365 6c66 2e6d 7869 645d  _mxid[self.mxid]
-00006450: 203d 2073 656c 660a 0a20 2020 2020 2020   = self..       
-00006460: 2020 2020 2070 7570 7065 7420 3d20 6177       puppet = aw
-00006470: 6169 7420 702e 5075 7070 6574 2e67 6574  ait p.Puppet.get
-00006480: 5f62 795f 6375 7374 6f6d 5f6d 7869 6428  _by_custom_mxid(
-00006490: 736f 7572 6365 2e6d 7869 6429 0a20 2020  source.mxid).   
-000064a0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-000064b0: 656c 662e 6d61 696e 5f69 6e74 656e 742e  elf.main_intent.
-000064c0: 696e 7669 7465 5f75 7365 7228 0a20 2020  invite_user(.   
-000064d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000064e0: 662e 6d78 6964 2c20 736f 7572 6365 2e6d  f.mxid, source.m
-000064f0: 7869 642c 2065 7874 7261 5f63 6f6e 7465  xid, extra_conte
-00006500: 6e74 3d73 656c 662e 5f67 6574 5f69 6e76  nt=self._get_inv
-00006510: 6974 655f 636f 6e74 656e 7428 7075 7070  ite_content(pupp
-00006520: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
-00006530: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00006540: 2070 7570 7065 743a 0a20 2020 2020 2020   puppet:.       
-00006550: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00006560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006570: 2020 6966 2073 656c 662e 6973 5f64 6972    if self.is_dir
-00006580: 6563 743a 0a20 2020 2020 2020 2020 2020  ect:.           
-00006590: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000065a0: 6974 2073 6f75 7263 652e 7570 6461 7465  it source.update
-000065b0: 5f64 6972 6563 745f 6368 6174 7328 7b73  _direct_chats({s
-000065c0: 656c 662e 6d61 696e 5f69 6e74 656e 742e  elf.main_intent.
-000065d0: 6d78 6964 3a20 5b73 656c 662e 6d78 6964  mxid: [self.mxid
-000065e0: 5d7d 290a 2020 2020 2020 2020 2020 2020  ]}).            
-000065f0: 2020 2020 2020 2020 6177 6169 7420 7075          await pu
-00006600: 7070 6574 2e69 6e74 656e 742e 6a6f 696e  ppet.intent.join
-00006610: 5f72 6f6f 6d5f 6279 5f69 6428 7365 6c66  _room_by_id(self
-00006620: 2e6d 7869 6429 0a20 2020 2020 2020 2020  .mxid).         
-00006630: 2020 2020 2020 2065 7863 6570 7420 4d61         except Ma
-00006640: 7472 6978 4572 726f 723a 0a20 2020 2020  trixError:.     
-00006650: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006660: 656c 662e 6c6f 672e 6465 6275 6728 0a20  elf.log.debug(. 
-00006670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006680: 2020 2020 2020 2022 4661 696c 6564 2074         "Failed t
-00006690: 6f20 6a6f 696e 2063 7573 746f 6d20 7075  o join custom pu
-000066a0: 7070 6574 2069 6e74 6f20 6e65 776c 7920  ppet into newly 
-000066b0: 6372 6561 7465 6420 706f 7274 616c 222c  created portal",
-000066c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000066d0: 2020 2020 2020 2020 2065 7863 5f69 6e66           exc_inf
-000066e0: 6f3d 5472 7565 2c0a 2020 2020 2020 2020  o=True,.        
-000066f0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00006700: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00006710: 7420 7365 6c66 2e69 735f 6469 7265 6374  t self.is_direct
-00006720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006730: 2020 6177 6169 7420 7365 6c66 2e5f 7570    await self._up
-00006740: 6461 7465 5f70 6172 7469 6369 7061 6e74  date_participant
-00006750: 7328 736f 7572 6365 2c20 696e 666f 290a  s(source, info).
-00006760: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00006770: 6974 2055 7365 7250 6f72 7461 6c28 0a20  it UserPortal(. 
-00006780: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00006790: 7365 723d 736f 7572 6365 2e66 6269 642c  ser=source.fbid,
-000067a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000067b0: 2070 6f72 7461 6c3d 7365 6c66 2e66 6269   portal=self.fbi
-000067c0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000067d0: 2020 2070 6f72 7461 6c5f 7265 6365 6976     portal_receiv
-000067e0: 6572 3d73 656c 662e 6662 5f72 6563 6569  er=self.fb_recei
-000067f0: 7665 722c 0a20 2020 2020 2020 2020 2020  ver,.           
-00006800: 2029 2e75 7073 6572 7428 290a 0a20 2020   ).upsert()..   
-00006810: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00006820: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-00006830: 6169 7420 7365 6c66 2e62 6163 6b66 696c  ait self.backfil
-00006840: 6c28 736f 7572 6365 2c20 6973 5f69 6e69  l(source, is_ini
-00006850: 7469 616c 3d54 7275 652c 2074 6872 6561  tial=True, threa
-00006860: 643d 696e 666f 290a 2020 2020 2020 2020  d=info).        
-00006870: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00006880: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00006890: 2020 2020 2020 7365 6c66 2e6c 6f67 2e65        self.log.e
-000068a0: 7863 6570 7469 6f6e 2822 4661 696c 6564  xception("Failed
-000068b0: 2074 6f20 6261 636b 6669 6c6c 206e 6577   to backfill new
-000068c0: 2070 6f72 7461 6c22 290a 0a20 2020 2020   portal")..     
-000068d0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-000068e0: 662e 5f73 796e 635f 7265 6164 5f72 6563  f._sync_read_rec
-000068f0: 6569 7074 7328 696e 666f 2e72 6561 645f  eipts(info.read_
-00006900: 7265 6365 6970 7473 2e6e 6f64 6573 2c20  receipts.nodes, 
-00006910: 7265 6163 7469 6f6e 733d 5472 7565 290a  reactions=True).
-00006920: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00006930: 7365 6c66 2e6d 7869 640a 0a20 2020 2023  self.mxid..    #
-00006940: 2065 6e64 7265 6769 6f6e 0a20 2020 2023   endregion.    #
-00006950: 2072 6567 696f 6e20 4d61 7472 6978 2065   region Matrix e
-00006960: 7665 6e74 2068 616e 646c 696e 670a 0a20  vent handling.. 
-00006970: 2020 2064 6566 2072 6571 7569 7265 5f73     def require_s
-00006980: 656e 645f 6c6f 636b 2873 656c 662c 2075  end_lock(self, u
-00006990: 7365 725f 6964 3a20 696e 7429 202d 3e20  ser_id: int) -> 
-000069a0: 6173 796e 6369 6f2e 4c6f 636b 3a0a 2020  asyncio.Lock:.  
-000069b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000069c0: 2020 2020 2020 206c 6f63 6b20 3d20 7365         lock = se
-000069d0: 6c66 2e5f 7365 6e64 5f6c 6f63 6b73 5b75  lf._send_locks[u
-000069e0: 7365 725f 6964 5d0a 2020 2020 2020 2020  ser_id].        
-000069f0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00006a00: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
-00006a10: 6b20 3d20 6173 796e 6369 6f2e 4c6f 636b  k = asyncio.Lock
-00006a20: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-00006a30: 656c 662e 5f73 656e 645f 6c6f 636b 735b  elf._send_locks[
-00006a40: 7573 6572 5f69 645d 203d 206c 6f63 6b0a  user_id] = lock.
-00006a50: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-00006a60: 6f63 6b0a 0a20 2020 2064 6566 206f 7074  ock..    def opt
-00006a70: 696f 6e61 6c5f 7365 6e64 5f6c 6f63 6b28  ional_send_lock(
-00006a80: 7365 6c66 2c20 7573 6572 5f69 643a 2069  self, user_id: i
-00006a90: 6e74 2920 2d3e 2061 7379 6e63 696f 2e4c  nt) -> asyncio.L
-00006aa0: 6f63 6b20 7c20 4661 6b65 4c6f 636b 3a0a  ock | FakeLock:.
-00006ab0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00006ac0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00006ad0: 7365 6c66 2e5f 7365 6e64 5f6c 6f63 6b73  self._send_locks
-00006ae0: 5b75 7365 725f 6964 5d0a 2020 2020 2020  [user_id].      
-00006af0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00006b00: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
-00006b10: 6173 730a 2020 2020 2020 2020 7265 7475  ass.        retu
-00006b20: 726e 2073 656c 662e 5f6e 6f6f 705f 6c6f  rn self._noop_lo
-00006b30: 636b 0a0a 2020 2020 6173 796e 6320 6465  ck..    async de
-00006b40: 6620 5f73 656e 645f 6465 6c69 7665 7279  f _send_delivery
-00006b50: 5f72 6563 6569 7074 2873 656c 662c 2065  _receipt(self, e
-00006b60: 7665 6e74 5f69 643a 2045 7665 6e74 4944  vent_id: EventID
-00006b70: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00006b80: 2020 2069 6620 6576 656e 745f 6964 2061     if event_id a
-00006b90: 6e64 2073 656c 662e 636f 6e66 6967 5b22  nd self.config["
-00006ba0: 6272 6964 6765 2e64 656c 6976 6572 795f  bridge.delivery_
-00006bb0: 7265 6365 6970 7473 225d 3a0a 2020 2020  receipts"]:.    
-00006bc0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00006bd0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00006be0: 6974 2073 656c 662e 617a 2e69 6e74 656e  it self.az.inten
-00006bf0: 742e 6d61 726b 5f72 6561 6428 7365 6c66  t.mark_read(self
-00006c00: 2e6d 7869 642c 2065 7665 6e74 5f69 6429  .mxid, event_id)
-00006c10: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00006c20: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006c40: 656c 662e 6c6f 672e 6578 6365 7074 696f  elf.log.exceptio
-00006c50: 6e28 6622 4661 696c 6564 2074 6f20 7365  n(f"Failed to se
-00006c60: 6e64 2064 656c 6976 6572 7920 7265 6365  nd delivery rece
-00006c70: 6970 7420 666f 7220 7b65 7665 6e74 5f69  ipt for {event_i
-00006c80: 647d 2229 0a0a 2020 2020 6173 796e 6320  d}")..    async 
-00006c90: 6465 6620 5f73 656e 645f 6272 6964 6765  def _send_bridge
-00006ca0: 5f73 7563 6365 7373 280a 2020 2020 2020  _success(.      
-00006cb0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00006cc0: 7365 6e64 6572 3a20 752e 5573 6572 2c0a  sender: u.User,.
-00006cd0: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
-00006ce0: 3a20 4576 656e 7449 442c 0a20 2020 2020  : EventID,.     
-00006cf0: 2020 2065 7665 6e74 5f74 7970 653a 2045     event_type: E
-00006d00: 7665 6e74 5479 7065 2c0a 2020 2020 2020  ventType,.      
-00006d10: 2020 6d73 6774 7970 653a 204d 6573 7361    msgtype: Messa
-00006d20: 6765 5479 7065 207c 204e 6f6e 6520 3d20  geType | None = 
-00006d30: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 204e  None,.    ) -> N
-00006d40: 6f6e 653a 0a20 2020 2020 2020 2073 656e  one:.        sen
-00006d50: 6465 722e 7365 6e64 5f72 656d 6f74 655f  der.send_remote_
-00006d60: 6368 6563 6b70 6f69 6e74 280a 2020 2020  checkpoint(.    
-00006d70: 2020 2020 2020 2020 7374 6174 7573 3d4d          status=M
-00006d80: 6573 7361 6765 5365 6e64 4368 6563 6b70  essageSendCheckp
-00006d90: 6f69 6e74 5374 6174 7573 2e53 5543 4345  ointStatus.SUCCE
-00006da0: 5353 2c0a 2020 2020 2020 2020 2020 2020  SS,.            
-00006db0: 6576 656e 745f 6964 3d65 7665 6e74 5f69  event_id=event_i
-00006dc0: 642c 0a20 2020 2020 2020 2020 2020 2072  d,.            r
-00006dd0: 6f6f 6d5f 6964 3d73 656c 662e 6d78 6964  oom_id=self.mxid
-00006de0: 2c0a 2020 2020 2020 2020 2020 2020 6576  ,.            ev
-00006df0: 656e 745f 7479 7065 3d65 7665 6e74 5f74  ent_type=event_t
-00006e00: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-00006e10: 206d 6573 7361 6765 5f74 7970 653d 6d73   message_type=ms
-00006e20: 6774 7970 652c 0a20 2020 2020 2020 2029  gtype,.        )
-00006e30: 0a20 2020 2020 2020 2061 7379 6e63 696f  .        asyncio
-00006e40: 2e63 7265 6174 655f 7461 736b 2873 656c  .create_task(sel
-00006e50: 662e 5f73 656e 645f 6d65 7373 6167 655f  f._send_message_
-00006e60: 7374 6174 7573 2865 7665 6e74 5f69 642c  status(event_id,
-00006e70: 2065 7272 3d4e 6f6e 6529 290a 2020 2020   err=None)).    
-00006e80: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-00006e90: 7365 6e64 5f64 656c 6976 6572 795f 7265  send_delivery_re
-00006ea0: 6365 6970 7428 6576 656e 745f 6964 290a  ceipt(event_id).
-00006eb0: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
-00006ec0: 7365 6e64 5f62 7269 6467 655f 6572 726f  send_bridge_erro
-00006ed0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-00006ee0: 0a20 2020 2020 2020 2073 656e 6465 723a  .        sender:
-00006ef0: 2075 2e55 7365 722c 0a20 2020 2020 2020   u.User,.       
-00006f00: 2065 7272 3a20 4578 6365 7074 696f 6e2c   err: Exception,
-00006f10: 0a20 2020 2020 2020 2065 7665 6e74 5f69  .        event_i
-00006f20: 643a 2045 7665 6e74 4944 2c0a 2020 2020  d: EventID,.    
-00006f30: 2020 2020 6576 656e 745f 7479 7065 3a20      event_type: 
-00006f40: 4576 656e 7454 7970 652c 0a20 2020 2020  EventType,.     
-00006f50: 2020 206d 6573 7361 6765 5f74 7970 653a     message_type:
-00006f60: 204d 6573 7361 6765 5479 7065 207c 204e   MessageType | N
-00006f70: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00006f80: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00006f90: 2020 2073 656e 6465 722e 7365 6e64 5f72     sender.send_r
-00006fa0: 656d 6f74 655f 6368 6563 6b70 6f69 6e74  emote_checkpoint
-00006fb0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00006fc0: 6c66 2e5f 7374 6174 7573 5f66 726f 6d5f  lf._status_from_
-00006fd0: 6578 6365 7074 696f 6e28 6572 7229 2c0a  exception(err),.
-00006fe0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00006ff0: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
-00007000: 2020 7365 6c66 2e6d 7869 642c 0a20 2020    self.mxid,.   
-00007010: 2020 2020 2020 2020 2065 7665 6e74 5f74           event_t
-00007020: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-00007030: 206d 6573 7361 6765 5f74 7970 653d 6d65   message_type=me
-00007040: 7373 6167 655f 7479 7065 2c0a 2020 2020  ssage_type,.    
-00007050: 2020 2020 2020 2020 6572 726f 723d 6572          error=er
-00007060: 722c 0a20 2020 2020 2020 2029 0a0a 2020  r,.        )..  
-00007070: 2020 2020 2020 7365 6e64 5f6e 6f74 6963        send_notic
-00007080: 6520 3d20 6e6f 7420 6973 696e 7374 616e  e = not isinstan
-00007090: 6365 2865 7272 2c20 4e6f 7449 6d70 6c65  ce(err, NotImple
-000070a0: 6d65 6e74 6564 4572 726f 7229 0a20 2020  mentedError).   
-000070b0: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
-000070c0: 6669 675b 2262 7269 6467 652e 6465 6c69  fig["bridge.deli
-000070d0: 7665 7279 5f65 7272 6f72 5f72 6570 6f72  very_error_repor
-000070e0: 7473 225d 2061 6e64 2073 656e 645f 6e6f  ts"] and send_no
-000070f0: 7469 6365 3a0a 2020 2020 2020 2020 2020  tice:.          
-00007100: 2020 6576 656e 745f 7479 7065 5f73 7472    event_type_str
-00007110: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00007120: 2020 2020 2045 7665 6e74 5479 7065 2e52       EventType.R
-00007130: 4541 4354 494f 4e3a 2022 7265 6163 7469  EACTION: "reacti
-00007140: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-00007150: 2020 2020 2045 7665 6e74 5479 7065 2e52       EventType.R
-00007160: 4f4f 4d5f 5245 4441 4354 494f 4e3a 2022  OOM_REDACTION: "
-00007170: 7265 6461 6374 696f 6e22 2c0a 2020 2020  redaction",.    
-00007180: 2020 2020 2020 2020 7d2e 6765 7428 6576          }.get(ev
-00007190: 656e 745f 7479 7065 2c20 226d 6573 7361  ent_type, "messa
-000071a0: 6765 2229 0a20 2020 2020 2020 2020 2020  ge").           
-000071b0: 2061 7761 6974 2073 656c 662e 5f73 656e   await self._sen
-000071c0: 645f 6d65 7373 6167 6528 0a20 2020 2020  d_message(.     
-000071d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000071e0: 6d61 696e 5f69 6e74 656e 742c 0a20 2020  main_intent,.   
-000071f0: 2020 2020 2020 2020 2020 2020 2054 6578               Tex
-00007200: 744d 6573 7361 6765 4576 656e 7443 6f6e  tMessageEventCon
-00007210: 7465 6e74 280a 2020 2020 2020 2020 2020  tent(.          
-00007220: 2020 2020 2020 2020 2020 6d73 6774 7970            msgtyp
-00007230: 653d 4d65 7373 6167 6554 7970 652e 4e4f  e=MessageType.NO
-00007240: 5449 4345 2c0a 2020 2020 2020 2020 2020  TICE,.          
-00007250: 2020 2020 2020 2020 2020 626f 6479 3d66            body=f
-00007260: 225c 7532 3661 3020 596f 7572 207b 6576  "\u26a0 Your {ev
-00007270: 656e 745f 7479 7065 5f73 7472 7d20 6d61  ent_type_str} ma
-00007280: 7920 6e6f 7420 6861 7665 2062 6565 6e20  y not have been 
-00007290: 6272 6964 6765 643a 207b 7374 7228 6572  bridged: {str(er
-000072a0: 7229 7d22 2c0a 2020 2020 2020 2020 2020  r)}",.          
-000072b0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-000072c0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-000072d0: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
-000072e0: 736b 2873 656c 662e 5f73 656e 645f 6d65  sk(self._send_me
-000072f0: 7373 6167 655f 7374 6174 7573 2865 7665  ssage_status(eve
-00007300: 6e74 5f69 642c 2065 7272 2929 0a0a 2020  nt_id, err))..  
-00007310: 2020 6173 796e 6320 6465 6620 5f73 656e    async def _sen
-00007320: 645f 6d65 7373 6167 655f 7374 6174 7573  d_message_status
-00007330: 2873 656c 662c 2065 7665 6e74 5f69 643a  (self, event_id:
-00007340: 2045 7665 6e74 4944 2c20 6572 723a 2045   EventID, err: E
-00007350: 7863 6570 7469 6f6e 207c 204e 6f6e 6529  xception | None)
-00007360: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00007370: 2020 6966 206e 6f74 2073 656c 662e 636f    if not self.co
-00007380: 6e66 6967 5b22 6272 6964 6765 2e6d 6573  nfig["bridge.mes
-00007390: 7361 6765 5f73 7461 7475 735f 6576 656e  sage_status_even
-000073a0: 7473 225d 3a0a 2020 2020 2020 2020 2020  ts"]:.          
-000073b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-000073c0: 2069 6e74 656e 7420 3d20 7365 6c66 2e61   intent = self.a
-000073d0: 7a2e 696e 7465 6e74 2069 6620 7365 6c66  z.intent if self
-000073e0: 2e65 6e63 7279 7074 6564 2065 6c73 6520  .encrypted else 
-000073f0: 7365 6c66 2e6d 6169 6e5f 696e 7465 6e74  self.main_intent
-00007400: 0a20 2020 2020 2020 2073 7461 7475 7320  .        status 
-00007410: 3d20 4265 6570 6572 4d65 7373 6167 6553  = BeeperMessageS
-00007420: 7461 7475 7345 7665 6e74 436f 6e74 656e  tatusEventConten
-00007430: 7428 0a20 2020 2020 2020 2020 2020 206e  t(.            n
-00007440: 6574 776f 726b 3d73 656c 662e 6272 6964  etwork=self.brid
-00007450: 6765 5f69 6e66 6f5f 7374 6174 655f 6b65  ge_info_state_ke
-00007460: 792c 0a20 2020 2020 2020 2020 2020 2072  y,.            r
-00007470: 656c 6174 6573 5f74 6f3d 5265 6c61 7465  elates_to=Relate
-00007480: 7354 6f28 0a20 2020 2020 2020 2020 2020  sTo(.           
-00007490: 2020 2020 2072 656c 5f74 7970 653d 5265       rel_type=Re
-000074a0: 6c61 7469 6f6e 5479 7065 2e52 4546 4552  lationType.REFER
-000074b0: 454e 4345 2c0a 2020 2020 2020 2020 2020  ENCE,.          
-000074c0: 2020 2020 2020 6576 656e 745f 6964 3d65        event_id=e
-000074d0: 7665 6e74 5f69 642c 0a20 2020 2020 2020  vent_id,.       
-000074e0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-000074f0: 290a 2020 2020 2020 2020 6966 2065 7272  ).        if err
-00007500: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00007510: 6174 7573 2e73 7461 7475 7320 3d20 4d65  atus.status = Me
-00007520: 7373 6167 6553 7461 7475 732e 5245 5452  ssageStatus.RETR
-00007530: 4941 424c 450a 2020 2020 2020 2020 2020  IABLE.          
-00007540: 2020 7374 6174 7573 2e72 6561 736f 6e20    status.reason 
-00007550: 3d20 4d65 7373 6167 6553 7461 7475 7352  = MessageStatusR
-00007560: 6561 736f 6e2e 4745 4e45 5249 435f 4552  eason.GENERIC_ER
-00007570: 524f 520a 2020 2020 2020 2020 2020 2020  ROR.            
-00007580: 7374 6174 7573 2e65 7272 6f72 203d 2073  status.error = s
-00007590: 7472 2865 7272 290a 2020 2020 2020 2020  tr(err).        
-000075a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000075b0: 6528 6572 722c 204e 6f74 496d 706c 656d  e(err, NotImplem
-000075c0: 656e 7465 6445 7272 6f72 293a 0a20 2020  entedError):.   
-000075d0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-000075e0: 7475 732e 7374 6174 7573 203d 204d 6573  tus.status = Mes
-000075f0: 7361 6765 5374 6174 7573 2e46 4149 4c0a  sageStatus.FAIL.
-00007600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007610: 7374 6174 7573 2e72 6561 736f 6e20 3d20  status.reason = 
-00007620: 4d65 7373 6167 6553 7461 7475 7352 6561  MessageStatusRea
-00007630: 736f 6e2e 554e 5355 5050 4f52 5445 440a  son.UNSUPPORTED.
-00007640: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007650: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00007660: 2e73 7461 7475 7320 3d20 4d65 7373 6167  .status = Messag
-00007670: 6553 7461 7475 732e 5355 4343 4553 530a  eStatus.SUCCESS.
-00007680: 2020 2020 2020 2020 7374 6174 7573 2e66          status.f
-00007690: 696c 6c5f 6c65 6761 6379 5f62 6f6f 6c65  ill_legacy_boole
-000076a0: 616e 7328 290a 0a20 2020 2020 2020 2061  ans()..        a
-000076b0: 7761 6974 2069 6e74 656e 742e 7365 6e64  wait intent.send
-000076c0: 5f6d 6573 7361 6765 5f65 7665 6e74 280a  _message_event(.
-000076d0: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
-000076e0: 5f69 643d 7365 6c66 2e6d 7869 642c 0a20  _id=self.mxid,. 
-000076f0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00007700: 5f74 7970 653d 4576 656e 7454 7970 652e  _type=EventType.
-00007710: 4245 4550 4552 5f4d 4553 5341 4745 5f53  BEEPER_MESSAGE_S
-00007720: 5441 5455 532c 0a20 2020 2020 2020 2020  TATUS,.         
-00007730: 2020 2063 6f6e 7465 6e74 3d73 7461 7475     content=statu
-00007740: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00007750: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-00007760: 2020 2020 6465 6620 5f73 7461 7475 735f      def _status_
-00007770: 6672 6f6d 5f65 7863 6570 7469 6f6e 2865  from_exception(e
-00007780: 3a20 4578 6365 7074 696f 6e29 202d 3e20  : Exception) -> 
-00007790: 4d65 7373 6167 6553 656e 6443 6865 636b  MessageSendCheck
-000077a0: 706f 696e 7453 7461 7475 733a 0a20 2020  pointStatus:.   
-000077b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-000077c0: 6365 2865 2c20 4e6f 7449 6d70 6c65 6d65  ce(e, NotImpleme
-000077d0: 6e74 6564 4572 726f 7229 3a0a 2020 2020  ntedError):.    
-000077e0: 2020 2020 2020 2020 7265 7475 726e 204d          return M
-000077f0: 6573 7361 6765 5365 6e64 4368 6563 6b70  essageSendCheckp
-00007800: 6f69 6e74 5374 6174 7573 2e55 4e53 5550  ointStatus.UNSUP
-00007810: 504f 5254 4544 0a20 2020 2020 2020 2072  PORTED.        r
-00007820: 6574 7572 6e20 4d65 7373 6167 6553 656e  eturn MessageSen
-00007830: 6443 6865 636b 706f 696e 7453 7461 7475  dCheckpointStatu
-00007840: 732e 5045 524d 5f46 4149 4c55 5245 0a0a  s.PERM_FAILURE..
-00007850: 2020 2020 6173 796e 6320 6465 6620 6861      async def ha
-00007860: 6e64 6c65 5f6d 6174 7269 785f 6d65 7373  ndle_matrix_mess
-00007870: 6167 6528 0a20 2020 2020 2020 2073 656c  age(.        sel
-00007880: 662c 2073 656e 6465 723a 2075 2e55 7365  f, sender: u.Use
-00007890: 722c 206d 6573 7361 6765 3a20 4d65 7373  r, message: Mess
-000078a0: 6167 6545 7665 6e74 436f 6e74 656e 742c  ageEventContent,
-000078b0: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
-000078c0: 4944 0a20 2020 2029 202d 3e20 4e6f 6e65  ID.    ) -> None
-000078d0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-000078e0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000078f0: 2073 656c 662e 5f68 616e 646c 655f 6d61   self._handle_ma
-00007900: 7472 6978 5f6d 6573 7361 6765 2873 656e  trix_message(sen
-00007910: 6465 722c 206d 6573 7361 6765 2c20 6576  der, message, ev
-00007920: 656e 745f 6964 290a 2020 2020 2020 2020  ent_id).        
-00007930: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00007940: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00007950: 2020 2073 656c 662e 6c6f 672e 6578 6365     self.log.exce
-00007960: 7074 696f 6e28 6622 4661 696c 6564 2074  ption(f"Failed t
-00007970: 6f20 6861 6e64 6c65 204d 6174 7269 7820  o handle Matrix 
-00007980: 6576 656e 7420 7b65 7665 6e74 5f69 647d  event {event_id}
-00007990: 2229 0a20 2020 2020 2020 2020 2020 2061  ").            a
-000079a0: 7761 6974 2073 656c 662e 5f73 656e 645f  wait self._send_
-000079b0: 6272 6964 6765 5f65 7272 6f72 280a 2020  bridge_error(.  
-000079c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000079d0: 6e64 6572 2c20 652c 2065 7665 6e74 5f69  nder, e, event_i
-000079e0: 642c 2045 7665 6e74 5479 7065 2e52 4f4f  d, EventType.ROO
-000079f0: 4d5f 4d45 5353 4147 452c 206d 6573 7361  M_MESSAGE, messa
-00007a00: 6765 2e6d 7367 7479 7065 0a20 2020 2020  ge.msgtype.     
-00007a10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007a20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00007a30: 2020 2061 7761 6974 2073 656c 662e 5f73     await self._s
-00007a40: 656e 645f 6272 6964 6765 5f73 7563 6365  end_bridge_succe
-00007a50: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
-00007a60: 2020 2020 7365 6e64 6572 2c20 6576 656e      sender, even
-00007a70: 745f 6964 2c20 4576 656e 7454 7970 652e  t_id, EventType.
-00007a80: 524f 4f4d 5f4d 4553 5341 4745 2c20 6d65  ROOM_MESSAGE, me
-00007a90: 7373 6167 652e 6d73 6774 7970 650a 2020  ssage.msgtype.  
-00007aa0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00007ab0: 2061 7379 6e63 2064 6566 205f 6861 6e64   async def _hand
-00007ac0: 6c65 5f6d 6174 7269 785f 6d65 7373 6167  le_matrix_messag
-00007ad0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-00007ae0: 206f 7269 675f 7365 6e64 6572 3a20 752e   orig_sender: u.
-00007af0: 5573 6572 2c20 6d65 7373 6167 653a 204d  User, message: M
-00007b00: 6573 7361 6765 4576 656e 7443 6f6e 7465  essageEventConte
-00007b10: 6e74 2c20 6576 656e 745f 6964 3a20 4576  nt, event_id: Ev
-00007b20: 656e 7449 440a 2020 2020 2920 2d3e 204e  entID.    ) -> N
-00007b30: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-00007b40: 6d65 7373 6167 652e 6765 745f 6564 6974  message.get_edit
-00007b50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00007b60: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
-00007b70: 6e74 6564 4572 726f 7228 2245 6469 7473  ntedError("Edits
-00007b80: 2061 7265 206e 6f74 2073 7570 706f 7274   are not support
-00007b90: 6564 2062 7920 7468 6520 4661 6365 626f  ed by the Facebo
-00007ba0: 6f6b 2062 7269 6467 652e 2229 0a20 2020  ok bridge.").   
-00007bb0: 2020 2020 2073 656e 6465 722c 2069 735f       sender, is_
-00007bc0: 7265 6c61 7920 3d20 6177 6169 7420 7365  relay = await se
-00007bd0: 6c66 2e67 6574 5f72 656c 6179 5f73 656e  lf.get_relay_sen
-00007be0: 6465 7228 6f72 6967 5f73 656e 6465 722c  der(orig_sender,
-00007bf0: 2066 226d 6573 7361 6765 207b 6576 656e   f"message {even
-00007c00: 745f 6964 7d22 290a 2020 2020 2020 2020  t_id}").        
-00007c10: 6966 206e 6f74 2073 656e 6465 723a 0a20  if not sender:. 
-00007c20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00007c30: 2045 7863 6570 7469 6f6e 2822 6e6f 7420   Exception("not 
-00007c40: 6c6f 6767 6564 2069 6e22 290a 2020 2020  logged in").    
-00007c50: 2020 2020 656c 6966 206e 6f74 2073 656e      elif not sen
-00007c60: 6465 722e 6d71 7474 3a0a 2020 2020 2020  der.mqtt:.      
-00007c70: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-00007c80: 7074 696f 6e28 226e 6f74 2063 6f6e 6e65  ption("not conne
-00007c90: 6374 6564 2074 6f20 4d51 5454 2229 0a20  cted to MQTT"). 
-00007ca0: 2020 2020 2020 2065 6c69 6620 6973 5f72         elif is_r
-00007cb0: 656c 6179 3a0a 2020 2020 2020 2020 2020  elay:.          
-00007cc0: 2020 6177 6169 7420 7365 6c66 2e61 7070    await self.app
-00007cd0: 6c79 5f72 656c 6179 5f6d 6573 7361 6765  ly_relay_message
-00007ce0: 5f66 6f72 6d61 7428 6f72 6967 5f73 656e  _format(orig_sen
-00007cf0: 6465 722c 206d 6573 7361 6765 290a 2020  der, message).  
-00007d00: 2020 2020 2020 6966 206d 6573 7361 6765        if message
-00007d10: 2e6d 7367 7479 7065 203d 3d20 4d65 7373  .msgtype == Mess
-00007d20: 6167 6554 7970 652e 5445 5854 206f 7220  ageType.TEXT or 
-00007d30: 6d65 7373 6167 652e 6d73 6774 7970 6520  message.msgtype 
-00007d40: 3d3d 204d 6573 7361 6765 5479 7065 2e4e  == MessageType.N
-00007d50: 4f54 4943 453a 0a20 2020 2020 2020 2020  OTICE:.         
-00007d60: 2020 2061 7761 6974 2073 656c 662e 5f68     await self._h
-00007d70: 616e 646c 655f 6d61 7472 6978 5f74 6578  andle_matrix_tex
-00007d80: 7428 6576 656e 745f 6964 2c20 7365 6e64  t(event_id, send
-00007d90: 6572 2c20 6d65 7373 6167 6529 0a20 2020  er, message).   
-00007da0: 2020 2020 2065 6c69 6620 6d65 7373 6167       elif messag
-00007db0: 652e 6d73 6774 7970 652e 6973 5f6d 6564  e.msgtype.is_med
-00007dc0: 6961 3a0a 2020 2020 2020 2020 2020 2020  ia:.            
-00007dd0: 6177 6169 7420 7365 6c66 2e5f 6861 6e64  await self._hand
-00007de0: 6c65 5f6d 6174 7269 785f 6d65 6469 6128  le_matrix_media(
-00007df0: 6576 656e 745f 6964 2c20 7365 6e64 6572  event_id, sender
-00007e00: 2c20 6d65 7373 6167 652c 2069 735f 7265  , message, is_re
-00007e10: 6c61 7929 0a20 2020 2020 2020 2065 6c73  lay).        els
-00007e20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00007e30: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-00007e40: 7465 6445 7272 6f72 2866 2255 6e73 7570  tedError(f"Unsup
-00007e50: 706f 7274 6564 206d 6573 7361 6765 2074  ported message t
-00007e60: 7970 6520 7b6d 6573 7361 6765 2e6d 7367  ype {message.msg
-00007e70: 7479 7065 7d22 290a 0a20 2020 2061 7379  type}")..    asy
-00007e80: 6e63 2064 6566 205f 6d61 6b65 5f64 626d  nc def _make_dbm
-00007e90: 2873 656c 662c 2073 656e 6465 723a 2075  (self, sender: u
-00007ea0: 2e55 7365 722c 2065 7665 6e74 5f69 643a  .User, event_id:
-00007eb0: 2045 7665 6e74 4944 2920 2d3e 2044 424d   EventID) -> DBM
-00007ec0: 6573 7361 6765 3a0a 2020 2020 2020 2020  essage:.        
-00007ed0: 6f74 6920 3d20 7365 6e64 6572 2e6d 7174  oti = sender.mqt
-00007ee0: 742e 6765 6e65 7261 7465 5f6f 6666 6c69  t.generate_offli
-00007ef0: 6e65 5f74 6872 6561 6469 6e67 5f69 6428  ne_threading_id(
-00007f00: 290a 2020 2020 2020 2020 6462 6d20 3d20  ).        dbm = 
-00007f10: 4442 4d65 7373 6167 6528 0a20 2020 2020  DBMessage(.     
-00007f20: 2020 2020 2020 206d 7869 643d 6576 656e         mxid=even
-00007f30: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
-00007f40: 2020 6d78 5f72 6f6f 6d3d 7365 6c66 2e6d    mx_room=self.m
-00007f50: 7869 642c 0a20 2020 2020 2020 2020 2020  xid,.           
-00007f60: 2066 625f 7478 6e5f 6964 3d6f 7469 2c0a   fb_txn_id=oti,.
-00007f70: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00007f80: 783d 302c 0a20 2020 2020 2020 2020 2020  x=0,.           
-00007f90: 2066 625f 6368 6174 3d73 656c 662e 6662   fb_chat=self.fb
-00007fa0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00007fb0: 6662 5f72 6563 6569 7665 723d 7365 6c66  fb_receiver=self
-00007fc0: 2e66 625f 7265 6365 6976 6572 2c0a 2020  .fb_receiver,.  
-00007fd0: 2020 2020 2020 2020 2020 6662 5f73 656e            fb_sen
-00007fe0: 6465 723d 7365 6e64 6572 2e66 6269 642c  der=sender.fbid,
-00007ff0: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-00008000: 6573 7461 6d70 3d69 6e74 2874 696d 652e  estamp=int(time.
-00008010: 7469 6d65 2829 202a 2031 3030 3029 2c0a  time() * 1000),.
-00008020: 2020 2020 2020 2020 2020 2020 6662 6964              fbid
-00008030: 3d4e 6f6e 652c 0a20 2020 2020 2020 2029  =None,.        )
-00008040: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
-00008050: 7469 5f64 6564 7570 5b6f 7469 5d20 3d20  ti_dedup[oti] = 
-00008060: 6462 6d0a 2020 2020 2020 2020 6177 6169  dbm.        awai
-00008070: 7420 6462 6d2e 696e 7365 7274 2829 0a20  t dbm.insert(). 
-00008080: 2020 2020 2020 2072 6574 7572 6e20 6462         return db
-00008090: 6d0a 0a20 2020 2061 7379 6e63 2064 6566  m..    async def
-000080a0: 205f 6861 6e64 6c65 5f6d 6174 7269 785f   _handle_matrix_
-000080b0: 7465 7874 280a 2020 2020 2020 2020 7365  text(.        se
-000080c0: 6c66 2c20 6576 656e 745f 6964 3a20 4576  lf, event_id: Ev
-000080d0: 656e 7449 442c 2073 656e 6465 723a 2075  entID, sender: u
-000080e0: 2e55 7365 722c 206d 6573 7361 6765 3a20  .User, message: 
-000080f0: 5465 7874 4d65 7373 6167 6545 7665 6e74  TextMessageEvent
-00008100: 436f 6e74 656e 740a 2020 2020 2920 2d3e  Content.    ) ->
-00008110: 204e 6f6e 653a 0a20 2020 2020 2020 2063   None:.        c
-00008120: 6f6e 7665 7274 6564 203d 2061 7761 6974  onverted = await
-00008130: 206d 6174 7269 785f 746f 5f66 6163 6562   matrix_to_faceb
-00008140: 6f6f 6b28 6d65 7373 6167 652c 2073 656c  ook(message, sel
-00008150: 662e 6d78 6964 2c20 7365 6c66 2e6c 6f67  f.mxid, self.log
-00008160: 290a 2020 2020 2020 2020 6462 6d20 3d20  ).        dbm = 
-00008170: 6177 6169 7420 7365 6c66 2e5f 6d61 6b65  await self._make
-00008180: 5f64 626d 2873 656e 6465 722c 2065 7665  _dbm(sender, eve
-00008190: 6e74 5f69 6429 0a20 2020 2020 2020 2072  nt_id).        r
-000081a0: 6573 7020 3d20 6177 6169 7420 7365 6e64  esp = await send
-000081b0: 6572 2e6d 7174 742e 7365 6e64 5f6d 6573  er.mqtt.send_mes
-000081c0: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
-000081d0: 2020 7365 6c66 2e66 6269 642c 0a20 2020    self.fbid,.   
-000081e0: 2020 2020 2020 2020 2073 656c 662e 6662           self.fb
-000081f0: 5f74 7970 6520 213d 2054 6872 6561 6454  _type != ThreadT
-00008200: 7970 652e 5553 4552 2c0a 2020 2020 2020  ype.USER,.      
-00008210: 2020 2020 2020 6d65 7373 6167 653d 636f        message=co
-00008220: 6e76 6572 7465 642e 7465 7874 2c0a 2020  nverted.text,.  
-00008230: 2020 2020 2020 2020 2020 6d65 6e74 696f            mentio
-00008240: 6e73 3d63 6f6e 7665 7274 6564 2e6d 656e  ns=converted.men
-00008250: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-00008260: 2020 2072 6570 6c79 5f74 6f3d 636f 6e76     reply_to=conv
-00008270: 6572 7465 642e 7265 706c 795f 746f 2c0a  erted.reply_to,.
-00008280: 2020 2020 2020 2020 2020 2020 6f66 666c              offl
-00008290: 696e 655f 7468 7265 6164 696e 675f 6964  ine_threading_id
-000082a0: 3d64 626d 2e66 625f 7478 6e5f 6964 2c0a  =dbm.fb_txn_id,.
-000082b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000082c0: 2020 6966 206e 6f74 2072 6573 702e 7375    if not resp.su
-000082d0: 6363 6573 7320 616e 6420 7265 7370 2e65  ccess and resp.e
-000082e0: 7272 6f72 5f6d 6573 7361 6765 3a0a 2020  rror_message:.  
-000082f0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-00008300: 6f67 2e64 6562 7567 2866 2245 7272 6f72  og.debug(f"Error
-00008310: 2068 616e 646c 696e 6720 4d61 7472 6978   handling Matrix
-00008320: 206d 6573 7361 6765 207b 6576 656e 745f   message {event_
-00008330: 6964 7d3a 207b 7265 7370 2e65 7272 6f72  id}: {resp.error
-00008340: 5f6d 6573 7361 6765 7d22 290a 2020 2020  _message}").    
-00008350: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-00008360: 6365 7074 696f 6e28 7265 7370 2e65 7272  ception(resp.err
-00008370: 6f72 5f6d 6573 7361 6765 290a 2020 2020  or_message).    
-00008380: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00008390: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
-000083a0: 6562 7567 2866 2248 616e 646c 6564 204d  ebug(f"Handled M
-000083b0: 6174 7269 7820 6d65 7373 6167 6520 7b65  atrix message {e
-000083c0: 7665 6e74 5f69 647d 202d 3e20 4f54 493a  vent_id} -> OTI:
-000083d0: 207b 6462 6d2e 6662 5f74 786e 5f69 647d   {dbm.fb_txn_id}
-000083e0: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
-000083f0: 6620 5f68 616e 646c 655f 6d61 7472 6978  f _handle_matrix
-00008400: 5f6d 6564 6961 280a 2020 2020 2020 2020  _media(.        
-00008410: 7365 6c66 2c20 6576 656e 745f 6964 3a20  self, event_id: 
-00008420: 4576 656e 7449 442c 2073 656e 6465 723a  EventID, sender:
-00008430: 2075 2e55 7365 722c 206d 6573 7361 6765   u.User, message
-00008440: 3a20 4d65 6469 614d 6573 7361 6765 4576  : MediaMessageEv
-00008450: 656e 7443 6f6e 7465 6e74 2c20 6973 5f72  entContent, is_r
-00008460: 656c 6179 3a20 626f 6f6c 0a20 2020 2029  elay: bool.    )
-00008470: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00008480: 2020 6966 206d 6573 7361 6765 2e66 696c    if message.fil
-00008490: 6520 616e 6420 6465 6372 7970 745f 6174  e and decrypt_at
-000084a0: 7461 6368 6d65 6e74 3a0a 2020 2020 2020  tachment:.      
-000084b0: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
-000084c0: 6974 2073 656c 662e 6d61 696e 5f69 6e74  it self.main_int
-000084d0: 656e 742e 646f 776e 6c6f 6164 5f6d 6564  ent.download_med
-000084e0: 6961 286d 6573 7361 6765 2e66 696c 652e  ia(message.file.
-000084f0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-00008500: 2064 6174 6120 3d20 6465 6372 7970 745f   data = decrypt_
-00008510: 6174 7461 6368 6d65 6e74 280a 2020 2020  attachment(.    
-00008520: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00008530: 2c20 6d65 7373 6167 652e 6669 6c65 2e6b  , message.file.k
-00008540: 6579 2e6b 6579 2c20 6d65 7373 6167 652e  ey.key, message.
-00008550: 6669 6c65 2e68 6173 6865 732e 6765 7428  file.hashes.get(
-00008560: 2273 6861 3235 3622 292c 206d 6573 7361  "sha256"), messa
-00008570: 6765 2e66 696c 652e 6976 0a20 2020 2020  ge.file.iv.     
-00008580: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008590: 2065 6c69 6620 6d65 7373 6167 652e 7572   elif message.ur
-000085a0: 6c3a 0a20 2020 2020 2020 2020 2020 2064  l:.            d
-000085b0: 6174 6120 3d20 6177 6169 7420 7365 6c66  ata = await self
-000085c0: 2e6d 6169 6e5f 696e 7465 6e74 2e64 6f77  .main_intent.dow
-000085d0: 6e6c 6f61 645f 6d65 6469 6128 6d65 7373  nload_media(mess
-000085e0: 6167 652e 7572 6c29 0a20 2020 2020 2020  age.url).       
-000085f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00008600: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-00008610: 656d 656e 7465 6445 7272 6f72 2822 4e6f  ementedError("No
-00008620: 2066 696c 6520 6f72 2055 524c 2073 7065   file or URL spe
-00008630: 6369 6669 6564 2229 0a20 2020 2020 2020  cified").       
-00008640: 206d 696d 6520 3d20 6d65 7373 6167 652e   mime = message.
-00008650: 696e 666f 2e6d 696d 6574 7970 6520 6f72  info.mimetype or
-00008660: 206d 6167 6963 2e6d 696d 6574 7970 6528   magic.mimetype(
-00008670: 6461 7461 290a 2020 2020 2020 2020 6462  data).        db
-00008680: 6d20 3d20 6177 6169 7420 7365 6c66 2e5f  m = await self._
-00008690: 6d61 6b65 5f64 626d 2873 656e 6465 722c  make_dbm(sender,
-000086a0: 2065 7665 6e74 5f69 6429 0a20 2020 2020   event_id).     
-000086b0: 2020 2072 6570 6c79 5f74 6f20 3d20 4e6f     reply_to = No
-000086c0: 6e65 0a20 2020 2020 2020 2072 6570 6c79  ne.        reply
-000086d0: 5f74 6f5f 6d78 6964 203d 206d 6573 7361  _to_mxid = messa
-000086e0: 6765 2e67 6574 5f72 6570 6c79 5f74 6f28  ge.get_reply_to(
-000086f0: 290a 2020 2020 2020 2020 6966 2072 6570  ).        if rep
-00008700: 6c79 5f74 6f5f 6d78 6964 3a0a 2020 2020  ly_to_mxid:.    
-00008710: 2020 2020 2020 2020 7265 706c 795f 746f          reply_to
-00008720: 5f6d 7367 203d 2061 7761 6974 2044 424d  _msg = await DBM
-00008730: 6573 7361 6765 2e67 6574 5f62 795f 6d78  essage.get_by_mx
-00008740: 6964 2872 6570 6c79 5f74 6f5f 6d78 6964  id(reply_to_mxid
-00008750: 2c20 7365 6c66 2e6d 7869 6429 0a20 2020  , self.mxid).   
-00008760: 2020 2020 2020 2020 2069 6620 7265 706c           if repl
-00008770: 795f 746f 5f6d 7367 3a0a 2020 2020 2020  y_to_msg:.      
-00008780: 2020 2020 2020 2020 2020 7265 706c 795f            reply_
-00008790: 746f 203d 2072 6570 6c79 5f74 6f5f 6d73  to = reply_to_ms
-000087a0: 672e 6662 6964 0a20 2020 2020 2020 2020  g.fbid.         
-000087b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000087c0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000087d0: 672e 7761 726e 696e 6728 0a20 2020 2020  g.warning(.     
-000087e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000087f0: 2243 6f75 6c64 6e27 7420 6669 6e64 2072  "Couldn't find r
-00008800: 6570 6c79 2074 6172 6765 7420 7b72 6570  eply target {rep
-00008810: 6c79 5f74 6f5f 6d78 6964 7d22 0a20 2020  ly_to_mxid}".   
-00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008830: 2022 2074 6f20 6272 6964 6765 206d 6564   " to bridge med
-00008840: 6961 206d 6573 7361 6765 2072 6570 6c79  ia message reply
-00008850: 206d 6574 6164 6174 6120 746f 2046 6163   metadata to Fac
-00008860: 6562 6f6f 6b22 0a20 2020 2020 2020 2020  ebook".         
-00008870: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00008880: 2066 696c 656e 616d 6520 3d20 6d65 7373   filename = mess
-00008890: 6167 652e 626f 6479 0a20 2020 2020 2020  age.body.       
-000088a0: 2069 6620 6973 5f72 656c 6179 3a0a 2020   if is_relay:.  
-000088b0: 2020 2020 2020 2020 2020 6361 7074 696f            captio
-000088c0: 6e20 3d20 2861 7761 6974 206d 6174 7269  n = (await matri
-000088d0: 785f 746f 5f66 6163 6562 6f6f 6b28 6d65  x_to_facebook(me
-000088e0: 7373 6167 652c 2073 656c 662e 6d78 6964  ssage, self.mxid
-000088f0: 2c20 7365 6c66 2e6c 6f67 2929 2e74 6578  , self.log)).tex
-00008900: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-00008910: 2020 2020 2020 2020 2020 2020 6361 7074              capt
-00008920: 696f 6e20 3d20 4e6f 6e65 0a20 2020 2020  ion = None.     
-00008930: 2020 2069 6620 6d65 7373 6167 652e 6d73     if message.ms
-00008940: 6774 7970 6520 3d3d 204d 6573 7361 6765  gtype == Message
-00008950: 5479 7065 2e41 5544 494f 3a0a 2020 2020  Type.AUDIO:.    
-00008960: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-00008970: 696d 652e 7374 6172 7473 7769 7468 2822  ime.startswith("
-00008980: 6175 6469 6f2f 6d70 2229 3a0a 2020 2020  audio/mp"):.    
-00008990: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000089a0: 203d 2061 7761 6974 2066 666d 7065 672e   = await ffmpeg.
-000089b0: 636f 6e76 6572 745f 6279 7465 7328 0a20  convert_bytes(. 
-000089c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089d0: 2020 2064 6174 612c 0a20 2020 2020 2020     data,.       
-000089e0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-000089f0: 7075 745f 6578 7465 6e73 696f 6e3d 222e  put_extension=".
-00008a00: 6d34 6122 2c0a 2020 2020 2020 2020 2020  m4a",.          
-00008a10: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-00008a20: 5f61 7267 733d 2822 2d63 3a61 222c 2022  _args=("-c:a", "
-00008a30: 6161 6322 292c 0a20 2020 2020 2020 2020  aac"),.         
-00008a40: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-00008a50: 5f6d 696d 653d 6d69 6d65 2c0a 2020 2020  _mime=mime,.    
-00008a60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00008a70: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-00008a80: 6d65 203d 2022 6175 6469 6f2f 6d70 6567  me = "audio/mpeg
-00008a90: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00008aa0: 2020 6669 6c65 6e61 6d65 203d 2022 6175    filename = "au
-00008ab0: 6469 6f2e 6d34 6122 0a20 2020 2020 2020  dio.m4a".       
-00008ac0: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
-00008ad0: 6d65 7373 6167 652e 696e 666f 2e64 7572  message.info.dur
-00008ae0: 6174 696f 6e0a 2020 2020 2020 2020 656c  ation.        el
-00008af0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008b00: 6475 7261 7469 6f6e 203d 204e 6f6e 650a  duration = None.
-00008b10: 2020 2020 2020 2020 2320 6177 6169 7420          # await 
-00008b20: 7365 6e64 6572 2e6d 7174 742e 6f70 656e  sender.mqtt.open
-00008b30: 6564 5f74 6872 6561 6428 7365 6c66 2e66  ed_thread(self.f
-00008b40: 6269 6429 0a20 2020 2020 2020 2072 6573  bid).        res
-00008b50: 7020 3d20 6177 6169 7420 7365 6e64 6572  p = await sender
-00008b60: 2e63 6c69 656e 742e 7365 6e64 5f6d 6564  .client.send_med
-00008b70: 6961 280a 2020 2020 2020 2020 2020 2020  ia(.            
-00008b80: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-00008b90: 2020 6669 6c65 6e61 6d65 2c0a 2020 2020    filename,.    
-00008ba0: 2020 2020 2020 2020 6d69 6d65 2c0a 2020          mime,.  
-00008bb0: 2020 2020 2020 2020 2020 6361 7074 696f            captio
-00008bc0: 6e3d 6361 7074 696f 6e2c 0a20 2020 2020  n=caption,.     
-00008bd0: 2020 2020 2020 206f 6666 6c69 6e65 5f74         offline_t
-00008be0: 6872 6561 6469 6e67 5f69 643d 6462 6d2e  hreading_id=dbm.
-00008bf0: 6662 5f74 786e 5f69 642c 0a20 2020 2020  fb_txn_id,.     
-00008c00: 2020 2020 2020 2072 6570 6c79 5f74 6f3d         reply_to=
-00008c10: 7265 706c 795f 746f 2c0a 2020 2020 2020  reply_to,.      
-00008c20: 2020 2020 2020 6368 6174 5f69 643d 7365        chat_id=se
-00008c30: 6c66 2e66 6269 642c 0a20 2020 2020 2020  lf.fbid,.       
-00008c40: 2020 2020 2069 735f 6772 6f75 703d 7365       is_group=se
-00008c50: 6c66 2e66 625f 7479 7065 2021 3d20 5468  lf.fb_type != Th
-00008c60: 7265 6164 5479 7065 2e55 5345 522c 0a20  readType.USER,. 
-00008c70: 2020 2020 2020 2020 2020 2064 7572 6174             durat
-00008c80: 696f 6e3d 6475 7261 7469 6f6e 2c0a 2020  ion=duration,.  
-00008c90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00008ca0: 6966 206e 6f74 2072 6573 702e 6d65 6469  if not resp.medi
-00008cb0: 615f 6964 2061 6e64 2072 6573 702e 6465  a_id and resp.de
-00008cc0: 6275 675f 696e 666f 3a0a 2020 2020 2020  bug_info:.      
-00008cd0: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
-00008ce0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00008cf0: 2020 2020 2020 6622 4572 726f 7220 7570        f"Error up
-00008d00: 6c6f 6164 696e 6720 6d65 6469 6120 666f  loading media fo
-00008d10: 7220 4d61 7472 6978 206d 6573 7361 6765  r Matrix message
-00008d20: 207b 6576 656e 745f 6964 7d3a 207b 7265   {event_id}: {re
-00008d30: 7370 2e64 6562 7567 5f69 6e66 6f2e 6d65  sp.debug_info.me
-00008d40: 7373 6167 657d 220a 2020 2020 2020 2020  ssage}".        
-00008d50: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00008d60: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00008d70: 6e28 6622 4d65 6469 6120 7570 6c6f 6164  n(f"Media upload
-00008d80: 2065 7272 6f72 3a20 7b72 6573 702e 6465   error: {resp.de
-00008d90: 6275 675f 696e 666f 2e6d 6573 7361 6765  bug_info.message
-00008da0: 7d22 290a 0a20 2020 2020 2020 2074 7279  }")..        try
-00008db0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00008dc0: 6c66 2e5f 6f74 695f 6465 6475 702e 706f  lf._oti_dedup.po
-00008dd0: 7028 6462 6d2e 6662 5f74 786e 5f69 6429  p(dbm.fb_txn_id)
-00008de0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00008df0: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
-00008e00: 2020 2020 2020 7365 6c66 2e6c 6f67 2e74        self.log.t
-00008e10: 7261 6365 2866 224d 6573 7361 6765 2049  race(f"Message I
-00008e20: 4420 666f 7220 4f54 4920 7b64 626d 2e66  D for OTI {dbm.f
-00008e30: 625f 7478 6e5f 6964 7d20 7365 656d 7320  b_txn_id} seems 
-00008e40: 746f 2068 6176 6520 6265 656e 2066 6f75  to have been fou
-00008e50: 6e64 2061 6c72 6561 6479 2229 0a20 2020  nd already").   
-00008e60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008e70: 2020 2020 2020 2064 626d 2e66 6269 6420         dbm.fbid 
-00008e80: 3d20 7265 7370 2e6d 6573 7361 6765 5f69  = resp.message_i
-00008e90: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-00008ea0: 544f 444f 2063 616e 2077 6520 6669 6e64  TODO can we find
-00008eb0: 2074 6865 2074 696d 6573 7461 6d70 3f0a   the timestamp?.
-00008ec0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00008ed0: 7420 6462 6d2e 7570 6461 7465 2829 0a20  t dbm.update(). 
-00008ee0: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-00008ef0: 6465 6275 6728 6622 4861 6e64 6c65 6420  debug(f"Handled 
-00008f00: 4d61 7472 6978 206d 6573 7361 6765 207b  Matrix message {
-00008f10: 6576 656e 745f 6964 7d20 2d3e 207b 7265  event_id} -> {re
-00008f20: 7370 2e6d 6573 7361 6765 5f69 647d 202f  sp.message_id} /
-00008f30: 207b 6462 6d2e 6662 5f74 786e 5f69 647d   {dbm.fb_txn_id}
-00008f40: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
-00008f50: 6620 6861 6e64 6c65 5f6d 6174 7269 785f  f handle_matrix_
-00008f60: 7265 6461 6374 696f 6e28 0a20 2020 2020  redaction(.     
-00008f70: 2020 2073 656c 662c 2073 656e 6465 723a     self, sender:
-00008f80: 2075 2e55 7365 722c 2065 7665 6e74 5f69   u.User, event_i
-00008f90: 643a 2045 7665 6e74 4944 2c20 7265 6461  d: EventID, reda
-00008fa0: 6374 696f 6e5f 6576 656e 745f 6964 3a20  ction_event_id: 
-00008fb0: 4576 656e 7449 440a 2020 2020 2920 2d3e  EventID.    ) ->
-00008fc0: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-00008fd0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00008fe0: 6177 6169 7420 7365 6c66 2e5f 6861 6e64  await self._hand
-00008ff0: 6c65 5f6d 6174 7269 785f 7265 6461 6374  le_matrix_redact
-00009000: 696f 6e28 7365 6e64 6572 2c20 6576 656e  ion(sender, even
-00009010: 745f 6964 290a 2020 2020 2020 2020 6578  t_id).        ex
-00009020: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00009030: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00009040: 2073 656c 662e 6c6f 672e 6572 726f 7228   self.log.error(
-00009050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009060: 2066 2246 6169 6c65 6420 746f 2068 616e   f"Failed to han
-00009070: 646c 6520 4d61 7472 6978 2072 6564 6163  dle Matrix redac
-00009080: 7469 6f6e 207b 7265 6461 6374 696f 6e5f  tion {redaction_
-00009090: 6576 656e 745f 6964 7d3a 207b 657d 222c  event_id}: {e}",
-000090a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000090b0: 2065 7863 5f69 6e66 6f3d 6e6f 7420 6973   exc_info=not is
-000090c0: 696e 7374 616e 6365 2865 2c20 4e6f 7449  instance(e, NotI
-000090d0: 6d70 6c65 6d65 6e74 6564 4572 726f 7229  mplementedError)
-000090e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-000090f0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00009100: 7420 7365 6c66 2e5f 7365 6e64 5f62 7269  t self._send_bri
-00009110: 6467 655f 6572 726f 7228 7365 6e64 6572  dge_error(sender
-00009120: 2c20 652c 2072 6564 6163 7469 6f6e 5f65  , e, redaction_e
-00009130: 7665 6e74 5f69 642c 2045 7665 6e74 5479  vent_id, EventTy
-00009140: 7065 2e52 4f4f 4d5f 5245 4441 4354 494f  pe.ROOM_REDACTIO
-00009150: 4e29 0a20 2020 2020 2020 2065 6c73 653a  N).        else:
-00009160: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00009170: 6974 2073 656c 662e 5f73 656e 645f 6272  it self._send_br
-00009180: 6964 6765 5f73 7563 6365 7373 2873 656e  idge_success(sen
-00009190: 6465 722c 2072 6564 6163 7469 6f6e 5f65  der, redaction_e
-000091a0: 7665 6e74 5f69 642c 2045 7665 6e74 5479  vent_id, EventTy
-000091b0: 7065 2e52 4f4f 4d5f 5245 4441 4354 494f  pe.ROOM_REDACTIO
-000091c0: 4e29 0a0a 2020 2020 6173 796e 6320 6465  N)..    async de
-000091d0: 6620 5f68 616e 646c 655f 6d61 7472 6978  f _handle_matrix
-000091e0: 5f72 6564 6163 7469 6f6e 2873 656c 662c  _redaction(self,
-000091f0: 2073 656e 6465 723a 2075 2e55 7365 722c   sender: u.User,
-00009200: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
-00009210: 4944 2920 2d3e 204e 6f6e 653a 0a20 2020  ID) -> None:.   
-00009220: 2020 2020 2073 656e 6465 722c 205f 203d       sender, _ =
-00009230: 2061 7761 6974 2073 656c 662e 6765 745f   await self.get_
-00009240: 7265 6c61 795f 7365 6e64 6572 2873 656e  relay_sender(sen
-00009250: 6465 722c 2066 2272 6564 6163 7469 6f6e  der, f"redaction
-00009260: 207b 6576 656e 745f 6964 7d22 290a 2020   {event_id}").  
-00009270: 2020 2020 2020 6966 206e 6f74 2073 656e        if not sen
-00009280: 6465 723a 0a20 2020 2020 2020 2020 2020  der:.           
-00009290: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-000092a0: 2822 6e6f 7420 6c6f 6767 6564 2069 6e22  ("not logged in"
-000092b0: 290a 2020 2020 2020 2020 6d65 7373 6167  ).        messag
-000092c0: 6520 3d20 6177 6169 7420 4442 4d65 7373  e = await DBMess
-000092d0: 6167 652e 6765 745f 6279 5f6d 7869 6428  age.get_by_mxid(
-000092e0: 6576 656e 745f 6964 2c20 7365 6c66 2e6d  event_id, self.m
-000092f0: 7869 6429 0a20 2020 2020 2020 2069 6620  xid).        if 
-00009300: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
-00009310: 2020 2020 2069 6620 6e6f 7420 6d65 7373       if not mess
-00009320: 6167 652e 6662 6964 3a0a 2020 2020 2020  age.fbid:.      
-00009330: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00009340: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-00009350: 726f 7228 2254 7269 6564 2074 6f20 7265  ror("Tried to re
-00009360: 6461 6374 206d 6573 7361 6765 2077 686f  dact message who
-00009370: 7365 2066 6269 6420 6973 2075 6e6b 6e6f  se fbid is unkno
-00009380: 776e 2229 0a20 2020 2020 2020 2020 2020  wn").           
-00009390: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000093a0: 2020 2020 2020 6177 6169 7420 6d65 7373        await mess
-000093b0: 6167 652e 6465 6c65 7465 2829 0a20 2020  age.delete().   
-000093c0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000093d0: 6974 2073 656e 6465 722e 636c 6965 6e74  it sender.client
-000093e0: 2e75 6e73 656e 6428 6d65 7373 6167 652e  .unsend(message.
-000093f0: 6662 6964 290a 2020 2020 2020 2020 2020  fbid).          
-00009400: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00009410: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00009420: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00009430: 672e 6578 6365 7074 696f 6e28 6622 4661  g.exception(f"Fa
-00009440: 696c 6564 2074 6f20 756e 7365 6e64 207b  iled to unsend {
-00009450: 6d65 7373 6167 652e 6662 6964 7d22 290a  message.fbid}").
-00009460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009470: 7261 6973 650a 2020 2020 2020 2020 2020  raise.          
-00009480: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00009490: 2020 7265 6163 7469 6f6e 203d 2061 7761    reaction = awa
-000094a0: 6974 2044 4252 6561 6374 696f 6e2e 6765  it DBReaction.ge
-000094b0: 745f 6279 5f6d 7869 6428 6576 656e 745f  t_by_mxid(event_
-000094c0: 6964 2c20 7365 6c66 2e6d 7869 6429 0a20  id, self.mxid). 
-000094d0: 2020 2020 2020 2069 6620 7265 6163 7469         if reacti
-000094e0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000094f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00009500: 2020 2020 2061 7761 6974 2072 6561 6374       await react
-00009510: 696f 6e2e 6465 6c65 7465 2829 0a20 2020  ion.delete().   
-00009520: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00009530: 6974 2073 656e 6465 722e 636c 6965 6e74  it sender.client
-00009540: 2e72 6561 6374 2872 6561 6374 696f 6e2e  .react(reaction.
-00009550: 6662 5f6d 7367 6964 2c20 4e6f 6e65 290a  fb_msgid, None).
-00009560: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00009570: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00009580: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00009590: 2020 2073 656c 662e 6c6f 672e 6578 6365     self.log.exce
-000095a0: 7074 696f 6e28 6622 4661 696c 6564 2074  ption(f"Failed t
-000095b0: 6f20 7265 6d6f 7665 2072 6561 6374 696f  o remove reactio
-000095c0: 6e20 746f 207b 7265 6163 7469 6f6e 2e66  n to {reaction.f
-000095d0: 625f 6d73 6769 647d 2229 0a20 2020 2020  b_msgid}").     
-000095e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000095f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00009600: 7572 6e0a 0a20 2020 2020 2020 2072 6169  urn..        rai
-00009610: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-00009620: 6445 7272 6f72 2822 7265 6461 6374 696f  dError("redactio
-00009630: 6e20 7461 7267 6574 206e 6f74 2066 6f75  n target not fou
-00009640: 6e64 2229 0a0a 2020 2020 6173 796e 6320  nd")..    async 
-00009650: 6465 6620 6861 6e64 6c65 5f6d 6174 7269  def handle_matri
-00009660: 785f 7265 6163 7469 6f6e 280a 2020 2020  x_reaction(.    
-00009670: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00009680: 2020 7365 6e64 6572 3a20 752e 5573 6572    sender: u.User
-00009690: 2c0a 2020 2020 2020 2020 6576 656e 745f  ,.        event_
-000096a0: 6964 3a20 4576 656e 7449 442c 0a20 2020  id: EventID,.   
-000096b0: 2020 2020 2072 6561 6374 696e 675f 746f       reacting_to
-000096c0: 3a20 4576 656e 7449 442c 0a20 2020 2020  : EventID,.     
-000096d0: 2020 2072 6561 6374 696f 6e3a 2073 7472     reaction: str
-000096e0: 2c0a 2020 2020 2020 2020 7469 6d65 7374  ,.        timest
-000096f0: 616d 703a 2069 6e74 2c0a 2020 2020 2920  amp: int,.    ) 
-00009700: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00009710: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00009720: 2020 6177 6169 7420 7365 6c66 2e5f 6861    await self._ha
-00009730: 6e64 6c65 5f6d 6174 7269 785f 7265 6163  ndle_matrix_reac
-00009740: 7469 6f6e 2873 656e 6465 722c 2065 7665  tion(sender, eve
-00009750: 6e74 5f69 642c 2072 6561 6374 696e 675f  nt_id, reacting_
-00009760: 746f 2c20 7265 6163 7469 6f6e 2c20 7469  to, reaction, ti
-00009770: 6d65 7374 616d 7029 0a20 2020 2020 2020  mestamp).       
-00009780: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00009790: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-000097a0: 2020 2020 7365 6c66 2e6c 6f67 2e65 7272      self.log.err
-000097b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000097c0: 2020 2020 6622 4661 696c 6564 2074 6f20      f"Failed to 
-000097d0: 6861 6e64 6c65 204d 6174 7269 7820 7265  handle Matrix re
-000097e0: 6163 7469 6f6e 207b 6576 656e 745f 6964  action {event_id
-000097f0: 7d3a 207b 657d 222c 0a20 2020 2020 2020  }: {e}",.       
-00009800: 2020 2020 2020 2020 2065 7863 5f69 6e66           exc_inf
-00009810: 6f3d 6e6f 7420 6973 696e 7374 616e 6365  o=not isinstance
-00009820: 2865 2c20 4e6f 7449 6d70 6c65 6d65 6e74  (e, NotImplement
-00009830: 6564 4572 726f 7229 2c0a 2020 2020 2020  edError),.      
-00009840: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00009850: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-00009860: 7365 6e64 5f62 7269 6467 655f 6572 726f  send_bridge_erro
-00009870: 7228 7365 6e64 6572 2c20 652c 2065 7665  r(sender, e, eve
-00009880: 6e74 5f69 642c 2045 7665 6e74 5479 7065  nt_id, EventType
-00009890: 2e52 4541 4354 494f 4e29 0a20 2020 2020  .REACTION).     
-000098a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000098b0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-000098c0: 5f73 656e 645f 6272 6964 6765 5f73 7563  _send_bridge_suc
-000098d0: 6365 7373 2873 656e 6465 722c 2065 7665  cess(sender, eve
-000098e0: 6e74 5f69 642c 2045 7665 6e74 5479 7065  nt_id, EventType
-000098f0: 2e52 4541 4354 494f 4e29 0a0a 2020 2020  .REACTION)..    
-00009900: 6173 796e 6320 6465 6620 5f68 616e 646c  async def _handl
-00009910: 655f 6d61 7472 6978 5f72 6561 6374 696f  e_matrix_reactio
-00009920: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-00009930: 0a20 2020 2020 2020 2073 656e 6465 723a  .        sender:
-00009940: 2075 2e55 7365 722c 0a20 2020 2020 2020   u.User,.       
-00009950: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
-00009960: 4944 2c0a 2020 2020 2020 2020 7265 6163  ID,.        reac
-00009970: 7469 6e67 5f74 6f3a 2045 7665 6e74 4944  ting_to: EventID
-00009980: 2c0a 2020 2020 2020 2020 7265 6163 7469  ,.        reacti
-00009990: 6f6e 3a20 7374 722c 0a20 2020 2020 2020  on: str,.       
-000099a0: 2074 696d 6573 7461 6d70 3a20 696e 742c   timestamp: int,
-000099b0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-000099c0: 2020 2020 2020 2020 7365 6e64 6572 2c20          sender, 
-000099d0: 6973 5f72 656c 6179 203d 2061 7761 6974  is_relay = await
-000099e0: 2073 656c 662e 6765 745f 7265 6c61 795f   self.get_relay_
-000099f0: 7365 6e64 6572 2873 656e 6465 722c 2066  sender(sender, f
-00009a00: 2272 6561 6374 696f 6e20 7b65 7665 6e74  "reaction {event
-00009a10: 5f69 647d 2229 0a20 2020 2020 2020 2069  _id}").        i
-00009a20: 6620 6e6f 7420 7365 6e64 6572 206f 7220  f not sender or 
-00009a30: 6973 5f72 656c 6179 3a0a 2020 2020 2020  is_relay:.      
-00009a40: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-00009a50: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-00009a60: 226e 6f74 206c 6f67 6765 6420 696e 2229  "not logged in")
-00009a70: 0a20 2020 2020 2020 2023 2046 6163 6562  .        # Faceb
-00009a80: 6f6f 6b20 646f 6573 6e27 7420 7573 6520  ook doesn't use 
-00009a90: 7661 7269 6174 696f 6e20 7365 6c65 6374  variation select
-00009aa0: 6f72 732c 204d 6174 7269 7820 646f 6573  ors, Matrix does
-00009ab0: 0a20 2020 2020 2020 2072 6561 6374 696f  .        reactio
-00009ac0: 6e20 3d20 7661 7269 6174 696f 6e5f 7365  n = variation_se
-00009ad0: 6c65 6374 6f72 2e72 656d 6f76 6528 7265  lector.remove(re
-00009ae0: 6163 7469 6f6e 290a 0a20 2020 2020 2020  action)..       
-00009af0: 2061 7379 6e63 2077 6974 6820 7365 6c66   async with self
-00009b00: 2e72 6571 7569 7265 5f73 656e 645f 6c6f  .require_send_lo
-00009b10: 636b 2873 656e 6465 722e 6662 6964 293a  ck(sender.fbid):
-00009b20: 0a20 2020 2020 2020 2020 2020 206d 6573  .            mes
-00009b30: 7361 6765 203d 2061 7761 6974 2044 424d  sage = await DBM
-00009b40: 6573 7361 6765 2e67 6574 5f62 795f 6d78  essage.get_by_mx
-00009b50: 6964 2872 6561 6374 696e 675f 746f 2c20  id(reacting_to, 
-00009b60: 7365 6c66 2e6d 7869 6429 0a20 2020 2020  self.mxid).     
-00009b70: 2020 2020 2020 2069 6620 6e6f 7420 6d65         if not me
-00009b80: 7373 6167 653a 0a20 2020 2020 2020 2020  ssage:.         
-00009b90: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
-00009ba0: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
-00009bb0: 2822 7265 6163 7469 6f6e 2074 6172 6765  ("reaction targe
-00009bc0: 7420 6d65 7373 6167 6520 6e6f 7420 666f  t message not fo
-00009bd0: 756e 6422 290a 2020 2020 2020 2020 2020  und").          
-00009be0: 2020 656c 6966 206e 6f74 206d 6573 7361    elif not messa
-00009bf0: 6765 2e66 6269 643a 0a20 2020 2020 2020  ge.fbid:.       
-00009c00: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-00009c10: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-00009c20: 6f72 2822 6661 6365 626f 6f6b 2049 4420  or("facebook ID 
-00009c30: 6f66 2074 6172 6765 7420 6d65 7373 6167  of target messag
-00009c40: 6520 6973 2075 6e6b 6e6f 776e 2229 0a0a  e is unknown")..
-00009c50: 2020 2020 2020 2020 2020 2020 6578 6973              exis
-00009c60: 7469 6e67 203d 2061 7761 6974 2044 4252  ting = await DBR
-00009c70: 6561 6374 696f 6e2e 6765 745f 6279 5f66  eaction.get_by_f
-00009c80: 6269 6428 6d65 7373 6167 652e 6662 6964  bid(message.fbid
-00009c90: 2c20 7365 6c66 2e66 625f 7265 6365 6976  , self.fb_receiv
-00009ca0: 6572 2c20 7365 6e64 6572 2e66 6269 6429  er, sender.fbid)
-00009cb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009cc0: 6578 6973 7469 6e67 2061 6e64 2065 7869  existing and exi
-00009cd0: 7374 696e 672e 7265 6163 7469 6f6e 203d  sting.reaction =
-00009ce0: 3d20 7265 6163 7469 6f6e 3a0a 2020 2020  = reaction:.    
-00009cf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00009d00: 726e 0a0a 2020 2020 2020 2020 2020 2020  rn..            
-00009d10: 6177 6169 7420 7365 6e64 6572 2e63 6c69  await sender.cli
-00009d20: 656e 742e 7265 6163 7428 6d65 7373 6167  ent.react(messag
-00009d30: 652e 6662 6964 2c20 7265 6163 7469 6f6e  e.fbid, reaction
-00009d40: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
-00009d50: 6169 7420 7365 6c66 2e5f 7570 7365 7274  ait self._upsert
-00009d60: 5f72 6561 6374 696f 6e28 0a20 2020 2020  _reaction(.     
-00009d70: 2020 2020 2020 2020 2020 2065 7869 7374             exist
-00009d80: 696e 672c 2073 656c 662e 6d61 696e 5f69  ing, self.main_i
-00009d90: 6e74 656e 742c 2065 7665 6e74 5f69 642c  ntent, event_id,
-00009da0: 206d 6573 7361 6765 2c20 7365 6e64 6572   message, sender
-00009db0: 2c20 7265 6163 7469 6f6e 2c20 7469 6d65  , reaction, time
-00009dc0: 7374 616d 700a 2020 2020 2020 2020 2020  stamp.          
-00009dd0: 2020 290a 0a20 2020 2061 7379 6e63 2064    )..    async d
-00009de0: 6566 2068 616e 646c 655f 6d61 7472 6978  ef handle_matrix
-00009df0: 5f6c 6561 7665 2873 656c 662c 2075 7365  _leave(self, use
-00009e00: 723a 2075 2e55 7365 7229 202d 3e20 4e6f  r: u.User) -> No
-00009e10: 6e65 3a0a 2020 2020 2020 2020 6966 2073  ne:.        if s
-00009e20: 656c 662e 6973 5f64 6972 6563 743a 0a20  elf.is_direct:. 
-00009e30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00009e40: 6c6f 672e 696e 666f 2866 227b 7573 6572  log.info(f"{user
-00009e50: 2e6d 7869 647d 206c 6566 7420 7072 6976  .mxid} left priv
-00009e60: 6174 6520 6368 6174 2070 6f72 7461 6c20  ate chat portal 
-00009e70: 7769 7468 207b 7365 6c66 2e66 6269 647d  with {self.fbid}
-00009e80: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-00009e90: 6620 7573 6572 2e66 6269 6420 3d3d 2073  f user.fbid == s
-00009ea0: 656c 662e 6662 5f72 6563 6569 7665 723a  elf.fb_receiver:
-00009eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009ec0: 2073 656c 662e 6c6f 672e 696e 666f 280a   self.log.info(.
-00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ee0: 2020 2020 6622 7b75 7365 722e 6d78 6964      f"{user.mxid
-00009ef0: 7d20 7761 7320 7468 6520 7265 6369 7069  } was the recipi
-00009f00: 656e 7420 6f66 2074 6869 7320 706f 7274  ent of this port
-00009f10: 616c 2e20 436c 6561 6e69 6e67 2075 7020  al. Cleaning up 
-00009f20: 616e 6420 6465 6c65 7469 6e67 2e2e 2e22  and deleting..."
-00009f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009f40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00009f50: 2020 2061 7761 6974 2073 656c 662e 636c     await self.cl
-00009f60: 6561 6e75 705f 616e 645f 6465 6c65 7465  eanup_and_delete
-00009f70: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
-00009f80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00009f90: 662e 6c6f 672e 6465 6275 6728 6622 7b75  f.log.debug(f"{u
-00009fa0: 7365 722e 6d78 6964 7d20 6c65 6674 2070  ser.mxid} left p
-00009fb0: 6f72 7461 6c20 746f 207b 7365 6c66 2e66  ortal to {self.f
-00009fc0: 6269 647d 2229 0a0a 2020 2020 6173 796e  bid}")..    asyn
-00009fd0: 6320 6465 6620 5f73 6574 5f74 7970 696e  c def _set_typin
-00009fe0: 6728 7365 6c66 2c20 7573 6572 733a 2073  g(self, users: s
-00009ff0: 6574 5b55 7365 7249 445d 2c20 7479 7069  et[UserID], typi
-0000a000: 6e67 3a20 626f 6f6c 2920 2d3e 204e 6f6e  ng: bool) -> Non
-0000a010: 653a 0a20 2020 2020 2020 2066 6f72 206d  e:.        for m
-0000a020: 7869 6420 696e 2075 7365 7273 3a0a 2020  xid in users:.  
-0000a030: 2020 2020 2020 2020 2020 7573 6572 3a20            user: 
-0000a040: 752e 5573 6572 203d 2061 7761 6974 2075  u.User = await u
-0000a050: 2e55 7365 722e 6765 745f 6279 5f6d 7869  .User.get_by_mxi
-0000a060: 6428 6d78 6964 2c20 6372 6561 7465 3d46  d(mxid, create=F
-0000a070: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-0000a080: 2020 6966 2075 7365 7220 616e 6420 7573    if user and us
-0000a090: 6572 2e6d 7174 743a 0a20 2020 2020 2020  er.mqtt:.       
-0000a0a0: 2020 2020 2020 2020 2061 7761 6974 2075           await u
-0000a0b0: 7365 722e 6d71 7474 2e73 6574 5f74 7970  ser.mqtt.set_typ
-0000a0c0: 696e 6728 7365 6c66 2e66 6269 642c 2074  ing(self.fbid, t
-0000a0d0: 7970 696e 6729 0a0a 2020 2020 6173 796e  yping)..    asyn
-0000a0e0: 6320 6465 6620 6861 6e64 6c65 5f6d 6174  c def handle_mat
-0000a0f0: 7269 785f 7479 7069 6e67 2873 656c 662c  rix_typing(self,
-0000a100: 2075 7365 7273 3a20 7365 745b 5573 6572   users: set[User
-0000a110: 4944 5d29 202d 3e20 4e6f 6e65 3a0a 2020  ID]) -> None:.  
-0000a120: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-0000a130: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-0000a140: 2020 2020 2020 2020 7365 6c66 2e5f 7365          self._se
-0000a150: 745f 7479 7069 6e67 2875 7365 7273 202d  t_typing(users -
-0000a160: 2073 656c 662e 5f74 7970 696e 672c 2074   self._typing, t
-0000a170: 7970 696e 673d 5472 7565 292c 0a20 2020  yping=True),.   
-0000a180: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-0000a190: 6574 5f74 7970 696e 6728 7365 6c66 2e5f  et_typing(self._
-0000a1a0: 7479 7069 6e67 202d 2075 7365 7273 2c20  typing - users, 
-0000a1b0: 7479 7069 6e67 3d46 616c 7365 292c 0a20  typing=False),. 
-0000a1c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000a1d0: 2073 656c 662e 5f74 7970 696e 6720 3d20   self._typing = 
-0000a1e0: 7573 6572 730a 0a20 2020 2023 2065 6e64  users..    # end
-0000a1f0: 7265 6769 6f6e 0a20 2020 2023 2072 6567  region.    # reg
-0000a200: 696f 6e20 4661 6365 626f 6f6b 2065 7665  ion Facebook eve
-0000a210: 6e74 2068 616e 646c 696e 670a 0a20 2020  nt handling..   
-0000a220: 2061 7379 6e63 2064 6566 205f 6272 6964   async def _brid
-0000a230: 6765 5f6f 776e 5f6d 6573 7361 6765 5f70  ge_own_message_p
-0000a240: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
-0000a250: 2073 6f75 7263 653a 2075 2e55 7365 722c   source: u.User,
-0000a260: 2073 656e 6465 723a 2070 2e50 7570 7065   sender: p.Puppe
-0000a270: 742c 206d 6964 3a20 7374 722c 2069 6e76  t, mid: str, inv
-0000a280: 6974 653a 2062 6f6f 6c20 3d20 5472 7565  ite: bool = True
-0000a290: 0a20 2020 2029 202d 3e20 626f 6f6c 3a0a  .    ) -> bool:.
-0000a2a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000a2b0: 6973 5f64 6972 6563 7420 616e 6420 7365  is_direct and se
-0000a2c0: 6e64 6572 2e66 6269 6420 3d3d 2073 6f75  nder.fbid == sou
-0000a2d0: 7263 652e 6662 6964 2061 6e64 206e 6f74  rce.fbid and not
-0000a2e0: 2073 656e 6465 722e 6973 5f72 6561 6c5f   sender.is_real_
-0000a2f0: 7573 6572 3a0a 2020 2020 2020 2020 2020  user:.          
-0000a300: 2020 6966 2073 656c 662e 696e 7669 7465    if self.invite
-0000a310: 5f6f 776e 5f70 7570 7065 745f 746f 5f70  _own_puppet_to_p
-0000a320: 6d20 616e 6420 696e 7669 7465 3a0a 2020  m and invite:.  
-0000a330: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0000a340: 6169 7420 7365 6c66 2e6d 6169 6e5f 696e  ait self.main_in
-0000a350: 7465 6e74 2e69 6e76 6974 655f 7573 6572  tent.invite_user
-0000a360: 2873 656c 662e 6d78 6964 2c20 7365 6e64  (self.mxid, send
-0000a370: 6572 2e6d 7869 6429 0a20 2020 2020 2020  er.mxid).       
-0000a380: 2020 2020 2065 6c69 6620 280a 2020 2020       elif (.    
-0000a390: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0000a3a0: 7420 7365 6c66 2e61 7a2e 7374 6174 655f  t self.az.state_
-0000a3b0: 7374 6f72 652e 6765 745f 6d65 6d62 6572  store.get_member
-0000a3c0: 7368 6970 2873 656c 662e 6d78 6964 2c20  ship(self.mxid, 
-0000a3d0: 7365 6e64 6572 2e6d 7869 6429 2021 3d20  sender.mxid) != 
-0000a3e0: 4d65 6d62 6572 7368 6970 2e4a 4f49 4e0a  Membership.JOIN.
-0000a3f0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0000a400: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000a410: 656c 662e 6c6f 672e 7761 726e 696e 6728  elf.log.warning(
-0000a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a430: 2020 2020 2066 2249 676e 6f72 696e 6720       f"Ignoring 
-0000a440: 6f77 6e20 7b6d 6964 7d20 696e 2070 7269  own {mid} in pri
-0000a450: 7661 7465 2063 6861 7420 6265 6361 7573  vate chat becaus
-0000a460: 6520 6f77 6e20 7075 7070 6574 2069 7320  e own puppet is 
-0000a470: 6e6f 7420 696e 2072 6f6f 6d2e 220a 2020  not in room.".  
-0000a480: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4a0: 7265 7475 726e 2046 616c 7365 0a20 2020  return False.   
-0000a4b0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000a4c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-0000a4d0: 5f61 6464 5f66 6163 6562 6f6f 6b5f 7265  _add_facebook_re
-0000a4e0: 706c 7928 0a20 2020 2020 2020 2073 656c  ply(.        sel
-0000a4f0: 662c 2063 6f6e 7465 6e74 3a20 4d65 7373  f, content: Mess
-0000a500: 6167 6545 7665 6e74 436f 6e74 656e 742c  ageEventContent,
-0000a510: 2072 6570 6c79 5f74 6f3a 2067 7261 7068   reply_to: graph
-0000a520: 716c 2e4d 696e 696d 616c 4d65 7373 6167  ql.MinimalMessag
-0000a530: 6520 7c20 6d71 7474 2e4d 6573 7361 6765  e | mqtt.Message
-0000a540: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-0000a550: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000a560: 7461 6e63 6528 7265 706c 795f 746f 2c20  tance(reply_to, 
-0000a570: 6772 6170 6871 6c2e 4d69 6e69 6d61 6c4d  graphql.MinimalM
-0000a580: 6573 7361 6765 293a 0a20 2020 2020 2020  essage):.       
-0000a590: 2020 2020 206d 6573 7361 6765 203d 2061       message = a
-0000a5a0: 7761 6974 2044 424d 6573 7361 6765 2e67  wait DBMessage.g
-0000a5b0: 6574 5f62 795f 6662 6964 2872 6570 6c79  et_by_fbid(reply
-0000a5c0: 5f74 6f2e 6d65 7373 6167 655f 6964 2c20  _to.message_id, 
-0000a5d0: 7365 6c66 2e66 625f 7265 6365 6976 6572  self.fb_receiver
-0000a5e0: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
-0000a5f0: 7369 6e73 7461 6e63 6528 7265 706c 795f  sinstance(reply_
-0000a600: 746f 2c20 6d71 7474 2e4d 6573 7361 6765  to, mqtt.Message
-0000a610: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-0000a620: 6574 6120 3d20 7265 706c 795f 746f 2e6d  eta = reply_to.m
-0000a630: 6574 6164 6174 610a 2020 2020 2020 2020  etadata.        
-0000a640: 2020 2020 6d65 7373 6167 6520 3d20 6177      message = aw
-0000a650: 6169 7420 4442 4d65 7373 6167 652e 6765  ait DBMessage.ge
-0000a660: 745f 6279 5f66 6269 645f 6f72 5f6f 7469  t_by_fbid_or_oti
-0000a670: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a680: 2020 6d65 7461 2e69 642c 206d 6574 612e    meta.id, meta.
-0000a690: 6f66 666c 696e 655f 7468 7265 6164 696e  offline_threadin
-0000a6a0: 675f 6964 2c20 7365 6c66 2e66 625f 7265  g_id, self.fb_re
-0000a6b0: 6365 6976 6572 2c20 6d65 7461 2e73 656e  ceiver, meta.sen
-0000a6c0: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
-0000a6d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000a6e0: 206d 6573 7361 6765 2061 6e64 206e 6f74   message and not
-0000a6f0: 206d 6573 7361 6765 2e66 6269 643a 0a20   message.fbid:. 
-0000a700: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000a710: 656c 662e 6c6f 672e 6465 6275 6728 0a20  elf.log.debug(. 
-0000a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a730: 2020 2066 2247 6f74 206d 6573 7361 6765     f"Got message
-0000a740: 2049 4420 7b6d 6574 612e 6964 7d20 666f   ID {meta.id} fo
-0000a750: 7220 6f66 666c 696e 6520 7468 7265 6164  r offline thread
-0000a760: 696e 6720 4944 2022 0a20 2020 2020 2020  ing ID ".       
-0000a770: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-0000a780: 6d65 7373 6167 652e 6662 5f74 786e 5f69  message.fb_txn_i
-0000a790: 647d 202f 207b 6d65 7373 6167 652e 6d78  d} / {message.mx
-0000a7a0: 6964 7d20 2869 6e20 6461 7461 6261 7365  id} (in database
-0000a7b0: 2920 6672 6f6d 2072 6570 6c79 220a 2020  ) from reply".  
-0000a7c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7e0: 6d65 7373 6167 652e 6662 6964 203d 206d  message.fbid = m
-0000a7f0: 6574 612e 6964 0a20 2020 2020 2020 2020  eta.id.         
-0000a800: 2020 2020 2020 206d 6573 7361 6765 2e74         message.t
-0000a810: 696d 6573 7461 6d70 203d 206d 6574 612e  imestamp = meta.
-0000a820: 7469 6d65 7374 616d 700a 2020 2020 2020  timestamp.      
-0000a830: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0000a840: 6d65 7373 6167 652e 7570 6461 7465 2829  message.update()
-0000a850: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000a860: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000a870: 6e0a 0a20 2020 2020 2020 2069 6620 6e6f  n..        if no
-0000a880: 7420 6d65 7373 6167 653a 0a20 2020 2020  t message:.     
-0000a890: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-0000a8a0: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-0000a8b0: 2020 2020 2020 2020 2066 2243 6f75 6c64           f"Could
-0000a8c0: 6e27 7420 6669 6e64 2072 6570 6c79 2074  n't find reply t
-0000a8d0: 6172 6765 7420 7b72 6570 6c79 5f74 6f7d  arget {reply_to}
-0000a8e0: 2074 6f20 6272 6964 6765 2072 6570 6c79   to bridge reply
-0000a8f0: 206d 6574 6164 6174 6120 746f 204d 6174   metadata to Mat
-0000a900: 7269 7822 0a20 2020 2020 2020 2020 2020  rix".           
-0000a910: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
-0000a920: 6574 7572 6e0a 0a20 2020 2020 2020 2063  eturn..        c
-0000a930: 6f6e 7465 6e74 2e73 6574 5f72 6570 6c79  ontent.set_reply
-0000a940: 286d 6573 7361 6765 2e6d 7869 6429 0a20  (message.mxid). 
-0000a950: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0000a960: 696e 7374 616e 6365 2863 6f6e 7465 6e74  instance(content
-0000a970: 2c20 5465 7874 4d65 7373 6167 6545 7665  , TextMessageEve
-0000a980: 6e74 436f 6e74 656e 7429 3a0a 2020 2020  ntContent):.    
-0000a990: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0000a9a0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000a9b0: 2020 2020 2020 2020 2065 7674 203d 2061           evt = a
-0000a9c0: 7761 6974 2073 656c 662e 6d61 696e 5f69  wait self.main_i
-0000a9d0: 6e74 656e 742e 6765 745f 6576 656e 7428  ntent.get_event(
-0000a9e0: 6d65 7373 6167 652e 6d78 5f72 6f6f 6d2c  message.mx_room,
-0000a9f0: 206d 6573 7361 6765 2e6d 7869 6429 0a20   message.mxid). 
-0000aa00: 2020 2020 2020 2065 7863 6570 7420 284d         except (M
-0000aa10: 4e6f 7446 6f75 6e64 2c20 4d46 6f72 6269  NotFound, MForbi
-0000aa20: 6464 656e 293a 0a20 2020 2020 2020 2020  dden):.         
-0000aa30: 2020 2065 7674 203d 204e 6f6e 650a 2020     evt = None.  
-0000aa40: 2020 2020 2020 6966 206e 6f74 2065 7674        if not evt
-0000aa50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000aa60: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
-0000aa70: 2065 7674 2e74 7970 6520 3d3d 2045 7665   evt.type == Eve
-0000aa80: 6e74 5479 7065 2e52 4f4f 4d5f 454e 4352  ntType.ROOM_ENCR
-0000aa90: 5950 5445 443a 0a20 2020 2020 2020 2020  YPTED:.         
-0000aaa0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000aab0: 2020 2020 2020 2020 6576 7420 3d20 6177          evt = aw
-0000aac0: 6169 7420 7365 6c66 2e6d 6174 7269 782e  ait self.matrix.
-0000aad0: 6532 6565 2e64 6563 7279 7074 2865 7674  e2ee.decrypt(evt
-0000aae0: 2c20 7761 6974 5f73 6573 7369 6f6e 5f74  , wait_session_t
-0000aaf0: 696d 656f 7574 3d30 290a 2020 2020 2020  imeout=0).      
-0000ab00: 2020 2020 2020 6578 6365 7074 2053 6573        except Ses
-0000ab10: 7369 6f6e 4e6f 7446 6f75 6e64 3a0a 2020  sionNotFound:.  
-0000ab20: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000ab30: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
-0000ab40: 2069 7369 6e73 7461 6e63 6528 6576 742e   isinstance(evt.
-0000ab50: 636f 6e74 656e 742c 2054 6578 744d 6573  content, TextMes
-0000ab60: 7361 6765 4576 656e 7443 6f6e 7465 6e74  sageEventContent
-0000ab70: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-0000ab80: 7674 2e63 6f6e 7465 6e74 2e74 7269 6d5f  vt.content.trim_
-0000ab90: 7265 706c 795f 6661 6c6c 6261 636b 2829  reply_fallback()
-0000aba0: 0a0a 2020 2020 2020 2020 636f 6e74 656e  ..        conten
-0000abb0: 742e 7365 745f 7265 706c 7928 6576 7429  t.set_reply(evt)
-0000abc0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-0000abd0: 6861 6e64 6c65 5f66 6163 6562 6f6f 6b5f  handle_facebook_
-0000abe0: 6d65 7373 6167 6528 0a20 2020 2020 2020  message(.       
-0000abf0: 2073 656c 662c 0a20 2020 2020 2020 2073   self,.        s
-0000ac00: 6f75 7263 653a 2075 2e55 7365 722c 0a20  ource: u.User,. 
-0000ac10: 2020 2020 2020 2073 656e 6465 723a 2070         sender: p
-0000ac20: 2e50 7570 7065 742c 0a20 2020 2020 2020  .Puppet,.       
-0000ac30: 206d 6573 7361 6765 3a20 6772 6170 6871   message: graphq
-0000ac40: 6c2e 4d65 7373 6167 6520 7c20 6d71 7474  l.Message | mqtt
-0000ac50: 2e4d 6573 7361 6765 2c0a 2020 2020 2020  .Message,.      
-0000ac60: 2020 7265 706c 795f 746f 3a20 6d71 7474    reply_to: mqtt
-0000ac70: 2e4d 6573 7361 6765 207c 204e 6f6e 6520  .Message | None 
-0000ac80: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-0000ac90: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-0000aca0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000acb0: 6177 6169 7420 7365 6c66 2e5f 6861 6e64  await self._hand
-0000acc0: 6c65 5f66 6163 6562 6f6f 6b5f 6d65 7373  le_facebook_mess
-0000acd0: 6167 6528 736f 7572 6365 2c20 7365 6e64  age(source, send
-0000ace0: 6572 2c20 6d65 7373 6167 652c 2072 6570  er, message, rep
-0000acf0: 6c79 5f74 6f29 0a20 2020 2020 2020 2065  ly_to).        e
-0000ad00: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0000ad10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ad20: 662e 6c6f 672e 6578 6365 7074 696f 6e28  f.log.exception(
-0000ad30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ad40: 2022 4572 726f 7220 6861 6e64 6c69 6e67   "Error handling
-0000ad50: 2046 6163 6562 6f6f 6b20 6d65 7373 6167   Facebook messag
-0000ad60: 6520 2573 222c 0a20 2020 2020 2020 2020  e %s",.         
-0000ad70: 2020 2020 2020 206d 6573 7361 6765 2e6d         message.m
-0000ad80: 6573 7361 6765 5f69 640a 2020 2020 2020  essage_id.      
-0000ad90: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0000ada0: 6e73 7461 6e63 6528 6d65 7373 6167 652c  nstance(message,
-0000adb0: 2067 7261 7068 716c 2e4d 6573 7361 6765   graphql.Message
-0000adc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000add0: 2020 656c 7365 206d 6573 7361 6765 2e6d    else message.m
-0000ade0: 6574 6164 6174 612e 6964 2c0a 2020 2020  etadata.id,.    
-0000adf0: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
-0000ae00: 7379 6e63 2064 6566 205f 6861 6e64 6c65  sync def _handle
-0000ae10: 5f66 6163 6562 6f6f 6b5f 6d65 7373 6167  _facebook_messag
-0000ae20: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-0000ae30: 0a20 2020 2020 2020 2073 6f75 7263 653a  .        source:
-0000ae40: 2075 2e55 7365 722c 0a20 2020 2020 2020   u.User,.       
-0000ae50: 2073 656e 6465 723a 2070 2e50 7570 7065   sender: p.Puppe
-0000ae60: 742c 0a20 2020 2020 2020 206d 6573 7361  t,.        messa
-0000ae70: 6765 3a20 6772 6170 6871 6c2e 4d65 7373  ge: graphql.Mess
-0000ae80: 6167 6520 7c20 6d71 7474 2e4d 6573 7361  age | mqtt.Messa
-0000ae90: 6765 2c0a 2020 2020 2020 2020 7265 706c  ge,.        repl
-0000aea0: 795f 746f 3a20 6d71 7474 2e4d 6573 7361  y_to: mqtt.Messa
-0000aeb0: 6765 207c 204e 6f6e 6520 3d20 4e6f 6e65  ge | None = None
-0000aec0: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-0000aed0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0000aee0: 7374 616e 6365 286d 6573 7361 6765 2c20  stance(message, 
-0000aef0: 6772 6170 6871 6c2e 4d65 7373 6167 6529  graphql.Message)
-0000af00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0000af10: 6c66 2e6c 6f67 2e74 7261 6365 2822 4661  lf.log.trace("Fa
-0000af20: 6365 626f 6f6b 2047 7261 7068 514c 2065  cebook GraphQL e
-0000af30: 7665 6e74 2063 6f6e 7465 6e74 3a20 2573  vent content: %s
-0000af40: 222c 206d 6573 7361 6765 290a 2020 2020  ", message).    
-0000af50: 2020 2020 2020 2020 6d73 675f 6964 203d          msg_id =
-0000af60: 206d 6573 7361 6765 2e6d 6573 7361 6765   message.message
-0000af70: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-0000af80: 6f74 6920 3d20 696e 7428 6d65 7373 6167  oti = int(messag
-0000af90: 652e 6f66 666c 696e 655f 7468 7265 6164  e.offline_thread
-0000afa0: 696e 675f 6964 290a 2020 2020 2020 2020  ing_id).        
-0000afb0: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
-0000afc0: 6d65 7373 6167 652e 7469 6d65 7374 616d  message.timestam
-0000afd0: 700a 0a20 2020 2020 2020 2020 2020 2064  p..            d
-0000afe0: 6566 2062 6163 6b66 696c 6c5f 7265 6163  ef backfill_reac
-0000aff0: 7469 6f6e 7328 6462 6d3a 2044 424d 6573  tions(dbm: DBMes
-0000b000: 7361 6765 207c 204e 6f6e 6529 3a0a 2020  sage | None):.  
-0000b010: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0000b020: 796e 6369 6f2e 6372 6561 7465 5f74 6173  yncio.create_tas
-0000b030: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
-0000b040: 2020 2020 2020 2073 656c 662e 5f74 7279         self._try
-0000b050: 5f68 616e 646c 655f 6772 6170 6871 6c5f  _handle_graphql_
-0000b060: 7265 6163 7469 6f6e 7328 0a20 2020 2020  reactions(.     
-0000b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b080: 2020 2073 6f75 7263 652c 2064 626d 206f     source, dbm o
-0000b090: 7220 6d73 675f 6964 2c20 6d65 7373 6167  r msg_id, messag
-0000b0a0: 652e 6d65 7373 6167 655f 7265 6163 7469  e.message_reacti
-0000b0b0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
-0000b0c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000b0d0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000b0e0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0000b0f0: 616e 6365 286d 6573 7361 6765 2c20 6d71  ance(message, mq
-0000b100: 7474 2e4d 6573 7361 6765 293a 0a20 2020  tt.Message):.   
-0000b110: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000b120: 672e 7472 6163 6528 2246 6163 6562 6f6f  g.trace("Faceboo
-0000b130: 6b20 4d51 5454 2065 7665 6e74 2063 6f6e  k MQTT event con
-0000b140: 7465 6e74 3a20 2573 222c 206d 6573 7361  tent: %s", messa
-0000b150: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
-0000b160: 6d73 675f 6964 203d 206d 6573 7361 6765  msg_id = message
-0000b170: 2e6d 6574 6164 6174 612e 6964 0a20 2020  .metadata.id.   
-0000b180: 2020 2020 2020 2020 206f 7469 203d 206d           oti = m
-0000b190: 6573 7361 6765 2e6d 6574 6164 6174 612e  essage.metadata.
-0000b1a0: 6f66 666c 696e 655f 7468 7265 6164 696e  offline_threadin
-0000b1b0: 675f 6964 0a20 2020 2020 2020 2020 2020  g_id.           
-0000b1c0: 2074 696d 6573 7461 6d70 203d 206d 6573   timestamp = mes
-0000b1d0: 7361 6765 2e6d 6574 6164 6174 612e 7469  sage.metadata.ti
-0000b1e0: 6d65 7374 616d 700a 0a20 2020 2020 2020  mestamp..       
-0000b1f0: 2020 2020 2064 6566 2062 6163 6b66 696c       def backfil
-0000b200: 6c5f 7265 6163 7469 6f6e 7328 5f29 3a0a  l_reactions(_):.
-0000b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b220: 7061 7373 0a0a 2020 2020 2020 2020 656c  pass..        el
-0000b230: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000b240: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0000b250: 2866 2249 6e76 616c 6964 206d 6573 7361  (f"Invalid messa
-0000b260: 6765 2063 6c61 7373 207b 7479 7065 286d  ge class {type(m
-0000b270: 6573 7361 6765 292e 5f5f 6e61 6d65 5f5f  essage).__name__
-0000b280: 7d22 290a 0a20 2020 2020 2020 2023 2043  }")..        # C
-0000b290: 6865 636b 2069 6e2d 6d65 6d6f 7279 2071  heck in-memory q
-0000b2a0: 7565 7565 7320 666f 7220 6475 706c 6963  ueues for duplic
-0000b2b0: 6174 6573 0a20 2020 2020 2020 2069 6620  ates.        if 
-0000b2c0: 6f74 6920 696e 2073 656c 662e 5f6f 7469  oti in self._oti
-0000b2d0: 5f64 6564 7570 3a0a 2020 2020 2020 2020  _dedup:.        
-0000b2e0: 2020 2020 6462 6d20 3d20 7365 6c66 2e5f      dbm = self._
-0000b2f0: 6f74 695f 6465 6475 702e 706f 7028 6f74  oti_dedup.pop(ot
-0000b300: 6929 0a20 2020 2020 2020 2020 2020 2073  i).            s
-0000b310: 656c 662e 5f64 6564 7570 2e61 7070 656e  elf._dedup.appen
-0000b320: 646c 6566 7428 6d73 675f 6964 290a 2020  dleft(msg_id).  
-0000b330: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0000b340: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0000b350: 2020 2020 2020 2020 2020 6622 476f 7420            f"Got 
-0000b360: 6d65 7373 6167 6520 4944 207b 6d73 675f  message ID {msg_
-0000b370: 6964 7d20 666f 7220 6f66 666c 696e 6520  id} for offline 
-0000b380: 7468 7265 6164 696e 6720 4944 207b 6f74  threading ID {ot
-0000b390: 697d 202f 207b 6462 6d2e 6d78 6964 7d22  i} / {dbm.mxid}"
-0000b3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b3b0: 2022 2028 696e 2064 6564 7570 2071 7565   " (in dedup que
-0000b3c0: 7565 2922 0a20 2020 2020 2020 2020 2020  ue)".           
-0000b3d0: 2029 0a20 2020 2020 2020 2020 2020 2064   ).            d
-0000b3e0: 626d 2e66 6269 6420 3d20 6d73 675f 6964  bm.fbid = msg_id
-0000b3f0: 0a20 2020 2020 2020 2020 2020 2064 626d  .            dbm
-0000b400: 2e74 696d 6573 7461 6d70 203d 2074 696d  .timestamp = tim
-0000b410: 6573 7461 6d70 0a20 2020 2020 2020 2020  estamp.         
-0000b420: 2020 2061 7761 6974 2064 626d 2e75 7064     await dbm.upd
-0000b430: 6174 6528 290a 2020 2020 2020 2020 2020  ate().          
-0000b440: 2020 6261 636b 6669 6c6c 5f72 6561 6374    backfill_react
-0000b450: 696f 6e73 2864 626d 290a 2020 2020 2020  ions(dbm).      
-0000b460: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0000b470: 2020 2020 2065 6c69 6620 6d73 675f 6964       elif msg_id
-0000b480: 2069 6e20 7365 6c66 2e5f 6465 6475 703a   in self._dedup:
-0000b490: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000b4a0: 662e 6c6f 672e 7472 6163 6528 224e 6f74  f.log.trace("Not
-0000b4b0: 2068 616e 646c 696e 6720 6d65 7373 6167   handling messag
-0000b4c0: 6520 2573 2c20 666f 756e 6420 4944 2069  e %s, found ID i
-0000b4d0: 6e20 6465 6475 7020 7175 6575 6522 2c20  n dedup queue", 
-0000b4e0: 6d73 675f 6964 290a 2020 2020 2020 2020  msg_id).        
-0000b4f0: 2020 2020 6261 636b 6669 6c6c 5f72 6561      backfill_rea
-0000b500: 6374 696f 6e73 284e 6f6e 6529 0a20 2020  ctions(None).   
-0000b510: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0000b520: 0a20 2020 2020 2020 2073 656c 662e 5f64  .        self._d
-0000b530: 6564 7570 2e61 7070 656e 646c 6566 7428  edup.appendleft(
-0000b540: 6d73 675f 6964 290a 0a20 2020 2020 2020  msg_id)..       
-0000b550: 2023 2043 6865 636b 2064 6174 6162 6173   # Check databas
-0000b560: 6520 666f 7220 6475 706c 6963 6174 6573  e for duplicates
-0000b570: 0a20 2020 2020 2020 2064 626d 203d 2061  .        dbm = a
-0000b580: 7761 6974 2044 424d 6573 7361 6765 2e67  wait DBMessage.g
-0000b590: 6574 5f62 795f 6662 6964 5f6f 725f 6f74  et_by_fbid_or_ot
-0000b5a0: 6928 6d73 675f 6964 2c20 6f74 692c 2073  i(msg_id, oti, s
-0000b5b0: 656c 662e 6662 5f72 6563 6569 7665 722c  elf.fb_receiver,
-0000b5c0: 2073 656e 6465 722e 6662 6964 290a 2020   sender.fbid).  
-0000b5d0: 2020 2020 2020 6966 2064 626d 3a0a 2020        if dbm:.  
-0000b5e0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000b5f0: 2064 626d 2e66 6269 643a 0a20 2020 2020   dbm.fbid:.     
-0000b600: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000b610: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0000b620: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000b630: 2247 6f74 206d 6573 7361 6765 2049 4420  "Got message ID 
-0000b640: 7b6d 7367 5f69 647d 2066 6f72 206f 6666  {msg_id} for off
-0000b650: 6c69 6e65 2074 6872 6561 6469 6e67 2049  line threading I
-0000b660: 4420 7b64 626d 2e66 625f 7478 6e5f 6964  D {dbm.fb_txn_id
-0000b670: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-0000b680: 2020 2020 2020 2020 6622 2f20 7b64 626d          f"/ {dbm
-0000b690: 2e6d 7869 647d 2028 696e 2064 6174 6162  .mxid} (in datab
-0000b6a0: 6173 6529 220a 2020 2020 2020 2020 2020  ase)".          
-0000b6b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000b6c0: 2020 2020 2020 2020 6462 6d2e 6662 6964          dbm.fbid
-0000b6d0: 203d 206d 7367 5f69 640a 2020 2020 2020   = msg_id.      
-0000b6e0: 2020 2020 2020 2020 2020 6462 6d2e 7469            dbm.ti
-0000b6f0: 6d65 7374 616d 7020 3d20 7469 6d65 7374  mestamp = timest
-0000b700: 616d 700a 2020 2020 2020 2020 2020 2020  amp.            
-0000b710: 2020 2020 6177 6169 7420 6462 6d2e 7570      await dbm.up
-0000b720: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
-0000b730: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b740: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000b750: 672e 6465 6275 6728 6622 4e6f 7420 6861  g.debug(f"Not ha
-0000b760: 6e64 6c69 6e67 206d 6573 7361 6765 207b  ndling message {
-0000b770: 6d73 675f 6964 7d2c 2066 6f75 6e64 2064  msg_id}, found d
-0000b780: 7570 6c69 6361 7465 2069 6e20 6461 7461  uplicate in data
-0000b790: 6261 7365 2229 0a20 2020 2020 2020 2020  base").         
-0000b7a0: 2020 2062 6163 6b66 696c 6c5f 7265 6163     backfill_reac
-0000b7b0: 7469 6f6e 7328 6462 6d29 0a20 2020 2020  tions(dbm).     
-0000b7c0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-0000b7d0: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
-0000b7e0: 6465 6275 6728 6622 4861 6e64 6c69 6e67  debug(f"Handling
-0000b7f0: 2046 6163 6562 6f6f 6b20 6576 656e 7420   Facebook event 
-0000b800: 7b6d 7367 5f69 647d 2028 2f7b 6f74 697d  {msg_id} (/{oti}
-0000b810: 2922 290a 2020 2020 2020 2020 6966 206e  )").        if n
-0000b820: 6f74 2073 656c 662e 6d78 6964 3a0a 2020  ot self.mxid:.  
-0000b830: 2020 2020 2020 2020 2020 6d78 6964 203d            mxid =
-0000b840: 2061 7761 6974 2073 656c 662e 6372 6561   await self.crea
-0000b850: 7465 5f6d 6174 7269 785f 726f 6f6d 2873  te_matrix_room(s
-0000b860: 6f75 7263 6529 0a20 2020 2020 2020 2020  ource).         
-0000b870: 2020 2069 6620 6e6f 7420 6d78 6964 3a0a     if not mxid:.
-0000b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b890: 2320 4661 696c 6564 2074 6f20 6372 6561  # Failed to crea
-0000b8a0: 7465 0a20 2020 2020 2020 2020 2020 2020  te.             
-0000b8b0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0000b8c0: 2020 6966 206e 6f74 2061 7761 6974 2073    if not await s
-0000b8d0: 656c 662e 5f62 7269 6467 655f 6f77 6e5f  elf._bridge_own_
-0000b8e0: 6d65 7373 6167 655f 706d 2873 6f75 7263  message_pm(sourc
-0000b8f0: 652c 2073 656e 6465 722c 2066 226d 6573  e, sender, f"mes
-0000b900: 7361 6765 207b 6d73 675f 6964 7d22 293a  sage {msg_id}"):
-0000b910: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000b920: 7572 6e0a 2020 2020 2020 2020 696e 7465  urn.        inte
-0000b930: 6e74 203d 2073 656e 6465 722e 696e 7465  nt = sender.inte
-0000b940: 6e74 5f66 6f72 2873 656c 6629 0a20 2020  nt_for(self).   
-0000b950: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
-0000b960: 2020 2020 2020 7365 6c66 2e5f 6261 636b        self._back
-0000b970: 6669 6c6c 5f6c 6561 7665 2069 7320 6e6f  fill_leave is no
-0000b980: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
-0000b990: 2020 2061 6e64 2073 656c 662e 6662 6964     and self.fbid
-0000b9a0: 2021 3d20 7365 6e64 6572 2e66 6269 640a   != sender.fbid.
-0000b9b0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-0000b9c0: 696e 7465 6e74 2021 3d20 7365 6e64 6572  intent != sender
-0000b9d0: 2e69 6e74 656e 740a 2020 2020 2020 2020  .intent.        
-0000b9e0: 2020 2020 616e 6420 696e 7465 6e74 206e      and intent n
-0000b9f0: 6f74 2069 6e20 7365 6c66 2e5f 6261 636b  ot in self._back
-0000ba00: 6669 6c6c 5f6c 6561 7665 0a20 2020 2020  fill_leave.     
-0000ba10: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0000ba20: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
-0000ba30: 2822 4164 6469 6e67 2025 7327 7320 6465  ("Adding %s's de
-0000ba40: 6661 756c 7420 7075 7070 6574 2074 6f20  fault puppet to 
-0000ba50: 726f 6f6d 2066 6f72 2062 6163 6b66 696c  room for backfil
-0000ba60: 6c69 6e67 222c 2073 656e 6465 722e 6d78  ling", sender.mx
-0000ba70: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
-0000ba80: 6177 6169 7420 7365 6c66 2e6d 6169 6e5f  await self.main_
-0000ba90: 696e 7465 6e74 2e69 6e76 6974 655f 7573  intent.invite_us
-0000baa0: 6572 2873 656c 662e 6d78 6964 2c20 696e  er(self.mxid, in
-0000bab0: 7465 6e74 2e6d 7869 6429 0a20 2020 2020  tent.mxid).     
-0000bac0: 2020 2020 2020 2061 7761 6974 2069 6e74         await int
-0000bad0: 656e 742e 656e 7375 7265 5f6a 6f69 6e65  ent.ensure_joine
-0000bae0: 6428 7365 6c66 2e6d 7869 6429 0a20 2020  d(self.mxid).   
-0000baf0: 2020 2020 2020 2020 2073 656c 662e 5f62           self._b
-0000bb00: 6163 6b66 696c 6c5f 6c65 6176 652e 6164  ackfill_leave.ad
-0000bb10: 6428 696e 7465 6e74 290a 0a20 2020 2020  d(intent)..     
-0000bb20: 2020 2065 7665 6e74 5f69 6473 203d 205b     event_ids = [
-0000bb30: 5d0a 2020 2020 2020 2020 6966 206d 6573  ].        if mes
-0000bb40: 7361 6765 2e6d 6f6e 7461 6765 5f72 6570  sage.montage_rep
-0000bb50: 6c79 5f64 6174 6120 616e 6420 6d65 7373  ly_data and mess
-0000bb60: 6167 652e 6d6f 6e74 6167 655f 7265 706c  age.montage_repl
-0000bb70: 795f 6461 7461 2e73 6e69 7070 6574 3a0a  y_data.snippet:.
-0000bb80: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000bb90: 745f 6964 732e 6170 7065 6e64 2861 7761  t_ids.append(awa
-0000bba0: 6974 2073 656c 662e 5f68 616e 646c 655f  it self._handle_
-0000bbb0: 6661 6365 626f 6f6b 5f73 746f 7279 5f72  facebook_story_r
-0000bbc0: 6570 6c79 2869 6e74 656e 742c 206d 6573  eply(intent, mes
-0000bbd0: 7361 6765 2c20 7469 6d65 7374 616d 7029  sage, timestamp)
-0000bbe0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-0000bbf0: 6e73 7461 6e63 6528 6d65 7373 6167 652c  nstance(message,
-0000bc00: 2067 7261 7068 716c 2e4d 6573 7361 6765   graphql.Message
-0000bc10: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-0000bc20: 7665 6e74 5f69 6473 202b 3d20 6177 6169  vent_ids += awai
-0000bc30: 7420 7365 6c66 2e5f 6861 6e64 6c65 5f67  t self._handle_g
-0000bc40: 7261 7068 716c 5f6d 6573 7361 6765 2873  raphql_message(s
-0000bc50: 6f75 7263 652c 2069 6e74 656e 742c 206d  ource, intent, m
-0000bc60: 6573 7361 6765 290a 2020 2020 2020 2020  essage).        
-0000bc70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000bc80: 2020 6576 656e 745f 6964 7320 2b3d 2061    event_ids += a
-0000bc90: 7761 6974 2073 656c 662e 5f68 616e 646c  wait self._handl
-0000bca0: 655f 6d71 7474 5f6d 6573 7361 6765 2873  e_mqtt_message(s
-0000bcb0: 6f75 7263 652c 2069 6e74 656e 742c 206d  ource, intent, m
-0000bcc0: 6573 7361 6765 2c20 7265 706c 795f 746f  essage, reply_to
-0000bcd0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000bce0: 2065 7665 6e74 5f69 6473 3a0a 2020 2020   event_ids:.    
-0000bcf0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000bd00: 2e77 6172 6e69 6e67 2866 2255 6e68 616e  .warning(f"Unhan
-0000bd10: 646c 6564 204d 6573 7365 6e67 6572 206d  dled Messenger m
-0000bd20: 6573 7361 6765 207b 6d73 675f 6964 7d22  essage {msg_id}"
-0000bd30: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000bd40: 7475 726e 0a20 2020 2020 2020 2065 7665  turn.        eve
-0000bd50: 6e74 5f69 6473 203d 205b 6576 656e 745f  nt_ids = [event_
-0000bd60: 6964 2066 6f72 2065 7665 6e74 5f69 6420  id for event_id 
-0000bd70: 696e 2065 7665 6e74 5f69 6473 2069 6620  in event_ids if 
-0000bd80: 6576 656e 745f 6964 5d0a 2020 2020 2020  event_id].      
-0000bd90: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
-0000bda0: 2866 2248 616e 646c 6564 204d 6573 7365  (f"Handled Messe
-0000bdb0: 6e67 6572 206d 6573 7361 6765 207b 6d73  nger message {ms
-0000bdc0: 675f 6964 7d20 2d3e 207b 6576 656e 745f  g_id} -> {event_
-0000bdd0: 6964 737d 2229 0a20 2020 2020 2020 2063  ids}").        c
-0000bde0: 7265 6174 6564 5f6d 7367 7320 3d20 6177  reated_msgs = aw
-0000bdf0: 6169 7420 4442 4d65 7373 6167 652e 6275  ait DBMessage.bu
-0000be00: 6c6b 5f63 7265 6174 6528 0a20 2020 2020  lk_create(.     
-0000be10: 2020 2020 2020 2066 6269 643d 6d73 675f         fbid=msg_
-0000be20: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0000be30: 6f74 693d 6f74 692c 0a20 2020 2020 2020  oti=oti,.       
-0000be40: 2020 2020 2066 625f 6368 6174 3d73 656c       fb_chat=sel
-0000be50: 662e 6662 6964 2c0a 2020 2020 2020 2020  f.fbid,.        
-0000be60: 2020 2020 6662 5f73 656e 6465 723d 7365      fb_sender=se
-0000be70: 6e64 6572 2e66 6269 642c 0a20 2020 2020  nder.fbid,.     
-0000be80: 2020 2020 2020 2066 625f 7265 6365 6976         fb_receiv
-0000be90: 6572 3d73 656c 662e 6662 5f72 6563 6569  er=self.fb_recei
-0000bea0: 7665 722c 0a20 2020 2020 2020 2020 2020  ver,.           
-0000beb0: 206d 785f 726f 6f6d 3d73 656c 662e 6d78   mx_room=self.mx
-0000bec0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0000bed0: 7469 6d65 7374 616d 703d 7469 6d65 7374  timestamp=timest
-0000bee0: 616d 702c 0a20 2020 2020 2020 2020 2020  amp,.           
-0000bef0: 2065 7665 6e74 5f69 6473 3d65 7665 6e74   event_ids=event
-0000bf00: 5f69 6473 2c0a 2020 2020 2020 2020 290a  _ids,.        ).
-0000bf10: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-0000bf20: 6c66 2e5f 7365 6e64 5f64 656c 6976 6572  lf._send_deliver
-0000bf30: 795f 7265 6365 6970 7428 6576 656e 745f  y_receipt(event_
-0000bf40: 6964 735b 2d31 5d29 0a20 2020 2020 2020  ids[-1]).       
-0000bf50: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
-0000bf60: 6573 7361 6765 2c20 6772 6170 6871 6c2e  essage, graphql.
-0000bf70: 4d65 7373 6167 6529 2061 6e64 206d 6573  Message) and mes
-0000bf80: 7361 6765 2e6d 6573 7361 6765 5f72 6561  sage.message_rea
-0000bf90: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-0000bfa0: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-0000bfb0: 6861 6e64 6c65 5f67 7261 7068 716c 5f72  handle_graphql_r
-0000bfc0: 6561 6374 696f 6e73 280a 2020 2020 2020  eactions(.      
-0000bfd0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000bfe0: 2c20 6372 6561 7465 645f 6d73 6773 5b30  , created_msgs[0
-0000bff0: 5d2c 206d 6573 7361 6765 2e6d 6573 7361  ], message.messa
-0000c000: 6765 5f72 6561 6374 696f 6e73 2c20 7469  ge_reactions, ti
-0000c010: 6d65 7374 616d 700a 2020 2020 2020 2020  mestamp.        
-0000c020: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
-0000c030: 2064 6566 205f 6861 6e64 6c65 5f66 6163   def _handle_fac
-0000c040: 6562 6f6f 6b5f 7374 6f72 795f 7265 706c  ebook_story_repl
-0000c050: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-0000c060: 2069 6e74 656e 743a 2049 6e74 656e 7441   intent: IntentA
-0000c070: 5049 2c20 6d65 7373 6167 653a 206d 7174  PI, message: mqt
-0000c080: 742e 4d65 7373 6167 6520 7c20 6772 6170  t.Message | grap
-0000c090: 6871 6c2e 4d65 7373 6167 652c 2074 696d  hql.Message, tim
-0000c0a0: 6573 7461 6d70 3a20 696e 740a 2020 2020  estamp: int.    
-0000c0b0: 2920 2d3e 2045 7665 6e74 4944 207c 204e  ) -> EventID | N
-0000c0c0: 6f6e 653a 0a20 2020 2020 2020 2074 6578  one:.        tex
-0000c0d0: 7420 3d20 6d65 7373 6167 652e 6d6f 6e74  t = message.mont
-0000c0e0: 6167 655f 7265 706c 795f 6461 7461 2e73  age_reply_data.s
-0000c0f0: 6e69 7070 6574 0a20 2020 2020 2020 2069  nippet.        i
-0000c100: 6620 6d65 7373 6167 652e 6d6f 6e74 6167  f message.montag
-0000c110: 655f 7265 706c 795f 6461 7461 2e6d 6573  e_reply_data.mes
-0000c120: 7361 6765 5f69 6420 616e 6420 6d65 7373  sage_id and mess
-0000c130: 6167 652e 6d6f 6e74 6167 655f 7265 706c  age.montage_repl
-0000c140: 795f 6461 7461 2e6d 6f6e 7461 6765 5f74  y_data.montage_t
-0000c150: 6872 6561 645f 6964 3a0a 2020 2020 2020  hread_id:.      
-0000c160: 2020 2020 2020 6361 7264 5f69 645f 6461        card_id_da
-0000c170: 7461 203d 2066 2253 3a5f 4953 433a 7b6d  ta = f"S:_ISC:{m
-0000c180: 6573 7361 6765 2e6d 6f6e 7461 6765 5f72  essage.montage_r
-0000c190: 6570 6c79 5f64 6174 612e 6d65 7373 6167  eply_data.messag
-0000c1a0: 655f 6964 7d22 0a20 2020 2020 2020 2020  e_id}".         
-0000c1b0: 2020 2073 746f 7279 5f75 726c 203d 2028     story_url = (
-0000c1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c1d0: 2055 524c 2822 6874 7470 733a 2f2f 7777   URL("https://ww
-0000c1e0: 772e 6661 6365 626f 6f6b 2e63 6f6d 2f73  w.facebook.com/s
-0000c1f0: 746f 7269 6573 2229 0a20 2020 2020 2020  tories").       
-0000c200: 2020 2020 2020 2020 202f 206d 6573 7361           / messa
-0000c210: 6765 2e6d 6f6e 7461 6765 5f72 6570 6c79  ge.montage_reply
-0000c220: 5f64 6174 612e 6d6f 6e74 6167 655f 7468  _data.montage_th
-0000c230: 7265 6164 5f69 640a 2020 2020 2020 2020  read_id.        
-0000c240: 2020 2020 2020 2020 2f20 6261 7365 3634          / base64
-0000c250: 2e62 3634 656e 636f 6465 2863 6172 645f  .b64encode(card_
-0000c260: 6964 5f64 6174 612e 656e 636f 6465 2822  id_data.encode("
-0000c270: 7574 662d 3822 2929 2e64 6563 6f64 6528  utf-8")).decode(
-0000c280: 2275 7466 2d38 2229 0a20 2020 2020 2020  "utf-8").       
-0000c290: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000c2a0: 2020 2074 6578 7420 2b3d 2066 2220 287b     text += f" ({
-0000c2b0: 7374 6f72 795f 7572 6c7d 2922 0a20 2020  story_url})".   
-0000c2c0: 2020 2020 2063 6f6e 7465 6e74 203d 2054       content = T
-0000c2d0: 6578 744d 6573 7361 6765 4576 656e 7443  extMessageEventC
-0000c2e0: 6f6e 7465 6e74 286d 7367 7479 7065 3d4d  ontent(msgtype=M
-0000c2f0: 6573 7361 6765 5479 7065 2e4e 4f54 4943  essageType.NOTIC
-0000c300: 452c 2062 6f64 793d 7465 7874 290a 2020  E, body=text).  
-0000c310: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-0000c320: 6974 2073 656c 662e 5f73 656e 645f 6d65  it self._send_me
-0000c330: 7373 6167 6528 696e 7465 6e74 2c20 636f  ssage(intent, co
-0000c340: 6e74 656e 742c 2074 696d 6573 7461 6d70  ntent, timestamp
-0000c350: 3d74 696d 6573 7461 6d70 290a 0a20 2020  =timestamp)..   
-0000c360: 2061 7379 6e63 2064 6566 205f 6861 6e64   async def _hand
-0000c370: 6c65 5f6d 7174 745f 6d65 7373 6167 6528  le_mqtt_message(
-0000c380: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000c390: 2020 2020 2020 2073 6f75 7263 653a 2075         source: u
-0000c3a0: 2e55 7365 722c 0a20 2020 2020 2020 2069  .User,.        i
-0000c3b0: 6e74 656e 743a 2049 6e74 656e 7441 5049  ntent: IntentAPI
-0000c3c0: 2c0a 2020 2020 2020 2020 6d65 7373 6167  ,.        messag
-0000c3d0: 653a 206d 7174 742e 4d65 7373 6167 652c  e: mqtt.Message,
-0000c3e0: 0a20 2020 2020 2020 2072 6570 6c79 5f74  .        reply_t
-0000c3f0: 6f3a 206d 7174 742e 4d65 7373 6167 6520  o: mqtt.Message 
-0000c400: 7c20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  | None,.    ) ->
-0000c410: 206c 6973 745b 4576 656e 7449 445d 3a0a   list[EventID]:.
-0000c420: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
-0000c430: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
-0000c440: 6620 6d65 7373 6167 652e 7374 6963 6b65  f message.sticke
-0000c450: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
-0000c460: 7665 6e74 5f69 6473 2e61 7070 656e 6428  vent_ids.append(
-0000c470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c480: 2061 7761 6974 2073 656c 662e 5f68 616e   await self._han
-0000c490: 646c 655f 6661 6365 626f 6f6b 5f73 7469  dle_facebook_sti
-0000c4a0: 636b 6572 280a 2020 2020 2020 2020 2020  cker(.          
-0000c4b0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000c4c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c4d0: 2020 2020 2020 696e 7465 6e74 2c0a 2020        intent,.  
-0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4f0: 2020 6d65 7373 6167 652e 7374 6963 6b65    message.sticke
-0000c500: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000c510: 2020 2020 2020 2072 6570 6c79 5f74 6f2c         reply_to,
-0000c520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c530: 2020 2020 206d 6573 7361 6765 2e6d 6574       message.met
-0000c540: 6164 6174 612e 7469 6d65 7374 616d 702c  adata.timestamp,
-0000c550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c560: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
-0000c570: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0000c580: 6d65 7373 6167 652e 6174 7461 6368 6d65  message.attachme
-0000c590: 6e74 7329 203e 2030 3a0a 2020 2020 2020  nts) > 0:.      
-0000c5a0: 2020 2020 2020 6174 7461 6368 5f69 6473        attach_ids
-0000c5b0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-0000c5c0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
-0000c5d0: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 7365 6c66 2e5f 6861 6e64 6c65 5f66 6163  self._handle_fac
-0000c600: 6562 6f6f 6b5f 6174 7461 6368 6d65 6e74  ebook_attachment
-0000c610: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c620: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
-0000c630: 652e 6d65 7461 6461 7461 2e69 642c 0a20  e.metadata.id,. 
-0000c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c650: 2020 2020 2020 2073 6f75 7263 652c 0a20         source,. 
-0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c670: 2020 2020 2020 2069 6e74 656e 742c 0a20         intent,. 
-0000c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c690: 2020 2020 2020 2061 7474 6163 686d 656e         attachmen
-0000c6a0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0000c6b0: 2020 2020 2020 2020 2020 2072 6570 6c79             reply
-0000c6c0: 5f74 6f2c 0a20 2020 2020 2020 2020 2020  _to,.           
-0000c6d0: 2020 2020 2020 2020 2020 2020 206d 6573               mes
-0000c6e0: 7361 6765 2e6d 6574 6164 6174 612e 7469  sage.metadata.ti
-0000c6f0: 6d65 7374 616d 702c 0a20 2020 2020 2020  mestamp,.       
-0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c710: 206d 6573 7361 6765 5f74 6578 743d 6d65   message_text=me
-0000c720: 7373 6167 652e 7465 7874 2c0a 2020 2020  ssage.text,.    
-0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c750: 2020 2020 2020 666f 7220 6174 7461 6368        for attach
-0000c760: 6d65 6e74 2069 6e20 6d65 7373 6167 652e  ment in message.
-0000c770: 6174 7461 6368 6d65 6e74 730a 2020 2020  attachments.    
-0000c780: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0000c790: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000c7a0: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
-0000c7b0: 7320 2b3d 205b 6174 7461 6368 5f69 6420  s += [attach_id 
-0000c7c0: 666f 7220 6174 7461 6368 5f69 6420 696e  for attach_id in
-0000c7d0: 2061 7474 6163 685f 6964 7320 6966 2061   attach_ids if a
-0000c7e0: 7474 6163 685f 6964 5d0a 2020 2020 2020  ttach_id].      
-0000c7f0: 2020 6966 206d 6573 7361 6765 2e74 6578    if message.tex
-0000c800: 743a 0a20 2020 2020 2020 2020 2020 2065  t:.            e
-0000c810: 7665 6e74 5f69 6473 2e61 7070 656e 6428  vent_ids.append(
-0000c820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c830: 2061 7761 6974 2073 656c 662e 5f68 616e   await self._han
-0000c840: 646c 655f 6661 6365 626f 6f6b 5f74 6578  dle_facebook_tex
-0000c850: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0000c860: 2020 2020 2020 2069 6e74 656e 742c 206d         intent, m
-0000c870: 6573 7361 6765 2c20 7265 706c 795f 746f  essage, reply_to
-0000c880: 2c20 6d65 7373 6167 652e 6d65 7461 6461  , message.metada
-0000c890: 7461 2e74 696d 6573 7461 6d70 0a20 2020  ta.timestamp.   
-0000c8a0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000c8b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000c8c0: 2020 2020 2072 6574 7572 6e20 6576 656e       return even
-0000c8d0: 745f 6964 730a 0a20 2020 2061 7379 6e63  t_ids..    async
-0000c8e0: 2064 6566 205f 636f 6e76 6572 745f 6578   def _convert_ex
-0000c8f0: 7465 6e73 6962 6c65 5f6d 6564 6961 280a  tensible_media(.
-0000c900: 2020 2020 2020 2020 7365 6c66 2c20 736f          self, so
-0000c910: 7572 6365 3a20 752e 5573 6572 2c20 696e  urce: u.User, in
-0000c920: 7465 6e74 3a20 496e 7465 6e74 4150 492c  tent: IntentAPI,
-0000c930: 2073 613a 2067 7261 7068 716c 2e53 746f   sa: graphql.Sto
-0000c940: 7279 4174 7461 6368 6d65 6e74 2c20 6d65  ryAttachment, me
-0000c950: 7373 6167 655f 7465 7874 3a20 7374 720a  ssage_text: str.
-0000c960: 2020 2020 2920 2d3e 204d 6573 7361 6765      ) -> Message
-0000c970: 4576 656e 7443 6f6e 7465 6e74 207c 204e  EventContent | N
-0000c980: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0000c990: 7361 2e74 6172 6765 7420 616e 6420 7361  sa.target and sa
-0000c9a0: 2e74 6172 6765 742e 7479 7065 6e61 6d65  .target.typename
-0000c9b0: 203d 3d20 6772 6170 6871 6c2e 4174 7461   == graphql.Atta
-0000c9c0: 6368 6d65 6e74 5479 7065 2e45 5854 4552  chmentType.EXTER
-0000c9d0: 4e41 4c5f 5552 4c3a 0a20 2020 2020 2020  NAL_URL:.       
-0000c9e0: 2020 2020 2075 726c 203d 2073 7472 2873       url = str(s
-0000c9f0: 612e 636c 6561 6e5f 7572 6c29 0a20 2020  a.clean_url).   
-0000ca00: 2020 2020 2020 2020 2069 6620 6d65 7373           if mess
-0000ca10: 6167 655f 7465 7874 2069 7320 6e6f 7420  age_text is not 
-0000ca20: 4e6f 6e65 2061 6e64 2075 726c 2069 6e20  None and url in 
-0000ca30: 6d65 7373 6167 655f 7465 7874 3a0a 2020  message_text:.  
-0000ca40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000ca50: 5552 4c20 6973 2070 7265 7365 6e74 2069  URL is present i
-0000ca60: 6e20 6d65 7373 6167 652c 2064 6f6e 2774  n message, don't
-0000ca70: 2072 6570 6f73 740a 2020 2020 2020 2020   repost.        
-0000ca80: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0000ca90: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000caa0: 6573 6361 7065 645f 7572 6c20 3d20 6573  escaped_url = es
-0000cab0: 6361 7065 2875 726c 290a 2020 2020 2020  cape(url).      
-0000cac0: 2020 2020 2020 7265 7475 726e 2054 6578        return Tex
-0000cad0: 744d 6573 7361 6765 4576 656e 7443 6f6e  tMessageEventCon
-0000cae0: 7465 6e74 280a 2020 2020 2020 2020 2020  tent(.          
-0000caf0: 2020 2020 2020 6d73 6774 7970 653d 4d65        msgtype=Me
-0000cb00: 7373 6167 6554 7970 652e 5445 5854 2c0a  ssageType.TEXT,.
-0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb20: 666f 726d 6174 3d46 6f72 6d61 742e 4854  format=Format.HT
-0000cb30: 4d4c 2c0a 2020 2020 2020 2020 2020 2020  ML,.            
-0000cb40: 2020 2020 626f 6479 3d73 7472 2873 612e      body=str(sa.
-0000cb50: 636c 6561 6e5f 7572 6c29 2c0a 2020 2020  clean_url),.    
-0000cb60: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0000cb70: 6174 7465 645f 626f 6479 3d66 273c 6120  atted_body=f'<a 
-0000cb80: 6872 6566 3d22 7b65 7363 6170 6564 5f75  href="{escaped_u
-0000cb90: 726c 7d22 3e7b 6573 6361 7065 645f 7572  rl}">{escaped_ur
-0000cba0: 6c7d 3c2f 613e 272c 0a20 2020 2020 2020  l}</a>',.       
-0000cbb0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-0000cbc0: 6c69 6620 7361 2e6d 6564 6961 3a0a 2020  lif sa.media:.  
-0000cbd0: 2020 2020 2020 2020 2020 6d73 6774 7970            msgtyp
-0000cbe0: 6520 3d20 7b0a 2020 2020 2020 2020 2020  e = {.          
-0000cbf0: 2020 2020 2020 2249 6d61 6765 223a 204d        "Image": M
-0000cc00: 6573 7361 6765 5479 7065 2e49 4d41 4745  essageType.IMAGE
-0000cc10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cc20: 2020 2256 6964 656f 223a 204d 6573 7361    "Video": Messa
-0000cc30: 6765 5479 7065 2e56 4944 454f 2c0a 2020  geType.VIDEO,.  
-0000cc40: 2020 2020 2020 2020 2020 7d2e 6765 7428            }.get(
-0000cc50: 7361 2e6d 6564 6961 2e74 7970 656e 616d  sa.media.typenam
-0000cc60: 655f 7374 7229 0a20 2020 2020 2020 2020  e_str).         
-0000cc70: 2020 2069 6620 7361 2e6d 6564 6961 2e70     if sa.media.p
-0000cc80: 6c61 7961 626c 655f 7572 6c20 616e 6420  layable_url and 
-0000cc90: 6d73 6774 7970 6520 3d3d 204d 6573 7361  msgtype == Messa
-0000cca0: 6765 5479 7065 2e56 4944 454f 3a0a 2020  geType.VIDEO:.  
-0000ccb0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000ccc0: 666f 203d 2056 6964 656f 496e 666f 2829  fo = VideoInfo()
-0000ccd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cce0: 2075 726c 203d 2073 612e 6d65 6469 612e   url = sa.media.
-0000ccf0: 706c 6179 6162 6c65 5f75 726c 0a20 2020  playable_url.   
-0000cd00: 2020 2020 2020 2020 2065 6c69 6620 7361           elif sa
-0000cd10: 2e6d 6564 6961 2e69 6d61 6765 5f6e 6174  .media.image_nat
-0000cd20: 7572 616c 2061 6e64 206d 7367 7479 7065  ural and msgtype
-0000cd30: 203d 3d20 4d65 7373 6167 6554 7970 652e   == MessageType.
-0000cd40: 494d 4147 453a 0a20 2020 2020 2020 2020  IMAGE:.         
-0000cd50: 2020 2020 2020 2075 726c 203d 2073 612e         url = sa.
-0000cd60: 6d65 6469 612e 696d 6167 655f 6e61 7475  media.image_natu
-0000cd70: 7261 6c2e 7572 690a 2020 2020 2020 2020  ral.uri.        
-0000cd80: 2020 2020 2020 2020 696e 666f 203d 2049          info = I
-0000cd90: 6d61 6765 496e 666f 280a 2020 2020 2020  mageInfo(.      
-0000cda0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0000cdb0: 6474 683d 7361 2e6d 6564 6961 2e69 6d61  dth=sa.media.ima
-0000cdc0: 6765 5f6e 6174 7572 616c 2e77 6964 7468  ge_natural.width
-0000cdd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cde0: 2020 2020 2020 6865 6967 6874 3d73 612e        height=sa.
-0000cdf0: 6d65 6469 612e 696d 6167 655f 6e61 7475  media.image_natu
-0000ce00: 7261 6c2e 6865 6967 6874 2c0a 2020 2020  ral.height,.    
-0000ce10: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000ce20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce40: 7365 6c66 2e6c 6f67 2e74 7261 6365 2822  self.log.trace("
-0000ce50: 556e 7375 7070 6f72 7465 6420 7374 6f72  Unsupported stor
-0000ce60: 7920 6d65 6469 6120 6174 7461 6368 6d65  y media attachme
-0000ce70: 6e74 3a20 2573 222c 2073 612e 7365 7269  nt: %s", sa.seri
-0000ce80: 616c 697a 6528 2929 0a20 2020 2020 2020  alize()).       
-0000ce90: 2020 2020 2020 2020 2062 6f64 7920 3d20           body = 
-0000cea0: 2255 6e73 7570 706f 7274 6564 2073 6861  "Unsupported sha
-0000ceb0: 7265 6420 6d65 6469 6120 6174 7461 6368  red media attach
-0000cec0: 6d65 6e74 220a 2020 2020 2020 2020 2020  ment".          
-0000ced0: 2020 2020 2020 6874 6d6c 203d 2062 6f64        html = bod
-0000cee0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0000cef0: 2020 6966 2073 612e 7469 746c 653a 0a20    if sa.title:. 
-0000cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf10: 2020 2062 6f64 7920 3d20 6622 7b62 6f64     body = f"{bod
-0000cf20: 797d 3a20 2a2a 7b73 612e 7469 746c 657d  y}: **{sa.title}
-0000cf30: 2a2a 220a 2020 2020 2020 2020 2020 2020  **".            
-0000cf40: 2020 2020 2020 2020 6874 6d6c 203d 2066          html = f
-0000cf50: 227b 6874 6d6c 7d3a 203c 7374 726f 6e67  "{html}: <strong
-0000cf60: 3e7b 6573 6361 7065 2873 612e 7469 746c  >{escape(sa.titl
-0000cf70: 6529 7d3c 2f73 7472 6f6e 673e 220a 2020  e)}</strong>".  
-0000cf80: 2020 2020 2020 2020 2020 2020 2020 6874                ht
-0000cf90: 6d6c 203d 2066 223c 703e 7b68 746d 6c7d  ml = f"<p>{html}
-0000cfa0: 3c2f 703e 220a 2020 2020 2020 2020 2020  </p>".          
-0000cfb0: 2020 2020 2020 6966 2073 612e 6465 7363        if sa.desc
-0000cfc0: 7269 7074 696f 6e20 616e 6420 7361 2e64  ription and sa.d
-0000cfd0: 6573 6372 6970 7469 6f6e 2e74 6578 7420  escription.text 
-0000cfe0: 213d 2022 6d73 6e67 722e 636f 6d22 3a0a  != "msngr.com":.
-0000cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d000: 2020 2020 626f 6479 202b 3d20 6622 5c6e      body += f"\n
-0000d010: 5c6e 3e7b 7361 2e64 6573 6372 6970 7469  \n>{sa.descripti
-0000d020: 6f6e 2e74 6578 747d 220a 2020 2020 2020  on.text}".      
-0000d030: 2020 2020 2020 2020 2020 2020 2020 6874                ht
-0000d040: 6d6c 202b 3d20 6622 3c62 6c6f 636b 7175  ml += f"<blockqu
-0000d050: 6f74 653e 7b65 7363 6170 6528 7361 2e64  ote>{escape(sa.d
-0000d060: 6573 6372 6970 7469 6f6e 2e74 6578 7429  escription.text)
-0000d070: 7d3c 2f62 6c6f 636b 7175 6f74 653e 220a  }</blockquote>".
-0000d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d090: 6966 2073 612e 7572 6c3a 0a20 2020 2020  if sa.url:.     
-0000d0a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000d0b0: 6f64 7920 2b3d 2066 225c 6e5c 6e7b 7361  ody += f"\n\n{sa
-0000d0c0: 2e75 726c 7d22 0a20 2020 2020 2020 2020  .url}".         
-0000d0d0: 2020 2020 2020 2020 2020 2068 746d 6c20             html 
-0000d0e0: 2b3d 2066 223c 703e 3c61 2068 7265 663d  += f"<p><a href=
-0000d0f0: 277b 7361 2e75 726c 7d27 3e4f 7065 6e20  '{sa.url}'>Open 
-0000d100: 6578 7465 726e 616c 206c 696e 6b3c 2f61  external link</a
-0000d110: 3e3c 2f70 3e22 0a20 2020 2020 2020 2020  ></p>".         
-0000d120: 2020 2020 2020 2065 6c69 6620 7361 2e61         elif sa.a
-0000d130: 6374 696f 6e5f 6c69 6e6b 733a 0a20 2020  ction_links:.   
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2075 726c 7320 3d20 5b69 7465 6d2e 7572   urls = [item.ur
-0000d160: 6c20 666f 7220 6974 656d 2069 6e20 7361  l for item in sa
-0000d170: 2e61 6374 696f 6e5f 6c69 6e6b 7320 6966  .action_links if
-0000d180: 2069 7465 6d2e 7572 6c5d 0a20 2020 2020   item.url].     
-0000d190: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000d1a0: 6620 6c65 6e28 7572 6c73 2920 3e20 303a  f len(urls) > 0:
-0000d1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d1c0: 2020 2020 2020 2020 2073 612e 7572 6c20           sa.url 
-0000d1d0: 3d20 7572 6c73 5b30 5d0a 2020 2020 2020  = urls[0].      
-0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1f0: 2020 626f 6479 202b 3d20 6622 5c6e 5c6e    body += f"\n\n
-0000d200: 2220 2b20 2220 2d20 222e 6a6f 696e 2875  " + " - ".join(u
-0000d210: 726c 7329 0a20 2020 2020 2020 2020 2020  rls).           
-0000d220: 2020 2020 2020 2020 2020 2020 2068 746d               htm
-0000d230: 6c5f 7061 7274 7320 3d20 5b0a 2020 2020  l_parts = [.    
-0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d250: 2020 2020 2020 2020 6622 2222 3c61 2068          f"""<a h
-0000d260: 7265 663d 227b 6974 656d 2e75 726c 7d22  ref="{item.url}"
-0000d270: 3e7b 6974 656d 2e74 6974 6c65 7d3c 2f61  >{item.title}</a
-0000d280: 3e22 2222 0a20 2020 2020 2020 2020 2020  >""".           
-0000d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2a0: 2066 6f72 2069 7465 6d20 696e 2073 612e   for item in sa.
-0000d2b0: 6163 7469 6f6e 5f6c 696e 6b73 0a20 2020  action_links.   
-0000d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2d0: 2020 2020 2020 2020 2069 6620 6974 656d           if item
-0000d2e0: 2e75 726c 0a20 2020 2020 2020 2020 2020  .url.           
-0000d2f0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
-0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d310: 2020 2020 2020 2068 746d 6c20 2b3d 2066         html += f
-0000d320: 2222 223c 703e 7b22 202d 2022 2e6a 6f69  """<p>{" - ".joi
-0000d330: 6e28 6874 6d6c 5f70 6172 7473 297d 3c2f  n(html_parts)}</
-0000d340: 703e 2222 220a 2020 2020 2020 2020 2020  p>""".          
-0000d350: 2020 2020 2020 7265 7475 726e 2054 6578        return Tex
-0000d360: 744d 6573 7361 6765 4576 656e 7443 6f6e  tMessageEventCon
-0000d370: 7465 6e74 280a 2020 2020 2020 2020 2020  tent(.          
-0000d380: 2020 2020 2020 2020 2020 6d73 6774 7970            msgtyp
-0000d390: 653d 4d65 7373 6167 6554 7970 652e 5445  e=MessageType.TE
-0000d3a0: 5854 2c0a 2020 2020 2020 2020 2020 2020  XT,.            
-0000d3b0: 2020 2020 2020 2020 666f 726d 6174 3d46          format=F
-0000d3c0: 6f72 6d61 742e 4854 4d4c 2c0a 2020 2020  ormat.HTML,.    
-0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3e0: 6578 7465 726e 616c 5f75 726c 3d73 612e  external_url=sa.
-0000d3f0: 7572 6c2c 0a20 2020 2020 2020 2020 2020  url,.           
-0000d400: 2020 2020 2020 2020 2062 6f64 793d 626f           body=bo
-0000d410: 6479 2c0a 2020 2020 2020 2020 2020 2020  dy,.            
-0000d420: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
-0000d430: 645f 626f 6479 3d68 746d 6c2c 0a20 2020  d_body=html,.   
-0000d440: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000d450: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d470: 6d78 632c 2061 6464 6974 696f 6e61 6c5f  mxc, additional_
-0000d480: 696e 666f 2c20 6465 6372 7970 7469 6f6e  info, decryption
-0000d490: 5f69 6e66 6f20 3d20 6177 6169 7420 7365  _info = await se
-0000d4a0: 6c66 2e5f 7265 7570 6c6f 6164 5f66 625f  lf._reupload_fb_
-0000d4b0: 6669 6c65 280a 2020 2020 2020 2020 2020  file(.          
-0000d4c0: 2020 2020 2020 2020 2020 7572 6c2c 2073            url, s
-0000d4d0: 6f75 7263 652c 2069 6e74 656e 742c 2065  ource, intent, e
-0000d4e0: 6e63 7279 7074 3d73 656c 662e 656e 6372  ncrypt=self.encr
-0000d4f0: 7970 7465 642c 2066 696e 645f 7369 7a65  ypted, find_size
-0000d500: 3d46 616c 7365 0a20 2020 2020 2020 2020  =False.         
-0000d510: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000d520: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
-0000d530: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
-0000d540: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000d550: 662e 6c6f 672e 6465 6275 6728 2246 6169  f.log.debug("Fai
-0000d560: 6c65 6420 746f 2072 6575 706c 6f61 6420  led to reupload 
-0000d570: 7374 6f72 7920 6174 7461 6368 6d65 6e74  story attachment
-0000d580: 206d 6564 6961 222c 2065 7863 5f69 6e66   media", exc_inf
-0000d590: 6f3d 5472 7565 290a 2020 2020 2020 2020  o=True).        
-0000d5a0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0000d5b0: 6578 744d 6573 7361 6765 4576 656e 7443  extMessageEventC
-0000d5c0: 6f6e 7465 6e74 280a 2020 2020 2020 2020  ontent(.        
-0000d5d0: 2020 2020 2020 2020 2020 2020 6d73 6774              msgt
-0000d5e0: 7970 653d 4d65 7373 6167 6554 7970 652e  ype=MessageType.
-0000d5f0: 4e4f 5449 4345 2c0a 2020 2020 2020 2020  NOTICE,.        
-0000d600: 2020 2020 2020 2020 2020 2020 626f 6479              body
-0000d610: 3d66 227b 657d 5c6e 7b73 612e 7572 6c7d  =f"{e}\n{sa.url}
-0000d620: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000d630: 2020 2020 2020 2065 7874 6572 6e61 6c5f         external_
-0000d640: 7572 6c3d 7361 2e75 726c 2c0a 2020 2020  url=sa.url,.    
-0000d650: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000d660: 2020 2020 2020 2020 2020 696e 666f 2e73            info.s
-0000d670: 697a 6520 3d20 6164 6469 7469 6f6e 616c  ize = additional
-0000d680: 5f69 6e66 6f2e 7369 7a65 0a20 2020 2020  _info.size.     
-0000d690: 2020 2020 2020 2069 6e66 6f2e 6d69 6d65         info.mime
-0000d6a0: 7479 7065 203d 2061 6464 6974 696f 6e61  type = additiona
-0000d6b0: 6c5f 696e 666f 2e6d 696d 6574 7970 650a  l_info.mimetype.
-0000d6c0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0000d6d0: 6520 3d20 7361 2e74 6974 6c65 206f 7220  e = sa.title or 
-0000d6e0: 7361 2e6d 6564 6961 2e74 7970 656e 616d  sa.media.typenam
-0000d6f0: 655f 7374 720a 2020 2020 2020 2020 2020  e_str.          
-0000d700: 2020 6669 6c65 6e61 6d65 203d 2066 227b    filename = f"{
-0000d710: 7469 746c 657d 7b6d 696d 6574 7970 6573  title}{mimetypes
-0000d720: 2e67 7565 7373 5f65 7874 656e 7369 6f6e  .guess_extension
-0000d730: 2869 6e66 6f2e 6d69 6d65 7479 7065 297d  (info.mimetype)}
-0000d740: 220a 2020 2020 2020 2020 2020 2020 636f  ".            co
-0000d750: 6e74 656e 7420 3d20 4d65 6469 614d 6573  ntent = MediaMes
-0000d760: 7361 6765 4576 656e 7443 6f6e 7465 6e74  sageEventContent
-0000d770: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d780: 2020 7572 6c3d 6d78 632c 0a20 2020 2020    url=mxc,.     
-0000d790: 2020 2020 2020 2020 2020 2066 696c 653d             file=
-0000d7a0: 6465 6372 7970 7469 6f6e 5f69 6e66 6f2c  decryption_info,
-0000d7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d7c0: 206d 7367 7479 7065 3d6d 7367 7479 7065   msgtype=msgtype
-0000d7d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d7e0: 2020 626f 6479 3d66 696c 656e 616d 652c    body=filename,
-0000d7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d800: 2069 6e66 6f3d 696e 666f 2c0a 2020 2020   info=info,.    
-0000d810: 2020 2020 2020 2020 2020 2020 6578 7465              exte
-0000d820: 726e 616c 5f75 726c 3d73 612e 7572 6c2c  rnal_url=sa.url,
-0000d830: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000d840: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000d850: 4f20 6f6e 6c79 2064 6f20 7468 6973 2069  O only do this i
-0000d860: 6620 6361 7074 696f 6e73 2061 7265 2065  f captions are e
-0000d870: 6e61 626c 6564 2069 6e20 7468 6520 636f  nabled in the co
-0000d880: 6e66 6967 0a20 2020 2020 2020 2020 2020  nfig.           
-0000d890: 2069 6620 7361 2e64 6573 6372 6970 7469   if sa.descripti
-0000d8a0: 6f6e 2061 6e64 2073 612e 6465 7363 7269  on and sa.descri
-0000d8b0: 7074 696f 6e2e 7465 7874 2021 3d20 226d  ption.text != "m
-0000d8c0: 736e 6772 2e63 6f6d 223a 0a20 2020 2020  sngr.com":.     
-0000d8d0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-0000d8e0: 6e74 5b22 6669 6c65 6e61 6d65 225d 203d  nt["filename"] =
-0000d8f0: 2063 6f6e 7465 6e74 2e62 6f64 790a 2020   content.body.  
-0000d900: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000d910: 6e74 656e 742e 626f 6479 203d 2073 612e  ntent.body = sa.
-0000d920: 6465 7363 7269 7074 696f 6e2e 7465 7874  description.text
-0000d930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d940: 2069 6620 7361 2e75 726c 3a0a 2020 2020   if sa.url:.    
-0000d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d960: 636f 6e74 656e 742e 626f 6479 202b 3d20  content.body += 
-0000d970: 6622 5c6e 5c6e 7b73 612e 7572 6c7d 220a  f"\n\n{sa.url}".
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2020 636f 6e74 656e 745b 2266 6f72      content["for
-0000d9a0: 6d61 7422 5d20 3d20 7374 7228 466f 726d  mat"] = str(Form
-0000d9b0: 6174 2e48 544d 4c29 0a20 2020 2020 2020  at.HTML).       
-0000d9c0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000d9d0: 7465 6e74 5b22 666f 726d 6174 7465 645f  tent["formatted_
-0000d9e0: 626f 6479 225d 203d 2028 0a20 2020 2020  body"] = (.     
-0000d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da00: 2020 2066 223c 703e 7b65 7363 6170 6528     f"<p>{escape(
-0000da10: 7361 2e64 6573 6372 6970 7469 6f6e 2e74  sa.description.t
-0000da20: 6578 7429 7d3c 2f70 3e22 0a20 2020 2020  ext)}</p>".     
-0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da40: 2020 2066 223c 703e 3c61 2068 7265 663d     f"<p><a href=
-0000da50: 277b 7361 2e75 726c 7d27 3e4f 7065 6e20  '{sa.url}'>Open 
-0000da60: 6578 7465 726e 616c 206c 696e 6b3c 2f61  external link</a
-0000da70: 3e3c 2f70 3e22 0a20 2020 2020 2020 2020  ></p>".         
-0000da80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000da90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000daa0: 636f 6e74 656e 740a 2020 2020 2020 2020  content.        
-0000dab0: 656c 6966 2073 612e 7572 6c20 616e 6420  elif sa.url and 
-0000dac0: 7361 2e74 6974 6c65 3a0a 2020 2020 2020  sa.title:.      
-0000dad0: 2020 2020 2020 7572 6c20 3d20 7374 7228        url = str(
-0000dae0: 7361 2e63 6c65 616e 5f75 726c 290a 2020  sa.clean_url).  
-0000daf0: 2020 2020 2020 2020 2020 6966 206d 6573            if mes
-0000db00: 7361 6765 5f74 6578 7420 6973 206e 6f74  sage_text is not
-0000db10: 204e 6f6e 6520 616e 6420 2875 726c 2069   None and (url i
-0000db20: 6e20 6d65 7373 6167 655f 7465 7874 206f  n message_text o
-0000db30: 7220 7361 2e74 6974 6c65 2069 6e20 6d65  r sa.title in me
-0000db40: 7373 6167 655f 7465 7874 293a 0a20 2020  ssage_text):.   
-0000db50: 2020 2020 2020 2020 2020 2020 2023 2055               # U
-0000db60: 524c 2069 7320 7072 6573 656e 7420 696e  RL is present in
-0000db70: 206d 6573 7361 6765 2c20 646f 6e27 7420   message, don't 
-0000db80: 7265 706f 7374 0a20 2020 2020 2020 2020  repost.         
-0000db90: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0000dba0: 6e65 0a20 2020 2020 2020 2020 2020 2072  ne.            r
-0000dbb0: 6574 7572 6e20 5465 7874 4d65 7373 6167  eturn TextMessag
-0000dbc0: 6545 7665 6e74 436f 6e74 656e 7428 6d73  eEventContent(ms
-0000dbd0: 6774 7970 653d 4d65 7373 6167 6554 7970  gtype=MessageTyp
-0000dbe0: 652e 5445 5854 2c20 626f 6479 3d66 227b  e.TEXT, body=f"{
-0000dbf0: 7361 2e74 6974 6c65 7d5c 6e5c 6e7b 7572  sa.title}\n\n{ur
-0000dc00: 6c7d 2229 0a20 2020 2020 2020 2065 6c73  l}").        els
-0000dc10: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0000dc20: 656c 662e 6c6f 672e 6465 6275 6728 2255  elf.log.debug("U
-0000dc30: 6e68 616e 646c 6564 2073 746f 7279 2061  nhandled story a
-0000dc40: 7474 6163 686d 656e 743a 2025 7322 2c20  ttachment: %s", 
-0000dc50: 7361 2e73 6572 6961 6c69 7a65 2829 290a  sa.serialize()).
-0000dc60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000dc70: 726e 204e 6f6e 650a 0a20 2020 2061 7379  rn None..    asy
-0000dc80: 6e63 2064 6566 205f 636f 6e76 6572 745f  nc def _convert_
-0000dc90: 6d71 7474 5f61 7474 6163 686d 656e 7428  mqtt_attachment(
-0000dca0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000dcb0: 2020 2020 2020 206d 7367 5f69 643a 2073         msg_id: s
-0000dcc0: 7472 2c0a 2020 2020 2020 2020 736f 7572  tr,.        sour
-0000dcd0: 6365 3a20 752e 5573 6572 2c0a 2020 2020  ce: u.User,.    
-0000dce0: 2020 2020 696e 7465 6e74 3a20 496e 7465      intent: Inte
-0000dcf0: 6e74 4150 492c 0a20 2020 2020 2020 2061  ntAPI,.        a
-0000dd00: 7474 6163 686d 656e 743a 206d 7174 742e  ttachment: mqtt.
-0000dd10: 4174 7461 6368 6d65 6e74 2c0a 2020 2020  Attachment,.    
-0000dd20: 2020 2020 6d65 7373 6167 655f 7465 7874      message_text
-0000dd30: 3a20 7374 722c 0a20 2020 2029 202d 3e20  : str,.    ) -> 
-0000dd40: 4d65 7373 6167 6545 7665 6e74 436f 6e74  MessageEventCont
-0000dd50: 656e 743a 0a20 2020 2020 2020 2066 696c  ent:.        fil
-0000dd60: 656e 616d 6520 3d20 6174 7461 6368 6d65  ename = attachme
-0000dd70: 6e74 2e66 696c 655f 6e61 6d65 0a20 2020  nt.file_name.   
-0000dd80: 2020 2020 2069 6620 6174 7461 6368 6d65       if attachme
-0000dd90: 6e74 2e6d 696d 655f 7479 7065 2061 6e64  nt.mime_type and
-0000dda0: 2066 696c 656e 616d 6520 6973 206e 6f74   filename is not
-0000ddb0: 204e 6f6e 6520 616e 6420 222e 2220 6e6f   None and "." no
-0000ddc0: 7420 696e 2066 696c 656e 616d 653a 0a20  t in filename:. 
-0000ddd0: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-0000dde0: 616d 6520 2b3d 206d 696d 6574 7970 6573  ame += mimetypes
-0000ddf0: 2e67 7565 7373 5f65 7874 656e 7369 6f6e  .guess_extension
-0000de00: 2861 7474 6163 686d 656e 742e 6d69 6d65  (attachment.mime
-0000de10: 5f74 7970 6529 0a20 2020 2020 2020 2072  _type).        r
-0000de20: 6566 6572 6572 203d 2022 756e 6b6e 6f77  eferer = "unknow
-0000de30: 6e22 0a20 2020 2020 2020 2076 6f69 6365  n".        voice
-0000de40: 5f6d 6573 7361 6765 203d 2046 616c 7365  _message = False
-0000de50: 0a20 2020 2020 2020 2069 6620 6174 7461  .        if atta
-0000de60: 6368 6d65 6e74 2e65 7874 656e 7369 626c  chment.extensibl
-0000de70: 655f 6d65 6469 613a 0a20 2020 2020 2020  e_media:.       
-0000de80: 2020 2020 2073 6120 3d20 6174 7461 6368       sa = attach
-0000de90: 6d65 6e74 2e70 6172 7365 5f65 7874 656e  ment.parse_exten
-0000dea0: 7369 626c 6528 292e 7374 6f72 795f 6174  sible().story_at
-0000deb0: 7461 6368 6d65 6e74 0a20 2020 2020 2020  tachment.       
-0000dec0: 2020 2020 2073 656c 662e 6c6f 672e 7472       self.log.tr
-0000ded0: 6163 6528 2253 746f 7279 2061 7474 6163  ace("Story attac
-0000dee0: 686d 656e 7420 2573 2063 6f6e 7465 6e74  hment %s content
-0000def0: 3a20 2573 222c 2061 7474 6163 686d 656e  : %s", attachmen
-0000df00: 742e 6d65 6469 615f 6964 5f73 7472 2c20  t.media_id_str, 
-0000df10: 7361 290a 2020 2020 2020 2020 2020 2020  sa).            
-0000df20: 7265 7475 726e 2061 7761 6974 2073 656c  return await sel
-0000df30: 662e 5f63 6f6e 7665 7274 5f65 7874 656e  f._convert_exten
-0000df40: 7369 626c 655f 6d65 6469 6128 0a20 2020  sible_media(.   
-0000df50: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
-0000df60: 7263 652c 2069 6e74 656e 742c 2073 612c  rce, intent, sa,
-0000df70: 206d 6573 7361 6765 5f74 6578 743d 6d65   message_text=me
-0000df80: 7373 6167 655f 7465 7874 0a20 2020 2020  ssage_text.     
-0000df90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000dfa0: 2065 6c69 6620 6174 7461 6368 6d65 6e74   elif attachment
-0000dfb0: 2e76 6964 656f 5f69 6e66 6f3a 0a20 2020  .video_info:.   
-0000dfc0: 2020 2020 2020 2020 206d 7367 7479 7065           msgtype
-0000dfd0: 203d 204d 6573 7361 6765 5479 7065 2e56   = MessageType.V
-0000dfe0: 4944 454f 0a20 2020 2020 2020 2020 2020  IDEO.           
-0000dff0: 2075 726c 203d 2061 7474 6163 686d 656e   url = attachmen
-0000e000: 742e 7669 6465 6f5f 696e 666f 2e64 6f77  t.video_info.dow
-0000e010: 6e6c 6f61 645f 7572 6c0a 2020 2020 2020  nload_url.      
-0000e020: 2020 2020 2020 696e 666f 203d 2056 6964        info = Vid
-0000e030: 656f 496e 666f 280a 2020 2020 2020 2020  eoInfo(.        
-0000e040: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-0000e050: 3d61 7474 6163 686d 656e 742e 7669 6465  =attachment.vide
-0000e060: 6f5f 696e 666f 2e64 7572 6174 696f 6e5f  o_info.duration_
-0000e070: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-0000e080: 2020 2020 7769 6474 683d 6174 7461 6368      width=attach
-0000e090: 6d65 6e74 2e76 6964 656f 5f69 6e66 6f2e  ment.video_info.
-0000e0a0: 6f72 6967 696e 616c 5f77 6964 7468 2c0a  original_width,.
-0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0c0: 6865 6967 6874 3d61 7474 6163 686d 656e  height=attachmen
-0000e0d0: 742e 7669 6465 6f5f 696e 666f 2e6f 7269  t.video_info.ori
-0000e0e0: 6769 6e61 6c5f 6865 6967 6874 2c0a 2020  ginal_height,.  
-0000e0f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000e100: 2020 2020 656c 6966 2061 7474 6163 686d      elif attachm
-0000e110: 656e 742e 6175 6469 6f5f 696e 666f 3a0a  ent.audio_info:.
-0000e120: 2020 2020 2020 2020 2020 2020 6d73 6774              msgt
-0000e130: 7970 6520 3d20 4d65 7373 6167 6554 7970  ype = MessageTyp
-0000e140: 652e 4155 4449 4f0a 2020 2020 2020 2020  e.AUDIO.        
-0000e150: 2020 2020 7572 6c20 3d20 6174 7461 6368      url = attach
-0000e160: 6d65 6e74 2e61 7564 696f 5f69 6e66 6f2e  ment.audio_info.
-0000e170: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
-0000e180: 696e 666f 203d 2041 7564 696f 496e 666f  info = AudioInfo
-0000e190: 2864 7572 6174 696f 6e3d 6174 7461 6368  (duration=attach
-0000e1a0: 6d65 6e74 2e61 7564 696f 5f69 6e66 6f2e  ment.audio_info.
-0000e1b0: 6475 7261 7469 6f6e 5f6d 7329 0a20 2020  duration_ms).   
-0000e1c0: 2020 2020 2020 2020 2076 6f69 6365 5f6d           voice_m
-0000e1d0: 6573 7361 6765 203d 2054 7275 650a 2020  essage = True.  
-0000e1e0: 2020 2020 2020 2020 2020 6174 7461 6368            attach
-0000e1f0: 6d65 6e74 2e6d 696d 655f 7479 7065 203d  ment.mime_type =
-0000e200: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
-0000e210: 6966 2061 7474 6163 686d 656e 742e 696d  if attachment.im
-0000e220: 6167 655f 696e 666f 3a0a 2020 2020 2020  age_info:.      
-0000e230: 2020 2020 2020 7265 6665 7265 7220 3d20        referer = 
-0000e240: 226d 6573 7365 6e67 6572 5f74 6872 6561  "messenger_threa
-0000e250: 645f 7068 6f74 6f22 0a20 2020 2020 2020  d_photo".       
-0000e260: 2020 2020 206d 7367 7479 7065 203d 204d       msgtype = M
-0000e270: 6573 7361 6765 5479 7065 2e49 4d41 4745  essageType.IMAGE
-0000e280: 0a20 2020 2020 2020 2020 2020 2069 6e66  .            inf
-0000e290: 6f20 3d20 496d 6167 6549 6e66 6f28 0a20  o = ImageInfo(. 
-0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000e2b0: 6964 7468 3d61 7474 6163 686d 656e 742e  idth=attachment.
-0000e2c0: 696d 6167 655f 696e 666f 2e6f 7269 6769  image_info.origi
-0000e2d0: 6e61 6c5f 7769 6474 682c 0a20 2020 2020  nal_width,.     
-0000e2e0: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-0000e2f0: 743d 6174 7461 6368 6d65 6e74 2e69 6d61  t=attachment.ima
-0000e300: 6765 5f69 6e66 6f2e 6f72 6967 696e 616c  ge_info.original
-0000e310: 5f68 6569 6768 742c 0a20 2020 2020 2020  _height,.       
-0000e320: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000e330: 2020 2069 6620 6174 7461 6368 6d65 6e74     if attachment
-0000e340: 2e69 6d61 6765 5f69 6e66 6f2e 616e 696d  .image_info.anim
-0000e350: 6174 6564 5f75 7269 5f6d 6170 3a0a 2020  ated_uri_map:.  
-0000e360: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-0000e370: 6c20 3d20 6c69 7374 2861 7474 6163 686d  l = list(attachm
-0000e380: 656e 742e 696d 6167 655f 696e 666f 2e61  ent.image_info.a
-0000e390: 6e69 6d61 7465 645f 7572 695f 6d61 702e  nimated_uri_map.
-0000e3a0: 7661 6c75 6573 2829 295b 305d 0a20 2020  values())[0].   
-0000e3b0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
-0000e3c0: 7665 7272 6964 6520 7468 6520 6d69 6d65  verride the mime
-0000e3d0: 2074 7970 6520 6f72 2064 6574 6563 7420   type or detect 
-0000e3e0: 6672 6f6d 2066 696c 650a 2020 2020 2020  from file.      
-0000e3f0: 2020 2020 2020 2020 2020 6174 7461 6368            attach
-0000e400: 6d65 6e74 2e6d 696d 655f 7479 7065 203d  ment.mime_type =
-0000e410: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000e420: 2020 2020 2020 2022 7765 6270 223a 2022         "webp": "
-0000e430: 696d 6167 652f 7765 6270 222c 0a20 2020  image/webp",.   
-0000e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e450: 2022 6769 6622 3a20 2269 6d61 6765 2f67   "gif": "image/g
-0000e460: 6966 222c 0a20 2020 2020 2020 2020 2020  if",.           
-0000e470: 2020 2020 2020 2020 2022 706e 6722 3a20           "png": 
-0000e480: 2269 6d61 6765 2f70 6e67 222c 0a20 2020  "image/png",.   
-0000e490: 2020 2020 2020 2020 2020 2020 207d 2e67               }.g
-0000e4a0: 6574 2861 7474 6163 686d 656e 742e 696d  et(attachment.im
-0000e4b0: 6167 655f 696e 666f 2e61 6e69 6d61 7465  age_info.animate
-0000e4c0: 645f 696d 6167 655f 7479 7065 2c20 4e6f  d_image_type, No
-0000e4d0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-0000e4e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000e4f0: 2020 2020 2020 7572 6c20 3d20 6c69 7374        url = list
-0000e500: 2861 7474 6163 686d 656e 742e 696d 6167  (attachment.imag
-0000e510: 655f 696e 666f 2e75 7269 5f6d 6170 2e76  e_info.uri_map.v
-0000e520: 616c 7565 7328 2929 5b30 5d0a 2020 2020  alues())[0].    
-0000e530: 2020 2020 2020 2020 2320 544f 444f 2066          # TODO f
-0000e540: 696e 6420 6f75 7420 6966 2077 6520 6e65  ind out if we ne
-0000e550: 6564 2074 6f20 7573 6520 6765 745f 696d  ed to use get_im
-0000e560: 6167 655f 7572 6c20 696e 2073 6f6d 6520  age_url in some 
-0000e570: 6361 7365 7320 6576 656e 2077 6974 6820  cases even with 
-0000e580: 4d51 5454 0a20 2020 2020 2020 2020 2020  MQTT.           
-0000e590: 2023 2075 726c 203d 2061 7761 6974 2073   # url = await s
-0000e5a0: 6f75 7263 652e 636c 6965 6e74 2e67 6574  ource.client.get
-0000e5b0: 5f69 6d61 6765 5f75 726c 286d 7367 5f69  _image_url(msg_i
-0000e5c0: 642c 2061 7474 6163 686d 656e 742e 6d65  d, attachment.me
-0000e5d0: 6469 615f 6964 290a 2020 2020 2020 2020  dia_id).        
-0000e5e0: 656c 6966 2061 7474 6163 686d 656e 742e  elif attachment.
-0000e5f0: 6d65 6469 615f 6964 3a0a 2020 2020 2020  media_id:.      
-0000e600: 2020 2020 2020 2320 544f 444f 2077 6861        # TODO wha
-0000e610: 7420 6966 2069 7427 7320 6e6f 7420 6120  t if it's not a 
-0000e620: 6669 6c65 3f0a 2020 2020 2020 2020 2020  file?.          
-0000e630: 2020 6d73 6774 7970 6520 3d20 4d65 7373    msgtype = Mess
-0000e640: 6167 6554 7970 652e 4649 4c45 0a20 2020  ageType.FILE.   
-0000e650: 2020 2020 2020 2020 2075 726c 203d 2061           url = a
-0000e660: 7761 6974 2073 6f75 7263 652e 636c 6965  wait source.clie
-0000e670: 6e74 2e67 6574 5f66 696c 655f 7572 6c28  nt.get_file_url(
-0000e680: 7365 6c66 2e66 6269 642c 206d 7367 5f69  self.fbid, msg_i
-0000e690: 642c 2061 7474 6163 686d 656e 742e 6d65  d, attachment.me
-0000e6a0: 6469 615f 6964 290a 2020 2020 2020 2020  dia_id).        
-0000e6b0: 2020 2020 696e 666f 203d 2046 696c 6549      info = FileI
-0000e6c0: 6e66 6f28 290a 2020 2020 2020 2020 656c  nfo().        el
-0000e6d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000e6e0: 7365 6c66 2e6c 6f67 2e77 6172 6e69 6e67  self.log.warning
-0000e6f0: 2866 2255 6e73 7570 706f 7274 6564 2061  (f"Unsupported a
-0000e700: 7474 6163 686d 656e 7420 696e 207b 6d73  ttachment in {ms
-0000e710: 675f 6964 7d22 290a 2020 2020 2020 2020  g_id}").        
-0000e720: 2020 2020 7265 7475 726e 2054 6578 744d      return TextM
-0000e730: 6573 7361 6765 4576 656e 7443 6f6e 7465  essageEventConte
-0000e740: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-0000e750: 2020 2020 6d73 6774 7970 653d 4d65 7373      msgtype=Mess
-0000e760: 6167 6554 7970 652e 4e4f 5449 4345 2c20  ageType.NOTICE, 
-0000e770: 626f 6479 3d22 556e 7375 7070 6f72 7465  body="Unsupporte
-0000e780: 6420 6174 7461 6368 6d65 6e74 220a 2020  d attachment".  
-0000e790: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000e7a0: 2020 2020 6d78 632c 2061 6464 6974 696f      mxc, additio
-0000e7b0: 6e61 6c5f 696e 666f 2c20 6465 6372 7970  nal_info, decryp
-0000e7c0: 7469 6f6e 5f69 6e66 6f20 3d20 6177 6169  tion_info = awai
-0000e7d0: 7420 7365 6c66 2e5f 7265 7570 6c6f 6164  t self._reupload
-0000e7e0: 5f66 625f 6669 6c65 280a 2020 2020 2020  _fb_file(.      
-0000e7f0: 2020 2020 2020 7572 6c2c 0a20 2020 2020        url,.     
-0000e800: 2020 2020 2020 2073 6f75 7263 652c 0a20         source,. 
-0000e810: 2020 2020 2020 2020 2020 2069 6e74 656e             inten
-0000e820: 742c 0a20 2020 2020 2020 2020 2020 2066  t,.            f
-0000e830: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
-0000e840: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
-0000e850: 6372 7970 743d 7365 6c66 2e65 6e63 7279  crypt=self.encry
-0000e860: 7074 6564 2c0a 2020 2020 2020 2020 2020  pted,.          
-0000e870: 2020 6669 6e64 5f73 697a 653d 4661 6c73    find_size=Fals
-0000e880: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
-0000e890: 6566 6572 6572 3d72 6566 6572 6572 2c0a  eferer=referer,.
-0000e8a0: 2020 2020 2020 2020 2020 2020 636f 6e76              conv
-0000e8b0: 6572 745f 6175 6469 6f3d 766f 6963 655f  ert_audio=voice_
-0000e8c0: 6d65 7373 6167 652c 0a20 2020 2020 2020  message,.       
-0000e8d0: 2029 0a20 2020 2020 2020 2069 6e66 6f2e   ).        info.
-0000e8e0: 7369 7a65 203d 2061 6464 6974 696f 6e61  size = additiona
-0000e8f0: 6c5f 696e 666f 2e73 697a 650a 2020 2020  l_info.size.    
-0000e900: 2020 2020 696e 666f 2e6d 696d 6574 7970      info.mimetyp
-0000e910: 6520 3d20 6174 7461 6368 6d65 6e74 2e6d  e = attachment.m
-0000e920: 696d 655f 7479 7065 206f 7220 6164 6469  ime_type or addi
-0000e930: 7469 6f6e 616c 5f69 6e66 6f2e 6d69 6d65  tional_info.mime
-0000e940: 7479 7065 0a20 2020 2020 2020 2063 6f6e  type.        con
-0000e950: 7465 6e74 203d 204d 6564 6961 4d65 7373  tent = MediaMess
-0000e960: 6167 6545 7665 6e74 436f 6e74 656e 7428  ageEventContent(
-0000e970: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-0000e980: 3d6d 7863 2c20 6669 6c65 3d64 6563 7279  =mxc, file=decry
-0000e990: 7074 696f 6e5f 696e 666f 2c20 6d73 6774  ption_info, msgt
-0000e9a0: 7970 653d 6d73 6774 7970 652c 2062 6f64  ype=msgtype, bod
-0000e9b0: 793d 6669 6c65 6e61 6d65 2c20 696e 666f  y=filename, info
-0000e9c0: 3d69 6e66 6f0a 2020 2020 2020 2020 290a  =info.        ).
-0000e9d0: 2020 2020 2020 2020 6966 2076 6f69 6365          if voice
-0000e9e0: 5f6d 6573 7361 6765 3a0a 2020 2020 2020  _message:.      
-0000e9f0: 2020 2020 2020 636f 6e74 656e 745b 226f        content["o
-0000ea00: 7267 2e6d 6174 7269 782e 6d73 6331 3736  rg.matrix.msc176
-0000ea10: 372e 6175 6469 6f22 5d20 3d20 7b22 6475  7.audio"] = {"du
-0000ea20: 7261 7469 6f6e 223a 2069 6e66 6f2e 6475  ration": info.du
-0000ea30: 7261 7469 6f6e 7d0a 2020 2020 2020 2020  ration}.        
-0000ea40: 2020 2020 636f 6e74 656e 745b 226f 7267      content["org
-0000ea50: 2e6d 6174 7269 782e 6d73 6333 3234 352e  .matrix.msc3245.
-0000ea60: 766f 6963 6522 5d20 3d20 7b7d 0a20 2020  voice"] = {}.   
-0000ea70: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-0000ea80: 2e62 6f64 7920 2b3d 2022 2e6f 6767 220a  .body += ".ogg".
-0000ea90: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-0000eaa0: 6f6e 7465 6e74 0a0a 2020 2020 6173 796e  ontent..    asyn
-0000eab0: 6320 6465 6620 5f74 7279 5f68 616e 646c  c def _try_handl
-0000eac0: 655f 6772 6170 6871 6c5f 7265 6163 7469  e_graphql_reacti
-0000ead0: 6f6e 7328 0a20 2020 2020 2020 2073 656c  ons(.        sel
-0000eae0: 662c 0a20 2020 2020 2020 2073 6f75 7263  f,.        sourc
-0000eaf0: 653a 2075 2e55 7365 722c 0a20 2020 2020  e: u.User,.     
-0000eb00: 2020 206d 7367 3a20 7374 7220 7c20 4442     msg: str | DB
-0000eb10: 4d65 7373 6167 652c 0a20 2020 2020 2020  Message,.       
-0000eb20: 2072 6561 6374 696f 6e73 3a20 6c69 7374   reactions: list
-0000eb30: 5b67 7261 7068 716c 2e52 6561 6374 696f  [graphql.Reactio
-0000eb40: 6e5d 2c0a 2020 2020 2020 2020 7469 6d65  n],.        time
-0000eb50: 7374 616d 703a 2069 6e74 207c 204e 6f6e  stamp: int | Non
-0000eb60: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
-0000eb70: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0000eb80: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000eb90: 2020 6177 6169 7420 7365 6c66 2e5f 6861    await self._ha
-0000eba0: 6e64 6c65 5f67 7261 7068 716c 5f72 6561  ndle_graphql_rea
-0000ebb0: 6374 696f 6e73 2873 6f75 7263 652c 206d  ctions(source, m
-0000ebc0: 7367 2c20 7265 6163 7469 6f6e 732c 2074  sg, reactions, t
-0000ebd0: 696d 6573 7461 6d70 290a 2020 2020 2020  imestamp).      
-0000ebe0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000ebf0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0000ec00: 6d73 675f 6964 203d 206d 7367 2e66 6269  msg_id = msg.fbi
-0000ec10: 6420 6966 2069 7369 6e73 7461 6e63 6528  d if isinstance(
-0000ec20: 6d73 672c 2044 424d 6573 7361 6765 2920  msg, DBMessage) 
-0000ec30: 656c 7365 206d 7367 0a20 2020 2020 2020  else msg.       
-0000ec40: 2020 2020 2073 656c 662e 6c6f 672e 6578       self.log.ex
-0000ec50: 6365 7074 696f 6e28 6622 4572 726f 7220  ception(f"Error 
-0000ec60: 6261 636b 6669 6c6c 696e 6720 7265 6163  backfilling reac
-0000ec70: 7469 6f6e 7320 746f 207b 6d73 675f 6964  tions to {msg_id
-0000ec80: 7d22 290a 0a20 2020 2061 7379 6e63 2064  }")..    async d
-0000ec90: 6566 205f 6861 6e64 6c65 5f67 7261 7068  ef _handle_graph
-0000eca0: 716c 5f72 6561 6374 696f 6e73 280a 2020  ql_reactions(.  
-0000ecb0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0000ecc0: 2020 2020 736f 7572 6365 3a20 752e 5573      source: u.Us
-0000ecd0: 6572 2c0a 2020 2020 2020 2020 6d73 673a  er,.        msg:
-0000ece0: 2073 7472 207c 2044 424d 6573 7361 6765   str | DBMessage
-0000ecf0: 2c0a 2020 2020 2020 2020 7265 6163 7469  ,.        reacti
-0000ed00: 6f6e 733a 206c 6973 745b 6772 6170 6871  ons: list[graphq
-0000ed10: 6c2e 5265 6163 7469 6f6e 5d2c 0a20 2020  l.Reaction],.   
-0000ed20: 2020 2020 2074 696d 6573 7461 6d70 3a20       timestamp: 
-0000ed30: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-0000ed40: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-0000ed50: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-0000ed60: 6e73 7461 6e63 6528 6d73 672c 2044 424d  nstance(msg, DBM
-0000ed70: 6573 7361 6765 293a 0a20 2020 2020 2020  essage):.       
-0000ed80: 2020 2020 206d 6573 7361 6765 5f69 6420       message_id 
-0000ed90: 3d20 6d73 672e 6662 6964 0a20 2020 2020  = msg.fbid.     
-0000eda0: 2020 2020 2020 2074 6172 6765 745f 6d65         target_me
-0000edb0: 7373 6167 6520 3d20 6d73 670a 2020 2020  ssage = msg.    
-0000edc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000edd0: 2020 2020 2020 6d65 7373 6167 655f 6964        message_id
-0000ede0: 203d 206d 7367 0a20 2020 2020 2020 2020   = msg.         
-0000edf0: 2020 2074 6172 6765 745f 6d65 7373 6167     target_messag
-0000ee00: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-0000ee10: 2062 7269 6467 6564 5f72 6561 6374 696f   bridged_reactio
-0000ee20: 6e73 203d 2061 7761 6974 2044 4252 6561  ns = await DBRea
-0000ee30: 6374 696f 6e2e 6765 745f 6279 5f6d 6573  ction.get_by_mes
-0000ee40: 7361 6765 5f66 6269 6428 6d65 7373 6167  sage_fbid(messag
-0000ee50: 655f 6964 2c20 7365 6c66 2e66 625f 7265  e_id, self.fb_re
-0000ee60: 6365 6976 6572 290a 2020 2020 2020 2020  ceiver).        
-0000ee70: 6c61 7465 7374 5f72 6561 6374 696f 6e73  latest_reactions
-0000ee80: 3a20 6469 6374 5b69 6e74 2c20 6772 6170  : dict[int, grap
-0000ee90: 6871 6c2e 5265 6163 7469 6f6e 5d20 3d20  hql.Reaction] = 
-0000eea0: 7b0a 2020 2020 2020 2020 2020 2020 696e  {.            in
-0000eeb0: 7428 7265 6163 742e 7573 6572 2e69 6429  t(react.user.id)
-0000eec0: 3a20 7265 6163 7420 666f 7220 7265 6163  : react for reac
-0000eed0: 7420 696e 2072 6561 6374 696f 6e73 0a20  t in reactions. 
-0000eee0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0000eef0: 2073 656c 662e 6c6f 672e 7472 6163 6528   self.log.trace(
-0000ef00: 0a20 2020 2020 2020 2020 2020 2066 2253  .            f"S
-0000ef10: 796e 6369 6e67 2072 6561 6374 696f 6e73  yncing reactions
-0000ef20: 206f 6620 7b6d 6573 7361 6765 5f69 647d   of {message_id}
-0000ef30: 2028 6461 7461 6261 7365 2068 6173 207b   (database has {
-0000ef40: 6c65 6e28 6272 6964 6765 645f 7265 6163  len(bridged_reac
-0000ef50: 7469 6f6e 7329 7d2c 2064 6174 6120 220a  tions)}, data ".
-0000ef60: 2020 2020 2020 2020 2020 2020 6622 6672              f"fr
-0000ef70: 6f6d 2047 7261 7068 514c 2068 6173 207b  om GraphQL has {
-0000ef80: 6c65 6e28 6c61 7465 7374 5f72 6561 6374  len(latest_react
-0000ef90: 696f 6e73 297d 2922 0a20 2020 2020 2020  ions)})".       
-0000efa0: 2029 0a20 2020 2020 2020 2074 6173 6b73   ).        tasks
-0000efb0: 3a20 6c69 7374 5b61 7379 6e63 696f 2e54  : list[asyncio.T
-0000efc0: 6173 6b5d 203d 205b 5d0a 2020 2020 2020  ask] = [].      
-0000efd0: 2020 6465 6475 706c 6963 6174 6564 5f74    deduplicated_t
-0000efe0: 696d 6573 7461 6d70 203d 2028 7469 6d65  imestamp = (time
-0000eff0: 7374 616d 7020 2b20 3129 2069 6620 7469  stamp + 1) if ti
-0000f000: 6d65 7374 616d 7020 656c 7365 2069 6e74  mestamp else int
-0000f010: 2874 696d 652e 7469 6d65 2829 202a 2031  (time.time() * 1
-0000f020: 3030 3029 0a20 2020 2020 2020 2066 6f72  000).        for
-0000f030: 2073 656e 6465 722c 2072 6561 6374 696f   sender, reactio
-0000f040: 6e20 696e 206c 6174 6573 745f 7265 6163  n in latest_reac
-0000f050: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
-0000f060: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f080: 6578 6973 7469 6e67 203d 2062 7269 6467  existing = bridg
-0000f090: 6564 5f72 6561 6374 696f 6e73 5b73 656e  ed_reactions[sen
-0000f0a0: 6465 725d 0a20 2020 2020 2020 2020 2020  der].           
-0000f0b0: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0000f0c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f0d0: 2020 7461 736b 203d 2073 656c 662e 6861    task = self.ha
-0000f0e0: 6e64 6c65 5f66 6163 6562 6f6f 6b5f 7265  ndle_facebook_re
-0000f0f0: 6163 7469 6f6e 5f61 6464 280a 2020 2020  action_add(.    
+00001ac0: 2020 6465 6620 6d71 7474 5f6b 6579 2873    def mqtt_key(s
+00001ad0: 656c 6629 202d 3e20 6d71 7474 2e54 6872  elf) -> mqtt.Thr
+00001ae0: 6561 644b 6579 3a0a 2020 2020 2020 2020  eadKey:.        
+00001af0: 6966 2073 656c 662e 6662 5f74 7970 6520  if self.fb_type 
+00001b00: 3d3d 2054 6872 6561 6454 7970 652e 5553  == ThreadType.US
+00001b10: 4552 3a0a 2020 2020 2020 2020 2020 2020  ER:.            
+00001b20: 7265 7475 726e 206d 7174 742e 5468 7265  return mqtt.Thre
+00001b30: 6164 4b65 7928 6f74 6865 725f 7573 6572  adKey(other_user
+00001b40: 5f69 643d 7365 6c66 2e66 6269 6429 0a20  _id=self.fbid). 
+00001b50: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00001b60: 2e66 625f 7479 7065 203d 3d20 5468 7265  .fb_type == Thre
+00001b70: 6164 5479 7065 2e47 524f 5550 3a0a 2020  adType.GROUP:.  
+00001b80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00001b90: 206d 7174 742e 5468 7265 6164 4b65 7928   mqtt.ThreadKey(
+00001ba0: 7468 7265 6164 5f66 6269 643d 7365 6c66  thread_fbid=self
+00001bb0: 2e66 6269 6429 0a20 2020 2020 2020 2065  .fbid).        e
+00001bc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00001bd0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00001be0: 7228 2255 6e73 7570 706f 7274 6564 2074  r("Unsupported t
+00001bf0: 6872 6561 6420 7479 7065 2229 0a0a 2020  hread type")..  
+00001c00: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00001c10: 6465 6620 6772 6170 6871 6c5f 6b65 7928  def graphql_key(
+00001c20: 7365 6c66 2920 2d3e 2067 7261 7068 716c  self) -> graphql
+00001c30: 2e54 6872 6561 644b 6579 3a0a 2020 2020  .ThreadKey:.    
+00001c40: 2020 2020 6966 2073 656c 662e 6662 5f74      if self.fb_t
+00001c50: 7970 6520 3d3d 2054 6872 6561 6454 7970  ype == ThreadTyp
+00001c60: 652e 5553 4552 3a0a 2020 2020 2020 2020  e.USER:.        
+00001c70: 2020 2020 7265 7475 726e 2067 7261 7068      return graph
+00001c80: 716c 2e54 6872 6561 644b 6579 286f 7468  ql.ThreadKey(oth
+00001c90: 6572 5f75 7365 725f 6964 3d73 7472 2873  er_user_id=str(s
+00001ca0: 656c 662e 6662 6964 2929 0a20 2020 2020  elf.fbid)).     
+00001cb0: 2020 2065 6c69 6620 7365 6c66 2e66 625f     elif self.fb_
+00001cc0: 7479 7065 203d 3d20 5468 7265 6164 5479  type == ThreadTy
+00001cd0: 7065 2e47 524f 5550 3a0a 2020 2020 2020  pe.GROUP:.      
+00001ce0: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+00001cf0: 7068 716c 2e54 6872 6561 644b 6579 2874  phql.ThreadKey(t
+00001d00: 6872 6561 645f 6662 6964 3d73 7472 2873  hread_fbid=str(s
+00001d10: 656c 662e 6662 6964 2929 0a20 2020 2020  elf.fbid)).     
+00001d20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00001d30: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00001d40: 4572 726f 7228 2255 6e73 7570 706f 7274  Error("Unsupport
+00001d50: 6564 2074 6872 6561 6420 7479 7065 2229  ed thread type")
+00001d60: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00001d70: 2020 2020 6465 6620 7365 745f 646d 5f72      def set_dm_r
+00001d80: 6f6f 6d5f 6d65 7461 6461 7461 2873 656c  oom_metadata(sel
+00001d90: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
+00001da0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00001db0: 2020 2020 2020 2020 206e 6f74 2073 656c           not sel
+00001dc0: 662e 6973 5f64 6972 6563 740a 2020 2020  f.is_direct.    
+00001dd0: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
+00001de0: 7072 6976 6174 655f 6368 6174 5f70 6f72  private_chat_por
+00001df0: 7461 6c5f 6d65 7461 203d 3d20 2261 6c77  tal_meta == "alw
+00001e00: 6179 7322 0a20 2020 2020 2020 2020 2020  ays".           
+00001e10: 206f 7220 2873 656c 662e 656e 6372 7970   or (self.encryp
+00001e20: 7465 6420 616e 6420 7365 6c66 2e70 7269  ted and self.pri
+00001e30: 7661 7465 5f63 6861 745f 706f 7274 616c  vate_chat_portal
+00001e40: 5f6d 6574 6120 213d 2022 6e65 7665 7222  _meta != "never"
+00001e50: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+00001e60: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00001e70: 6566 2069 735f 6469 7265 6374 2873 656c  ef is_direct(sel
+00001e80: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
+00001e90: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00001ea0: 6662 5f74 7970 6520 3d3d 2054 6872 6561  fb_type == Threa
+00001eb0: 6454 7970 652e 5553 4552 0a0a 2020 2020  dType.USER..    
+00001ec0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00001ed0: 6620 6d61 696e 5f69 6e74 656e 7428 7365  f main_intent(se
+00001ee0: 6c66 2920 2d3e 2049 6e74 656e 7441 5049  lf) -> IntentAPI
+00001ef0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00001f00: 2073 656c 662e 5f6d 6169 6e5f 696e 7465   self._main_inte
+00001f10: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00001f20: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00001f30: 2822 506f 7274 616c 206d 7573 7420 6265  ("Portal must be
+00001f40: 2070 6f73 7469 6e69 7428 2965 6420 6265   postinit()ed be
+00001f50: 666f 7265 206d 6169 6e5f 696e 7465 6e74  fore main_intent
+00001f60: 2063 616e 2062 6520 7573 6564 2229 0a20   can be used"). 
+00001f70: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00001f80: 6c66 2e5f 6d61 696e 5f69 6e74 656e 740a  lf._main_intent.
+00001f90: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
+00001fa0: 6574 5f64 6d5f 7075 7070 6574 2873 656c  et_dm_puppet(sel
+00001fb0: 6629 202d 3e20 702e 5075 7070 6574 207c  f) -> p.Puppet |
+00001fc0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00001fd0: 6620 6e6f 7420 7365 6c66 2e69 735f 6469  f not self.is_di
+00001fe0: 7265 6374 3a0a 2020 2020 2020 2020 2020  rect:.          
+00001ff0: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+00002000: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
+00002010: 6974 2070 2e50 7570 7065 742e 6765 745f  it p.Puppet.get_
+00002020: 6279 5f66 6269 6428 7365 6c66 2e66 6269  by_fbid(self.fbi
+00002030: 6429 0a0a 2020 2020 2320 656e 6472 6567  d)..    # endreg
+00002040: 696f 6e0a 2020 2020 2320 7265 6769 6f6e  ion.    # region
+00002050: 2043 6861 7420 696e 666f 2075 7064 6174   Chat info updat
+00002060: 696e 670a 0a20 2020 2064 6566 2073 6368  ing..    def sch
+00002070: 6564 756c 655f 7265 7379 6e63 2873 656c  edule_resync(sel
+00002080: 662c 2073 6f75 7263 653a 2075 2e55 7365  f, source: u.Use
+00002090: 722c 2074 6172 6765 743a 2070 2e50 7570  r, target: p.Pup
+000020a0: 7065 7429 202d 3e20 4e6f 6e65 3a0a 2020  pet) -> None:.  
+000020b0: 2020 2020 2020 7365 6c66 2e5f 7265 7379        self._resy
+000020c0: 6e63 5f74 6172 6765 7473 5b74 6172 6765  nc_targets[targe
+000020d0: 742e 6662 6964 5d20 3d20 7461 7267 6574  t.fbid] = target
+000020e0: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
+000020f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00002100: 736c 6565 7069 6e67 5f74 6f5f 7265 7379  sleeping_to_resy
+00002110: 6e63 0a20 2020 2020 2020 2020 2020 2061  nc.            a
+00002120: 6e64 2073 656c 662e 5f73 6368 6564 756c  nd self._schedul
+00002130: 6564 5f72 6573 796e 630a 2020 2020 2020  ed_resync.      
+00002140: 2020 2020 2020 616e 6420 6e6f 7420 7365        and not se
+00002150: 6c66 2e5f 7363 6865 6475 6c65 645f 7265  lf._scheduled_re
+00002160: 7379 6e63 2e64 6f6e 6528 290a 2020 2020  sync.done().    
+00002170: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00002180: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00002190: 2020 7365 6c66 2e5f 736c 6565 7069 6e67    self._sleeping
+000021a0: 5f74 6f5f 7265 7379 6e63 203d 2054 7275  _to_resync = Tru
+000021b0: 650a 2020 2020 2020 2020 7365 6c66 2e6c  e.        self.l
+000021c0: 6f67 2e64 6562 7567 2866 2253 6368 6564  og.debug(f"Sched
+000021d0: 756c 696e 6720 7265 7379 6e63 2074 6872  uling resync thr
+000021e0: 6f75 6768 207b 736f 7572 6365 2e6d 7869  ough {source.mxi
+000021f0: 647d 2f7b 736f 7572 6365 2e66 6269 647d  d}/{source.fbid}
+00002200: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00002210: 5f73 6368 6564 756c 6564 5f72 6573 796e  _scheduled_resyn
+00002220: 6320 3d20 6173 796e 6369 6f2e 6372 6561  c = asyncio.crea
+00002230: 7465 5f74 6173 6b28 7365 6c66 2e5f 736c  te_task(self._sl
+00002240: 6565 705f 616e 645f 7265 7379 6e63 2873  eep_and_resync(s
+00002250: 6f75 7263 652c 2031 3029 290a 0a20 2020  ource, 10))..   
+00002260: 2061 7379 6e63 2064 6566 205f 736c 6565   async def _slee
+00002270: 705f 616e 645f 7265 7379 6e63 2873 656c  p_and_resync(sel
+00002280: 662c 2073 6f75 7263 653a 2075 2e55 7365  f, source: u.Use
+00002290: 722c 2073 6c65 6570 3a20 696e 7429 202d  r, sleep: int) -
+000022a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000022b0: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
+000022c0: 6565 7028 736c 6565 7029 0a20 2020 2020  eep(sleep).     
+000022d0: 2020 2074 6172 6765 7473 203d 2073 656c     targets = sel
+000022e0: 662e 5f72 6573 796e 635f 7461 7267 6574  f._resync_target
+000022f0: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
+00002300: 736c 6565 7069 6e67 5f74 6f5f 7265 7379  sleeping_to_resy
+00002310: 6e63 203d 2046 616c 7365 0a20 2020 2020  nc = False.     
+00002320: 2020 2073 656c 662e 5f72 6573 796e 635f     self._resync_
+00002330: 7461 7267 6574 7320 3d20 7b7d 0a20 2020  targets = {}.   
+00002340: 2020 2020 2066 6f72 2070 7570 7065 7420       for puppet 
+00002350: 696e 2074 6172 6765 7473 2e76 616c 7565  in targets.value
+00002360: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00002370: 2069 6620 6e6f 7420 7075 7070 6574 2e6e   if not puppet.n
+00002380: 616d 6520 6f72 206e 6f74 2070 7570 7065  ame or not puppe
+00002390: 742e 6e61 6d65 5f73 6574 3a0a 2020 2020  t.name_set:.    
+000023a0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000023b0: 6b0a 2020 2020 2020 2020 656c 7365 3a0a  k.        else:.
+000023c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000023d0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000023e0: 2020 2020 2020 2020 2020 2020 6622 4361              f"Ca
+000023f0: 6e63 656c 6c65 6420 7265 7379 6e63 2074  ncelled resync t
+00002400: 6872 6f75 6768 207b 736f 7572 6365 2e6d  hrough {source.m
+00002410: 7869 647d 2f7b 736f 7572 6365 2e66 6269  xid}/{source.fbi
+00002420: 647d 2c20 616c 6c20 7075 7070 6574 7320  d}, all puppets 
+00002430: 6861 7665 206e 616d 6573 220a 2020 2020  have names".    
+00002440: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00002450: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00002460: 2020 2020 2073 656c 662e 6c6f 672e 6465       self.log.de
+00002470: 6275 6728 6622 5265 7379 6e63 696e 6720  bug(f"Resyncing 
+00002480: 6368 6174 2074 6872 6f75 6768 207b 736f  chat through {so
+00002490: 7572 6365 2e6d 7869 647d 2f7b 736f 7572  urce.mxid}/{sour
+000024a0: 6365 2e66 6269 647d 2061 6674 6572 2073  ce.fbid} after s
+000024b0: 6c65 6570 696e 6722 290a 2020 2020 2020  leeping").      
+000024c0: 2020 6177 6169 7420 7365 6c66 2e75 7064    await self.upd
+000024d0: 6174 655f 696e 666f 2873 6f75 7263 6529  ate_info(source)
+000024e0: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
+000024f0: 6368 6564 756c 6564 5f72 6573 796e 6320  cheduled_resync 
+00002500: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+00002510: 656c 662e 6c6f 672e 6465 6275 6728 6622  elf.log.debug(f"
+00002520: 436f 6d70 6c65 7465 6420 7363 6865 6475  Completed schedu
+00002530: 6c65 6420 7265 7379 6e63 2074 6872 6f75  led resync throu
+00002540: 6768 207b 736f 7572 6365 2e6d 7869 647d  gh {source.mxid}
+00002550: 2f7b 736f 7572 6365 2e66 6269 647d 2229  /{source.fbid}")
+00002560: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00002570: 7570 6461 7465 5f69 6e66 6f28 0a20 2020  update_info(.   
+00002580: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00002590: 2020 2073 6f75 7263 653a 2075 2e55 7365     source: u.Use
+000025a0: 722c 0a20 2020 2020 2020 2069 6e66 6f3a  r,.        info:
+000025b0: 2067 7261 7068 716c 2e54 6872 6561 6420   graphql.Thread 
+000025c0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000025d0: 2020 2020 2020 2066 6f72 6365 5f73 6176         force_sav
+000025e0: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+000025f0: 0a20 2020 2029 202d 3e20 6772 6170 6871  .    ) -> graphq
+00002600: 6c2e 5468 7265 6164 207c 204e 6f6e 653a  l.Thread | None:
+00002610: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00002620: 696e 666f 3a0a 2020 2020 2020 2020 2020  info:.          
+00002630: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
+00002640: 2822 4361 6c6c 6564 2075 7064 6174 655f  ("Called update_
+00002650: 696e 666f 2077 6974 6820 6e6f 2069 6e66  info with no inf
+00002660: 6f2c 2066 6574 6368 696e 6720 7468 7265  o, fetching thre
+00002670: 6164 2069 6e66 6f2e 2e2e 2229 0a20 2020  ad info...").   
+00002680: 2020 2020 2020 2020 2074 6872 6561 6473           threads
+00002690: 203d 2061 7761 6974 2073 6f75 7263 652e   = await source.
+000026a0: 636c 6965 6e74 2e66 6574 6368 5f74 6872  client.fetch_thr
+000026b0: 6561 645f 696e 666f 2873 656c 662e 6662  ead_info(self.fb
+000026c0: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+000026d0: 6966 206e 6f74 2074 6872 6561 6473 3a0a  if not threads:.
+000026e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026f0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+00002700: 2020 2020 2020 2020 656c 6966 2074 6872          elif thr
+00002710: 6561 6473 5b30 5d2e 7468 7265 6164 5f6b  eads[0].thread_k
+00002720: 6579 2e69 6420 213d 2073 656c 662e 6662  ey.id != self.fb
+00002730: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+00002740: 2020 2020 7365 6c66 2e6c 6f67 2e77 6172      self.log.war
+00002750: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00002760: 2020 2020 2020 2020 2020 2266 6574 6368            "fetch
+00002770: 5f74 6872 6561 645f 696e 666f 2072 6573  _thread_info res
+00002780: 706f 6e73 6520 636f 6e74 6169 6e65 6420  ponse contained 
+00002790: 6469 6666 6572 656e 7420 4944 2028 2573  different ID (%s
+000027a0: 2920 7468 616e 2065 7870 6563 7465 6420  ) than expected 
+000027b0: 2825 7329 222c 0a20 2020 2020 2020 2020  (%s)",.         
+000027c0: 2020 2020 2020 2020 2020 2074 6872 6561             threa
+000027d0: 6473 5b30 5d2e 7468 7265 6164 5f6b 6579  ds[0].thread_key
+000027e0: 2e69 642c 0a20 2020 2020 2020 2020 2020  .id,.           
+000027f0: 2020 2020 2020 2020 2073 656c 662e 6662           self.fb
+00002800: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00002810: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00002820: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
+00002830: 6562 7567 2866 224e 756d 6265 7220 6f66  ebug(f"Number of
+00002840: 2074 6872 6561 6473 2069 6e20 756e 6578   threads in unex
+00002850: 7065 6374 6564 2072 6573 706f 6e73 653a  pected response:
+00002860: 207b 6c65 6e28 7468 7265 6164 7329 7d22   {len(threads)}"
+00002870: 290a 2020 2020 2020 2020 2020 2020 696e  ).            in
+00002880: 666f 203d 2074 6872 6561 6473 5b30 5d0a  fo = threads[0].
+00002890: 2020 2020 2020 2020 6966 2069 6e66 6f2e          if info.
+000028a0: 7468 7265 6164 5f6b 6579 2021 3d20 7365  thread_key != se
+000028b0: 6c66 2e67 7261 7068 716c 5f6b 6579 3a0a  lf.graphql_key:.
+000028c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000028d0: 2e6c 6f67 2e77 6172 6e69 6e67 280a 2020  .log.warning(.  
+000028e0: 2020 2020 2020 2020 2020 2020 2020 2247                "G
+000028f0: 6f74 2064 6966 6665 7265 6e74 2049 4420  ot different ID 
+00002900: 2825 7329 2074 6861 6e20 7768 6174 2061  (%s) than what a
+00002910: 736b 6564 2066 6f72 2028 2573 2920 7768  sked for (%s) wh
+00002920: 656e 2066 6574 6368 696e 6720 696e 666f  en fetching info
+00002930: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00002940: 2020 2069 6e66 6f2e 7468 7265 6164 5f6b     info.thread_k
+00002950: 6579 2e69 642c 0a20 2020 2020 2020 2020  ey.id,.         
+00002960: 2020 2020 2020 2073 656c 662e 6662 6964         self.fbid
+00002970: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00002980: 2020 2020 2020 2020 6368 616e 6765 6420          changed 
+00002990: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000029a0: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
+000029b0: 6972 6563 743a 0a20 2020 2020 2020 2020  irect:.         
+000029c0: 2020 2063 6861 6e67 6564 203d 2061 6e79     changed = any
+000029d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000029e0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+000029f0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+00002a00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002a10: 2e5f 7570 6461 7465 5f6e 616d 6528 696e  ._update_name(in
+00002a20: 666f 2e6e 616d 6529 2c0a 2020 2020 2020  fo.name),.      
+00002a30: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00002a40: 6c66 2e5f 7570 6461 7465 5f70 686f 746f  lf._update_photo
+00002a50: 2873 6f75 7263 652c 2069 6e66 6f2e 696d  (source, info.im
+00002a60: 6167 6529 2c0a 2020 2020 2020 2020 2020  age),.          
+00002a70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00002a80: 2020 2020 290a 2020 2020 2020 2020 6368      ).        ch
+00002a90: 616e 6765 6420 3d20 6177 6169 7420 7365  anged = await se
+00002aa0: 6c66 2e5f 7570 6461 7465 5f70 6172 7469  lf._update_parti
+00002ab0: 6369 7061 6e74 7328 736f 7572 6365 2c20  cipants(source, 
+00002ac0: 696e 666f 2920 6f72 2063 6861 6e67 6564  info) or changed
+00002ad0: 0a20 2020 2020 2020 2069 6620 6368 616e  .        if chan
+00002ae0: 6765 6420 6f72 2066 6f72 6365 5f73 6176  ged or force_sav
+00002af0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00002b00: 7761 6974 2073 656c 662e 7570 6461 7465  wait self.update
+00002b10: 5f62 7269 6467 655f 696e 666f 2829 0a20  _bridge_info(). 
+00002b20: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00002b30: 2073 656c 662e 7361 7665 2829 0a20 2020   self.save().   
+00002b40: 2020 2020 2072 6574 7572 6e20 696e 666f       return info
+00002b50: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00002b60: 686f 640a 2020 2020 6465 6620 6765 745f  hod.    def get_
+00002b70: 7068 6f74 6f5f 6964 2870 686f 746f 3a20  photo_id(photo: 
+00002b80: 6772 6170 6871 6c2e 5069 6374 7572 6520  graphql.Picture 
+00002b90: 7c20 7374 7220 7c20 4e6f 6e65 2920 2d3e  | str | None) ->
+00002ba0: 2073 7472 207c 204e 6f6e 653a 0a20 2020   str | None:.   
+00002bb0: 2020 2020 2069 6620 6e6f 7420 7068 6f74       if not phot
+00002bc0: 6f3a 0a20 2020 2020 2020 2020 2020 2072  o:.            r
+00002bd0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+00002be0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00002bf0: 6365 2870 686f 746f 2c20 6772 6170 6871  ce(photo, graphq
+00002c00: 6c2e 5069 6374 7572 6529 3a0a 2020 2020  l.Picture):.    
+00002c10: 2020 2020 2020 2020 7068 6f74 6f20 3d20          photo = 
+00002c20: 7068 6f74 6f2e 7572 690a 2020 2020 2020  photo.uri.      
+00002c30: 2020 7061 7468 203d 2055 524c 2870 686f    path = URL(pho
+00002c40: 746f 292e 7061 7468 0a20 2020 2020 2020  to).path.       
+00002c50: 2072 6574 7572 6e20 7061 7468 5b70 6174   return path[pat
+00002c60: 682e 7266 696e 6428 222f 2229 202b 2031  h.rfind("/") + 1
+00002c70: 203a 5d0a 0a20 2020 2040 636c 6173 736d   :]..    @classm
+00002c80: 6574 686f 640a 2020 2020 6173 796e 6320  ethod.    async 
+00002c90: 6465 6620 5f72 6575 706c 6f61 645f 6662  def _reupload_fb
+00002ca0: 5f66 696c 6528 0a20 2020 2020 2020 2063  _file(.        c
+00002cb0: 6c73 2c0a 2020 2020 2020 2020 7572 6c3a  ls,.        url:
+00002cc0: 2073 7472 2c0a 2020 2020 2020 2020 736f   str,.        so
+00002cd0: 7572 6365 3a20 752e 5573 6572 2c0a 2020  urce: u.User,.  
+00002ce0: 2020 2020 2020 696e 7465 6e74 3a20 496e        intent: In
+00002cf0: 7465 6e74 4150 492c 0a20 2020 2020 2020  tentAPI,.       
+00002d00: 202a 2c0a 2020 2020 2020 2020 6669 6c65   *,.        file
+00002d10: 6e61 6d65 3a20 7374 7220 7c20 4e6f 6e65  name: str | None
+00002d20: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00002d30: 2065 6e63 7279 7074 3a20 626f 6f6c 203d   encrypt: bool =
+00002d40: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
+00002d50: 7265 6665 7265 723a 2073 7472 203d 2022  referer: str = "
+00002d60: 6d65 7373 656e 6765 725f 7468 7265 6164  messenger_thread
+00002d70: 5f70 686f 746f 222c 0a20 2020 2020 2020  _photo",.       
+00002d80: 2066 696e 645f 7369 7a65 3a20 626f 6f6c   find_size: bool
+00002d90: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00002da0: 2020 636f 6e76 6572 745f 6175 6469 6f3a    convert_audio:
+00002db0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00002dc0: 2020 2029 202d 3e20 7475 706c 655b 436f     ) -> tuple[Co
+00002dd0: 6e74 656e 7455 5249 2c20 4669 6c65 496e  ntentURI, FileIn
+00002de0: 666f 207c 2056 6964 656f 496e 666f 207c  fo | VideoInfo |
+00002df0: 2041 7564 696f 496e 666f 207c 2049 6d61   AudioInfo | Ima
+00002e00: 6765 496e 666f 2c20 456e 6372 7970 7465  geInfo, Encrypte
+00002e10: 6446 696c 6520 7c20 4e6f 6e65 5d3a 0a20  dFile | None]:. 
+00002e20: 2020 2020 2020 2069 6620 6e6f 7420 7572         if not ur
+00002e30: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
+00002e40: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00002e50: 2255 524c 206e 6f74 2070 726f 7669 6465  "URL not provide
+00002e60: 6422 290a 2020 2020 2020 2020 6865 6164  d").        head
+00002e70: 6572 7320 3d20 7b22 7265 6665 7265 7222  ers = {"referer"
+00002e80: 3a20 6622 6662 6170 703a 2f2f 7b73 6f75  : f"fbapp://{sou
+00002e90: 7263 652e 7374 6174 652e 6170 706c 6963  rce.state.applic
+00002ea0: 6174 696f 6e2e 636c 6965 6e74 5f69 647d  ation.client_id}
+00002eb0: 2f7b 7265 6665 7265 727d 227d 0a20 2020  /{referer}"}.   
+00002ec0: 2020 2020 2073 616e 6462 6f78 203d 2063       sandbox = c
+00002ed0: 6c73 2e63 6f6e 6669 675b 2262 7269 6467  ls.config["bridg
+00002ee0: 652e 7361 6e64 626f 785f 6d65 6469 615f  e.sandbox_media_
+00002ef0: 646f 776e 6c6f 6164 225d 0a20 2020 2020  download"].     
+00002f00: 2020 2063 6c73 2e6c 6f67 2e74 7261 6365     cls.log.trace
+00002f10: 2822 5265 7570 6c6f 6164 696e 6720 6669  ("Reuploading fi
+00002f20: 6c65 2025 7322 2c20 7572 6c29 0a20 2020  le %s", url).   
+00002f30: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
+00002f40: 736f 7572 6365 2e63 6c69 656e 742e 7261  source.client.ra
+00002f50: 775f 6874 7470 5f67 6574 2875 726c 2c20  w_http_get(url, 
+00002f60: 6865 6164 6572 733d 6865 6164 6572 732c  headers=headers,
+00002f70: 2073 616e 6462 6f78 3d73 616e 6462 6f78   sandbox=sandbox
+00002f80: 2920 6173 2072 6573 703a 0a20 2020 2020  ) as resp:.     
+00002f90: 2020 2020 2020 206c 656e 6774 6820 3d20         length = 
+00002fa0: 696e 7428 7265 7370 2e68 6561 6465 7273  int(resp.headers
+00002fb0: 5b22 436f 6e74 656e 742d 4c65 6e67 7468  ["Content-Length
+00002fc0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00002fd0: 6966 206c 656e 6774 6820 3e20 636c 732e  if length > cls.
+00002fe0: 6d61 7472 6978 2e6d 6564 6961 5f63 6f6e  matrix.media_con
+00002ff0: 6669 672e 7570 6c6f 6164 5f73 697a 653a  fig.upload_size:
+00003000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003010: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00003020: 7228 2246 696c 6520 6e6f 7420 6176 6169  r("File not avai
+00003030: 6c61 626c 653a 2074 6f6f 206c 6172 6765  lable: too large
+00003040: 2229 0a20 2020 2020 2020 2020 2020 2064  ").            d
+00003050: 6174 6120 3d20 6177 6169 7420 7265 7370  ata = await resp
+00003060: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
+00003070: 6d69 6d65 203d 206d 6167 6963 2e6d 696d  mime = magic.mim
+00003080: 6574 7970 6528 6461 7461 290a 2020 2020  etype(data).    
+00003090: 2020 2020 6966 2063 6f6e 7665 7274 5f61      if convert_a
+000030a0: 7564 696f 2061 6e64 206d 696d 6520 213d  udio and mime !=
+000030b0: 2022 6175 6469 6f2f 6f67 6722 3a0a 2020   "audio/ogg":.  
+000030c0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+000030d0: 2061 7761 6974 2066 666d 7065 672e 636f   await ffmpeg.co
+000030e0: 6e76 6572 745f 6279 7465 7328 0a20 2020  nvert_bytes(.   
+000030f0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00003100: 612c 2022 2e6f 6767 222c 206f 7574 7075  a, ".ogg", outpu
+00003110: 745f 6172 6773 3d28 222d 633a 6122 2c20  t_args=("-c:a", 
+00003120: 226c 6962 6f70 7573 2229 2c20 696e 7075  "libopus"), inpu
+00003130: 745f 6d69 6d65 3d6d 696d 650a 2020 2020  t_mime=mime.    
+00003140: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003150: 2020 2020 2020 6d69 6d65 203d 2022 6175        mime = "au
+00003160: 6469 6f2f 6f67 6722 0a20 2020 2020 2020  dio/ogg".       
+00003170: 2069 6e66 6f20 3d20 4669 6c65 496e 666f   info = FileInfo
+00003180: 286d 696d 6574 7970 653d 6d69 6d65 2c20  (mimetype=mime, 
+00003190: 7369 7a65 3d6c 656e 2864 6174 6129 290a  size=len(data)).
+000031a0: 2020 2020 2020 2020 6966 2049 6d61 6765          if Image
+000031b0: 2061 6e64 206d 696d 652e 7374 6172 7473   and mime.starts
+000031c0: 7769 7468 2822 696d 6167 652f 2229 2061  with("image/") a
+000031d0: 6e64 2066 696e 645f 7369 7a65 3a0a 2020  nd find_size:.  
+000031e0: 2020 2020 2020 2020 2020 7769 7468 2049            with I
+000031f0: 6d61 6765 2e6f 7065 6e28 4279 7465 7349  mage.open(BytesI
+00003200: 4f28 6461 7461 2929 2061 7320 696d 673a  O(data)) as img:
+00003210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003220: 2077 6964 7468 2c20 6865 6967 6874 203d   width, height =
+00003230: 2069 6d67 2e73 697a 650a 2020 2020 2020   img.size.      
+00003240: 2020 2020 2020 696e 666f 203d 2049 6d61        info = Ima
+00003250: 6765 496e 666f 286d 696d 6574 7970 653d  geInfo(mimetype=
+00003260: 6d69 6d65 2c20 7369 7a65 3d6c 656e 2864  mime, size=len(d
+00003270: 6174 6129 2c20 7769 6474 683d 7769 6474  ata), width=widt
+00003280: 682c 2068 6569 6768 743d 6865 6967 6874  h, height=height
+00003290: 290a 2020 2020 2020 2020 7570 6c6f 6164  ).        upload
+000032a0: 5f6d 696d 655f 7479 7065 203d 206d 696d  _mime_type = mim
+000032b0: 650a 2020 2020 2020 2020 6465 6372 7970  e.        decryp
+000032c0: 7469 6f6e 5f69 6e66 6f20 3d20 4e6f 6e65  tion_info = None
+000032d0: 0a20 2020 2020 2020 2069 6620 656e 6372  .        if encr
+000032e0: 7970 7420 616e 6420 656e 6372 7970 745f  ypt and encrypt_
+000032f0: 6174 7461 6368 6d65 6e74 3a0a 2020 2020  attachment:.    
+00003300: 2020 2020 2020 2020 6461 7461 2c20 6465          data, de
+00003310: 6372 7970 7469 6f6e 5f69 6e66 6f20 3d20  cryption_info = 
+00003320: 656e 6372 7970 745f 6174 7461 6368 6d65  encrypt_attachme
+00003330: 6e74 2864 6174 6129 0a20 2020 2020 2020  nt(data).       
+00003340: 2020 2020 2075 706c 6f61 645f 6d69 6d65       upload_mime
+00003350: 5f74 7970 6520 3d20 2261 7070 6c69 6361  _type = "applica
+00003360: 7469 6f6e 2f6f 6374 6574 2d73 7472 6561  tion/octet-strea
+00003370: 6d22 0a20 2020 2020 2020 2020 2020 2066  m".            f
+00003380: 696c 656e 616d 6520 3d20 4e6f 6e65 0a20  ilename = None. 
+00003390: 2020 2020 2020 2075 726c 203d 2061 7761         url = awa
+000033a0: 6974 2069 6e74 656e 742e 7570 6c6f 6164  it intent.upload
+000033b0: 5f6d 6564 6961 280a 2020 2020 2020 2020  _media(.        
+000033c0: 2020 2020 6461 7461 2c0a 2020 2020 2020      data,.      
+000033d0: 2020 2020 2020 6d69 6d65 5f74 7970 653d        mime_type=
+000033e0: 7570 6c6f 6164 5f6d 696d 655f 7479 7065  upload_mime_type
+000033f0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00003400: 6c65 6e61 6d65 3d66 696c 656e 616d 652c  lename=filename,
+00003410: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
+00003420: 6e63 5f75 706c 6f61 643d 636c 732e 636f  nc_upload=cls.co
+00003430: 6e66 6967 5b22 686f 6d65 7365 7276 6572  nfig["homeserver
+00003440: 2e61 7379 6e63 5f6d 6564 6961 225d 2c0a  .async_media"],.
+00003450: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003460: 2020 6966 2064 6563 7279 7074 696f 6e5f    if decryption_
+00003470: 696e 666f 3a0a 2020 2020 2020 2020 2020  info:.          
+00003480: 2020 6465 6372 7970 7469 6f6e 5f69 6e66    decryption_inf
+00003490: 6f2e 7572 6c20 3d20 7572 6c0a 2020 2020  o.url = url.    
+000034a0: 2020 2020 7265 7475 726e 2075 726c 2c20      return url, 
+000034b0: 696e 666f 2c20 6465 6372 7970 7469 6f6e  info, decryption
+000034c0: 5f69 6e66 6f0a 0a20 2020 2061 7379 6e63  _info..    async
+000034d0: 2064 6566 205f 7570 6461 7465 5f6e 616d   def _update_nam
+000034e0: 6528 7365 6c66 2c20 6e61 6d65 3a20 7374  e(self, name: st
+000034f0: 7220 7c20 4e6f 6e65 2920 2d3e 2062 6f6f  r | None) -> boo
+00003500: 6c3a 0a20 2020 2020 2020 2069 6620 6e6f  l:.        if no
+00003510: 7420 6e61 6d65 3a0a 2020 2020 2020 2020  t name:.        
+00003520: 2020 2020 7365 6c66 2e6c 6f67 2e77 6172      self.log.war
+00003530: 6e69 6e67 2822 476f 7420 656d 7074 7920  ning("Got empty 
+00003540: 6e61 6d65 2069 6e20 5f75 7064 6174 655f  name in _update_
+00003550: 6e61 6d65 2063 616c 6c22 290a 2020 2020  name call").    
+00003560: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00003570: 616c 7365 0a20 2020 2020 2020 2069 6620  alse.        if 
+00003580: 7365 6c66 2e6e 616d 6520 213d 206e 616d  self.name != nam
+00003590: 6520 6f72 2028 6e6f 7420 7365 6c66 2e6e  e or (not self.n
+000035a0: 616d 655f 7365 7420 616e 6420 7365 6c66  ame_set and self
+000035b0: 2e73 6574 5f64 6d5f 726f 6f6d 5f6d 6574  .set_dm_room_met
+000035c0: 6164 6174 6129 3a0a 2020 2020 2020 2020  adata):.        
+000035d0: 2020 2020 7365 6c66 2e6c 6f67 2e74 7261      self.log.tra
+000035e0: 6365 2822 5570 6461 7469 6e67 206e 616d  ce("Updating nam
+000035f0: 6520 2573 202d 3e20 2573 222c 2073 656c  e %s -> %s", sel
+00003600: 662e 6e61 6d65 2c20 6e61 6d65 290a 2020  f.name, name).  
+00003610: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+00003620: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
+00003630: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
+00003640: 5f73 6574 203d 2046 616c 7365 0a20 2020  _set = False.   
+00003650: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00003660: 2e6d 7869 6420 616e 6420 7365 6c66 2e73  .mxid and self.s
+00003670: 6574 5f64 6d5f 726f 6f6d 5f6d 6574 6164  et_dm_room_metad
+00003680: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+00003690: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000036a0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+000036b0: 6169 7420 7365 6c66 2e6d 6169 6e5f 696e  ait self.main_in
+000036c0: 7465 6e74 2e73 6574 5f72 6f6f 6d5f 6e61  tent.set_room_na
+000036d0: 6d65 2873 656c 662e 6d78 6964 2c20 7365  me(self.mxid, se
+000036e0: 6c66 2e6e 616d 6529 0a20 2020 2020 2020  lf.name).       
+000036f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00003700: 662e 6e61 6d65 5f73 6574 203d 2054 7275  f.name_set = Tru
+00003710: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00003720: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00003730: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00003740: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00003750: 2e65 7863 6570 7469 6f6e 2822 4661 696c  .exception("Fail
+00003760: 6564 2074 6f20 7365 7420 726f 6f6d 206e  ed to set room n
+00003770: 616d 6522 290a 2020 2020 2020 2020 2020  ame").          
+00003780: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
+00003790: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+000037a0: 7365 0a0a 2020 2020 6173 796e 6320 6465  se..    async de
+000037b0: 6620 5f75 7064 6174 655f 7068 6f74 6f28  f _update_photo(
+000037c0: 7365 6c66 2c20 736f 7572 6365 3a20 752e  self, source: u.
+000037d0: 5573 6572 2c20 7068 6f74 6f3a 2067 7261  User, photo: gra
+000037e0: 7068 716c 2e50 6963 7475 7265 207c 204e  phql.Picture | N
+000037f0: 6f6e 6529 202d 3e20 626f 6f6c 3a0a 2020  one) -> bool:.  
+00003800: 2020 2020 2020 7068 6f74 6f5f 6964 203d        photo_id =
+00003810: 2073 656c 662e 6765 745f 7068 6f74 6f5f   self.get_photo_
+00003820: 6964 2870 686f 746f 290a 2020 2020 2020  id(photo).      
+00003830: 2020 6966 2073 656c 662e 7068 6f74 6f5f    if self.photo_
+00003840: 6964 2021 3d20 7068 6f74 6f5f 6964 206f  id != photo_id o
+00003850: 7220 6e6f 7420 7365 6c66 2e61 7661 7461  r not self.avata
+00003860: 725f 7365 743a 0a20 2020 2020 2020 2020  r_set:.         
+00003870: 2020 2073 656c 662e 7068 6f74 6f5f 6964     self.photo_id
+00003880: 203d 2070 686f 746f 5f69 640a 2020 2020   = photo_id.    
+00003890: 2020 2020 2020 2020 7365 6c66 2e61 7661          self.ava
+000038a0: 7461 725f 7365 7420 3d20 4661 6c73 650a  tar_set = False.
+000038b0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+000038c0: 686f 746f 3a0a 2020 2020 2020 2020 2020  hoto:.          
+000038d0: 2020 2020 2020 6966 2073 656c 662e 7068        if self.ph
+000038e0: 6f74 6f5f 6964 2021 3d20 7068 6f74 6f5f  oto_id != photo_
+000038f0: 6964 206f 7220 6e6f 7420 7365 6c66 2e61  id or not self.a
+00003900: 7661 7461 725f 7572 6c3a 0a20 2020 2020  vatar_url:.     
+00003910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00003920: 2052 6573 6574 2061 7661 7461 725f 7572   Reset avatar_ur
+00003930: 6c20 6669 7273 7420 696e 2063 6173 6520  l first in case 
+00003940: 7468 6520 7570 6c6f 6164 2066 6169 6c73  the upload fails
+00003950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003960: 2020 2020 2073 656c 662e 6176 6174 6172       self.avatar
+00003970: 5f75 726c 203d 204e 6f6e 650a 2020 2020  _url = None.    
+00003980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003990: 7365 6c66 2e61 7661 7461 725f 7572 6c20  self.avatar_url 
+000039a0: 3d20 6177 6169 7420 702e 5075 7070 6574  = await p.Puppet
+000039b0: 2e72 6575 706c 6f61 645f 6176 6174 6172  .reupload_avatar
+000039c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000039d0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+000039e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000039f0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00003a00: 6169 6e5f 696e 7465 6e74 2c0a 2020 2020  ain_intent,.    
+00003a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a20: 2020 2020 7068 6f74 6f2e 7572 692c 0a20      photo.uri,. 
+00003a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a40: 2020 2020 2020 2073 656c 662e 6662 6964         self.fbid
+00003a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003a60: 2020 2020 2020 2020 2020 7573 655f 6772            use_gr
+00003a70: 6170 683d 7365 6c66 2e69 735f 6469 7265  aph=self.is_dire
+00003a80: 6374 2061 6e64 2028 7068 6f74 6f2e 6865  ct and (photo.he
+00003a90: 6967 6874 206f 7220 3029 203c 2035 3030  ight or 0) < 500
+00003aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003ab0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00003ac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00003ad0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00003ae0: 7661 7461 725f 7572 6c20 3d20 436f 6e74  vatar_url = Cont
+00003af0: 656e 7455 5249 2822 2229 0a20 2020 2020  entURI("").     
+00003b00: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
+00003b10: 7869 643a 0a20 2020 2020 2020 2020 2020  xid:.           
+00003b20: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00003b30: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00003b40: 6169 7420 7365 6c66 2e6d 6169 6e5f 696e  ait self.main_in
+00003b50: 7465 6e74 2e73 6574 5f72 6f6f 6d5f 6176  tent.set_room_av
+00003b60: 6174 6172 2873 656c 662e 6d78 6964 2c20  atar(self.mxid, 
+00003b70: 7365 6c66 2e61 7661 7461 725f 7572 6c29  self.avatar_url)
+00003b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003b90: 2020 2020 2073 656c 662e 6176 6174 6172       self.avatar
+00003ba0: 5f73 6574 203d 2054 7275 650a 2020 2020  _set = True.    
+00003bb0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00003bc0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+00003bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003be0: 2020 7365 6c66 2e6c 6f67 2e65 7863 6570    self.log.excep
+00003bf0: 7469 6f6e 2822 4661 696c 6564 2074 6f20  tion("Failed to 
+00003c00: 7365 7420 726f 6f6d 2061 7661 7461 7222  set room avatar"
+00003c10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00003c20: 7475 726e 2054 7275 650a 2020 2020 2020  turn True.      
+00003c30: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00003c40: 2020 2020 6173 796e 6320 6465 6620 5f75      async def _u
+00003c50: 7064 6174 655f 7068 6f74 6f5f 6672 6f6d  pdate_photo_from
+00003c60: 5f70 7570 7065 7428 7365 6c66 2c20 7075  _puppet(self, pu
+00003c70: 7070 6574 3a20 702e 5075 7070 6574 2920  ppet: p.Puppet) 
+00003c80: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00003c90: 2069 6620 7365 6c66 2e70 686f 746f 5f69   if self.photo_i
+00003ca0: 6420 3d3d 2070 7570 7065 742e 7068 6f74  d == puppet.phot
+00003cb0: 6f5f 6964 2061 6e64 2028 7365 6c66 2e61  o_id and (self.a
+00003cc0: 7661 7461 725f 7365 7420 6f72 206e 6f74  vatar_set or not
+00003cd0: 2073 656c 662e 7365 745f 646d 5f72 6f6f   self.set_dm_roo
+00003ce0: 6d5f 6d65 7461 6461 7461 293a 0a20 2020  m_metadata):.   
+00003cf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00003d00: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+00003d10: 6c66 2e70 686f 746f 5f69 6420 3d20 7075  lf.photo_id = pu
+00003d20: 7070 6574 2e70 686f 746f 5f69 640a 2020  ppet.photo_id.  
+00003d30: 2020 2020 2020 6966 2070 7570 7065 742e        if puppet.
+00003d40: 7068 6f74 6f5f 6d78 633a 0a20 2020 2020  photo_mxc:.     
+00003d50: 2020 2020 2020 2073 656c 662e 6176 6174         self.avat
+00003d60: 6172 5f75 726c 203d 2070 7570 7065 742e  ar_url = puppet.
+00003d70: 7068 6f74 6f5f 6d78 630a 2020 2020 2020  photo_mxc.      
+00003d80: 2020 656c 6966 2073 656c 662e 7068 6f74    elif self.phot
+00003d90: 6f5f 6964 3a0a 2020 2020 2020 2020 2020  o_id:.          
+00003da0: 2020 7072 6f66 696c 6520 3d20 6177 6169    profile = awai
+00003db0: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
+00003dc0: 6e74 2e67 6574 5f70 726f 6669 6c65 2870  nt.get_profile(p
+00003dd0: 7570 7065 742e 6465 6661 756c 745f 6d78  uppet.default_mx
+00003de0: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00003df0: 7365 6c66 2e61 7661 7461 725f 7572 6c20  self.avatar_url 
+00003e00: 3d20 7072 6f66 696c 652e 6176 6174 6172  = profile.avatar
+00003e10: 5f75 726c 0a20 2020 2020 2020 2020 2020  _url.           
+00003e20: 2070 7570 7065 742e 7068 6f74 6f5f 6d78   puppet.photo_mx
+00003e30: 6320 3d20 7072 6f66 696c 652e 6176 6174  c = profile.avat
+00003e40: 6172 5f75 726c 0a20 2020 2020 2020 2065  ar_url.        e
+00003e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00003e60: 2073 656c 662e 6176 6174 6172 5f75 726c   self.avatar_url
+00003e70: 203d 2043 6f6e 7465 6e74 5552 4928 2222   = ContentURI(""
+00003e80: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00003e90: 7661 7461 725f 7365 7420 3d20 4661 6c73  vatar_set = Fals
+00003ea0: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
+00003eb0: 662e 6d78 6964 2061 6e64 2073 656c 662e  f.mxid and self.
+00003ec0: 7365 745f 646d 5f72 6f6f 6d5f 6d65 7461  set_dm_room_meta
+00003ed0: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+00003ee0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00003ef0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+00003f00: 662e 6d61 696e 5f69 6e74 656e 742e 7365  f.main_intent.se
+00003f10: 745f 726f 6f6d 5f61 7661 7461 7228 7365  t_room_avatar(se
+00003f20: 6c66 2e6d 7869 642c 2073 656c 662e 6176  lf.mxid, self.av
+00003f30: 6174 6172 5f75 726c 290a 2020 2020 2020  atar_url).      
+00003f40: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00003f50: 7661 7461 725f 7365 7420 3d20 5472 7565  vatar_set = True
+00003f60: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00003f70: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00003f80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003f90: 656c 662e 6c6f 672e 6578 6365 7074 696f  elf.log.exceptio
+00003fa0: 6e28 2246 6169 6c65 6420 746f 2073 6574  n("Failed to set
+00003fb0: 2072 6f6f 6d20 6176 6174 6172 2229 0a20   room avatar"). 
+00003fc0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00003fd0: 7565 0a0a 2020 2020 6173 796e 6320 6465  ue..    async de
+00003fe0: 6620 7570 6461 7465 5f69 6e66 6f5f 6672  f update_info_fr
+00003ff0: 6f6d 5f70 7570 7065 7428 7365 6c66 2c20  om_puppet(self, 
+00004000: 7075 7070 6574 3a20 702e 5075 7070 6574  puppet: p.Puppet
+00004010: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00004020: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00004030: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
+00004040: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
+00004050: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00004060: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00004070: 7075 7070 6574 3a0a 2020 2020 2020 2020  puppet:.        
+00004080: 2020 2020 7075 7070 6574 203d 2061 7761      puppet = awa
+00004090: 6974 2073 656c 662e 6765 745f 646d 5f70  it self.get_dm_p
+000040a0: 7570 7065 7428 290a 2020 2020 2020 2020  uppet().        
+000040b0: 6368 616e 6765 6420 3d20 6177 6169 7420  changed = await 
+000040c0: 7365 6c66 2e5f 7570 6461 7465 5f6e 616d  self._update_nam
+000040d0: 6528 7075 7070 6574 2e6e 616d 6529 0a20  e(puppet.name). 
+000040e0: 2020 2020 2020 2063 6861 6e67 6564 203d         changed =
+000040f0: 2061 7761 6974 2073 656c 662e 5f75 7064   await self._upd
+00004100: 6174 655f 7068 6f74 6f5f 6672 6f6d 5f70  ate_photo_from_p
+00004110: 7570 7065 7428 7075 7070 6574 2920 6f72  uppet(puppet) or
+00004120: 2063 6861 6e67 6564 0a20 2020 2020 2020   changed.       
+00004130: 2072 6574 7572 6e20 6368 616e 6765 640a   return changed.
+00004140: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
+00004150: 796e 635f 7065 725f 726f 6f6d 5f6e 6963  ync_per_room_nic
+00004160: 6b28 7365 6c66 2c20 7075 7070 6574 3a20  k(self, puppet: 
+00004170: 702e 5075 7070 6574 2c20 6e61 6d65 3a20  p.Puppet, name: 
+00004180: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+00004190: 2020 2020 2020 696e 7465 6e74 203d 2070        intent = p
+000041a0: 7570 7065 742e 696e 7465 6e74 5f66 6f72  uppet.intent_for
+000041b0: 2873 656c 6629 0a20 2020 2020 2020 2063  (self).        c
+000041c0: 6f6e 7465 6e74 203d 204d 656d 6265 7253  ontent = MemberS
+000041d0: 7461 7465 4576 656e 7443 6f6e 7465 6e74  tateEventContent
+000041e0: 280a 2020 2020 2020 2020 2020 2020 6d65  (.            me
+000041f0: 6d62 6572 7368 6970 3d4d 656d 6265 7273  mbership=Members
+00004200: 6869 702e 4a4f 494e 2c0a 2020 2020 2020  hip.JOIN,.      
+00004210: 2020 2020 2020 6176 6174 6172 5f75 726c        avatar_url
+00004220: 3d70 7570 7065 742e 7068 6f74 6f5f 6d78  =puppet.photo_mx
+00004230: 632c 0a20 2020 2020 2020 2020 2020 2064  c,.            d
+00004240: 6973 706c 6179 6e61 6d65 3d6e 616d 6520  isplayname=name 
+00004250: 6f72 2070 7570 7065 742e 6e61 6d65 2c0a  or puppet.name,.
+00004260: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00004270: 2020 636f 6e74 656e 745b 444f 5542 4c45    content[DOUBLE
+00004280: 5f50 5550 5045 545f 534f 5552 4345 5f4b  _PUPPET_SOURCE_K
+00004290: 4559 5d20 3d20 7365 6c66 2e62 7269 6467  EY] = self.bridg
+000042a0: 652e 6e61 6d65 0a20 2020 2020 2020 2063  e.name.        c
+000042b0: 7572 7265 6e74 5f73 7461 7465 203d 2061  urrent_state = a
+000042c0: 7761 6974 2069 6e74 656e 742e 7374 6174  wait intent.stat
+000042d0: 655f 7374 6f72 652e 6765 745f 6d65 6d62  e_store.get_memb
+000042e0: 6572 2873 656c 662e 6d78 6964 2c20 696e  er(self.mxid, in
+000042f0: 7465 6e74 2e6d 7869 6429 0a20 2020 2020  tent.mxid).     
+00004300: 2020 2069 6620 6e6f 7420 6375 7272 656e     if not curren
+00004310: 745f 7374 6174 6520 6f72 2063 7572 7265  t_state or curre
+00004320: 6e74 5f73 7461 7465 2e64 6973 706c 6179  nt_state.display
+00004330: 6e61 6d65 2021 3d20 636f 6e74 656e 742e  name != content.
+00004340: 6469 7370 6c61 796e 616d 653a 0a20 2020  displayname:.   
+00004350: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00004360: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00004370: 2020 2020 2020 2020 2022 5379 6e63 696e           "Syncin
+00004380: 6720 2573 2773 2070 6572 2d72 6f6f 6d20  g %s's per-room 
+00004390: 6e69 636b 2025 7320 746f 2074 6865 2072  nick %s to the r
+000043a0: 6f6f 6d22 2c0a 2020 2020 2020 2020 2020  oom",.          
+000043b0: 2020 2020 2020 7075 7070 6574 2e66 6269        puppet.fbi
+000043c0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000043d0: 2020 2063 6f6e 7465 6e74 2e64 6973 706c     content.displ
+000043e0: 6179 6e61 6d65 2c0a 2020 2020 2020 2020  ayname,.        
+000043f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00004400: 2020 6177 6169 7420 696e 7465 6e74 2e73    await intent.s
+00004410: 656e 645f 7374 6174 655f 6576 656e 7428  end_state_event(
+00004420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004430: 2073 656c 662e 6d78 6964 2c20 4576 656e   self.mxid, Even
+00004440: 7454 7970 652e 524f 4f4d 5f4d 454d 4245  tType.ROOM_MEMBE
+00004450: 522c 2063 6f6e 7465 6e74 2c20 7374 6174  R, content, stat
+00004460: 655f 6b65 793d 696e 7465 6e74 2e6d 7869  e_key=intent.mxi
+00004470: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
+00004480: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+00004490: 7570 6461 7465 5f70 6172 7469 6369 7061  update_participa
+000044a0: 6e74 280a 2020 2020 2020 2020 7365 6c66  nt(.        self
+000044b0: 2c20 736f 7572 6365 3a20 752e 5573 6572  , source: u.User
+000044c0: 2c20 7061 7274 6963 6970 616e 743a 2067  , participant: g
+000044d0: 7261 7068 716c 2e50 6172 7469 6369 7061  raphql.Participa
+000044e0: 6e74 4e6f 6465 2c20 6e69 636b 5f6d 6170  ntNode, nick_map
+000044f0: 3a20 6469 6374 5b69 6e74 2c20 7374 725d  : dict[int, str]
+00004500: 0a20 2020 2029 202d 3e20 626f 6f6c 3a0a  .    ) -> bool:.
+00004510: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00004520: 2e74 7261 6365 2822 5379 6e63 696e 6720  .trace("Syncing 
+00004530: 7061 7274 6963 6970 616e 7420 2573 222c  participant %s",
+00004540: 2070 6172 7469 6369 7061 6e74 2e69 6429   participant.id)
+00004550: 0a20 2020 2020 2020 2070 7570 7065 7420  .        puppet 
+00004560: 3d20 6177 6169 7420 702e 5075 7070 6574  = await p.Puppet
+00004570: 2e67 6574 5f62 795f 6662 6964 2869 6e74  .get_by_fbid(int
+00004580: 2870 6172 7469 6369 7061 6e74 2e69 6429  (participant.id)
+00004590: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
+000045a0: 7075 7070 6574 2e75 7064 6174 655f 696e  puppet.update_in
+000045b0: 666f 2873 6f75 7263 652c 2070 6172 7469  fo(source, parti
+000045c0: 6369 7061 6e74 2e6d 6573 7361 6769 6e67  cipant.messaging
+000045d0: 5f61 6374 6f72 290a 2020 2020 2020 2020  _actor).        
+000045e0: 6368 616e 6765 6420 3d20 4661 6c73 650a  changed = False.
+000045f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00004600: 6973 5f64 6972 6563 7420 616e 6420 7365  is_direct and se
+00004610: 6c66 2e66 6269 6420 3d3d 2070 7570 7065  lf.fbid == puppe
+00004620: 742e 6662 6964 3a0a 2020 2020 2020 2020  t.fbid:.        
+00004630: 2020 2020 6368 616e 6765 6420 3d20 6177      changed = aw
+00004640: 6169 7420 7365 6c66 2e75 7064 6174 655f  ait self.update_
+00004650: 696e 666f 5f66 726f 6d5f 7075 7070 6574  info_from_puppet
+00004660: 2870 7570 7065 7429 206f 7220 6368 616e  (puppet) or chan
+00004670: 6765 640a 2020 2020 2020 2020 6966 2073  ged.        if s
+00004680: 656c 662e 6d78 6964 3a0a 2020 2020 2020  elf.mxid:.      
+00004690: 2020 2020 2020 6966 2070 7570 7065 742e        if puppet.
+000046a0: 6662 6964 2021 3d20 7365 6c66 2e66 625f  fbid != self.fb_
+000046b0: 7265 6365 6976 6572 206f 7220 7075 7070  receiver or pupp
+000046c0: 6574 2e69 735f 7265 616c 5f75 7365 723a  et.is_real_user:
+000046d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000046e0: 2061 7761 6974 2070 7570 7065 742e 696e   await puppet.in
+000046f0: 7465 6e74 5f66 6f72 2873 656c 6629 2e65  tent_for(self).e
+00004700: 6e73 7572 655f 6a6f 696e 6564 2873 656c  nsure_joined(sel
+00004710: 662e 6d78 6964 2c20 626f 743d 7365 6c66  f.mxid, bot=self
+00004720: 2e6d 6169 6e5f 696e 7465 6e74 290a 2020  .main_intent).  
+00004730: 2020 2020 2020 2020 2020 6966 2070 7570            if pup
+00004740: 7065 742e 6662 6964 2069 6e20 6e69 636b  pet.fbid in nick
+00004750: 5f6d 6170 2061 6e64 206e 6f74 2070 7570  _map and not pup
+00004760: 7065 742e 6973 5f72 6561 6c5f 7573 6572  pet.is_real_user
+00004770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00004780: 2020 6177 6169 7420 7365 6c66 2e73 796e    await self.syn
+00004790: 635f 7065 725f 726f 6f6d 5f6e 6963 6b28  c_per_room_nick(
+000047a0: 7075 7070 6574 2c20 6e69 636b 5f6d 6170  puppet, nick_map
+000047b0: 5b70 7570 7065 742e 6662 6964 5d29 0a20  [puppet.fbid]). 
+000047c0: 2020 2020 2020 2072 6574 7572 6e20 6368         return ch
+000047d0: 616e 6765 640a 0a20 2020 2061 7379 6e63  anged..    async
+000047e0: 2064 6566 205f 7570 6461 7465 5f70 6172   def _update_par
+000047f0: 7469 6369 7061 6e74 7328 7365 6c66 2c20  ticipants(self, 
+00004800: 736f 7572 6365 3a20 752e 5573 6572 2c20  source: u.User, 
+00004810: 696e 666f 3a20 6772 6170 6871 6c2e 5468  info: graphql.Th
+00004820: 7265 6164 2920 2d3e 2062 6f6f 6c3a 0a20  read) -> bool:. 
+00004830: 2020 2020 2020 206e 6963 6b5f 6d61 7020         nick_map 
+00004840: 3d20 696e 666f 2e63 7573 746f 6d69 7a61  = info.customiza
+00004850: 7469 6f6e 5f69 6e66 6f2e 6e69 636b 6e61  tion_info.nickna
+00004860: 6d65 5f6d 6170 2069 6620 696e 666f 2e63  me_map if info.c
+00004870: 7573 746f 6d69 7a61 7469 6f6e 5f69 6e66  ustomization_inf
+00004880: 6f20 656c 7365 207b 7d0a 2020 2020 2020  o else {}.      
+00004890: 2020 7379 6e63 5f74 6173 6b73 203d 205b    sync_tasks = [
+000048a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000048b0: 662e 5f75 7064 6174 655f 7061 7274 6963  f._update_partic
+000048c0: 6970 616e 7428 736f 7572 6365 2c20 7063  ipant(source, pc
+000048d0: 702c 206e 6963 6b5f 6d61 7029 2066 6f72  p, nick_map) for
+000048e0: 2070 6370 2069 6e20 696e 666f 2e61 6c6c   pcp in info.all
+000048f0: 5f70 6172 7469 6369 7061 6e74 732e 6e6f  _participants.no
+00004900: 6465 730a 2020 2020 2020 2020 5d0a 2020  des.        ].  
+00004910: 2020 2020 2020 6368 616e 6765 6420 3d20        changed = 
+00004920: 616e 7928 6177 6169 7420 6173 796e 6369  any(await asynci
+00004930: 6f2e 6761 7468 6572 282a 7379 6e63 5f74  o.gather(*sync_t
+00004940: 6173 6b73 2929 0a20 2020 2020 2020 2072  asks)).        r
+00004950: 6574 7572 6e20 6368 616e 6765 640a 0a20  eturn changed.. 
+00004960: 2020 2023 2065 6e64 7265 6769 6f6e 0a20     # endregion. 
+00004970: 2020 2023 2072 6567 696f 6e20 4d61 7472     # region Matr
+00004980: 6978 2072 6f6f 6d20 6372 6561 7469 6f6e  ix room creation
+00004990: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000049a0: 7570 6461 7465 5f6d 6174 7269 785f 726f  update_matrix_ro
+000049b0: 6f6d 2873 656c 662c 2073 6f75 7263 653a  om(self, source:
+000049c0: 2075 2e55 7365 722c 2069 6e66 6f3a 2067   u.User, info: g
+000049d0: 7261 7068 716c 2e54 6872 6561 6420 7c20  raphql.Thread | 
+000049e0: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
+000049f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
+00004a00: 793a 0a20 2020 2020 2020 2020 2020 2061  y:.            a
+00004a10: 7761 6974 2073 656c 662e 5f75 7064 6174  wait self._updat
+00004a20: 655f 6d61 7472 6978 5f72 6f6f 6d28 736f  e_matrix_room(so
+00004a30: 7572 6365 2c20 696e 666f 290a 2020 2020  urce, info).    
+00004a40: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00004a50: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00004a60: 2020 7365 6c66 2e6c 6f67 2e65 7863 6570    self.log.excep
+00004a70: 7469 6f6e 2822 4661 696c 6564 2074 6f20  tion("Failed to 
+00004a80: 7570 6461 7465 2070 6f72 7461 6c22 290a  update portal").
+00004a90: 0a20 2020 2064 6566 205f 6765 745f 696e  .    def _get_in
+00004aa0: 7669 7465 5f63 6f6e 7465 6e74 2873 656c  vite_content(sel
+00004ab0: 662c 2064 6f75 626c 655f 7075 7070 6574  f, double_puppet
+00004ac0: 3a20 702e 5075 7070 6574 207c 204e 6f6e  : p.Puppet | Non
+00004ad0: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
+00004ae0: 416e 795d 3a0a 2020 2020 2020 2020 696e  Any]:.        in
+00004af0: 7669 7465 5f63 6f6e 7465 6e74 203d 207b  vite_content = {
+00004b00: 7d0a 2020 2020 2020 2020 6966 2064 6f75  }.        if dou
+00004b10: 626c 655f 7075 7070 6574 3a0a 2020 2020  ble_puppet:.    
+00004b20: 2020 2020 2020 2020 696e 7669 7465 5f63          invite_c
+00004b30: 6f6e 7465 6e74 5b22 6669 2e6d 6175 2e77  ontent["fi.mau.w
+00004b40: 696c 6c5f 6175 746f 5f61 6363 6570 7422  ill_auto_accept"
+00004b50: 5d20 3d20 5472 7565 0a20 2020 2020 2020  ] = True.       
+00004b60: 2069 6620 7365 6c66 2e69 735f 6469 7265   if self.is_dire
+00004b70: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+00004b80: 696e 7669 7465 5f63 6f6e 7465 6e74 5b22  invite_content["
+00004b90: 6973 5f64 6972 6563 7422 5d20 3d20 5472  is_direct"] = Tr
+00004ba0: 7565 0a20 2020 2020 2020 2072 6574 7572  ue.        retur
+00004bb0: 6e20 696e 7669 7465 5f63 6f6e 7465 6e74  n invite_content
+00004bc0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00004bd0: 5f75 7064 6174 655f 6d61 7472 6978 5f72  _update_matrix_r
+00004be0: 6f6f 6d28 0a20 2020 2020 2020 2073 656c  oom(.        sel
+00004bf0: 662c 2073 6f75 7263 653a 2075 2e55 7365  f, source: u.Use
+00004c00: 722c 2069 6e66 6f3a 2067 7261 7068 716c  r, info: graphql
+00004c10: 2e54 6872 6561 6420 7c20 4e6f 6e65 203d  .Thread | None =
+00004c20: 204e 6f6e 650a 2020 2020 2920 2d3e 204e   None.    ) -> N
+00004c30: 6f6e 653a 0a20 2020 2020 2020 2070 7570  one:.        pup
+00004c40: 7065 7420 3d20 6177 6169 7420 702e 5075  pet = await p.Pu
+00004c50: 7070 6574 2e67 6574 5f62 795f 6375 7374  ppet.get_by_cust
+00004c60: 6f6d 5f6d 7869 6428 736f 7572 6365 2e6d  om_mxid(source.m
+00004c70: 7869 6429 0a20 2020 2020 2020 2061 7761  xid).        awa
+00004c80: 6974 2073 656c 662e 6d61 696e 5f69 6e74  it self.main_int
+00004c90: 656e 742e 696e 7669 7465 5f75 7365 7228  ent.invite_user(
+00004ca0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00004cb0: 662e 6d78 6964 2c0a 2020 2020 2020 2020  f.mxid,.        
+00004cc0: 2020 2020 736f 7572 6365 2e6d 7869 642c      source.mxid,
+00004cd0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
+00004ce0: 636b 5f63 6163 6865 3d54 7275 652c 0a20  ck_cache=True,. 
+00004cf0: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+00004d00: 5f63 6f6e 7465 6e74 3d73 656c 662e 5f67  _content=self._g
+00004d10: 6574 5f69 6e76 6974 655f 636f 6e74 656e  et_invite_conten
+00004d20: 7428 7075 7070 6574 292c 0a20 2020 2020  t(puppet),.     
+00004d30: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+00004d40: 7075 7070 6574 3a0a 2020 2020 2020 2020  puppet:.        
+00004d50: 2020 2020 6469 645f 6a6f 696e 203d 2061      did_join = a
+00004d60: 7761 6974 2070 7570 7065 742e 696e 7465  wait puppet.inte
+00004d70: 6e74 2e65 6e73 7572 655f 6a6f 696e 6564  nt.ensure_joined
+00004d80: 2873 656c 662e 6d78 6964 290a 2020 2020  (self.mxid).    
+00004d90: 2020 2020 2020 2020 6966 2064 6964 5f6a          if did_j
+00004da0: 6f69 6e20 616e 6420 7365 6c66 2e69 735f  oin and self.is_
+00004db0: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
+00004dc0: 2020 2020 2020 2020 6177 6169 7420 736f          await so
+00004dd0: 7572 6365 2e75 7064 6174 655f 6469 7265  urce.update_dire
+00004de0: 6374 5f63 6861 7473 287b 7365 6c66 2e6d  ct_chats({self.m
+00004df0: 6169 6e5f 696e 7465 6e74 2e6d 7869 643a  ain_intent.mxid:
+00004e00: 205b 7365 6c66 2e6d 7869 645d 7d29 0a0a   [self.mxid]})..
+00004e10: 2020 2020 2020 2020 696e 666f 203d 2061          info = a
+00004e20: 7761 6974 2073 656c 662e 7570 6461 7465  wait self.update
+00004e30: 5f69 6e66 6f28 736f 7572 6365 2c20 696e  _info(source, in
+00004e40: 666f 290a 2020 2020 2020 2020 6966 206e  fo).        if n
+00004e50: 6f74 2069 6e66 6f3a 0a20 2020 2020 2020  ot info:.       
+00004e60: 2020 2020 2073 656c 662e 6c6f 672e 7761       self.log.wa
+00004e70: 726e 696e 6728 2243 616e 6365 6c69 6e67  rning("Canceling
+00004e80: 205f 7570 6461 7465 5f6d 6174 7269 785f   _update_matrix_
+00004e90: 726f 6f6d 2061 7320 7570 6461 7465 5f69  room as update_i
+00004ea0: 6e66 6f20 6469 646e 2774 2072 6574 7572  nfo didn't retur
+00004eb0: 6e20 696e 666f 2229 0a20 2020 2020 2020  n info").       
+00004ec0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00004ed0: 2020 2020 2061 7761 6974 2055 7365 7250       await UserP
+00004ee0: 6f72 7461 6c28 0a20 2020 2020 2020 2020  ortal(.         
+00004ef0: 2020 2075 7365 723d 736f 7572 6365 2e66     user=source.f
+00004f00: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
+00004f10: 2070 6f72 7461 6c3d 7365 6c66 2e66 6269   portal=self.fbi
+00004f20: 642c 0a20 2020 2020 2020 2020 2020 2070  d,.            p
+00004f30: 6f72 7461 6c5f 7265 6365 6976 6572 3d73  ortal_receiver=s
+00004f40: 656c 662e 6662 5f72 6563 6569 7665 722c  elf.fb_receiver,
+00004f50: 0a20 2020 2020 2020 2029 2e75 7073 6572  .        ).upser
+00004f60: 7428 290a 2020 2020 2020 2020 6177 6169  t().        awai
+00004f70: 7420 7365 6c66 2e5f 7379 6e63 5f72 6561  t self._sync_rea
+00004f80: 645f 7265 6365 6970 7473 2869 6e66 6f2e  d_receipts(info.
+00004f90: 7265 6164 5f72 6563 6569 7074 732e 6e6f  read_receipts.no
+00004fa0: 6465 732c 2072 6561 6374 696f 6e73 3d46  des, reactions=F
+00004fb0: 616c 7365 290a 0a20 2020 2061 7379 6e63  alse)..    async
+00004fc0: 2064 6566 205f 7379 6e63 5f72 6561 645f   def _sync_read_
+00004fd0: 7265 6365 6970 7473 280a 2020 2020 2020  receipts(.      
+00004fe0: 2020 7365 6c66 2c20 7265 6365 6970 7473    self, receipts
+00004ff0: 3a20 6c69 7374 5b67 7261 7068 716c 2e52  : list[graphql.R
+00005000: 6561 6452 6563 6569 7074 5d2c 2072 6561  eadReceipt], rea
+00005010: 6374 696f 6e73 3a20 626f 6f6c 0a20 2020  ctions: bool.   
+00005020: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+00005030: 2020 2020 666f 7220 7265 6365 6970 7420      for receipt 
+00005040: 696e 2072 6563 6569 7074 733a 0a20 2020  in receipts:.   
+00005050: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00005060: 7265 6365 6970 742e 6163 746f 723a 0a20  receipt.actor:. 
+00005070: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00005080: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00005090: 2020 2020 6d65 7373 6167 6520 3d20 6177      message = aw
+000050a0: 6169 7420 4442 4d65 7373 6167 652e 6765  ait DBMessage.ge
+000050b0: 745f 636c 6f73 6573 745f 6265 666f 7265  t_closest_before
+000050c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000050d0: 2020 7365 6c66 2e66 6269 642c 2073 656c    self.fbid, sel
+000050e0: 662e 6662 5f72 6563 6569 7665 722c 2072  f.fb_receiver, r
+000050f0: 6563 6569 7074 2e74 696d 6573 7461 6d70  eceipt.timestamp
+00005100: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00005110: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00005120: 7420 6d65 7373 6167 653a 0a20 2020 2020  t message:.     
+00005130: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00005140: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+00005150: 7075 7070 6574 203d 2061 7761 6974 2070  puppet = await p
+00005160: 2e50 7570 7065 742e 6765 745f 6279 5f66  .Puppet.get_by_f
+00005170: 6269 6428 7265 6365 6970 742e 6163 746f  bid(receipt.acto
+00005180: 722e 6964 2c20 6372 6561 7465 3d46 616c  r.id, create=Fal
+00005190: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+000051a0: 6966 206e 6f74 2070 7570 7065 743a 0a20  if not puppet:. 
+000051b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000051c0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+000051d0: 2020 2020 6d73 6769 645f 7465 7874 203d      msgid_text =
+000051e0: 206d 6573 7361 6765 2e6d 7869 640a 2020   message.mxid.  
+000051f0: 2020 2020 2020 2020 2020 6966 2072 6561            if rea
+00005200: 6374 696f 6e73 2061 6e64 206d 6573 7361  ctions and messa
+00005210: 6765 2e66 6269 643a 0a20 2020 2020 2020  ge.fbid:.       
+00005220: 2020 2020 2020 2020 2072 6561 6374 696f           reactio
+00005230: 6e20 3d20 6177 6169 7420 4442 5265 6163  n = await DBReac
+00005240: 7469 6f6e 2e67 6574 5f6c 6173 745f 666f  tion.get_last_fo
+00005250: 725f 6d65 7373 6167 6528 6d65 7373 6167  r_message(messag
+00005260: 652e 6662 6964 2c20 6d65 7373 6167 652e  e.fbid, message.
+00005270: 6662 5f72 6563 6569 7665 7229 0a20 2020  fb_receiver).   
+00005280: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00005290: 7265 6163 7469 6f6e 3a0a 2020 2020 2020  reaction:.      
+000052a0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+000052b0: 6769 645f 7465 7874 203d 2066 227b 6d65  gid_text = f"{me
+000052c0: 7373 6167 652e 6d78 6964 7d20 2d3e 206c  ssage.mxid} -> l
+000052d0: 6173 7420 7265 6163 7469 6f6e 207b 7265  ast reaction {re
+000052e0: 6163 7469 6f6e 2e6d 7869 647d 220a 2020  action.mxid}".  
+000052f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005300: 2020 6d65 7373 6167 6520 3d20 7265 6163    message = reac
+00005310: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00005320: 2073 656c 662e 6c6f 672e 6465 6275 6728   self.log.debug(
+00005330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005340: 2022 2573 2068 6173 2072 6561 6420 6d65   "%s has read me
+00005350: 7373 6167 6573 2075 7020 746f 2025 6420  ssages up to %d 
+00005360: 2d3e 2025 7322 2c20 7075 7070 6574 2e6d  -> %s", puppet.m
+00005370: 7869 642c 2072 6563 6569 7074 2e74 696d  xid, receipt.tim
+00005380: 6573 7461 6d70 2c20 6d73 6769 645f 7465  estamp, msgid_te
+00005390: 7874 0a20 2020 2020 2020 2020 2020 2029  xt.            )
+000053a0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+000053b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000053c0: 2020 6177 6169 7420 7075 7070 6574 2e69    await puppet.i
+000053d0: 6e74 656e 745f 666f 7228 7365 6c66 292e  ntent_for(self).
+000053e0: 6d61 726b 5f72 6561 6428 6d65 7373 6167  mark_read(messag
+000053f0: 652e 6d78 5f72 6f6f 6d2c 206d 6573 7361  e.mx_room, messa
+00005400: 6765 2e6d 7869 6429 0a20 2020 2020 2020  ge.mxid).       
+00005410: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00005420: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+00005430: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+00005440: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00005450: 2020 2020 2020 2020 2020 2020 2066 2246               f"F
+00005460: 6169 6c65 6420 746f 206d 6172 6b20 7b6d  ailed to mark {m
+00005470: 6573 7361 6765 2e6d 7869 647d 2069 6e20  essage.mxid} in 
+00005480: 7b6d 6573 7361 6765 2e6d 785f 726f 6f6d  {message.mx_room
+00005490: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
+000054a0: 2020 2020 2020 2020 6622 6173 2072 6561          f"as rea
+000054b0: 6420 6279 207b 7075 7070 6574 2e69 6e74  d by {puppet.int
+000054c0: 656e 742e 6d78 6964 7d22 2c0a 2020 2020  ent.mxid}",.    
+000054d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054e0: 6578 635f 696e 666f 3d54 7275 652c 0a20  exc_info=True,. 
+000054f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00005500: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00005510: 6372 6561 7465 5f6d 6174 7269 785f 726f  create_matrix_ro
+00005520: 6f6d 280a 2020 2020 2020 2020 7365 6c66  om(.        self
+00005530: 2c20 736f 7572 6365 3a20 752e 5573 6572  , source: u.User
+00005540: 2c20 696e 666f 3a20 6772 6170 6871 6c2e  , info: graphql.
+00005550: 5468 7265 6164 207c 204e 6f6e 6520 3d20  Thread | None = 
+00005560: 4e6f 6e65 0a20 2020 2029 202d 3e20 526f  None.    ) -> Ro
+00005570: 6f6d 4944 207c 204e 6f6e 653a 0a20 2020  omID | None:.   
+00005580: 2020 2020 2069 6620 7365 6c66 2e6d 7869       if self.mxi
+00005590: 643a 0a20 2020 2020 2020 2020 2020 2074  d:.            t
+000055a0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000055b0: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
+000055c0: 7570 6461 7465 5f6d 6174 7269 785f 726f  update_matrix_ro
+000055d0: 6f6d 2873 6f75 7263 652c 2069 6e66 6f29  om(source, info)
+000055e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+000055f0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00005600: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005610: 656c 662e 6c6f 672e 6578 6365 7074 696f  elf.log.exceptio
+00005620: 6e28 2246 6169 6c65 6420 746f 2075 7064  n("Failed to upd
+00005630: 6174 6520 706f 7274 616c 2229 0a20 2020  ate portal").   
+00005640: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00005650: 7365 6c66 2e6d 7869 640a 2020 2020 2020  self.mxid.      
+00005660: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
+00005670: 662e 5f63 7265 6174 655f 726f 6f6d 5f6c  f._create_room_l
+00005680: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
+00005690: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000056a0: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
+000056b0: 6974 2073 656c 662e 5f63 7265 6174 655f  it self._create_
+000056c0: 6d61 7472 6978 5f72 6f6f 6d28 736f 7572  matrix_room(sour
+000056d0: 6365 2c20 696e 666f 290a 2020 2020 2020  ce, info).      
+000056e0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+000056f0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00005700: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00005710: 2e65 7863 6570 7469 6f6e 2822 4661 696c  .exception("Fail
+00005720: 6564 2074 6f20 6372 6561 7465 2070 6f72  ed to create por
+00005730: 7461 6c22 290a 2020 2020 2020 2020 2020  tal").          
+00005740: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00005750: 650a 0a20 2020 2040 7072 6f70 6572 7479  e..    @property
+00005760: 0a20 2020 2064 6566 2062 7269 6467 655f  .    def bridge_
+00005770: 696e 666f 5f73 7461 7465 5f6b 6579 2873  info_state_key(s
+00005780: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00005790: 2020 2020 2072 6574 7572 6e20 6622 6e65       return f"ne
+000057a0: 742e 6d61 756e 6975 6d2e 6661 6365 626f  t.maunium.facebo
+000057b0: 6f6b 3a2f 2f66 6163 6562 6f6f 6b2f 7b73  ok://facebook/{s
+000057c0: 656c 662e 6662 6964 7d22 0a0a 2020 2020  elf.fbid}"..    
+000057d0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+000057e0: 6620 6272 6964 6765 5f69 6e66 6f28 7365  f bridge_info(se
+000057f0: 6c66 2920 2d3e 2064 6963 745b 7374 722c  lf) -> dict[str,
+00005800: 2041 6e79 5d3a 0a20 2020 2020 2020 2072   Any]:.        r
+00005810: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00005820: 2020 2020 2262 7269 6467 6562 6f74 223a      "bridgebot":
+00005830: 2073 656c 662e 617a 2e62 6f74 5f6d 7869   self.az.bot_mxi
+00005840: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
+00005850: 6372 6561 746f 7222 3a20 7365 6c66 2e6d  creator": self.m
+00005860: 6169 6e5f 696e 7465 6e74 2e6d 7869 642c  ain_intent.mxid,
+00005870: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+00005880: 6f74 6f63 6f6c 223a 207b 0a20 2020 2020  otocol": {.     
+00005890: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
+000058a0: 2022 6661 6365 626f 6f6b 222c 0a20 2020   "facebook",.   
+000058b0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+000058c0: 7370 6c61 796e 616d 6522 3a20 2246 6163  splayname": "Fac
+000058d0: 6562 6f6f 6b20 4d65 7373 656e 6765 7222  ebook Messenger"
+000058e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000058f0: 2020 2261 7661 7461 725f 7572 6c22 3a20    "avatar_url": 
+00005900: 7365 6c66 2e63 6f6e 6669 675b 2261 7070  self.config["app
+00005910: 7365 7276 6963 652e 626f 745f 6176 6174  service.bot_avat
+00005920: 6172 225d 2c0a 2020 2020 2020 2020 2020  ar"],.          
+00005930: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+00005940: 2022 6368 616e 6e65 6c22 3a20 7b0a 2020   "channel": {.  
+00005950: 2020 2020 2020 2020 2020 2020 2020 2269                "i
+00005960: 6422 3a20 7374 7228 7365 6c66 2e66 6269  d": str(self.fbi
+00005970: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00005980: 2020 2020 2264 6973 706c 6179 6e61 6d65      "displayname
+00005990: 223a 2073 656c 662e 6e61 6d65 2c0a 2020  ": self.name,.  
+000059a0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+000059b0: 7661 7461 725f 7572 6c22 3a20 7365 6c66  vatar_url": self
+000059c0: 2e61 7661 7461 725f 7572 6c2c 0a20 2020  .avatar_url,.   
+000059d0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000059e0: 2020 2020 7d0a 0a20 2020 2061 7379 6e63      }..    async
+000059f0: 2064 6566 2075 7064 6174 655f 6272 6964   def update_brid
+00005a00: 6765 5f69 6e66 6f28 7365 6c66 2920 2d3e  ge_info(self) ->
+00005a10: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00005a20: 6620 6e6f 7420 7365 6c66 2e6d 7869 643a  f not self.mxid:
+00005a30: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00005a40: 662e 6c6f 672e 6465 6275 6728 224e 6f74  f.log.debug("Not
+00005a50: 2075 7064 6174 696e 6720 6272 6964 6765   updating bridge
+00005a60: 2069 6e66 6f3a 206e 6f20 4d61 7472 6978   info: no Matrix
+00005a70: 2072 6f6f 6d20 6372 6561 7465 6422 290a   room created").
+00005a80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005a90: 726e 0a20 2020 2020 2020 2074 7279 3a0a  rn.        try:.
+00005aa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005ab0: 2e6c 6f67 2e64 6562 7567 2822 5570 6461  .log.debug("Upda
+00005ac0: 7469 6e67 2062 7269 6467 6520 696e 666f  ting bridge info
+00005ad0: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
+00005ae0: 2020 6177 6169 7420 7365 6c66 2e6d 6169    await self.mai
+00005af0: 6e5f 696e 7465 6e74 2e73 656e 645f 7374  n_intent.send_st
+00005b00: 6174 655f 6576 656e 7428 0a20 2020 2020  ate_event(.     
+00005b10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00005b20: 6d78 6964 2c20 5374 6174 6542 7269 6467  mxid, StateBridg
+00005b30: 652c 2073 656c 662e 6272 6964 6765 5f69  e, self.bridge_i
+00005b40: 6e66 6f2c 2073 656c 662e 6272 6964 6765  nfo, self.bridge
+00005b50: 5f69 6e66 6f5f 7374 6174 655f 6b65 790a  _info_state_key.
+00005b60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00005b70: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+00005b80: 2072 656d 6f76 6520 7468 6973 206f 6e63   remove this onc
+00005b90: 6520 6874 7470 733a 2f2f 6769 7468 7562  e https://github
+00005ba0: 2e63 6f6d 2f6d 6174 7269 782d 6f72 672f  .com/matrix-org/
+00005bb0: 6d61 7472 6978 2d64 6f63 2f70 756c 6c2f  matrix-doc/pull/
+00005bc0: 3233 3436 2069 7320 696e 2073 7065 630a  2346 is in spec.
+00005bd0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00005be0: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
+00005bf0: 6e74 2e73 656e 645f 7374 6174 655f 6576  nt.send_state_ev
+00005c00: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
+00005c10: 2020 2020 2073 656c 662e 6d78 6964 2c20       self.mxid, 
+00005c20: 5374 6174 6548 616c 6653 686f 7442 7269  StateHalfShotBri
+00005c30: 6467 652c 2073 656c 662e 6272 6964 6765  dge, self.bridge
+00005c40: 5f69 6e66 6f2c 2073 656c 662e 6272 6964  _info, self.brid
+00005c50: 6765 5f69 6e66 6f5f 7374 6174 655f 6b65  ge_info_state_ke
+00005c60: 790a 2020 2020 2020 2020 2020 2020 290a  y.            ).
+00005c70: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00005c80: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00005c90: 2020 2020 2020 7365 6c66 2e6c 6f67 2e77        self.log.w
+00005ca0: 6172 6e69 6e67 2822 4661 696c 6564 2074  arning("Failed t
+00005cb0: 6f20 7570 6461 7465 2062 7269 6467 6520  o update bridge 
+00005cc0: 696e 666f 222c 2065 7863 5f69 6e66 6f3d  info", exc_info=
+00005cd0: 5472 7565 290a 0a20 2020 2061 7379 6e63  True)..    async
+00005ce0: 2064 6566 205f 6372 6561 7465 5f6d 6174   def _create_mat
+00005cf0: 7269 785f 726f 6f6d 280a 2020 2020 2020  rix_room(.      
+00005d00: 2020 7365 6c66 2c20 736f 7572 6365 3a20    self, source: 
+00005d10: 752e 5573 6572 2c20 696e 666f 3a20 6772  u.User, info: gr
+00005d20: 6170 6871 6c2e 5468 7265 6164 207c 204e  aphql.Thread | N
+00005d30: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+00005d40: 202d 3e20 526f 6f6d 4944 207c 204e 6f6e   -> RoomID | Non
+00005d50: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
+00005d60: 6c66 2e6d 7869 643a 0a20 2020 2020 2020  lf.mxid:.       
+00005d70: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00005d80: 5f75 7064 6174 655f 6d61 7472 6978 5f72  _update_matrix_r
+00005d90: 6f6f 6d28 736f 7572 6365 2c20 696e 666f  oom(source, info
+00005da0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00005db0: 7475 726e 2073 656c 662e 6d78 6964 0a0a  turn self.mxid..
+00005dc0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00005dd0: 2e64 6562 7567 2822 4372 6561 7469 6e67  .debug("Creating
+00005de0: 204d 6174 7269 7820 726f 6f6d 2229 0a20   Matrix room"). 
+00005df0: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
+00005e00: 207c 204e 6f6e 6520 3d20 4e6f 6e65 0a20   | None = None. 
+00005e10: 2020 2020 2020 2069 6e69 7469 616c 5f73         initial_s
+00005e20: 7461 7465 203d 205b 0a20 2020 2020 2020  tate = [.       
+00005e30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00005e40: 2020 2020 2020 2022 7479 7065 223a 2073         "type": s
+00005e50: 7472 2853 7461 7465 4272 6964 6765 292c  tr(StateBridge),
+00005e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005e70: 2022 7374 6174 655f 6b65 7922 3a20 7365   "state_key": se
+00005e80: 6c66 2e62 7269 6467 655f 696e 666f 5f73  lf.bridge_info_s
+00005e90: 7461 7465 5f6b 6579 2c0a 2020 2020 2020  tate_key,.      
+00005ea0: 2020 2020 2020 2020 2020 2263 6f6e 7465            "conte
+00005eb0: 6e74 223a 2073 656c 662e 6272 6964 6765  nt": self.bridge
+00005ec0: 5f69 6e66 6f2c 0a20 2020 2020 2020 2020  _info,.         
+00005ed0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+00005ee0: 2020 2320 544f 444f 2072 656d 6f76 6520    # TODO remove 
+00005ef0: 7468 6973 206f 6e63 6520 6874 7470 733a  this once https:
+00005f00: 2f2f 6769 7468 7562 2e63 6f6d 2f6d 6174  //github.com/mat
+00005f10: 7269 782d 6f72 672f 6d61 7472 6978 2d64  rix-org/matrix-d
+00005f20: 6f63 2f70 756c 6c2f 3233 3436 2069 7320  oc/pull/2346 is 
+00005f30: 696e 2073 7065 630a 2020 2020 2020 2020  in spec.        
+00005f40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00005f50: 2020 2020 2020 2274 7970 6522 3a20 7374        "type": st
+00005f60: 7228 5374 6174 6548 616c 6653 686f 7442  r(StateHalfShotB
+00005f70: 7269 6467 6529 2c0a 2020 2020 2020 2020  ridge),.        
+00005f80: 2020 2020 2020 2020 2273 7461 7465 5f6b          "state_k
+00005f90: 6579 223a 2073 656c 662e 6272 6964 6765  ey": self.bridge
+00005fa0: 5f69 6e66 6f5f 7374 6174 655f 6b65 792c  _info_state_key,
+00005fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005fc0: 2022 636f 6e74 656e 7422 3a20 7365 6c66   "content": self
+00005fd0: 2e62 7269 6467 655f 696e 666f 2c0a 2020  .bridge_info,.  
+00005fe0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00005ff0: 2020 2020 205d 0a20 2020 2020 2020 2069       ].        i
+00006000: 6e76 6974 6573 203d 205b 5d0a 2020 2020  nvites = [].    
+00006010: 2020 2020 6966 2073 656c 662e 636f 6e66      if self.conf
+00006020: 6967 5b22 6272 6964 6765 2e65 6e63 7279  ig["bridge.encry
+00006030: 7074 696f 6e2e 6465 6661 756c 7422 5d20  ption.default"] 
+00006040: 616e 6420 7365 6c66 2e6d 6174 7269 782e  and self.matrix.
+00006050: 6532 6565 3a0a 2020 2020 2020 2020 2020  e2ee:.          
+00006060: 2020 7365 6c66 2e65 6e63 7279 7074 6564    self.encrypted
+00006070: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00006080: 2020 2020 696e 6974 6961 6c5f 7374 6174      initial_stat
+00006090: 652e 6170 7065 6e64 280a 2020 2020 2020  e.append(.      
+000060a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000060b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060c0: 2274 7970 6522 3a20 226d 2e72 6f6f 6d2e  "type": "m.room.
+000060d0: 656e 6372 7970 7469 6f6e 222c 0a20 2020  encryption",.   
+000060e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060f0: 2022 636f 6e74 656e 7422 3a20 7365 6c66   "content": self
+00006100: 2e67 6574 5f65 6e63 7279 7074 696f 6e5f  .get_encryption_
+00006110: 7374 6174 655f 6576 656e 745f 6a73 6f6e  state_event_json
+00006120: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00006130: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00006140: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00006150: 6966 2073 656c 662e 6973 5f64 6972 6563  if self.is_direc
+00006160: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00006170: 2020 2069 6e76 6974 6573 2e61 7070 656e     invites.appen
+00006180: 6428 7365 6c66 2e61 7a2e 626f 745f 6d78  d(self.az.bot_mx
+00006190: 6964 290a 0a20 2020 2020 2020 2069 6e66  id)..        inf
+000061a0: 6f20 3d20 6177 6169 7420 7365 6c66 2e75  o = await self.u
+000061b0: 7064 6174 655f 696e 666f 2873 6f75 7263  pdate_info(sourc
+000061c0: 652c 2069 6e66 6f3d 696e 666f 290a 2020  e, info=info).  
+000061d0: 2020 2020 2020 6966 206e 6f74 2069 6e66        if not inf
+000061e0: 6f3a 0a20 2020 2020 2020 2020 2020 2073  o:.            s
+000061f0: 656c 662e 6c6f 672e 6465 6275 6728 2275  elf.log.debug("u
+00006200: 7064 6174 655f 696e 666f 2829 2064 6964  pdate_info() did
+00006210: 6e27 7420 7265 7475 726e 2069 6e66 6f2c  n't return info,
+00006220: 2063 616e 6365 6c6c 696e 6720 726f 6f6d   cancelling room
+00006230: 2063 7265 6174 696f 6e22 290a 2020 2020   creation").    
+00006240: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00006250: 6f6e 650a 0a20 2020 2020 2020 2069 6620  one..        if 
+00006260: 7365 6c66 2e73 6574 5f64 6d5f 726f 6f6d  self.set_dm_room
+00006270: 5f6d 6574 6164 6174 613a 0a20 2020 2020  _metadata:.     
+00006280: 2020 2020 2020 206e 616d 6520 3d20 7365         name = se
+00006290: 6c66 2e6e 616d 650a 2020 2020 2020 2020  lf.name.        
+000062a0: 2020 2020 696e 6974 6961 6c5f 7374 6174      initial_stat
+000062b0: 652e 6170 7065 6e64 280a 2020 2020 2020  e.append(.      
+000062c0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000062d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062e0: 2274 7970 6522 3a20 7374 7228 4576 656e  "type": str(Even
+000062f0: 7454 7970 652e 524f 4f4d 5f41 5641 5441  tType.ROOM_AVATA
+00006300: 5229 2c0a 2020 2020 2020 2020 2020 2020  R),.            
+00006310: 2020 2020 2020 2020 2263 6f6e 7465 6e74          "content
+00006320: 223a 207b 2275 726c 223a 2073 656c 662e  ": {"url": self.
+00006330: 6176 6174 6172 5f75 726c 7d2c 0a20 2020  avatar_url},.   
+00006340: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00006350: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00006360: 2020 2020 2020 6372 6561 7469 6f6e 5f63        creation_c
+00006370: 6f6e 7465 6e74 203d 207b 7d0a 2020 2020  ontent = {}.    
+00006380: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00006390: 636f 6e66 6967 5b22 6272 6964 6765 2e66  config["bridge.f
+000063a0: 6564 6572 6174 655f 726f 6f6d 7322 5d3a  ederate_rooms"]:
+000063b0: 0a20 2020 2020 2020 2020 2020 2063 7265  .            cre
+000063c0: 6174 696f 6e5f 636f 6e74 656e 745b 226d  ation_content["m
+000063d0: 2e66 6564 6572 6174 6522 5d20 3d20 4661  .federate"] = Fa
+000063e0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+000063f0: 2e6d 7869 6420 3d20 6177 6169 7420 7365  .mxid = await se
+00006400: 6c66 2e6d 6169 6e5f 696e 7465 6e74 2e63  lf.main_intent.c
+00006410: 7265 6174 655f 726f 6f6d 280a 2020 2020  reate_room(.    
+00006420: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
+00006430: 652c 0a20 2020 2020 2020 2020 2020 2069  e,.            i
+00006440: 735f 6469 7265 6374 3d73 656c 662e 6973  s_direct=self.is
+00006450: 5f64 6972 6563 742c 0a20 2020 2020 2020  _direct,.       
+00006460: 2020 2020 2069 6e69 7469 616c 5f73 7461       initial_sta
+00006470: 7465 3d69 6e69 7469 616c 5f73 7461 7465  te=initial_state
+00006480: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00006490: 7669 7465 6573 3d69 6e76 6974 6573 2c0a  vitees=invites,.
+000064a0: 2020 2020 2020 2020 2020 2020 6372 6561              crea
+000064b0: 7469 6f6e 5f63 6f6e 7465 6e74 3d63 7265  tion_content=cre
+000064c0: 6174 696f 6e5f 636f 6e74 656e 742c 0a20  ation_content,. 
+000064d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000064e0: 2069 6620 6e6f 7420 7365 6c66 2e6d 7869   if not self.mxi
+000064f0: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00006500: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+00006510: 4661 696c 6564 2074 6f20 6372 6561 7465  Failed to create
+00006520: 2072 6f6f 6d3a 206e 6f20 6d78 6964 2072   room: no mxid r
+00006530: 6574 7572 6e65 6422 290a 2020 2020 2020  eturned").      
+00006540: 2020 7365 6c66 2e6e 616d 655f 7365 7420    self.name_set 
+00006550: 3d20 626f 6f6c 286e 616d 6529 0a20 2020  = bool(name).   
+00006560: 2020 2020 2073 656c 662e 6176 6174 6172       self.avatar
+00006570: 5f73 6574 203d 2062 6f6f 6c28 7365 6c66  _set = bool(self
+00006580: 2e61 7661 7461 725f 7572 6c29 2061 6e64  .avatar_url) and
+00006590: 2073 656c 662e 7365 745f 646d 5f72 6f6f   self.set_dm_roo
+000065a0: 6d5f 6d65 7461 6461 7461 0a0a 2020 2020  m_metadata..    
+000065b0: 2020 2020 6966 2073 656c 662e 656e 6372      if self.encr
+000065c0: 7970 7465 6420 616e 6420 7365 6c66 2e6d  ypted and self.m
+000065d0: 6174 7269 782e 6532 6565 2061 6e64 2073  atrix.e2ee and s
+000065e0: 656c 662e 6973 5f64 6972 6563 743a 0a20  elf.is_direct:. 
+000065f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00006600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006610: 6177 6169 7420 7365 6c66 2e61 7a2e 696e  await self.az.in
+00006620: 7465 6e74 2e65 6e73 7572 655f 6a6f 696e  tent.ensure_join
+00006630: 6564 2873 656c 662e 6d78 6964 290a 2020  ed(self.mxid).  
+00006640: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00006650: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00006660: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006670: 2e6c 6f67 2e77 6172 6e69 6e67 2866 2246  .log.warning(f"F
+00006680: 6169 6c65 6420 746f 2061 6464 2062 7269  ailed to add bri
+00006690: 6467 6520 626f 7420 746f 206e 6577 2070  dge bot to new p
+000066a0: 7269 7661 7465 2063 6861 7420 7b73 656c  rivate chat {sel
+000066b0: 662e 6d78 6964 7d22 290a 2020 2020 2020  f.mxid}").      
+000066c0: 2020 6177 6169 7420 7365 6c66 2e73 6176    await self.sav
+000066d0: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
+000066e0: 2e6c 6f67 2e64 6562 7567 2866 224d 6174  .log.debug(f"Mat
+000066f0: 7269 7820 726f 6f6d 2063 7265 6174 6564  rix room created
+00006700: 3a20 7b73 656c 662e 6d78 6964 7d22 290a  : {self.mxid}").
+00006710: 2020 2020 2020 2020 7365 6c66 2e62 795f          self.by_
+00006720: 6d78 6964 5b73 656c 662e 6d78 6964 5d20  mxid[self.mxid] 
+00006730: 3d20 7365 6c66 0a0a 2020 2020 2020 2020  = self..        
+00006740: 7075 7070 6574 203d 2061 7761 6974 2070  puppet = await p
+00006750: 2e50 7570 7065 742e 6765 745f 6279 5f63  .Puppet.get_by_c
+00006760: 7573 746f 6d5f 6d78 6964 2873 6f75 7263  ustom_mxid(sourc
+00006770: 652e 6d78 6964 290a 2020 2020 2020 2020  e.mxid).        
+00006780: 6177 6169 7420 7365 6c66 2e6d 6169 6e5f  await self.main_
+00006790: 696e 7465 6e74 2e69 6e76 6974 655f 7573  intent.invite_us
+000067a0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000067b0: 7365 6c66 2e6d 7869 642c 2073 6f75 7263  self.mxid, sourc
+000067c0: 652e 6d78 6964 2c20 6578 7472 615f 636f  e.mxid, extra_co
+000067d0: 6e74 656e 743d 7365 6c66 2e5f 6765 745f  ntent=self._get_
+000067e0: 696e 7669 7465 5f63 6f6e 7465 6e74 2870  invite_content(p
+000067f0: 7570 7065 7429 0a20 2020 2020 2020 2029  uppet).        )
+00006800: 0a20 2020 2020 2020 2069 6620 7075 7070  .        if pupp
+00006810: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00006820: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00006830: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+00006840: 6469 7265 6374 3a0a 2020 2020 2020 2020  direct:.        
+00006850: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00006860: 7420 736f 7572 6365 2e75 7064 6174 655f  t source.update_
+00006870: 6469 7265 6374 5f63 6861 7473 287b 7365  direct_chats({se
+00006880: 6c66 2e6d 6169 6e5f 696e 7465 6e74 2e6d  lf.main_intent.m
+00006890: 7869 643a 205b 7365 6c66 2e6d 7869 645d  xid: [self.mxid]
+000068a0: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+000068b0: 2020 2061 7761 6974 2070 7570 7065 742e     await puppet.
+000068c0: 696e 7465 6e74 2e6a 6f69 6e5f 726f 6f6d  intent.join_room
+000068d0: 5f62 795f 6964 2873 656c 662e 6d78 6964  _by_id(self.mxid
+000068e0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+000068f0: 6365 7074 204d 6174 7269 7845 7272 6f72  cept MatrixError
+00006900: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006910: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
+00006920: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006930: 2020 2020 2020 2246 6169 6c65 6420 746f        "Failed to
+00006940: 206a 6f69 6e20 6375 7374 6f6d 2070 7570   join custom pup
+00006950: 7065 7420 696e 746f 206e 6577 6c79 2063  pet into newly c
+00006960: 7265 6174 6564 2070 6f72 7461 6c22 2c0a  reated portal",.
+00006970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006980: 2020 2020 6578 635f 696e 666f 3d54 7275      exc_info=Tru
+00006990: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000069a0: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
+000069b0: 206e 6f74 2073 656c 662e 6973 5f64 6972   not self.is_dir
+000069c0: 6563 743a 0a20 2020 2020 2020 2020 2020  ect:.           
+000069d0: 2061 7761 6974 2073 656c 662e 5f75 7064   await self._upd
+000069e0: 6174 655f 7061 7274 6963 6970 616e 7473  ate_participants
+000069f0: 2873 6f75 7263 652c 2069 6e66 6f29 0a0a  (source, info)..
+00006a00: 2020 2020 2020 2020 6177 6169 7420 5573          await Us
+00006a10: 6572 506f 7274 616c 280a 2020 2020 2020  erPortal(.      
+00006a20: 2020 2020 2020 7573 6572 3d73 6f75 7263        user=sourc
+00006a30: 652e 6662 6964 2c0a 2020 2020 2020 2020  e.fbid,.        
+00006a40: 2020 2020 706f 7274 616c 3d73 656c 662e      portal=self.
+00006a50: 6662 6964 2c0a 2020 2020 2020 2020 2020  fbid,.          
+00006a60: 2020 706f 7274 616c 5f72 6563 6569 7665    portal_receive
+00006a70: 723d 7365 6c66 2e66 625f 7265 6365 6976  r=self.fb_receiv
+00006a80: 6572 2c0a 2020 2020 2020 2020 292e 7570  er,.        ).up
+00006a90: 7365 7274 2829 0a0a 2020 2020 2020 2020  sert()..        
+00006aa0: 7365 6c66 2e6c 6f67 2e74 7261 6365 2822  self.log.trace("
+00006ab0: 5365 6e64 696e 6720 706f 7274 616c 2070  Sending portal p
+00006ac0: 6f73 742d 6372 6561 7465 2064 756d 6d79  ost-create dummy
+00006ad0: 2065 7665 6e74 2229 0a20 2020 2020 2020   event").       
+00006ae0: 2073 656c 662e 6669 7273 745f 6576 656e   self.first_even
+00006af0: 745f 6964 203d 2061 7761 6974 2073 656c  t_id = await sel
+00006b00: 662e 6d61 696e 5f69 6e74 656e 742e 7365  f.main_intent.se
+00006b10: 6e64 5f6d 6573 7361 6765 5f65 7665 6e74  nd_message_event
+00006b20: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00006b30: 6c66 2e6d 7869 642c 2050 6f72 7461 6c43  lf.mxid, PortalC
+00006b40: 7265 6174 6544 756d 6d79 2c20 7b7d 0a20  reateDummy, {}. 
+00006b50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006b60: 2061 7761 6974 2073 656c 662e 7361 7665   await self.save
+00006b70: 2829 0a0a 2020 2020 2020 2020 6177 6169  ()..        awai
+00006b80: 7420 7365 6c66 2e5f 7379 6e63 5f72 6561  t self._sync_rea
+00006b90: 645f 7265 6365 6970 7473 2869 6e66 6f2e  d_receipts(info.
+00006ba0: 7265 6164 5f72 6563 6569 7074 732e 6e6f  read_receipts.no
+00006bb0: 6465 732c 2072 6561 6374 696f 6e73 3d54  des, reactions=T
+00006bc0: 7275 6529 0a20 2020 2020 2020 2072 6574  rue).        ret
+00006bd0: 7572 6e20 7365 6c66 2e6d 7869 640a 0a20  urn self.mxid.. 
+00006be0: 2020 2023 2065 6e64 7265 6769 6f6e 0a20     # endregion. 
+00006bf0: 2020 2023 2072 6567 696f 6e20 4261 636b     # region Back
+00006c00: 6669 6c6c 0a0a 2020 2020 6173 796e 6320  fill..    async 
+00006c10: 6465 6620 656e 7175 6575 655f 696d 6d65  def enqueue_imme
+00006c20: 6469 6174 655f 6261 636b 6669 6c6c 2873  diate_backfill(s
+00006c30: 656c 662c 2073 6f75 7263 653a 2075 2e55  elf, source: u.U
+00006c40: 7365 722c 2070 7269 6f72 6974 793a 2069  ser, priority: i
+00006c50: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
+00006c60: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+00006c70: 2e63 6f6e 6669 675b 2262 7269 6467 652e  .config["bridge.
+00006c80: 6261 636b 6669 6c6c 2e6d 7363 3237 3136  backfill.msc2716
+00006c90: 225d 0a20 2020 2020 2020 2069 6620 6e6f  "].        if no
+00006ca0: 7420 6177 6169 7420 4261 636b 6669 6c6c  t await Backfill
+00006cb0: 2e67 6574 2873 6f75 7263 652e 6d78 6964  .get(source.mxid
+00006cc0: 2c20 7365 6c66 2e66 6269 642c 2073 656c  , self.fbid, sel
+00006cd0: 662e 6662 5f72 6563 6569 7665 7229 3a0a  f.fb_receiver):.
+00006ce0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00006cf0: 7420 4261 636b 6669 6c6c 2e6e 6577 280a  t Backfill.new(.
+00006d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d10: 736f 7572 6365 2e6d 7869 642c 0a20 2020  source.mxid,.   
+00006d20: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00006d30: 6f72 6974 792c 0a20 2020 2020 2020 2020  ority,.         
+00006d40: 2020 2020 2020 2073 656c 662e 6662 6964         self.fbid
+00006d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006d60: 2020 7365 6c66 2e66 625f 7265 6365 6976    self.fb_receiv
+00006d70: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00006d80: 2020 2020 7365 6c66 2e63 6f6e 6669 675b      self.config[
+00006d90: 2262 7269 6467 652e 6261 636b 6669 6c6c  "bridge.backfill
+00006da0: 2e69 6e63 7265 6d65 6e74 616c 2e6d 6178  .incremental.max
+00006db0: 5f70 6167 6573 225d 2c0a 2020 2020 2020  _pages"],.      
+00006dc0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00006dd0: 6f6e 6669 675b 2262 7269 6467 652e 6261  onfig["bridge.ba
+00006de0: 636b 6669 6c6c 2e69 6e63 7265 6d65 6e74  ckfill.increment
+00006df0: 616c 2e70 6167 655f 6465 6c61 7922 5d2c  al.page_delay"],
+00006e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006e10: 2073 656c 662e 636f 6e66 6967 5b22 6272   self.config["br
+00006e20: 6964 6765 2e62 6163 6b66 696c 6c2e 696e  idge.backfill.in
+00006e30: 6372 656d 656e 7461 6c2e 706f 7374 5f62  cremental.post_b
+00006e40: 6174 6368 5f64 656c 6179 225d 2c0a 2020  atch_delay"],.  
+00006e50: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00006e60: 6c66 2e63 6f6e 6669 675b 2262 7269 6467  lf.config["bridg
+00006e70: 652e 6261 636b 6669 6c6c 2e69 6e63 7265  e.backfill.incre
+00006e80: 6d65 6e74 616c 2e6d 6178 5f74 6f74 616c  mental.max_total
+00006e90: 5f70 6167 6573 225d 2c0a 2020 2020 2020  _pages"],.      
+00006ea0: 2020 2020 2020 292e 696e 7365 7274 2829        ).insert()
+00006eb0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00006ec0: 6261 636b 6669 6c6c 2873 656c 662c 2073  backfill(self, s
+00006ed0: 6f75 7263 653a 2075 2e55 7365 722c 2062  ource: u.User, b
+00006ee0: 6163 6b66 696c 6c5f 7265 7175 6573 743a  ackfill_request:
+00006ef0: 2042 6163 6b66 696c 6c29 202d 3e20 4e6f   Backfill) -> No
+00006f00: 6e65 3a0a 2020 2020 2020 2020 7472 793a  ne:.        try:
+00006f10: 0a20 2020 2020 2020 2020 2020 206c 6173  .            las
+00006f20: 745f 6d65 7373 6167 655f 7469 6d65 7374  t_message_timest
+00006f30: 616d 7020 3d20 6177 6169 7420 7365 6c66  amp = await self
+00006f40: 2e5f 6261 636b 6669 6c6c 2873 6f75 7263  ._backfill(sourc
+00006f50: 652c 2062 6163 6b66 696c 6c5f 7265 7175  e, backfill_requ
+00006f60: 6573 7429 0a20 2020 2020 2020 2020 2020  est).           
+00006f70: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+00006f80: 2020 2020 2020 6c61 7374 5f6d 6573 7361        last_messa
+00006f90: 6765 5f74 696d 6573 7461 6d70 2069 7320  ge_timestamp is 
+00006fa0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
+00006fb0: 2020 2020 2020 2020 2061 6e64 206e 6f74           and not
+00006fc0: 2073 656c 662e 6272 6964 6765 2e68 6f6d   self.bridge.hom
+00006fd0: 6573 6572 7665 725f 736f 6674 7761 7265  eserver_software
+00006fe0: 2e69 735f 6875 6e67 7279 0a20 2020 2020  .is_hungry.     
+00006ff0: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
+00007000: 656c 662e 636f 6e66 6967 5b22 6272 6964  elf.config["brid
+00007010: 6765 2e62 6163 6b66 696c 6c2e 6d73 6332  ge.backfill.msc2
+00007020: 3731 3622 5d0a 2020 2020 2020 2020 2020  716"].          
+00007030: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00007040: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00007050: 7365 6e64 5f70 6f73 745f 6261 636b 6669  send_post_backfi
+00007060: 6c6c 5f64 756d 6d79 286c 6173 745f 6d65  ll_dummy(last_me
+00007070: 7373 6167 655f 7469 6d65 7374 616d 7029  ssage_timestamp)
+00007080: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+00007090: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000070a0: 416c 7761 7973 2073 6c65 6570 2061 6674  Always sleep aft
+000070b0: 6572 2074 6865 2062 6163 6b66 696c 6c20  er the backfill 
+000070c0: 7265 7175 6573 7420 6973 2066 696e 6973  request is finis
+000070d0: 6865 6420 7072 6f63 6573 7369 6e67 2c20  hed processing, 
+000070e0: 6576 656e 2069 6620 6974 2065 7272 6f72  even if it error
+000070f0: 732e 0a20 2020 2020 2020 2020 2020 2061  s..            a
+00007100: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+00007110: 6570 2862 6163 6b66 696c 6c5f 7265 7175  ep(backfill_requ
+00007120: 6573 742e 706f 7374 5f62 6174 6368 5f64  est.post_batch_d
+00007130: 656c 6179 290a 0a20 2020 2061 7379 6e63  elay)..    async
+00007140: 2064 6566 205f 6261 636b 6669 6c6c 2873   def _backfill(s
+00007150: 656c 662c 2073 6f75 7263 653a 2075 2e55  elf, source: u.U
+00007160: 7365 722c 2062 6163 6b66 696c 6c5f 7265  ser, backfill_re
+00007170: 7175 6573 743a 2042 6163 6b66 696c 6c29  quest: Backfill)
+00007180: 202d 3e20 696e 7420 7c20 4e6f 6e65 3a0a   -> int | None:.
+00007190: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+000071a0: 6f75 7263 652e 636c 6965 6e74 0a20 2020  ource.client.   
+000071b0: 2020 2020 2073 656c 662e 6c6f 672e 6465       self.log.de
+000071c0: 6275 6728 2242 6163 6b66 696c 6c20 7265  bug("Backfill re
+000071d0: 7175 6573 743a 2025 7322 2c20 6261 636b  quest: %s", back
+000071e0: 6669 6c6c 5f72 6571 7565 7374 290a 0a20  fill_request).. 
+000071f0: 2020 2020 2020 206e 756d 5f70 6167 6573         num_pages
+00007200: 203d 2062 6163 6b66 696c 6c5f 7265 7175   = backfill_requ
+00007210: 6573 742e 6e75 6d5f 7061 6765 730a 2020  est.num_pages.  
+00007220: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
+00007230: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00007240: 2020 2242 6163 6b66 696c 6c69 6e67 2075    "Backfilling u
+00007250: 7020 746f 2025 6420 7061 6765 7320 6f66  p to %d pages of
+00007260: 2068 6973 746f 7279 2069 6e20 2573 2074   history in %s t
+00007270: 6872 6f75 6768 2025 7322 2c0a 2020 2020  hrough %s",.    
+00007280: 2020 2020 2020 2020 6e75 6d5f 7061 6765          num_page
+00007290: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+000072a0: 656c 662e 6d78 6964 2c0a 2020 2020 2020  elf.mxid,.      
+000072b0: 2020 2020 2020 736f 7572 6365 2e6d 7869        source.mxi
+000072c0: 642c 0a20 2020 2020 2020 2029 0a0a 2020  d,.        )..  
+000072d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000072e0: 2020 2020 2020 2069 6620 6669 7273 745f         if first_
+000072f0: 6d65 7373 6167 6520 3a3d 2061 7761 6974  message := await
+00007300: 2044 424d 6573 7361 6765 2e67 6574 5f66   DBMessage.get_f
+00007310: 6972 7374 5f69 6e5f 6368 6174 2873 656c  irst_in_chat(sel
+00007320: 662e 6662 6964 2c20 7365 6c66 2e66 625f  f.fbid, self.fb_
+00007330: 7265 6365 6976 6572 293a 0a20 2020 2020  receiver):.     
+00007340: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007350: 6c6f 672e 6465 6275 6728 2254 6865 7265  log.debug("There
+00007360: 2069 7320 6120 6669 7273 7420 6d65 7373   is a first mess
+00007370: 6167 6520 696e 2074 6865 2063 6861 742c  age in the chat,
+00007380: 2066 6574 6368 696e 6720 6d65 7373 6167   fetching messag
+00007390: 6573 2062 6566 6f72 6520 6974 2229 0a20  es before it"). 
+000073a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000073b0: 6573 7020 3d20 6177 6169 7420 736f 7572  esp = await sour
+000073c0: 6365 2e63 6c69 656e 742e 6665 7463 685f  ce.client.fetch_
+000073d0: 6d65 7373 6167 6573 2873 656c 662e 6662  messages(self.fb
+000073e0: 6964 2c20 6669 7273 745f 6d65 7373 6167  id, first_messag
+000073f0: 652e 7469 6d65 7374 616d 7020 2d20 3129  e.timestamp - 1)
+00007400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007410: 206d 6573 7361 6765 7320 3d20 7265 7370   messages = resp
+00007420: 2e6e 6f64 6573 0a20 2020 2020 2020 2020  .nodes.         
+00007430: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00007440: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00007450: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00007460: 2020 2020 2020 2020 2020 2020 2022 5468               "Th
+00007470: 6572 6520 6973 206e 6f20 6669 7273 7420  ere is no first 
+00007480: 6d65 7373 6167 6520 696e 2074 6865 2063  message in the c
+00007490: 6861 742c 2073 7461 7274 696e 6720 7769  hat, starting wi
+000074a0: 7468 2074 6865 206d 6f73 7420 7265 6365  th the most rece
+000074b0: 6e74 206d 6573 7361 6765 7322 0a20 2020  nt messages".   
+000074c0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000074d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000074e0: 6573 7020 3d20 6177 6169 7420 736f 7572  esp = await sour
+000074f0: 6365 2e63 6c69 656e 742e 6665 7463 685f  ce.client.fetch_
+00007500: 6d65 7373 6167 6573 2873 656c 662e 6662  messages(self.fb
+00007510: 6964 2c20 696e 7428 7469 6d65 2e74 696d  id, int(time.tim
+00007520: 6528 2920 2a20 3130 3030 2929 0a20 2020  e() * 1000)).   
+00007530: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+00007540: 7361 6765 7320 3d20 7265 7370 2e6e 6f64  sages = resp.nod
+00007550: 6573 0a20 2020 2020 2020 2065 7863 6570  es.        excep
+00007560: 7420 5261 7465 4c69 6d69 7445 7863 6565  t RateLimitExcee
+00007570: 6465 643a 0a20 2020 2020 2020 2020 2020  ded:.           
+00007580: 2062 6163 6b6f 6666 203d 2073 656c 662e   backoff = self.
+00007590: 636f 6e66 6967 2e67 6574 2822 6272 6964  config.get("brid
+000075a0: 6765 2e62 6163 6b66 696c 6c2e 6261 636b  ge.backfill.back
+000075b0: 6f66 662e 6d65 7373 6167 655f 6869 7374  off.message_hist
+000075c0: 6f72 7922 2c20 3330 3029 0a20 2020 2020  ory", 300).     
+000075d0: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+000075e0: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+000075f0: 2020 2020 2020 2020 2066 2242 6163 6b66           f"Backf
+00007600: 696c 6c69 6e67 2066 6169 6c65 6420 6475  illing failed du
+00007610: 6520 746f 2072 6174 6520 6c69 6d69 742e  e to rate limit.
+00007620: 2057 6169 7469 6e67 2066 6f72 207b 6261   Waiting for {ba
+00007630: 636b 6f66 667d 2073 6563 6f6e 6473 2062  ckoff} seconds b
+00007640: 6566 6f72 6520 220a 2020 2020 2020 2020  efore ".        
+00007650: 2020 2020 2020 2020 2272 6573 756d 696e          "resumin
+00007660: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
+00007670: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
+00007680: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
+00007690: 7028 6261 636b 6f66 6629 0a20 2020 2020  p(backoff).     
+000076a0: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+000076b0: 2020 2020 2020 6966 206c 656e 286d 6573        if len(mes
+000076c0: 7361 6765 7329 203d 3d20 303a 0a20 2020  sages) == 0:.   
+000076d0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+000076e0: 672e 6465 6275 6728 224e 6f20 6d65 7373  g.debug("No mess
+000076f0: 6167 6573 2074 6f20 6261 636b 6669 6c6c  ages to backfill
+00007700: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00007710: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+00007720: 2020 2020 206c 6173 745f 6d65 7373 6167       last_messag
+00007730: 655f 7469 6d65 7374 616d 7020 3d20 6d65  e_timestamp = me
+00007740: 7373 6167 6573 5b2d 315d 2e74 696d 6573  ssages[-1].times
+00007750: 7461 6d70 0a0a 2020 2020 2020 2020 7061  tamp..        pa
+00007760: 6765 735f 746f 5f62 6163 6b66 696c 6c20  ges_to_backfill 
+00007770: 3d20 6261 636b 6669 6c6c 5f72 6571 7565  = backfill_reque
+00007780: 7374 2e6e 756d 5f70 6167 6573 0a20 2020  st.num_pages.   
+00007790: 2020 2020 2069 6620 6261 636b 6669 6c6c       if backfill
+000077a0: 5f72 6571 7565 7374 2e6d 6178 5f74 6f74  _request.max_tot
+000077b0: 616c 5f70 6167 6573 203e 202d 313a 0a20  al_pages > -1:. 
+000077c0: 2020 2020 2020 2020 2020 2070 6167 6573             pages
+000077d0: 5f74 6f5f 6261 636b 6669 6c6c 203d 206d  _to_backfill = m
+000077e0: 696e 2870 6167 6573 5f74 6f5f 6261 636b  in(pages_to_back
+000077f0: 6669 6c6c 2c20 6261 636b 6669 6c6c 5f72  fill, backfill_r
+00007800: 6571 7565 7374 2e6d 6178 5f74 6f74 616c  equest.max_total
+00007810: 5f70 6167 6573 290a 0a20 2020 2020 2020  _pages)..       
+00007820: 2062 6163 6b66 696c 6c5f 6d6f 7265 203d   backfill_more =
+00007830: 2054 7275 650a 2020 2020 2020 2020 7061   True.        pa
+00007840: 6765 735f 6261 636b 6669 6c6c 6564 203d  ges_backfilled =
+00007850: 2030 0a20 2020 2020 2020 2066 6f72 2069   0.        for i
+00007860: 2069 6e20 7261 6e67 6528 7061 6765 735f   in range(pages_
+00007870: 746f 5f62 6163 6b66 696c 6c29 3a0a 2020  to_backfill):.  
+00007880: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+00007890: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+000078a0: 6272 6964 6765 642c 0a20 2020 2020 2020  bridged,.       
+000078b0: 2020 2020 2020 2020 206f 6c64 6573 745f           oldest_
+000078c0: 6272 6964 6765 645f 6d73 675f 7473 2c0a  bridged_msg_ts,.
+000078d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078e0: 6261 7365 5f69 6e73 6572 7469 6f6e 5f65  base_insertion_e
+000078f0: 7665 6e74 5f69 642c 0a20 2020 2020 2020  vent_id,.       
+00007900: 2020 2020 2029 203d 2061 7761 6974 2073       ) = await s
+00007910: 656c 662e 6261 636b 6669 6c6c 5f6d 6573  elf.backfill_mes
+00007920: 7361 6765 5f70 6167 6528 736f 7572 6365  sage_page(source
+00007930: 2c20 6d65 7373 6167 6573 290a 2020 2020  , messages).    
+00007940: 2020 2020 2020 2020 7061 6765 735f 6261          pages_ba
+00007950: 636b 6669 6c6c 6564 202b 3d20 310a 0a20  ckfilled += 1.. 
+00007960: 2020 2020 2020 2020 2020 2069 6620 6261             if ba
+00007970: 7365 5f69 6e73 6572 7469 6f6e 5f65 7665  se_insertion_eve
+00007980: 6e74 5f69 643a 0a20 2020 2020 2020 2020  nt_id:.         
+00007990: 2020 2020 2020 2073 656c 662e 6869 7374         self.hist
+000079a0: 6f72 6963 616c 5f62 6173 655f 696e 7365  orical_base_inse
+000079b0: 7274 696f 6e5f 6576 656e 745f 6964 203d  rtion_event_id =
+000079c0: 2062 6173 655f 696e 7365 7274 696f 6e5f   base_insertion_
+000079d0: 6576 656e 745f 6964 0a20 2020 2020 2020  event_id.       
+000079e0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+000079f0: 656c 662e 7361 7665 2829 0a0a 2020 2020  elf.save()..    
+00007a00: 2020 2020 2020 2020 2320 4966 206e 6f74          # If not
+00007a10: 6869 6e67 2077 6173 2062 7269 6467 6564  hing was bridged
+00007a20: 2c20 7468 656e 2077 6520 7761 6e74 2074  , then we want t
+00007a30: 6f20 6368 6563 6b20 616e 6420 7365 6520  o check and see 
+00007a40: 6966 2074 6865 7265 2061 7265 206d 6573  if there are mes
+00007a50: 7361 6765 7320 6265 666f 7265 0a20 2020  sages before.   
+00007a60: 2020 2020 2020 2020 2023 2074 6869 7320           # this 
+00007a70: 7061 6765 2c20 6f72 2069 6620 7468 6520  page, or if the 
+00007a80: 6f6e 6c79 2074 6869 6e67 206c 6566 7420  only thing left 
+00007a90: 696e 2074 6865 2063 6861 7420 6973 2075  in the chat is u
+00007aa0: 6e62 7269 6467 6162 6c65 206d 6573 7361  nbridgable messa
+00007ab0: 6765 732e 0a20 2020 2020 2020 2020 2020  ges..           
+00007ac0: 2069 6620 6e75 6d5f 6272 6964 6765 6420   if num_bridged 
+00007ad0: 3d3d 2030 206f 7220 6920 3c20 7061 6765  == 0 or i < page
+00007ae0: 735f 746f 5f62 6163 6b66 696c 6c20 2d20  s_to_backfill - 
+00007af0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00007b00: 2020 2023 2053 6c65 6570 2062 6566 6f72     # Sleep befor
+00007b10: 6520 6665 7463 6869 6e67 2061 6e6f 7468  e fetching anoth
+00007b20: 6572 2070 6167 6520 6f66 206d 6573 7361  er page of messa
+00007b30: 6765 732e 0a20 2020 2020 2020 2020 2020  ges..           
+00007b40: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00007b50: 696f 2e73 6c65 6570 2862 6163 6b66 696c  io.sleep(backfil
+00007b60: 6c5f 7265 7175 6573 742e 7061 6765 5f64  l_request.page_d
+00007b70: 656c 6179 290a 0a20 2020 2020 2020 2020  elay)..         
+00007b80: 2020 2020 2020 2023 2046 6574 6368 206d         # Fetch m
+00007b90: 6f72 6520 6d65 7373 6167 6573 0a20 2020  ore messages.   
+00007ba0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00007bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007bc0: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
+00007bd0: 6974 2073 6f75 7263 652e 636c 6965 6e74  it source.client
+00007be0: 2e66 6574 6368 5f6d 6573 7361 6765 7328  .fetch_messages(
+00007bf0: 7365 6c66 2e66 6269 642c 206f 6c64 6573  self.fbid, oldes
+00007c00: 745f 6272 6964 6765 645f 6d73 675f 7473  t_bridged_msg_ts
+00007c10: 202d 2031 290a 2020 2020 2020 2020 2020   - 1).          
+00007c20: 2020 2020 2020 6578 6365 7074 2052 6174        except Rat
+00007c30: 654c 696d 6974 4578 6365 6564 6564 3a0a  eLimitExceeded:.
+00007c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c50: 2020 2020 6261 636b 6f66 6620 3d20 7365      backoff = se
+00007c60: 6c66 2e63 6f6e 6669 672e 6765 7428 2262  lf.config.get("b
+00007c70: 7269 6467 652e 6261 636b 6669 6c6c 2e62  ridge.backfill.b
+00007c80: 6163 6b6f 6666 2e6d 6573 7361 6765 5f68  ackoff.message_h
+00007c90: 6973 746f 7279 222c 2033 3030 290a 2020  istory", 300).  
+00007ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cb0: 2020 7365 6c66 2e6c 6f67 2e77 6172 6e69    self.log.warni
+00007cc0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00007cd0: 2020 2020 2020 2020 2020 2020 6622 4261              f"Ba
+00007ce0: 636b 6669 6c6c 696e 6720 6661 696c 6564  ckfilling failed
+00007cf0: 2064 7565 2074 6f20 7261 7465 206c 696d   due to rate lim
+00007d00: 6974 2e20 5761 6974 696e 6720 666f 7220  it. Waiting for 
+00007d10: 7b62 6163 6b6f 6666 7d20 7365 636f 6e64  {backoff} second
+00007d20: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
+00007d30: 2020 2020 2020 2020 2020 2020 2262 6566              "bef
+00007d40: 6f72 6520 7265 7375 6d69 6e67 2e22 0a20  ore resuming.". 
+00007d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d60: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007d70: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00007d80: 7379 6e63 696f 2e73 6c65 6570 2862 6163  syncio.sleep(bac
+00007d90: 6b6f 6666 290a 0a20 2020 2020 2020 2020  koff)..         
+00007da0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00007db0: 7765 2068 6974 2074 6865 2072 6174 6520  we hit the rate 
+00007dc0: 6c69 6d69 742c 2074 6865 6e20 7765 2077  limit, then we w
+00007dd0: 696c 6c20 7761 6e74 2074 6f20 6769 7665  ill want to give
+00007de0: 2075 7020 666f 7220 6e6f 772c 2062 7574   up for now, but
+00007df0: 2065 6e71 7565 7565 0a20 2020 2020 2020   enqueue.       
+00007e00: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+00007e10: 6464 6974 696f 6e61 6c20 6261 636b 6669  dditional backfi
+00007e20: 6c6c 2074 6f20 646f 206c 6174 6572 2e0a  ll to do later..
+00007e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e40: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+00007e50: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00007e60: 7420 7265 7370 2e6e 6f64 6573 3a0a 2020  t resp.nodes:.  
+00007e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e80: 2020 2320 5468 6572 6520 7765 7265 206e    # There were n
+00007e90: 6f20 6d6f 7265 206d 6573 7361 6765 732c  o more messages,
+00007ea0: 2077 6520 6172 6520 6174 2074 6865 2062   we are at the b
+00007eb0: 6567 696e 6e69 6e67 206f 6620 6869 7374  eginning of hist
+00007ec0: 6f72 792c 2073 6f20 6a75 7374 0a20 2020  ory, so just.   
+00007ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ee0: 2023 2062 7265 616b 2e0a 2020 2020 2020   # break..      
+00007ef0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00007f00: 636b 6669 6c6c 5f6d 6f72 6520 3d20 4661  ckfill_more = Fa
+00007f10: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00007f20: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00007f30: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00007f40: 7373 6167 6573 203d 2072 6573 702e 6e6f  ssages = resp.no
+00007f50: 6465 730a 0a20 2020 2020 2020 2069 6620  des..        if 
+00007f60: 6261 636b 6669 6c6c 5f72 6571 7565 7374  backfill_request
+00007f70: 2e6d 6178 5f74 6f74 616c 5f70 6167 6573  .max_total_pages
+00007f80: 203d 3d20 2d31 3a0a 2020 2020 2020 2020   == -1:.        
+00007f90: 2020 2020 6e65 775f 6d61 785f 746f 7461      new_max_tota
+00007fa0: 6c5f 7061 6765 7320 3d20 2d31 0a20 2020  l_pages = -1.   
+00007fb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007fc0: 2020 2020 2020 206e 6577 5f6d 6178 5f74         new_max_t
+00007fd0: 6f74 616c 5f70 6167 6573 203d 2062 6163  otal_pages = bac
+00007fe0: 6b66 696c 6c5f 7265 7175 6573 742e 6d61  kfill_request.ma
+00007ff0: 785f 746f 7461 6c5f 7061 6765 7320 2d20  x_total_pages - 
+00008000: 7061 6765 735f 6261 636b 6669 6c6c 6564  pages_backfilled
+00008010: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008020: 6e65 775f 6d61 785f 746f 7461 6c5f 7061  new_max_total_pa
+00008030: 6765 7320 3c3d 2030 3a0a 2020 2020 2020  ges <= 0:.      
+00008040: 2020 2020 2020 2020 2020 6261 636b 6669            backfi
+00008050: 6c6c 5f6d 6f72 6520 3d20 4661 6c73 650a  ll_more = False.
+00008060: 0a20 2020 2020 2020 2069 6620 6261 636b  .        if back
+00008070: 6669 6c6c 5f6d 6f72 653a 0a20 2020 2020  fill_more:.     
+00008080: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+00008090: 6465 6275 6728 2245 6e71 7565 7565 696e  debug("Enqueuein
+000080a0: 6720 6d6f 7265 2062 6163 6b66 696c 6c22  g more backfill"
+000080b0: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
+000080c0: 6169 7420 4261 636b 6669 6c6c 2e6e 6577  ait Backfill.new
+000080d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000080e0: 2020 736f 7572 6365 2e6d 7869 642c 0a20    source.mxid,. 
+000080f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00008100: 2041 6c77 6179 7320 656e 7175 6575 6520   Always enqueue 
+00008110: 7375 6273 6571 7565 6e74 2062 6163 6b66  subsequent backf
+00008120: 696c 6c73 2061 7420 7468 6520 6c6f 7765  ills at the lowe
+00008130: 7374 2070 7269 6f72 6974 790a 2020 2020  st priority.    
+00008140: 2020 2020 2020 2020 2020 2020 322c 0a20              2,. 
+00008150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008160: 656c 662e 6662 6964 2c0a 2020 2020 2020  elf.fbid,.      
+00008170: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00008180: 625f 7265 6365 6976 6572 2c0a 2020 2020  b_receiver,.    
+00008190: 2020 2020 2020 2020 2020 2020 6261 636b              back
+000081a0: 6669 6c6c 5f72 6571 7565 7374 2e6e 756d  fill_request.num
+000081b0: 5f70 6167 6573 2c0a 2020 2020 2020 2020  _pages,.        
+000081c0: 2020 2020 2020 2020 6261 636b 6669 6c6c          backfill
+000081d0: 5f72 6571 7565 7374 2e70 6167 655f 6465  _request.page_de
+000081e0: 6c61 792c 0a20 2020 2020 2020 2020 2020  lay,.           
+000081f0: 2020 2020 2062 6163 6b66 696c 6c5f 7265       backfill_re
+00008200: 7175 6573 742e 706f 7374 5f62 6174 6368  quest.post_batch
+00008210: 5f64 656c 6179 2c0a 2020 2020 2020 2020  _delay,.        
+00008220: 2020 2020 2020 2020 6e65 775f 6d61 785f          new_max_
+00008230: 746f 7461 6c5f 7061 6765 732c 0a20 2020  total_pages,.   
+00008240: 2020 2020 2020 2020 2029 2e69 6e73 6572           ).inser
+00008250: 7428 290a 2020 2020 2020 2020 656c 7365  t().        else
+00008260: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00008270: 6c66 2e6c 6f67 2e64 6562 7567 2822 4e6f  lf.log.debug("No
+00008280: 206d 6f72 6520 6d65 7373 6167 6573 2074   more messages t
+00008290: 6f20 6261 636b 6669 6c6c 2229 0a0a 2020  o backfill")..  
+000082a0: 2020 2020 2020 7265 7475 726e 206c 6173        return las
+000082b0: 745f 6d65 7373 6167 655f 7469 6d65 7374  t_message_timest
+000082c0: 616d 700a 0a20 2020 2061 7379 6e63 2064  amp..    async d
+000082d0: 6566 2062 6163 6b66 696c 6c5f 6d65 7373  ef backfill_mess
+000082e0: 6167 655f 7061 6765 280a 2020 2020 2020  age_page(.      
+000082f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00008300: 736f 7572 6365 3a20 752e 5573 6572 2c0a  source: u.User,.
+00008310: 2020 2020 2020 2020 6d65 7373 6167 655f          message_
+00008320: 7061 6765 3a20 6c69 7374 5b67 7261 7068  page: list[graph
+00008330: 716c 2e4d 6573 7361 6765 5d2c 0a20 2020  ql.Message],.   
+00008340: 2020 2020 2066 6f72 7761 7264 3a20 626f       forward: bo
+00008350: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00008360: 2020 2020 6c61 7374 5f6d 6573 7361 6765      last_message
+00008370: 3a20 4442 4d65 7373 6167 6520 7c20 4e6f  : DBMessage | No
+00008380: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00008390: 2020 206d 6172 6b5f 7265 6164 3a20 626f     mark_read: bo
+000083a0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+000083b0: 2920 2d3e 2074 7570 6c65 5b69 6e74 2c20  ) -> tuple[int, 
+000083c0: 696e 742c 2045 7665 6e74 4944 207c 204e  int, EventID | N
+000083d0: 6f6e 655d 3a0a 2020 2020 2020 2020 2222  one]:.        ""
+000083e0: 220a 2020 2020 2020 2020 4261 636b 6669  ".        Backfi
+000083f0: 6c6c 7320 6120 7061 6765 206f 6620 6d65  lls a page of me
+00008400: 7373 6167 6573 2074 6f20 4d61 7472 6978  ssages to Matrix
+00008410: 2e20 5468 6520 6d65 7373 6167 6573 2073  . The messages s
+00008420: 686f 756c 6420 6265 2069 6e20 6f72 6465  hould be in orde
+00008430: 7220 6672 6f6d 206f 6c64 6573 7420 746f  r from oldest to
+00008440: 0a20 2020 2020 2020 206e 6577 6573 742e  .        newest.
+00008450: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00008460: 733a 2061 2074 7570 6c65 2063 6f6e 7461  s: a tuple conta
+00008470: 696e 696e 6720 7468 6520 6e75 6d62 6572  ining the number
+00008480: 206f 6620 6d65 7373 6167 6573 2074 6861   of messages tha
+00008490: 7420 7765 7265 2061 6374 7561 6c6c 7920  t were actually 
+000084a0: 6272 6964 6765 642c 2074 6865 0a20 2020  bridged, the.   
+000084b0: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
+000084c0: 6d70 206f 6620 7468 6520 6f6c 6465 7374  mp of the oldest
+000084d0: 2062 7269 6467 6564 206d 6573 7361 6765   bridged message
+000084e0: 2061 6e64 2074 6865 2062 6173 6520 696e   and the base in
+000084f0: 7365 7274 696f 6e20 6576 656e 7420 4944  sertion event ID
+00008500: 2069 6620 6974 2065 7869 7374 732e 0a20   if it exists.. 
+00008510: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00008520: 2020 2061 7373 6572 7420 736f 7572 6365     assert source
+00008530: 2e63 6c69 656e 740a 2020 2020 2020 2020  .client.        
+00008540: 6966 206c 656e 286d 6573 7361 6765 5f70  if len(message_p
+00008550: 6167 6529 203d 3d20 303a 0a20 2020 2020  age) == 0:.     
+00008560: 2020 2020 2020 2072 6574 7572 6e20 302c         return 0,
+00008570: 2030 2c20 4e6f 6e65 0a0a 2020 2020 2020   0, None..      
+00008580: 2020 6966 2066 6f72 7761 7264 3a0a 2020    if forward:.  
+00008590: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000085a0: 2028 6c61 7374 5f6d 6573 7361 6765 2061   (last_message a
+000085b0: 6e64 206c 6173 745f 6d65 7373 6167 652e  nd last_message.
+000085c0: 6d78 6964 2920 6f72 2073 656c 662e 6669  mxid) or self.fi
+000085d0: 7273 745f 6576 656e 745f 6964 0a20 2020  rst_event_id.   
+000085e0: 2020 2020 2020 2020 2070 7265 765f 6576           prev_ev
+000085f0: 656e 745f 6964 203d 206c 6173 745f 6d65  ent_id = last_me
+00008600: 7373 6167 652e 6d78 6964 2069 6620 6c61  ssage.mxid if la
+00008610: 7374 5f6d 6573 7361 6765 2065 6c73 6520  st_message else 
+00008620: 7365 6c66 2e66 6972 7374 5f65 7665 6e74  self.first_event
+00008630: 5f69 640a 2020 2020 2020 2020 656c 7365  _id.        else
+00008640: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00008650: 7365 7274 2073 656c 662e 636f 6e66 6967  sert self.config
+00008660: 5b22 6272 6964 6765 2e62 6163 6b66 696c  ["bridge.backfil
+00008670: 6c2e 6d73 6332 3731 3622 5d0a 2020 2020  l.msc2716"].    
+00008680: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00008690: 656c 662e 6669 7273 745f 6576 656e 745f  elf.first_event_
+000086a0: 6964 0a20 2020 2020 2020 2020 2020 2070  id.            p
+000086b0: 7265 765f 6576 656e 745f 6964 203d 2073  rev_event_id = s
+000086c0: 656c 662e 6669 7273 745f 6576 656e 745f  elf.first_event_
+000086d0: 6964 0a0a 2020 2020 2020 2020 6173 7365  id..        asse
+000086e0: 7274 2073 656c 662e 6d78 6964 0a0a 2020  rt self.mxid..  
+000086f0: 2020 2020 2020 6f6c 6465 7374 5f6d 6573        oldest_mes
+00008700: 7361 6765 5f69 6e5f 7061 6765 203d 206d  sage_in_page = m
+00008710: 6573 7361 6765 5f70 6167 655b 305d 0a20  essage_page[0]. 
+00008720: 2020 2020 2020 206f 6c64 6573 745f 6d73         oldest_ms
+00008730: 675f 7469 6d65 7374 616d 7020 3d20 6f6c  g_timestamp = ol
+00008740: 6465 7374 5f6d 6573 7361 6765 5f69 6e5f  dest_message_in_
+00008750: 7061 6765 2e74 696d 6573 7461 6d70 0a0a  page.timestamp..
+00008760: 2020 2020 2020 2020 6261 7463 685f 6d65          batch_me
+00008770: 7373 6167 6573 3a20 6c69 7374 5b42 6174  ssages: list[Bat
+00008780: 6368 5365 6e64 4576 656e 745d 203d 205b  chSendEvent] = [
+00008790: 5d0a 2020 2020 2020 2020 7374 6174 655f  ].        state_
+000087a0: 6576 656e 7473 5f61 745f 7374 6172 743a  events_at_start:
+000087b0: 206c 6973 745b 4261 7463 6853 656e 6453   list[BatchSendS
+000087c0: 7461 7465 4576 656e 745d 203d 205b 5d0a  tateEvent] = [].
+000087d0: 0a20 2020 2020 2020 2061 6464 6564 5f6d  .        added_m
+000087e0: 656d 6265 7273 203d 2073 6574 2829 0a20  embers = set(). 
+000087f0: 2020 2020 2020 2063 7572 7265 6e74 5f6d         current_m
+00008800: 656d 6265 7273 203d 2061 7761 6974 2073  embers = await s
+00008810: 656c 662e 6d61 696e 5f69 6e74 656e 742e  elf.main_intent.
+00008820: 7374 6174 655f 7374 6f72 652e 6765 745f  state_store.get_
+00008830: 6d65 6d62 6572 7328 0a20 2020 2020 2020  members(.       
+00008840: 2020 2020 2073 656c 662e 6d78 6964 2c20       self.mxid, 
+00008850: 6d65 6d62 6572 7368 6970 733d 284d 656d  memberships=(Mem
+00008860: 6265 7273 6869 702e 4a4f 494e 2c29 0a20  bership.JOIN,). 
+00008870: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00008880: 2020 6465 6620 6164 645f 6d65 6d62 6572    def add_member
+00008890: 2870 7570 7065 743a 2070 2e50 7570 7065  (puppet: p.Puppe
+000088a0: 742c 206d 7869 643a 2055 7365 7249 4429  t, mxid: UserID)
+000088b0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000088c0: 7365 7274 2073 656c 662e 6d78 6964 0a20  sert self.mxid. 
+000088d0: 2020 2020 2020 2020 2020 2069 6620 6d78             if mx
+000088e0: 6964 2069 6e20 6164 6465 645f 6d65 6d62  id in added_memb
+000088f0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00008900: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00008910: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+00008920: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00008930: 662e 6272 6964 6765 2e68 6f6d 6573 6572  f.bridge.homeser
+00008940: 7665 725f 736f 6674 7761 7265 2e69 735f  ver_software.is_
+00008950: 6875 6e67 7279 0a20 2020 2020 2020 2020  hungry.         
+00008960: 2020 2020 2020 206f 7220 6e6f 7420 7365         or not se
+00008970: 6c66 2e63 6f6e 6669 675b 2262 7269 6467  lf.config["bridg
+00008980: 652e 6261 636b 6669 6c6c 2e6d 7363 3237  e.backfill.msc27
+00008990: 3136 225d 0a20 2020 2020 2020 2020 2020  16"].           
+000089a0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000089b0: 2020 2020 2320 4875 6e67 7279 7365 7276      # Hungryserv
+000089c0: 2064 6f65 736e 2774 2065 7870 6563 7420   doesn't expect 
+000089d0: 6f72 2063 6865 636b 2073 7461 7465 2065  or check state e
+000089e0: 7665 6e74 7320 6174 2073 7461 7274 2e0a  vents at start..
+000089f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a00: 6164 6465 645f 6d65 6d62 6572 732e 6164  added_members.ad
+00008a10: 6428 6d78 6964 290a 2020 2020 2020 2020  d(mxid).        
+00008a20: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00008a30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00008a40: 656e 745f 6172 6773 203d 207b 2261 7661  ent_args = {"ava
+00008a50: 7461 725f 7572 6c22 3a20 7075 7070 6574  tar_url": puppet
+00008a60: 2e70 686f 746f 5f6d 7863 2c20 2264 6973  .photo_mxc, "dis
+00008a70: 706c 6179 6e61 6d65 223a 2070 7570 7065  playname": puppe
+00008a80: 742e 6e61 6d65 7d0a 2020 2020 2020 2020  t.name}.        
+00008a90: 2020 2020 7374 6174 655f 6576 656e 7473      state_events
+00008aa0: 5f61 745f 7374 6172 742e 6578 7465 6e64  _at_start.extend
+00008ab0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008ac0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00008ad0: 2020 2020 2020 2020 4261 7463 6853 656e          BatchSen
+00008ae0: 6453 7461 7465 4576 656e 7428 0a20 2020  dStateEvent(.   
+00008af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b00: 2020 2020 2063 6f6e 7465 6e74 3d4d 656d       content=Mem
+00008b10: 6265 7253 7461 7465 4576 656e 7443 6f6e  berStateEventCon
+00008b20: 7465 6e74 284d 656d 6265 7273 6869 702e  tent(Membership.
+00008b30: 494e 5649 5445 2c20 2a2a 636f 6e74 656e  INVITE, **conten
+00008b40: 745f 6172 6773 292c 0a20 2020 2020 2020  t_args),.       
+00008b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b60: 2074 7970 653d 4576 656e 7454 7970 652e   type=EventType.
+00008b70: 524f 4f4d 5f4d 454d 4245 522c 0a20 2020  ROOM_MEMBER,.   
+00008b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b90: 2020 2020 2073 656e 6465 723d 7365 6c66       sender=self
+00008ba0: 2e6d 6169 6e5f 696e 7465 6e74 2e6d 7869  .main_intent.mxi
+00008bb0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00008bc0: 2020 2020 2020 2020 2020 2073 7461 7465             state
+00008bd0: 5f6b 6579 3d6d 7869 642c 0a20 2020 2020  _key=mxid,.     
+00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bf0: 2020 2074 696d 6573 7461 6d70 3d6f 6c64     timestamp=old
+00008c00: 6573 745f 6d73 675f 7469 6d65 7374 616d  est_msg_timestam
+00008c10: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+00008c20: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00008c30: 2020 2020 2020 2020 2020 2020 2020 4261                Ba
+00008c40: 7463 6853 656e 6453 7461 7465 4576 656e  tchSendStateEven
+00008c50: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00008c60: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00008c70: 6e74 3d4d 656d 6265 7253 7461 7465 4576  nt=MemberStateEv
+00008c80: 656e 7443 6f6e 7465 6e74 284d 656d 6265  entContent(Membe
+00008c90: 7273 6869 702e 4a4f 494e 2c20 2a2a 636f  rship.JOIN, **co
+00008ca0: 6e74 656e 745f 6172 6773 292c 0a20 2020  ntent_args),.   
+00008cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008cc0: 2020 2020 2074 7970 653d 4576 656e 7454       type=EventT
+00008cd0: 7970 652e 524f 4f4d 5f4d 454d 4245 522c  ype.ROOM_MEMBER,
+00008ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008cf0: 2020 2020 2020 2020 2073 656e 6465 723d           sender=
+00008d00: 6d78 6964 2c0a 2020 2020 2020 2020 2020  mxid,.          
+00008d10: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00008d20: 6174 655f 6b65 793d 6d78 6964 2c0a 2020  ate_key=mxid,.  
+00008d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d40: 2020 2020 2020 7469 6d65 7374 616d 703d        timestamp=
+00008d50: 6f6c 6465 7374 5f6d 7367 5f74 696d 6573  oldest_msg_times
+00008d60: 7461 6d70 2c0a 2020 2020 2020 2020 2020  tamp,.          
+00008d70: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00008d80: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+00008d90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00008da0: 2020 2020 2020 2020 2061 6464 6564 5f6d           added_m
+00008db0: 656d 6265 7273 2e61 6464 286d 7869 6429  embers.add(mxid)
+00008dc0: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+00008dd0: 6465 6620 696e 7465 6e74 5f66 6f72 2875  def intent_for(u
+00008de0: 7365 725f 6964 3a20 7374 7220 7c20 696e  ser_id: str | in
+00008df0: 7429 202d 3e20 7475 706c 655b 702e 5075  t) -> tuple[p.Pu
+00008e00: 7070 6574 2c20 496e 7465 6e74 4150 495d  ppet, IntentAPI]
+00008e10: 3a0a 2020 2020 2020 2020 2020 2020 7075  :.            pu
+00008e20: 7070 6574 3a20 702e 5075 7070 6574 203d  ppet: p.Puppet =
+00008e30: 2061 7761 6974 2070 2e50 7570 7065 742e   await p.Puppet.
+00008e40: 6765 745f 6279 5f66 6269 6428 7573 6572  get_by_fbid(user
+00008e50: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
+00008e60: 2069 6620 7075 7070 6574 3a0a 2020 2020   if puppet:.    
+00008e70: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00008e80: 6e74 203d 2070 7570 7065 742e 696e 7465  nt = puppet.inte
+00008e90: 6e74 5f66 6f72 2873 656c 6629 0a20 2020  nt_for(self).   
+00008ea0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00008eb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00008ec0: 6e74 656e 7420 3d20 7365 6c66 2e6d 6169  ntent = self.mai
+00008ed0: 6e5f 696e 7465 6e74 0a20 2020 2020 2020  n_intent.       
+00008ee0: 2020 2020 2069 6620 7075 7070 6574 2e69       if puppet.i
+00008ef0: 735f 7265 616c 5f75 7365 7220 616e 6420  s_real_user and 
+00008f00: 6e6f 7420 7365 6c66 2e5f 6361 6e5f 646f  not self._can_do
+00008f10: 7562 6c65 5f70 7570 7065 745f 6261 636b  uble_puppet_back
+00008f20: 6669 6c6c 2869 6e74 656e 742e 6d78 6964  fill(intent.mxid
+00008f30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00008f40: 2020 2069 6e74 656e 7420 3d20 7075 7070     intent = pupp
+00008f50: 6574 2e64 6566 6175 6c74 5f6d 7869 645f  et.default_mxid_
+00008f60: 696e 7465 6e74 0a20 2020 2020 2020 2020  intent.         
+00008f70: 2020 2072 6574 7572 6e20 7075 7070 6574     return puppet
+00008f80: 2c20 696e 7465 6e74 0a0a 2020 2020 2020  , intent..      
+00008f90: 2020 6d65 7373 6167 655f 696e 666f 733a    message_infos:
+00008fa0: 206c 6973 745b 7475 706c 655b 6772 6170   list[tuple[grap
+00008fb0: 6871 6c2e 4d65 7373 6167 652c 2069 6e74  hql.Message, int
+00008fc0: 5d5d 203d 205b 5d0a 2020 2020 2020 2020  ]] = [].        
+00008fd0: 696e 7465 6e74 733a 206c 6973 745b 496e  intents: list[In
+00008fe0: 7465 6e74 4150 495d 203d 205b 5d0a 2020  tentAPI] = [].  
+00008ff0: 2020 2020 2020 6c61 7374 5f6d 6573 7361        last_messa
+00009000: 6765 5f74 696d 6573 7461 6d70 203d 2030  ge_timestamp = 0
+00009010: 0a0a 2020 2020 2020 2020 666f 7220 6d65  ..        for me
+00009020: 7373 6167 6520 696e 206d 6573 7361 6765  ssage in message
+00009030: 5f70 6167 653a 0a20 2020 2020 2020 2020  _page:.         
+00009040: 2020 206c 6173 745f 6d65 7373 6167 655f     last_message_
+00009050: 7469 6d65 7374 616d 7020 3d20 6d61 7828  timestamp = max(
+00009060: 6c61 7374 5f6d 6573 7361 6765 5f74 696d  last_message_tim
+00009070: 6573 7461 6d70 2c20 6d65 7373 6167 652e  estamp, message.
+00009080: 7469 6d65 7374 616d 7029 0a0a 2020 2020  timestamp)..    
+00009090: 2020 2020 2020 2020 7075 7070 6574 2c20          puppet, 
+000090a0: 696e 7465 6e74 203d 2061 7761 6974 2069  intent = await i
+000090b0: 6e74 656e 745f 666f 7228 6d65 7373 6167  ntent_for(messag
+000090c0: 652e 6d65 7373 6167 655f 7365 6e64 6572  e.message_sender
+000090d0: 2e69 6429 0a20 2020 2020 2020 2020 2020  .id).           
+000090e0: 2069 6620 6e6f 7420 7075 7070 6574 2e6e   if not puppet.n
+000090f0: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+00009100: 2020 2020 2061 7761 6974 2070 7570 7065       await puppe
+00009110: 742e 7570 6461 7465 5f69 6e66 6f28 736f  t.update_info(so
+00009120: 7572 6365 290a 0a20 2020 2020 2020 2020  urce)..         
+00009130: 2020 2023 2043 6f6e 7665 7274 2074 6865     # Convert the
+00009140: 206d 6573 7361 6765 0a20 2020 2020 2020   message.       
+00009150: 2020 2020 2063 6f6e 7665 7274 6564 203d       converted =
+00009160: 2061 7761 6974 2073 656c 662e 636f 6e76   await self.conv
+00009170: 6572 745f 6661 6365 626f 6f6b 5f6d 6573  ert_facebook_mes
+00009180: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
+00009190: 2020 2020 2020 736f 7572 6365 2c0a 2020        source,.  
+000091a0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000091b0: 7465 6e74 2c0a 2020 2020 2020 2020 2020  tent,.          
+000091c0: 2020 2020 2020 6d65 7373 6167 652c 0a20        message,. 
+000091d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000091e0: 6574 6572 6d69 6e69 7374 6963 5f72 6570  eterministic_rep
+000091f0: 6c79 5f69 643d 7365 6c66 2e62 7269 6467  ly_id=self.bridg
+00009200: 652e 686f 6d65 7365 7276 6572 5f73 6f66  e.homeserver_sof
+00009210: 7477 6172 652e 6973 5f68 756e 6772 792c  tware.is_hungry,
+00009220: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00009230: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00009240: 7420 636f 6e76 6572 7465 643a 0a20 2020  t converted:.   
+00009250: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00009260: 662e 6c6f 672e 6465 6275 6728 2253 6b69  f.log.debug("Ski
+00009270: 7070 696e 6720 756e 7375 7070 6f72 7465  pping unsupporte
+00009280: 6420 6d65 7373 6167 6520 696e 2062 6163  d message in bac
+00009290: 6b66 696c 6c22 290a 2020 2020 2020 2020  kfill").        
+000092a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000092b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000092c0: 2069 6e74 656e 742e 6d78 6964 206e 6f74   intent.mxid not
+000092d0: 2069 6e20 6375 7272 656e 745f 6d65 6d62   in current_memb
+000092e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000092f0: 2020 2020 2061 6464 5f6d 656d 6265 7228       add_member(
+00009300: 7075 7070 6574 2c20 696e 7465 6e74 2e6d  puppet, intent.m
+00009310: 7869 6429 0a0a 2020 2020 2020 2020 2020  xid)..          
+00009320: 2020 645f 6576 656e 745f 6964 203d 204e    d_event_id = N
+00009330: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00009340: 666f 7220 696e 6465 782c 2028 6576 656e  for index, (even
+00009350: 745f 7479 7065 2c20 636f 6e74 656e 7429  t_type, content)
+00009360: 2069 6e20 656e 756d 6572 6174 6528 636f   in enumerate(co
+00009370: 6e76 6572 7465 6429 3a0a 2020 2020 2020  nverted):.      
+00009380: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00009390: 662e 656e 6372 7970 7465 6420 616e 6420  f.encrypted and 
+000093a0: 7365 6c66 2e6d 6174 7269 782e 6532 6565  self.matrix.e2ee
+000093b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000093c0: 2020 2020 2020 6576 656e 745f 7479 7065        event_type
+000093d0: 2c20 636f 6e74 656e 7420 3d20 6177 6169  , content = awai
+000093e0: 7420 7365 6c66 2e6d 6174 7269 782e 6532  t self.matrix.e2
+000093f0: 6565 2e65 6e63 7279 7074 280a 2020 2020  ee.encrypt(.    
+00009400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009410: 2020 2020 7365 6c66 2e6d 7869 642c 2065      self.mxid, e
+00009420: 7665 6e74 5f74 7970 652c 2063 6f6e 7465  vent_type, conte
+00009430: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00009440: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009450: 2020 2020 2020 2020 2069 6620 696e 7465           if inte
+00009460: 6e74 2e61 7069 2e69 735f 7265 616c 5f75  nt.api.is_real_u
+00009470: 7365 7220 616e 6420 696e 7465 6e74 2e61  ser and intent.a
+00009480: 7069 2e62 7269 6467 655f 6e61 6d65 2069  pi.bridge_name i
+00009490: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000094a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094b0: 636f 6e74 656e 745b 444f 5542 4c45 5f50  content[DOUBLE_P
+000094c0: 5550 5045 545f 534f 5552 4345 5f4b 4559  UPPET_SOURCE_KEY
+000094d0: 5d20 3d20 696e 7465 6e74 2e61 7069 2e62  ] = intent.api.b
+000094e0: 7269 6467 655f 6e61 6d65 0a0a 2020 2020  ridge_name..    
+000094f0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00009500: 656c 662e 6272 6964 6765 2e68 6f6d 6573  elf.bridge.homes
+00009510: 6572 7665 725f 736f 6674 7761 7265 2e69  erver_software.i
+00009520: 735f 6875 6e67 7279 3a0a 2020 2020 2020  s_hungry:.      
+00009530: 2020 2020 2020 2020 2020 2020 2020 645f                d_
+00009540: 6576 656e 745f 6964 203d 2073 656c 662e  event_id = self.
+00009550: 5f64 6574 6572 6d69 6e69 7374 6963 5f65  _deterministic_e
+00009560: 7665 6e74 5f69 6428 6d65 7373 6167 652e  vent_id(message.
+00009570: 6d65 7373 6167 655f 6964 2c20 696e 6465  message_id, inde
+00009580: 7829 0a0a 2020 2020 2020 2020 2020 2020  x)..            
+00009590: 2020 2020 6d65 7373 6167 655f 696e 666f      message_info
+000095a0: 732e 6170 7065 6e64 2828 6d65 7373 6167  s.append((messag
+000095b0: 652c 2069 6e64 6578 2929 0a20 2020 2020  e, index)).     
+000095c0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+000095d0: 5f6d 6573 7361 6765 732e 6170 7065 6e64  _messages.append
+000095e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000095f0: 2020 2020 2020 4261 7463 6853 656e 6445        BatchSendE
+00009600: 7665 6e74 280a 2020 2020 2020 2020 2020  vent(.          
+00009610: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00009620: 6e74 656e 743d 636f 6e74 656e 742c 0a20  ntent=content,. 
+00009630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009640: 2020 2020 2020 2074 7970 653d 6576 656e         type=even
+00009650: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
+00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009670: 7365 6e64 6572 3d69 6e74 656e 742e 6d78  sender=intent.mx
+00009680: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00009690: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000096a0: 7374 616d 703d 6d65 7373 6167 652e 7469  stamp=message.ti
+000096b0: 6d65 7374 616d 702c 0a20 2020 2020 2020  mestamp,.       
+000096c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096d0: 2065 7665 6e74 5f69 643d 645f 6576 656e   event_id=d_even
+000096e0: 745f 6964 2c0a 2020 2020 2020 2020 2020  t_id,.          
+000096f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00009700: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00009710: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00009720: 7465 6e74 732e 6170 7065 6e64 2869 6e74  tents.append(int
+00009730: 656e 7429 0a0a 2020 2020 2020 2020 2020  ent)..          
+00009740: 2020 6966 2073 656c 662e 6272 6964 6765    if self.bridge
+00009750: 2e68 6f6d 6573 6572 7665 725f 736f 6674  .homeserver_soft
+00009760: 7761 7265 2e69 735f 6875 6e67 7279 2061  ware.is_hungry a
+00009770: 6e64 206d 6573 7361 6765 2e6d 6573 7361  nd message.messa
+00009780: 6765 5f72 6561 6374 696f 6e73 3a0a 2020  ge_reactions:.  
+00009790: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000097a0: 7220 7265 6163 7469 6f6e 2069 6e20 6d65  r reaction in me
+000097b0: 7373 6167 652e 6d65 7373 6167 655f 7265  ssage.message_re
+000097c0: 6163 7469 6f6e 733a 0a20 2020 2020 2020  actions:.       
+000097d0: 2020 2020 2020 2020 2020 2020 2070 7570               pup
+000097e0: 7065 742c 2069 6e74 656e 7420 3d20 6177  pet, intent = aw
+000097f0: 6169 7420 696e 7465 6e74 5f66 6f72 2872  ait intent_for(r
+00009800: 6561 6374 696f 6e2e 7573 6572 2e69 6429  eaction.user.id)
+00009810: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009820: 2020 2020 2020 7265 6163 7469 6f6e 5f65        reaction_e
+00009830: 7665 6e74 203d 2052 6561 6374 696f 6e45  vent = ReactionE
+00009840: 7665 6e74 436f 6e74 656e 7428 290a 2020  ventContent().  
+00009850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009860: 2020 7265 6163 7469 6f6e 5f65 7665 6e74    reaction_event
+00009870: 2e72 656c 6174 6573 5f74 6f20 3d20 5265  .relates_to = Re
+00009880: 6c61 7465 7354 6f28 0a20 2020 2020 2020  latesTo(.       
+00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098a0: 2072 656c 5f74 7970 653d 5265 6c61 7469   rel_type=Relati
+000098b0: 6f6e 5479 7065 2e41 4e4e 4f54 4154 494f  onType.ANNOTATIO
+000098c0: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
+000098d0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+000098e0: 5f69 643d 645f 6576 656e 745f 6964 2c0a  _id=d_event_id,.
+000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009900: 2020 2020 2020 2020 6b65 793d 7265 6163          key=reac
+00009910: 7469 6f6e 2e72 6561 6374 696f 6e2c 0a20  tion.reaction,. 
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00009940: 2020 2020 2020 2020 2069 6620 696e 7465           if inte
+00009950: 6e74 2e61 7069 2e69 735f 7265 616c 5f75  nt.api.is_real_u
+00009960: 7365 7220 616e 6420 696e 7465 6e74 2e61  ser and intent.a
+00009970: 7069 2e62 7269 6467 655f 6e61 6d65 2069  pi.bridge_name i
+00009980: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099a0: 2020 2020 7265 6163 7469 6f6e 5f65 7665      reaction_eve
+000099b0: 6e74 5b44 4f55 424c 455f 5055 5050 4554  nt[DOUBLE_PUPPET
+000099c0: 5f53 4f55 5243 455f 4b45 595d 203d 2069  _SOURCE_KEY] = i
+000099d0: 6e74 656e 742e 6170 692e 6272 6964 6765  ntent.api.bridge
+000099e0: 5f6e 616d 650a 0a20 2020 2020 2020 2020  _name..         
+000099f0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+00009a00: 6765 5f69 6e66 6f73 2e61 7070 656e 6428  ge_infos.append(
+00009a10: 2872 6561 6374 696f 6e2c 2030 2929 0a20  (reaction, 0)). 
+00009a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a30: 2020 2062 6174 6368 5f6d 6573 7361 6765     batch_message
+00009a40: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a60: 2020 4261 7463 6853 656e 6445 7665 6e74    BatchSendEvent
+00009a70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009a80: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00009a90: 6e74 656e 743d 7265 6163 7469 6f6e 5f65  ntent=reaction_e
+00009aa0: 7665 6e74 2c0a 2020 2020 2020 2020 2020  vent,.          
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ac0: 2020 7479 7065 3d45 7665 6e74 5479 7065    type=EventType
+00009ad0: 2e52 4541 4354 494f 4e2c 0a20 2020 2020  .REACTION,.     
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2020 2020 2020 2073 656e 6465 723d 696e         sender=in
+00009b00: 7465 6e74 2e6d 7869 642c 0a20 2020 2020  tent.mxid,.     
+00009b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b20: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
+00009b30: 3d6d 6573 7361 6765 2e74 696d 6573 7461  =message.timesta
+00009b40: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
+00009b50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00009b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b70: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+00009b80: 6e6f 7420 6261 7463 685f 6d65 7373 6167  not batch_messag
+00009b90: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00009ba0: 2320 5374 696c 6c20 7265 7475 726e 2074  # Still return t
+00009bb0: 6865 206f 6c64 6573 7420 6d65 7373 6167  he oldest messag
+00009bc0: 6527 7320 7469 6d65 7374 616d 702c 2073  e's timestamp, s
+00009bd0: 696e 6365 206e 6f6e 6520 6f66 2074 6865  ince none of the
+00009be0: 206d 6573 7361 6765 7320 7765 7265 0a20   messages were. 
+00009bf0: 2020 2020 2020 2020 2020 2023 2062 7269             # bri
+00009c00: 6467 6561 626c 652c 2077 6520 7761 6e74  dgeable, we want
+00009c10: 2074 6f20 736b 6970 2066 7572 7468 6572   to skip further
+00009c20: 2062 6163 6b20 696e 2068 6973 746f 7279   back in history
+00009c30: 2074 6f20 6669 6e64 2073 6f6d 6520 7468   to find some th
+00009c40: 6174 2061 7265 2062 7269 6467 6162 6c65  at are bridgable
+00009c50: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00009c60: 7475 726e 2030 2c20 6f6c 6465 7374 5f6d  turn 0, oldest_m
+00009c70: 7367 5f74 696d 6573 7461 6d70 2c20 4e6f  sg_timestamp, No
+00009c80: 6e65 0a0a 2020 2020 2020 2020 6966 2028  ne..        if (
+00009c90: 0a20 2020 2020 2020 2020 2020 206e 6f74  .            not
+00009ca0: 2073 656c 662e 6272 6964 6765 2e68 6f6d   self.bridge.hom
+00009cb0: 6573 6572 7665 725f 736f 6674 7761 7265  eserver_software
+00009cc0: 2e69 735f 6875 6e67 7279 0a20 2020 2020  .is_hungry.     
+00009cd0: 2020 2020 2020 2061 6e64 2073 656c 662e         and self.
+00009ce0: 636f 6e66 6967 5b22 6272 6964 6765 2e62  config["bridge.b
+00009cf0: 6163 6b66 696c 6c2e 6d73 6332 3731 3622  ackfill.msc2716"
+00009d00: 5d0a 2020 2020 2020 2020 2020 2020 616e  ].            an
+00009d10: 6420 2866 6f72 7761 7264 206f 7220 7365  d (forward or se
+00009d20: 6c66 2e6e 6578 745f 6261 7463 685f 6964  lf.next_batch_id
+00009d30: 2069 7320 4e6f 6e65 290a 2020 2020 2020   is None).      
+00009d40: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00009d50: 2073 656c 662e 6c6f 672e 6465 6275 6728   self.log.debug(
+00009d60: 2253 656e 6469 6e67 2064 756d 6d79 2065  "Sending dummy e
+00009d70: 7665 6e74 2074 6f20 6176 6f69 6420 666f  vent to avoid fo
+00009d80: 7277 6172 6420 6578 7472 656d 6974 7920  rward extremity 
+00009d90: 6572 726f 7273 2229 0a20 2020 2020 2020  errors").       
+00009da0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00009db0: 6d61 696e 5f69 6e74 656e 742e 7365 6e64  main_intent.send
+00009dc0: 5f6d 6573 7361 6765 5f65 7665 6e74 280a  _message_event(.
+00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009de0: 7365 6c66 2e6d 7869 642c 2045 7665 6e74  self.mxid, Event
+00009df0: 5479 7065 2822 6669 2e6d 6175 2e64 756d  Type("fi.mau.dum
+00009e00: 6d79 2e70 7265 5f62 6163 6b66 696c 6c22  my.pre_backfill"
+00009e10: 2c20 4576 656e 7454 7970 652e 436c 6173  , EventType.Clas
+00009e20: 732e 4d45 5353 4147 4529 2c20 7b7d 0a20  s.MESSAGE), {}. 
+00009e30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00009e40: 2020 2020 2020 7365 6c66 2e6c 6f67 2e69        self.log.i
+00009e50: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00009e60: 2022 5365 6e64 696e 6720 2564 2025 7320   "Sending %d %s 
+00009e70: 6d65 7373 6167 6573 2074 6f20 2573 2077  messages to %s w
+00009e80: 6974 6820 6261 7463 6820 4944 2025 7320  ith batch ID %s 
+00009e90: 616e 6420 7072 6576 696f 7573 2065 7665  and previous eve
+00009ea0: 6e74 2049 4420 2573 222c 0a20 2020 2020  nt ID %s",.     
+00009eb0: 2020 2020 2020 206c 656e 2862 6174 6368         len(batch
+00009ec0: 5f6d 6573 7361 6765 7329 2c0a 2020 2020  _messages),.    
+00009ed0: 2020 2020 2020 2020 226e 6577 2220 6966          "new" if
+00009ee0: 2066 6f72 7761 7264 2065 6c73 6520 2268   forward else "h
+00009ef0: 6973 746f 7269 6361 6c22 2c0a 2020 2020  istorical",.    
+00009f00: 2020 2020 2020 2020 7365 6c66 2e6d 7869          self.mxi
+00009f10: 642c 0a20 2020 2020 2020 2020 2020 2073  d,.            s
+00009f20: 656c 662e 6e65 7874 5f62 6174 6368 5f69  elf.next_batch_i
+00009f30: 642c 0a20 2020 2020 2020 2020 2020 2070  d,.            p
+00009f40: 7265 765f 6576 656e 745f 6964 2c0a 2020  rev_event_id,.  
+00009f50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00009f60: 6261 7365 5f69 6e73 6572 7469 6f6e 5f65  base_insertion_e
+00009f70: 7665 6e74 5f69 6420 3d20 4e6f 6e65 0a20  vent_id = None. 
+00009f80: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00009f90: 6f6e 6669 675b 2262 7269 6467 652e 6261  onfig["bridge.ba
+00009fa0: 636b 6669 6c6c 2e6d 7363 3237 3136 225d  ckfill.msc2716"]
+00009fb0: 3a0a 2020 2020 2020 2020 2020 2020 6261  :.            ba
+00009fc0: 7463 685f 7365 6e64 5f72 6573 7020 3d20  tch_send_resp = 
+00009fd0: 6177 6169 7420 7365 6c66 2e6d 6169 6e5f  await self.main_
+00009fe0: 696e 7465 6e74 2e62 6174 6368 5f73 656e  intent.batch_sen
+00009ff0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0000a000: 2020 2073 656c 662e 6d78 6964 2c0a 2020     self.mxid,.  
+0000a010: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000a020: 6576 5f65 7665 6e74 5f69 642c 0a20 2020  ev_event_id,.   
+0000a030: 2020 2020 2020 2020 2020 2020 2062 6174               bat
+0000a040: 6368 5f69 643d 7365 6c66 2e6e 6578 745f  ch_id=self.next_
+0000a050: 6261 7463 685f 6964 2c0a 2020 2020 2020  batch_id,.      
+0000a060: 2020 2020 2020 2020 2020 6576 656e 7473            events
+0000a070: 3d62 6174 6368 5f6d 6573 7361 6765 732c  =batch_messages,
+0000a080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a090: 2073 7461 7465 5f65 7665 6e74 735f 6174   state_events_at
+0000a0a0: 5f73 7461 7274 3d73 7461 7465 5f65 7665  _start=state_eve
+0000a0b0: 6e74 735f 6174 5f73 7461 7274 2c0a 2020  nts_at_start,.  
+0000a0c0: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0000a0d0: 6570 6572 5f6e 6577 5f6d 6573 7361 6765  eper_new_message
+0000a0e0: 733d 666f 7277 6172 642c 0a20 2020 2020  s=forward,.     
+0000a0f0: 2020 2020 2020 2020 2020 2062 6565 7065             beepe
+0000a100: 725f 6d61 726b 5f72 6561 645f 6279 3d73  r_mark_read_by=s
+0000a110: 6f75 7263 652e 6d78 6964 2069 6620 6d61  ource.mxid if ma
+0000a120: 726b 5f72 6561 6420 656c 7365 204e 6f6e  rk_read else Non
+0000a130: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+0000a140: 0a20 2020 2020 2020 2020 2020 2062 6173  .            bas
+0000a150: 655f 696e 7365 7274 696f 6e5f 6576 656e  e_insertion_even
+0000a160: 745f 6964 203d 2062 6174 6368 5f73 656e  t_id = batch_sen
+0000a170: 645f 7265 7370 2e62 6173 655f 696e 7365  d_resp.base_inse
+0000a180: 7274 696f 6e5f 6576 656e 745f 6964 0a20  rtion_event_id. 
+0000a190: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0000a1a0: 5f69 6473 203d 2062 6174 6368 5f73 656e  _ids = batch_sen
+0000a1b0: 645f 7265 7370 2e65 7665 6e74 5f69 6473  d_resp.event_ids
+0000a1c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000a1d0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+0000a1e0: 5f73 656e 645f 7265 7370 203d 204e 6f6e  _send_resp = Non
+0000a1f0: 650a 2020 2020 2020 2020 2020 2020 6576  e.            ev
+0000a200: 656e 745f 6964 7320 3d20 5b0a 2020 2020  ent_ids = [.    
+0000a210: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000a220: 7420 696e 7465 6e74 2e73 656e 645f 6d65  t intent.send_me
+0000a230: 7373 6167 655f 6576 656e 7428 0a20 2020  ssage_event(.   
+0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a250: 2073 656c 662e 6d78 6964 2c20 6576 742e   self.mxid, evt.
+0000a260: 7479 7065 2c20 6576 742e 636f 6e74 656e  type, evt.conten
+0000a270: 742c 2074 696d 6573 7461 6d70 3d65 7674  t, timestamp=evt
+0000a280: 2e74 696d 6573 7461 6d70 0a20 2020 2020  .timestamp.     
+0000a290: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000a2a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000a2b0: 2065 7674 2c20 696e 7465 6e74 2069 6e20   evt, intent in 
+0000a2c0: 7a69 7028 6261 7463 685f 6d65 7373 6167  zip(batch_messag
+0000a2d0: 6573 2c20 696e 7465 6e74 7329 0a20 2020  es, intents).   
+0000a2e0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0000a2f0: 2020 2061 7761 6974 2073 656c 662e 5f66     await self._f
+0000a300: 696e 6973 685f 6261 7463 6828 6576 656e  inish_batch(even
+0000a310: 745f 6964 732c 206d 6573 7361 6765 5f69  t_ids, message_i
+0000a320: 6e66 6f73 290a 2020 2020 2020 2020 6966  nfos).        if
+0000a330: 206e 6f74 2066 6f72 7761 7264 3a0a 2020   not forward:.  
+0000a340: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0000a350: 2062 6174 6368 5f73 656e 645f 7265 7370   batch_send_resp
+0000a360: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000a370: 662e 6c6f 672e 6465 6275 6728 2247 6f74  f.log.debug("Got
+0000a380: 206e 6578 7420 6261 7463 6820 4944 2025   next batch ID %
+0000a390: 7320 666f 7220 2573 222c 2062 6174 6368  s for %s", batch
+0000a3a0: 5f73 656e 645f 7265 7370 2e6e 6578 745f  _send_resp.next_
+0000a3b0: 6261 7463 685f 6964 2c20 7365 6c66 2e6d  batch_id, self.m
+0000a3c0: 7869 6429 0a20 2020 2020 2020 2020 2020  xid).           
+0000a3d0: 2073 656c 662e 6e65 7874 5f62 6174 6368   self.next_batch
+0000a3e0: 5f69 6420 3d20 6261 7463 685f 7365 6e64  _id = batch_send
+0000a3f0: 5f72 6573 702e 6e65 7874 5f62 6174 6368  _resp.next_batch
+0000a400: 5f69 640a 2020 2020 2020 2020 6177 6169  _id.        awai
+0000a410: 7420 7365 6c66 2e73 6176 6528 290a 0a20  t self.save().. 
+0000a420: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+0000a430: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+0000a440: 6576 656e 745f 6964 7329 2c0a 2020 2020  event_ids),.    
+0000a450: 2020 2020 2020 2020 6f6c 6465 7374 5f6d          oldest_m
+0000a460: 7367 5f74 696d 6573 7461 6d70 2c0a 2020  sg_timestamp,.  
+0000a470: 2020 2020 2020 2020 2020 6261 7365 5f69            base_i
+0000a480: 6e73 6572 7469 6f6e 5f65 7665 6e74 5f69  nsertion_event_i
+0000a490: 642c 0a20 2020 2020 2020 2029 0a0a 2020  d,.        )..  
+0000a4a0: 2020 6465 6620 5f63 616e 5f64 6f75 626c    def _can_doubl
+0000a4b0: 655f 7075 7070 6574 5f62 6163 6b66 696c  e_puppet_backfil
+0000a4c0: 6c28 7365 6c66 2c20 6375 7374 6f6d 5f6d  l(self, custom_m
+0000a4d0: 7869 643a 2055 7365 7249 4429 202d 3e20  xid: UserID) -> 
+0000a4e0: 626f 6f6c 3a0a 2020 2020 2020 2020 7265  bool:.        re
+0000a4f0: 7475 726e 2073 656c 662e 636f 6e66 6967  turn self.config
+0000a500: 5b22 6272 6964 6765 2e62 6163 6b66 696c  ["bridge.backfil
+0000a510: 6c2e 646f 7562 6c65 5f70 7570 7065 745f  l.double_puppet_
+0000a520: 6261 636b 6669 6c6c 225d 2061 6e64 2028  backfill"] and (
+0000a530: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
+0000a540: 756e 6772 7973 6572 7620 6361 6e20 6261  ungryserv can ba
+0000a550: 7463 6820 7365 6e64 2061 6e79 2075 7365  tch send any use
+0000a560: 7273 0a20 2020 2020 2020 2020 2020 2073  rs.            s
+0000a570: 656c 662e 6272 6964 6765 2e68 6f6d 6573  elf.bridge.homes
+0000a580: 6572 7665 725f 736f 6674 7761 7265 2e69  erver_software.i
+0000a590: 735f 6875 6e67 7279 0a20 2020 2020 2020  s_hungry.       
+0000a5a0: 2020 2020 2023 204e 6f6e 2d4d 5343 3237       # Non-MSC27
+0000a5b0: 3136 2062 6163 6b66 696c 6c20 6361 6e20  16 backfill can 
+0000a5c0: 7573 6520 616e 7920 646f 7562 6c65 2070  use any double p
+0000a5d0: 7570 7065 740a 2020 2020 2020 2020 2020  uppet.          
+0000a5e0: 2020 6f72 206e 6f74 2073 656c 662e 636f    or not self.co
+0000a5f0: 6e66 6967 5b22 6272 6964 6765 2e62 6163  nfig["bridge.bac
+0000a600: 6b66 696c 6c2e 6d73 6332 3731 3622 5d0a  kfill.msc2716"].
+0000a610: 2020 2020 2020 2020 2020 2020 2320 4c6f              # Lo
+0000a620: 6361 6c20 7573 6572 7320 6361 6e20 6265  cal users can be
+0000a630: 2064 6f75 626c 6520 7075 7070 6574 6564   double puppeted
+0000a640: 2065 7665 6e20 7769 7468 204d 5343 3237   even with MSC27
+0000a650: 3136 0a20 2020 2020 2020 2020 2020 206f  16.            o
+0000a660: 7220 2863 7573 746f 6d5f 6d78 6964 5b63  r (custom_mxid[c
+0000a670: 7573 746f 6d5f 6d78 6964 2e69 6e64 6578  ustom_mxid.index
+0000a680: 2822 3a22 2920 2b20 3120 3a5d 203d 3d20  (":") + 1 :] == 
+0000a690: 7365 6c66 2e63 6f6e 6669 675b 2268 6f6d  self.config["hom
+0000a6a0: 6573 6572 7665 722e 646f 6d61 696e 225d  eserver.domain"]
+0000a6b0: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+0000a6c0: 2061 7379 6e63 2064 6566 205f 6669 6e69   async def _fini
+0000a6d0: 7368 5f62 6174 6368 280a 2020 2020 2020  sh_batch(.      
+0000a6e0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000a6f0: 6576 656e 745f 6964 733a 206c 6973 745b  event_ids: list[
+0000a700: 4576 656e 7449 445d 2c0a 2020 2020 2020  EventID],.      
+0000a710: 2020 6d65 7373 6167 655f 696e 666f 733a    message_infos:
+0000a720: 206c 6973 745b 7475 706c 655b 6772 6170   list[tuple[grap
+0000a730: 6871 6c2e 4d65 7373 6167 6520 7c20 6772  hql.Message | gr
+0000a740: 6170 6871 6c2e 5265 6163 7469 6f6e 2c20  aphql.Reaction, 
+0000a750: 696e 745d 5d2c 0a20 2020 2029 3a0a 2020  int]],.    ):.  
+0000a760: 2020 2020 2020 2320 5765 2068 6176 6520        # We have 
+0000a770: 746f 2064 6f20 7468 6973 2073 6c69 6768  to do this sligh
+0000a780: 746c 7920 616e 6e6f 7969 6e67 2070 726f  tly annoying pro
+0000a790: 6365 7373 696e 6720 6f66 2074 6865 2065  cessing of the e
+0000a7a0: 7665 6e74 2049 4473 2061 6e64 206d 6573  vent IDs and mes
+0000a7b0: 7361 6765 2069 6e66 6f73 2073 6f0a 2020  sage infos so.  
+0000a7c0: 2020 2020 2020 2320 7468 6174 2077 6520        # that we 
+0000a7d0: 6f6e 6c79 206d 6170 2074 6865 206c 6173  only map the las
+0000a7e0: 7420 6576 656e 7420 4944 2074 6f20 7468  t event ID to th
+0000a7f0: 6520 6d65 7373 6167 652e 0a20 2020 2020  e message..     
+0000a800: 2020 2023 2057 6865 6e20 696e 6c69 6e65     # When inline
+0000a810: 2063 6170 7469 6f6e 7320 6172 6520 656e   captions are en
+0000a820: 6162 6c65 642c 2074 6869 7320 7769 6c6c  abled, this will
+0000a830: 2068 6176 6520 6e6f 2065 6666 6563 7420   have no effect 
+0000a840: 7369 6e63 6520 696e 6465 7820 7769 6c6c  since index will
+0000a850: 2061 6c77 6179 7320 6265 2030 0a20 2020   always be 0.   
+0000a860: 2020 2020 2023 2073 696e 6365 2074 6865       # since the
+0000a870: 7265 2773 206f 6e6c 7920 6576 6572 206f  re's only ever o
+0000a880: 6e65 2065 7665 6e74 2070 6572 206d 6573  ne event per mes
+0000a890: 7361 6765 2e0a 2020 2020 2020 2020 6375  sage..        cu
+0000a8a0: 7272 656e 745f 6d65 7373 6167 6520 3d20  rrent_message = 
+0000a8b0: 4e6f 6e65 0a20 2020 2020 2020 206d 6573  None.        mes
+0000a8c0: 7361 6765 7320 3d20 5b5d 0a20 2020 2020  sages = [].     
+0000a8d0: 2020 2072 6561 6374 696f 6e73 203d 205b     reactions = [
+0000a8e0: 5d0a 2020 2020 2020 2020 666f 7220 6576  ].        for ev
+0000a8f0: 656e 745f 6964 2c20 286d 6573 7361 6765  ent_id, (message
+0000a900: 5f6f 725f 7265 6163 7469 6f6e 2c20 696e  _or_reaction, in
+0000a910: 6465 7829 2069 6e20 7a69 7028 6576 656e  dex) in zip(even
+0000a920: 745f 6964 732c 206d 6573 7361 6765 5f69  t_ids, message_i
+0000a930: 6e66 6f73 293a 0a20 2020 2020 2020 2020  nfos):.         
+0000a940: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000a950: 286d 6573 7361 6765 5f6f 725f 7265 6163  (message_or_reac
+0000a960: 7469 6f6e 2c20 6772 6170 6871 6c2e 4d65  tion, graphql.Me
+0000a970: 7373 6167 6529 3a0a 2020 2020 2020 2020  ssage):.        
+0000a980: 2020 2020 2020 2020 6d65 7373 6167 6520          message 
+0000a990: 3d20 6d65 7373 6167 655f 6f72 5f72 6561  = message_or_rea
+0000a9a0: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
+0000a9b0: 2020 2020 2020 6966 2069 6e64 6578 203d        if index =
+0000a9c0: 3d20 3020 616e 6420 6375 7272 656e 745f  = 0 and current_
+0000a9d0: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
+0000a9e0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0000a9f0: 6869 7320 6d65 616e 7320 7468 6174 2061  his means that a
+0000aa00: 6c6c 206f 6620 7468 6520 6576 656e 7473  ll of the events
+0000aa10: 2066 6f72 2074 6865 2070 7265 7669 6f75   for the previou
+0000aa20: 7320 6d65 7373 6167 6520 6861 7665 2062  s message have b
+0000aa30: 6565 6e20 7072 6f63 6573 7365 642c 0a20  een processed,. 
+0000aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa50: 2020 2023 2061 6e64 2074 6865 2063 7572     # and the cur
+0000aa60: 7265 6e74 5f6d 6573 7361 6765 2069 7320  rent_message is 
+0000aa70: 7468 6520 6d6f 7374 2072 6563 656e 7420  the most recent 
+0000aa80: 6576 656e 7420 666f 7220 7468 6174 206d  event for that m
+0000aa90: 6573 7361 6765 2e0a 2020 2020 2020 2020  essage..        
+0000aaa0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+0000aab0: 6167 6573 2e61 7070 656e 6428 6375 7272  ages.append(curr
+0000aac0: 656e 745f 6d65 7373 6167 6529 0a0a 2020  ent_message)..  
+0000aad0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0000aae0: 7272 656e 745f 6d65 7373 6167 6520 3d20  rrent_message = 
+0000aaf0: 4442 4d65 7373 6167 6528 0a20 2020 2020  DBMessage(.     
+0000ab00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000ab10: 7869 643d 6576 656e 745f 6964 2c0a 2020  xid=event_id,.  
+0000ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab30: 2020 6d78 5f72 6f6f 6d3d 7365 6c66 2e6d    mx_room=self.m
+0000ab40: 7869 642c 0a20 2020 2020 2020 2020 2020  xid,.           
+0000ab50: 2020 2020 2020 2020 2069 6e64 6578 3d69           index=i
+0000ab60: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
+0000ab70: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+0000ab80: 616d 703d 6d65 7373 6167 652e 7469 6d65  amp=message.time
+0000ab90: 7374 616d 702c 0a20 2020 2020 2020 2020  stamp,.         
+0000aba0: 2020 2020 2020 2020 2020 2066 6269 643d             fbid=
+0000abb0: 6d65 7373 6167 652e 6d65 7373 6167 655f  message.message_
+0000abc0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000abd0: 2020 2020 2020 2020 6662 5f63 6861 743d          fb_chat=
+0000abe0: 7365 6c66 2e66 6269 642c 0a20 2020 2020  self.fbid,.     
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ac00: 625f 7265 6365 6976 6572 3d73 656c 662e  b_receiver=self.
+0000ac10: 6662 5f72 6563 6569 7665 722c 0a20 2020  fb_receiver,.   
+0000ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac30: 2066 625f 7365 6e64 6572 3d69 6e74 286d   fb_sender=int(m
+0000ac40: 6573 7361 6765 2e6d 6573 7361 6765 5f73  essage.message_s
+0000ac50: 656e 6465 722e 6964 292c 0a20 2020 2020  ender.id),.     
+0000ac60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ac70: 625f 7478 6e5f 6964 3d69 6e74 286d 6573  b_txn_id=int(mes
+0000ac80: 7361 6765 2e6f 6666 6c69 6e65 5f74 6872  sage.offline_thr
+0000ac90: 6561 6469 6e67 5f69 6429 2c0a 2020 2020  eading_id),.    
+0000aca0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000acb0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acd0: 6173 7365 7274 2063 7572 7265 6e74 5f6d  assert current_m
+0000ace0: 6573 7361 6765 0a20 2020 2020 2020 2020  essage.         
+0000acf0: 2020 2020 2020 2072 6561 6374 696f 6e20         reaction 
+0000ad00: 3d20 6d65 7373 6167 655f 6f72 5f72 6561  = message_or_rea
+0000ad10: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
+0000ad20: 2020 2020 2020 7265 6163 7469 6f6e 732e        reactions.
+0000ad30: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+0000ad40: 2020 2020 2020 2020 2020 2020 4442 5265              DBRe
+0000ad50: 6163 7469 6f6e 280a 2020 2020 2020 2020  action(.        
+0000ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad70: 6d78 6964 3d65 7665 6e74 5f69 642c 0a20  mxid=event_id,. 
+0000ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad90: 2020 2020 2020 206d 785f 726f 6f6d 3d73         mx_room=s
+0000ada0: 656c 662e 6d78 6964 2c0a 2020 2020 2020  elf.mxid,.      
+0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000adc0: 2020 6662 5f6d 7367 6964 3d63 7572 7265    fb_msgid=curre
+0000add0: 6e74 5f6d 6573 7361 6765 2e66 6269 642c  nt_message.fbid,
+0000ade0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000adf0: 2020 2020 2020 2020 2066 625f 7265 6365           fb_rece
+0000ae00: 6976 6572 3d73 656c 662e 6662 5f72 6563  iver=self.fb_rec
+0000ae10: 6569 7665 722c 0a20 2020 2020 2020 2020  eiver,.         
+0000ae20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ae30: 625f 7365 6e64 6572 3d69 6e74 2872 6561  b_sender=int(rea
+0000ae40: 6374 696f 6e2e 7573 6572 2e69 6429 2c0a  ction.user.id),.
+0000ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae60: 2020 2020 2020 2020 7265 6163 7469 6f6e          reaction
+0000ae70: 3d72 6561 6374 696f 6e2e 7265 6163 7469  =reaction.reacti
+0000ae80: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+0000ae90: 2020 2020 2020 2020 2020 2020 6d78 5f74              mx_t
+0000aea0: 696d 6573 7461 6d70 3d63 7572 7265 6e74  imestamp=current
+0000aeb0: 5f6d 6573 7361 6765 2e74 696d 6573 7461  _message.timesta
+0000aec0: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
+0000aed0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000aee0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000aef0: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
+0000af00: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
+0000af10: 2020 2020 206d 6573 7361 6765 732e 6170       messages.ap
+0000af20: 7065 6e64 2863 7572 7265 6e74 5f6d 6573  pend(current_mes
+0000af30: 7361 6765 290a 0a20 2020 2020 2020 2074  sage)..        t
+0000af40: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000af50: 6177 6169 7420 4442 4d65 7373 6167 652e  await DBMessage.
+0000af60: 6275 6c6b 5f69 6e73 6572 7428 6d65 7373  bulk_insert(mess
+0000af70: 6167 6573 290a 2020 2020 2020 2020 6578  ages).        ex
+0000af80: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+0000af90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000afa0: 2e6c 6f67 2e65 7863 6570 7469 6f6e 2822  .log.exception("
+0000afb0: 4661 696c 6564 2074 6f20 7374 6f72 6520  Failed to store 
+0000afc0: 6261 7463 6820 6d65 7373 6167 6520 4944  batch message ID
+0000afd0: 7322 290a 0a20 2020 2020 2020 2074 7279  s")..        try
+0000afe0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0000aff0: 7220 7265 6163 7469 6f6e 2069 6e20 7265  r reaction in re
+0000b000: 6163 7469 6f6e 733a 0a20 2020 2020 2020  actions:.       
+0000b010: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+0000b020: 6561 6374 696f 6e2e 696e 7365 7274 2829  eaction.insert()
+0000b030: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000b040: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+0000b050: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+0000b060: 6578 6365 7074 696f 6e28 2246 6169 6c65  exception("Faile
+0000b070: 6420 746f 2073 746f 7265 2062 6163 6b66  d to store backf
+0000b080: 696c 6c65 6420 7265 6163 7469 6f6e 7322  illed reactions"
+0000b090: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+0000b0a0: 2073 656e 645f 706f 7374 5f62 6163 6b66   send_post_backf
+0000b0b0: 696c 6c5f 6475 6d6d 7928 0a20 2020 2020  ill_dummy(.     
+0000b0c0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0000b0d0: 206c 6173 745f 6d65 7373 6167 655f 7469   last_message_ti
+0000b0e0: 6d65 7374 616d 703a 2069 6e74 2c0a 2020  mestamp: int,.  
+0000b0f0: 2020 2020 2020 6261 7365 5f69 6e73 6572        base_inser
+0000b100: 7469 6f6e 5f65 7665 6e74 5f69 643a 2045  tion_event_id: E
+0000b110: 7665 6e74 4944 207c 204e 6f6e 6520 3d20  ventID | None = 
+0000b120: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+0000b130: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+0000b140: 2e6d 7869 640a 0a20 2020 2020 2020 2069  .mxid..        i
+0000b150: 6620 6e6f 7420 6261 7365 5f69 6e73 6572  f not base_inser
+0000b160: 7469 6f6e 5f65 7665 6e74 5f69 643a 0a20  tion_event_id:. 
+0000b170: 2020 2020 2020 2020 2020 2062 6173 655f             base_
+0000b180: 696e 7365 7274 696f 6e5f 6576 656e 745f  insertion_event_
+0000b190: 6964 203d 2073 656c 662e 6869 7374 6f72  id = self.histor
+0000b1a0: 6963 616c 5f62 6173 655f 696e 7365 7274  ical_base_insert
+0000b1b0: 696f 6e5f 6576 656e 745f 6964 0a0a 2020  ion_event_id..  
+0000b1c0: 2020 2020 2020 6966 206e 6f74 2062 6173        if not bas
+0000b1d0: 655f 696e 7365 7274 696f 6e5f 6576 656e  e_insertion_even
+0000b1e0: 745f 6964 3a0a 2020 2020 2020 2020 2020  t_id:.          
+0000b1f0: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
+0000b200: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b210: 2020 224e 6f20 6261 7365 2069 6e73 6572    "No base inser
+0000b220: 7469 6f6e 2065 7665 6e74 2049 4420 696e  tion event ID in
+0000b230: 2064 6174 6162 6173 6520 6f72 2066 726f   database or fro
+0000b240: 6d20 6261 7463 6820 7365 6e64 2072 6573  m batch send res
+0000b250: 706f 6e73 652e 204e 6f74 2073 656e 6469  ponse. Not sendi
+0000b260: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
+0000b270: 2020 2020 2220 6475 6d6d 7920 6576 656e      " dummy even
+0000b280: 742e 220a 2020 2020 2020 2020 2020 2020  t.".            
+0000b290: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000b2a0: 7475 726e 0a0a 2020 2020 2020 2020 6576  turn..        ev
+0000b2b0: 656e 745f 6964 203d 2061 7761 6974 2073  ent_id = await s
+0000b2c0: 656c 662e 6d61 696e 5f69 6e74 656e 742e  elf.main_intent.
+0000b2d0: 7365 6e64 5f6d 6573 7361 6765 5f65 7665  send_message_eve
+0000b2e0: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+0000b2f0: 7365 6c66 2e6d 7869 642c 0a20 2020 2020  self.mxid,.     
+0000b300: 2020 2020 2020 2065 7665 6e74 5f74 7970         event_typ
+0000b310: 653d 4869 7374 6f72 7953 796e 634d 6172  e=HistorySyncMar
+0000b320: 6b65 724d 6573 7361 6765 2c0a 2020 2020  kerMessage,.    
+0000b330: 2020 2020 2020 2020 636f 6e74 656e 743d          content=
+0000b340: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000b350: 2020 226f 7267 2e6d 6174 7269 782e 6d73    "org.matrix.ms
+0000b360: 6332 3731 362e 6d61 726b 6572 2e69 6e73  c2716.marker.ins
+0000b370: 6572 7469 6f6e 223a 2062 6173 655f 696e  ertion": base_in
+0000b380: 7365 7274 696f 6e5f 6576 656e 745f 6964  sertion_event_id
+0000b390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b3a0: 2020 226d 2e6d 6172 6b65 722e 696e 7365    "m.marker.inse
+0000b3b0: 7274 696f 6e22 3a20 6261 7365 5f69 6e73  rtion": base_ins
+0000b3c0: 6572 7469 6f6e 5f65 7665 6e74 5f69 642c  ertion_event_id,
+0000b3d0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0000b3e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000b3f0: 2020 6177 6169 7420 4442 4d65 7373 6167    await DBMessag
+0000b400: 6528 0a20 2020 2020 2020 2020 2020 206d  e(.            m
+0000b410: 7869 643d 6576 656e 745f 6964 2c0a 2020  xid=event_id,.  
+0000b420: 2020 2020 2020 2020 2020 6d78 5f72 6f6f            mx_roo
+0000b430: 6d3d 7365 6c66 2e6d 7869 642c 0a20 2020  m=self.mxid,.   
+0000b440: 2020 2020 2020 2020 2069 6e64 6578 3d30           index=0
+0000b450: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+0000b460: 6d65 7374 616d 703d 6c61 7374 5f6d 6573  mestamp=last_mes
+0000b470: 7361 6765 5f74 696d 6573 7461 6d70 202b  sage_timestamp +
+0000b480: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+0000b490: 6662 6964 3d4e 6f6e 652c 0a20 2020 2020  fbid=None,.     
+0000b4a0: 2020 2020 2020 2066 625f 6368 6174 3d73         fb_chat=s
+0000b4b0: 656c 662e 6662 6964 2c0a 2020 2020 2020  elf.fbid,.      
+0000b4c0: 2020 2020 2020 6662 5f72 6563 6569 7665        fb_receive
+0000b4d0: 723d 7365 6c66 2e66 625f 7265 6365 6976  r=self.fb_receiv
+0000b4e0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0000b4f0: 6662 5f73 656e 6465 723d 302c 0a20 2020  fb_sender=0,.   
+0000b500: 2020 2020 2020 2020 2066 625f 7478 6e5f           fb_txn_
+0000b510: 6964 3d4e 6f6e 652c 0a20 2020 2020 2020  id=None,.       
+0000b520: 2029 2e69 6e73 6572 7428 290a 0a20 2020   ).insert()..   
+0000b530: 2023 2065 6e64 7265 6769 6f6e 0a20 2020   # endregion.   
+0000b540: 2023 2072 6567 696f 6e20 4d61 7472 6978   # region Matrix
+0000b550: 2065 7665 6e74 2068 616e 646c 696e 670a   event handling.
+0000b560: 0a20 2020 2064 6566 2072 6571 7569 7265  .    def require
+0000b570: 5f73 656e 645f 6c6f 636b 2873 656c 662c  _send_lock(self,
+0000b580: 2075 7365 725f 6964 3a20 696e 7429 202d   user_id: int) -
+0000b590: 3e20 6173 796e 6369 6f2e 4c6f 636b 3a0a  > asyncio.Lock:.
+0000b5a0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000b5b0: 2020 2020 2020 2020 206c 6f63 6b20 3d20           lock = 
+0000b5c0: 7365 6c66 2e5f 7365 6e64 5f6c 6f63 6b73  self._send_locks
+0000b5d0: 5b75 7365 725f 6964 5d0a 2020 2020 2020  [user_id].      
+0000b5e0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+0000b5f0: 723a 0a20 2020 2020 2020 2020 2020 206c  r:.            l
+0000b600: 6f63 6b20 3d20 6173 796e 6369 6f2e 4c6f  ock = asyncio.Lo
+0000b610: 636b 2829 0a20 2020 2020 2020 2020 2020  ck().           
+0000b620: 2073 656c 662e 5f73 656e 645f 6c6f 636b   self._send_lock
+0000b630: 735b 7573 6572 5f69 645d 203d 206c 6f63  s[user_id] = loc
+0000b640: 6b0a 2020 2020 2020 2020 7265 7475 726e  k.        return
+0000b650: 206c 6f63 6b0a 0a20 2020 2064 6566 206f   lock..    def o
+0000b660: 7074 696f 6e61 6c5f 7365 6e64 5f6c 6f63  ptional_send_loc
+0000b670: 6b28 7365 6c66 2c20 7573 6572 5f69 643a  k(self, user_id:
+0000b680: 2069 6e74 2920 2d3e 2061 7379 6e63 696f   int) -> asyncio
+0000b690: 2e4c 6f63 6b20 7c20 4661 6b65 4c6f 636b  .Lock | FakeLock
+0000b6a0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+0000b6b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000b6c0: 6e20 7365 6c66 2e5f 7365 6e64 5f6c 6f63  n self._send_loc
+0000b6d0: 6b73 5b75 7365 725f 6964 5d0a 2020 2020  ks[user_id].    
+0000b6e0: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+0000b6f0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000b700: 2070 6173 730a 2020 2020 2020 2020 7265   pass.        re
+0000b710: 7475 726e 2073 656c 662e 5f6e 6f6f 705f  turn self._noop_
+0000b720: 6c6f 636b 0a0a 2020 2020 6173 796e 6320  lock..    async 
+0000b730: 6465 6620 5f73 656e 645f 6465 6c69 7665  def _send_delive
+0000b740: 7279 5f72 6563 6569 7074 2873 656c 662c  ry_receipt(self,
+0000b750: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
+0000b760: 4944 2920 2d3e 204e 6f6e 653a 0a20 2020  ID) -> None:.   
+0000b770: 2020 2020 2069 6620 6576 656e 745f 6964       if event_id
+0000b780: 2061 6e64 2073 656c 662e 636f 6e66 6967   and self.config
+0000b790: 5b22 6272 6964 6765 2e64 656c 6976 6572  ["bridge.deliver
+0000b7a0: 795f 7265 6365 6970 7473 225d 3a0a 2020  y_receipts"]:.  
+0000b7b0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0000b7c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b7d0: 7761 6974 2073 656c 662e 617a 2e69 6e74  wait self.az.int
+0000b7e0: 656e 742e 6d61 726b 5f72 6561 6428 7365  ent.mark_read(se
+0000b7f0: 6c66 2e6d 7869 642c 2065 7665 6e74 5f69  lf.mxid, event_i
+0000b800: 6429 0a20 2020 2020 2020 2020 2020 2065  d).            e
+0000b810: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+0000b820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b830: 2073 656c 662e 6c6f 672e 6578 6365 7074   self.log.except
+0000b840: 696f 6e28 6622 4661 696c 6564 2074 6f20  ion(f"Failed to 
+0000b850: 7365 6e64 2064 656c 6976 6572 7920 7265  send delivery re
+0000b860: 6365 6970 7420 666f 7220 7b65 7665 6e74  ceipt for {event
+0000b870: 5f69 647d 2229 0a0a 2020 2020 6173 796e  _id}")..    asyn
+0000b880: 6320 6465 6620 5f73 656e 645f 6272 6964  c def _send_brid
+0000b890: 6765 5f73 7563 6365 7373 280a 2020 2020  ge_success(.    
+0000b8a0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0000b8b0: 2020 7365 6e64 6572 3a20 752e 5573 6572    sender: u.User
+0000b8c0: 2c0a 2020 2020 2020 2020 6576 656e 745f  ,.        event_
+0000b8d0: 6964 3a20 4576 656e 7449 442c 0a20 2020  id: EventID,.   
+0000b8e0: 2020 2020 2065 7665 6e74 5f74 7970 653a       event_type:
+0000b8f0: 2045 7665 6e74 5479 7065 2c0a 2020 2020   EventType,.    
+0000b900: 2020 2020 6d73 6774 7970 653a 204d 6573      msgtype: Mes
+0000b910: 7361 6765 5479 7065 207c 204e 6f6e 6520  sageType | None 
+0000b920: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+0000b930: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
+0000b940: 656e 6465 722e 7365 6e64 5f72 656d 6f74  ender.send_remot
+0000b950: 655f 6368 6563 6b70 6f69 6e74 280a 2020  e_checkpoint(.  
+0000b960: 2020 2020 2020 2020 2020 7374 6174 7573            status
+0000b970: 3d4d 6573 7361 6765 5365 6e64 4368 6563  =MessageSendChec
+0000b980: 6b70 6f69 6e74 5374 6174 7573 2e53 5543  kpointStatus.SUC
+0000b990: 4345 5353 2c0a 2020 2020 2020 2020 2020  CESS,.          
+0000b9a0: 2020 6576 656e 745f 6964 3d65 7665 6e74    event_id=event
+0000b9b0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0000b9c0: 2072 6f6f 6d5f 6964 3d73 656c 662e 6d78   room_id=self.mx
+0000b9d0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000b9e0: 6576 656e 745f 7479 7065 3d65 7665 6e74  event_type=event
+0000b9f0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+0000ba00: 2020 206d 6573 7361 6765 5f74 7970 653d     message_type=
+0000ba10: 6d73 6774 7970 652c 0a20 2020 2020 2020  msgtype,.       
+0000ba20: 2029 0a20 2020 2020 2020 2062 6163 6b67   ).        backg
+0000ba30: 726f 756e 645f 7461 736b 2e63 7265 6174  round_task.creat
+0000ba40: 6528 7365 6c66 2e5f 7365 6e64 5f6d 6573  e(self._send_mes
+0000ba50: 7361 6765 5f73 7461 7475 7328 6576 656e  sage_status(even
+0000ba60: 745f 6964 2c20 6572 723d 4e6f 6e65 2929  t_id, err=None))
+0000ba70: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+0000ba80: 656c 662e 5f73 656e 645f 6465 6c69 7665  elf._send_delive
+0000ba90: 7279 5f72 6563 6569 7074 2865 7665 6e74  ry_receipt(event
+0000baa0: 5f69 6429 0a0a 2020 2020 6173 796e 6320  _id)..    async 
+0000bab0: 6465 6620 5f73 656e 645f 6272 6964 6765  def _send_bridge
+0000bac0: 5f65 7272 6f72 280a 2020 2020 2020 2020  _error(.        
+0000bad0: 7365 6c66 2c0a 2020 2020 2020 2020 7365  self,.        se
+0000bae0: 6e64 6572 3a20 752e 5573 6572 2c0a 2020  nder: u.User,.  
+0000baf0: 2020 2020 2020 6572 723a 2045 7863 6570        err: Excep
+0000bb00: 7469 6f6e 2c0a 2020 2020 2020 2020 6576  tion,.        ev
+0000bb10: 656e 745f 6964 3a20 4576 656e 7449 442c  ent_id: EventID,
+0000bb20: 0a20 2020 2020 2020 2065 7665 6e74 5f74  .        event_t
+0000bb30: 7970 653a 2045 7665 6e74 5479 7065 2c0a  ype: EventType,.
+0000bb40: 2020 2020 2020 2020 6d65 7373 6167 655f          message_
+0000bb50: 7479 7065 3a20 4d65 7373 6167 6554 7970  type: MessageTyp
+0000bb60: 6520 7c20 4e6f 6e65 203d 204e 6f6e 652c  e | None = None,
+0000bb70: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+0000bb80: 2020 2020 2020 2020 7365 6e64 6572 2e73          sender.s
+0000bb90: 656e 645f 7265 6d6f 7465 5f63 6865 636b  end_remote_check
+0000bba0: 706f 696e 7428 0a20 2020 2020 2020 2020  point(.         
+0000bbb0: 2020 2073 656c 662e 5f73 7461 7475 735f     self._status_
+0000bbc0: 6672 6f6d 5f65 7863 6570 7469 6f6e 2865  from_exception(e
+0000bbd0: 7272 292c 0a20 2020 2020 2020 2020 2020  rr),.           
+0000bbe0: 2065 7665 6e74 5f69 642c 0a20 2020 2020   event_id,.     
+0000bbf0: 2020 2020 2020 2073 656c 662e 6d78 6964         self.mxid
+0000bc00: 2c0a 2020 2020 2020 2020 2020 2020 6576  ,.            ev
+0000bc10: 656e 745f 7479 7065 2c0a 2020 2020 2020  ent_type,.      
+0000bc20: 2020 2020 2020 6d65 7373 6167 655f 7479        message_ty
+0000bc30: 7065 3d6d 6573 7361 6765 5f74 7970 652c  pe=message_type,
+0000bc40: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+0000bc50: 6f72 3d65 7272 2c0a 2020 2020 2020 2020  or=err,.        
+0000bc60: 290a 0a20 2020 2020 2020 2073 656e 645f  )..        send_
+0000bc70: 6e6f 7469 6365 203d 206e 6f74 2069 7369  notice = not isi
+0000bc80: 6e73 7461 6e63 6528 6572 722c 204e 6f74  nstance(err, Not
+0000bc90: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+0000bca0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0000bcb0: 662e 636f 6e66 6967 5b22 6272 6964 6765  f.config["bridge
+0000bcc0: 2e64 656c 6976 6572 795f 6572 726f 725f  .delivery_error_
+0000bcd0: 7265 706f 7274 7322 5d20 616e 6420 7365  reports"] and se
+0000bce0: 6e64 5f6e 6f74 6963 653a 0a20 2020 2020  nd_notice:.     
+0000bcf0: 2020 2020 2020 2065 7665 6e74 5f74 7970         event_typ
+0000bd00: 655f 7374 7220 3d20 7b0a 2020 2020 2020  e_str = {.      
+0000bd10: 2020 2020 2020 2020 2020 4576 656e 7454            EventT
+0000bd20: 7970 652e 5245 4143 5449 4f4e 3a20 2272  ype.REACTION: "r
+0000bd30: 6561 6374 696f 6e22 2c0a 2020 2020 2020  eaction",.      
+0000bd40: 2020 2020 2020 2020 2020 4576 656e 7454            EventT
+0000bd50: 7970 652e 524f 4f4d 5f52 4544 4143 5449  ype.ROOM_REDACTI
+0000bd60: 4f4e 3a20 2272 6564 6163 7469 6f6e 222c  ON: "redaction",
+0000bd70: 0a20 2020 2020 2020 2020 2020 207d 2e67  .            }.g
+0000bd80: 6574 2865 7665 6e74 5f74 7970 652c 2022  et(event_type, "
+0000bd90: 6d65 7373 6167 6522 290a 2020 2020 2020  message").      
+0000bda0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+0000bdb0: 2e5f 7365 6e64 5f6d 6573 7361 6765 280a  ._send_message(.
+0000bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdd0: 7365 6c66 2e6d 6169 6e5f 696e 7465 6e74  self.main_intent
+0000bde0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000bdf0: 2020 5465 7874 4d65 7373 6167 6545 7665    TextMessageEve
+0000be00: 6e74 436f 6e74 656e 7428 0a20 2020 2020  ntContent(.     
+0000be10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000be20: 7367 7479 7065 3d4d 6573 7361 6765 5479  sgtype=MessageTy
+0000be30: 7065 2e4e 4f54 4943 452c 0a20 2020 2020  pe.NOTICE,.     
+0000be40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000be50: 6f64 793d 6622 5c75 3236 6130 2059 6f75  ody=f"\u26a0 You
+0000be60: 7220 7b65 7665 6e74 5f74 7970 655f 7374  r {event_type_st
+0000be70: 727d 206d 6179 206e 6f74 2068 6176 6520  r} may not have 
+0000be80: 6265 656e 2062 7269 6467 6564 3a20 7b73  been bridged: {s
+0000be90: 7472 2865 7272 297d 222c 0a20 2020 2020  tr(err)}",.     
+0000bea0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0000beb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000bec0: 2020 2020 6261 636b 6772 6f75 6e64 5f74      background_t
+0000bed0: 6173 6b2e 6372 6561 7465 2873 656c 662e  ask.create(self.
+0000bee0: 5f73 656e 645f 6d65 7373 6167 655f 7374  _send_message_st
+0000bef0: 6174 7573 2865 7665 6e74 5f69 642c 2065  atus(event_id, e
+0000bf00: 7272 2929 0a0a 2020 2020 6173 796e 6320  rr))..    async 
+0000bf10: 6465 6620 5f73 656e 645f 6d65 7373 6167  def _send_messag
+0000bf20: 655f 7374 6174 7573 2873 656c 662c 2065  e_status(self, e
+0000bf30: 7665 6e74 5f69 643a 2045 7665 6e74 4944  vent_id: EventID
+0000bf40: 2c20 6572 723a 2045 7863 6570 7469 6f6e  , err: Exception
+0000bf50: 207c 204e 6f6e 6529 202d 3e20 4e6f 6e65   | None) -> None
+0000bf60: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+0000bf70: 2073 656c 662e 636f 6e66 6967 5b22 6272   self.config["br
+0000bf80: 6964 6765 2e6d 6573 7361 6765 5f73 7461  idge.message_sta
+0000bf90: 7475 735f 6576 656e 7473 225d 3a0a 2020  tus_events"]:.  
+0000bfa0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000bfb0: 0a20 2020 2020 2020 2069 6e74 656e 7420  .        intent 
+0000bfc0: 3d20 7365 6c66 2e61 7a2e 696e 7465 6e74  = self.az.intent
+0000bfd0: 2069 6620 7365 6c66 2e65 6e63 7279 7074   if self.encrypt
+0000bfe0: 6564 2065 6c73 6520 7365 6c66 2e6d 6169  ed else self.mai
+0000bff0: 6e5f 696e 7465 6e74 0a20 2020 2020 2020  n_intent.       
+0000c000: 2073 7461 7475 7320 3d20 4265 6570 6572   status = Beeper
+0000c010: 4d65 7373 6167 6553 7461 7475 7345 7665  MessageStatusEve
+0000c020: 6e74 436f 6e74 656e 7428 0a20 2020 2020  ntContent(.     
+0000c030: 2020 2020 2020 206e 6574 776f 726b 3d73         network=s
+0000c040: 656c 662e 6272 6964 6765 5f69 6e66 6f5f  elf.bridge_info_
+0000c050: 7374 6174 655f 6b65 792c 0a20 2020 2020  state_key,.     
+0000c060: 2020 2020 2020 2072 656c 6174 6573 5f74         relates_t
+0000c070: 6f3d 5265 6c61 7465 7354 6f28 0a20 2020  o=RelatesTo(.   
+0000c080: 2020 2020 2020 2020 2020 2020 2072 656c               rel
+0000c090: 5f74 7970 653d 5265 6c61 7469 6f6e 5479  _type=RelationTy
+0000c0a0: 7065 2e52 4546 4552 454e 4345 2c0a 2020  pe.REFERENCE,.  
+0000c0b0: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+0000c0c0: 656e 745f 6964 3d65 7665 6e74 5f69 642c  ent_id=event_id,
+0000c0d0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0000c0e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000c0f0: 2020 6966 2065 7272 3a0a 2020 2020 2020    if err:.      
+0000c100: 2020 2020 2020 7374 6174 7573 2e73 7461        status.sta
+0000c110: 7475 7320 3d20 4d65 7373 6167 6553 7461  tus = MessageSta
+0000c120: 7475 732e 5245 5452 4941 424c 450a 2020  tus.RETRIABLE.  
+0000c130: 2020 2020 2020 2020 2020 7374 6174 7573            status
+0000c140: 2e72 6561 736f 6e20 3d20 4d65 7373 6167  .reason = Messag
+0000c150: 6553 7461 7475 7352 6561 736f 6e2e 4745  eStatusReason.GE
+0000c160: 4e45 5249 435f 4552 524f 520a 2020 2020  NERIC_ERROR.    
+0000c170: 2020 2020 2020 2020 7374 6174 7573 2e65          status.e
+0000c180: 7272 6f72 203d 2073 7472 2865 7272 290a  rror = str(err).
+0000c190: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000c1a0: 7369 6e73 7461 6e63 6528 6572 722c 204e  sinstance(err, N
+0000c1b0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+0000c1c0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0000c1d0: 2020 2020 2073 7461 7475 732e 7374 6174       status.stat
+0000c1e0: 7573 203d 204d 6573 7361 6765 5374 6174  us = MessageStat
+0000c1f0: 7573 2e46 4149 4c0a 2020 2020 2020 2020  us.FAIL.        
+0000c200: 2020 2020 2020 2020 7374 6174 7573 2e72          status.r
+0000c210: 6561 736f 6e20 3d20 4d65 7373 6167 6553  eason = MessageS
+0000c220: 7461 7475 7352 6561 736f 6e2e 554e 5355  tatusReason.UNSU
+0000c230: 5050 4f52 5445 440a 2020 2020 2020 2020  PPORTED.        
+0000c240: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000c250: 2020 7374 6174 7573 2e73 7461 7475 7320    status.status 
+0000c260: 3d20 4d65 7373 6167 6553 7461 7475 732e  = MessageStatus.
+0000c270: 5355 4343 4553 530a 0a20 2020 2020 2020  SUCCESS..       
+0000c280: 2061 7761 6974 2069 6e74 656e 742e 7365   await intent.se
+0000c290: 6e64 5f6d 6573 7361 6765 5f65 7665 6e74  nd_message_event
+0000c2a0: 280a 2020 2020 2020 2020 2020 2020 726f  (.            ro
+0000c2b0: 6f6d 5f69 643d 7365 6c66 2e6d 7869 642c  om_id=self.mxid,
+0000c2c0: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+0000c2d0: 6e74 5f74 7970 653d 4576 656e 7454 7970  nt_type=EventTyp
+0000c2e0: 652e 4245 4550 4552 5f4d 4553 5341 4745  e.BEEPER_MESSAGE
+0000c2f0: 5f53 5441 5455 532c 0a20 2020 2020 2020  _STATUS,.       
+0000c300: 2020 2020 2063 6f6e 7465 6e74 3d73 7461       content=sta
+0000c310: 7475 732c 0a20 2020 2020 2020 2029 0a0a  tus,.        )..
+0000c320: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0000c330: 640a 2020 2020 6465 6620 5f73 7461 7475  d.    def _statu
+0000c340: 735f 6672 6f6d 5f65 7863 6570 7469 6f6e  s_from_exception
+0000c350: 2865 3a20 4578 6365 7074 696f 6e29 202d  (e: Exception) -
+0000c360: 3e20 4d65 7373 6167 6553 656e 6443 6865  > MessageSendChe
+0000c370: 636b 706f 696e 7453 7461 7475 733a 0a20  ckpointStatus:. 
+0000c380: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000c390: 616e 6365 2865 2c20 4e6f 7449 6d70 6c65  ance(e, NotImple
+0000c3a0: 6d65 6e74 6564 4572 726f 7229 3a0a 2020  mentedError):.  
+0000c3b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c3c0: 204d 6573 7361 6765 5365 6e64 4368 6563   MessageSendChec
+0000c3d0: 6b70 6f69 6e74 5374 6174 7573 2e55 4e53  kpointStatus.UNS
+0000c3e0: 5550 504f 5254 4544 0a20 2020 2020 2020  UPPORTED.       
+0000c3f0: 2072 6574 7572 6e20 4d65 7373 6167 6553   return MessageS
+0000c400: 656e 6443 6865 636b 706f 696e 7453 7461  endCheckpointSta
+0000c410: 7475 732e 5045 524d 5f46 4149 4c55 5245  tus.PERM_FAILURE
+0000c420: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+0000c430: 6861 6e64 6c65 5f6d 6174 7269 785f 6d65  handle_matrix_me
+0000c440: 7373 6167 6528 0a20 2020 2020 2020 2073  ssage(.        s
+0000c450: 656c 662c 2073 656e 6465 723a 2075 2e55  elf, sender: u.U
+0000c460: 7365 722c 206d 6573 7361 6765 3a20 4d65  ser, message: Me
+0000c470: 7373 6167 6545 7665 6e74 436f 6e74 656e  ssageEventConten
+0000c480: 742c 2065 7665 6e74 5f69 643a 2045 7665  t, event_id: Eve
+0000c490: 6e74 4944 0a20 2020 2029 202d 3e20 4e6f  ntID.    ) -> No
+0000c4a0: 6e65 3a0a 2020 2020 2020 2020 7472 793a  ne:.        try:
+0000c4b0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0000c4c0: 6974 2073 656c 662e 5f68 616e 646c 655f  it self._handle_
+0000c4d0: 6d61 7472 6978 5f6d 6573 7361 6765 2873  matrix_message(s
+0000c4e0: 656e 6465 722c 206d 6573 7361 6765 2c20  ender, message, 
+0000c4f0: 6576 656e 745f 6964 290a 2020 2020 2020  event_id).      
+0000c500: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0000c510: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0000c520: 2020 2020 2073 656c 662e 6c6f 672e 6578       self.log.ex
+0000c530: 6365 7074 696f 6e28 6622 4661 696c 6564  ception(f"Failed
+0000c540: 2074 6f20 6861 6e64 6c65 204d 6174 7269   to handle Matri
+0000c550: 7820 6576 656e 7420 7b65 7665 6e74 5f69  x event {event_i
+0000c560: 647d 2229 0a20 2020 2020 2020 2020 2020  d}").           
+0000c570: 2061 7761 6974 2073 656c 662e 5f73 656e   await self._sen
+0000c580: 645f 6272 6964 6765 5f65 7272 6f72 280a  d_bridge_error(.
+0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5a0: 7365 6e64 6572 2c20 652c 2065 7665 6e74  sender, e, event
+0000c5b0: 5f69 642c 2045 7665 6e74 5479 7065 2e52  _id, EventType.R
+0000c5c0: 4f4f 4d5f 4d45 5353 4147 452c 206d 6573  OOM_MESSAGE, mes
+0000c5d0: 7361 6765 2e6d 7367 7479 7065 0a20 2020  sage.msgtype.   
+0000c5e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000c5f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000c600: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+0000c610: 5f73 656e 645f 6272 6964 6765 5f73 7563  _send_bridge_suc
+0000c620: 6365 7373 280a 2020 2020 2020 2020 2020  cess(.          
+0000c630: 2020 2020 2020 7365 6e64 6572 2c20 6576        sender, ev
+0000c640: 656e 745f 6964 2c20 4576 656e 7454 7970  ent_id, EventTyp
+0000c650: 652e 524f 4f4d 5f4d 4553 5341 4745 2c20  e.ROOM_MESSAGE, 
+0000c660: 6d65 7373 6167 652e 6d73 6774 7970 650a  message.msgtype.
+0000c670: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000c680: 2020 2061 7379 6e63 2064 6566 205f 6861     async def _ha
+0000c690: 6e64 6c65 5f6d 6174 7269 785f 6d65 7373  ndle_matrix_mess
+0000c6a0: 6167 6528 0a20 2020 2020 2020 2073 656c  age(.        sel
+0000c6b0: 662c 206f 7269 675f 7365 6e64 6572 3a20  f, orig_sender: 
+0000c6c0: 752e 5573 6572 2c20 6d65 7373 6167 653a  u.User, message:
+0000c6d0: 204d 6573 7361 6765 4576 656e 7443 6f6e   MessageEventCon
+0000c6e0: 7465 6e74 2c20 6576 656e 745f 6964 3a20  tent, event_id: 
+0000c6f0: 4576 656e 7449 440a 2020 2020 2920 2d3e  EventID.    ) ->
+0000c700: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0000c710: 6620 6d65 7373 6167 652e 6765 745f 6564  f message.get_ed
+0000c720: 6974 2829 3a0a 2020 2020 2020 2020 2020  it():.          
+0000c730: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+0000c740: 6d65 6e74 6564 4572 726f 7228 2245 6469  mentedError("Edi
+0000c750: 7473 2061 7265 206e 6f74 2073 7570 706f  ts are not suppo
+0000c760: 7274 6564 2062 7920 7468 6520 4661 6365  rted by the Face
+0000c770: 626f 6f6b 2062 7269 6467 652e 2229 0a20  book bridge."). 
+0000c780: 2020 2020 2020 2073 656e 6465 722c 2069         sender, i
+0000c790: 735f 7265 6c61 7920 3d20 6177 6169 7420  s_relay = await 
+0000c7a0: 7365 6c66 2e67 6574 5f72 656c 6179 5f73  self.get_relay_s
+0000c7b0: 656e 6465 7228 6f72 6967 5f73 656e 6465  ender(orig_sende
+0000c7c0: 722c 2066 226d 6573 7361 6765 207b 6576  r, f"message {ev
+0000c7d0: 656e 745f 6964 7d22 290a 2020 2020 2020  ent_id}").      
+0000c7e0: 2020 6966 206e 6f74 2073 656e 6465 723a    if not sender:
+0000c7f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000c800: 7365 2045 7863 6570 7469 6f6e 2822 6e6f  se Exception("no
+0000c810: 7420 6c6f 6767 6564 2069 6e22 290a 2020  t logged in").  
+0000c820: 2020 2020 2020 656c 6966 206e 6f74 2073        elif not s
+0000c830: 656e 6465 722e 6d71 7474 3a0a 2020 2020  ender.mqtt:.    
+0000c840: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0000c850: 6365 7074 696f 6e28 226e 6f74 2063 6f6e  ception("not con
+0000c860: 6e65 6374 6564 2074 6f20 4d51 5454 2229  nected to MQTT")
+0000c870: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+0000c880: 5f72 656c 6179 3a0a 2020 2020 2020 2020  _relay:.        
+0000c890: 2020 2020 6177 6169 7420 7365 6c66 2e61      await self.a
+0000c8a0: 7070 6c79 5f72 656c 6179 5f6d 6573 7361  pply_relay_messa
+0000c8b0: 6765 5f66 6f72 6d61 7428 6f72 6967 5f73  ge_format(orig_s
+0000c8c0: 656e 6465 722c 206d 6573 7361 6765 290a  ender, message).
+0000c8d0: 2020 2020 2020 2020 6966 206d 6573 7361          if messa
+0000c8e0: 6765 2e6d 7367 7479 7065 203d 3d20 4d65  ge.msgtype == Me
+0000c8f0: 7373 6167 6554 7970 652e 5445 5854 206f  ssageType.TEXT o
+0000c900: 7220 6d65 7373 6167 652e 6d73 6774 7970  r message.msgtyp
+0000c910: 6520 3d3d 204d 6573 7361 6765 5479 7065  e == MessageType
+0000c920: 2e4e 4f54 4943 453a 0a20 2020 2020 2020  .NOTICE:.       
+0000c930: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+0000c940: 5f68 616e 646c 655f 6d61 7472 6978 5f74  _handle_matrix_t
+0000c950: 6578 7428 6576 656e 745f 6964 2c20 7365  ext(event_id, se
+0000c960: 6e64 6572 2c20 6d65 7373 6167 6529 0a20  nder, message). 
+0000c970: 2020 2020 2020 2065 6c69 6620 6d65 7373         elif mess
+0000c980: 6167 652e 6d73 6774 7970 652e 6973 5f6d  age.msgtype.is_m
+0000c990: 6564 6961 3a0a 2020 2020 2020 2020 2020  edia:.          
+0000c9a0: 2020 6177 6169 7420 7365 6c66 2e5f 6861    await self._ha
+0000c9b0: 6e64 6c65 5f6d 6174 7269 785f 6d65 6469  ndle_matrix_medi
+0000c9c0: 6128 6576 656e 745f 6964 2c20 7365 6e64  a(event_id, send
+0000c9d0: 6572 2c20 6d65 7373 6167 652c 2069 735f  er, message, is_
+0000c9e0: 7265 6c61 7929 0a20 2020 2020 2020 2065  relay).        e
+0000c9f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000ca00: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+0000ca10: 656e 7465 6445 7272 6f72 2866 2255 6e73  entedError(f"Uns
+0000ca20: 7570 706f 7274 6564 206d 6573 7361 6765  upported message
+0000ca30: 2074 7970 6520 7b6d 6573 7361 6765 2e6d   type {message.m
+0000ca40: 7367 7479 7065 7d22 290a 0a20 2020 2061  sgtype}")..    a
+0000ca50: 7379 6e63 2064 6566 205f 6d61 6b65 5f64  sync def _make_d
+0000ca60: 626d 2873 656c 662c 2073 656e 6465 723a  bm(self, sender:
+0000ca70: 2075 2e55 7365 722c 2065 7665 6e74 5f69   u.User, event_i
+0000ca80: 643a 2045 7665 6e74 4944 2920 2d3e 2044  d: EventID) -> D
+0000ca90: 424d 6573 7361 6765 3a0a 2020 2020 2020  BMessage:.      
+0000caa0: 2020 6f74 6920 3d20 7365 6e64 6572 2e6d    oti = sender.m
+0000cab0: 7174 742e 6765 6e65 7261 7465 5f6f 6666  qtt.generate_off
+0000cac0: 6c69 6e65 5f74 6872 6561 6469 6e67 5f69  line_threading_i
+0000cad0: 6428 290a 2020 2020 2020 2020 6462 6d20  d().        dbm 
+0000cae0: 3d20 4442 4d65 7373 6167 6528 0a20 2020  = DBMessage(.   
+0000caf0: 2020 2020 2020 2020 206d 7869 643d 6576           mxid=ev
+0000cb00: 656e 745f 6964 2c0a 2020 2020 2020 2020  ent_id,.        
+0000cb10: 2020 2020 6d78 5f72 6f6f 6d3d 7365 6c66      mx_room=self
+0000cb20: 2e6d 7869 642c 0a20 2020 2020 2020 2020  .mxid,.         
+0000cb30: 2020 2066 625f 7478 6e5f 6964 3d6f 7469     fb_txn_id=oti
+0000cb40: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+0000cb50: 6465 783d 302c 0a20 2020 2020 2020 2020  dex=0,.         
+0000cb60: 2020 2066 625f 6368 6174 3d73 656c 662e     fb_chat=self.
+0000cb70: 6662 6964 2c0a 2020 2020 2020 2020 2020  fbid,.          
+0000cb80: 2020 6662 5f72 6563 6569 7665 723d 7365    fb_receiver=se
+0000cb90: 6c66 2e66 625f 7265 6365 6976 6572 2c0a  lf.fb_receiver,.
+0000cba0: 2020 2020 2020 2020 2020 2020 6662 5f73              fb_s
+0000cbb0: 656e 6465 723d 7365 6e64 6572 2e66 6269  ender=sender.fbi
+0000cbc0: 642c 0a20 2020 2020 2020 2020 2020 2074  d,.            t
+0000cbd0: 696d 6573 7461 6d70 3d69 6e74 2874 696d  imestamp=int(tim
+0000cbe0: 652e 7469 6d65 2829 202a 2031 3030 3029  e.time() * 1000)
+0000cbf0: 2c0a 2020 2020 2020 2020 2020 2020 6662  ,.            fb
+0000cc00: 6964 3d4e 6f6e 652c 0a20 2020 2020 2020  id=None,.       
+0000cc10: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0000cc20: 5f6f 7469 5f64 6564 7570 5b6f 7469 5d20  _oti_dedup[oti] 
+0000cc30: 3d20 6462 6d0a 2020 2020 2020 2020 6177  = dbm.        aw
+0000cc40: 6169 7420 6462 6d2e 696e 7365 7274 2829  ait dbm.insert()
+0000cc50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cc60: 6462 6d0a 0a20 2020 2061 7379 6e63 2064  dbm..    async d
+0000cc70: 6566 205f 6861 6e64 6c65 5f6d 6174 7269  ef _handle_matri
+0000cc80: 785f 7465 7874 280a 2020 2020 2020 2020  x_text(.        
+0000cc90: 7365 6c66 2c20 6576 656e 745f 6964 3a20  self, event_id: 
+0000cca0: 4576 656e 7449 442c 2073 656e 6465 723a  EventID, sender:
+0000ccb0: 2075 2e55 7365 722c 206d 6573 7361 6765   u.User, message
+0000ccc0: 3a20 5465 7874 4d65 7373 6167 6545 7665  : TextMessageEve
+0000ccd0: 6e74 436f 6e74 656e 740a 2020 2020 2920  ntContent.    ) 
+0000cce0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000ccf0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+0000cd00: 2020 6d65 7373 6167 652e 6d73 6774 7970    message.msgtyp
+0000cd10: 6520 3d3d 204d 6573 7361 6765 5479 7065  e == MessageType
+0000cd20: 2e4e 4f54 4943 450a 2020 2020 2020 2020  .NOTICE.        
+0000cd30: 2020 2020 616e 6420 6e6f 7420 7365 6c66      and not self
+0000cd40: 2e63 6f6e 6669 675b 2262 7269 6467 652e  .config["bridge.
+0000cd50: 6272 6964 6765 5f6d 6174 7269 785f 6e6f  bridge_matrix_no
+0000cd60: 7469 6365 7322 5d0a 2020 2020 2020 2020  tices"].        
+0000cd70: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000cd80: 6574 7572 6e0a 2020 2020 2020 2020 636f  eturn.        co
+0000cd90: 6e76 6572 7465 6420 3d20 6177 6169 7420  nverted = await 
+0000cda0: 6d61 7472 6978 5f74 6f5f 6661 6365 626f  matrix_to_facebo
+0000cdb0: 6f6b 286d 6573 7361 6765 2c20 7365 6c66  ok(message, self
+0000cdc0: 2e6d 7869 642c 2073 656c 662e 6c6f 6729  .mxid, self.log)
+0000cdd0: 0a20 2020 2020 2020 2064 626d 203d 2061  .        dbm = a
+0000cde0: 7761 6974 2073 656c 662e 5f6d 616b 655f  wait self._make_
+0000cdf0: 6462 6d28 7365 6e64 6572 2c20 6576 656e  dbm(sender, even
+0000ce00: 745f 6964 290a 0a20 2020 2020 2020 2072  t_id)..        r
+0000ce10: 6573 7020 3d20 6177 6169 7420 7365 6e64  esp = await send
+0000ce20: 6572 2e6d 7174 742e 7365 6e64 5f6d 6573  er.mqtt.send_mes
+0000ce30: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
+0000ce40: 2020 7365 6c66 2e66 6269 642c 0a20 2020    self.fbid,.   
+0000ce50: 2020 2020 2020 2020 2073 656c 662e 6662           self.fb
+0000ce60: 5f74 7970 6520 213d 2054 6872 6561 6454  _type != ThreadT
+0000ce70: 7970 652e 5553 4552 2c0a 2020 2020 2020  ype.USER,.      
+0000ce80: 2020 2020 2020 6d65 7373 6167 653d 636f        message=co
+0000ce90: 6e76 6572 7465 642e 7465 7874 2c0a 2020  nverted.text,.  
+0000cea0: 2020 2020 2020 2020 2020 6d65 6e74 696f            mentio
+0000ceb0: 6e73 3d63 6f6e 7665 7274 6564 2e6d 656e  ns=converted.men
+0000cec0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000ced0: 2020 2072 6570 6c79 5f74 6f3d 636f 6e76     reply_to=conv
+0000cee0: 6572 7465 642e 7265 706c 795f 746f 2c0a  erted.reply_to,.
+0000cef0: 2020 2020 2020 2020 2020 2020 6f66 666c              offl
+0000cf00: 696e 655f 7468 7265 6164 696e 675f 6964  ine_threading_id
+0000cf10: 3d64 626d 2e66 625f 7478 6e5f 6964 2c0a  =dbm.fb_txn_id,.
+0000cf20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000cf30: 2020 6966 206e 6f74 2072 6573 702e 7375    if not resp.su
+0000cf40: 6363 6573 7320 616e 6420 7265 7370 2e65  ccess and resp.e
+0000cf50: 7272 6f72 5f6d 6573 7361 6765 3a0a 2020  rror_message:.  
+0000cf60: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0000cf70: 6f67 2e64 6562 7567 2866 2245 7272 6f72  og.debug(f"Error
+0000cf80: 2068 616e 646c 696e 6720 4d61 7472 6978   handling Matrix
+0000cf90: 206d 6573 7361 6765 207b 6576 656e 745f   message {event_
+0000cfa0: 6964 7d3a 207b 7265 7370 2e65 7272 6f72  id}: {resp.error
+0000cfb0: 5f6d 6573 7361 6765 7d22 290a 2020 2020  _message}").    
+0000cfc0: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0000cfd0: 6365 7074 696f 6e28 7265 7370 2e65 7272  ception(resp.err
+0000cfe0: 6f72 5f6d 6573 7361 6765 290a 2020 2020  or_message).    
+0000cff0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000d000: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
+0000d010: 6562 7567 2866 2248 616e 646c 6564 204d  ebug(f"Handled M
+0000d020: 6174 7269 7820 6d65 7373 6167 6520 7b65  atrix message {e
+0000d030: 7665 6e74 5f69 647d 202d 3e20 4f54 493a  vent_id} -> OTI:
+0000d040: 207b 6462 6d2e 6662 5f74 786e 5f69 647d   {dbm.fb_txn_id}
+0000d050: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
+0000d060: 6620 5f68 616e 646c 655f 6d61 7472 6978  f _handle_matrix
+0000d070: 5f6d 6564 6961 280a 2020 2020 2020 2020  _media(.        
+0000d080: 7365 6c66 2c20 6576 656e 745f 6964 3a20  self, event_id: 
+0000d090: 4576 656e 7449 442c 2073 656e 6465 723a  EventID, sender:
+0000d0a0: 2075 2e55 7365 722c 206d 6573 7361 6765   u.User, message
+0000d0b0: 3a20 4d65 6469 614d 6573 7361 6765 4576  : MediaMessageEv
+0000d0c0: 656e 7443 6f6e 7465 6e74 2c20 6973 5f72  entContent, is_r
+0000d0d0: 656c 6179 3a20 626f 6f6c 0a20 2020 2029  elay: bool.    )
+0000d0e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000d0f0: 2020 6966 206d 6573 7361 6765 2e66 696c    if message.fil
+0000d100: 6520 616e 6420 6465 6372 7970 745f 6174  e and decrypt_at
+0000d110: 7461 6368 6d65 6e74 3a0a 2020 2020 2020  tachment:.      
+0000d120: 2020 2020 2020 6461 7461 203d 2061 7761        data = awa
+0000d130: 6974 2073 656c 662e 6d61 696e 5f69 6e74  it self.main_int
+0000d140: 656e 742e 646f 776e 6c6f 6164 5f6d 6564  ent.download_med
+0000d150: 6961 286d 6573 7361 6765 2e66 696c 652e  ia(message.file.
+0000d160: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
+0000d170: 2064 6174 6120 3d20 6465 6372 7970 745f   data = decrypt_
+0000d180: 6174 7461 6368 6d65 6e74 280a 2020 2020  attachment(.    
+0000d190: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000d1a0: 2c20 6d65 7373 6167 652e 6669 6c65 2e6b  , message.file.k
+0000d1b0: 6579 2e6b 6579 2c20 6d65 7373 6167 652e  ey.key, message.
+0000d1c0: 6669 6c65 2e68 6173 6865 732e 6765 7428  file.hashes.get(
+0000d1d0: 2273 6861 3235 3622 292c 206d 6573 7361  "sha256"), messa
+0000d1e0: 6765 2e66 696c 652e 6976 0a20 2020 2020  ge.file.iv.     
+0000d1f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000d200: 2065 6c69 6620 6d65 7373 6167 652e 7572   elif message.ur
+0000d210: 6c3a 0a20 2020 2020 2020 2020 2020 2064  l:.            d
+0000d220: 6174 6120 3d20 6177 6169 7420 7365 6c66  ata = await self
+0000d230: 2e6d 6169 6e5f 696e 7465 6e74 2e64 6f77  .main_intent.dow
+0000d240: 6e6c 6f61 645f 6d65 6469 6128 6d65 7373  nload_media(mess
+0000d250: 6167 652e 7572 6c29 0a20 2020 2020 2020  age.url).       
+0000d260: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000d270: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+0000d280: 656d 656e 7465 6445 7272 6f72 2822 4e6f  ementedError("No
+0000d290: 2066 696c 6520 6f72 2055 524c 2073 7065   file or URL spe
+0000d2a0: 6369 6669 6564 2229 0a20 2020 2020 2020  cified").       
+0000d2b0: 206d 696d 6520 3d20 6d65 7373 6167 652e   mime = message.
+0000d2c0: 696e 666f 2e6d 696d 6574 7970 6520 6f72  info.mimetype or
+0000d2d0: 206d 6167 6963 2e6d 696d 6574 7970 6528   magic.mimetype(
+0000d2e0: 6461 7461 290a 2020 2020 2020 2020 6462  data).        db
+0000d2f0: 6d20 3d20 6177 6169 7420 7365 6c66 2e5f  m = await self._
+0000d300: 6d61 6b65 5f64 626d 2873 656e 6465 722c  make_dbm(sender,
+0000d310: 2065 7665 6e74 5f69 6429 0a20 2020 2020   event_id).     
+0000d320: 2020 2072 6570 6c79 5f74 6f20 3d20 4e6f     reply_to = No
+0000d330: 6e65 0a20 2020 2020 2020 2072 6570 6c79  ne.        reply
+0000d340: 5f74 6f5f 6d78 6964 203d 206d 6573 7361  _to_mxid = messa
+0000d350: 6765 2e67 6574 5f72 6570 6c79 5f74 6f28  ge.get_reply_to(
+0000d360: 290a 2020 2020 2020 2020 6966 2072 6570  ).        if rep
+0000d370: 6c79 5f74 6f5f 6d78 6964 3a0a 2020 2020  ly_to_mxid:.    
+0000d380: 2020 2020 2020 2020 7265 706c 795f 746f          reply_to
+0000d390: 5f6d 7367 203d 2061 7761 6974 2044 424d  _msg = await DBM
+0000d3a0: 6573 7361 6765 2e67 6574 5f62 795f 6d78  essage.get_by_mx
+0000d3b0: 6964 2872 6570 6c79 5f74 6f5f 6d78 6964  id(reply_to_mxid
+0000d3c0: 2c20 7365 6c66 2e6d 7869 6429 0a20 2020  , self.mxid).   
+0000d3d0: 2020 2020 2020 2020 2069 6620 7265 706c           if repl
+0000d3e0: 795f 746f 5f6d 7367 3a0a 2020 2020 2020  y_to_msg:.      
+0000d3f0: 2020 2020 2020 2020 2020 7265 706c 795f            reply_
+0000d400: 746f 203d 2072 6570 6c79 5f74 6f5f 6d73  to = reply_to_ms
+0000d410: 672e 6662 6964 0a20 2020 2020 2020 2020  g.fbid.         
+0000d420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000d430: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0000d440: 672e 7761 726e 696e 6728 0a20 2020 2020  g.warning(.     
+0000d450: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000d460: 2243 6f75 6c64 6e27 7420 6669 6e64 2072  "Couldn't find r
+0000d470: 6570 6c79 2074 6172 6765 7420 7b72 6570  eply target {rep
+0000d480: 6c79 5f74 6f5f 6d78 6964 7d22 0a20 2020  ly_to_mxid}".   
+0000d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4a0: 2022 2074 6f20 6272 6964 6765 206d 6564   " to bridge med
+0000d4b0: 6961 206d 6573 7361 6765 2072 6570 6c79  ia message reply
+0000d4c0: 206d 6574 6164 6174 6120 746f 2046 6163   metadata to Fac
+0000d4d0: 6562 6f6f 6b22 0a20 2020 2020 2020 2020  ebook".         
+0000d4e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000d4f0: 2066 696c 656e 616d 6520 3d20 6d65 7373   filename = mess
+0000d500: 6167 652e 626f 6479 0a20 2020 2020 2020  age.body.       
+0000d510: 2069 6620 6973 5f72 656c 6179 3a0a 2020   if is_relay:.  
+0000d520: 2020 2020 2020 2020 2020 6361 7074 696f            captio
+0000d530: 6e20 3d20 2861 7761 6974 206d 6174 7269  n = (await matri
+0000d540: 785f 746f 5f66 6163 6562 6f6f 6b28 6d65  x_to_facebook(me
+0000d550: 7373 6167 652c 2073 656c 662e 6d78 6964  ssage, self.mxid
+0000d560: 2c20 7365 6c66 2e6c 6f67 2929 2e74 6578  , self.log)).tex
+0000d570: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
+0000d580: 2020 2020 2020 2020 2020 2020 6361 7074              capt
+0000d590: 696f 6e20 3d20 4e6f 6e65 0a20 2020 2020  ion = None.     
+0000d5a0: 2020 2069 6620 6d65 7373 6167 652e 6d73     if message.ms
+0000d5b0: 6774 7970 6520 3d3d 204d 6573 7361 6765  gtype == Message
+0000d5c0: 5479 7065 2e41 5544 494f 3a0a 2020 2020  Type.AUDIO:.    
+0000d5d0: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
+0000d5e0: 696d 652e 7374 6172 7473 7769 7468 2822  ime.startswith("
+0000d5f0: 6175 6469 6f2f 6d70 2229 3a0a 2020 2020  audio/mp"):.    
+0000d600: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000d610: 203d 2061 7761 6974 2066 666d 7065 672e   = await ffmpeg.
+0000d620: 636f 6e76 6572 745f 6279 7465 7328 0a20  convert_bytes(. 
+0000d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d640: 2020 2064 6174 612c 0a20 2020 2020 2020     data,.       
+0000d650: 2020 2020 2020 2020 2020 2020 206f 7574               out
+0000d660: 7075 745f 6578 7465 6e73 696f 6e3d 222e  put_extension=".
+0000d670: 6d34 6122 2c0a 2020 2020 2020 2020 2020  m4a",.          
+0000d680: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000d690: 5f61 7267 733d 2822 2d63 3a61 222c 2022  _args=("-c:a", "
+0000d6a0: 6161 6322 292c 0a20 2020 2020 2020 2020  aac"),.         
+0000d6b0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0000d6c0: 5f6d 696d 653d 6d69 6d65 2c0a 2020 2020  _mime=mime,.    
+0000d6d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000d6e0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0000d6f0: 6d65 203d 2022 6175 6469 6f2f 6d70 6567  me = "audio/mpeg
+0000d700: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000d710: 2020 6669 6c65 6e61 6d65 203d 2022 6175    filename = "au
+0000d720: 6469 6f2e 6d34 6122 0a20 2020 2020 2020  dio.m4a".       
+0000d730: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+0000d740: 6d65 7373 6167 652e 696e 666f 2e64 7572  message.info.dur
+0000d750: 6174 696f 6e0a 2020 2020 2020 2020 656c  ation.        el
+0000d760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000d770: 6475 7261 7469 6f6e 203d 204e 6f6e 650a  duration = None.
+0000d780: 2020 2020 2020 2020 2320 6177 6169 7420          # await 
+0000d790: 7365 6e64 6572 2e6d 7174 742e 6f70 656e  sender.mqtt.open
+0000d7a0: 6564 5f74 6872 6561 6428 7365 6c66 2e66  ed_thread(self.f
+0000d7b0: 6269 6429 0a20 2020 2020 2020 2072 6573  bid).        res
+0000d7c0: 7020 3d20 6177 6169 7420 7365 6e64 6572  p = await sender
+0000d7d0: 2e63 6c69 656e 742e 7365 6e64 5f6d 6564  .client.send_med
+0000d7e0: 6961 280a 2020 2020 2020 2020 2020 2020  ia(.            
+0000d7f0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0000d800: 2020 6669 6c65 6e61 6d65 2c0a 2020 2020    filename,.    
+0000d810: 2020 2020 2020 2020 6d69 6d65 2c0a 2020          mime,.  
+0000d820: 2020 2020 2020 2020 2020 6361 7074 696f            captio
+0000d830: 6e3d 6361 7074 696f 6e2c 0a20 2020 2020  n=caption,.     
+0000d840: 2020 2020 2020 206f 6666 6c69 6e65 5f74         offline_t
+0000d850: 6872 6561 6469 6e67 5f69 643d 6462 6d2e  hreading_id=dbm.
+0000d860: 6662 5f74 786e 5f69 642c 0a20 2020 2020  fb_txn_id,.     
+0000d870: 2020 2020 2020 2072 6570 6c79 5f74 6f3d         reply_to=
+0000d880: 7265 706c 795f 746f 2c0a 2020 2020 2020  reply_to,.      
+0000d890: 2020 2020 2020 6368 6174 5f69 643d 7365        chat_id=se
+0000d8a0: 6c66 2e66 6269 642c 0a20 2020 2020 2020  lf.fbid,.       
+0000d8b0: 2020 2020 2069 735f 6772 6f75 703d 7365       is_group=se
+0000d8c0: 6c66 2e66 625f 7479 7065 2021 3d20 5468  lf.fb_type != Th
+0000d8d0: 7265 6164 5479 7065 2e55 5345 522c 0a20  readType.USER,. 
+0000d8e0: 2020 2020 2020 2020 2020 2064 7572 6174             durat
+0000d8f0: 696f 6e3d 6475 7261 7469 6f6e 2c0a 2020  ion=duration,.  
+0000d900: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000d910: 6966 206e 6f74 2072 6573 702e 6d65 6469  if not resp.medi
+0000d920: 615f 6964 2061 6e64 2072 6573 702e 6465  a_id and resp.de
+0000d930: 6275 675f 696e 666f 3a0a 2020 2020 2020  bug_info:.      
+0000d940: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
+0000d950: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0000d960: 2020 2020 2020 6622 4572 726f 7220 7570        f"Error up
+0000d970: 6c6f 6164 696e 6720 6d65 6469 6120 666f  loading media fo
+0000d980: 7220 4d61 7472 6978 206d 6573 7361 6765  r Matrix message
+0000d990: 207b 6576 656e 745f 6964 7d3a 207b 7265   {event_id}: {re
+0000d9a0: 7370 2e64 6562 7567 5f69 6e66 6f2e 6d65  sp.debug_info.me
+0000d9b0: 7373 6167 657d 220a 2020 2020 2020 2020  ssage}".        
+0000d9c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000d9d0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+0000d9e0: 6e28 6622 4d65 6469 6120 7570 6c6f 6164  n(f"Media upload
+0000d9f0: 2065 7272 6f72 3a20 7b72 6573 702e 6465   error: {resp.de
+0000da00: 6275 675f 696e 666f 2e6d 6573 7361 6765  bug_info.message
+0000da10: 7d22 290a 0a20 2020 2020 2020 2074 7279  }")..        try
+0000da20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000da30: 6c66 2e5f 6f74 695f 6465 6475 702e 706f  lf._oti_dedup.po
+0000da40: 7028 6462 6d2e 6662 5f74 786e 5f69 6429  p(dbm.fb_txn_id)
+0000da50: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000da60: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
+0000da70: 2020 2020 2020 7365 6c66 2e6c 6f67 2e74        self.log.t
+0000da80: 7261 6365 2866 224d 6573 7361 6765 2049  race(f"Message I
+0000da90: 4420 666f 7220 4f54 4920 7b64 626d 2e66  D for OTI {dbm.f
+0000daa0: 625f 7478 6e5f 6964 7d20 7365 656d 7320  b_txn_id} seems 
+0000dab0: 746f 2068 6176 6520 6265 656e 2066 6f75  to have been fou
+0000dac0: 6e64 2061 6c72 6561 6479 2229 0a20 2020  nd already").   
+0000dad0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000dae0: 2020 2020 2020 2064 626d 2e66 6269 6420         dbm.fbid 
+0000daf0: 3d20 7265 7370 2e6d 6573 7361 6765 5f69  = resp.message_i
+0000db00: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+0000db10: 544f 444f 2063 616e 2077 6520 6669 6e64  TODO can we find
+0000db20: 2074 6865 2074 696d 6573 7461 6d70 3f0a   the timestamp?.
+0000db30: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000db40: 7420 6462 6d2e 7570 6461 7465 2829 0a20  t dbm.update(). 
+0000db50: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+0000db60: 6465 6275 6728 6622 4861 6e64 6c65 6420  debug(f"Handled 
+0000db70: 4d61 7472 6978 206d 6573 7361 6765 207b  Matrix message {
+0000db80: 6576 656e 745f 6964 7d20 2d3e 207b 7265  event_id} -> {re
+0000db90: 7370 2e6d 6573 7361 6765 5f69 647d 202f  sp.message_id} /
+0000dba0: 207b 6462 6d2e 6662 5f74 786e 5f69 647d   {dbm.fb_txn_id}
+0000dbb0: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
+0000dbc0: 6620 6861 6e64 6c65 5f6d 6174 7269 785f  f handle_matrix_
+0000dbd0: 7265 6461 6374 696f 6e28 0a20 2020 2020  redaction(.     
+0000dbe0: 2020 2073 656c 662c 2073 656e 6465 723a     self, sender:
+0000dbf0: 2075 2e55 7365 722c 2065 7665 6e74 5f69   u.User, event_i
+0000dc00: 643a 2045 7665 6e74 4944 2c20 7265 6461  d: EventID, reda
+0000dc10: 6374 696f 6e5f 6576 656e 745f 6964 3a20  ction_event_id: 
+0000dc20: 4576 656e 7449 440a 2020 2020 2920 2d3e  EventID.    ) ->
+0000dc30: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0000dc40: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000dc50: 6177 6169 7420 7365 6c66 2e5f 6861 6e64  await self._hand
+0000dc60: 6c65 5f6d 6174 7269 785f 7265 6461 6374  le_matrix_redact
+0000dc70: 696f 6e28 7365 6e64 6572 2c20 6576 656e  ion(sender, even
+0000dc80: 745f 6964 290a 2020 2020 2020 2020 6578  t_id).        ex
+0000dc90: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0000dca0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0000dcb0: 2073 656c 662e 6c6f 672e 6572 726f 7228   self.log.error(
+0000dcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dcd0: 2066 2246 6169 6c65 6420 746f 2068 616e   f"Failed to han
+0000dce0: 646c 6520 4d61 7472 6978 2072 6564 6163  dle Matrix redac
+0000dcf0: 7469 6f6e 207b 7265 6461 6374 696f 6e5f  tion {redaction_
+0000dd00: 6576 656e 745f 6964 7d3a 207b 657d 222c  event_id}: {e}",
+0000dd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd20: 2065 7863 5f69 6e66 6f3d 6e6f 7420 6973   exc_info=not is
+0000dd30: 696e 7374 616e 6365 2865 2c20 4e6f 7449  instance(e, NotI
+0000dd40: 6d70 6c65 6d65 6e74 6564 4572 726f 7229  mplementedError)
+0000dd50: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000dd60: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000dd70: 7420 7365 6c66 2e5f 7365 6e64 5f62 7269  t self._send_bri
+0000dd80: 6467 655f 6572 726f 7228 7365 6e64 6572  dge_error(sender
+0000dd90: 2c20 652c 2072 6564 6163 7469 6f6e 5f65  , e, redaction_e
+0000dda0: 7665 6e74 5f69 642c 2045 7665 6e74 5479  vent_id, EventTy
+0000ddb0: 7065 2e52 4f4f 4d5f 5245 4441 4354 494f  pe.ROOM_REDACTIO
+0000ddc0: 4e29 0a20 2020 2020 2020 2065 6c73 653a  N).        else:
+0000ddd0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0000dde0: 6974 2073 656c 662e 5f73 656e 645f 6272  it self._send_br
+0000ddf0: 6964 6765 5f73 7563 6365 7373 2873 656e  idge_success(sen
+0000de00: 6465 722c 2072 6564 6163 7469 6f6e 5f65  der, redaction_e
+0000de10: 7665 6e74 5f69 642c 2045 7665 6e74 5479  vent_id, EventTy
+0000de20: 7065 2e52 4f4f 4d5f 5245 4441 4354 494f  pe.ROOM_REDACTIO
+0000de30: 4e29 0a0a 2020 2020 6173 796e 6320 6465  N)..    async de
+0000de40: 6620 5f68 616e 646c 655f 6d61 7472 6978  f _handle_matrix
+0000de50: 5f72 6564 6163 7469 6f6e 2873 656c 662c  _redaction(self,
+0000de60: 2073 656e 6465 723a 2075 2e55 7365 722c   sender: u.User,
+0000de70: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
+0000de80: 4944 2920 2d3e 204e 6f6e 653a 0a20 2020  ID) -> None:.   
+0000de90: 2020 2020 2073 656e 6465 722c 205f 203d       sender, _ =
+0000dea0: 2061 7761 6974 2073 656c 662e 6765 745f   await self.get_
+0000deb0: 7265 6c61 795f 7365 6e64 6572 2873 656e  relay_sender(sen
+0000dec0: 6465 722c 2066 2272 6564 6163 7469 6f6e  der, f"redaction
+0000ded0: 207b 6576 656e 745f 6964 7d22 290a 2020   {event_id}").  
+0000dee0: 2020 2020 2020 6966 206e 6f74 2073 656e        if not sen
+0000def0: 6465 723a 0a20 2020 2020 2020 2020 2020  der:.           
+0000df00: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0000df10: 2822 6e6f 7420 6c6f 6767 6564 2069 6e22  ("not logged in"
+0000df20: 290a 2020 2020 2020 2020 6d65 7373 6167  ).        messag
+0000df30: 6520 3d20 6177 6169 7420 4442 4d65 7373  e = await DBMess
+0000df40: 6167 652e 6765 745f 6279 5f6d 7869 6428  age.get_by_mxid(
+0000df50: 6576 656e 745f 6964 2c20 7365 6c66 2e6d  event_id, self.m
+0000df60: 7869 6429 0a20 2020 2020 2020 2069 6620  xid).        if 
+0000df70: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
+0000df80: 2020 2020 2069 6620 6e6f 7420 6d65 7373       if not mess
+0000df90: 6167 652e 6662 6964 3a0a 2020 2020 2020  age.fbid:.      
+0000dfa0: 2020 2020 2020 2020 2020 7472 6163 6b28            track(
+0000dfb0: 7365 6e64 6572 2c20 2224 756e 6b6e 6f77  sender, "$unknow
+0000dfc0: 6e5f 6d65 7373 6167 655f 6662 6964 2229  n_message_fbid")
+0000dfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dfe0: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+0000dff0: 656e 7465 6445 7272 6f72 2822 5472 6965  entedError("Trie
+0000e000: 6420 746f 2072 6564 6163 7420 6d65 7373  d to redact mess
+0000e010: 6167 6520 7768 6f73 6520 6662 6964 2069  age whose fbid i
+0000e020: 7320 756e 6b6e 6f77 6e22 290a 2020 2020  s unknown").    
+0000e030: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000e040: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+0000e050: 6974 206d 6573 7361 6765 2e64 656c 6574  it message.delet
+0000e060: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000e070: 2020 2020 6177 6169 7420 7365 6e64 6572      await sender
+0000e080: 2e63 6c69 656e 742e 756e 7365 6e64 286d  .client.unsend(m
+0000e090: 6573 7361 6765 2e66 6269 6429 0a20 2020  essage.fbid).   
+0000e0a0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0000e0b0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0000e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0d0: 7365 6c66 2e6c 6f67 2e65 7863 6570 7469  self.log.excepti
+0000e0e0: 6f6e 2866 2246 6169 6c65 6420 746f 2075  on(f"Failed to u
+0000e0f0: 6e73 656e 6420 7b6d 6573 7361 6765 2e66  nsend {message.f
+0000e100: 6269 647d 2229 0a20 2020 2020 2020 2020  bid}").         
+0000e110: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+0000e120: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000e130: 0a20 2020 2020 2020 2072 6561 6374 696f  .        reactio
+0000e140: 6e20 3d20 6177 6169 7420 4442 5265 6163  n = await DBReac
+0000e150: 7469 6f6e 2e67 6574 5f62 795f 6d78 6964  tion.get_by_mxid
+0000e160: 2865 7665 6e74 5f69 642c 2073 656c 662e  (event_id, self.
+0000e170: 6d78 6964 290a 2020 2020 2020 2020 6966  mxid).        if
+0000e180: 2072 6561 6374 696f 6e3a 0a20 2020 2020   reaction:.     
+0000e190: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000e1a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000e1b0: 7420 7265 6163 7469 6f6e 2e64 656c 6574  t reaction.delet
+0000e1c0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000e1d0: 2020 2020 6177 6169 7420 7365 6e64 6572      await sender
+0000e1e0: 2e63 6c69 656e 742e 7265 6163 7428 7265  .client.react(re
+0000e1f0: 6163 7469 6f6e 2e66 625f 6d73 6769 642c  action.fb_msgid,
+0000e200: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+0000e210: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000e220: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0000e230: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0000e240: 6f67 2e65 7863 6570 7469 6f6e 2866 2246  og.exception(f"F
+0000e250: 6169 6c65 6420 746f 2072 656d 6f76 6520  ailed to remove 
+0000e260: 7265 6163 7469 6f6e 2074 6f20 7b72 6561  reaction to {rea
+0000e270: 6374 696f 6e2e 6662 5f6d 7367 6964 7d22  ction.fb_msgid}"
+0000e280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e290: 2020 7261 6973 650a 2020 2020 2020 2020    raise.        
+0000e2a0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0000e2b0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
+0000e2c0: 6c65 6d65 6e74 6564 4572 726f 7228 2272  lementedError("r
+0000e2d0: 6564 6163 7469 6f6e 2074 6172 6765 7420  edaction target 
+0000e2e0: 6e6f 7420 666f 756e 6422 290a 0a20 2020  not found")..   
+0000e2f0: 2061 7379 6e63 2064 6566 2068 616e 646c   async def handl
+0000e300: 655f 6d61 7472 6978 5f72 6561 6374 696f  e_matrix_reactio
+0000e310: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
+0000e320: 0a20 2020 2020 2020 2073 656e 6465 723a  .        sender:
+0000e330: 2075 2e55 7365 722c 0a20 2020 2020 2020   u.User,.       
+0000e340: 2065 7665 6e74 5f69 643a 2045 7665 6e74   event_id: Event
+0000e350: 4944 2c0a 2020 2020 2020 2020 7265 6163  ID,.        reac
+0000e360: 7469 6e67 5f74 6f3a 2045 7665 6e74 4944  ting_to: EventID
+0000e370: 2c0a 2020 2020 2020 2020 7265 6163 7469  ,.        reacti
+0000e380: 6f6e 3a20 7374 722c 0a20 2020 2020 2020  on: str,.       
+0000e390: 2074 696d 6573 7461 6d70 3a20 696e 742c   timestamp: int,
+0000e3a0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+0000e3b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000e3c0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+0000e3d0: 656c 662e 5f68 616e 646c 655f 6d61 7472  elf._handle_matr
+0000e3e0: 6978 5f72 6561 6374 696f 6e28 7365 6e64  ix_reaction(send
+0000e3f0: 6572 2c20 6576 656e 745f 6964 2c20 7265  er, event_id, re
+0000e400: 6163 7469 6e67 5f74 6f2c 2072 6561 6374  acting_to, react
+0000e410: 696f 6e2c 2074 696d 6573 7461 6d70 290a  ion, timestamp).
+0000e420: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000e430: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0000e440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000e450: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+0000e460: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
+0000e470: 6c65 6420 746f 2068 616e 646c 6520 4d61  led to handle Ma
+0000e480: 7472 6978 2072 6561 6374 696f 6e20 7b65  trix reaction {e
+0000e490: 7665 6e74 5f69 647d 3a20 7b65 7d22 2c0a  vent_id}: {e}",.
+0000e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4b0: 6578 635f 696e 666f 3d6e 6f74 2069 7369  exc_info=not isi
+0000e4c0: 6e73 7461 6e63 6528 652c 204e 6f74 496d  nstance(e, NotIm
+0000e4d0: 706c 656d 656e 7465 6445 7272 6f72 292c  plementedError),
+0000e4e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000e4f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0000e500: 2073 656c 662e 5f73 656e 645f 6272 6964   self._send_brid
+0000e510: 6765 5f65 7272 6f72 2873 656e 6465 722c  ge_error(sender,
+0000e520: 2065 2c20 6576 656e 745f 6964 2c20 4576   e, event_id, Ev
+0000e530: 656e 7454 7970 652e 5245 4143 5449 4f4e  entType.REACTION
+0000e540: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000e550: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000e560: 7420 7365 6c66 2e5f 7365 6e64 5f62 7269  t self._send_bri
+0000e570: 6467 655f 7375 6363 6573 7328 7365 6e64  dge_success(send
+0000e580: 6572 2c20 6576 656e 745f 6964 2c20 4576  er, event_id, Ev
+0000e590: 656e 7454 7970 652e 5245 4143 5449 4f4e  entType.REACTION
+0000e5a0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+0000e5b0: 205f 6861 6e64 6c65 5f6d 6174 7269 785f   _handle_matrix_
+0000e5c0: 7265 6163 7469 6f6e 280a 2020 2020 2020  reaction(.      
+0000e5d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000e5e0: 7365 6e64 6572 3a20 752e 5573 6572 2c0a  sender: u.User,.
+0000e5f0: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
+0000e600: 3a20 4576 656e 7449 442c 0a20 2020 2020  : EventID,.     
+0000e610: 2020 2072 6561 6374 696e 675f 746f 3a20     reacting_to: 
+0000e620: 4576 656e 7449 442c 0a20 2020 2020 2020  EventID,.       
+0000e630: 2072 6561 6374 696f 6e3a 2073 7472 2c0a   reaction: str,.
+0000e640: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+0000e650: 703a 2069 6e74 2c0a 2020 2020 2920 2d3e  p: int,.    ) ->
+0000e660: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
+0000e670: 656e 6465 722c 2069 735f 7265 6c61 7920  ender, is_relay 
+0000e680: 3d20 6177 6169 7420 7365 6c66 2e67 6574  = await self.get
+0000e690: 5f72 656c 6179 5f73 656e 6465 7228 7365  _relay_sender(se
+0000e6a0: 6e64 6572 2c20 6622 7265 6163 7469 6f6e  nder, f"reaction
+0000e6b0: 207b 6576 656e 745f 6964 7d22 290a 2020   {event_id}").  
+0000e6c0: 2020 2020 2020 6966 206e 6f74 2073 656e        if not sen
+0000e6d0: 6465 7220 6f72 2069 735f 7265 6c61 793a  der or is_relay:
+0000e6e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000e6f0: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+0000e700: 6445 7272 6f72 2822 6e6f 7420 6c6f 6767  dError("not logg
+0000e710: 6564 2069 6e22 290a 2020 2020 2020 2020  ed in").        
+0000e720: 2320 4661 6365 626f 6f6b 2064 6f65 736e  # Facebook doesn
+0000e730: 2774 2075 7365 2076 6172 6961 7469 6f6e  't use variation
+0000e740: 2073 656c 6563 746f 7273 2c20 4d61 7472   selectors, Matr
+0000e750: 6978 2064 6f65 730a 2020 2020 2020 2020  ix does.        
+0000e760: 7265 6163 7469 6f6e 203d 2076 6172 6961  reaction = varia
+0000e770: 7469 6f6e 5f73 656c 6563 746f 722e 7265  tion_selector.re
+0000e780: 6d6f 7665 2872 6561 6374 696f 6e29 0a0a  move(reaction)..
+0000e790: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+0000e7a0: 7468 2073 656c 662e 7265 7175 6972 655f  th self.require_
+0000e7b0: 7365 6e64 5f6c 6f63 6b28 7365 6e64 6572  send_lock(sender
+0000e7c0: 2e66 6269 6429 3a0a 2020 2020 2020 2020  .fbid):.        
+0000e7d0: 2020 2020 6d65 7373 6167 6520 3d20 6177      message = aw
+0000e7e0: 6169 7420 4442 4d65 7373 6167 652e 6765  ait DBMessage.ge
+0000e7f0: 745f 6279 5f6d 7869 6428 7265 6163 7469  t_by_mxid(reacti
+0000e800: 6e67 5f74 6f2c 2073 656c 662e 6d78 6964  ng_to, self.mxid
+0000e810: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000e820: 206e 6f74 206d 6573 7361 6765 3a0a 2020   not message:.  
+0000e830: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000e840: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0000e850: 6564 4572 726f 7228 2272 6561 6374 696f  edError("reactio
+0000e860: 6e20 7461 7267 6574 206d 6573 7361 6765  n target message
+0000e870: 206e 6f74 2066 6f75 6e64 2229 0a20 2020   not found").   
+0000e880: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+0000e890: 7420 6d65 7373 6167 652e 6662 6964 3a0a  t message.fbid:.
+0000e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8b0: 7472 6163 6b28 7365 6e64 6572 2c20 2224  track(sender, "$
+0000e8c0: 756e 6b6e 6f77 6e5f 6d65 7373 6167 655f  unknown_message_
+0000e8d0: 6662 6964 2229 0a20 2020 2020 2020 2020  fbid").         
+0000e8e0: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+0000e8f0: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+0000e900: 2822 6661 6365 626f 6f6b 2049 4420 6f66  ("facebook ID of
+0000e910: 2074 6172 6765 7420 6d65 7373 6167 6520   target message 
+0000e920: 6973 2075 6e6b 6e6f 776e 2229 0a0a 2020  is unknown")..  
+0000e930: 2020 2020 2020 2020 2020 6578 6973 7469            existi
+0000e940: 6e67 203d 2061 7761 6974 2044 4252 6561  ng = await DBRea
+0000e950: 6374 696f 6e2e 6765 745f 6279 5f66 6269  ction.get_by_fbi
+0000e960: 6428 6d65 7373 6167 652e 6662 6964 2c20  d(message.fbid, 
+0000e970: 7365 6c66 2e66 625f 7265 6365 6976 6572  self.fb_receiver
+0000e980: 2c20 7365 6e64 6572 2e66 6269 6429 0a20  , sender.fbid). 
+0000e990: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+0000e9a0: 6973 7469 6e67 2061 6e64 2065 7869 7374  isting and exist
+0000e9b0: 696e 672e 7265 6163 7469 6f6e 203d 3d20  ing.reaction == 
+0000e9c0: 7265 6163 7469 6f6e 3a0a 2020 2020 2020  reaction:.      
+0000e9d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000e9e0: 0a0a 2020 2020 2020 2020 2020 2020 6177  ..            aw
+0000e9f0: 6169 7420 7365 6e64 6572 2e63 6c69 656e  ait sender.clien
+0000ea00: 742e 7265 6163 7428 6d65 7373 6167 652e  t.react(message.
+0000ea10: 6662 6964 2c20 7265 6163 7469 6f6e 290a  fbid, reaction).
+0000ea20: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000ea30: 7420 7365 6c66 2e5f 7570 7365 7274 5f72  t self._upsert_r
+0000ea40: 6561 6374 696f 6e28 0a20 2020 2020 2020  eaction(.       
+0000ea50: 2020 2020 2020 2020 2065 7869 7374 696e           existin
+0000ea60: 672c 2073 656c 662e 6d61 696e 5f69 6e74  g, self.main_int
+0000ea70: 656e 742c 2065 7665 6e74 5f69 642c 206d  ent, event_id, m
+0000ea80: 6573 7361 6765 2c20 7365 6e64 6572 2c20  essage, sender, 
+0000ea90: 7265 6163 7469 6f6e 2c20 7469 6d65 7374  reaction, timest
+0000eaa0: 616d 700a 2020 2020 2020 2020 2020 2020  amp.            
+0000eab0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+0000eac0: 2068 616e 646c 655f 6d61 7472 6978 5f6c   handle_matrix_l
+0000ead0: 6561 7665 2873 656c 662c 2075 7365 723a  eave(self, user:
+0000eae0: 2075 2e55 7365 7229 202d 3e20 4e6f 6e65   u.User) -> None
+0000eaf0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+0000eb00: 662e 6973 5f64 6972 6563 743a 0a20 2020  f.is_direct:.   
+0000eb10: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0000eb20: 672e 696e 666f 2866 227b 7573 6572 2e6d  g.info(f"{user.m
+0000eb30: 7869 647d 206c 6566 7420 7072 6976 6174  xid} left privat
+0000eb40: 6520 6368 6174 2070 6f72 7461 6c20 7769  e chat portal wi
+0000eb50: 7468 207b 7365 6c66 2e66 6269 647d 2229  th {self.fbid}")
+0000eb60: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000eb70: 7573 6572 2e66 6269 6420 3d3d 2073 656c  user.fbid == sel
+0000eb80: 662e 6662 5f72 6563 6569 7665 723a 0a20  f.fb_receiver:. 
+0000eb90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000eba0: 656c 662e 6c6f 672e 696e 666f 280a 2020  elf.log.info(.  
+0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebc0: 2020 6622 7b75 7365 722e 6d78 6964 7d20    f"{user.mxid} 
+0000ebd0: 7761 7320 7468 6520 7265 6369 7069 656e  was the recipien
+0000ebe0: 7420 6f66 2074 6869 7320 706f 7274 616c  t of this portal
+0000ebf0: 2e20 436c 6561 6e69 6e67 2075 7020 616e  . Cleaning up an
+0000ec00: 6420 6465 6c65 7469 6e67 2e2e 2e22 0a20  d deleting...". 
+0000ec10: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000ec20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ec30: 2061 7761 6974 2073 656c 662e 636c 6561   await self.clea
+0000ec40: 6e75 705f 616e 645f 6465 6c65 7465 2829  nup_and_delete()
+0000ec50: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000ec60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000ec70: 6c6f 672e 6465 6275 6728 6622 7b75 7365  log.debug(f"{use
+0000ec80: 722e 6d78 6964 7d20 6c65 6674 2070 6f72  r.mxid} left por
+0000ec90: 7461 6c20 746f 207b 7365 6c66 2e66 6269  tal to {self.fbi
+0000eca0: 647d 2229 0a0a 2020 2020 6173 796e 6320  d}")..    async 
+0000ecb0: 6465 6620 5f73 6574 5f74 7970 696e 6728  def _set_typing(
+0000ecc0: 7365 6c66 2c20 7573 6572 733a 2073 6574  self, users: set
+0000ecd0: 5b55 7365 7249 445d 2c20 7479 7069 6e67  [UserID], typing
+0000ece0: 3a20 626f 6f6c 2920 2d3e 204e 6f6e 653a  : bool) -> None:
+0000ecf0: 0a20 2020 2020 2020 2066 6f72 206d 7869  .        for mxi
+0000ed00: 6420 696e 2075 7365 7273 3a0a 2020 2020  d in users:.    
+0000ed10: 2020 2020 2020 2020 7573 6572 3a20 752e          user: u.
+0000ed20: 5573 6572 203d 2061 7761 6974 2075 2e55  User = await u.U
+0000ed30: 7365 722e 6765 745f 6279 5f6d 7869 6428  ser.get_by_mxid(
+0000ed40: 6d78 6964 2c20 6372 6561 7465 3d46 616c  mxid, create=Fal
+0000ed50: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0000ed60: 6966 2075 7365 7220 616e 6420 7573 6572  if user and user
+0000ed70: 2e6d 7174 743a 0a20 2020 2020 2020 2020  .mqtt:.         
+0000ed80: 2020 2020 2020 2061 7761 6974 2075 7365         await use
+0000ed90: 722e 6d71 7474 2e73 6574 5f74 7970 696e  r.mqtt.set_typin
+0000eda0: 6728 7365 6c66 2e66 6269 642c 2074 7970  g(self.fbid, typ
+0000edb0: 696e 6729 0a0a 2020 2020 6173 796e 6320  ing)..    async 
+0000edc0: 6465 6620 6861 6e64 6c65 5f6d 6174 7269  def handle_matri
+0000edd0: 785f 7479 7069 6e67 2873 656c 662c 2075  x_typing(self, u
+0000ede0: 7365 7273 3a20 7365 745b 5573 6572 4944  sers: set[UserID
+0000edf0: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
+0000ee00: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+0000ee10: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+0000ee20: 2020 2020 2020 7365 6c66 2e5f 7365 745f        self._set_
+0000ee30: 7479 7069 6e67 2875 7365 7273 202d 2073  typing(users - s
+0000ee40: 656c 662e 5f74 7970 696e 672c 2074 7970  elf._typing, typ
+0000ee50: 696e 673d 5472 7565 292c 0a20 2020 2020  ing=True),.     
+0000ee60: 2020 2020 2020 2073 656c 662e 5f73 6574         self._set
+0000ee70: 5f74 7970 696e 6728 7365 6c66 2e5f 7479  _typing(self._ty
+0000ee80: 7069 6e67 202d 2075 7365 7273 2c20 7479  ping - users, ty
+0000ee90: 7069 6e67 3d46 616c 7365 292c 0a20 2020  ping=False),.   
+0000eea0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0000eeb0: 656c 662e 5f74 7970 696e 6720 3d20 7573  elf._typing = us
+0000eec0: 6572 730a 0a20 2020 2023 2065 6e64 7265  ers..    # endre
+0000eed0: 6769 6f6e 0a20 2020 2023 2072 6567 696f  gion.    # regio
+0000eee0: 6e20 4661 6365 626f 6f6b 2065 7665 6e74  n Facebook event
+0000eef0: 2068 616e 646c 696e 670a 0a20 2020 2061   handling..    a
+0000ef00: 7379 6e63 2064 6566 205f 6272 6964 6765  sync def _bridge
+0000ef10: 5f6f 776e 5f6d 6573 7361 6765 5f70 6d28  _own_message_pm(
+0000ef20: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
+0000ef30: 6f75 7263 653a 2075 2e55 7365 722c 2073  ource: u.User, s
+0000ef40: 656e 6465 723a 2070 2e50 7570 7065 742c  ender: p.Puppet,
+0000ef50: 206d 6964 3a20 7374 722c 2069 6e76 6974   mid: str, invit
+0000ef60: 653a 2062 6f6f 6c20 3d20 5472 7565 0a20  e: bool = True. 
+0000ef70: 2020 2029 202d 3e20 626f 6f6c 3a0a 2020     ) -> bool:.  
+0000ef80: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+0000ef90: 5f64 6972 6563 7420 616e 6420 7365 6e64  _direct and send
+0000efa0: 6572 2e66 6269 6420 3d3d 2073 6f75 7263  er.fbid == sourc
+0000efb0: 652e 6662 6964 2061 6e64 206e 6f74 2073  e.fbid and not s
+0000efc0: 656e 6465 722e 6973 5f72 6561 6c5f 7573  ender.is_real_us
+0000efd0: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0000efe0: 6966 2073 656c 662e 696e 7669 7465 5f6f  if self.invite_o
+0000eff0: 776e 5f70 7570 7065 745f 746f 5f70 6d20  wn_puppet_to_pm 
+0000f000: 616e 6420 696e 7669 7465 3a0a 2020 2020  and invite:.    
+0000f010: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0000f020: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
+0000f030: 6e74 2e69 6e76 6974 655f 7573 6572 2873  nt.invite_user(s
+0000f040: 656c 662e 6d78 6964 2c20 7365 6e64 6572  elf.mxid, sender
+0000f050: 2e6d 7869 6429 0a20 2020 2020 2020 2020  .mxid).         
+0000f060: 2020 2065 6c69 6620 280a 2020 2020 2020     elif (.      
+0000f070: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0000f080: 7365 6c66 2e61 7a2e 7374 6174 655f 7374  self.az.state_st
+0000f090: 6f72 652e 6765 745f 6d65 6d62 6572 7368  ore.get_membersh
+0000f0a0: 6970 2873 656c 662e 6d78 6964 2c20 7365  ip(self.mxid, se
+0000f0b0: 6e64 6572 2e6d 7869 6429 2021 3d20 4d65  nder.mxid) != Me
+0000f0c0: 6d62 6572 7368 6970 2e4a 4f49 4e0a 2020  mbership.JOIN.  
+0000f0d0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0000f0e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000f0f0: 662e 6c6f 672e 7761 726e 696e 6728 0a20  f.log.warning(. 
 0000f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f110: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000f120: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-0000f130: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0000f140: 2020 2020 2020 2020 6d65 7373 6167 655f          message_
-0000f150: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0000f160: 2020 2020 2020 2020 7265 6163 7469 6f6e          reaction
-0000f170: 2e72 6561 6374 696f 6e2c 0a20 2020 2020  .reaction,.     
-0000f180: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000f190: 6172 6765 745f 6d65 7373 6167 653d 7461  arget_message=ta
-0000f1a0: 7267 6574 5f6d 6573 7361 6765 2c0a 2020  rget_message,.  
-0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1c0: 2020 2320 5469 6d65 7374 616d 7020 6973    # Timestamp is
-0000f1d0: 206f 6e6c 7920 7573 6564 2066 6f72 206e   only used for n
-0000f1e0: 6577 2072 6561 6374 696f 6e73 2c20 6265  ew reactions, be
-0000f1f0: 6361 7573 6520 6974 2773 206f 6e6c 7920  cause it's only 
-0000f200: 696d 706f 7274 616e 7420 7768 656e 0a20  important when. 
-0000f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f220: 2020 2023 2062 6163 6b66 696c 6c69 6e67     # backfilling
-0000f230: 206d 6573 7361 6765 7320 2877 6869 6368   messages (which
-0000f240: 206f 6276 696f 7573 6c79 2077 6f6e 2774   obviously won't
-0000f250: 2068 6176 6520 616c 7265 6164 7920 6272   have already br
-0000f260: 6964 6765 6420 7265 6163 7469 6f6e 7329  idged reactions)
-0000f270: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000f280: 2020 2020 2020 7469 6d65 7374 616d 703d        timestamp=
-0000f290: 6465 6475 706c 6963 6174 6564 5f74 696d  deduplicated_tim
-0000f2a0: 6573 7461 6d70 2c0a 2020 2020 2020 2020  estamp,.        
-0000f2b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000f2c0: 2020 2020 2020 2020 2020 6465 6475 706c            dedupl
-0000f2d0: 6963 6174 6564 5f74 696d 6573 7461 6d70  icated_timestamp
-0000f2e0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-0000f2f0: 2020 2020 2020 7461 736b 732e 6170 7065        tasks.appe
-0000f300: 6e64 2861 7379 6e63 696f 2e63 7265 6174  nd(asyncio.creat
-0000f310: 655f 7461 736b 2874 6173 6b29 290a 2020  e_task(task)).  
-0000f320: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f340: 6966 2065 7869 7374 696e 672e 7265 6163  if existing.reac
-0000f350: 7469 6f6e 2021 3d20 7265 6163 7469 6f6e  tion != reaction
-0000f360: 2e72 6561 6374 696f 6e3a 0a20 2020 2020  .reaction:.     
-0000f370: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000f380: 6173 6b20 3d20 7365 6c66 2e68 616e 646c  ask = self.handl
-0000f390: 655f 6661 6365 626f 6f6b 5f72 6561 6374  e_facebook_react
-0000f3a0: 696f 6e5f 6164 6428 0a20 2020 2020 2020  ion_add(.       
-0000f3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3c0: 2073 6f75 7263 652c 0a20 2020 2020 2020   source,.       
-0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3e0: 2073 656e 6465 722c 0a20 2020 2020 2020   sender,.       
-0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f400: 206d 6573 7361 6765 5f69 642c 0a20 2020   message_id,.   
-0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f420: 2020 2020 2072 6561 6374 696f 6e2e 7265       reaction.re
-0000f430: 6163 7469 6f6e 2c0a 2020 2020 2020 2020  action,.        
-0000f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f450: 6578 6973 7469 6e67 3d65 7869 7374 696e  existing=existin
-0000f460: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-0000f470: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0000f480: 745f 6d65 7373 6167 653d 7461 7267 6574  t_message=target
-0000f490: 5f6d 6573 7361 6765 2c0a 2020 2020 2020  _message,.      
-0000f4a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4c0: 2020 2020 7461 736b 732e 6170 7065 6e64      tasks.append
-0000f4d0: 2861 7379 6e63 696f 2e63 7265 6174 655f  (asyncio.create_
-0000f4e0: 7461 736b 2874 6173 6b29 290a 2020 2020  task(task)).    
-0000f4f0: 2020 2020 666f 7220 7365 6e64 6572 2c20      for sender, 
-0000f500: 6578 6973 7469 6e67 2069 6e20 6272 6964  existing in brid
-0000f510: 6765 645f 7265 6163 7469 6f6e 732e 6974  ged_reactions.it
-0000f520: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0000f530: 2020 2069 6620 7365 6e64 6572 206e 6f74     if sender not
-0000f540: 2069 6e20 6c61 7465 7374 5f72 6561 6374   in latest_react
-0000f550: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-0000f560: 2020 2020 2020 7461 736b 203d 2073 656c        task = sel
-0000f570: 662e 6861 6e64 6c65 5f66 6163 6562 6f6f  f.handle_faceboo
-0000f580: 6b5f 7265 6163 7469 6f6e 5f72 656d 6f76  k_reaction_remov
-0000f590: 6528 736f 7572 6365 2c20 7365 6e64 6572  e(source, sender
-0000f5a0: 2c20 6578 6973 7469 6e67 290a 2020 2020  , existing).    
-0000f5b0: 2020 2020 2020 2020 2020 2020 7461 736b              task
-0000f5c0: 732e 6170 7065 6e64 2861 7379 6e63 696f  s.append(asyncio
-0000f5d0: 2e63 7265 6174 655f 7461 736b 2874 6173  .create_task(tas
-0000f5e0: 6b29 290a 2020 2020 2020 2020 6966 206c  k)).        if l
-0000f5f0: 656e 2874 6173 6b73 2920 3e20 303a 0a20  en(tasks) > 0:. 
-0000f600: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0000f610: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-0000f620: 2a74 6173 6b73 290a 2020 2020 2020 2020  *tasks).        
-0000f630: 2020 2020 7365 6c66 2e6c 6f67 2e64 6562      self.log.deb
-0000f640: 7567 2866 2255 7064 6174 6564 207b 6c65  ug(f"Updated {le
-0000f650: 6e28 7461 736b 7329 7d20 7265 6163 7469  n(tasks)} reacti
-0000f660: 6f6e 7320 6f66 207b 6d65 7373 6167 655f  ons of {message_
-0000f670: 6964 7d22 290a 0a20 2020 2061 7379 6e63  id}")..    async
-0000f680: 2064 6566 205f 6861 6e64 6c65 5f67 7261   def _handle_gra
-0000f690: 7068 716c 5f6d 6573 7361 6765 280a 2020  phql_message(.  
-0000f6a0: 2020 2020 2020 7365 6c66 2c20 736f 7572        self, sour
-0000f6b0: 6365 3a20 752e 5573 6572 2c20 696e 7465  ce: u.User, inte
-0000f6c0: 6e74 3a20 496e 7465 6e74 4150 492c 206d  nt: IntentAPI, m
-0000f6d0: 6573 7361 6765 3a20 6772 6170 6871 6c2e  essage: graphql.
-0000f6e0: 4d65 7373 6167 650a 2020 2020 2920 2d3e  Message.    ) ->
-0000f6f0: 206c 6973 745b 4576 656e 7449 445d 3a0a   list[EventID]:.
-0000f700: 2020 2020 2020 2020 7265 706c 795f 746f          reply_to
-0000f710: 5f6d 7367 203d 206d 6573 7361 6765 2e72  _msg = message.r
-0000f720: 6570 6c69 6564 5f74 6f5f 6d65 7373 6167  eplied_to_messag
-0000f730: 652e 6d65 7373 6167 6520 6966 206d 6573  e.message if mes
-0000f740: 7361 6765 2e72 6570 6c69 6564 5f74 6f5f  sage.replied_to_
-0000f750: 6d65 7373 6167 6520 656c 7365 204e 6f6e  message else Non
-0000f760: 650a 2020 2020 2020 2020 6576 656e 745f  e.        event_
-0000f770: 6964 7320 3d20 5b5d 0a20 2020 2020 2020  ids = [].       
-0000f780: 2069 6620 6d65 7373 6167 652e 7374 6963   if message.stic
-0000f790: 6b65 723a 0a20 2020 2020 2020 2020 2020  ker:.           
-0000f7a0: 2065 7665 6e74 5f69 6473 2e61 7070 656e   event_ids.appen
-0000f7b0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0000f7c0: 2020 2061 7761 6974 2073 656c 662e 5f68     await self._h
-0000f7d0: 616e 646c 655f 6661 6365 626f 6f6b 5f73  andle_facebook_s
-0000f7e0: 7469 636b 6572 280a 2020 2020 2020 2020  ticker(.        
-0000f7f0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0000f800: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0000f810: 2020 2020 2020 2020 696e 7465 6e74 2c0a          intent,.
-0000f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f830: 2020 2020 696e 7428 6d65 7373 6167 652e      int(message.
-0000f840: 7374 6963 6b65 722e 6964 292c 0a20 2020  sticker.id),.   
-0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f860: 2072 6570 6c79 5f74 6f5f 6d73 672c 0a20   reply_to_msg,. 
-0000f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f880: 2020 206d 6573 7361 6765 2e74 696d 6573     message.times
-0000f890: 7461 6d70 2c0a 2020 2020 2020 2020 2020  tamp,.          
-0000f8a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000f8b0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-0000f8c0: 206c 656e 286d 6573 7361 6765 2e62 6c6f   len(message.blo
-0000f8d0: 625f 6174 7461 6368 6d65 6e74 7329 203e  b_attachments) >
-0000f8e0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0000f8f0: 6174 7461 6368 5f69 6473 203d 2061 7761  attach_ids = awa
-0000f900: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
-0000f910: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000f920: 2020 202a 5b0a 2020 2020 2020 2020 2020     *[.          
-0000f930: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000f940: 6861 6e64 6c65 5f66 6163 6562 6f6f 6b5f  handle_facebook_
-0000f950: 6174 7461 6368 6d65 6e74 280a 2020 2020  attachment(.    
-0000f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f970: 2020 2020 6d65 7373 6167 652e 6d65 7373      message.mess
-0000f980: 6167 655f 6964 2c0a 2020 2020 2020 2020  age_id,.        
-0000f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9a0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9c0: 696e 7465 6e74 2c0a 2020 2020 2020 2020  intent,.        
-0000f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9e0: 6174 7461 6368 6d65 6e74 2c0a 2020 2020  attachment,.    
-0000f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa00: 2020 2020 7265 706c 795f 746f 5f6d 7367      reply_to_msg
-0000fa10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa20: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
-0000fa30: 652e 7469 6d65 7374 616d 702c 0a20 2020  e.timestamp,.   
-0000fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000fa60: 2020 2020 2020 2066 6f72 2061 7474 6163         for attac
-0000fa70: 686d 656e 7420 696e 206d 6573 7361 6765  hment in message
-0000fa80: 2e62 6c6f 625f 6174 7461 6368 6d65 6e74  .blob_attachment
-0000fa90: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000faa0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-0000fab0: 290a 2020 2020 2020 2020 2020 2020 6576  ).            ev
-0000fac0: 656e 745f 6964 7320 2b3d 205b 6174 7461  ent_ids += [atta
-0000fad0: 6368 5f69 6420 666f 7220 6174 7461 6368  ch_id for attach
-0000fae0: 5f69 6420 696e 2061 7474 6163 685f 6964  _id in attach_id
-0000faf0: 7320 6966 2061 7474 6163 685f 6964 5d0a  s if attach_id].
-0000fb00: 2020 2020 2020 2020 7465 7874 203d 206d          text = m
-0000fb10: 6573 7361 6765 2e6d 6573 7361 6765 2e74  essage.message.t
-0000fb20: 6578 7420 6966 206d 6573 7361 6765 2e6d  ext if message.m
-0000fb30: 6573 7361 6765 2065 6c73 6520 4e6f 6e65  essage else None
-0000fb40: 0a20 2020 2020 2020 2069 6620 6d65 7373  .        if mess
-0000fb50: 6167 652e 6578 7465 6e73 6962 6c65 5f61  age.extensible_a
-0000fb60: 7474 6163 686d 656e 743a 0a20 2020 2020  ttachment:.     
-0000fb70: 2020 2020 2020 2073 6120 3d20 6d65 7373         sa = mess
-0000fb80: 6167 652e 6578 7465 6e73 6962 6c65 5f61  age.extensible_a
-0000fb90: 7474 6163 686d 656e 742e 7374 6f72 795f  ttachment.story_
-0000fba0: 6174 7461 6368 6d65 6e74 0a20 2020 2020  attachment.     
-0000fbb0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
-0000fbc0: 2061 7761 6974 2073 656c 662e 5f63 6f6e   await self._con
-0000fbd0: 7665 7274 5f65 7874 656e 7369 626c 655f  vert_extensible_
-0000fbe0: 6d65 6469 6128 736f 7572 6365 2c20 696e  media(source, in
-0000fbf0: 7465 6e74 2c20 7361 2c20 6d65 7373 6167  tent, sa, messag
-0000fc00: 655f 7465 7874 3d74 6578 7429 0a20 2020  e_text=text).   
-0000fc10: 2020 2020 2020 2020 2069 6620 636f 6e74           if cont
-0000fc20: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
-0000fc30: 2020 2020 2065 7665 6e74 5f69 6473 2e61       event_ids.a
-0000fc40: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-0000fc50: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0000fc60: 2073 656c 662e 5f73 656e 645f 6d65 7373   self._send_mess
-0000fc70: 6167 6528 696e 7465 6e74 2c20 636f 6e74  age(intent, cont
-0000fc80: 656e 742c 2074 696d 6573 7461 6d70 3d6d  ent, timestamp=m
-0000fc90: 6573 7361 6765 2e74 696d 6573 7461 6d70  essage.timestamp
-0000fca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000fcb0: 2020 290a 2020 2020 2020 2020 6966 2074    ).        if t
-0000fcc0: 6578 743a 0a20 2020 2020 2020 2020 2020  ext:.           
-0000fcd0: 2065 7665 6e74 5f69 6473 2e61 7070 656e   event_ids.appen
-0000fce0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0000fcf0: 2020 2061 7761 6974 2073 656c 662e 5f68     await self._h
-0000fd00: 616e 646c 655f 6661 6365 626f 6f6b 5f74  andle_facebook_t
-0000fd10: 6578 7428 0a20 2020 2020 2020 2020 2020  ext(.           
-0000fd20: 2020 2020 2020 2020 2069 6e74 656e 742c           intent,
-0000fd30: 206d 6573 7361 6765 2e6d 6573 7361 6765   message.message
-0000fd40: 2c20 7265 706c 795f 746f 5f6d 7367 2c20  , reply_to_msg, 
-0000fd50: 6d65 7373 6167 652e 7469 6d65 7374 616d  message.timestam
-0000fd60: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-0000fd70: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000fd80: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000fd90: 2065 7665 6e74 5f69 6473 0a0a 2020 2020   event_ids..    
-0000fda0: 6173 796e 6320 6465 6620 5f68 616e 646c  async def _handl
-0000fdb0: 655f 6661 6365 626f 6f6b 5f74 6578 7428  e_facebook_text(
-0000fdc0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000fdd0: 2020 2020 2020 2069 6e74 656e 743a 2049         intent: I
-0000fde0: 6e74 656e 7441 5049 2c0a 2020 2020 2020  ntentAPI,.      
-0000fdf0: 2020 6d65 7373 6167 653a 2067 7261 7068    message: graph
-0000fe00: 716c 2e4d 6573 7361 6765 5465 7874 207c  ql.MessageText |
-0000fe10: 206d 7174 742e 4d65 7373 6167 652c 0a20   mqtt.Message,. 
-0000fe20: 2020 2020 2020 2072 6570 6c79 5f74 6f3a         reply_to:
-0000fe30: 2067 7261 7068 716c 2e4d 696e 696d 616c   graphql.Minimal
-0000fe40: 4d65 7373 6167 6520 7c20 6d71 7474 2e4d  Message | mqtt.M
-0000fe50: 6573 7361 6765 2c0a 2020 2020 2020 2020  essage,.        
-0000fe60: 7469 6d65 7374 616d 703a 2069 6e74 2c0a  timestamp: int,.
-0000fe70: 2020 2020 2920 2d3e 2045 7665 6e74 4944      ) -> EventID
-0000fe80: 3a0a 2020 2020 2020 2020 636f 6e74 656e  :.        conten
-0000fe90: 7420 3d20 6177 6169 7420 6661 6365 626f  t = await facebo
-0000fea0: 6f6b 5f74 6f5f 6d61 7472 6978 286d 6573  ok_to_matrix(mes
-0000feb0: 7361 6765 290a 2020 2020 2020 2020 6177  sage).        aw
-0000fec0: 6169 7420 7365 6c66 2e5f 6164 645f 6661  ait self._add_fa
-0000fed0: 6365 626f 6f6b 5f72 6570 6c79 2863 6f6e  cebook_reply(con
-0000fee0: 7465 6e74 2c20 7265 706c 795f 746f 290a  tent, reply_to).
-0000fef0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-0000ff00: 7761 6974 2073 656c 662e 5f73 656e 645f  wait self._send_
-0000ff10: 6d65 7373 6167 6528 696e 7465 6e74 2c20  message(intent, 
-0000ff20: 636f 6e74 656e 742c 2074 696d 6573 7461  content, timesta
-0000ff30: 6d70 3d74 696d 6573 7461 6d70 290a 0a20  mp=timestamp).. 
-0000ff40: 2020 2061 7379 6e63 2064 6566 205f 6861     async def _ha
-0000ff50: 6e64 6c65 5f66 6163 6562 6f6f 6b5f 7374  ndle_facebook_st
-0000ff60: 6963 6b65 7228 0a20 2020 2020 2020 2073  icker(.        s
-0000ff70: 656c 662c 0a20 2020 2020 2020 2073 6f75  elf,.        sou
-0000ff80: 7263 653a 2075 2e55 7365 722c 0a20 2020  rce: u.User,.   
-0000ff90: 2020 2020 2069 6e74 656e 743a 2049 6e74       intent: Int
-0000ffa0: 656e 7441 5049 2c0a 2020 2020 2020 2020  entAPI,.        
-0000ffb0: 7374 6963 6b65 725f 6964 3a20 696e 742c  sticker_id: int,
-0000ffc0: 0a20 2020 2020 2020 2072 6570 6c79 5f74  .        reply_t
-0000ffd0: 6f3a 2067 7261 7068 716c 2e4d 696e 696d  o: graphql.Minim
-0000ffe0: 616c 4d65 7373 6167 6520 7c20 6d71 7474  alMessage | mqtt
-0000fff0: 2e4d 6573 7361 6765 2c0a 2020 2020 2020  .Message,.      
-00010000: 2020 7469 6d65 7374 616d 703a 2069 6e74    timestamp: int
-00010010: 2c0a 2020 2020 2920 2d3e 2045 7665 6e74  ,.    ) -> Event
-00010020: 4944 3a0a 2020 2020 2020 2020 7265 7370  ID:.        resp
-00010030: 203d 2061 7761 6974 2073 6f75 7263 652e   = await source.
-00010040: 636c 6965 6e74 2e66 6574 6368 5f73 7469  client.fetch_sti
-00010050: 636b 6572 7328 5b73 7469 636b 6572 5f69  ckers([sticker_i
-00010060: 645d 2c20 7374 6963 6b65 725f 6c61 6265  d], sticker_labe
-00010070: 6c73 5f65 6e61 626c 6564 3d54 7275 6529  ls_enabled=True)
-00010080: 0a20 2020 2020 2020 2073 7469 636b 6572  .        sticker
-00010090: 203d 2072 6573 702e 6e6f 6465 735b 305d   = resp.nodes[0]
-000100a0: 0a20 2020 2020 2020 2075 726c 203d 2028  .        url = (
-000100b0: 7374 6963 6b65 722e 616e 696d 6174 6564  sticker.animated
-000100c0: 5f69 6d61 6765 206f 7220 7374 6963 6b65  _image or sticke
-000100d0: 722e 7468 7265 6164 5f69 6d61 6765 292e  r.thread_image).
-000100e0: 7572 690a 2020 2020 2020 2020 6d78 632c  uri.        mxc,
-000100f0: 2069 6e66 6f2c 2064 6563 7279 7074 696f   info, decryptio
-00010100: 6e5f 696e 666f 203d 2061 7761 6974 2073  n_info = await s
-00010110: 656c 662e 5f72 6575 706c 6f61 645f 6662  elf._reupload_fb
-00010120: 5f66 696c 6528 0a20 2020 2020 2020 2020  _file(.         
-00010130: 2020 2075 726c 2c20 736f 7572 6365 2c20     url, source, 
-00010140: 696e 7465 6e74 2c20 656e 6372 7970 743d  intent, encrypt=
-00010150: 7365 6c66 2e65 6e63 7279 7074 6564 2c20  self.encrypted, 
-00010160: 6669 6e64 5f73 697a 653d 5472 7565 0a20  find_size=True. 
-00010170: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010180: 2063 6f6e 7465 6e74 203d 204d 6564 6961   content = Media
-00010190: 4d65 7373 6167 6545 7665 6e74 436f 6e74  MessageEventCont
-000101a0: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-000101b0: 2075 726c 3d6d 7863 2c0a 2020 2020 2020   url=mxc,.      
-000101c0: 2020 2020 2020 6669 6c65 3d64 6563 7279        file=decry
-000101d0: 7074 696f 6e5f 696e 666f 2c0a 2020 2020  ption_info,.    
-000101e0: 2020 2020 2020 2020 696e 666f 3d69 6e66          info=inf
-000101f0: 6f2c 0a20 2020 2020 2020 2020 2020 206d  o,.            m
-00010200: 7367 7479 7065 3d4d 6573 7361 6765 5479  sgtype=MessageTy
-00010210: 7065 2e53 5449 434b 4552 2c0a 2020 2020  pe.STICKER,.    
-00010220: 2020 2020 2020 2020 626f 6479 3d73 7469          body=sti
-00010230: 636b 6572 2e6c 6162 656c 206f 7220 2222  cker.label or ""
-00010240: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00010250: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-00010260: 6164 645f 6661 6365 626f 6f6b 5f72 6570  add_facebook_rep
-00010270: 6c79 2863 6f6e 7465 6e74 2c20 7265 706c  ly(content, repl
-00010280: 795f 746f 290a 2020 2020 2020 2020 7265  y_to).        re
-00010290: 7475 726e 2061 7761 6974 2073 656c 662e  turn await self.
-000102a0: 5f73 656e 645f 6d65 7373 6167 6528 0a20  _send_message(. 
-000102b0: 2020 2020 2020 2020 2020 2069 6e74 656e             inten
-000102c0: 742c 2065 7665 6e74 5f74 7970 653d 4576  t, event_type=Ev
-000102d0: 656e 7454 7970 652e 5354 4943 4b45 522c  entType.STICKER,
-000102e0: 2063 6f6e 7465 6e74 3d63 6f6e 7465 6e74   content=content
-000102f0: 2c20 7469 6d65 7374 616d 703d 7469 6d65  , timestamp=time
-00010300: 7374 616d 700a 2020 2020 2020 2020 290a  stamp.        ).
-00010310: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
-00010320: 6861 6e64 6c65 5f66 6163 6562 6f6f 6b5f  handle_facebook_
-00010330: 6174 7461 6368 6d65 6e74 280a 2020 2020  attachment(.    
-00010340: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00010350: 2020 6d73 675f 6964 3a20 7374 722c 0a20    msg_id: str,. 
-00010360: 2020 2020 2020 2073 6f75 7263 653a 2075         source: u
-00010370: 2e55 7365 722c 0a20 2020 2020 2020 2069  .User,.        i
-00010380: 6e74 656e 743a 2049 6e74 656e 7441 5049  ntent: IntentAPI
-00010390: 2c0a 2020 2020 2020 2020 6174 7461 6368  ,.        attach
-000103a0: 6d65 6e74 3a20 6772 6170 6871 6c2e 4174  ment: graphql.At
-000103b0: 7461 6368 6d65 6e74 207c 206d 7174 742e  tachment | mqtt.
-000103c0: 4174 7461 6368 6d65 6e74 2c0a 2020 2020  Attachment,.    
-000103d0: 2020 2020 7265 706c 795f 746f 3a20 6772      reply_to: gr
-000103e0: 6170 6871 6c2e 4d69 6e69 6d61 6c4d 6573  aphql.MinimalMes
-000103f0: 7361 6765 207c 206d 7174 742e 4d65 7373  sage | mqtt.Mess
-00010400: 6167 652c 0a20 2020 2020 2020 2074 696d  age,.        tim
-00010410: 6573 7461 6d70 3a20 696e 742c 0a20 2020  estamp: int,.   
-00010420: 2020 2020 206d 6573 7361 6765 5f74 6578       message_tex
-00010430: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
-00010440: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2045  None,.    ) -> E
-00010450: 7665 6e74 4944 207c 204e 6f6e 653a 0a20  ventID | None:. 
-00010460: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00010470: 616e 6365 2861 7474 6163 686d 656e 742c  ance(attachment,
-00010480: 2067 7261 7068 716c 2e41 7474 6163 686d   graphql.Attachm
-00010490: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-000104a0: 2020 636f 6e74 656e 7420 3d20 6177 6169    content = awai
-000104b0: 7420 7365 6c66 2e5f 636f 6e76 6572 745f  t self._convert_
-000104c0: 6772 6170 6871 6c5f 6174 7461 6368 6d65  graphql_attachme
-000104d0: 6e74 286d 7367 5f69 642c 2073 6f75 7263  nt(msg_id, sourc
-000104e0: 652c 2069 6e74 656e 742c 2061 7474 6163  e, intent, attac
-000104f0: 686d 656e 7429 0a20 2020 2020 2020 2065  hment).        e
-00010500: 6c69 6620 6973 696e 7374 616e 6365 2861  lif isinstance(a
-00010510: 7474 6163 686d 656e 742c 206d 7174 742e  ttachment, mqtt.
-00010520: 4174 7461 6368 6d65 6e74 293a 0a20 2020  Attachment):.   
-00010530: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-00010540: 203d 2061 7761 6974 2073 656c 662e 5f63   = await self._c
-00010550: 6f6e 7665 7274 5f6d 7174 745f 6174 7461  onvert_mqtt_atta
-00010560: 6368 6d65 6e74 280a 2020 2020 2020 2020  chment(.        
-00010570: 2020 2020 2020 2020 6d73 675f 6964 2c20          msg_id, 
-00010580: 736f 7572 6365 2c20 696e 7465 6e74 2c20  source, intent, 
-00010590: 6174 7461 6368 6d65 6e74 2c20 6d65 7373  attachment, mess
-000105a0: 6167 655f 7465 7874 3d6d 6573 7361 6765  age_text=message
-000105b0: 5f74 6578 740a 2020 2020 2020 2020 2020  _text.          
-000105c0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-000105d0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-000105e0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-000105f0: 2249 6e76 616c 6964 2061 7474 6163 686d  "Invalid attachm
-00010600: 656e 7420 7479 7065 207b 7479 7065 2861  ent type {type(a
-00010610: 7474 6163 686d 656e 7429 2e5f 5f6e 616d  ttachment).__nam
-00010620: 655f 5f7d 2229 0a20 2020 2020 2020 2069  e__}").        i
-00010630: 6620 6e6f 7420 636f 6e74 656e 743a 0a20  f not content:. 
-00010640: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010650: 6e20 4e6f 6e65 0a20 2020 2020 2020 2061  n None.        a
-00010660: 7761 6974 2073 656c 662e 5f61 6464 5f66  wait self._add_f
-00010670: 6163 6562 6f6f 6b5f 7265 706c 7928 636f  acebook_reply(co
-00010680: 6e74 656e 742c 2072 6570 6c79 5f74 6f29  ntent, reply_to)
-00010690: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000106a0: 6177 6169 7420 7365 6c66 2e5f 7365 6e64  await self._send
-000106b0: 5f6d 6573 7361 6765 2869 6e74 656e 742c  _message(intent,
-000106c0: 2063 6f6e 7465 6e74 2c20 7469 6d65 7374   content, timest
-000106d0: 616d 703d 7469 6d65 7374 616d 7029 0a0a  amp=timestamp)..
-000106e0: 2020 2020 6173 796e 6320 6465 6620 5f63      async def _c
-000106f0: 6f6e 7665 7274 5f67 7261 7068 716c 5f61  onvert_graphql_a
-00010700: 7474 6163 686d 656e 7428 0a20 2020 2020  ttachment(.     
-00010710: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00010720: 206d 7367 5f69 643a 2073 7472 2c0a 2020   msg_id: str,.  
-00010730: 2020 2020 2020 736f 7572 6365 3a20 752e        source: u.
-00010740: 5573 6572 2c0a 2020 2020 2020 2020 696e  User,.        in
-00010750: 7465 6e74 3a20 496e 7465 6e74 4150 492c  tent: IntentAPI,
-00010760: 0a20 2020 2020 2020 2061 7474 6163 686d  .        attachm
-00010770: 656e 743a 2067 7261 7068 716c 2e41 7474  ent: graphql.Att
-00010780: 6163 686d 656e 742c 0a20 2020 2029 202d  achment,.    ) -
-00010790: 3e20 4d65 7373 6167 6545 7665 6e74 436f  > MessageEventCo
-000107a0: 6e74 656e 743a 0a20 2020 2020 2020 2066  ntent:.        f
-000107b0: 696c 656e 616d 6520 3d20 6174 7461 6368  ilename = attach
-000107c0: 6d65 6e74 2e66 696c 656e 616d 650a 2020  ment.filename.  
-000107d0: 2020 2020 2020 6966 2061 7474 6163 686d        if attachm
-000107e0: 656e 742e 6d69 6d65 7479 7065 2061 6e64  ent.mimetype and
-000107f0: 2022 2e22 206e 6f74 2069 6e20 6669 6c65   "." not in file
-00010800: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-00010810: 2020 6669 6c65 6e61 6d65 202b 3d20 6d69    filename += mi
-00010820: 6d65 7479 7065 732e 6775 6573 735f 6578  metypes.guess_ex
-00010830: 7465 6e73 696f 6e28 6174 7461 6368 6d65  tension(attachme
-00010840: 6e74 2e6d 696d 6574 7970 6529 0a20 2020  nt.mimetype).   
-00010850: 2020 2020 2072 6566 6572 6572 203d 2022       referer = "
-00010860: 756e 6b6e 6f77 6e22 0a20 2020 2020 2020  unknown".       
-00010870: 2069 6620 6174 7461 6368 6d65 6e74 2e74   if attachment.t
-00010880: 7970 656e 616d 6520 696e 2028 0a20 2020  ypename in (.   
-00010890: 2020 2020 2020 2020 2067 7261 7068 716c           graphql
-000108a0: 2e41 7474 6163 686d 656e 7454 7970 652e  .AttachmentType.
-000108b0: 494d 4147 452c 0a20 2020 2020 2020 2020  IMAGE,.         
-000108c0: 2020 2067 7261 7068 716c 2e41 7474 6163     graphql.Attac
-000108d0: 686d 656e 7454 7970 652e 414e 494d 4154  hmentType.ANIMAT
-000108e0: 4544 5f49 4d41 4745 2c0a 2020 2020 2020  ED_IMAGE,.      
-000108f0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00010900: 206d 7367 7479 7065 203d 204d 6573 7361   msgtype = Messa
-00010910: 6765 5479 7065 2e49 4d41 4745 0a20 2020  geType.IMAGE.   
-00010920: 2020 2020 2020 2020 2069 6620 6174 7461           if atta
-00010930: 6368 6d65 6e74 2e74 7970 656e 616d 6520  chment.typename 
-00010940: 3d3d 2067 7261 7068 716c 2e41 7474 6163  == graphql.Attac
-00010950: 686d 656e 7454 7970 652e 494d 4147 453a  hmentType.IMAGE:
-00010960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010970: 2069 6e66 6f20 3d20 496d 6167 6549 6e66   info = ImageInf
-00010980: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00010990: 2020 2020 2020 2077 6964 7468 3d61 7474         width=att
-000109a0: 6163 686d 656e 742e 6f72 6967 696e 616c  achment.original
-000109b0: 5f64 696d 656e 7369 6f6e 732e 782c 0a20  _dimensions.x,. 
-000109c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109d0: 2020 2068 6569 6768 743d 6174 7461 6368     height=attach
-000109e0: 6d65 6e74 2e6f 7269 6769 6e61 6c5f 6469  ment.original_di
-000109f0: 6d65 6e73 696f 6e73 2e79 2c0a 2020 2020  mensions.y,.    
-00010a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a10: 6d69 6d65 7479 7065 3d61 7474 6163 686d  mimetype=attachm
-00010a20: 656e 742e 6d69 6d65 7479 7065 2c0a 2020  ent.mimetype,.  
-00010a30: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00010a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a50: 6675 6c6c 5f73 6372 6565 6e20 3d20 6174  full_screen = at
-00010a60: 7461 6368 6d65 6e74 2e69 6d61 6765 5f66  tachment.image_f
-00010a70: 756c 6c5f 7363 7265 656e 0a20 2020 2020  ull_screen.     
-00010a80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00010a90: 2020 2020 2020 2020 2020 2020 2069 6e66               inf
-00010aa0: 6f20 3d20 496d 6167 6549 6e66 6f28 0a20  o = ImageInfo(. 
-00010ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ac0: 2020 2077 6964 7468 3d61 7474 6163 686d     width=attachm
-00010ad0: 656e 742e 616e 696d 6174 6564 5f69 6d61  ent.animated_ima
-00010ae0: 6765 5f6f 7269 6769 6e61 6c5f 6469 6d65  ge_original_dime
-00010af0: 6e73 696f 6e73 2e78 2c0a 2020 2020 2020  nsions.x,.      
-00010b00: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00010b10: 6967 6874 3d61 7474 6163 686d 656e 742e  ight=attachment.
-00010b20: 616e 696d 6174 6564 5f69 6d61 6765 5f6f  animated_image_o
-00010b30: 7269 6769 6e61 6c5f 6469 6d65 6e73 696f  riginal_dimensio
-00010b40: 6e73 2e79 2c0a 2020 2020 2020 2020 2020  ns.y,.          
-00010b50: 2020 2020 2020 2020 2020 6d69 6d65 7479            mimety
-00010b60: 7065 3d61 7474 6163 686d 656e 742e 6d69  pe=attachment.mi
-00010b70: 6d65 7479 7065 2c0a 2020 2020 2020 2020  metype,.        
-00010b80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00010b90: 2020 2020 2020 2020 2020 6675 6c6c 5f73            full_s
-00010ba0: 6372 6565 6e20 3d20 6174 7461 6368 6d65  creen = attachme
-00010bb0: 6e74 2e61 6e69 6d61 7465 645f 696d 6167  nt.animated_imag
-00010bc0: 655f 6675 6c6c 5f73 6372 6565 6e0a 2020  e_full_screen.  
-00010bd0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-00010be0: 6675 6c6c 5f73 6372 6565 6e2e 7572 690a  full_screen.uri.
-00010bf0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00010c00: 696e 666f 2e77 6964 7468 2c20 696e 666f  info.width, info
-00010c10: 2e68 6569 6768 7429 203e 2066 756c 6c5f  .height) > full_
-00010c20: 7363 7265 656e 2e64 696d 656e 7369 6f6e  screen.dimension
-00010c30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010c40: 2020 2075 726c 203d 2061 7761 6974 2073     url = await s
-00010c50: 6f75 7263 652e 636c 6965 6e74 2e67 6574  ource.client.get
-00010c60: 5f69 6d61 6765 5f75 726c 286d 7367 5f69  _image_url(msg_i
-00010c70: 642c 2061 7474 6163 686d 656e 742e 6174  d, attachment.at
-00010c80: 7461 6368 6d65 6e74 5f66 6269 6429 206f  tachment_fbid) o
-00010c90: 7220 7572 6c0a 2020 2020 2020 2020 2020  r url.          
-00010ca0: 2020 7265 6665 7265 7220 3d20 226d 6573    referer = "mes
-00010cb0: 7365 6e67 6572 5f74 6872 6561 645f 7068  senger_thread_ph
-00010cc0: 6f74 6f22 0a20 2020 2020 2020 2065 6c69  oto".        eli
-00010cd0: 6620 6174 7461 6368 6d65 6e74 2e74 7970  f attachment.typ
-00010ce0: 656e 616d 6520 3d3d 2067 7261 7068 716c  ename == graphql
-00010cf0: 2e41 7474 6163 686d 656e 7454 7970 652e  .AttachmentType.
-00010d00: 4155 4449 4f3a 0a20 2020 2020 2020 2020  AUDIO:.         
-00010d10: 2020 206d 7367 7479 7065 203d 204d 6573     msgtype = Mes
-00010d20: 7361 6765 5479 7065 2e41 5544 494f 0a20  sageType.AUDIO. 
-00010d30: 2020 2020 2020 2020 2020 2069 6e66 6f20             info 
-00010d40: 3d20 4175 6469 6f49 6e66 6f28 0a20 2020  = AudioInfo(.   
-00010d50: 2020 2020 2020 2020 2020 2020 2064 7572               dur
-00010d60: 6174 696f 6e3d 6174 7461 6368 6d65 6e74  ation=attachment
-00010d70: 2e70 6c61 7961 626c 655f 6475 7261 7469  .playable_durati
-00010d80: 6f6e 5f69 6e5f 6d73 2c0a 2020 2020 2020  on_in_ms,.      
-00010d90: 2020 2020 2020 2020 2020 6d69 6d65 7479            mimety
-00010da0: 7065 3d61 7474 6163 686d 656e 742e 6d69  pe=attachment.mi
-00010db0: 6d65 7479 7065 2c0a 2020 2020 2020 2020  metype,.        
-00010dc0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00010dd0: 2020 7572 6c20 3d20 6174 7461 6368 6d65    url = attachme
-00010de0: 6e74 2e70 6c61 7961 626c 655f 7572 6c0a  nt.playable_url.
-00010df0: 2020 2020 2020 2020 656c 6966 2061 7474          elif att
-00010e00: 6163 686d 656e 742e 7479 7065 6e61 6d65  achment.typename
-00010e10: 203d 3d20 6772 6170 6871 6c2e 4174 7461   == graphql.Atta
-00010e20: 6368 6d65 6e74 5479 7065 2e56 4944 454f  chmentType.VIDEO
-00010e30: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-00010e40: 6774 7970 6520 3d20 4d65 7373 6167 6554  gtype = MessageT
-00010e50: 7970 652e 5649 4445 4f0a 2020 2020 2020  ype.VIDEO.      
-00010e60: 2020 2020 2020 696e 666f 203d 2056 6964        info = Vid
-00010e70: 656f 496e 666f 280a 2020 2020 2020 2020  eoInfo(.        
-00010e80: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-00010e90: 3d61 7474 6163 686d 656e 742e 706c 6179  =attachment.play
-00010ea0: 6162 6c65 5f64 7572 6174 696f 6e5f 696e  able_duration_in
-00010eb0: 5f6d 732c 0a20 2020 2020 2020 2020 2020  _ms,.           
-00010ec0: 2020 2020 206d 696d 6574 7970 653d 6174       mimetype=at
-00010ed0: 7461 6368 6d65 6e74 2e6d 696d 6574 7970  tachment.mimetyp
-00010ee0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-00010ef0: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-00010f00: 203d 2061 7474 6163 686d 656e 742e 6174   = attachment.at
-00010f10: 7461 6368 6d65 6e74 5f76 6964 656f 5f75  tachment_video_u
-00010f20: 726c 0a20 2020 2020 2020 2065 6c69 6620  rl.        elif 
-00010f30: 6174 7461 6368 6d65 6e74 2e74 7970 656e  attachment.typen
-00010f40: 616d 6520 3d3d 2067 7261 7068 716c 2e41  ame == graphql.A
-00010f50: 7474 6163 686d 656e 7454 7970 652e 4649  ttachmentType.FI
-00010f60: 4c45 3a0a 2020 2020 2020 2020 2020 2020  LE:.            
-00010f70: 6d73 6774 7970 6520 3d20 4d65 7373 6167  msgtype = Messag
-00010f80: 6554 7970 652e 4649 4c45 0a20 2020 2020  eType.FILE.     
-00010f90: 2020 2020 2020 2075 726c 203d 2061 7761         url = awa
-00010fa0: 6974 2073 6f75 7263 652e 636c 6965 6e74  it source.client
-00010fb0: 2e67 6574 5f66 696c 655f 7572 6c28 7365  .get_file_url(se
-00010fc0: 6c66 2e66 6269 642c 206d 7367 5f69 642c  lf.fbid, msg_id,
-00010fd0: 2061 7474 6163 686d 656e 742e 6174 7461   attachment.atta
-00010fe0: 6368 6d65 6e74 5f66 6269 6429 0a20 2020  chment_fbid).   
-00010ff0: 2020 2020 2020 2020 2069 6e66 6f20 3d20           info = 
-00011000: 4669 6c65 496e 666f 286d 696d 6574 7970  FileInfo(mimetyp
-00011010: 653d 6174 7461 6368 6d65 6e74 2e6d 696d  e=attachment.mim
-00011020: 6574 7970 6529 0a20 2020 2020 2020 2065  etype).        e
-00011030: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00011040: 2023 2054 4f44 4f20 6c6f 6361 7469 6f6e   # TODO location
-00011050: 2061 7474 6163 686d 656e 7473 0a20 2020   attachments.   
-00011060: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
-00011070: 2255 6e73 7570 706f 7274 6564 2061 7474  "Unsupported att
-00011080: 6163 686d 656e 7420 7479 7065 207b 6174  achment type {at
-00011090: 7461 6368 6d65 6e74 2e74 7970 656e 616d  tachment.typenam
-000110a0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
-000110b0: 7365 6c66 2e6c 6f67 2e77 6172 6e69 6e67  self.log.warning
-000110c0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
-000110d0: 2020 7265 7475 726e 2054 6578 744d 6573    return TextMes
-000110e0: 7361 6765 4576 656e 7443 6f6e 7465 6e74  sageEventContent
-000110f0: 286d 7367 7479 7065 3d4d 6573 7361 6765  (msgtype=Message
-00011100: 5479 7065 2e4e 4f54 4943 452c 2062 6f64  Type.NOTICE, bod
-00011110: 793d 6d73 6729 0a20 2020 2020 2020 206d  y=msg).        m
-00011120: 7863 2c20 6164 6469 7469 6f6e 616c 5f69  xc, additional_i
-00011130: 6e66 6f2c 2064 6563 7279 7074 696f 6e5f  nfo, decryption_
-00011140: 696e 666f 203d 2061 7761 6974 2073 656c  info = await sel
-00011150: 662e 5f72 6575 706c 6f61 645f 6662 5f66  f._reupload_fb_f
-00011160: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
-00011170: 2075 726c 2c0a 2020 2020 2020 2020 2020   url,.          
-00011180: 2020 736f 7572 6365 2c0a 2020 2020 2020    source,.      
-00011190: 2020 2020 2020 696e 7465 6e74 2c0a 2020        intent,.  
-000111a0: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-000111b0: 6d65 3d66 696c 656e 616d 652c 0a20 2020  me=filename,.   
-000111c0: 2020 2020 2020 2020 2065 6e63 7279 7074           encrypt
-000111d0: 3d73 656c 662e 656e 6372 7970 7465 642c  =self.encrypted,
-000111e0: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
-000111f0: 645f 7369 7a65 3d46 616c 7365 2c0a 2020  d_size=False,.  
-00011200: 2020 2020 2020 2020 2020 7265 6665 7265            refere
-00011210: 723d 7265 6665 7265 722c 0a20 2020 2020  r=referer,.     
-00011220: 2020 2029 0a20 2020 2020 2020 2069 6e66     ).        inf
-00011230: 6f2e 7369 7a65 203d 2061 6464 6974 696f  o.size = additio
-00011240: 6e61 6c5f 696e 666f 2e73 697a 650a 2020  nal_info.size.  
-00011250: 2020 2020 2020 7265 7475 726e 204d 6564        return Med
-00011260: 6961 4d65 7373 6167 6545 7665 6e74 436f  iaMessageEventCo
-00011270: 6e74 656e 7428 0a20 2020 2020 2020 2020  ntent(.         
-00011280: 2020 2075 726c 3d6d 7863 2c20 6669 6c65     url=mxc, file
-00011290: 3d64 6563 7279 7074 696f 6e5f 696e 666f  =decryption_info
-000112a0: 2c20 6d73 6774 7970 653d 6d73 6774 7970  , msgtype=msgtyp
-000112b0: 652c 2062 6f64 793d 6669 6c65 6e61 6d65  e, body=filename
-000112c0: 2c20 696e 666f 3d69 6e66 6f0a 2020 2020  , info=info.    
-000112d0: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
-000112e0: 2064 6566 205f 636f 6e76 6572 745f 6661   def _convert_fa
-000112f0: 6365 626f 6f6b 5f6c 6f63 6174 696f 6e28  cebook_location(
-00011300: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
-00011310: 6f75 7263 653a 2075 2e55 7365 722c 2069  ource: u.User, i
-00011320: 6e74 656e 743a 2049 6e74 656e 7441 5049  ntent: IntentAPI
-00011330: 2c20 6c6f 6361 7469 6f6e 3a20 6772 6170  , location: grap
-00011340: 6871 6c2e 5374 6f72 7954 6172 6765 740a  hql.StoryTarget.
-00011350: 2020 2020 2920 2d3e 204c 6f63 6174 696f      ) -> Locatio
-00011360: 6e4d 6573 7361 6765 4576 656e 7443 6f6e  nMessageEventCon
-00011370: 7465 6e74 207c 2054 6578 744d 6573 7361  tent | TextMessa
-00011380: 6765 4576 656e 7443 6f6e 7465 6e74 3a0a  geEventContent:.
-00011390: 2020 2020 2020 2020 6c6f 6e67 2c20 6c61          long, la
-000113a0: 7420 3d20 6c6f 6361 7469 6f6e 2e63 6f6f  t = location.coo
-000113b0: 7264 696e 6174 6573 2e6c 6f6e 6769 7475  rdinates.longitu
-000113c0: 6465 2c20 6c6f 6361 7469 6f6e 2e63 6f6f  de, location.coo
-000113d0: 7264 696e 6174 6573 2e6c 6174 6974 7564  rdinates.latitud
-000113e0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-000113f0: 206c 6f6e 6720 6f72 206e 6f74 206c 6174   long or not lat
-00011400: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00011410: 6966 206c 6f63 6174 696f 6e2e 6164 6472  if location.addr
-00011420: 6573 7320 6f72 206c 6f63 6174 696f 6e2e  ess or location.
-00011430: 7572 6c3a 0a20 2020 2020 2020 2020 2020  url:.           
-00011440: 2023 2020 2020 2073 656c 662e 6c6f 672e   #     self.log.
-00011450: 7472 6163 6528 224c 6f63 6174 696f 6e20  trace("Location 
-00011460: 6d65 7373 6167 6520 7769 7468 206e 6f20  message with no 
-00011470: 636f 6f72 6469 6e61 7465 733a 2025 7322  coordinates: %s"
-00011480: 2c20 6c6f 6361 7469 6f6e 290a 2020 2020  , location).    
-00011490: 2020 2020 2020 2020 2320 2020 2020 7265          #     re
-000114a0: 7475 726e 2054 6578 744d 6573 7361 6765  turn TextMessage
-000114b0: 4576 656e 7443 6f6e 7465 6e74 286d 7367  EventContent(msg
-000114c0: 7479 7065 3d4d 6573 7361 6765 5479 7065  type=MessageType
-000114d0: 2e54 4558 542c 0a20 2020 2020 2020 2020  .TEXT,.         
-000114e0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-000114f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011500: 2020 2020 2020 2020 626f 6479 3d66 227b          body=f"{
-00011510: 6c6f 6361 7469 6f6e 2e61 6464 7265 7373  location.address
-00011520: 7d5c 6e7b 6c6f 6361 7469 6f6e 2e75 726c  }\n{location.url
-00011530: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-00011540: 2320 656c 7365 3a0a 2020 2020 2020 2020  # else:.        
-00011550: 2020 2020 7365 6c66 2e6c 6f67 2e77 6172      self.log.war
-00011560: 6e69 6e67 2822 556e 7375 7070 6f72 7465  ning("Unsupporte
-00011570: 6420 4661 6365 626f 6f6b 206c 6f63 6174  d Facebook locat
-00011580: 696f 6e20 6d65 7373 6167 6520 636f 6e74  ion message cont
-00011590: 656e 743a 2025 7322 2c20 6c6f 6361 7469  ent: %s", locati
-000115a0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-000115b0: 7265 7475 726e 2054 6578 744d 6573 7361  return TextMessa
-000115c0: 6765 4576 656e 7443 6f6e 7465 6e74 280a  geEventContent(.
-000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115e0: 6d73 6774 7970 653d 4d65 7373 6167 6554  msgtype=MessageT
-000115f0: 7970 652e 4e4f 5449 4345 2c0a 2020 2020  ype.NOTICE,.    
-00011600: 2020 2020 2020 2020 2020 2020 626f 6479              body
-00011610: 3d22 4c6f 6361 7469 6f6e 206d 6573 7361  ="Location messa
-00011620: 6765 2077 6974 6820 756e 7375 7070 6f72  ge with unsuppor
-00011630: 7465 6420 636f 6e74 656e 7422 2c0a 2020  ted content",.  
-00011640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00011650: 2020 2020 6c6f 6e67 5f63 6861 7220 3d20      long_char = 
-00011660: 2245 2220 6966 206c 6f6e 6720 3e20 3020  "E" if long > 0 
-00011670: 656c 7365 2022 5722 0a20 2020 2020 2020  else "W".       
-00011680: 206c 6174 5f63 6861 7220 3d20 224e 2220   lat_char = "N" 
-00011690: 6966 206c 6174 203e 2030 2065 6c73 6520  if lat > 0 else 
-000116a0: 2253 220a 2020 2020 2020 2020 6765 6f20  "S".        geo 
-000116b0: 3d20 6622 7b72 6f75 6e64 286c 6174 2c20  = f"{round(lat, 
-000116c0: 3629 7d2c 7b72 6f75 6e64 286c 6f6e 672c  6)},{round(long,
-000116d0: 2036 297d 220a 0a20 2020 2020 2020 2074   6)}"..        t
-000116e0: 6578 7420 3d20 6622 7b72 6f75 6e64 2861  ext = f"{round(a
-000116f0: 6273 286c 6174 292c 2034 297d c2b0 207b  bs(lat), 4)}.. {
-00011700: 6c61 745f 6368 6172 7d2c 207b 726f 756e  lat_char}, {roun
-00011710: 6428 6162 7328 6c6f 6e67 292c 2034 297d  d(abs(long), 4)}
-00011720: c2b0 207b 6c6f 6e67 5f63 6861 727d 220a  .. {long_char}".
-00011730: 2020 2020 2020 2020 7572 6c20 3d20 6622          url = f"
-00011740: 6874 7470 733a 2f2f 6d61 7073 2e67 6f6f  https://maps.goo
-00011750: 676c 652e 636f 6d2f 3f71 3d7b 6765 6f7d  gle.com/?q={geo}
-00011760: 220a 0a20 2020 2020 2020 2063 6f6e 7465  "..        conte
-00011770: 6e74 203d 204c 6f63 6174 696f 6e4d 6573  nt = LocationMes
-00011780: 7361 6765 4576 656e 7443 6f6e 7465 6e74  sageEventContent
-00011790: 280a 2020 2020 2020 2020 2020 2020 626f  (.            bo
-000117a0: 6479 3d66 224c 6f63 6174 696f 6e3a 207b  dy=f"Location: {
-000117b0: 7465 7874 7d5c 6e7b 7572 6c7d 222c 0a20  text}\n{url}",. 
-000117c0: 2020 2020 2020 2020 2020 2067 656f 5f75             geo_u
-000117d0: 7269 3d66 2267 656f 3a7b 6c61 747d 2c7b  ri=f"geo:{lat},{
-000117e0: 6c6f 6e67 7d22 2c0a 2020 2020 2020 2020  long}",.        
-000117f0: 2020 2020 6d73 6774 7970 653d 4d65 7373      msgtype=Mess
-00011800: 6167 6554 7970 652e 4c4f 4341 5449 4f4e  ageType.LOCATION
-00011810: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00011820: 2020 2020 2320 536f 6d65 2063 6c69 656e      # Some clien
-00011830: 7473 2073 7570 706f 7274 2066 6f72 6d61  ts support forma
-00011840: 7474 6564 2062 6f64 7920 696e 206d 2e6c  tted body in m.l
-00011850: 6f63 6174 696f 6e2c 2073 6f20 6164 6420  ocation, so add 
-00011860: 7468 6174 2061 7320 7765 6c6c 2e0a 2020  that as well..  
-00011870: 2020 2020 2020 636f 6e74 656e 745b 2266        content["f
-00011880: 6f72 6d61 7422 5d20 3d20 7374 7228 466f  ormat"] = str(Fo
-00011890: 726d 6174 2e48 544d 4c29 0a20 2020 2020  rmat.HTML).     
-000118a0: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
-000118b0: 6174 7465 645f 626f 6479 225d 203d 2066  atted_body"] = f
-000118c0: 223c 703e 4c6f 6361 7469 6f6e 3a20 3c61  "<p>Location: <a
-000118d0: 2068 7265 663d 277b 7572 6c7d 273e 7b74   href='{url}'>{t
-000118e0: 6578 747d 3c2f 613e 3c2f 7022 0a20 2020  ext}</a></p".   
-000118f0: 2020 2020 2023 2054 4f44 4f20 6669 6e64       # TODO find
-00011900: 206f 7574 2069 6620 6c6f 6361 7469 6f6e   out if location
-00011910: 7320 7374 696c 6c20 6861 7665 2061 6464  s still have add
-00011920: 7265 7373 6573 0a20 2020 2020 2020 2023  resses.        #
-00011930: 2069 6620 6c6f 6361 7469 6f6e 2e61 6464   if location.add
-00011940: 7265 7373 3a0a 2020 2020 2020 2020 2320  ress:.        # 
-00011950: 2020 2020 636f 6e74 656e 742e 626f 6479      content.body
-00011960: 203d 2066 227b 6c6f 6361 7469 6f6e 2e61   = f"{location.a
-00011970: 6464 7265 7373 7d5c 6e7b 636f 6e74 656e  ddress}\n{conten
-00011980: 742e 626f 6479 7d22 0a20 2020 2020 2020  t.body}".       
-00011990: 2023 2020 2020 2063 6f6e 7465 6e74 5b22   #     content["
-000119a0: 666f 726d 6174 7465 645f 626f 6479 225d  formatted_body"]
-000119b0: 203d 2066 223c 703e 7b6c 6f63 6174 696f   = f"<p>{locatio
-000119c0: 6e2e 6164 6472 6573 737d 3c2f 703e 7b63  n.address}</p>{c
-000119d0: 6f6e 7465 6e74 5b27 666f 726d 6174 7465  ontent['formatte
-000119e0: 645f 626f 6479 275d 7d22 0a20 2020 2020  d_body']}".     
-000119f0: 2020 2072 6574 7572 6e20 636f 6e74 656e     return conten
-00011a00: 740a 0a20 2020 2061 7379 6e63 2064 6566  t..    async def
-00011a10: 2068 616e 646c 655f 6661 6365 626f 6f6b   handle_facebook
-00011a20: 5f75 6e73 656e 6428 0a20 2020 2020 2020  _unsend(.       
-00011a30: 2073 656c 662c 2073 656e 6465 723a 2070   self, sender: p
-00011a40: 2e50 7570 7065 742c 206d 6573 7361 6765  .Puppet, message
-00011a50: 5f69 643a 2073 7472 2c20 7469 6d65 7374  _id: str, timest
-00011a60: 616d 703a 2069 6e74 0a20 2020 2029 202d  amp: int.    ) -
-00011a70: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00011a80: 6966 206e 6f74 2073 656c 662e 6d78 6964  if not self.mxid
-00011a90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00011aa0: 7475 726e 0a20 2020 2020 2020 2066 6f72  turn.        for
-00011ab0: 206d 6573 7361 6765 2069 6e20 6177 6169   message in awai
-00011ac0: 7420 4442 4d65 7373 6167 652e 6765 745f  t DBMessage.get_
-00011ad0: 616c 6c5f 6279 5f66 6269 6428 6d65 7373  all_by_fbid(mess
-00011ae0: 6167 655f 6964 2c20 7365 6c66 2e66 625f  age_id, self.fb_
-00011af0: 7265 6365 6976 6572 293a 0a20 2020 2020  receiver):.     
-00011b00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00011b10: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00011b20: 7420 7365 6e64 6572 2e69 6e74 656e 745f  t sender.intent_
-00011b30: 666f 7228 7365 6c66 292e 7265 6461 6374  for(self).redact
-00011b40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011b50: 2020 2020 2020 6d65 7373 6167 652e 6d78        message.mx
-00011b60: 5f72 6f6f 6d2c 206d 6573 7361 6765 2e6d  _room, message.m
-00011b70: 7869 642c 2074 696d 6573 7461 6d70 3d74  xid, timestamp=t
-00011b80: 696d 6573 7461 6d70 0a20 2020 2020 2020  imestamp.       
-00011b90: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00011ba0: 2020 2020 2020 2065 7863 6570 7420 4d46         except MF
-00011bb0: 6f72 6269 6464 656e 3a0a 2020 2020 2020  orbidden:.      
-00011bc0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00011bd0: 7365 6c66 2e6d 6169 6e5f 696e 7465 6e74  self.main_intent
-00011be0: 2e72 6564 6163 7428 6d65 7373 6167 652e  .redact(message.
-00011bf0: 6d78 5f72 6f6f 6d2c 206d 6573 7361 6765  mx_room, message
-00011c00: 2e6d 7869 642c 2074 696d 6573 7461 6d70  .mxid, timestamp
-00011c10: 3d74 696d 6573 7461 6d70 290a 2020 2020  =timestamp).    
-00011c20: 2020 2020 2020 2020 6177 6169 7420 6d65          await me
-00011c30: 7373 6167 652e 6465 6c65 7465 2829 0a0a  ssage.delete()..
-00011c40: 2020 2020 6173 796e 6320 6465 6620 6861      async def ha
-00011c50: 6e64 6c65 5f66 6163 6562 6f6f 6b5f 7365  ndle_facebook_se
-00011c60: 656e 2873 656c 662c 2073 6f75 7263 653a  en(self, source:
-00011c70: 2075 2e55 7365 722c 2073 656e 6465 723a   u.User, sender:
-00011c80: 2070 2e50 7570 7065 742c 2074 696d 6573   p.Puppet, times
-00011c90: 7461 6d70 3a20 696e 7429 202d 3e20 4e6f  tamp: int) -> No
-00011ca0: 6e65 3a0a 2020 2020 2020 2020 6966 206e  ne:.        if n
-00011cb0: 6f74 2073 656c 662e 6d78 6964 3a0a 2020  ot self.mxid:.  
-00011cc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011cd0: 0a20 2020 2020 2020 206d 7367 203d 2061  .        msg = a
-00011ce0: 7761 6974 2044 424d 6573 7361 6765 2e67  wait DBMessage.g
-00011cf0: 6574 5f63 6c6f 7365 7374 5f62 6566 6f72  et_closest_befor
-00011d00: 6528 7365 6c66 2e66 6269 642c 2073 656c  e(self.fbid, sel
-00011d10: 662e 6662 5f72 6563 6569 7665 722c 2074  f.fb_receiver, t
-00011d20: 696d 6573 7461 6d70 290a 2020 2020 2020  imestamp).      
-00011d30: 2020 6966 206e 6f74 206d 7367 3a0a 2020    if not msg:.  
-00011d40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011d50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00011d60: 6177 6169 7420 7365 6c66 2e5f 6272 6964  await self._brid
-00011d70: 6765 5f6f 776e 5f6d 6573 7361 6765 5f70  ge_own_message_p
-00011d80: 6d28 736f 7572 6365 2c20 7365 6e64 6572  m(source, sender
-00011d90: 2c20 2272 6561 6420 7265 6365 6970 7422  , "read receipt"
-00011da0: 2c20 696e 7669 7465 3d46 616c 7365 293a  , invite=False):
-00011db0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00011dc0: 7572 6e0a 2020 2020 2020 2020 2320 544f  urn.        # TO
-00011dd0: 444f 2063 616e 2077 6520 7365 7420 6120  DO can we set a 
-00011de0: 7469 6d65 7374 616d 7020 7768 656e 2074  timestamp when t
-00011df0: 6865 2072 6561 6420 7265 6365 6970 7420  he read receipt 
-00011e00: 6861 7070 656e 6564 3f0a 2020 2020 2020  happened?.      
-00011e10: 2020 6177 6169 7420 7365 6e64 6572 2e69    await sender.i
-00011e20: 6e74 656e 745f 666f 7228 7365 6c66 292e  ntent_for(self).
-00011e30: 6d61 726b 5f72 6561 6428 6d73 672e 6d78  mark_read(msg.mx
-00011e40: 5f72 6f6f 6d2c 206d 7367 2e6d 7869 6429  _room, msg.mxid)
-00011e50: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00011e60: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-00011e70: 2020 2020 2066 2248 616e 646c 6564 204d       f"Handled M
-00011e80: 6573 7365 6e67 6572 2072 6561 6420 7265  essenger read re
-00011e90: 6365 6970 7420 6672 6f6d 207b 7365 6e64  ceipt from {send
-00011ea0: 6572 2e66 6269 647d 2075 7020 746f 207b  er.fbid} up to {
-00011eb0: 7469 6d65 7374 616d 707d 2f7b 6d73 672e  timestamp}/{msg.
-00011ec0: 6d78 6964 7d22 0a20 2020 2020 2020 2029  mxid}".        )
-00011ed0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00011ee0: 6861 6e64 6c65 5f66 6163 6562 6f6f 6b5f  handle_facebook_
-00011ef0: 7479 7069 6e67 2873 656c 662c 2073 6f75  typing(self, sou
-00011f00: 7263 653a 2075 2e55 7365 722c 2073 656e  rce: u.User, sen
-00011f10: 6465 723a 2070 2e50 7570 7065 7429 202d  der: p.Puppet) -
-00011f20: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00011f30: 6966 206e 6f74 2061 7761 6974 2073 656c  if not await sel
-00011f40: 662e 5f62 7269 6467 655f 6f77 6e5f 6d65  f._bridge_own_me
-00011f50: 7373 6167 655f 706d 280a 2020 2020 2020  ssage_pm(.      
-00011f60: 2020 2020 2020 736f 7572 6365 2c20 7365        source, se
-00011f70: 6e64 6572 2c20 2274 7970 696e 6720 6e6f  nder, "typing no
-00011f80: 7469 6669 6361 7469 6f6e 222c 2069 6e76  tification", inv
-00011f90: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
-00011fa0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00011fb0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00011fc0: 6177 6169 7420 7365 6e64 6572 2e69 6e74  await sender.int
-00011fd0: 656e 742e 7365 745f 7479 7069 6e67 2873  ent.set_typing(s
-00011fe0: 656c 662e 6d78 6964 2c20 6973 5f74 7970  elf.mxid, is_typ
-00011ff0: 696e 673d 5472 7565 290a 0a20 2020 2061  ing=True)..    a
-00012000: 7379 6e63 2064 6566 2068 616e 646c 655f  sync def handle_
-00012010: 6661 6365 626f 6f6b 5f70 686f 746f 280a  facebook_photo(.
-00012020: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00012030: 2020 2020 2020 736f 7572 6365 3a20 752e        source: u.
-00012040: 5573 6572 2c0a 2020 2020 2020 2020 7365  User,.        se
-00012050: 6e64 6572 3a20 702e 5075 7070 6574 2c0a  nder: p.Puppet,.
-00012060: 2020 2020 2020 2020 6e65 775f 7068 6f74          new_phot
-00012070: 6f3a 206d 7174 742e 4174 7461 6368 6d65  o: mqtt.Attachme
-00012080: 6e74 2c0a 2020 2020 2020 2020 6d65 7373  nt,.        mess
-00012090: 6167 655f 6964 3a20 7374 722c 0a20 2020  age_id: str,.   
-000120a0: 2020 2020 2074 696d 6573 7461 6d70 3a20       timestamp: 
-000120b0: 696e 742c 0a20 2020 2029 202d 3e20 4e6f  int,.    ) -> No
-000120c0: 6e65 3a0a 2020 2020 2020 2020 6966 206e  ne:.        if n
-000120d0: 6f74 2073 656c 662e 6d78 6964 206f 7220  ot self.mxid or 
-000120e0: 7365 6c66 2e69 735f 6469 7265 6374 206f  self.is_direct o
-000120f0: 7220 6d65 7373 6167 655f 6964 2069 6e20  r message_id in 
-00012100: 7365 6c66 2e5f 6465 6475 703a 0a20 2020  self._dedup:.   
-00012110: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00012120: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
-00012130: 6475 702e 6170 7065 6e64 6c65 6674 286d  dup.appendleft(m
-00012140: 6573 7361 6765 5f69 6429 0a20 2020 2020  essage_id).     
-00012150: 2020 2070 686f 746f 5f75 726c 203d 2061     photo_url = a
-00012160: 7761 6974 2073 6f75 7263 652e 636c 6965  wait source.clie
-00012170: 6e74 2e67 6574 5f69 6d61 6765 5f75 726c  nt.get_image_url
-00012180: 286d 6573 7361 6765 5f69 642c 206e 6577  (message_id, new
-00012190: 5f70 686f 746f 2e6d 6564 6961 5f69 6429  _photo.media_id)
-000121a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000121b0: 7068 6f74 6f5f 7572 6c20 616e 6420 6e65  photo_url and ne
-000121c0: 775f 7068 6f74 6f2e 696d 6167 655f 696e  w_photo.image_in
-000121d0: 666f 2e75 7269 5f6d 6170 3a0a 2020 2020  fo.uri_map:.    
-000121e0: 2020 2020 2020 2020 7068 6f74 6f5f 7572          photo_ur
-000121f0: 6c20 3d20 6c69 7374 286e 6577 5f70 686f  l = list(new_pho
-00012200: 746f 2e69 6d61 6765 5f69 6e66 6f2e 7572  to.image_info.ur
-00012210: 695f 6d61 702e 7661 6c75 6573 2829 295b  i_map.values())[
-00012220: 2d31 5d0a 2020 2020 2020 2020 7068 6f74  -1].        phot
-00012230: 6f5f 6964 203d 2073 656c 662e 6765 745f  o_id = self.get_
-00012240: 7068 6f74 6f5f 6964 2870 686f 746f 5f75  photo_id(photo_u
-00012250: 726c 290a 2020 2020 2020 2020 6966 2073  rl).        if s
-00012260: 656c 662e 7068 6f74 6f5f 6964 203d 3d20  elf.photo_id == 
-00012270: 7068 6f74 6f5f 6964 3a0a 2020 2020 2020  photo_id:.      
-00012280: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00012290: 2020 2020 2073 656c 662e 7068 6f74 6f5f       self.photo_
-000122a0: 6964 203d 2070 686f 746f 5f69 640a 2020  id = photo_id.  
-000122b0: 2020 2020 2020 7365 6c66 2e61 7661 7461        self.avata
-000122c0: 725f 7572 6c2c 202a 5f20 3d20 6177 6169  r_url, *_ = awai
-000122d0: 7420 7365 6c66 2e5f 7265 7570 6c6f 6164  t self._reupload
-000122e0: 5f66 625f 6669 6c65 2870 686f 746f 5f75  _fb_file(photo_u
-000122f0: 726c 2c20 736f 7572 6365 2c20 7365 6e64  rl, source, send
-00012300: 6572 2e69 6e74 656e 7429 0a20 2020 2020  er.intent).     
-00012310: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00012320: 2020 2020 6576 656e 745f 6964 203d 2061      event_id = a
-00012330: 7761 6974 2073 656e 6465 722e 696e 7465  wait sender.inte
-00012340: 6e74 2e73 6574 5f72 6f6f 6d5f 6176 6174  nt.set_room_avat
-00012350: 6172 2873 656c 662e 6d78 6964 2c20 7365  ar(self.mxid, se
-00012360: 6c66 2e61 7661 7461 725f 7572 6c29 0a20  lf.avatar_url). 
-00012370: 2020 2020 2020 2065 7863 6570 7420 496e         except In
-00012380: 7465 6e74 4572 726f 723a 0a20 2020 2020  tentError:.     
-00012390: 2020 2020 2020 2065 7665 6e74 5f69 6420         event_id 
-000123a0: 3d20 6177 6169 7420 7365 6c66 2e6d 6169  = await self.mai
-000123b0: 6e5f 696e 7465 6e74 2e73 6574 5f72 6f6f  n_intent.set_roo
-000123c0: 6d5f 6176 6174 6172 2873 656c 662e 6d78  m_avatar(self.mx
-000123d0: 6964 2c20 7365 6c66 2e61 7661 7461 725f  id, self.avatar_
-000123e0: 7572 6c29 0a20 2020 2020 2020 2061 7761  url).        awa
-000123f0: 6974 2073 656c 662e 7361 7665 2829 0a20  it self.save(). 
-00012400: 2020 2020 2020 2061 7761 6974 2044 424d         await DBM
-00012410: 6573 7361 6765 280a 2020 2020 2020 2020  essage(.        
-00012420: 2020 2020 6d78 6964 3d65 7665 6e74 5f69      mxid=event_i
-00012430: 642c 0a20 2020 2020 2020 2020 2020 206d  d,.            m
-00012440: 785f 726f 6f6d 3d73 656c 662e 6d78 6964  x_room=self.mxid
-00012450: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-00012460: 6465 783d 302c 0a20 2020 2020 2020 2020  dex=0,.         
-00012470: 2020 2074 696d 6573 7461 6d70 3d74 696d     timestamp=tim
-00012480: 6573 7461 6d70 2c0a 2020 2020 2020 2020  estamp,.        
-00012490: 2020 2020 6662 6964 3d6d 6573 7361 6765      fbid=message
-000124a0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-000124b0: 2066 625f 6368 6174 3d73 656c 662e 6662   fb_chat=self.fb
-000124c0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000124d0: 6662 5f72 6563 6569 7665 723d 7365 6c66  fb_receiver=self
-000124e0: 2e66 625f 7265 6365 6976 6572 2c0a 2020  .fb_receiver,.  
-000124f0: 2020 2020 2020 2020 2020 6662 5f73 656e            fb_sen
-00012500: 6465 723d 7365 6e64 6572 2e66 6269 642c  der=sender.fbid,
-00012510: 0a20 2020 2020 2020 2020 2020 2066 625f  .            fb_
-00012520: 7478 6e5f 6964 3d4e 6f6e 652c 0a20 2020  txn_id=None,.   
-00012530: 2020 2020 2029 2e69 6e73 6572 7428 290a       ).insert().
-00012540: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00012550: 6c66 2e75 7064 6174 655f 6272 6964 6765  lf.update_bridge
-00012560: 5f69 6e66 6f28 290a 0a20 2020 2061 7379  _info()..    asy
-00012570: 6e63 2064 6566 2068 616e 646c 655f 6661  nc def handle_fa
-00012580: 6365 626f 6f6b 5f6e 616d 6528 0a20 2020  cebook_name(.   
-00012590: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000125a0: 2020 2073 6f75 7263 653a 2075 2e55 7365     source: u.Use
-000125b0: 722c 0a20 2020 2020 2020 2073 656e 6465  r,.        sende
-000125c0: 723a 2070 2e50 7570 7065 742c 0a20 2020  r: p.Puppet,.   
-000125d0: 2020 2020 206e 6577 5f6e 616d 653a 2073       new_name: s
-000125e0: 7472 2c0a 2020 2020 2020 2020 6d65 7373  tr,.        mess
-000125f0: 6167 655f 6964 3a20 7374 722c 0a20 2020  age_id: str,.   
-00012600: 2020 2020 2074 696d 6573 7461 6d70 3a20       timestamp: 
-00012610: 696e 742c 0a20 2020 2029 202d 3e20 4e6f  int,.    ) -> No
-00012620: 6e65 3a0a 2020 2020 2020 2020 6966 2073  ne:.        if s
-00012630: 656c 662e 6e61 6d65 203d 3d20 6e65 775f  elf.name == new_
-00012640: 6e61 6d65 206f 7220 6d65 7373 6167 655f  name or message_
-00012650: 6964 2069 6e20 7365 6c66 2e5f 6465 6475  id in self._dedu
-00012660: 703a 0a20 2020 2020 2020 2020 2020 2072  p:.            r
-00012670: 6574 7572 6e0a 2020 2020 2020 2020 7365  eturn.        se
-00012680: 6c66 2e5f 6465 6475 702e 6170 7065 6e64  lf._dedup.append
-00012690: 6c65 6674 286d 6573 7361 6765 5f69 6429  left(message_id)
-000126a0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
-000126b0: 6d65 203d 206e 6577 5f6e 616d 650a 2020  me = new_name.  
-000126c0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-000126d0: 662e 6d78 6964 206f 7220 7365 6c66 2e69  f.mxid or self.i
-000126e0: 735f 6469 7265 6374 3a0a 2020 2020 2020  s_direct:.      
-000126f0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00012700: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00012710: 2020 2020 2020 6576 656e 745f 6964 203d        event_id =
-00012720: 2061 7761 6974 2073 656e 6465 722e 696e   await sender.in
-00012730: 7465 6e74 2e73 6574 5f72 6f6f 6d5f 6e61  tent.set_room_na
-00012740: 6d65 2873 656c 662e 6d78 6964 2c20 7365  me(self.mxid, se
-00012750: 6c66 2e6e 616d 6529 0a20 2020 2020 2020  lf.name).       
-00012760: 2065 7863 6570 7420 496e 7465 6e74 4572   except IntentEr
-00012770: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00012780: 2065 7665 6e74 5f69 6420 3d20 6177 6169   event_id = awai
-00012790: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
-000127a0: 6e74 2e73 6574 5f72 6f6f 6d5f 6e61 6d65  nt.set_room_name
-000127b0: 2873 656c 662e 6d78 6964 2c20 7365 6c66  (self.mxid, self
-000127c0: 2e6e 616d 6529 0a20 2020 2020 2020 2061  .name).        a
-000127d0: 7761 6974 2073 656c 662e 7361 7665 2829  wait self.save()
-000127e0: 0a20 2020 2020 2020 2061 7761 6974 2044  .        await D
-000127f0: 424d 6573 7361 6765 280a 2020 2020 2020  BMessage(.      
-00012800: 2020 2020 2020 6d78 6964 3d65 7665 6e74        mxid=event
-00012810: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00012820: 206d 785f 726f 6f6d 3d73 656c 662e 6d78   mx_room=self.mx
-00012830: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00012840: 696e 6465 783d 302c 0a20 2020 2020 2020  index=0,.       
-00012850: 2020 2020 2074 696d 6573 7461 6d70 3d74       timestamp=t
-00012860: 696d 6573 7461 6d70 2c0a 2020 2020 2020  imestamp,.      
-00012870: 2020 2020 2020 6662 6964 3d6d 6573 7361        fbid=messa
-00012880: 6765 5f69 642c 0a20 2020 2020 2020 2020  ge_id,.         
-00012890: 2020 2066 625f 6368 6174 3d73 656c 662e     fb_chat=self.
-000128a0: 6662 6964 2c0a 2020 2020 2020 2020 2020  fbid,.          
-000128b0: 2020 6662 5f72 6563 6569 7665 723d 7365    fb_receiver=se
-000128c0: 6c66 2e66 625f 7265 6365 6976 6572 2c0a  lf.fb_receiver,.
-000128d0: 2020 2020 2020 2020 2020 2020 6662 5f73              fb_s
-000128e0: 656e 6465 723d 7365 6e64 6572 2e66 6269  ender=sender.fbi
-000128f0: 642c 0a20 2020 2020 2020 2020 2020 2066  d,.            f
-00012900: 625f 7478 6e5f 6964 3d4e 6f6e 652c 0a20  b_txn_id=None,. 
-00012910: 2020 2020 2020 2029 2e69 6e73 6572 7428         ).insert(
-00012920: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
-00012930: 7365 6c66 2e75 7064 6174 655f 6272 6964  self.update_brid
-00012940: 6765 5f69 6e66 6f28 290a 0a20 2020 2061  ge_info()..    a
-00012950: 7379 6e63 2064 6566 2068 616e 646c 655f  sync def handle_
-00012960: 6661 6365 626f 6f6b 5f72 6561 6374 696f  facebook_reactio
-00012970: 6e5f 6164 6428 0a20 2020 2020 2020 2073  n_add(.        s
-00012980: 656c 662c 0a20 2020 2020 2020 2073 6f75  elf,.        sou
-00012990: 7263 653a 2075 2e55 7365 722c 0a20 2020  rce: u.User,.   
-000129a0: 2020 2020 2073 656e 6465 723a 2070 2e50       sender: p.P
-000129b0: 7570 7065 7420 7c20 696e 742c 0a20 2020  uppet | int,.   
-000129c0: 2020 2020 206d 6573 7361 6765 5f69 643a       message_id:
-000129d0: 2073 7472 2c0a 2020 2020 2020 2020 7265   str,.        re
-000129e0: 6163 7469 6f6e 3a20 7374 722c 0a20 2020  action: str,.   
-000129f0: 2020 2020 2065 7869 7374 696e 673a 2044       existing: D
-00012a00: 4252 6561 6374 696f 6e20 7c20 4e6f 6e65  BReaction | None
-00012a10: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00012a20: 2074 6172 6765 745f 6d65 7373 6167 653a   target_message:
-00012a30: 2044 424d 6573 7361 6765 207c 204e 6f6e   DBMessage | Non
-00012a40: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00012a50: 2020 7469 6d65 7374 616d 703a 2069 6e74    timestamp: int
-00012a60: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00012a70: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00012a80: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00012a90: 616e 6365 2873 656e 6465 722c 2069 6e74  ance(sender, int
-00012aa0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00012ab0: 656e 6465 7220 3d20 6177 6169 7420 702e  ender = await p.
-00012ac0: 5075 7070 6574 2e67 6574 5f62 795f 6662  Puppet.get_by_fb
-00012ad0: 6964 2873 656e 6465 7229 0a20 2020 2020  id(sender).     
-00012ae0: 2020 2064 6564 7570 5f69 6420 3d20 6622     dedup_id = f"
-00012af0: 7265 6163 745f 7b6d 6573 7361 6765 5f69  react_{message_i
-00012b00: 647d 5f7b 7365 6e64 6572 2e66 6269 647d  d}_{sender.fbid}
-00012b10: 5f7b 7265 6163 7469 6f6e 7d22 0a20 2020  _{reaction}".   
-00012b20: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
-00012b30: 7365 6c66 2e6f 7074 696f 6e61 6c5f 7365  self.optional_se
-00012b40: 6e64 5f6c 6f63 6b28 7365 6e64 6572 2e66  nd_lock(sender.f
-00012b50: 6269 6429 3a0a 2020 2020 2020 2020 2020  bid):.          
-00012b60: 2020 6966 2064 6564 7570 5f69 6420 696e    if dedup_id in
-00012b70: 2073 656c 662e 5f64 6564 7570 3a0a 2020   self._dedup:.  
-00012b80: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00012b90: 6c66 2e6c 6f67 2e64 6562 7567 2866 2249  lf.log.debug(f"I
-00012ba0: 676e 6f72 696e 6720 6475 706c 6963 6174  gnoring duplicat
-00012bb0: 6520 7265 6163 7469 6f6e 2066 726f 6d20  e reaction from 
-00012bc0: 7b73 656e 6465 722e 6662 6964 7d20 746f  {sender.fbid} to
-00012bd0: 207b 6d65 7373 6167 655f 6964 7d22 290a   {message_id}").
-00012be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bf0: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-00012c00: 2020 2073 656c 662e 5f64 6564 7570 2e61     self._dedup.a
-00012c10: 7070 656e 646c 6566 7428 6465 6475 705f  ppendleft(dedup_
-00012c20: 6964 290a 0a20 2020 2020 2020 2069 6620  id)..        if 
-00012c30: 6e6f 7420 6578 6973 7469 6e67 3a0a 2020  not existing:.  
-00012c40: 2020 2020 2020 2020 2020 6578 6973 7469            existi
-00012c50: 6e67 203d 2061 7761 6974 2044 4252 6561  ng = await DBRea
-00012c60: 6374 696f 6e2e 6765 745f 6279 5f66 6269  ction.get_by_fbi
-00012c70: 6428 6d65 7373 6167 655f 6964 2c20 7365  d(message_id, se
-00012c80: 6c66 2e66 625f 7265 6365 6976 6572 2c20  lf.fb_receiver, 
-00012c90: 7365 6e64 6572 2e66 6269 6429 0a20 2020  sender.fbid).   
-00012ca0: 2020 2020 2020 2020 2069 6620 6578 6973           if exis
-00012cb0: 7469 6e67 2061 6e64 2065 7869 7374 696e  ting and existin
-00012cc0: 672e 7265 6163 7469 6f6e 203d 3d20 7265  g.reaction == re
-00012cd0: 6163 7469 6f6e 3a0a 2020 2020 2020 2020  action:.        
-00012ce0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00012cf0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00012d00: 2020 2020 2020 2020 2020 2020 6622 4967              f"Ig
-00012d10: 6e6f 7269 6e67 2064 7570 6c69 6361 7465  noring duplicate
-00012d20: 2072 6561 6374 696f 6e20 6672 6f6d 207b   reaction from {
-00012d30: 7365 6e64 6572 2e66 6269 647d 2074 6f20  sender.fbid} to 
-00012d40: 7b6d 6573 7361 6765 5f69 647d 2028 6462  {message_id} (db
-00012d50: 2063 6865 636b 2922 0a20 2020 2020 2020   check)".       
-00012d60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012d70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012d80: 6e0a 0a20 2020 2020 2020 2069 6620 6e6f  n..        if no
-00012d90: 7420 6177 6169 7420 7365 6c66 2e5f 6272  t await self._br
-00012da0: 6964 6765 5f6f 776e 5f6d 6573 7361 6765  idge_own_message
-00012db0: 5f70 6d28 736f 7572 6365 2c20 7365 6e64  _pm(source, send
-00012dc0: 6572 2c20 6622 7265 6163 7469 6f6e 2074  er, f"reaction t
-00012dd0: 6f20 7b6d 6573 7361 6765 5f69 647d 2229  o {message_id}")
-00012de0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00012df0: 7475 726e 0a0a 2020 2020 2020 2020 696e  turn..        in
-00012e00: 7465 6e74 203d 2073 656e 6465 722e 696e  tent = sender.in
-00012e10: 7465 6e74 5f66 6f72 2873 656c 6629 0a0a  tent_for(self)..
-00012e20: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-00012e30: 6172 6765 745f 6d65 7373 6167 653a 0a20  arget_message:. 
-00012e40: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-00012e50: 745f 6d65 7373 6167 6520 3d20 6177 6169  t_message = awai
-00012e60: 7420 4442 4d65 7373 6167 652e 6765 745f  t DBMessage.get_
-00012e70: 6279 5f66 6269 6428 6d65 7373 6167 655f  by_fbid(message_
-00012e80: 6964 2c20 7365 6c66 2e66 625f 7265 6365  id, self.fb_rece
-00012e90: 6976 6572 290a 2020 2020 2020 2020 6966  iver).        if
-00012ea0: 206e 6f74 2074 6172 6765 745f 6d65 7373   not target_mess
-00012eb0: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
-00012ec0: 2073 656c 662e 6c6f 672e 6465 6275 6728   self.log.debug(
-00012ed0: 6622 4967 6e6f 7269 6e67 2072 6561 6374  f"Ignoring react
-00012ee0: 696f 6e20 6672 6f6d 207b 7365 6e64 6572  ion from {sender
-00012ef0: 2e66 6269 647d 2074 6f20 756e 6b6e 6f77  .fbid} to unknow
-00012f00: 6e20 6d65 7373 6167 6520 7b6d 6573 7361  n message {messa
-00012f10: 6765 5f69 647d 2229 0a20 2020 2020 2020  ge_id}").       
-00012f20: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00012f30: 2020 2020 2074 696d 6573 7461 6d70 203d       timestamp =
-00012f40: 2074 696d 6573 7461 6d70 206f 7220 696e   timestamp or in
-00012f50: 7428 7469 6d65 2e74 696d 6528 2920 2a20  t(time.time() * 
-00012f60: 3130 3030 290a 2020 2020 2020 2020 6d78  1000).        mx
-00012f70: 6964 203d 2061 7761 6974 2069 6e74 656e  id = await inten
-00012f80: 742e 7265 6163 7428 0a20 2020 2020 2020  t.react(.       
-00012f90: 2020 2020 2072 6f6f 6d5f 6964 3d74 6172       room_id=tar
-00012fa0: 6765 745f 6d65 7373 6167 652e 6d78 5f72  get_message.mx_r
-00012fb0: 6f6f 6d2c 0a20 2020 2020 2020 2020 2020  oom,.           
-00012fc0: 2065 7665 6e74 5f69 643d 7461 7267 6574   event_id=target
-00012fd0: 5f6d 6573 7361 6765 2e6d 7869 642c 0a20  _message.mxid,. 
-00012fe0: 2020 2020 2020 2020 2020 206b 6579 3d76             key=v
-00012ff0: 6172 6961 7469 6f6e 5f73 656c 6563 746f  ariation_selecto
-00013000: 722e 6164 6428 7265 6163 7469 6f6e 292c  r.add(reaction),
-00013010: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-00013020: 6573 7461 6d70 3d74 696d 6573 7461 6d70  estamp=timestamp
-00013030: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00013040: 2020 2020 7365 6c66 2e6c 6f67 2e64 6562      self.log.deb
-00013050: 7567 2866 227b 7365 6e64 6572 2e66 6269  ug(f"{sender.fbi
-00013060: 647d 2072 6561 6374 6564 2074 6f20 7b74  d} reacted to {t
-00013070: 6172 6765 745f 6d65 7373 6167 652e 6d78  arget_message.mx
-00013080: 6964 7d20 287b 6d65 7373 6167 655f 6964  id} ({message_id
-00013090: 7d29 202d 3e20 7b6d 7869 647d 2229 0a0a  }) -> {mxid}")..
-000130a0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-000130b0: 6c66 2e5f 7570 7365 7274 5f72 6561 6374  lf._upsert_react
-000130c0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-000130d0: 2065 7869 7374 696e 672c 2069 6e74 656e   existing, inten
-000130e0: 742c 206d 7869 642c 2074 6172 6765 745f  t, mxid, target_
-000130f0: 6d65 7373 6167 652c 2073 656e 6465 722c  message, sender,
-00013100: 2072 6561 6374 696f 6e2c 2074 696d 6573   reaction, times
-00013110: 7461 6d70 0a20 2020 2020 2020 2029 0a0a  tamp.        )..
-00013120: 2020 2020 6173 796e 6320 6465 6620 5f75      async def _u
-00013130: 7073 6572 745f 7265 6163 7469 6f6e 280a  psert_reaction(.
-00013140: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00013150: 2020 2020 2020 6578 6973 7469 6e67 3a20        existing: 
-00013160: 4442 5265 6163 7469 6f6e 207c 204e 6f6e  DBReaction | Non
-00013170: 652c 0a20 2020 2020 2020 2069 6e74 656e  e,.        inten
-00013180: 743a 2049 6e74 656e 7441 5049 2c0a 2020  t: IntentAPI,.  
-00013190: 2020 2020 2020 6d78 6964 3a20 4576 656e        mxid: Even
-000131a0: 7449 442c 0a20 2020 2020 2020 206d 6573  tID,.        mes
-000131b0: 7361 6765 3a20 4442 4d65 7373 6167 652c  sage: DBMessage,
-000131c0: 0a20 2020 2020 2020 2073 656e 6465 723a  .        sender:
-000131d0: 2075 2e55 7365 7220 7c20 702e 5075 7070   u.User | p.Pupp
-000131e0: 6574 2c0a 2020 2020 2020 2020 7265 6163  et,.        reac
-000131f0: 7469 6f6e 3a20 7374 722c 0a20 2020 2020  tion: str,.     
-00013200: 2020 206d 785f 7469 6d65 7374 616d 703a     mx_timestamp:
-00013210: 2069 6e74 2c0a 2020 2020 2920 2d3e 204e   int,.    ) -> N
-00013220: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-00013230: 6578 6973 7469 6e67 3a0a 2020 2020 2020  existing:.      
-00013240: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
-00013250: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00013260: 2020 2020 2020 6622 5f75 7073 6572 745f        f"_upsert_
-00013270: 7265 6163 7469 6f6e 2072 6564 6163 7469  reaction redacti
-00013280: 6e67 207b 6578 6973 7469 6e67 2e6d 7869  ng {existing.mxi
-00013290: 647d 2061 6e64 2069 6e73 6572 7469 6e67  d} and inserting
-000132a0: 207b 6d78 6964 7d22 0a20 2020 2020 2020   {mxid}".       
-000132b0: 2020 2020 2020 2020 2066 2220 286d 6573           f" (mes
-000132c0: 7361 6765 3a20 7b6d 6573 7361 6765 2e6d  sage: {message.m
-000132d0: 7869 647d 2922 0a20 2020 2020 2020 2020  xid})".         
-000132e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000132f0: 2061 7761 6974 2069 6e74 656e 742e 7265   await intent.re
-00013300: 6461 6374 2865 7869 7374 696e 672e 6d78  dact(existing.mx
-00013310: 5f72 6f6f 6d2c 2065 7869 7374 696e 672e  _room, existing.
-00013320: 6d78 6964 290a 2020 2020 2020 2020 2020  mxid).          
-00013330: 2020 6578 6973 7469 6e67 2e72 6561 6374    existing.react
-00013340: 696f 6e20 3d20 7265 6163 7469 6f6e 0a20  ion = reaction. 
-00013350: 2020 2020 2020 2020 2020 2065 7869 7374             exist
-00013360: 696e 672e 6d78 6964 203d 206d 7869 640a  ing.mxid = mxid.
-00013370: 2020 2020 2020 2020 2020 2020 6578 6973              exis
-00013380: 7469 6e67 2e6d 785f 726f 6f6d 203d 206d  ting.mx_room = m
-00013390: 6573 7361 6765 2e6d 785f 726f 6f6d 0a20  essage.mx_room. 
-000133a0: 2020 2020 2020 2020 2020 2065 7869 7374             exist
-000133b0: 696e 672e 6d78 5f74 696d 6573 7461 6d70  ing.mx_timestamp
-000133c0: 203d 206d 785f 7469 6d65 7374 616d 700a   = mx_timestamp.
-000133d0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-000133e0: 7420 6578 6973 7469 6e67 2e73 6176 6528  t existing.save(
-000133f0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00013400: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00013410: 2e6c 6f67 2e64 6562 7567 2866 225f 7570  .log.debug(f"_up
-00013420: 7365 7274 5f72 6561 6374 696f 6e20 696e  sert_reaction in
-00013430: 7365 7274 696e 6720 7b6d 7869 647d 2028  serting {mxid} (
-00013440: 6d65 7373 6167 653a 207b 6d65 7373 6167  message: {messag
-00013450: 652e 6d78 6964 7d29 2229 0a20 2020 2020  e.mxid})").     
-00013460: 2020 2020 2020 2061 7761 6974 2044 4252         await DBR
-00013470: 6561 6374 696f 6e28 0a20 2020 2020 2020  eaction(.       
-00013480: 2020 2020 2020 2020 206d 7869 643d 6d78           mxid=mx
-00013490: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000134a0: 2020 2020 6d78 5f72 6f6f 6d3d 6d65 7373      mx_room=mess
-000134b0: 6167 652e 6d78 5f72 6f6f 6d2c 0a20 2020  age.mx_room,.   
-000134c0: 2020 2020 2020 2020 2020 2020 2066 625f               fb_
-000134d0: 6d73 6769 643d 6d65 7373 6167 652e 6662  msgid=message.fb
-000134e0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000134f0: 2020 2020 6662 5f72 6563 6569 7665 723d      fb_receiver=
-00013500: 7365 6c66 2e66 625f 7265 6365 6976 6572  self.fb_receiver
-00013510: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013520: 2020 6662 5f73 656e 6465 723d 7365 6e64    fb_sender=send
-00013530: 6572 2e66 6269 642c 0a20 2020 2020 2020  er.fbid,.       
-00013540: 2020 2020 2020 2020 2072 6561 6374 696f           reactio
-00013550: 6e3d 7265 6163 7469 6f6e 2c0a 2020 2020  n=reaction,.    
-00013560: 2020 2020 2020 2020 2020 2020 6d78 5f74              mx_t
-00013570: 696d 6573 7461 6d70 3d6d 785f 7469 6d65  imestamp=mx_time
-00013580: 7374 616d 702c 0a20 2020 2020 2020 2020  stamp,.         
-00013590: 2020 2029 2e69 6e73 6572 7428 290a 0a20     ).insert().. 
-000135a0: 2020 2061 7379 6e63 2064 6566 2068 616e     async def han
-000135b0: 646c 655f 6661 6365 626f 6f6b 5f72 6561  dle_facebook_rea
-000135c0: 6374 696f 6e5f 7265 6d6f 7665 280a 2020  ction_remove(.  
-000135d0: 2020 2020 2020 7365 6c66 2c20 736f 7572        self, sour
-000135e0: 6365 3a20 752e 5573 6572 2c20 7365 6e64  ce: u.User, send
-000135f0: 6572 3a20 702e 5075 7070 6574 207c 2069  er: p.Puppet | i
-00013600: 6e74 2c20 7461 7267 6574 3a20 7374 7220  nt, target: str 
-00013610: 7c20 4442 5265 6163 7469 6f6e 0a20 2020  | DBReaction.   
-00013620: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00013630: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00013640: 6d78 6964 3a0a 2020 2020 2020 2020 2020  mxid:.          
-00013650: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00013660: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-00013670: 656e 6465 722c 2069 6e74 293a 0a20 2020  ender, int):.   
-00013680: 2020 2020 2020 2020 2073 656e 6465 7220           sender 
-00013690: 3d20 6177 6169 7420 702e 5075 7070 6574  = await p.Puppet
-000136a0: 2e67 6574 5f62 795f 6662 6964 2873 656e  .get_by_fbid(sen
-000136b0: 6465 7229 0a20 2020 2020 2020 2069 6620  der).        if 
-000136c0: 6973 696e 7374 616e 6365 2874 6172 6765  isinstance(targe
-000136d0: 742c 2044 4252 6561 6374 696f 6e29 3a0a  t, DBReaction):.
-000136e0: 2020 2020 2020 2020 2020 2020 7265 6163              reac
-000136f0: 7469 6f6e 203d 2074 6172 6765 740a 2020  tion = target.  
-00013700: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00013710: 2020 2020 2020 2020 7265 6163 7469 6f6e          reaction
-00013720: 203d 2061 7761 6974 2044 4252 6561 6374   = await DBReact
-00013730: 696f 6e2e 6765 745f 6279 5f66 6269 6428  ion.get_by_fbid(
-00013740: 7461 7267 6574 2c20 7365 6c66 2e66 625f  target, self.fb_
-00013750: 7265 6365 6976 6572 2c20 7365 6e64 6572  receiver, sender
-00013760: 2e66 6269 6429 0a20 2020 2020 2020 2069  .fbid).        i
-00013770: 6620 7265 6163 7469 6f6e 3a0a 2020 2020  f reaction:.    
-00013780: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00013790: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000137a0: 6974 2073 656e 6465 722e 696e 7465 6e74  it sender.intent
-000137b0: 5f66 6f72 2873 656c 6629 2e72 6564 6163  _for(self).redac
-000137c0: 7428 7265 6163 7469 6f6e 2e6d 785f 726f  t(reaction.mx_ro
-000137d0: 6f6d 2c20 7265 6163 7469 6f6e 2e6d 7869  om, reaction.mxi
-000137e0: 6429 0a20 2020 2020 2020 2020 2020 2065  d).            e
-000137f0: 7863 6570 7420 4d46 6f72 6269 6464 656e  xcept MForbidden
-00013800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013810: 2020 6177 6169 7420 7365 6c66 2e6d 6169    await self.mai
-00013820: 6e5f 696e 7465 6e74 2e72 6564 6163 7428  n_intent.redact(
-00013830: 7265 6163 7469 6f6e 2e6d 785f 726f 6f6d  reaction.mx_room
-00013840: 2c20 7265 6163 7469 6f6e 2e6d 7869 6429  , reaction.mxid)
-00013850: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00013860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013870: 2020 7365 6c66 2e5f 6465 6475 702e 7265    self._dedup.re
-00013880: 6d6f 7665 2866 2272 6561 6374 5f7b 7265  move(f"react_{re
-00013890: 6163 7469 6f6e 2e66 625f 6d73 6769 647d  action.fb_msgid}
-000138a0: 5f7b 7365 6e64 6572 2e66 6269 647d 5f7b  _{sender.fbid}_{
-000138b0: 7265 6163 7469 6f6e 2e72 6561 6374 696f  reaction.reactio
-000138c0: 6e7d 2229 0a20 2020 2020 2020 2020 2020  n}").           
-000138d0: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-000138e0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-000138f0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00013900: 2020 2020 2061 7761 6974 2072 6561 6374       await react
-00013910: 696f 6e2e 6465 6c65 7465 2829 0a0a 2020  ion.delete()..  
-00013920: 2020 6173 796e 6320 6465 6620 6861 6e64    async def hand
-00013930: 6c65 5f66 6163 6562 6f6f 6b5f 706f 6c6c  le_facebook_poll
-00013940: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00013950: 2020 2020 2020 2020 7365 6e64 6572 3a20          sender: 
-00013960: 702e 5075 7070 6574 2c0a 2020 2020 2020  p.Puppet,.      
-00013970: 2020 7468 7265 6164 5f63 6861 6e67 653a    thread_change:
-00013980: 206d 7174 742e 5468 7265 6164 4368 616e   mqtt.ThreadChan
-00013990: 6765 2c0a 2020 2020 2920 2d3e 204e 6f6e  ge,.    ) -> Non
-000139a0: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
-000139b0: 7420 7365 6c66 2e6d 7869 643a 0a20 2020  t self.mxid:.   
-000139c0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000139d0: 0a20 2020 2020 2020 2069 6620 7468 7265  .        if thre
-000139e0: 6164 5f63 6861 6e67 652e 6163 7469 6f6e  ad_change.action
-000139f0: 5f64 6174 615b 2265 7665 6e74 5f74 7970  _data["event_typ
-00013a00: 6522 5d20 213d 2022 7175 6573 7469 6f6e  e"] != "question
-00013a10: 5f63 7265 6174 696f 6e22 3a0a 2020 2020  _creation":.    
-00013a20: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00013a30: 2020 2020 2020 2020 7175 6573 7469 6f6e          question
-00013a40: 5f6a 736f 6e20 3d20 6a73 6f6e 2e6c 6f61  _json = json.loa
-00013a50: 6473 2874 6872 6561 645f 6368 616e 6765  ds(thread_change
-00013a60: 2e61 6374 696f 6e5f 6461 7461 2e67 6574  .action_data.get
-00013a70: 2822 7175 6573 7469 6f6e 5f6a 736f 6e22  ("question_json"
-00013a80: 2929 0a20 2020 2020 2020 206f 7074 696f  )).        optio
-00013a90: 6e73 5f68 746d 6c20 3d20 2222 2e6a 6f69  ns_html = "".joi
-00013aa0: 6e28 6622 3c6c 693e 7b6f 5b27 7465 7874  n(f"<li>{o['text
-00013ab0: 275d 7d3c 2f6c 693e 2220 666f 7220 6f20  ']}</li>" for o 
-00013ac0: 696e 2071 7565 7374 696f 6e5f 6a73 6f6e  in question_json
-00013ad0: 2e67 6574 2822 6f70 7469 6f6e 7322 2929  .get("options"))
-00013ae0: 0a20 2020 2020 2020 2068 746d 6c20 3d20  .        html = 
-00013af0: 6622 2222 0a20 2020 2020 2020 2020 2020  f""".           
-00013b00: 203c 623e 506f 6c6c 3a20 7b71 7565 7374   <b>Poll: {quest
-00013b10: 696f 6e5f 6a73 6f6e 2e67 6574 2822 7465  ion_json.get("te
-00013b20: 7874 2229 7d3c 2f62 3e3c 6272 3e0a 2020  xt")}</b><br>.  
-00013b30: 2020 2020 2020 2020 2020 4f70 7469 6f6e            Option
-00013b40: 733a 0a20 2020 2020 2020 2020 2020 203c  s:.            <
-00013b50: 756c 3e7b 6f70 7469 6f6e 735f 6874 6d6c  ul>{options_html
-00013b60: 7d3c 2f75 6c3e 0a20 2020 2020 2020 2020  }</ul>.         
-00013b70: 2020 204f 7065 6e20 4661 6365 626f 6f6b     Open Facebook
-00013b80: 204d 6573 7365 6e67 6572 2074 6f20 766f   Messenger to vo
-00013b90: 7465 2e0a 2020 2020 2020 2020 2222 222e  te..        """.
-00013ba0: 7374 7269 7028 290a 0a20 2020 2020 2020  strip()..       
-00013bb0: 2061 7761 6974 2073 656c 662e 5f73 656e   await self._sen
-00013bc0: 645f 6d65 7373 6167 6528 0a20 2020 2020  d_message(.     
-00013bd0: 2020 2020 2020 2073 656e 6465 722e 696e         sender.in
-00013be0: 7465 6e74 5f66 6f72 2873 656c 6629 2c0a  tent_for(self),.
-00013bf0: 2020 2020 2020 2020 2020 2020 5465 7874              Text
-00013c00: 4d65 7373 6167 6545 7665 6e74 436f 6e74  MessageEventCont
-00013c10: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-00013c20: 2020 2020 206d 7367 7479 7065 3d4d 6573       msgtype=Mes
-00013c30: 7361 6765 5479 7065 2e54 4558 542c 0a20  sageType.TEXT,. 
-00013c40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00013c50: 6f64 793d 6177 6169 7420 7061 7273 655f  ody=await parse_
-00013c60: 6874 6d6c 2868 746d 6c29 2c0a 2020 2020  html(html),.    
-00013c70: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00013c80: 6174 3d46 6f72 6d61 742e 4854 4d4c 2c0a  at=Format.HTML,.
-00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ca0: 666f 726d 6174 7465 645f 626f 6479 3d68  formatted_body=h
-00013cb0: 746d 6c2c 0a20 2020 2020 2020 2020 2020  tml,.           
-00013cc0: 2029 2c0a 2020 2020 2020 2020 290a 0a20   ),.        ).. 
-00013cd0: 2020 2061 7379 6e63 2064 6566 2068 616e     async def han
-00013ce0: 646c 655f 6661 6365 626f 6f6b 5f6a 6f69  dle_facebook_joi
-00013cf0: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-00013d00: 2073 6f75 7263 653a 2075 2e55 7365 722c   source: u.User,
-00013d10: 2073 656e 6465 723a 2070 2e50 7570 7065   sender: p.Puppe
-00013d20: 742c 2075 7365 7273 3a20 6c69 7374 5b70  t, users: list[p
-00013d30: 2e50 7570 7065 745d 0a20 2020 2029 202d  .Puppet].    ) -
-00013d40: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00013d50: 7365 6e64 6572 5f69 6e74 656e 7420 3d20  sender_intent = 
-00013d60: 7365 6e64 6572 2e69 6e74 656e 745f 666f  sender.intent_fo
-00013d70: 7228 7365 6c66 290a 2020 2020 2020 2020  r(self).        
-00013d80: 666f 7220 7573 6572 2069 6e20 7573 6572  for user in user
-00013d90: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-00013da0: 7761 6974 2073 656e 6465 725f 696e 7465  wait sender_inte
-00013db0: 6e74 2e69 6e76 6974 655f 7573 6572 2873  nt.invite_user(s
-00013dc0: 656c 662e 6d78 6964 2c20 7573 6572 2e6d  elf.mxid, user.m
-00013dd0: 7869 6429 0a20 2020 2020 2020 2020 2020  xid).           
-00013de0: 2061 7761 6974 2075 7365 722e 696e 7465   await user.inte
-00013df0: 6e74 5f66 6f72 2873 656c 6629 2e6a 6f69  nt_for(self).joi
-00013e00: 6e5f 726f 6f6d 5f62 795f 6964 2873 656c  n_room_by_id(sel
-00013e10: 662e 6d78 6964 290a 2020 2020 2020 2020  f.mxid).        
-00013e20: 2020 2020 6966 206e 6f74 2075 7365 722e      if not user.
-00013e30: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-00013e40: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-00013e50: 756c 655f 7265 7379 6e63 2873 6f75 7263  ule_resync(sourc
-00013e60: 652c 2075 7365 7229 0a0a 2020 2020 6173  e, user)..    as
-00013e70: 796e 6320 6465 6620 6861 6e64 6c65 5f66  ync def handle_f
-00013e80: 6163 6562 6f6f 6b5f 6c65 6176 6528 0a20  acebook_leave(. 
-00013e90: 2020 2020 2020 2073 656c 662c 2073 6f75         self, sou
-00013ea0: 7263 653a 2075 2e55 7365 722c 2073 656e  rce: u.User, sen
-00013eb0: 6465 723a 2070 2e50 7570 7065 742c 2072  der: p.Puppet, r
-00013ec0: 656d 6f76 6564 3a20 702e 5075 7070 6574  emoved: p.Puppet
-00013ed0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00013ee0: 2020 2020 2020 2020 6966 2073 656e 6465          if sende
-00013ef0: 7220 3d3d 2072 656d 6f76 6564 3a0a 2020  r == removed:.  
-00013f00: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00013f10: 7265 6d6f 7665 642e 696e 7465 6e74 5f66  removed.intent_f
-00013f20: 6f72 2873 656c 6629 2e6c 6561 7665 5f72  or(self).leave_r
-00013f30: 6f6f 6d28 7365 6c66 2e6d 7869 6429 0a20  oom(self.mxid). 
-00013f40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013f50: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00013f60: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-00013f70: 6169 7420 7365 6e64 6572 2e69 6e74 656e  ait sender.inten
-00013f80: 745f 666f 7228 7365 6c66 292e 6b69 636b  t_for(self).kick
-00013f90: 5f75 7365 7228 7365 6c66 2e6d 7869 642c  _user(self.mxid,
-00013fa0: 2072 656d 6f76 6564 2e6d 7869 6429 0a20   removed.mxid). 
-00013fb0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00013fc0: 7420 4d46 6f72 6269 6464 656e 3a0a 2020  t MForbidden:.  
-00013fd0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-00013fe0: 6169 7420 7365 6c66 2e6d 6169 6e5f 696e  ait self.main_in
-00013ff0: 7465 6e74 2e6b 6963 6b5f 7573 6572 280a  tent.kick_user(.
-00014000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014010: 2020 2020 7365 6c66 2e6d 7869 642c 2072      self.mxid, r
-00014020: 656d 6f76 6564 2e6d 7869 642c 2072 6561  emoved.mxid, rea
-00014030: 736f 6e3d 6622 4b69 636b 6564 2062 7920  son=f"Kicked by 
-00014040: 7b73 656e 6465 722e 6e61 6d65 7d22 0a20  {sender.name}". 
-00014050: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00014060: 0a0a 2020 2020 2320 656e 6472 6567 696f  ..    # endregio
-00014070: 6e0a 0a20 2020 2061 7379 6e63 2064 6566  n..    async def
-00014080: 2062 6163 6b66 696c 6c28 7365 6c66 2c20   backfill(self, 
-00014090: 736f 7572 6365 3a20 752e 5573 6572 2c20  source: u.User, 
-000140a0: 6973 5f69 6e69 7469 616c 3a20 626f 6f6c  is_initial: bool
-000140b0: 2c20 7468 7265 6164 3a20 6772 6170 6871  , thread: graphq
-000140c0: 6c2e 5468 7265 6164 2920 2d3e 204e 6f6e  l.Thread) -> Non
-000140d0: 653a 0a20 2020 2020 2020 206c 696d 6974  e:.        limit
-000140e0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000140f0: 2073 656c 662e 636f 6e66 6967 5b22 6272   self.config["br
-00014100: 6964 6765 2e62 6163 6b66 696c 6c2e 696e  idge.backfill.in
-00014110: 6974 6961 6c5f 6c69 6d69 7422 5d0a 2020  itial_limit"].  
-00014120: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
-00014130: 696e 6974 6961 6c0a 2020 2020 2020 2020  initial.        
-00014140: 2020 2020 656c 7365 2073 656c 662e 636f      else self.co
-00014150: 6e66 6967 5b22 6272 6964 6765 2e62 6163  nfig["bridge.bac
-00014160: 6b66 696c 6c2e 6d69 7373 6564 5f6c 696d  kfill.missed_lim
-00014170: 6974 225d 0a20 2020 2020 2020 2029 0a20  it"].        ). 
-00014180: 2020 2020 2020 2069 6620 6c69 6d69 7420         if limit 
-00014190: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-000141a0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-000141b0: 2065 6c69 6620 6c69 6d69 7420 3c20 303a   elif limit < 0:
-000141c0: 0a20 2020 2020 2020 2020 2020 206c 696d  .            lim
-000141d0: 6974 203d 204e 6f6e 650a 2020 2020 2020  it = None.      
-000141e0: 2020 6c61 7374 5f61 6374 6976 6520 3d20    last_active = 
-000141f0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-00014200: 6e6f 7420 6973 5f69 6e69 7469 616c 2061  not is_initial a
-00014210: 6e64 2074 6872 6561 6420 616e 6420 6c65  nd thread and le
-00014220: 6e28 7468 7265 6164 2e6c 6173 745f 6d65  n(thread.last_me
-00014230: 7373 6167 652e 6e6f 6465 7329 203e 2030  ssage.nodes) > 0
-00014240: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
-00014250: 7374 5f61 6374 6976 6520 3d20 7468 7265  st_active = thre
-00014260: 6164 2e6c 6173 745f 6d65 7373 6167 652e  ad.last_message.
-00014270: 6e6f 6465 735b 305d 2e74 696d 6573 7461  nodes[0].timesta
-00014280: 6d70 0a20 2020 2020 2020 206d 6f73 745f  mp.        most_
-00014290: 7265 6365 6e74 203d 2061 7761 6974 2044  recent = await D
-000142a0: 424d 6573 7361 6765 2e67 6574 5f6d 6f73  BMessage.get_mos
-000142b0: 745f 7265 6365 6e74 2873 656c 662e 6662  t_recent(self.fb
-000142c0: 6964 2c20 7365 6c66 2e66 625f 7265 6365  id, self.fb_rece
-000142d0: 6976 6572 290a 2020 2020 2020 2020 6966  iver).        if
-000142e0: 206d 6f73 745f 7265 6365 6e74 2061 6e64   most_recent and
-000142f0: 2069 735f 696e 6974 6961 6c3a 0a20 2020   is_initial:.   
-00014300: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00014310: 672e 6465 6275 6728 224e 6f74 2062 6163  g.debug("Not bac
-00014320: 6b66 696c 6c69 6e67 2025 733a 2061 6c72  kfilling %s: alr
-00014330: 6561 6479 2062 7269 6467 6564 206d 6573  eady bridged mes
-00014340: 7361 6765 7320 666f 756e 6422 2c20 7365  sages found", se
-00014350: 6c66 2e66 6269 645f 6c6f 6729 0a20 2020  lf.fbid_log).   
-00014360: 2020 2020 2065 6c69 6620 286e 6f74 206d       elif (not m
-00014370: 6f73 745f 7265 6365 6e74 206f 7220 6e6f  ost_recent or no
-00014380: 7420 6d6f 7374 5f72 6563 656e 742e 7469  t most_recent.ti
-00014390: 6d65 7374 616d 7029 2061 6e64 206e 6f74  mestamp) and not
-000143a0: 2069 735f 696e 6974 6961 6c3a 0a20 2020   is_initial:.   
-000143b0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000143c0: 672e 6465 6275 6728 224e 6f74 2062 6163  g.debug("Not bac
-000143d0: 6b66 696c 6c69 6e67 2025 733a 206e 6f20  kfilling %s: no 
-000143e0: 6d6f 7374 2072 6563 656e 7420 6d65 7373  most recent mess
-000143f0: 6167 6520 666f 756e 6422 2c20 7365 6c66  age found", self
-00014400: 2e66 6269 645f 6c6f 6729 0a20 2020 2020  .fbid_log).     
-00014410: 2020 2065 6c69 6620 6c61 7374 5f61 6374     elif last_act
-00014420: 6976 6520 616e 6420 6d6f 7374 5f72 6563  ive and most_rec
-00014430: 656e 742e 7469 6d65 7374 616d 7020 3e3d  ent.timestamp >=
-00014440: 206c 6173 745f 6163 7469 7665 3a0a 2020   last_active:.  
-00014450: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-00014460: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00014470: 2020 2020 2020 2020 2020 224e 6f74 2062            "Not b
-00014480: 6163 6b66 696c 6c69 6e67 2025 733a 206c  ackfilling %s: l
-00014490: 6173 7420 6163 7469 7669 7479 2069 7320  ast activity is 
-000144a0: 6571 7561 6c20 746f 206d 6f73 7420 7265  equal to most re
-000144b0: 6365 6e74 2062 7269 6467 6564 2022 0a20  cent bridged ". 
-000144c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000144d0: 6d65 7373 6167 6520 2825 7320 3e3d 2025  message (%s >= %
-000144e0: 7329 222c 0a20 2020 2020 2020 2020 2020  s)",.           
-000144f0: 2020 2020 2073 656c 662e 6662 6964 5f6c       self.fbid_l
-00014500: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
-00014510: 2020 2020 6d6f 7374 5f72 6563 656e 742e      most_recent.
-00014520: 7469 6d65 7374 616d 702c 0a20 2020 2020  timestamp,.     
-00014530: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-00014540: 6163 7469 7665 2c0a 2020 2020 2020 2020  active,.        
-00014550: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00014560: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00014570: 7769 7468 2073 656c 662e 6261 636b 6669  with self.backfi
-00014580: 6c6c 5f6c 6f63 6b3a 0a20 2020 2020 2020  ll_lock:.       
-00014590: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-000145a0: 656c 662e 5f62 6163 6b66 696c 6c28 0a20  elf._backfill(. 
-000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145c0: 2020 2073 6f75 7263 652c 0a20 2020 2020     source,.     
-000145d0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000145e0: 696d 6974 2c0a 2020 2020 2020 2020 2020  imit,.          
-000145f0: 2020 2020 2020 2020 2020 6d6f 7374 5f72            most_r
-00014600: 6563 656e 742e 7469 6d65 7374 616d 7020  ecent.timestamp 
-00014610: 6966 206d 6f73 745f 7265 6365 6e74 2065  if most_recent e
-00014620: 6c73 6520 4e6f 6e65 2c0a 2020 2020 2020  lse None,.      
-00014630: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00014640: 7265 6164 3d74 6872 6561 642c 0a20 2020  read=thread,.   
-00014650: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00014660: 2020 2020 6173 796e 6320 6465 6620 5f62      async def _b
-00014670: 6163 6b66 696c 6c28 0a20 2020 2020 2020  ackfill(.       
-00014680: 2073 656c 662c 0a20 2020 2020 2020 2073   self,.        s
-00014690: 6f75 7263 653a 2075 2e55 7365 722c 0a20  ource: u.User,. 
-000146a0: 2020 2020 2020 206c 696d 6974 3a20 696e         limit: in
-000146b0: 742c 0a20 2020 2020 2020 2061 6674 6572  t,.        after
-000146c0: 5f74 696d 6573 7461 6d70 3a20 696e 7420  _timestamp: int 
-000146d0: 7c20 4e6f 6e65 2c0a 2020 2020 2020 2020  | None,.        
-000146e0: 7468 7265 6164 3a20 6772 6170 6871 6c2e  thread: graphql.
-000146f0: 5468 7265 6164 2c0a 2020 2020 2920 2d3e  Thread,.    ) ->
-00014700: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
-00014710: 656c 662e 6c6f 672e 6465 6275 6728 2242  elf.log.debug("B
-00014720: 6163 6b66 696c 6c69 6e67 2068 6973 746f  ackfilling histo
-00014730: 7279 2074 6872 6f75 6768 2025 7322 2c20  ry through %s", 
-00014740: 736f 7572 6365 2e6d 7869 6429 0a20 2020  source.mxid).   
-00014750: 2020 2020 206d 6573 7361 6765 7320 3d20       messages = 
-00014760: 7468 7265 6164 2e6d 6573 7361 6765 732e  thread.messages.
-00014770: 6e6f 6465 730a 2020 2020 2020 2020 6f6c  nodes.        ol
-00014780: 6465 7374 5f6d 6573 7361 6765 203d 206d  dest_message = m
-00014790: 6573 7361 6765 735b 305d 0a20 2020 2020  essages[0].     
-000147a0: 2020 2062 6566 6f72 655f 7469 6d65 7374     before_timest
-000147b0: 616d 7020 3d20 6f6c 6465 7374 5f6d 6573  amp = oldest_mes
-000147c0: 7361 6765 2e74 696d 6573 7461 6d70 202d  sage.timestamp -
-000147d0: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
-000147e0: 6c6f 672e 6465 6275 6728 2246 6574 6368  log.debug("Fetch
-000147f0: 696e 6720 7570 2074 6f20 2564 206d 6573  ing up to %d mes
-00014800: 7361 6765 7320 7468 726f 7567 6820 2573  sages through %s
-00014810: 222c 206c 696d 6974 2c20 736f 7572 6365  ", limit, source
-00014820: 2e66 6269 6429 0a20 2020 2020 2020 2077  .fbid).        w
-00014830: 6869 6c65 206c 656e 286d 6573 7361 6765  hile len(message
-00014840: 7329 203c 206c 696d 6974 3a0a 2020 2020  s) < limit:.    
-00014850: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-00014860: 7761 6974 2073 6f75 7263 652e 636c 6965  wait source.clie
-00014870: 6e74 2e66 6574 6368 5f6d 6573 7361 6765  nt.fetch_message
-00014880: 7328 7365 6c66 2e66 6269 642c 2062 6566  s(self.fbid, bef
-00014890: 6f72 655f 7469 6d65 7374 616d 7029 0a20  ore_timestamp). 
-000148a0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000148b0: 7420 7265 7370 2e6e 6f64 6573 3a0a 2020  t resp.nodes:.  
-000148c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000148d0: 6c66 2e6c 6f67 2e64 6562 7567 280a 2020  lf.log.debug(.  
-000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148f0: 2020 2253 746f 7070 696e 6720 6665 7463    "Stopping fetc
-00014900: 6869 6e67 206d 6573 7361 6765 7320 6174  hing messages at
-00014910: 2025 7320 6166 7465 7220 656d 7074 7920   %s after empty 
-00014920: 7265 7370 6f6e 7365 222c 0a20 2020 2020  response",.     
-00014930: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00014940: 6c64 6573 745f 6d65 7373 6167 652e 6d65  ldest_message.me
-00014950: 7373 6167 655f 6964 2c0a 2020 2020 2020  ssage_id,.      
-00014960: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00014970: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00014980: 6b0a 2020 2020 2020 2020 2020 2020 6f6c  k.            ol
-00014990: 6465 7374 5f6d 6573 7361 6765 203d 2072  dest_message = r
-000149a0: 6573 702e 6e6f 6465 735b 305d 0a20 2020  esp.nodes[0].   
-000149b0: 2020 2020 2020 2020 2062 6566 6f72 655f           before_
-000149c0: 7469 6d65 7374 616d 7020 3d20 6f6c 6465  timestamp = olde
-000149d0: 7374 5f6d 6573 7361 6765 2e74 696d 6573  st_message.times
-000149e0: 7461 6d70 202d 2031 0a20 2020 2020 2020  tamp - 1.       
-000149f0: 2020 2020 206d 6573 7361 6765 7320 3d20       messages = 
-00014a00: 7265 7370 2e6e 6f64 6573 202b 206d 6573  resp.nodes + mes
-00014a10: 7361 6765 730a 2020 2020 2020 2020 2020  sages.          
-00014a20: 2020 6966 206e 6f74 2072 6573 702e 7061    if not resp.pa
-00014a30: 6765 5f69 6e66 6f2e 6861 735f 7072 6576  ge_info.has_prev
-00014a40: 696f 7573 5f70 6167 653a 0a20 2020 2020  ious_page:.     
-00014a50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00014a60: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00014a70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00014a80: 5374 6f70 7069 6e67 2066 6574 6368 696e  Stopping fetchin
-00014a90: 6720 6d65 7373 6167 6573 2061 7420 2573  g messages at %s
-00014aa0: 2061 7320 7265 7370 6f6e 7365 2073 6169   as response sai
-00014ab0: 6420 7468 6572 6520 6172 6520 6e6f 2022  d there are no "
-00014ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ad0: 2020 2020 2022 6d6f 7265 206d 6573 7361       "more messa
-00014ae0: 6765 7322 2c0a 2020 2020 2020 2020 2020  ges",.          
-00014af0: 2020 2020 2020 2020 2020 6f6c 6465 7374            oldest
-00014b00: 5f6d 6573 7361 6765 2e6d 6573 7361 6765  _message.message
-00014b10: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00014b20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00014b30: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-00014b40: 2020 2020 2020 2020 2065 6c69 6620 6166           elif af
-00014b50: 7465 725f 7469 6d65 7374 616d 7020 616e  ter_timestamp an
-00014b60: 6420 6f6c 6465 7374 5f6d 6573 7361 6765  d oldest_message
-00014b70: 2e74 696d 6573 7461 6d70 203c 3d20 6166  .timestamp <= af
-00014b80: 7465 725f 7469 6d65 7374 616d 703a 0a20  ter_timestamp:. 
-00014b90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014ba0: 656c 662e 6c6f 672e 6465 6275 6728 0a20  elf.log.debug(. 
-00014bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bc0: 2020 2022 5374 6f70 7069 6e67 2066 6574     "Stopping fet
-00014bd0: 6368 696e 6720 6d65 7373 6167 6573 2061  ching messages a
-00014be0: 7420 2573 2061 7320 6d65 7373 6167 6520  t %s as message 
-00014bf0: 6973 206f 6c64 6572 2074 6861 6e20 6e65  is older than ne
-00014c00: 7765 7374 2022 0a20 2020 2020 2020 2020  west ".         
-00014c10: 2020 2020 2020 2020 2020 2022 6272 6964             "brid
-00014c20: 6765 6420 6d65 7373 6167 6520 2825 7320  ged message (%s 
-00014c30: 3c20 2573 2922 2c0a 2020 2020 2020 2020  < %s)",.        
-00014c40: 2020 2020 2020 2020 2020 2020 6f6c 6465              olde
-00014c50: 7374 5f6d 6573 7361 6765 2e6d 6573 7361  st_message.messa
-00014c60: 6765 5f69 642c 0a20 2020 2020 2020 2020  ge_id,.         
-00014c70: 2020 2020 2020 2020 2020 206f 6c64 6573             oldes
-00014c80: 745f 6d65 7373 6167 652e 7469 6d65 7374  t_message.timest
-00014c90: 616d 702c 0a20 2020 2020 2020 2020 2020  amp,.           
-00014ca0: 2020 2020 2020 2020 2061 6674 6572 5f74           after_t
-00014cb0: 696d 6573 7461 6d70 2c0a 2020 2020 2020  imestamp,.      
-00014cc0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00014cd0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00014ce0: 6b0a 2020 2020 2020 2020 6966 2061 6674  k.        if aft
-00014cf0: 6572 5f74 696d 6573 7461 6d70 3a0a 2020  er_timestamp:.  
-00014d00: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00014d10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014d20: 6c69 6365 5f69 6e64 6578 203d 206e 6578  lice_index = nex
-00014d30: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00014d40: 2020 2020 2020 2069 6e64 6578 0a20 2020         index.   
-00014d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d60: 2066 6f72 2069 6e64 6578 2c20 6d65 7373   for index, mess
-00014d70: 6167 6520 696e 2065 6e75 6d65 7261 7465  age in enumerate
-00014d80: 286d 6573 7361 6765 7329 0a20 2020 2020  (messages).     
-00014d90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014da0: 6620 6d65 7373 6167 652e 7469 6d65 7374  f message.timest
-00014db0: 616d 7020 3e20 6166 7465 725f 7469 6d65  amp > after_time
-00014dc0: 7374 616d 700a 2020 2020 2020 2020 2020  stamp.          
-00014dd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014de0: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-00014df0: 203d 206d 6573 7361 6765 735b 736c 6963   = messages[slic
-00014e00: 655f 696e 6465 783a 5d0a 2020 2020 2020  e_index:].      
-00014e10: 2020 2020 2020 6578 6365 7074 2053 746f        except Sto
-00014e20: 7049 7465 7261 7469 6f6e 3a0a 2020 2020  pIteration:.    
-00014e30: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-00014e40: 6167 6573 203d 205b 5d0a 2020 2020 2020  ages = [].      
-00014e50: 2020 6966 206e 6f74 206d 6573 7361 6765    if not message
-00014e60: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-00014e70: 656c 662e 6c6f 672e 6465 6275 6728 2244  elf.log.debug("D
-00014e80: 6964 6e27 7420 6765 7420 616e 7920 6d65  idn't get any me
-00014e90: 7373 6167 6573 2066 726f 6d20 7365 7276  ssages from serv
-00014ea0: 6572 2229 0a20 2020 2020 2020 2020 2020  er").           
-00014eb0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00014ec0: 7365 6c66 2e6c 6f67 2e64 6562 7567 2822  self.log.debug("
-00014ed0: 476f 7420 2564 206d 6573 7361 6765 7320  Got %d messages 
-00014ee0: 6672 6f6d 2073 6572 7665 7222 2c20 6c65  from server", le
-00014ef0: 6e28 6d65 7373 6167 6573 2929 0a0a 2020  n(messages))..  
-00014f00: 2020 2020 2020 2320 4966 2077 6520 676f        # If we go
-00014f10: 7420 6d6f 7265 206d 6573 7361 6765 7320  t more messages 
-00014f20: 7468 616e 2074 6865 206c 696d 6974 2c20  than the limit, 
-00014f30: 7472 696d 2074 6865 206c 6973 742e 0a20  trim the list.. 
-00014f40: 2020 2020 2020 2069 6620 6c65 6e28 6d65         if len(me
-00014f50: 7373 6167 6573 2920 3e20 6c69 6d69 743a  ssages) > limit:
-00014f60: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00014f70: 7465 7265 645f 6d65 7373 6167 6573 203d  tered_messages =
-00014f80: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00014f90: 666f 7220 6d65 7373 6167 6520 696e 2072  for message in r
-00014fa0: 6576 6572 7365 6428 6d65 7373 6167 6573  eversed(messages
-00014fb0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00014fc0: 2020 2066 696c 7465 7265 645f 6d65 7373     filtered_mess
-00014fd0: 6167 6573 2e61 7070 656e 6428 6d65 7373  ages.append(mess
-00014fe0: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
-00014ff0: 2020 2020 2069 6620 6c65 6e28 6669 6c74       if len(filt
-00015000: 6572 6564 5f6d 6573 7361 6765 7329 203e  ered_messages) >
-00015010: 3d20 6c69 6d69 7420 616e 6420 6d65 7373  = limit and mess
-00015020: 6167 652e 6973 5f6c 696b 656c 795f 6272  age.is_likely_br
-00015030: 6964 6765 6162 6c65 3a0a 2020 2020 2020  idgeable:.      
-00015040: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00015050: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00015060: 6d65 7373 6167 6573 203d 206c 6973 7428  messages = list(
-00015070: 7265 7665 7273 6564 2866 696c 7465 7265  reversed(filtere
-00015080: 645f 6d65 7373 6167 6573 2929 0a20 2020  d_messages)).   
-00015090: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000150a0: 672e 6465 6275 6728 6622 5472 696d 6d65  g.debug(f"Trimme
-000150b0: 6420 6d65 7373 6167 6520 6c69 7374 2064  d message list d
-000150c0: 6f77 6e20 746f 207b 6c69 6d69 747d 206d  own to {limit} m
-000150d0: 6573 7361 6765 732e 2229 0a0a 2020 2020  essages.")..    
-000150e0: 2020 2020 7365 6c66 2e5f 6261 636b 6669      self._backfi
-000150f0: 6c6c 5f6c 6561 7665 203d 2073 6574 2829  ll_leave = set()
-00015100: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00015110: 6974 6820 4e6f 7469 6669 6361 7469 6f6e  ith Notification
-00015120: 4469 7361 626c 6572 2873 656c 662e 6d78  Disabler(self.mx
-00015130: 6964 2c20 736f 7572 6365 293a 0a20 2020  id, source):.   
-00015140: 2020 2020 2020 2020 2066 6f72 206d 6573           for mes
-00015150: 7361 6765 2069 6e20 6d65 7373 6167 6573  sage in messages
-00015160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015170: 2020 7075 7070 6574 203d 2061 7761 6974    puppet = await
-00015180: 2070 2e50 7570 7065 742e 6765 745f 6279   p.Puppet.get_by
-00015190: 5f66 6269 6428 6d65 7373 6167 652e 6d65  _fbid(message.me
-000151a0: 7373 6167 655f 7365 6e64 6572 2e69 6429  ssage_sender.id)
-000151b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000151c0: 2061 7761 6974 2073 656c 662e 6861 6e64   await self.hand
-000151d0: 6c65 5f66 6163 6562 6f6f 6b5f 6d65 7373  le_facebook_mess
-000151e0: 6167 6528 736f 7572 6365 2c20 7075 7070  age(source, pupp
-000151f0: 6574 2c20 6d65 7373 6167 6529 0a20 2020  et, message).   
-00015200: 2020 2020 2066 6f72 2069 6e74 656e 7420       for intent 
-00015210: 696e 2073 656c 662e 5f62 6163 6b66 696c  in self._backfil
-00015220: 6c5f 6c65 6176 653a 0a20 2020 2020 2020  l_leave:.       
-00015230: 2020 2020 2073 656c 662e 6c6f 672e 7472       self.log.tr
-00015240: 6163 6528 224c 6561 7669 6e67 2072 6f6f  ace("Leaving roo
-00015250: 6d20 7769 7468 2025 7320 706f 7374 2d62  m with %s post-b
-00015260: 6163 6b66 696c 6c22 2c20 696e 7465 6e74  ackfill", intent
-00015270: 2e6d 7869 6429 0a20 2020 2020 2020 2020  .mxid).         
-00015280: 2020 2061 7761 6974 2069 6e74 656e 742e     await intent.
-00015290: 6c65 6176 655f 726f 6f6d 2873 656c 662e  leave_room(self.
-000152a0: 6d78 6964 290a 2020 2020 2020 2020 7365  mxid).        se
-000152b0: 6c66 2e6c 6f67 2e69 6e66 6f28 2242 6163  lf.log.info("Bac
-000152c0: 6b66 696c 6c65 6420 2564 206d 6573 7361  kfilled %d messa
-000152d0: 6765 7320 7468 726f 7567 6820 2573 222c  ges through %s",
-000152e0: 206c 656e 286d 6573 7361 6765 7329 2c20   len(messages), 
-000152f0: 736f 7572 6365 2e6d 7869 6429 0a0a 2020  source.mxid)..  
-00015300: 2020 6173 796e 6320 6465 6620 6861 6e64    async def hand
-00015310: 6c65 5f66 6f72 6365 645f 6665 7463 6828  le_forced_fetch(
-00015320: 7365 6c66 2c20 736f 7572 6365 3a20 752e  self, source: u.
-00015330: 5573 6572 2c20 6d65 7373 6167 6573 3a20  User, messages: 
-00015340: 6c69 7374 5b67 7261 7068 716c 2e4d 6573  list[graphql.Mes
-00015350: 7361 6765 5d29 202d 3e20 4e6f 6e65 3a0a  sage]) -> None:.
-00015360: 2020 2020 2020 2020 6d6f 7374 5f72 6563          most_rec
-00015370: 656e 7420 3d20 6177 6169 7420 4442 4d65  ent = await DBMe
-00015380: 7373 6167 652e 6765 745f 6d6f 7374 5f72  ssage.get_most_r
-00015390: 6563 656e 7428 7365 6c66 2e66 6269 642c  ecent(self.fbid,
-000153a0: 2073 656c 662e 6662 5f72 6563 6569 7665   self.fb_receive
-000153b0: 7229 0a20 2020 2020 2020 2066 6f72 206d  r).        for m
-000153c0: 6573 7361 6765 2069 6e20 6d65 7373 6167  essage in messag
-000153d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000153e0: 7075 7070 6574 203d 2061 7761 6974 2070  puppet = await p
-000153f0: 2e50 7570 7065 742e 6765 745f 6279 5f66  .Puppet.get_by_f
-00015400: 6269 6428 6d65 7373 6167 652e 6d65 7373  bid(message.mess
-00015410: 6167 655f 7365 6e64 6572 2e69 6429 0a20  age_sender.id). 
-00015420: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
-00015430: 7373 6167 652e 7469 6d65 7374 616d 7020  ssage.timestamp 
-00015440: 3e20 6d6f 7374 5f72 6563 656e 742e 7469  > most_recent.ti
-00015450: 6d65 7374 616d 703a 0a20 2020 2020 2020  mestamp:.       
-00015460: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-00015470: 656c 662e 6861 6e64 6c65 5f66 6163 6562  elf.handle_faceb
-00015480: 6f6f 6b5f 6d65 7373 6167 6528 736f 7572  ook_message(sour
-00015490: 6365 2c20 7075 7070 6574 2c20 6d65 7373  ce, puppet, mess
-000154a0: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
-000154b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000154c0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-000154d0: 662e 5f74 7279 5f68 616e 646c 655f 6772  f._try_handle_gr
-000154e0: 6170 6871 6c5f 7265 6163 7469 6f6e 7328  aphql_reactions(
-000154f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015500: 2020 2020 2073 6f75 7263 652c 206d 6573       source, mes
-00015510: 7361 6765 2e6d 6573 7361 6765 5f69 642c  sage.message_id,
-00015520: 206d 6573 7361 6765 2e6d 6573 7361 6765   message.message
-00015530: 5f72 6561 6374 696f 6e73 0a20 2020 2020  _reactions.     
-00015540: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00015550: 2020 2320 7265 6769 6f6e 2044 6174 6162    # region Datab
-00015560: 6173 6520 6765 7474 6572 730a 0a20 2020  ase getters..   
-00015570: 2061 7379 6e63 2064 6566 2070 6f73 7469   async def posti
-00015580: 6e69 7428 7365 6c66 2920 2d3e 204e 6f6e  nit(self) -> Non
-00015590: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
-000155a0: 6279 5f66 6269 645b 7365 6c66 2e66 6269  by_fbid[self.fbi
-000155b0: 645f 6675 6c6c 5d20 3d20 7365 6c66 0a20  d_full] = self. 
-000155c0: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
-000155d0: 7869 643a 0a20 2020 2020 2020 2020 2020  xid:.           
-000155e0: 2073 656c 662e 6279 5f6d 7869 645b 7365   self.by_mxid[se
-000155f0: 6c66 2e6d 7869 645d 203d 2073 656c 660a  lf.mxid] = self.
-00015600: 2020 2020 2020 2020 7365 6c66 2e5f 6d61          self._ma
-00015610: 696e 5f69 6e74 656e 7420 3d20 280a 2020  in_intent = (.  
-00015620: 2020 2020 2020 2020 2020 2861 7761 6974            (await
-00015630: 2073 656c 662e 6765 745f 646d 5f70 7570   self.get_dm_pup
-00015640: 7065 7428 2929 2e64 6566 6175 6c74 5f6d  pet()).default_m
-00015650: 7869 645f 696e 7465 6e74 2069 6620 7365  xid_intent if se
-00015660: 6c66 2e69 735f 6469 7265 6374 2065 6c73  lf.is_direct els
-00015670: 6520 7365 6c66 2e61 7a2e 696e 7465 6e74  e self.az.intent
-00015680: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00015690: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-000156a0: 2040 6173 796e 635f 6765 7474 6572 5f6c   @async_getter_l
-000156b0: 6f63 6b0a 2020 2020 6173 796e 6320 6465  ock.    async de
-000156c0: 6620 6765 745f 6279 5f6d 7869 6428 636c  f get_by_mxid(cl
-000156d0: 732c 206d 7869 643a 2052 6f6f 6d49 4429  s, mxid: RoomID)
-000156e0: 202d 3e20 506f 7274 616c 207c 204e 6f6e   -> Portal | Non
-000156f0: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
-00015700: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00015710: 726e 2063 6c73 2e62 795f 6d78 6964 5b6d  rn cls.by_mxid[m
-00015720: 7869 645d 0a20 2020 2020 2020 2065 7863  xid].        exc
-00015730: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-00015740: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-00015750: 2020 2020 2020 2020 706f 7274 616c 203d          portal =
-00015760: 2063 6173 7428 636c 732c 2061 7761 6974   cast(cls, await
-00015770: 2073 7570 6572 2829 2e67 6574 5f62 795f   super().get_by_
-00015780: 6d78 6964 286d 7869 6429 290a 2020 2020  mxid(mxid)).    
-00015790: 2020 2020 6966 2070 6f72 7461 6c3a 0a20      if portal:. 
-000157a0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000157b0: 2070 6f72 7461 6c2e 706f 7374 696e 6974   portal.postinit
-000157c0: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-000157d0: 6574 7572 6e20 706f 7274 616c 0a0a 2020  eturn portal..  
-000157e0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000157f0: 650a 0a20 2020 2040 636c 6173 736d 6574  e..    @classmet
-00015800: 686f 640a 2020 2020 4061 7379 6e63 5f67  hod.    @async_g
-00015810: 6574 7465 725f 6c6f 636b 0a20 2020 2061  etter_lock.    a
-00015820: 7379 6e63 2064 6566 2067 6574 5f62 795f  sync def get_by_
-00015830: 6662 6964 280a 2020 2020 2020 2020 636c  fbid(.        cl
-00015840: 732c 0a20 2020 2020 2020 2066 6269 643a  s,.        fbid:
-00015850: 2069 6e74 2c0a 2020 2020 2020 2020 2a2c   int,.        *,
-00015860: 0a20 2020 2020 2020 2066 625f 7265 6365  .        fb_rece
-00015870: 6976 6572 3a20 696e 7420 3d20 302c 0a20  iver: int = 0,. 
-00015880: 2020 2020 2020 2063 7265 6174 653a 2062         create: b
-00015890: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-000158a0: 2020 2020 6662 5f74 7970 653a 2054 6872      fb_type: Thr
-000158b0: 6561 6454 7970 6520 7c20 4e6f 6e65 203d  eadType | None =
-000158c0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-000158d0: 506f 7274 616c 207c 204e 6f6e 653a 0a20  Portal | None:. 
-000158e0: 2020 2020 2020 2069 6620 6662 5f74 7970         if fb_typ
-000158f0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00015900: 625f 7265 6365 6976 6572 203d 2066 625f  b_receiver = fb_
-00015910: 7265 6365 6976 6572 2069 6620 6662 5f74  receiver if fb_t
-00015920: 7970 6520 3d3d 2054 6872 6561 6454 7970  ype == ThreadTyp
-00015930: 652e 5553 4552 2065 6c73 6520 300a 2020  e.USER else 0.  
-00015940: 2020 2020 2020 6662 6964 5f66 756c 6c20        fbid_full 
-00015950: 3d20 2866 6269 642c 2066 625f 7265 6365  = (fbid, fb_rece
-00015960: 6976 6572 290a 2020 2020 2020 2020 7472  iver).        tr
-00015970: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-00015980: 6574 7572 6e20 636c 732e 6279 5f66 6269  eturn cls.by_fbi
-00015990: 645b 6662 6964 5f66 756c 6c5d 0a20 2020  d[fbid_full].   
-000159a0: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-000159b0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-000159c0: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-000159d0: 706f 7274 616c 203d 2063 6173 7428 636c  portal = cast(cl
-000159e0: 732c 2061 7761 6974 2073 7570 6572 2829  s, await super()
-000159f0: 2e67 6574 5f62 795f 6662 6964 2866 6269  .get_by_fbid(fbi
-00015a00: 642c 2066 625f 7265 6365 6976 6572 2929  d, fb_receiver))
-00015a10: 0a20 2020 2020 2020 2069 6620 706f 7274  .        if port
-00015a20: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-00015a30: 6177 6169 7420 706f 7274 616c 2e70 6f73  await portal.pos
-00015a40: 7469 6e69 7428 290a 2020 2020 2020 2020  tinit().        
-00015a50: 2020 2020 7265 7475 726e 2070 6f72 7461      return porta
-00015a60: 6c0a 0a20 2020 2020 2020 2069 6620 6662  l..        if fb
-00015a70: 5f74 7970 6520 616e 6420 6372 6561 7465  _type and create
-00015a80: 3a0a 2020 2020 2020 2020 2020 2020 706f  :.            po
-00015a90: 7274 616c 203d 2063 6c73 2866 6269 643d  rtal = cls(fbid=
-00015aa0: 6662 6964 2c20 6662 5f72 6563 6569 7665  fbid, fb_receive
-00015ab0: 723d 6662 5f72 6563 6569 7665 722c 2066  r=fb_receiver, f
-00015ac0: 625f 7479 7065 3d66 625f 7479 7065 290a  b_type=fb_type).
-00015ad0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00015ae0: 7420 706f 7274 616c 2e69 6e73 6572 7428  t portal.insert(
-00015af0: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
-00015b00: 6169 7420 706f 7274 616c 2e70 6f73 7469  ait portal.posti
-00015b10: 6e69 7428 290a 2020 2020 2020 2020 2020  nit().          
-00015b20: 2020 7265 7475 726e 2070 6f72 7461 6c0a    return portal.
-00015b30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015b40: 4e6f 6e65 0a0a 2020 2020 4063 6c61 7373  None..    @class
-00015b50: 6d65 7468 6f64 0a20 2020 2061 7379 6e63  method.    async
-00015b60: 2064 6566 2067 6574 5f61 6c6c 5f62 795f   def get_all_by_
-00015b70: 7265 6365 6976 6572 2863 6c73 2c20 6662  receiver(cls, fb
-00015b80: 5f72 6563 6569 7665 723a 2069 6e74 2920  _receiver: int) 
-00015b90: 2d3e 2041 7379 6e63 4765 6e65 7261 746f  -> AsyncGenerato
-00015ba0: 725b 506f 7274 616c 2c20 4e6f 6e65 5d3a  r[Portal, None]:
-00015bb0: 0a20 2020 2020 2020 2070 6f72 7461 6c73  .        portals
-00015bc0: 203d 2061 7761 6974 2073 7570 6572 2829   = await super()
-00015bd0: 2e67 6574 5f61 6c6c 5f62 795f 7265 6365  .get_all_by_rece
-00015be0: 6976 6572 2866 625f 7265 6365 6976 6572  iver(fb_receiver
-00015bf0: 290a 2020 2020 2020 2020 706f 7274 616c  ).        portal
-00015c00: 3a20 506f 7274 616c 0a20 2020 2020 2020  : Portal.       
-00015c10: 2066 6f72 2070 6f72 7461 6c20 696e 2070   for portal in p
-00015c20: 6f72 7461 6c73 3a0a 2020 2020 2020 2020  ortals:.        
-00015c30: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00015c40: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-00015c50: 6c73 2e62 795f 6662 6964 5b28 706f 7274  ls.by_fbid[(port
-00015c60: 616c 2e66 6269 642c 2070 6f72 7461 6c2e  al.fbid, portal.
-00015c70: 6662 5f72 6563 6569 7665 7229 5d0a 2020  fb_receiver)].  
-00015c80: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00015c90: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
-00015ca0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00015cb0: 2070 6f72 7461 6c2e 706f 7374 696e 6974   portal.postinit
-00015cc0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00015cd0: 2020 2079 6965 6c64 2070 6f72 7461 6c0a     yield portal.
-00015ce0: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-00015cf0: 640a 2020 2020 6173 796e 6320 6465 6620  d.    async def 
-00015d00: 616c 6c28 636c 7329 202d 3e20 4173 796e  all(cls) -> Asyn
-00015d10: 6347 656e 6572 6174 6f72 5b50 6f72 7461  cGenerator[Porta
-00015d20: 6c2c 204e 6f6e 655d 3a0a 2020 2020 2020  l, None]:.      
-00015d30: 2020 706f 7274 616c 7320 3d20 6177 6169    portals = awai
-00015d40: 7420 7375 7065 7228 292e 616c 6c28 290a  t super().all().
-00015d50: 2020 2020 2020 2020 706f 7274 616c 3a20          portal: 
-00015d60: 506f 7274 616c 0a20 2020 2020 2020 2066  Portal.        f
-00015d70: 6f72 2070 6f72 7461 6c20 696e 2070 6f72  or portal in por
-00015d80: 7461 6c73 3a0a 2020 2020 2020 2020 2020  tals:.          
-00015d90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00015da0: 2020 2020 2020 2079 6965 6c64 2063 6c73         yield cls
-00015db0: 2e62 795f 6662 6964 5b28 706f 7274 616c  .by_fbid[(portal
-00015dc0: 2e66 6269 642c 2070 6f72 7461 6c2e 6662  .fbid, portal.fb
-00015dd0: 5f72 6563 6569 7665 7229 5d0a 2020 2020  _receiver)].    
-00015de0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00015df0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00015e00: 2020 2020 2020 2020 2061 7761 6974 2070           await p
-00015e10: 6f72 7461 6c2e 706f 7374 696e 6974 2829  ortal.postinit()
-00015e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015e30: 2079 6965 6c64 2070 6f72 7461 6c0a 0a20   yield portal.. 
-00015e40: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
-00015e50: 2020 2020 6465 6620 6765 745f 6279 5f74      def get_by_t
-00015e60: 6872 6561 6428 0a20 2020 2020 2020 2063  hread(.        c
-00015e70: 6c73 2c0a 2020 2020 2020 2020 6b65 793a  ls,.        key:
-00015e80: 2067 7261 7068 716c 2e54 6872 6561 644b   graphql.ThreadK
-00015e90: 6579 207c 206d 7174 742e 5468 7265 6164  ey | mqtt.Thread
-00015ea0: 4b65 792c 0a20 2020 2020 2020 2066 625f  Key,.        fb_
-00015eb0: 7265 6365 6976 6572 3a20 696e 7420 7c20  receiver: int | 
-00015ec0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00015ed0: 2020 2020 2063 7265 6174 653a 2062 6f6f       create: boo
-00015ee0: 6c20 3d20 5472 7565 2c0a 2020 2020 2920  l = True,.    ) 
-00015ef0: 2d3e 2041 7761 6974 6162 6c65 5b50 6f72  -> Awaitable[Por
-00015f00: 7461 6c5d 3a0a 2020 2020 2020 2020 7265  tal]:.        re
-00015f10: 7475 726e 2063 6c73 2e67 6574 5f62 795f  turn cls.get_by_
-00015f20: 6662 6964 280a 2020 2020 2020 2020 2020  fbid(.          
-00015f30: 2020 6b65 792e 6964 2c0a 2020 2020 2020    key.id,.      
-00015f40: 2020 2020 2020 6662 5f72 6563 6569 7665        fb_receive
-00015f50: 723d 6662 5f72 6563 6569 7665 722c 0a20  r=fb_receiver,. 
-00015f60: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-00015f70: 653d 6372 6561 7465 2c0a 2020 2020 2020  e=create,.      
-00015f80: 2020 2020 2020 6662 5f74 7970 653d 5468        fb_type=Th
-00015f90: 7265 6164 5479 7065 2e66 726f 6d5f 7468  readType.from_th
-00015fa0: 7265 6164 5f6b 6579 286b 6579 292c 0a20  read_key(key),. 
-00015fb0: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
-00015fc0: 656e 6472 6567 696f 6e0a                 endregion.
+0000f110: 2020 2066 2249 676e 6f72 696e 6720 6f77     f"Ignoring ow
+0000f120: 6e20 7b6d 6964 7d20 696e 2070 7269 7661  n {mid} in priva
+0000f130: 7465 2063 6861 7420 6265 6361 7573 6520  te chat because 
+0000f140: 6f77 6e20 7075 7070 6574 2069 7320 6e6f  own puppet is no
+0000f150: 7420 696e 2072 6f6f 6d2e 220a 2020 2020  t in room.".    
+0000f160: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000f170: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000f180: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+0000f190: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+0000f1a0: 2020 2020 6173 796e 6320 6465 6620 5f61      async def _a
+0000f1b0: 6464 5f66 6163 6562 6f6f 6b5f 7265 706c  dd_facebook_repl
+0000f1c0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
+0000f1d0: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
+0000f1e0: 3a20 4d65 7373 6167 6545 7665 6e74 436f  : MessageEventCo
+0000f1f0: 6e74 656e 742c 0a20 2020 2020 2020 2072  ntent,.        r
+0000f200: 6570 6c79 5f74 6f3a 2067 7261 7068 716c  eply_to: graphql
+0000f210: 2e4d 696e 696d 616c 4d65 7373 6167 6520  .MinimalMessage 
+0000f220: 7c20 6d71 7474 2e4d 6573 7361 6765 2c0a  | mqtt.Message,.
+0000f230: 2020 2020 2020 2020 6465 7465 726d 696e          determin
+0000f240: 6973 7469 635f 6964 3a20 626f 6f6c 203d  istic_id: bool =
+0000f250: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+0000f260: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0000f270: 6620 6973 696e 7374 616e 6365 2872 6570  f isinstance(rep
+0000f280: 6c79 5f74 6f2c 2067 7261 7068 716c 2e4d  ly_to, graphql.M
+0000f290: 696e 696d 616c 4d65 7373 6167 6529 3a0a  inimalMessage):.
+0000f2a0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+0000f2b0: 6d73 675f 6964 203d 2072 6570 6c79 5f74  msg_id = reply_t
+0000f2c0: 6f2e 6d65 7373 6167 655f 6964 0a20 2020  o.message_id.   
+0000f2d0: 2020 2020 2020 2020 206d 6573 7361 6765           message
+0000f2e0: 203d 2061 7761 6974 2044 424d 6573 7361   = await DBMessa
+0000f2f0: 6765 2e67 6574 5f62 795f 6662 6964 2872  ge.get_by_fbid(r
+0000f300: 6570 6c79 5f74 6f2e 6d65 7373 6167 655f  eply_to.message_
+0000f310: 6964 2c20 7365 6c66 2e66 625f 7265 6365  id, self.fb_rece
+0000f320: 6976 6572 290a 2020 2020 2020 2020 656c  iver).        el
+0000f330: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0000f340: 706c 795f 746f 2c20 6d71 7474 2e4d 6573  ply_to, mqtt.Mes
+0000f350: 7361 6765 293a 0a20 2020 2020 2020 2020  sage):.         
+0000f360: 2020 206d 6574 6120 3d20 7265 706c 795f     meta = reply_
+0000f370: 746f 2e6d 6574 6164 6174 610a 2020 2020  to.metadata.    
+0000f380: 2020 2020 2020 2020 6c6f 675f 6d73 675f          log_msg_
+0000f390: 6964 203d 2066 227b 6d65 7461 2e69 647d  id = f"{meta.id}
+0000f3a0: 202f 207b 6d65 7461 2e6f 6666 6c69 6e65   / {meta.offline
+0000f3b0: 5f74 6872 6561 6469 6e67 5f69 647d 220a  _threading_id}".
+0000f3c0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+0000f3d0: 6167 6520 3d20 6177 6169 7420 4442 4d65  age = await DBMe
+0000f3e0: 7373 6167 652e 6765 745f 6279 5f66 6269  ssage.get_by_fbi
+0000f3f0: 645f 6f72 5f6f 7469 280a 2020 2020 2020  d_or_oti(.      
+0000f400: 2020 2020 2020 2020 2020 6d65 7461 2e69            meta.i
+0000f410: 642c 206d 6574 612e 6f66 666c 696e 655f  d, meta.offline_
+0000f420: 7468 7265 6164 696e 675f 6964 2c20 7365  threading_id, se
+0000f430: 6c66 2e66 625f 7265 6365 6976 6572 2c20  lf.fb_receiver, 
+0000f440: 6d65 7461 2e73 656e 6465 720a 2020 2020  meta.sender.    
+0000f450: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000f460: 2020 2020 2020 6966 206d 6573 7361 6765        if message
+0000f470: 2061 6e64 206e 6f74 206d 6573 7361 6765   and not message
+0000f480: 2e66 6269 643a 0a20 2020 2020 2020 2020  .fbid:.         
+0000f490: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+0000f4a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0000f4b0: 2020 2020 2020 2020 2020 2066 2247 6f74             f"Got
+0000f4c0: 206d 6573 7361 6765 2049 4420 7b6d 6574   message ID {met
+0000f4d0: 612e 6964 7d20 666f 7220 6f66 666c 696e  a.id} for offlin
+0000f4e0: 6520 7468 7265 6164 696e 6720 4944 2022  e threading ID "
+0000f4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f500: 2020 2020 2066 227b 6d65 7373 6167 652e       f"{message.
+0000f510: 6662 5f74 786e 5f69 647d 202f 207b 6d65  fb_txn_id} / {me
+0000f520: 7373 6167 652e 6d78 6964 7d20 2869 6e20  ssage.mxid} (in 
+0000f530: 6461 7461 6261 7365 2920 6672 6f6d 2072  database) from r
+0000f540: 6570 6c79 220a 2020 2020 2020 2020 2020  eply".          
+0000f550: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f560: 2020 2020 2020 2020 6d65 7373 6167 652e          message.
+0000f570: 6662 6964 203d 206d 6574 612e 6964 0a20  fbid = meta.id. 
+0000f580: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000f590: 6573 7361 6765 2e74 696d 6573 7461 6d70  essage.timestamp
+0000f5a0: 203d 206d 6574 612e 7469 6d65 7374 616d   = meta.timestam
+0000f5b0: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+0000f5c0: 2020 6177 6169 7420 6d65 7373 6167 652e    await message.
+0000f5d0: 7570 6461 7465 2829 0a20 2020 2020 2020  update().       
+0000f5e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000f5f0: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+0000f600: 2020 2069 6620 6e6f 7420 6d65 7373 6167     if not messag
+0000f610: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0000f620: 6620 6465 7465 726d 696e 6973 7469 635f  f deterministic_
+0000f630: 6964 2061 6e64 2069 7369 6e73 7461 6e63  id and isinstanc
+0000f640: 6528 7265 706c 795f 746f 2c20 6772 6170  e(reply_to, grap
+0000f650: 6871 6c2e 4d69 6e69 6d61 6c4d 6573 7361  hql.MinimalMessa
+0000f660: 6765 293a 0a20 2020 2020 2020 2020 2020  ge):.           
+0000f670: 2020 2020 2063 6f6e 7465 6e74 2e73 6574       content.set
+0000f680: 5f72 6570 6c79 2873 656c 662e 5f64 6574  _reply(self._det
+0000f690: 6572 6d69 6e69 7374 6963 5f65 7665 6e74  erministic_event
+0000f6a0: 5f69 6428 7265 706c 795f 746f 2e6d 6573  _id(reply_to.mes
+0000f6b0: 7361 6765 5f69 642c 2030 2929 0a20 2020  sage_id, 0)).   
+0000f6c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000f6d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f6e0: 656c 662e 6c6f 672e 7761 726e 696e 6728  elf.log.warning(
+0000f6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f700: 2020 2020 2066 2243 6f75 6c64 6e27 7420       f"Couldn't 
+0000f710: 6669 6e64 2072 6570 6c79 2074 6172 6765  find reply targe
+0000f720: 7420 7b6c 6f67 5f6d 7367 5f69 647d 2074  t {log_msg_id} t
+0000f730: 6f20 6272 6964 6765 2072 6570 6c79 206d  o bridge reply m
+0000f740: 6574 6164 6174 6120 746f 204d 6174 7269  etadata to Matri
+0000f750: 7822 0a20 2020 2020 2020 2020 2020 2020  x".             
+0000f760: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000f770: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0000f780: 2063 6f6e 7465 6e74 2e73 6574 5f72 6570   content.set_rep
+0000f790: 6c79 286d 6573 7361 6765 2e6d 7869 6429  ly(message.mxid)
+0000f7a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000f7b0: 6973 696e 7374 616e 6365 2863 6f6e 7465  isinstance(conte
+0000f7c0: 6e74 2c20 5465 7874 4d65 7373 6167 6545  nt, TextMessageE
+0000f7d0: 7665 6e74 436f 6e74 656e 7429 206f 7220  ventContent) or 
+0000f7e0: 7365 6c66 2e64 6973 6162 6c65 5f72 6570  self.disable_rep
+0000f7f0: 6c79 5f66 616c 6c62 6163 6b73 3a0a 2020  ly_fallbacks:.  
+0000f800: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000f810: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+0000f820: 2020 2020 2020 2020 2020 2065 7674 203d             evt =
+0000f830: 2061 7761 6974 2073 656c 662e 6d61 696e   await self.main
+0000f840: 5f69 6e74 656e 742e 6765 745f 6576 656e  _intent.get_even
+0000f850: 7428 6d65 7373 6167 652e 6d78 5f72 6f6f  t(message.mx_roo
+0000f860: 6d2c 206d 6573 7361 6765 2e6d 7869 6429  m, message.mxid)
+0000f870: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000f880: 284d 4e6f 7446 6f75 6e64 2c20 4d46 6f72  (MNotFound, MFor
+0000f890: 6269 6464 656e 293a 0a20 2020 2020 2020  bidden):.       
+0000f8a0: 2020 2020 2065 7674 203d 204e 6f6e 650a       evt = None.
+0000f8b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000f8c0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0000f8d0: 2020 2020 2020 7365 6c66 2e6c 6f67 2e77        self.log.w
+0000f8e0: 6172 6e69 6e67 2822 4661 696c 6564 2074  arning("Failed t
+0000f8f0: 6f20 6665 7463 6820 6576 656e 7420 666f  o fetch event fo
+0000f900: 7220 6765 6e65 7261 7469 6e67 2072 6570  r generating rep
+0000f910: 6c79 2066 616c 6c62 6163 6b22 2c20 6578  ly fallback", ex
+0000f920: 635f 696e 666f 3d54 7275 6529 0a20 2020  c_info=True).   
+0000f930: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000f940: 2020 2020 2020 2020 6966 206e 6f74 2065          if not e
+0000f950: 7674 3a0a 2020 2020 2020 2020 2020 2020  vt:.            
+0000f960: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0000f970: 6966 2065 7674 2e74 7970 6520 3d3d 2045  if evt.type == E
+0000f980: 7665 6e74 5479 7065 2e52 4f4f 4d5f 454e  ventType.ROOM_EN
+0000f990: 4352 5950 5445 443a 0a20 2020 2020 2020  CRYPTED:.       
+0000f9a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000f9b0: 2020 2020 2020 2020 2020 6576 7420 3d20            evt = 
+0000f9c0: 6177 6169 7420 7365 6c66 2e6d 6174 7269  await self.matri
+0000f9d0: 782e 6532 6565 2e64 6563 7279 7074 2865  x.e2ee.decrypt(e
+0000f9e0: 7674 2c20 7761 6974 5f73 6573 7369 6f6e  vt, wait_session
+0000f9f0: 5f74 696d 656f 7574 3d30 290a 2020 2020  _timeout=0).    
+0000fa00: 2020 2020 2020 2020 6578 6365 7074 2044          except D
+0000fa10: 6563 7279 7074 696f 6e45 7272 6f72 3a0a  ecryptionError:.
+0000fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa30: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0000fa40: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000fa50: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+0000fa60: 2020 2020 2073 656c 662e 6c6f 672e 7761       self.log.wa
+0000fa70: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+0000fa80: 2020 2020 2020 2020 2020 2022 4661 696c             "Fail
+0000fa90: 6564 2074 6f20 6465 6372 7970 7420 6576  ed to decrypt ev
+0000faa0: 656e 7420 666f 7220 6765 6e65 7261 7469  ent for generati
+0000fab0: 6e67 2072 6570 6c79 2066 616c 6c62 6163  ng reply fallbac
+0000fac0: 6b22 2c20 6578 635f 696e 666f 3d54 7275  k", exc_info=Tru
+0000fad0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000fae0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000faf0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0000fb00: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000fb10: 6528 6576 742e 636f 6e74 656e 742c 2054  e(evt.content, T
+0000fb20: 6578 744d 6573 7361 6765 4576 656e 7443  extMessageEventC
+0000fb30: 6f6e 7465 6e74 293a 0a20 2020 2020 2020  ontent):.       
+0000fb40: 2020 2020 2065 7674 2e63 6f6e 7465 6e74       evt.content
+0000fb50: 2e74 7269 6d5f 7265 706c 795f 6661 6c6c  .trim_reply_fall
+0000fb60: 6261 636b 2829 0a0a 2020 2020 2020 2020  back()..        
+0000fb70: 636f 6e74 656e 742e 7365 745f 7265 706c  content.set_repl
+0000fb80: 7928 6576 7429 0a0a 2020 2020 6173 796e  y(evt)..    asyn
+0000fb90: 6320 6465 6620 6861 6e64 6c65 5f66 6163  c def handle_fac
+0000fba0: 6562 6f6f 6b5f 6d65 7373 6167 6528 0a20  ebook_message(. 
+0000fbb0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000fbc0: 2020 2020 2073 6f75 7263 653a 2075 2e55       source: u.U
+0000fbd0: 7365 722c 0a20 2020 2020 2020 2073 656e  ser,.        sen
+0000fbe0: 6465 723a 2070 2e50 7570 7065 742c 0a20  der: p.Puppet,. 
+0000fbf0: 2020 2020 2020 206d 6573 7361 6765 3a20         message: 
+0000fc00: 6772 6170 6871 6c2e 4d65 7373 6167 6520  graphql.Message 
+0000fc10: 7c20 6d71 7474 2e4d 6573 7361 6765 2c0a  | mqtt.Message,.
+0000fc20: 2020 2020 2020 2020 7265 706c 795f 746f          reply_to
+0000fc30: 3a20 6d71 7474 2e4d 6573 7361 6765 207c  : mqtt.Message |
+0000fc40: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0000fc50: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0000fc60: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000fc70: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+0000fc80: 2e5f 6861 6e64 6c65 5f66 6163 6562 6f6f  ._handle_faceboo
+0000fc90: 6b5f 6d65 7373 6167 6528 736f 7572 6365  k_message(source
+0000fca0: 2c20 7365 6e64 6572 2c20 6d65 7373 6167  , sender, messag
+0000fcb0: 652c 2072 6570 6c79 5f74 6f29 0a20 2020  e, reply_to).   
+0000fcc0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0000fcd0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+0000fce0: 2020 2073 656c 662e 6c6f 672e 6578 6365     self.log.exce
+0000fcf0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+0000fd00: 2020 2020 2020 2022 4572 726f 7220 6861         "Error ha
+0000fd10: 6e64 6c69 6e67 2046 6163 6562 6f6f 6b20  ndling Facebook 
+0000fd20: 6d65 7373 6167 6520 2573 222c 0a20 2020  message %s",.   
+0000fd30: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+0000fd40: 7361 6765 2e6d 6573 7361 6765 5f69 640a  sage.message_id.
+0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd60: 6966 2069 7369 6e73 7461 6e63 6528 6d65  if isinstance(me
+0000fd70: 7373 6167 652c 2067 7261 7068 716c 2e4d  ssage, graphql.M
+0000fd80: 6573 7361 6765 290a 2020 2020 2020 2020  essage).        
+0000fd90: 2020 2020 2020 2020 656c 7365 206d 6573          else mes
+0000fda0: 7361 6765 2e6d 6574 6164 6174 612e 6964  sage.metadata.id
+0000fdb0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000fdc0: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+0000fdd0: 6861 6e64 6c65 5f66 6163 6562 6f6f 6b5f  handle_facebook_
+0000fde0: 6d65 7373 6167 6528 0a20 2020 2020 2020  message(.       
+0000fdf0: 2073 656c 662c 0a20 2020 2020 2020 2073   self,.        s
+0000fe00: 6f75 7263 653a 2075 2e55 7365 722c 0a20  ource: u.User,. 
+0000fe10: 2020 2020 2020 2073 656e 6465 723a 2070         sender: p
+0000fe20: 2e50 7570 7065 742c 0a20 2020 2020 2020  .Puppet,.       
+0000fe30: 206d 6573 7361 6765 3a20 6772 6170 6871   message: graphq
+0000fe40: 6c2e 4d65 7373 6167 6520 7c20 6d71 7474  l.Message | mqtt
+0000fe50: 2e4d 6573 7361 6765 2c0a 2020 2020 2020  .Message,.      
+0000fe60: 2020 7265 706c 795f 746f 3a20 6d71 7474    reply_to: mqtt
+0000fe70: 2e4d 6573 7361 6765 207c 204e 6f6e 6520  .Message | None 
+0000fe80: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+0000fe90: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0000fea0: 6620 6973 696e 7374 616e 6365 286d 6573  f isinstance(mes
+0000feb0: 7361 6765 2c20 6772 6170 6871 6c2e 4d65  sage, graphql.Me
+0000fec0: 7373 6167 6529 3a0a 2020 2020 2020 2020  ssage):.        
+0000fed0: 2020 2020 7365 6c66 2e6c 6f67 2e74 7261      self.log.tra
+0000fee0: 6365 2822 4661 6365 626f 6f6b 2047 7261  ce("Facebook Gra
+0000fef0: 7068 514c 2065 7665 6e74 2063 6f6e 7465  phQL event conte
+0000ff00: 6e74 3a20 2573 222c 206d 6573 7361 6765  nt: %s", message
+0000ff10: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
+0000ff20: 675f 6964 203d 206d 6573 7361 6765 2e6d  g_id = message.m
+0000ff30: 6573 7361 6765 5f69 640a 2020 2020 2020  essage_id.      
+0000ff40: 2020 2020 2020 6f74 6920 3d20 696e 7428        oti = int(
+0000ff50: 6d65 7373 6167 652e 6f66 666c 696e 655f  message.offline_
+0000ff60: 7468 7265 6164 696e 675f 6964 290a 2020  threading_id).  
+0000ff70: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+0000ff80: 616d 7020 3d20 6d65 7373 6167 652e 7469  amp = message.ti
+0000ff90: 6d65 7374 616d 700a 0a20 2020 2020 2020  mestamp..       
+0000ffa0: 2020 2020 2064 6566 2062 6163 6b66 696c       def backfil
+0000ffb0: 6c5f 7265 6163 7469 6f6e 7328 6462 6d3a  l_reactions(dbm:
+0000ffc0: 2044 424d 6573 7361 6765 207c 204e 6f6e   DBMessage | Non
+0000ffd0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000ffe0: 2020 2020 6261 636b 6772 6f75 6e64 5f74      background_t
+0000fff0: 6173 6b2e 6372 6561 7465 280a 2020 2020  ask.create(.    
+00010000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010010: 7365 6c66 2e5f 7472 795f 6861 6e64 6c65  self._try_handle
+00010020: 5f67 7261 7068 716c 5f72 6561 6374 696f  _graphql_reactio
+00010030: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
+00010040: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00010050: 6365 2c20 6462 6d20 6f72 206d 7367 5f69  ce, dbm or msg_i
+00010060: 642c 206d 6573 7361 6765 2e6d 6573 7361  d, message.messa
+00010070: 6765 5f72 6561 6374 696f 6e73 0a20 2020  ge_reactions.   
+00010080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010090: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000100a0: 2020 2029 0a0a 2020 2020 2020 2020 656c     )..        el
+000100b0: 6966 2069 7369 6e73 7461 6e63 6528 6d65  if isinstance(me
+000100c0: 7373 6167 652c 206d 7174 742e 4d65 7373  ssage, mqtt.Mess
+000100d0: 6167 6529 3a0a 2020 2020 2020 2020 2020  age):.          
+000100e0: 2020 7365 6c66 2e6c 6f67 2e74 7261 6365    self.log.trace
+000100f0: 2822 4661 6365 626f 6f6b 204d 5154 5420  ("Facebook MQTT 
+00010100: 6576 656e 7420 636f 6e74 656e 743a 2025  event content: %
+00010110: 7322 2c20 6d65 7373 6167 6529 0a20 2020  s", message).   
+00010120: 2020 2020 2020 2020 206d 7367 5f69 6420           msg_id 
+00010130: 3d20 6d65 7373 6167 652e 6d65 7461 6461  = message.metada
+00010140: 7461 2e69 640a 2020 2020 2020 2020 2020  ta.id.          
+00010150: 2020 6f74 6920 3d20 6d65 7373 6167 652e    oti = message.
+00010160: 6d65 7461 6461 7461 2e6f 6666 6c69 6e65  metadata.offline
+00010170: 5f74 6872 6561 6469 6e67 5f69 640a 2020  _threading_id.  
+00010180: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+00010190: 616d 7020 3d20 6d65 7373 6167 652e 6d65  amp = message.me
+000101a0: 7461 6461 7461 2e74 696d 6573 7461 6d70  tadata.timestamp
+000101b0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+000101c0: 6620 6261 636b 6669 6c6c 5f72 6561 6374  f backfill_react
+000101d0: 696f 6e73 285f 293a 0a20 2020 2020 2020  ions(_):.       
+000101e0: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
+000101f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010200: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00010210: 616c 7565 4572 726f 7228 6622 496e 7661  alueError(f"Inva
+00010220: 6c69 6420 6d65 7373 6167 6520 636c 6173  lid message clas
+00010230: 7320 7b74 7970 6528 6d65 7373 6167 6529  s {type(message)
+00010240: 2e5f 5f6e 616d 655f 5f7d 2229 0a0a 2020  .__name__}")..  
+00010250: 2020 2020 2020 2320 4368 6563 6b20 696e        # Check in
+00010260: 2d6d 656d 6f72 7920 7175 6575 6573 2066  -memory queues f
+00010270: 6f72 2064 7570 6c69 6361 7465 730a 2020  or duplicates.  
+00010280: 2020 2020 2020 6966 206f 7469 2069 6e20        if oti in 
+00010290: 7365 6c66 2e5f 6f74 695f 6465 6475 703a  self._oti_dedup:
+000102a0: 0a20 2020 2020 2020 2020 2020 2064 626d  .            dbm
+000102b0: 203d 2073 656c 662e 5f6f 7469 5f64 6564   = self._oti_ded
+000102c0: 7570 2e70 6f70 286f 7469 290a 2020 2020  up.pop(oti).    
+000102d0: 2020 2020 2020 2020 7365 6c66 2e5f 6465          self._de
+000102e0: 6475 702e 6170 7065 6e64 6c65 6674 286d  dup.appendleft(m
+000102f0: 7367 5f69 6429 0a20 2020 2020 2020 2020  sg_id).         
+00010300: 2020 2073 656c 662e 6c6f 672e 6465 6275     self.log.debu
+00010310: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00010320: 2020 2066 2247 6f74 206d 6573 7361 6765     f"Got message
+00010330: 2049 4420 7b6d 7367 5f69 647d 2066 6f72   ID {msg_id} for
+00010340: 206f 6666 6c69 6e65 2074 6872 6561 6469   offline threadi
+00010350: 6e67 2049 4420 7b6f 7469 7d20 2f20 7b64  ng ID {oti} / {d
+00010360: 626d 2e6d 7869 647d 220a 2020 2020 2020  bm.mxid}".      
+00010370: 2020 2020 2020 2020 2020 2220 2869 6e20            " (in 
+00010380: 6465 6475 7020 7175 6575 6529 220a 2020  dedup queue)".  
+00010390: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000103a0: 2020 2020 2020 2020 6462 6d2e 6662 6964          dbm.fbid
+000103b0: 203d 206d 7367 5f69 640a 2020 2020 2020   = msg_id.      
+000103c0: 2020 2020 2020 6462 6d2e 7469 6d65 7374        dbm.timest
+000103d0: 616d 7020 3d20 7469 6d65 7374 616d 700a  amp = timestamp.
+000103e0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000103f0: 7420 6462 6d2e 7570 6461 7465 2829 0a20  t dbm.update(). 
+00010400: 2020 2020 2020 2020 2020 2062 6163 6b66             backf
+00010410: 696c 6c5f 7265 6163 7469 6f6e 7328 6462  ill_reactions(db
+00010420: 6d29 0a20 2020 2020 2020 2020 2020 2072  m).            r
+00010430: 6574 7572 6e0a 2020 2020 2020 2020 656c  eturn.        el
+00010440: 6966 206d 7367 5f69 6420 696e 2073 656c  if msg_id in sel
+00010450: 662e 5f64 6564 7570 3a0a 2020 2020 2020  f._dedup:.      
+00010460: 2020 2020 2020 7365 6c66 2e6c 6f67 2e74        self.log.t
+00010470: 7261 6365 2822 4e6f 7420 6861 6e64 6c69  race("Not handli
+00010480: 6e67 206d 6573 7361 6765 2025 732c 2066  ng message %s, f
+00010490: 6f75 6e64 2049 4420 696e 2064 6564 7570  ound ID in dedup
+000104a0: 2071 7565 7565 222c 206d 7367 5f69 6429   queue", msg_id)
+000104b0: 0a20 2020 2020 2020 2020 2020 2062 6163  .            bac
+000104c0: 6b66 696c 6c5f 7265 6163 7469 6f6e 7328  kfill_reactions(
+000104d0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+000104e0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+000104f0: 2020 7365 6c66 2e5f 6465 6475 702e 6170    self._dedup.ap
+00010500: 7065 6e64 6c65 6674 286d 7367 5f69 6429  pendleft(msg_id)
+00010510: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+00010520: 6b20 6461 7461 6261 7365 2066 6f72 2064  k database for d
+00010530: 7570 6c69 6361 7465 730a 2020 2020 2020  uplicates.      
+00010540: 2020 6462 6d20 3d20 6177 6169 7420 4442    dbm = await DB
+00010550: 4d65 7373 6167 652e 6765 745f 6279 5f66  Message.get_by_f
+00010560: 6269 645f 6f72 5f6f 7469 286d 7367 5f69  bid_or_oti(msg_i
+00010570: 642c 206f 7469 2c20 7365 6c66 2e66 625f  d, oti, self.fb_
+00010580: 7265 6365 6976 6572 2c20 7365 6e64 6572  receiver, sender
+00010590: 2e66 6269 6429 0a20 2020 2020 2020 2069  .fbid).        i
+000105a0: 6620 6462 6d3a 0a20 2020 2020 2020 2020  f dbm:.         
+000105b0: 2020 2069 6620 6e6f 7420 6462 6d2e 6662     if not dbm.fb
+000105c0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+000105d0: 2020 2020 7365 6c66 2e6c 6f67 2e64 6562      self.log.deb
+000105e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000105f0: 2020 2020 2020 2020 6622 476f 7420 6d65          f"Got me
+00010600: 7373 6167 6520 4944 207b 6d73 675f 6964  ssage ID {msg_id
+00010610: 7d20 666f 7220 6f66 666c 696e 6520 7468  } for offline th
+00010620: 7265 6164 696e 6720 4944 207b 6462 6d2e  reading ID {dbm.
+00010630: 6662 5f74 786e 5f69 647d 2022 0a20 2020  fb_txn_id} ".   
+00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010650: 2066 222f 207b 6462 6d2e 6d78 6964 7d20   f"/ {dbm.mxid} 
+00010660: 2869 6e20 6461 7461 6261 7365 2922 0a20  (in database)". 
+00010670: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00010680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010690: 2064 626d 2e66 6269 6420 3d20 6d73 675f   dbm.fbid = msg_
+000106a0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+000106b0: 2020 2064 626d 2e74 696d 6573 7461 6d70     dbm.timestamp
+000106c0: 203d 2074 696d 6573 7461 6d70 0a20 2020   = timestamp.   
+000106d0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+000106e0: 6974 2064 626d 2e75 7064 6174 6528 290a  it dbm.update().
+000106f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00010700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010710: 2020 7365 6c66 2e6c 6f67 2e64 6562 7567    self.log.debug
+00010720: 2866 224e 6f74 2068 616e 646c 696e 6720  (f"Not handling 
+00010730: 6d65 7373 6167 6520 7b6d 7367 5f69 647d  message {msg_id}
+00010740: 2c20 666f 756e 6420 6475 706c 6963 6174  , found duplicat
+00010750: 6520 696e 2064 6174 6162 6173 6522 290a  e in database").
+00010760: 2020 2020 2020 2020 2020 2020 6261 636b              back
+00010770: 6669 6c6c 5f72 6561 6374 696f 6e73 2864  fill_reactions(d
+00010780: 626d 290a 2020 2020 2020 2020 2020 2020  bm).            
+00010790: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+000107a0: 7365 6c66 2e6c 6f67 2e64 6562 7567 2866  self.log.debug(f
+000107b0: 2248 616e 646c 696e 6720 4661 6365 626f  "Handling Facebo
+000107c0: 6f6b 2065 7665 6e74 207b 6d73 675f 6964  ok event {msg_id
+000107d0: 7d20 282f 7b6f 7469 7d29 2229 0a20 2020  } (/{oti})").   
+000107e0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+000107f0: 2e6d 7869 643a 0a20 2020 2020 2020 2020  .mxid:.         
+00010800: 2020 206d 7869 6420 3d20 6177 6169 7420     mxid = await 
+00010810: 7365 6c66 2e63 7265 6174 655f 6d61 7472  self.create_matr
+00010820: 6978 5f72 6f6f 6d28 736f 7572 6365 290a  ix_room(source).
+00010830: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00010840: 6f74 206d 7869 643a 0a20 2020 2020 2020  ot mxid:.       
+00010850: 2020 2020 2020 2020 2023 2046 6169 6c65           # Faile
+00010860: 6420 746f 2063 7265 6174 650a 2020 2020  d to create.    
+00010870: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010880: 726e 0a0a 2020 2020 2020 2020 2020 2020  rn..            
+00010890: 6966 2073 656c 662e 636f 6e66 6967 5b22  if self.config["
+000108a0: 6272 6964 6765 2e62 6163 6b66 696c 6c2e  bridge.backfill.
+000108b0: 656e 6162 6c65 225d 3a0a 2020 2020 2020  enable"]:.      
+000108c0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000108d0: 662e 636f 6e66 6967 5b22 6272 6964 6765  f.config["bridge
+000108e0: 2e62 6163 6b66 696c 6c2e 6d73 6332 3731  .backfill.msc271
+000108f0: 3622 5d3a 0a20 2020 2020 2020 2020 2020  6"]:.           
+00010900: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00010910: 656c 662e 656e 7175 6575 655f 696d 6d65  elf.enqueue_imme
+00010920: 6469 6174 655f 6261 636b 6669 6c6c 2873  diate_backfill(s
+00010930: 6f75 7263 652c 2030 290a 2020 2020 2020  ource, 0).      
+00010940: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+00010950: 2062 6163 6b66 696c 6c20 696d 6d65 6469   backfill immedi
+00010960: 6174 6520 7061 6765 2077 6974 686f 7574  ate page without
+00010970: 204d 5343 3237 3136 0a20 2020 2020 2020   MSC2716.       
+00010980: 2069 6620 6e6f 7420 6177 6169 7420 7365   if not await se
+00010990: 6c66 2e5f 6272 6964 6765 5f6f 776e 5f6d  lf._bridge_own_m
+000109a0: 6573 7361 6765 5f70 6d28 736f 7572 6365  essage_pm(source
+000109b0: 2c20 7365 6e64 6572 2c20 6622 6d65 7373  , sender, f"mess
+000109c0: 6167 6520 7b6d 7367 5f69 647d 2229 3a0a  age {msg_id}"):.
+000109d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000109e0: 726e 0a20 2020 2020 2020 2069 6e74 656e  rn.        inten
+000109f0: 7420 3d20 7365 6e64 6572 2e69 6e74 656e  t = sender.inten
+00010a00: 745f 666f 7228 7365 6c66 290a 2020 2020  t_for(self).    
+00010a10: 2020 2020 6576 656e 745f 6964 7320 3d20      event_ids = 
+00010a20: 5b5d 0a20 2020 2020 2020 2066 6f72 2065  [].        for e
+00010a30: 7665 6e74 5f74 7970 652c 2063 6f6e 7465  vent_type, conte
+00010a40: 6e74 2069 6e20 6177 6169 7420 7365 6c66  nt in await self
+00010a50: 2e63 6f6e 7665 7274 5f66 6163 6562 6f6f  .convert_faceboo
+00010a60: 6b5f 6d65 7373 6167 6528 0a20 2020 2020  k_message(.     
+00010a70: 2020 2020 2020 2073 6f75 7263 652c 2069         source, i
+00010a80: 6e74 656e 742c 206d 6573 7361 6765 2c20  ntent, message, 
+00010a90: 7265 706c 795f 746f 0a20 2020 2020 2020  reply_to.       
+00010aa0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00010ab0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00010ac0: 6528 6d65 7373 6167 652c 2028 6772 6170  e(message, (grap
+00010ad0: 6871 6c2e 4d65 7373 6167 652c 206d 7174  hql.Message, mqt
+00010ae0: 742e 4d65 7373 6167 6529 290a 2020 2020  t.Message)).    
+00010af0: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+00010b00: 7020 3d20 280a 2020 2020 2020 2020 2020  p = (.          
+00010b10: 2020 2020 2020 6d65 7373 6167 652e 7469        message.ti
+00010b20: 6d65 7374 616d 700a 2020 2020 2020 2020  mestamp.        
+00010b30: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00010b40: 7461 6e63 6528 6d65 7373 6167 652c 2067  tance(message, g
+00010b50: 7261 7068 716c 2e4d 6573 7361 6765 290a  raphql.Message).
+00010b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b70: 656c 7365 206d 6573 7361 6765 2e6d 6574  else message.met
+00010b80: 6164 6174 612e 7469 6d65 7374 616d 700a  adata.timestamp.
+00010b90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00010ba0: 2020 2020 2020 2020 2020 6576 656e 745f            event_
+00010bb0: 6964 732e 6170 7065 6e64 280a 2020 2020  ids.append(.    
+00010bc0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00010bd0: 7420 7365 6c66 2e5f 7365 6e64 5f6d 6573  t self._send_mes
+00010be0: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
+00010bf0: 2020 2020 2020 2020 2020 696e 7465 6e74            intent
+00010c00: 2c20 636f 6e74 656e 742c 2065 7665 6e74  , content, event
+00010c10: 5f74 7970 653d 6576 656e 745f 7479 7065  _type=event_type
+00010c20: 2c20 7469 6d65 7374 616d 703d 7469 6d65  , timestamp=time
+00010c30: 7374 616d 700a 2020 2020 2020 2020 2020  stamp.          
+00010c40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010c50: 2020 2020 290a 2020 2020 2020 2020 6576      ).        ev
+00010c60: 656e 745f 6964 7320 3d20 5b65 7665 6e74  ent_ids = [event
+00010c70: 5f69 6420 666f 7220 6576 656e 745f 6964  _id for event_id
+00010c80: 2069 6e20 6576 656e 745f 6964 7320 6966   in event_ids if
+00010c90: 2065 7665 6e74 5f69 645d 0a20 2020 2020   event_id].     
+00010ca0: 2020 2069 6620 6e6f 7420 6576 656e 745f     if not event_
+00010cb0: 6964 733a 0a20 2020 2020 2020 2020 2020  ids:.           
+00010cc0: 2073 656c 662e 6c6f 672e 7761 726e 696e   self.log.warnin
+00010cd0: 6728 6622 556e 6861 6e64 6c65 6420 4d65  g(f"Unhandled Me
+00010ce0: 7373 656e 6765 7220 6d65 7373 6167 6520  ssenger message 
+00010cf0: 7b6d 7367 5f69 647d 2229 0a20 2020 2020  {msg_id}").     
+00010d00: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00010d10: 2020 2020 2020 7365 6c66 2e6c 6f67 2e64        self.log.d
+00010d20: 6562 7567 2866 2248 616e 646c 6564 204d  ebug(f"Handled M
+00010d30: 6573 7365 6e67 6572 206d 6573 7361 6765  essenger message
+00010d40: 207b 6d73 675f 6964 7d20 2d3e 207b 6576   {msg_id} -> {ev
+00010d50: 656e 745f 6964 737d 2229 0a20 2020 2020  ent_ids}").     
+00010d60: 2020 2063 7265 6174 6564 5f6d 7367 7320     created_msgs 
+00010d70: 3d20 6177 6169 7420 4442 4d65 7373 6167  = await DBMessag
+00010d80: 652e 6275 6c6b 5f63 7265 6174 655f 7061  e.bulk_create_pa
+00010d90: 7274 7328 0a20 2020 2020 2020 2020 2020  rts(.           
+00010da0: 2066 6269 643d 6d73 675f 6964 2c0a 2020   fbid=msg_id,.  
+00010db0: 2020 2020 2020 2020 2020 6f74 693d 6f74            oti=ot
+00010dc0: 692c 0a20 2020 2020 2020 2020 2020 2066  i,.            f
+00010dd0: 625f 6368 6174 3d73 656c 662e 6662 6964  b_chat=self.fbid
+00010de0: 2c0a 2020 2020 2020 2020 2020 2020 6662  ,.            fb
+00010df0: 5f73 656e 6465 723d 7365 6e64 6572 2e66  _sender=sender.f
+00010e00: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
+00010e10: 2066 625f 7265 6365 6976 6572 3d73 656c   fb_receiver=sel
+00010e20: 662e 6662 5f72 6563 6569 7665 722c 0a20  f.fb_receiver,. 
+00010e30: 2020 2020 2020 2020 2020 206d 785f 726f             mx_ro
+00010e40: 6f6d 3d73 656c 662e 6d78 6964 2c0a 2020  om=self.mxid,.  
+00010e50: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+00010e60: 616d 703d 7469 6d65 7374 616d 702c 0a20  amp=timestamp,. 
+00010e70: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+00010e80: 5f69 6473 3d65 7665 6e74 5f69 6473 2c0a  _ids=event_ids,.
+00010e90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010ea0: 2020 6177 6169 7420 7365 6c66 2e5f 7365    await self._se
+00010eb0: 6e64 5f64 656c 6976 6572 795f 7265 6365  nd_delivery_rece
+00010ec0: 6970 7428 6576 656e 745f 6964 735b 2d31  ipt(event_ids[-1
+00010ed0: 5d29 0a20 2020 2020 2020 2069 6620 6973  ]).        if is
+00010ee0: 696e 7374 616e 6365 286d 6573 7361 6765  instance(message
+00010ef0: 2c20 6772 6170 6871 6c2e 4d65 7373 6167  , graphql.Messag
+00010f00: 6529 2061 6e64 206d 6573 7361 6765 2e6d  e) and message.m
+00010f10: 6573 7361 6765 5f72 6561 6374 696f 6e73  essage_reactions
+00010f20: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00010f30: 6169 7420 7365 6c66 2e5f 6861 6e64 6c65  ait self._handle
+00010f40: 5f67 7261 7068 716c 5f72 6561 6374 696f  _graphql_reactio
+00010f50: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
+00010f60: 2020 2020 736f 7572 6365 2c20 6372 6561      source, crea
+00010f70: 7465 645f 6d73 6773 5b30 5d2c 206d 6573  ted_msgs[0], mes
+00010f80: 7361 6765 2e6d 6573 7361 6765 5f72 6561  sage.message_rea
+00010f90: 6374 696f 6e73 2c20 7469 6d65 7374 616d  ctions, timestam
+00010fa0: 700a 2020 2020 2020 2020 2020 2020 290a  p.            ).
+00010fb0: 0a20 2020 2064 6566 205f 6465 7465 726d  .    def _determ
+00010fc0: 696e 6973 7469 635f 6576 656e 745f 6964  inistic_event_id
+00010fd0: 2873 656c 662c 206d 6573 7361 6765 5f69  (self, message_i
+00010fe0: 643a 2069 6e74 207c 2073 7472 2c20 696e  d: int | str, in
+00010ff0: 6465 783a 2069 6e74 2920 2d3e 2045 7665  dex: int) -> Eve
+00011000: 6e74 4944 3a0a 2020 2020 2020 2020 6861  ntID:.        ha
+00011010: 7368 5f63 6f6e 7465 6e74 203d 2066 227b  sh_content = f"{
+00011020: 7365 6c66 2e6d 7869 647d 2f66 6163 6562  self.mxid}/faceb
+00011030: 6f6f 6b2f 7b6d 6573 7361 6765 5f69 647d  ook/{message_id}
+00011040: 2f7b 696e 6465 787d 220a 2020 2020 2020  /{index}".      
+00011050: 2020 6861 7368 6564 203d 2068 6173 686c    hashed = hashl
+00011060: 6962 2e73 6861 3235 3628 6861 7368 5f63  ib.sha256(hash_c
+00011070: 6f6e 7465 6e74 2e65 6e63 6f64 6528 2275  ontent.encode("u
+00011080: 7466 2d38 2229 292e 6469 6765 7374 2829  tf-8")).digest()
+00011090: 0a20 2020 2020 2020 2062 3634 6861 7368  .        b64hash
+000110a0: 203d 2062 6173 6536 342e 7572 6c73 6166   = base64.urlsaf
+000110b0: 655f 6236 3465 6e63 6f64 6528 6861 7368  e_b64encode(hash
+000110c0: 6564 292e 6465 636f 6465 2822 7574 662d  ed).decode("utf-
+000110d0: 3822 292e 7273 7472 6970 2822 3d22 290a  8").rstrip("=").
+000110e0: 2020 2020 2020 2020 7265 7475 726e 2045          return E
+000110f0: 7665 6e74 4944 2866 2224 7b62 3634 6861  ventID(f"${b64ha
+00011100: 7368 7d3a 6661 6365 626f 6f6b 2e63 6f6d  sh}:facebook.com
+00011110: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
+00011120: 6620 636f 6e76 6572 745f 6661 6365 626f  f convert_facebo
+00011130: 6f6b 5f6d 6573 7361 6765 280a 2020 2020  ok_message(.    
+00011140: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00011150: 2020 736f 7572 6365 3a20 752e 5573 6572    source: u.User
+00011160: 2c0a 2020 2020 2020 2020 696e 7465 6e74  ,.        intent
+00011170: 3a20 496e 7465 6e74 4150 492c 0a20 2020  : IntentAPI,.   
+00011180: 2020 2020 206d 6573 7361 6765 3a20 6772       message: gr
+00011190: 6170 6871 6c2e 4d65 7373 6167 6520 7c20  aphql.Message | 
+000111a0: 6d71 7474 2e4d 6573 7361 6765 2c0a 2020  mqtt.Message,.  
+000111b0: 2020 2020 2020 7265 706c 795f 746f 3a20        reply_to: 
+000111c0: 6d71 7474 2e4d 6573 7361 6765 207c 204e  mqtt.Message | N
+000111d0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+000111e0: 2020 2020 6465 7465 726d 696e 6973 7469      deterministi
+000111f0: 635f 7265 706c 795f 6964 3a20 626f 6f6c  c_reply_id: bool
+00011200: 203d 2046 616c 7365 2c0a 2020 2020 2920   = False,.    ) 
+00011210: 2d3e 206c 6973 745b 436f 6e76 6572 7465  -> list[Converte
+00011220: 644d 6573 7361 6765 5d3a 0a20 2020 2020  dMessage]:.     
+00011230: 2020 2063 6f6e 7665 7274 6564 3a20 6c69     converted: li
+00011240: 7374 5b43 6f6e 7665 7274 6564 4d65 7373  st[ConvertedMess
+00011250: 6167 655d 203d 205b 5d0a 0a20 2020 2020  age] = []..     
+00011260: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00011270: 2020 2020 6966 206d 6573 7361 6765 2e6d      if message.m
+00011280: 6f6e 7461 6765 5f72 6570 6c79 5f64 6174  ontage_reply_dat
+00011290: 6120 616e 6420 6d65 7373 6167 652e 6d6f  a and message.mo
+000112a0: 6e74 6167 655f 7265 706c 795f 6461 7461  ntage_reply_data
+000112b0: 2e73 6e69 7070 6574 3a0a 2020 2020 2020  .snippet:.      
+000112c0: 2020 2020 2020 2020 2020 636f 6e76 6572            conver
+000112d0: 7465 642e 6170 7065 6e64 2861 7761 6974  ted.append(await
+000112e0: 2073 656c 662e 5f63 6f6e 7665 7274 5f66   self._convert_f
+000112f0: 6163 6562 6f6f 6b5f 7374 6f72 795f 7265  acebook_story_re
+00011300: 706c 7928 6d65 7373 6167 6529 290a 0a20  ply(message)).. 
+00011310: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00011320: 696e 7374 616e 6365 286d 6573 7361 6765  instance(message
+00011330: 2c20 6772 6170 6871 6c2e 4d65 7373 6167  , graphql.Messag
+00011340: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00011350: 2020 2020 636f 6e76 6572 7465 642e 6578      converted.ex
+00011360: 7465 6e64 280a 2020 2020 2020 2020 2020  tend(.          
+00011370: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00011380: 7365 6c66 2e5f 636f 6e76 6572 745f 6772  self._convert_gr
+00011390: 6170 6871 6c5f 6d65 7373 6167 6528 0a20  aphql_message(. 
+000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113b0: 2020 2020 2020 2073 6f75 7263 652c 2069         source, i
+000113c0: 6e74 656e 742c 206d 6573 7361 6765 2c20  ntent, message, 
+000113d0: 6465 7465 726d 696e 6973 7469 635f 7265  deterministic_re
+000113e0: 706c 795f 6964 3d64 6574 6572 6d69 6e69  ply_id=determini
+000113f0: 7374 6963 5f72 6570 6c79 5f69 640a 2020  stic_reply_id.  
+00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011410: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00011420: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00011430: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011440: 2020 2020 2020 2020 636f 6e76 6572 7465          converte
+00011450: 642e 6578 7465 6e64 280a 2020 2020 2020  d.extend(.      
+00011460: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00011470: 6169 7420 7365 6c66 2e5f 636f 6e76 6572  ait self._conver
+00011480: 745f 6d71 7474 5f6d 6573 7361 6765 2873  t_mqtt_message(s
+00011490: 6f75 7263 652c 2069 6e74 656e 742c 206d  ource, intent, m
+000114a0: 6573 7361 6765 2c20 7265 706c 795f 746f  essage, reply_to
+000114b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000114c0: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
+000114d0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+000114e0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+000114f0: 6f67 2e65 7863 6570 7469 6f6e 280a 2020  og.exception(.  
+00011500: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00011510: 7272 6f72 2063 6f6e 7665 7274 696e 6720  rror converting 
+00011520: 4661 6365 626f 6f6b 206d 6573 7361 6765  Facebook message
+00011530: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
+00011540: 2020 2020 2020 6d65 7373 6167 652e 6d65        message.me
+00011550: 7373 6167 655f 6964 0a20 2020 2020 2020  ssage_id.       
+00011560: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00011570: 7374 616e 6365 286d 6573 7361 6765 2c20  stance(message, 
+00011580: 6772 6170 6871 6c2e 4d65 7373 6167 6529  graphql.Message)
+00011590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000115a0: 2065 6c73 6520 6d65 7373 6167 652e 6d65   else message.me
+000115b0: 7461 6461 7461 2e69 642c 0a20 2020 2020  tadata.id,.     
+000115c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000115d0: 2020 7265 7475 726e 2063 6f6e 7665 7274    return convert
+000115e0: 6564 0a0a 2020 2020 6173 796e 6320 6465  ed..    async de
+000115f0: 6620 5f63 6f6e 7665 7274 5f66 6163 6562  f _convert_faceb
+00011600: 6f6f 6b5f 7374 6f72 795f 7265 706c 7928  ook_story_reply(
+00011610: 0a20 2020 2020 2020 2073 656c 662c 206d  .        self, m
+00011620: 6573 7361 6765 3a20 6d71 7474 2e4d 6573  essage: mqtt.Mes
+00011630: 7361 6765 207c 2067 7261 7068 716c 2e4d  sage | graphql.M
+00011640: 6573 7361 6765 0a20 2020 2029 202d 3e20  essage.    ) -> 
+00011650: 436f 6e76 6572 7465 644d 6573 7361 6765  ConvertedMessage
+00011660: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00011670: 206d 6573 7361 6765 2e6d 6f6e 7461 6765   message.montage
+00011680: 5f72 6570 6c79 5f64 6174 6120 616e 6420  _reply_data and 
+00011690: 6d65 7373 6167 652e 6d6f 6e74 6167 655f  message.montage_
+000116a0: 7265 706c 795f 6461 7461 2e73 6e69 7070  reply_data.snipp
+000116b0: 6574 0a20 2020 2020 2020 2074 6578 7420  et.        text 
+000116c0: 3d20 6d65 7373 6167 652e 6d6f 6e74 6167  = message.montag
+000116d0: 655f 7265 706c 795f 6461 7461 2e73 6e69  e_reply_data.sni
+000116e0: 7070 6574 0a20 2020 2020 2020 2069 6620  ppet.        if 
+000116f0: 6d65 7373 6167 652e 6d6f 6e74 6167 655f  message.montage_
+00011700: 7265 706c 795f 6461 7461 2e6d 6573 7361  reply_data.messa
+00011710: 6765 5f69 6420 616e 6420 6d65 7373 6167  ge_id and messag
+00011720: 652e 6d6f 6e74 6167 655f 7265 706c 795f  e.montage_reply_
+00011730: 6461 7461 2e6d 6f6e 7461 6765 5f74 6872  data.montage_thr
+00011740: 6561 645f 6964 3a0a 2020 2020 2020 2020  ead_id:.        
+00011750: 2020 2020 6361 7264 5f69 645f 6461 7461      card_id_data
+00011760: 203d 2066 2253 3a5f 4953 433a 7b6d 6573   = f"S:_ISC:{mes
+00011770: 7361 6765 2e6d 6f6e 7461 6765 5f72 6570  sage.montage_rep
+00011780: 6c79 5f64 6174 612e 6d65 7373 6167 655f  ly_data.message_
+00011790: 6964 7d22 0a20 2020 2020 2020 2020 2020  id}".           
+000117a0: 2073 746f 7279 5f75 726c 203d 2028 0a20   story_url = (. 
+000117b0: 2020 2020 2020 2020 2020 2020 2020 2055                 U
+000117c0: 524c 2822 6874 7470 733a 2f2f 7777 772e  RL("https://www.
+000117d0: 6661 6365 626f 6f6b 2e63 6f6d 2f73 746f  facebook.com/sto
+000117e0: 7269 6573 2229 0a20 2020 2020 2020 2020  ries").         
+000117f0: 2020 2020 2020 202f 206d 6573 7361 6765         / message
+00011800: 2e6d 6f6e 7461 6765 5f72 6570 6c79 5f64  .montage_reply_d
+00011810: 6174 612e 6d6f 6e74 6167 655f 7468 7265  ata.montage_thre
+00011820: 6164 5f69 640a 2020 2020 2020 2020 2020  ad_id.          
+00011830: 2020 2020 2020 2f20 6261 7365 3634 2e62        / base64.b
+00011840: 3634 656e 636f 6465 2863 6172 645f 6964  64encode(card_id
+00011850: 5f64 6174 612e 656e 636f 6465 2822 7574  _data.encode("ut
+00011860: 662d 3822 2929 2e64 6563 6f64 6528 2275  f-8")).decode("u
+00011870: 7466 2d38 2229 0a20 2020 2020 2020 2020  tf-8").         
+00011880: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00011890: 2074 6578 7420 2b3d 2066 2220 287b 7374   text += f" ({st
+000118a0: 6f72 795f 7572 6c7d 2922 0a20 2020 2020  ory_url})".     
+000118b0: 2020 2072 6574 7572 6e20 4576 656e 7454     return EventT
+000118c0: 7970 652e 524f 4f4d 5f4d 4553 5341 4745  ype.ROOM_MESSAGE
+000118d0: 2c20 5465 7874 4d65 7373 6167 6545 7665  , TextMessageEve
+000118e0: 6e74 436f 6e74 656e 7428 0a20 2020 2020  ntContent(.     
+000118f0: 2020 2020 2020 206d 7367 7479 7065 3d4d         msgtype=M
+00011900: 6573 7361 6765 5479 7065 2e4e 4f54 4943  essageType.NOTIC
+00011910: 452c 2062 6f64 793d 7465 7874 0a20 2020  E, body=text.   
+00011920: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+00011930: 6320 6465 6620 5f63 6f6e 7665 7274 5f6d  c def _convert_m
+00011940: 7174 745f 6d65 7373 6167 6528 0a20 2020  qtt_message(.   
+00011950: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00011960: 2020 2073 6f75 7263 653a 2075 2e55 7365     source: u.Use
+00011970: 722c 0a20 2020 2020 2020 2069 6e74 656e  r,.        inten
+00011980: 743a 2049 6e74 656e 7441 5049 2c0a 2020  t: IntentAPI,.  
+00011990: 2020 2020 2020 6d65 7373 6167 653a 206d        message: m
+000119a0: 7174 742e 4d65 7373 6167 652c 0a20 2020  qtt.Message,.   
+000119b0: 2020 2020 2072 6570 6c79 5f74 6f3a 206d       reply_to: m
+000119c0: 7174 742e 4d65 7373 6167 6520 7c20 4e6f  qtt.Message | No
+000119d0: 6e65 2c0a 2020 2020 2920 2d3e 206c 6973  ne,.    ) -> lis
+000119e0: 745b 436f 6e76 6572 7465 644d 6573 7361  t[ConvertedMessa
+000119f0: 6765 5d3a 0a20 2020 2020 2020 2063 6f6e  ge]:.        con
+00011a00: 7665 7274 6564 3a20 6c69 7374 5b43 6f6e  verted: list[Con
+00011a10: 7665 7274 6564 4d65 7373 6167 655d 203d  vertedMessage] =
+00011a20: 205b 5d0a 2020 2020 2020 2020 6966 206d   [].        if m
+00011a30: 6573 7361 6765 2e73 7469 636b 6572 3a0a  essage.sticker:.
+00011a40: 2020 2020 2020 2020 2020 2020 636f 6e76              conv
+00011a50: 6572 7465 642e 6170 7065 6e64 280a 2020  erted.append(.  
+00011a60: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00011a70: 6169 7420 7365 6c66 2e5f 636f 6e76 6572  ait self._conver
+00011a80: 745f 6661 6365 626f 6f6b 5f73 7469 636b  t_facebook_stick
+00011a90: 6572 2873 6f75 7263 652c 2069 6e74 656e  er(source, inten
+00011aa0: 742c 206d 6573 7361 6765 2e73 7469 636b  t, message.stick
+00011ab0: 6572 2c20 7265 706c 795f 746f 290a 2020  er, reply_to).  
+00011ac0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00011ad0: 2020 2020 6966 206c 656e 286d 6573 7361      if len(messa
+00011ae0: 6765 2e61 7474 6163 686d 656e 7473 2920  ge.attachments) 
+00011af0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00011b00: 2061 7474 6163 686d 656e 745f 636f 6e74   attachment_cont
+00011b10: 656e 7473 203d 2061 7761 6974 2061 7379  ents = await asy
+00011b20: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+00011b30: 2020 2020 2020 2020 2020 2020 202a 5b0a               *[.
+00011b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b50: 2020 2020 7365 6c66 2e5f 636f 6e76 6572      self._conver
+00011b60: 745f 6661 6365 626f 6f6b 5f61 7474 6163  t_facebook_attac
+00011b70: 686d 656e 7428 0a20 2020 2020 2020 2020  hment(.         
+00011b80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00011b90: 6573 7361 6765 2e6d 6574 6164 6174 612e  essage.metadata.
+00011ba0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00011bb0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00011bc0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00011bd0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00011be0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00011bf0: 2020 2020 2020 2020 2020 2020 6174 7461              atta
+00011c00: 6368 6d65 6e74 2c0a 2020 2020 2020 2020  chment,.        
+00011c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c20: 7265 706c 795f 746f 2c0a 2020 2020 2020  reply_to,.      
+00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c40: 2020 6d65 7373 6167 655f 7465 7874 3d6d    message_text=m
+00011c50: 6573 7361 6765 2e74 6578 742c 0a20 2020  essage.text,.   
+00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c70: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00011c80: 2020 2020 2020 2066 6f72 2061 7474 6163         for attac
+00011c90: 686d 656e 7420 696e 206d 6573 7361 6765  hment in message
+00011ca0: 2e61 7474 6163 686d 656e 7473 0a20 2020  .attachments.   
+00011cb0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+00011cc0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00011cd0: 2020 2020 2020 2020 2063 6f6e 7665 7274           convert
+00011ce0: 6564 202b 3d20 5b63 2066 6f72 2063 2069  ed += [c for c i
+00011cf0: 6e20 6174 7461 6368 6d65 6e74 5f63 6f6e  n attachment_con
+00011d00: 7465 6e74 7320 6966 2063 5d0a 2020 2020  tents if c].    
+00011d10: 2020 2020 6966 206d 6573 7361 6765 2e74      if message.t
+00011d20: 6578 743a 0a20 2020 2020 2020 2020 2020  ext:.           
+00011d30: 2063 6f6e 7665 7274 6564 2e61 7070 656e   converted.appen
+00011d40: 6428 6177 6169 7420 7365 6c66 2e5f 636f  d(await self._co
+00011d50: 6e76 6572 745f 6661 6365 626f 6f6b 5f74  nvert_facebook_t
+00011d60: 6578 7428 6d65 7373 6167 652c 2072 6570  ext(message, rep
+00011d70: 6c79 5f74 6f29 290a 2020 2020 2020 2020  ly_to)).        
+00011d80: 7265 7475 726e 2063 6f6e 7665 7274 6564  return converted
+00011d90: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00011da0: 5f63 6f6e 7665 7274 5f65 7874 656e 7369  _convert_extensi
+00011db0: 626c 655f 6d65 6469 6128 0a20 2020 2020  ble_media(.     
+00011dc0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00011dd0: 2073 6f75 7263 653a 2075 2e55 7365 722c   source: u.User,
+00011de0: 0a20 2020 2020 2020 2069 6e74 656e 743a  .        intent:
+00011df0: 2049 6e74 656e 7441 5049 2c0a 2020 2020   IntentAPI,.    
+00011e00: 2020 2020 7361 3a20 6772 6170 6871 6c2e      sa: graphql.
+00011e10: 5374 6f72 7941 7474 6163 686d 656e 742c  StoryAttachment,
+00011e20: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
+00011e30: 5f74 6578 743a 2073 7472 207c 204e 6f6e  _text: str | Non
+00011e40: 652c 0a20 2020 2029 202d 3e20 4d65 7373  e,.    ) -> Mess
+00011e50: 6167 6545 7665 6e74 436f 6e74 656e 7420  ageEventContent 
+00011e60: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00011e70: 6966 2073 612e 7461 7267 6574 2061 6e64  if sa.target and
+00011e80: 2073 612e 7461 7267 6574 2e74 7970 656e   sa.target.typen
+00011e90: 616d 6520 3d3d 2067 7261 7068 716c 2e41  ame == graphql.A
+00011ea0: 7474 6163 686d 656e 7454 7970 652e 4558  ttachmentType.EX
+00011eb0: 5445 524e 414c 5f55 524c 3a0a 2020 2020  TERNAL_URL:.    
+00011ec0: 2020 2020 2020 2020 7572 6c20 3d20 7374          url = st
+00011ed0: 7228 7361 2e63 6c65 616e 5f75 726c 290a  r(sa.clean_url).
+00011ee0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00011ef0: 6573 7361 6765 5f74 6578 7420 6973 206e  essage_text is n
+00011f00: 6f74 204e 6f6e 6520 616e 6420 7572 6c20  ot None and url 
+00011f10: 696e 206d 6573 7361 6765 5f74 6578 743a  in message_text:
+00011f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011f30: 2023 2055 524c 2069 7320 7072 6573 656e   # URL is presen
+00011f40: 7420 696e 206d 6573 7361 6765 2c20 646f  t in message, do
+00011f50: 6e27 7420 7265 706f 7374 0a20 2020 2020  n't repost.     
+00011f60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00011f70: 6e20 4e6f 6e65 0a20 2020 2020 2020 2020  n None.         
+00011f80: 2020 2065 7363 6170 6564 5f75 726c 203d     escaped_url =
+00011f90: 2065 7363 6170 6528 7572 6c29 0a20 2020   escape(url).   
+00011fa0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00011fb0: 5465 7874 4d65 7373 6167 6545 7665 6e74  TextMessageEvent
+00011fc0: 436f 6e74 656e 7428 0a20 2020 2020 2020  Content(.       
+00011fd0: 2020 2020 2020 2020 206d 7367 7479 7065           msgtype
+00011fe0: 3d4d 6573 7361 6765 5479 7065 2e54 4558  =MessageType.TEX
+00011ff0: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
+00012000: 2020 2066 6f72 6d61 743d 466f 726d 6174     format=Format
+00012010: 2e48 544d 4c2c 0a20 2020 2020 2020 2020  .HTML,.         
+00012020: 2020 2020 2020 2062 6f64 793d 7374 7228         body=str(
+00012030: 7361 2e63 6c65 616e 5f75 726c 292c 0a20  sa.clean_url),. 
+00012040: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012050: 6f72 6d61 7474 6564 5f62 6f64 793d 6627  ormatted_body=f'
+00012060: 3c61 2068 7265 663d 227b 6573 6361 7065  <a href="{escape
+00012070: 645f 7572 6c7d 223e 7b65 7363 6170 6564  d_url}">{escaped
+00012080: 5f75 726c 7d3c 2f61 3e27 2c0a 2020 2020  _url}</a>',.    
+00012090: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000120a0: 2020 656c 6966 2028 0a20 2020 2020 2020    elif (.       
+000120b0: 2020 2020 2073 612e 6d65 6469 610a 2020       sa.media.  
+000120c0: 2020 2020 2020 2020 2020 616e 6420 7361            and sa
+000120d0: 2e6d 6564 6961 2e74 7970 656e 616d 655f  .media.typename_
+000120e0: 7374 7220 696e 2028 2249 6d61 6765 222c  str in ("Image",
+000120f0: 2022 5669 6465 6f22 290a 2020 2020 2020   "Video").      
+00012100: 2020 2020 2020 616e 6420 2873 612e 6d65        and (sa.me
+00012110: 6469 612e 706c 6179 6162 6c65 5f75 726c  dia.playable_url
+00012120: 206f 7220 7361 2e6d 6564 6961 2e69 6d61   or sa.media.ima
+00012130: 6765 5f6e 6174 7572 616c 290a 2020 2020  ge_natural).    
+00012140: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00012150: 2020 2069 6620 7361 2e6d 6564 6961 2e74     if sa.media.t
+00012160: 7970 656e 616d 655f 7374 7220 3d3d 2022  ypename_str == "
+00012170: 5669 6465 6f22 3a0a 2020 2020 2020 2020  Video":.        
+00012180: 2020 2020 2020 2020 6d73 6774 7970 6520          msgtype 
+00012190: 3d20 4d65 7373 6167 6554 7970 652e 5649  = MessageType.VI
+000121a0: 4445 4f0a 2020 2020 2020 2020 2020 2020  DEO.            
+000121b0: 2020 2020 696e 666f 203d 2056 6964 656f      info = Video
+000121c0: 496e 666f 2829 0a20 2020 2020 2020 2020  Info().         
+000121d0: 2020 2020 2020 2075 726c 203d 2073 612e         url = sa.
+000121e0: 6d65 6469 612e 706c 6179 6162 6c65 5f75  media.playable_u
+000121f0: 726c 0a20 2020 2020 2020 2020 2020 2065  rl.            e
+00012200: 6c69 6620 7361 2e6d 6564 6961 2e74 7970  lif sa.media.typ
+00012210: 656e 616d 655f 7374 7220 3d3d 2022 496d  ename_str == "Im
+00012220: 6167 6522 3a0a 2020 2020 2020 2020 2020  age":.          
+00012230: 2020 2020 2020 6d73 6774 7970 6520 3d20        msgtype = 
+00012240: 4d65 7373 6167 6554 7970 652e 494d 4147  MessageType.IMAG
+00012250: 450a 2020 2020 2020 2020 2020 2020 2020  E.              
+00012260: 2020 7572 6c20 3d20 7361 2e6d 6564 6961    url = sa.media
+00012270: 2e69 6d61 6765 5f6e 6174 7572 616c 2e75  .image_natural.u
+00012280: 7269 0a20 2020 2020 2020 2020 2020 2020  ri.             
+00012290: 2020 2069 6e66 6f20 3d20 496d 6167 6549     info = ImageI
+000122a0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+000122b0: 2020 2020 2020 2020 2077 6964 7468 3d73           width=s
+000122c0: 612e 6d65 6469 612e 696d 6167 655f 6e61  a.media.image_na
+000122d0: 7475 7261 6c2e 7769 6474 682c 0a20 2020  tural.width,.   
+000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122f0: 2068 6569 6768 743d 7361 2e6d 6564 6961   height=sa.media
+00012300: 2e69 6d61 6765 5f6e 6174 7572 616c 2e68  .image_natural.h
+00012310: 6569 6768 742c 0a20 2020 2020 2020 2020  eight,.         
+00012320: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012330: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012340: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012350: 2052 756e 7469 6d65 4572 726f 7228 2255   RuntimeError("U
+00012360: 6e65 7870 6563 7465 6420 7479 7065 6e61  nexpected typena
+00012370: 6d65 5f73 7472 2069 6e20 6578 7465 6e73  me_str in extens
+00012380: 6962 6c65 206d 6564 6961 2068 616e 646c  ible media handl
+00012390: 6572 2229 0a20 2020 2020 2020 2020 2020  er").           
+000123a0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000123b0: 2020 2020 2020 6d78 632c 2061 6464 6974        mxc, addit
+000123c0: 696f 6e61 6c5f 696e 666f 2c20 6465 6372  ional_info, decr
+000123d0: 7970 7469 6f6e 5f69 6e66 6f20 3d20 6177  yption_info = aw
+000123e0: 6169 7420 7365 6c66 2e5f 7265 7570 6c6f  ait self._reuplo
+000123f0: 6164 5f66 625f 6669 6c65 280a 2020 2020  ad_fb_file(.    
+00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012410: 7572 6c2c 2073 6f75 7263 652c 2069 6e74  url, source, int
+00012420: 656e 742c 2065 6e63 7279 7074 3d73 656c  ent, encrypt=sel
+00012430: 662e 656e 6372 7970 7465 642c 2066 696e  f.encrypted, fin
+00012440: 645f 7369 7a65 3d46 616c 7365 0a20 2020  d_size=False.   
+00012450: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00012460: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00012470: 7420 5661 6c75 6545 7272 6f72 2061 7320  t ValueError as 
+00012480: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00012490: 2020 2073 656c 662e 6c6f 672e 6465 6275     self.log.debu
+000124a0: 6728 2246 6169 6c65 6420 746f 2072 6575  g("Failed to reu
+000124b0: 706c 6f61 6420 7374 6f72 7920 6174 7461  pload story atta
+000124c0: 6368 6d65 6e74 206d 6564 6961 222c 2065  chment media", e
+000124d0: 7863 5f69 6e66 6f3d 5472 7565 290a 2020  xc_info=True).  
+000124e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000124f0: 7475 726e 2054 6578 744d 6573 7361 6765  turn TextMessage
+00012500: 4576 656e 7443 6f6e 7465 6e74 280a 2020  EventContent(.  
+00012510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012520: 2020 6d73 6774 7970 653d 4d65 7373 6167    msgtype=Messag
+00012530: 6554 7970 652e 4e4f 5449 4345 2c0a 2020  eType.NOTICE,.  
+00012540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012550: 2020 626f 6479 3d66 227b 657d 5c6e 7b73    body=f"{e}\n{s
+00012560: 612e 7572 6c7d 222c 0a20 2020 2020 2020  a.url}",.       
+00012570: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00012580: 6572 6e61 6c5f 7572 6c3d 7361 2e75 726c  ernal_url=sa.url
+00012590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000125a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000125b0: 696e 666f 2e73 697a 6520 3d20 6164 6469  info.size = addi
+000125c0: 7469 6f6e 616c 5f69 6e66 6f2e 7369 7a65  tional_info.size
+000125d0: 0a20 2020 2020 2020 2020 2020 2069 6e66  .            inf
+000125e0: 6f2e 6d69 6d65 7479 7065 203d 2061 6464  o.mimetype = add
+000125f0: 6974 696f 6e61 6c5f 696e 666f 2e6d 696d  itional_info.mim
+00012600: 6574 7970 650a 2020 2020 2020 2020 2020  etype.          
+00012610: 2020 7469 746c 6520 3d20 7361 2e74 6974    title = sa.tit
+00012620: 6c65 206f 7220 7361 2e6d 6564 6961 2e74  le or sa.media.t
+00012630: 7970 656e 616d 655f 7374 720a 2020 2020  ypename_str.    
+00012640: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00012650: 203d 2066 227b 7469 746c 657d 7b6d 696d   = f"{title}{mim
+00012660: 6574 7970 6573 2e67 7565 7373 5f65 7874  etypes.guess_ext
+00012670: 656e 7369 6f6e 2869 6e66 6f2e 6d69 6d65  ension(info.mime
+00012680: 7479 7065 297d 220a 2020 2020 2020 2020  type)}".        
+00012690: 2020 2020 636f 6e74 656e 7420 3d20 4d65      content = Me
+000126a0: 6469 614d 6573 7361 6765 4576 656e 7443  diaMessageEventC
+000126b0: 6f6e 7465 6e74 280a 2020 2020 2020 2020  ontent(.        
+000126c0: 2020 2020 2020 2020 7572 6c3d 6d78 632c          url=mxc,
+000126d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000126e0: 2066 696c 653d 6465 6372 7970 7469 6f6e   file=decryption
+000126f0: 5f69 6e66 6f2c 0a20 2020 2020 2020 2020  _info,.         
+00012700: 2020 2020 2020 206d 7367 7479 7065 3d6d         msgtype=m
+00012710: 7367 7479 7065 2c0a 2020 2020 2020 2020  sgtype,.        
+00012720: 2020 2020 2020 2020 626f 6479 3d66 696c          body=fil
+00012730: 656e 616d 652c 0a20 2020 2020 2020 2020  ename,.         
+00012740: 2020 2020 2020 2069 6e66 6f3d 696e 666f         info=info
+00012750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012760: 2020 6578 7465 726e 616c 5f75 726c 3d73    external_url=s
+00012770: 612e 7572 6c2c 0a20 2020 2020 2020 2020  a.url,.         
+00012780: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00012790: 2023 2054 4f44 4f20 6f6e 6c79 2064 6f20   # TODO only do 
+000127a0: 7468 6973 2069 6620 6361 7074 696f 6e73  this if captions
+000127b0: 2061 7265 2065 6e61 626c 6564 2069 6e20   are enabled in 
+000127c0: 7468 6520 636f 6e66 6967 0a20 2020 2020  the config.     
+000127d0: 2020 2020 2020 2069 6620 7361 2e64 6573         if sa.des
+000127e0: 6372 6970 7469 6f6e 2061 6e64 2073 612e  cription and sa.
+000127f0: 6465 7363 7269 7074 696f 6e2e 7465 7874  description.text
+00012800: 2021 3d20 226d 736e 6772 2e63 6f6d 223a   != "msngr.com":
+00012810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012820: 2063 6f6e 7465 6e74 5b22 6669 6c65 6e61   content["filena
+00012830: 6d65 225d 203d 2063 6f6e 7465 6e74 2e62  me"] = content.b
+00012840: 6f64 790a 2020 2020 2020 2020 2020 2020  ody.            
+00012850: 2020 2020 636f 6e74 656e 742e 626f 6479      content.body
+00012860: 203d 2073 612e 6465 7363 7269 7074 696f   = sa.descriptio
+00012870: 6e2e 7465 7874 0a20 2020 2020 2020 2020  n.text.         
+00012880: 2020 2020 2020 2069 6620 7361 2e75 726c         if sa.url
+00012890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000128a0: 2020 2020 2020 636f 6e74 656e 742e 626f        content.bo
+000128b0: 6479 202b 3d20 6622 5c6e 5c6e 7b73 612e  dy += f"\n\n{sa.
+000128c0: 7572 6c7d 220a 2020 2020 2020 2020 2020  url}".          
+000128d0: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
+000128e0: 745b 2266 6f72 6d61 7422 5d20 3d20 7374  t["format"] = st
+000128f0: 7228 466f 726d 6174 2e48 544d 4c29 0a20  r(Format.HTML). 
+00012900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012910: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
+00012920: 6174 7465 645f 626f 6479 225d 203d 2028  atted_body"] = (
+00012930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012940: 2020 2020 2020 2020 2066 223c 703e 7b65           f"<p>{e
+00012950: 7363 6170 6528 7361 2e64 6573 6372 6970  scape(sa.descrip
+00012960: 7469 6f6e 2e74 6578 7429 7d3c 2f70 3e22  tion.text)}</p>"
+00012970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012980: 2020 2020 2020 2020 2066 223c 703e 3c61           f"<p><a
+00012990: 2068 7265 663d 277b 7361 2e75 726c 7d27   href='{sa.url}'
+000129a0: 3e4f 7065 6e20 6578 7465 726e 616c 206c  >Open external l
+000129b0: 696e 6b3c 2f61 3e3c 2f70 3e22 0a20 2020  ink</a></p>".   
+000129c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129d0: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
+000129e0: 6574 7572 6e20 636f 6e74 656e 740a 2020  eturn content.  
+000129f0: 2020 2020 2020 656c 6966 2073 612e 7572        elif sa.ur
+00012a00: 6c20 6f72 2073 612e 7469 746c 6520 6f72  l or sa.title or
+00012a10: 2028 7361 2e64 6573 6372 6970 7469 6f6e   (sa.description
+00012a20: 2061 6e64 2073 612e 6465 7363 7269 7074   and sa.descript
+00012a30: 696f 6e2e 7465 7874 2920 6f72 2073 612e  ion.text) or sa.
+00012a40: 6163 7469 6f6e 5f6c 696e 6b73 3a0a 2020  action_links:.  
+00012a50: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00012a60: 7374 7228 7361 2e63 6c65 616e 5f75 726c  str(sa.clean_url
+00012a70: 2920 6966 2073 612e 7572 6c20 656c 7365  ) if sa.url else
+00012a80: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00012a90: 2020 6966 206e 6f74 2075 726c 3a0a 2020    if not url:.  
+00012aa0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+00012ab0: 6c20 3d20 7374 7228 7361 2e78 6d61 5f74  l = str(sa.xma_t
+00012ac0: 706c 5f75 726c 290a 2020 2020 2020 2020  pl_url).        
+00012ad0: 2020 2020 6966 206d 6573 7361 6765 5f74      if message_t
+00012ae0: 6578 7420 616e 6420 2828 7572 6c20 616e  ext and ((url an
+00012af0: 6420 7572 6c20 696e 206d 6573 7361 6765  d url in message
+00012b00: 5f74 6578 7429 206f 7220 7361 2e74 6974  _text) or sa.tit
+00012b10: 6c65 2069 6e20 6d65 7373 6167 655f 7465  le in message_te
+00012b20: 7874 293a 0a20 2020 2020 2020 2020 2020  xt):.           
+00012b30: 2020 2020 2023 2055 524c 2069 7320 7072       # URL is pr
+00012b40: 6573 656e 7420 696e 206d 6573 7361 6765  esent in message
+00012b50: 2c20 646f 6e27 7420 7265 706f 7374 0a20  , don't repost. 
+00012b60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012b70: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+00012b80: 2020 2020 2020 2074 6578 745f 7061 7274         text_part
+00012b90: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+00012ba0: 2020 2068 746d 6c5f 7061 7274 7320 3d20     html_parts = 
+00012bb0: 5b5d 0a20 2020 2020 2020 2020 2020 2069  [].            i
+00012bc0: 6620 7361 2e74 6974 6c65 3a0a 2020 2020  f sa.title:.    
+00012bd0: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00012be0: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
+00012bf0: 2a2a 7b73 612e 7469 746c 657d 2a2a 2229  **{sa.title}**")
+00012c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c10: 2068 746d 6c5f 7061 7274 732e 6170 7065   html_parts.appe
+00012c20: 6e64 2866 223c 703e 3c73 7472 6f6e 673e  nd(f"<p><strong>
+00012c30: 7b65 7363 6170 6528 7361 2e74 6974 6c65  {escape(sa.title
+00012c40: 297d 3c2f 7374 726f 6e67 3e3c 2f70 3e22  )}</strong></p>"
+00012c50: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00012c60: 2073 612e 6465 7363 7269 7074 696f 6e20   sa.description 
+00012c70: 616e 6420 7361 2e64 6573 6372 6970 7469  and sa.descripti
+00012c80: 6f6e 2e74 6578 7420 616e 6420 7361 2e64  on.text and sa.d
+00012c90: 6573 6372 6970 7469 6f6e 2e74 6578 7420  escription.text 
+00012ca0: 213d 2022 6d73 6e67 722e 636f 6d22 3a0a  != "msngr.com":.
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 7465 7874 5f70 6172 7473 2e61 7070 656e  text_parts.appen
+00012cd0: 6428 7361 2e64 6573 6372 6970 7469 6f6e  d(sa.description
+00012ce0: 2e74 6578 7429 0a20 2020 2020 2020 2020  .text).         
+00012cf0: 2020 2020 2020 2068 746d 6c5f 7061 7274         html_part
+00012d00: 732e 6170 7065 6e64 2866 223c 703e 7b65  s.append(f"<p>{e
+00012d10: 7363 6170 6528 7361 2e64 6573 6372 6970  scape(sa.descrip
+00012d20: 7469 6f6e 2e74 6578 7429 7d3c 2f70 3e22  tion.text)}</p>"
+00012d30: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00012d40: 2075 726c 3a0a 2020 2020 2020 2020 2020   url:.          
+00012d50: 2020 2020 2020 7465 7874 5f70 6172 7473        text_parts
+00012d60: 2e61 7070 656e 6428 7572 6c29 0a20 2020  .append(url).   
+00012d70: 2020 2020 2020 2020 2020 2020 2068 746d               htm
+00012d80: 6c5f 7061 7274 732e 6170 7065 6e64 2866  l_parts.append(f
+00012d90: 223c 703e 7b65 7363 6170 6528 7572 6c29  "<p>{escape(url)
+00012da0: 7d3c 2f70 3e22 290a 2020 2020 2020 2020  }</p>").        
+00012db0: 2020 2020 656c 6966 2073 612e 6163 7469      elif sa.acti
+00012dc0: 6f6e 5f6c 696e 6b73 3a0a 2020 2020 2020  on_links:.      
+00012dd0: 2020 2020 2020 2020 2020 7572 6c73 203d            urls =
+00012de0: 205b 6974 656d 2e75 726c 2066 6f72 2069   [item.url for i
+00012df0: 7465 6d20 696e 2073 612e 6163 7469 6f6e  tem in sa.action
+00012e00: 5f6c 696e 6b73 2069 6620 6974 656d 2e75  _links if item.u
+00012e10: 726c 5d0a 2020 2020 2020 2020 2020 2020  rl].            
+00012e20: 2020 2020 6966 206c 656e 2875 726c 7329      if len(urls)
+00012e30: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00012e40: 2020 2020 2020 2020 2020 7361 2e75 726c            sa.url
+00012e50: 203d 2075 726c 735b 305d 0a20 2020 2020   = urls[0].     
+00012e60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00012e70: 6578 745f 7061 7274 732e 6170 7065 6e64  ext_parts.append
+00012e80: 2822 202d 2022 2e6a 6f69 6e28 7572 6c73  (" - ".join(urls
+00012e90: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00012ea0: 2020 2020 2020 2068 746d 6c5f 6163 7469         html_acti
+00012eb0: 6f6e 5f6c 696e 6b73 203d 205b 0a20 2020  on_links = [.   
+00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ed0: 2020 2020 2066 2222 223c 6120 6872 6566       f"""<a href
+00012ee0: 3d22 7b69 7465 6d2e 7572 6c7d 223e 7b69  ="{item.url}">{i
+00012ef0: 7465 6d2e 7469 746c 657d 3c2f 613e 2222  tem.title}</a>""
+00012f00: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00012f10: 2020 2020 2020 2020 2020 666f 7220 6974            for it
+00012f20: 656d 2069 6e20 7361 2e61 6374 696f 6e5f  em in sa.action_
+00012f30: 6c69 6e6b 730a 2020 2020 2020 2020 2020  links.          
+00012f40: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00012f50: 2069 7465 6d2e 7572 6c0a 2020 2020 2020   item.url.      
+00012f60: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f80: 2020 2020 6874 6d6c 5f70 6172 7473 2e61      html_parts.a
+00012f90: 7070 656e 6428 6622 2222 3c70 3e7b 2220  ppend(f"""<p>{" 
+00012fa0: 2d20 222e 6a6f 696e 2868 746d 6c5f 6163  - ".join(html_ac
+00012fb0: 7469 6f6e 5f6c 696e 6b73 297d 3c2f 703e  tion_links)}</p>
+00012fc0: 2222 2229 0a20 2020 2020 2020 2020 2020  """).           
+00012fd0: 2072 6574 7572 6e20 5465 7874 4d65 7373   return TextMess
+00012fe0: 6167 6545 7665 6e74 436f 6e74 656e 7428  ageEventContent(
+00012ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013000: 206d 7367 7479 7065 3d4d 6573 7361 6765   msgtype=Message
+00013010: 5479 7065 2e54 4558 542c 0a20 2020 2020  Type.TEXT,.     
+00013020: 2020 2020 2020 2020 2020 2062 6f64 793d             body=
+00013030: 225c 6e5c 6e22 2e6a 6f69 6e28 7465 7874  "\n\n".join(text
+00013040: 5f70 6172 7473 292c 0a20 2020 2020 2020  _parts),.       
+00013050: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+00013060: 466f 726d 6174 2e48 544d 4c2c 0a20 2020  Format.HTML,.   
+00013070: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00013080: 6d61 7474 6564 5f62 6f64 793d 2222 2e6a  matted_body="".j
+00013090: 6f69 6e28 6874 6d6c 5f70 6172 7473 292c  oin(html_parts),
+000130a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000130b0: 2065 7874 6572 6e61 6c5f 7572 6c3d 7361   external_url=sa
+000130c0: 2e75 726c 2c0a 2020 2020 2020 2020 2020  .url,.          
+000130d0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+000130e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000130f0: 6c66 2e6c 6f67 2e64 6562 7567 2822 556e  lf.log.debug("Un
+00013100: 6861 6e64 6c65 6420 7374 6f72 7920 6174  handled story at
+00013110: 7461 6368 6d65 6e74 3a20 2573 222c 2073  tachment: %s", s
+00013120: 612e 7365 7269 616c 697a 6528 2929 0a20  a.serialize()). 
+00013130: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013140: 6e20 4e6f 6e65 0a0a 2020 2020 6173 796e  n None..    asyn
+00013150: 6320 6465 6620 5f63 6f6e 7665 7274 5f6d  c def _convert_m
+00013160: 7174 745f 6174 7461 6368 6d65 6e74 280a  qtt_attachment(.
+00013170: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00013180: 2020 2020 2020 6d73 675f 6964 3a20 7374        msg_id: st
+00013190: 722c 0a20 2020 2020 2020 2073 6f75 7263  r,.        sourc
+000131a0: 653a 2075 2e55 7365 722c 0a20 2020 2020  e: u.User,.     
+000131b0: 2020 2069 6e74 656e 743a 2049 6e74 656e     intent: Inten
+000131c0: 7441 5049 2c0a 2020 2020 2020 2020 6174  tAPI,.        at
+000131d0: 7461 6368 6d65 6e74 3a20 6d71 7474 2e41  tachment: mqtt.A
+000131e0: 7474 6163 686d 656e 742c 0a20 2020 2020  ttachment,.     
+000131f0: 2020 206d 6573 7361 6765 5f74 6578 743a     message_text:
+00013200: 2073 7472 2c0a 2020 2020 2920 2d3e 204d   str,.    ) -> M
+00013210: 6573 7361 6765 4576 656e 7443 6f6e 7465  essageEventConte
+00013220: 6e74 207c 204e 6f6e 653a 0a20 2020 2020  nt | None:.     
+00013230: 2020 2066 696c 656e 616d 6520 3d20 6174     filename = at
+00013240: 7461 6368 6d65 6e74 2e66 696c 655f 6e61  tachment.file_na
+00013250: 6d65 0a20 2020 2020 2020 2069 6620 6174  me.        if at
+00013260: 7461 6368 6d65 6e74 2e6d 696d 655f 7479  tachment.mime_ty
+00013270: 7065 2061 6e64 2066 696c 656e 616d 6520  pe and filename 
+00013280: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00013290: 222e 2220 6e6f 7420 696e 2066 696c 656e  "." not in filen
+000132a0: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+000132b0: 2066 696c 656e 616d 6520 2b3d 206d 696d   filename += mim
+000132c0: 6574 7970 6573 2e67 7565 7373 5f65 7874  etypes.guess_ext
+000132d0: 656e 7369 6f6e 2861 7474 6163 686d 656e  ension(attachmen
+000132e0: 742e 6d69 6d65 5f74 7970 6529 0a20 2020  t.mime_type).   
+000132f0: 2020 2020 2072 6566 6572 6572 203d 2022       referer = "
+00013300: 756e 6b6e 6f77 6e22 0a20 2020 2020 2020  unknown".       
+00013310: 2076 6f69 6365 5f6d 6573 7361 6765 203d   voice_message =
+00013320: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
+00013330: 6620 6174 7461 6368 6d65 6e74 2e65 7874  f attachment.ext
+00013340: 656e 7369 626c 655f 6d65 6469 613a 0a20  ensible_media:. 
+00013350: 2020 2020 2020 2020 2020 2073 6120 3d20             sa = 
+00013360: 6174 7461 6368 6d65 6e74 2e70 6172 7365  attachment.parse
+00013370: 5f65 7874 656e 7369 626c 6528 292e 7374  _extensible().st
+00013380: 6f72 795f 6174 7461 6368 6d65 6e74 0a20  ory_attachment. 
+00013390: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000133a0: 6c6f 672e 7472 6163 6528 2253 746f 7279  log.trace("Story
+000133b0: 2061 7474 6163 686d 656e 7420 2573 2063   attachment %s c
+000133c0: 6f6e 7465 6e74 3a20 2573 222c 2061 7474  ontent: %s", att
+000133d0: 6163 686d 656e 742e 6d65 6469 615f 6964  achment.media_id
+000133e0: 5f73 7472 2c20 7361 290a 2020 2020 2020  _str, sa).      
+000133f0: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
+00013400: 6974 2073 656c 662e 5f63 6f6e 7665 7274  it self._convert
+00013410: 5f65 7874 656e 7369 626c 655f 6d65 6469  _extensible_medi
+00013420: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+00013430: 2020 2073 6f75 7263 652c 2069 6e74 656e     source, inten
+00013440: 742c 2073 612c 206d 6573 7361 6765 5f74  t, sa, message_t
+00013450: 6578 743d 6d65 7373 6167 655f 7465 7874  ext=message_text
+00013460: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00013470: 2020 2020 2020 2065 6c69 6620 6174 7461         elif atta
+00013480: 6368 6d65 6e74 2e76 6964 656f 5f69 6e66  chment.video_inf
+00013490: 6f3a 0a20 2020 2020 2020 2020 2020 206d  o:.            m
+000134a0: 7367 7479 7065 203d 204d 6573 7361 6765  sgtype = Message
+000134b0: 5479 7065 2e56 4944 454f 0a20 2020 2020  Type.VIDEO.     
+000134c0: 2020 2020 2020 2075 726c 203d 2061 7474         url = att
+000134d0: 6163 686d 656e 742e 7669 6465 6f5f 696e  achment.video_in
+000134e0: 666f 2e64 6f77 6e6c 6f61 645f 7572 6c0a  fo.download_url.
+000134f0: 2020 2020 2020 2020 2020 2020 696e 666f              info
+00013500: 203d 2056 6964 656f 496e 666f 280a 2020   = VideoInfo(.  
+00013510: 2020 2020 2020 2020 2020 2020 2020 6475                du
+00013520: 7261 7469 6f6e 3d61 7474 6163 686d 656e  ration=attachmen
+00013530: 742e 7669 6465 6f5f 696e 666f 2e64 7572  t.video_info.dur
+00013540: 6174 696f 6e5f 6d73 2c0a 2020 2020 2020  ation_ms,.      
+00013550: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+00013560: 6174 7461 6368 6d65 6e74 2e76 6964 656f  attachment.video
+00013570: 5f69 6e66 6f2e 6f72 6967 696e 616c 5f77  _info.original_w
+00013580: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
+00013590: 2020 2020 2020 6865 6967 6874 3d61 7474        height=att
+000135a0: 6163 686d 656e 742e 7669 6465 6f5f 696e  achment.video_in
+000135b0: 666f 2e6f 7269 6769 6e61 6c5f 6865 6967  fo.original_heig
+000135c0: 6874 2c0a 2020 2020 2020 2020 2020 2020  ht,.            
+000135d0: 290a 2020 2020 2020 2020 656c 6966 2061  ).        elif a
+000135e0: 7474 6163 686d 656e 742e 6175 6469 6f5f  ttachment.audio_
+000135f0: 696e 666f 3a0a 2020 2020 2020 2020 2020  info:.          
+00013600: 2020 6d73 6774 7970 6520 3d20 4d65 7373    msgtype = Mess
+00013610: 6167 6554 7970 652e 4155 4449 4f0a 2020  ageType.AUDIO.  
+00013620: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00013630: 6174 7461 6368 6d65 6e74 2e61 7564 696f  attachment.audio
+00013640: 5f69 6e66 6f2e 7572 6c0a 2020 2020 2020  _info.url.      
+00013650: 2020 2020 2020 696e 666f 203d 2041 7564        info = Aud
+00013660: 696f 496e 666f 2864 7572 6174 696f 6e3d  ioInfo(duration=
+00013670: 6174 7461 6368 6d65 6e74 2e61 7564 696f  attachment.audio
+00013680: 5f69 6e66 6f2e 6475 7261 7469 6f6e 5f6d  _info.duration_m
+00013690: 7329 0a20 2020 2020 2020 2020 2020 2076  s).            v
+000136a0: 6f69 6365 5f6d 6573 7361 6765 203d 2054  oice_message = T
+000136b0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+000136c0: 6174 7461 6368 6d65 6e74 2e6d 696d 655f  attachment.mime_
+000136d0: 7479 7065 203d 204e 6f6e 650a 2020 2020  type = None.    
+000136e0: 2020 2020 656c 6966 2061 7474 6163 686d      elif attachm
+000136f0: 656e 742e 696d 6167 655f 696e 666f 3a0a  ent.image_info:.
+00013700: 2020 2020 2020 2020 2020 2020 7265 6665              refe
+00013710: 7265 7220 3d20 226d 6573 7365 6e67 6572  rer = "messenger
+00013720: 5f74 6872 6561 645f 7068 6f74 6f22 0a20  _thread_photo". 
+00013730: 2020 2020 2020 2020 2020 206d 7367 7479             msgty
+00013740: 7065 203d 204d 6573 7361 6765 5479 7065  pe = MessageType
+00013750: 2e49 4d41 4745 0a20 2020 2020 2020 2020  .IMAGE.         
+00013760: 2020 2069 6e66 6f20 3d20 496d 6167 6549     info = ImageI
+00013770: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00013780: 2020 2020 2077 6964 7468 3d61 7474 6163       width=attac
+00013790: 686d 656e 742e 696d 6167 655f 696e 666f  hment.image_info
+000137a0: 2e6f 7269 6769 6e61 6c5f 7769 6474 682c  .original_width,
+000137b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000137c0: 2068 6569 6768 743d 6174 7461 6368 6d65   height=attachme
+000137d0: 6e74 2e69 6d61 6765 5f69 6e66 6f2e 6f72  nt.image_info.or
+000137e0: 6967 696e 616c 5f68 6569 6768 742c 0a20  iginal_height,. 
+000137f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00013800: 2020 2020 2020 2020 2069 6620 6174 7461           if atta
+00013810: 6368 6d65 6e74 2e69 6d61 6765 5f69 6e66  chment.image_inf
+00013820: 6f2e 616e 696d 6174 6564 5f75 7269 5f6d  o.animated_uri_m
+00013830: 6170 3a0a 2020 2020 2020 2020 2020 2020  ap:.            
+00013840: 2020 2020 7572 6c20 3d20 6c69 7374 2861      url = list(a
+00013850: 7474 6163 686d 656e 742e 696d 6167 655f  ttachment.image_
+00013860: 696e 666f 2e61 6e69 6d61 7465 645f 7572  info.animated_ur
+00013870: 695f 6d61 702e 7661 6c75 6573 2829 295b  i_map.values())[
+00013880: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00013890: 2020 2023 204f 7665 7272 6964 6520 7468     # Override th
+000138a0: 6520 6d69 6d65 2074 7970 6520 6f72 2064  e mime type or d
+000138b0: 6574 6563 7420 6672 6f6d 2066 696c 650a  etect from file.
+000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138d0: 6174 7461 6368 6d65 6e74 2e6d 696d 655f  attachment.mime_
+000138e0: 7479 7065 203d 207b 0a20 2020 2020 2020  type = {.       
+000138f0: 2020 2020 2020 2020 2020 2020 2022 7765               "we
+00013900: 6270 223a 2022 696d 6167 652f 7765 6270  bp": "image/webp
+00013910: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00013920: 2020 2020 2020 2022 6769 6622 3a20 2269         "gif": "i
+00013930: 6d61 6765 2f67 6966 222c 0a20 2020 2020  mage/gif",.     
+00013940: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013950: 706e 6722 3a20 2269 6d61 6765 2f70 6e67  png": "image/png
+00013960: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00013970: 2020 207d 2e67 6574 2861 7474 6163 686d     }.get(attachm
+00013980: 656e 742e 696d 6167 655f 696e 666f 2e61  ent.image_info.a
+00013990: 6e69 6d61 7465 645f 696d 6167 655f 7479  nimated_image_ty
+000139a0: 7065 2c20 4e6f 6e65 290a 2020 2020 2020  pe, None).      
+000139b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000139c0: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+000139d0: 3d20 6c69 7374 2861 7474 6163 686d 656e  = list(attachmen
+000139e0: 742e 696d 6167 655f 696e 666f 2e75 7269  t.image_info.uri
+000139f0: 5f6d 6170 2e76 616c 7565 7328 2929 5b30  _map.values())[0
+00013a00: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
+00013a10: 544f 444f 2066 696e 6420 6f75 7420 6966  TODO find out if
+00013a20: 2077 6520 6e65 6564 2074 6f20 7573 6520   we need to use 
+00013a30: 6765 745f 696d 6167 655f 7572 6c20 696e  get_image_url in
+00013a40: 2073 6f6d 6520 6361 7365 7320 6576 656e   some cases even
+00013a50: 2077 6974 6820 4d51 5454 0a20 2020 2020   with MQTT.     
+00013a60: 2020 2020 2020 2023 2075 726c 203d 2061         # url = a
+00013a70: 7761 6974 2073 6f75 7263 652e 636c 6965  wait source.clie
+00013a80: 6e74 2e67 6574 5f69 6d61 6765 5f75 726c  nt.get_image_url
+00013a90: 286d 7367 5f69 642c 2061 7474 6163 686d  (msg_id, attachm
+00013aa0: 656e 742e 6d65 6469 615f 6964 290a 2020  ent.media_id).  
+00013ab0: 2020 2020 2020 656c 6966 2061 7474 6163        elif attac
+00013ac0: 686d 656e 742e 6d65 6469 615f 6964 3a0a  hment.media_id:.
+00013ad0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00013ae0: 444f 2077 6861 7420 6966 2069 7427 7320  DO what if it's 
+00013af0: 6e6f 7420 6120 6669 6c65 3f0a 2020 2020  not a file?.    
+00013b00: 2020 2020 2020 2020 6d73 6774 7970 6520          msgtype 
+00013b10: 3d20 4d65 7373 6167 6554 7970 652e 4649  = MessageType.FI
+00013b20: 4c45 0a20 2020 2020 2020 2020 2020 2075  LE.            u
+00013b30: 726c 203d 2061 7761 6974 2073 6f75 7263  rl = await sourc
+00013b40: 652e 636c 6965 6e74 2e67 6574 5f66 696c  e.client.get_fil
+00013b50: 655f 7572 6c28 7365 6c66 2e66 6269 642c  e_url(self.fbid,
+00013b60: 206d 7367 5f69 642c 2061 7474 6163 686d   msg_id, attachm
+00013b70: 656e 742e 6d65 6469 615f 6964 290a 2020  ent.media_id).  
+00013b80: 2020 2020 2020 2020 2020 696e 666f 203d            info =
+00013b90: 2046 696c 6549 6e66 6f28 290a 2020 2020   FileInfo().    
+00013ba0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013bb0: 2020 2020 2020 7365 6c66 2e6c 6f67 2e77        self.log.w
+00013bc0: 6172 6e69 6e67 2866 2255 6e73 7570 706f  arning(f"Unsuppo
+00013bd0: 7274 6564 2061 7474 6163 686d 656e 7420  rted attachment 
+00013be0: 696e 207b 6d73 675f 6964 7d22 290a 2020  in {msg_id}").  
+00013bf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00013c00: 2054 6578 744d 6573 7361 6765 4576 656e   TextMessageEven
+00013c10: 7443 6f6e 7465 6e74 280a 2020 2020 2020  tContent(.      
+00013c20: 2020 2020 2020 2020 2020 6d73 6774 7970            msgtyp
+00013c30: 653d 4d65 7373 6167 6554 7970 652e 4e4f  e=MessageType.NO
+00013c40: 5449 4345 2c20 626f 6479 3d22 556e 7375  TICE, body="Unsu
+00013c50: 7070 6f72 7465 6420 6174 7461 6368 6d65  pported attachme
+00013c60: 6e74 220a 2020 2020 2020 2020 2020 2020  nt".            
+00013c70: 290a 2020 2020 2020 2020 6d78 632c 2061  ).        mxc, a
+00013c80: 6464 6974 696f 6e61 6c5f 696e 666f 2c20  dditional_info, 
+00013c90: 6465 6372 7970 7469 6f6e 5f69 6e66 6f20  decryption_info 
+00013ca0: 3d20 6177 6169 7420 7365 6c66 2e5f 7265  = await self._re
+00013cb0: 7570 6c6f 6164 5f66 625f 6669 6c65 280a  upload_fb_file(.
+00013cc0: 2020 2020 2020 2020 2020 2020 7572 6c2c              url,
+00013cd0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00013ce0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+00013cf0: 2069 6e74 656e 742c 0a20 2020 2020 2020   intent,.       
+00013d00: 2020 2020 2066 696c 656e 616d 653d 6669       filename=fi
+00013d10: 6c65 6e61 6d65 2c0a 2020 2020 2020 2020  lename,.        
+00013d20: 2020 2020 656e 6372 7970 743d 7365 6c66      encrypt=self
+00013d30: 2e65 6e63 7279 7074 6564 2c0a 2020 2020  .encrypted,.    
+00013d40: 2020 2020 2020 2020 6669 6e64 5f73 697a          find_siz
+00013d50: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
+00013d60: 2020 2020 2072 6566 6572 6572 3d72 6566       referer=ref
+00013d70: 6572 6572 2c0a 2020 2020 2020 2020 2020  erer,.          
+00013d80: 2020 636f 6e76 6572 745f 6175 6469 6f3d    convert_audio=
+00013d90: 766f 6963 655f 6d65 7373 6167 652c 0a20  voice_message,. 
+00013da0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013db0: 2069 6e66 6f2e 7369 7a65 203d 2061 6464   info.size = add
+00013dc0: 6974 696f 6e61 6c5f 696e 666f 2e73 697a  itional_info.siz
+00013dd0: 650a 2020 2020 2020 2020 696e 666f 2e6d  e.        info.m
+00013de0: 696d 6574 7970 6520 3d20 6174 7461 6368  imetype = attach
+00013df0: 6d65 6e74 2e6d 696d 655f 7479 7065 206f  ment.mime_type o
+00013e00: 7220 6164 6469 7469 6f6e 616c 5f69 6e66  r additional_inf
+00013e10: 6f2e 6d69 6d65 7479 7065 0a20 2020 2020  o.mimetype.     
+00013e20: 2020 2063 6f6e 7465 6e74 203d 204d 6564     content = Med
+00013e30: 6961 4d65 7373 6167 6545 7665 6e74 436f  iaMessageEventCo
+00013e40: 6e74 656e 7428 0a20 2020 2020 2020 2020  ntent(.         
+00013e50: 2020 2075 726c 3d6d 7863 2c20 6669 6c65     url=mxc, file
+00013e60: 3d64 6563 7279 7074 696f 6e5f 696e 666f  =decryption_info
+00013e70: 2c20 6d73 6774 7970 653d 6d73 6774 7970  , msgtype=msgtyp
+00013e80: 652c 2062 6f64 793d 6669 6c65 6e61 6d65  e, body=filename
+00013e90: 2c20 696e 666f 3d69 6e66 6f0a 2020 2020  , info=info.    
+00013ea0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+00013eb0: 2076 6f69 6365 5f6d 6573 7361 6765 3a0a   voice_message:.
+00013ec0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00013ed0: 656e 745b 226f 7267 2e6d 6174 7269 782e  ent["org.matrix.
+00013ee0: 6d73 6331 3736 372e 6175 6469 6f22 5d20  msc1767.audio"] 
+00013ef0: 3d20 7b22 6475 7261 7469 6f6e 223a 2069  = {"duration": i
+00013f00: 6e66 6f2e 6475 7261 7469 6f6e 7d0a 2020  nfo.duration}.  
+00013f10: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
+00013f20: 745b 226f 7267 2e6d 6174 7269 782e 6d73  t["org.matrix.ms
+00013f30: 6333 3234 352e 766f 6963 6522 5d20 3d20  c3245.voice"] = 
+00013f40: 7b7d 0a20 2020 2020 2020 2020 2020 2063  {}.            c
+00013f50: 6f6e 7465 6e74 2e62 6f64 7920 2b3d 2022  ontent.body += "
+00013f60: 2e6f 6767 220a 2020 2020 2020 2020 7265  .ogg".        re
+00013f70: 7475 726e 2063 6f6e 7465 6e74 0a0a 2020  turn content..  
+00013f80: 2020 6173 796e 6320 6465 6620 5f74 7279    async def _try
+00013f90: 5f68 616e 646c 655f 6772 6170 6871 6c5f  _handle_graphql_
+00013fa0: 7265 6163 7469 6f6e 7328 0a20 2020 2020  reactions(.     
+00013fb0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00013fc0: 2073 6f75 7263 653a 2075 2e55 7365 722c   source: u.User,
+00013fd0: 0a20 2020 2020 2020 206d 7367 3a20 7374  .        msg: st
+00013fe0: 7220 7c20 4442 4d65 7373 6167 652c 0a20  r | DBMessage,. 
+00013ff0: 2020 2020 2020 2072 6561 6374 696f 6e73         reactions
+00014000: 3a20 6c69 7374 5b67 7261 7068 716c 2e52  : list[graphql.R
+00014010: 6561 6374 696f 6e5d 2c0a 2020 2020 2020  eaction],.      
+00014020: 2020 7469 6d65 7374 616d 703a 2069 6e74    timestamp: int
+00014030: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00014040: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00014050: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00014060: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00014070: 6c66 2e5f 6861 6e64 6c65 5f67 7261 7068  lf._handle_graph
+00014080: 716c 5f72 6561 6374 696f 6e73 2873 6f75  ql_reactions(sou
+00014090: 7263 652c 206d 7367 2c20 7265 6163 7469  rce, msg, reacti
+000140a0: 6f6e 732c 2074 696d 6573 7461 6d70 290a  ons, timestamp).
+000140b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+000140c0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+000140d0: 2020 2020 2020 6d73 675f 6964 203d 206d        msg_id = m
+000140e0: 7367 2e66 6269 6420 6966 2069 7369 6e73  sg.fbid if isins
+000140f0: 7461 6e63 6528 6d73 672c 2044 424d 6573  tance(msg, DBMes
+00014100: 7361 6765 2920 656c 7365 206d 7367 0a20  sage) else msg. 
+00014110: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00014120: 6c6f 672e 6578 6365 7074 696f 6e28 6622  log.exception(f"
+00014130: 4572 726f 7220 6261 636b 6669 6c6c 696e  Error backfillin
+00014140: 6720 7265 6163 7469 6f6e 7320 746f 207b  g reactions to {
+00014150: 6d73 675f 6964 7d22 290a 0a20 2020 2061  msg_id}")..    a
+00014160: 7379 6e63 2064 6566 205f 6861 6e64 6c65  sync def _handle
+00014170: 5f67 7261 7068 716c 5f72 6561 6374 696f  _graphql_reactio
+00014180: 6e73 280a 2020 2020 2020 2020 7365 6c66  ns(.        self
+00014190: 2c0a 2020 2020 2020 2020 736f 7572 6365  ,.        source
+000141a0: 3a20 752e 5573 6572 2c0a 2020 2020 2020  : u.User,.      
+000141b0: 2020 6d73 673a 2073 7472 207c 2044 424d    msg: str | DBM
+000141c0: 6573 7361 6765 2c0a 2020 2020 2020 2020  essage,.        
+000141d0: 7265 6163 7469 6f6e 733a 206c 6973 745b  reactions: list[
+000141e0: 6772 6170 6871 6c2e 5265 6163 7469 6f6e  graphql.Reaction
+000141f0: 5d2c 0a20 2020 2020 2020 2074 696d 6573  ],.        times
+00014200: 7461 6d70 3a20 696e 7420 7c20 4e6f 6e65  tamp: int | None
+00014210: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+00014220: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00014230: 6966 2069 7369 6e73 7461 6e63 6528 6d73  if isinstance(ms
+00014240: 672c 2044 424d 6573 7361 6765 293a 0a20  g, DBMessage):. 
+00014250: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+00014260: 6765 5f69 6420 3d20 6d73 672e 6662 6964  ge_id = msg.fbid
+00014270: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
+00014280: 6765 745f 6d65 7373 6167 6520 3d20 6d73  get_message = ms
+00014290: 670a 2020 2020 2020 2020 656c 7365 3a0a  g.        else:.
+000142a0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+000142b0: 6167 655f 6964 203d 206d 7367 0a20 2020  age_id = msg.   
+000142c0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+000142d0: 6d65 7373 6167 6520 3d20 4e6f 6e65 0a20  message = None. 
+000142e0: 2020 2020 2020 2062 7269 6467 6564 5f72         bridged_r
+000142f0: 6561 6374 696f 6e73 203d 2061 7761 6974  eactions = await
+00014300: 2044 4252 6561 6374 696f 6e2e 6765 745f   DBReaction.get_
+00014310: 6279 5f6d 6573 7361 6765 5f66 6269 6428  by_message_fbid(
+00014320: 6d65 7373 6167 655f 6964 2c20 7365 6c66  message_id, self
+00014330: 2e66 625f 7265 6365 6976 6572 290a 2020  .fb_receiver).  
+00014340: 2020 2020 2020 6c61 7465 7374 5f72 6561        latest_rea
+00014350: 6374 696f 6e73 3a20 6469 6374 5b69 6e74  ctions: dict[int
+00014360: 2c20 6772 6170 6871 6c2e 5265 6163 7469  , graphql.Reacti
+00014370: 6f6e 5d20 3d20 7b0a 2020 2020 2020 2020  on] = {.        
+00014380: 2020 2020 696e 7428 7265 6163 742e 7573      int(react.us
+00014390: 6572 2e69 6429 3a20 7265 6163 7420 666f  er.id): react fo
+000143a0: 7220 7265 6163 7420 696e 2072 6561 6374  r react in react
+000143b0: 696f 6e73 0a20 2020 2020 2020 207d 0a20  ions.        }. 
+000143c0: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+000143d0: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
+000143e0: 2020 2066 2253 796e 6369 6e67 2072 6561     f"Syncing rea
+000143f0: 6374 696f 6e73 206f 6620 7b6d 6573 7361  ctions of {messa
+00014400: 6765 5f69 647d 2028 6461 7461 6261 7365  ge_id} (database
+00014410: 2068 6173 207b 6c65 6e28 6272 6964 6765   has {len(bridge
+00014420: 645f 7265 6163 7469 6f6e 7329 7d2c 2064  d_reactions)}, d
+00014430: 6174 6120 220a 2020 2020 2020 2020 2020  ata ".          
+00014440: 2020 6622 6672 6f6d 2047 7261 7068 514c    f"from GraphQL
+00014450: 2068 6173 207b 6c65 6e28 6c61 7465 7374   has {len(latest
+00014460: 5f72 6561 6374 696f 6e73 297d 2922 0a20  _reactions)})". 
+00014470: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00014480: 2074 6173 6b73 3a20 6c69 7374 5b61 7379   tasks: list[asy
+00014490: 6e63 696f 2e54 6173 6b5d 203d 205b 5d0a  ncio.Task] = [].
+000144a0: 2020 2020 2020 2020 6465 6475 706c 6963          deduplic
+000144b0: 6174 6564 5f74 696d 6573 7461 6d70 203d  ated_timestamp =
+000144c0: 2028 7469 6d65 7374 616d 7020 2b20 3129   (timestamp + 1)
+000144d0: 2069 6620 7469 6d65 7374 616d 7020 656c   if timestamp el
+000144e0: 7365 2069 6e74 2874 696d 652e 7469 6d65  se int(time.time
+000144f0: 2829 202a 2031 3030 3029 0a20 2020 2020  () * 1000).     
+00014500: 2020 2066 6f72 2073 656e 6465 722c 2072     for sender, r
+00014510: 6561 6374 696f 6e20 696e 206c 6174 6573  eaction in lates
+00014520: 745f 7265 6163 7469 6f6e 732e 6974 656d  t_reactions.item
+00014530: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00014540: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00014550: 2020 2020 2020 6578 6973 7469 6e67 203d        existing =
+00014560: 2062 7269 6467 6564 5f72 6561 6374 696f   bridged_reactio
+00014570: 6e73 5b73 656e 6465 725d 0a20 2020 2020  ns[sender].     
+00014580: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00014590: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+000145a0: 2020 2020 2020 2020 7461 736b 203d 2073          task = s
+000145b0: 656c 662e 6861 6e64 6c65 5f66 6163 6562  elf.handle_faceb
+000145c0: 6f6f 6b5f 7265 6163 7469 6f6e 5f61 6464  ook_reaction_add
+000145d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000145e0: 2020 2020 2020 736f 7572 6365 2c0a 2020        source,.  
+000145f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014600: 2020 7365 6e64 6572 2c0a 2020 2020 2020    sender,.      
+00014610: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00014620: 7373 6167 655f 6964 2c0a 2020 2020 2020  ssage_id,.      
+00014630: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00014640: 6163 7469 6f6e 2e72 6561 6374 696f 6e2c  action.reaction,
+00014650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014660: 2020 2020 2074 6172 6765 745f 6d65 7373       target_mess
+00014670: 6167 653d 7461 7267 6574 5f6d 6573 7361  age=target_messa
+00014680: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+00014690: 2020 2020 2020 2020 2320 5469 6d65 7374          # Timest
+000146a0: 616d 7020 6973 206f 6e6c 7920 7573 6564  amp is only used
+000146b0: 2066 6f72 206e 6577 2072 6561 6374 696f   for new reactio
+000146c0: 6e73 2c20 6265 6361 7573 6520 6974 2773  ns, because it's
+000146d0: 206f 6e6c 7920 696d 706f 7274 616e 7420   only important 
+000146e0: 7768 656e 0a20 2020 2020 2020 2020 2020  when.           
+000146f0: 2020 2020 2020 2020 2023 2062 6163 6b66           # backf
+00014700: 696c 6c69 6e67 206d 6573 7361 6765 7320  illing messages 
+00014710: 2877 6869 6368 206f 6276 696f 7573 6c79  (which obviously
+00014720: 2077 6f6e 2774 2068 6176 6520 616c 7265   won't have alre
+00014730: 6164 7920 6272 6964 6765 6420 7265 6163  ady bridged reac
+00014740: 7469 6f6e 7329 2e0a 2020 2020 2020 2020  tions)..        
+00014750: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00014760: 7374 616d 703d 6465 6475 706c 6963 6174  stamp=deduplicat
+00014770: 6564 5f74 696d 6573 7461 6d70 2c0a 2020  ed_timestamp,.  
+00014780: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00014790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147a0: 6465 6475 706c 6963 6174 6564 5f74 696d  deduplicated_tim
+000147b0: 6573 7461 6d70 202b 3d20 310a 2020 2020  estamp += 1.    
+000147c0: 2020 2020 2020 2020 2020 2020 7461 736b              task
+000147d0: 732e 6170 7065 6e64 2861 7379 6e63 696f  s.append(asyncio
+000147e0: 2e63 7265 6174 655f 7461 736b 2874 6173  .create_task(tas
+000147f0: 6b29 290a 2020 2020 2020 2020 2020 2020  k)).            
+00014800: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00014810: 2020 2020 2020 6966 2065 7869 7374 696e        if existin
+00014820: 672e 7265 6163 7469 6f6e 2021 3d20 7265  g.reaction != re
+00014830: 6163 7469 6f6e 2e72 6561 6374 696f 6e3a  action.reaction:
+00014840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014850: 2020 2020 2074 6173 6b20 3d20 7365 6c66       task = self
+00014860: 2e68 616e 646c 655f 6661 6365 626f 6f6b  .handle_facebook
+00014870: 5f72 6561 6374 696f 6e5f 6164 6428 0a20  _reaction_add(. 
+00014880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014890: 2020 2020 2020 2073 6f75 7263 652c 0a20         source,. 
+000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148b0: 2020 2020 2020 2073 656e 6465 722c 0a20         sender,. 
+000148c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148d0: 2020 2020 2020 206d 6573 7361 6765 5f69         message_i
+000148e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000148f0: 2020 2020 2020 2020 2020 2072 6561 6374             react
+00014900: 696f 6e2e 7265 6163 7469 6f6e 2c0a 2020  ion.reaction,.  
+00014910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014920: 2020 2020 2020 6578 6973 7469 6e67 3d65        existing=e
+00014930: 7869 7374 696e 672c 0a20 2020 2020 2020  xisting,.       
+00014940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014950: 2074 6172 6765 745f 6d65 7373 6167 653d   target_message=
+00014960: 7461 7267 6574 5f6d 6573 7361 6765 2c0a  target_message,.
+00014970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014980: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00014990: 2020 2020 2020 2020 2020 7461 736b 732e            tasks.
+000149a0: 6170 7065 6e64 2861 7379 6e63 696f 2e63  append(asyncio.c
+000149b0: 7265 6174 655f 7461 736b 2874 6173 6b29  reate_task(task)
+000149c0: 290a 2020 2020 2020 2020 666f 7220 7365  ).        for se
+000149d0: 6e64 6572 2c20 6578 6973 7469 6e67 2069  nder, existing i
+000149e0: 6e20 6272 6964 6765 645f 7265 6163 7469  n bridged_reacti
+000149f0: 6f6e 732e 6974 656d 7328 293a 0a20 2020  ons.items():.   
+00014a00: 2020 2020 2020 2020 2069 6620 7365 6e64           if send
+00014a10: 6572 206e 6f74 2069 6e20 6c61 7465 7374  er not in latest
+00014a20: 5f72 6561 6374 696f 6e73 3a0a 2020 2020  _reactions:.    
+00014a30: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00014a40: 203d 2073 656c 662e 6861 6e64 6c65 5f66   = self.handle_f
+00014a50: 6163 6562 6f6f 6b5f 7265 6163 7469 6f6e  acebook_reaction
+00014a60: 5f72 656d 6f76 6528 736f 7572 6365 2c20  _remove(source, 
+00014a70: 7365 6e64 6572 2c20 6578 6973 7469 6e67  sender, existing
+00014a80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014a90: 2020 7461 736b 732e 6170 7065 6e64 2861    tasks.append(a
+00014aa0: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
+00014ab0: 736b 2874 6173 6b29 290a 2020 2020 2020  sk(task)).      
+00014ac0: 2020 6966 206c 656e 2874 6173 6b73 2920    if len(tasks) 
+00014ad0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00014ae0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00014af0: 6174 6865 7228 2a74 6173 6b73 290a 2020  ather(*tasks).  
+00014b00: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+00014b10: 6f67 2e64 6562 7567 2866 2255 7064 6174  og.debug(f"Updat
+00014b20: 6564 207b 6c65 6e28 7461 736b 7329 7d20  ed {len(tasks)} 
+00014b30: 7265 6163 7469 6f6e 7320 6f66 207b 6d65  reactions of {me
+00014b40: 7373 6167 655f 6964 7d22 290a 0a20 2020  ssage_id}")..   
+00014b50: 2061 7379 6e63 2064 6566 205f 636f 6e76   async def _conv
+00014b60: 6572 745f 6772 6170 6871 6c5f 6d65 7373  ert_graphql_mess
+00014b70: 6167 6528 0a20 2020 2020 2020 2073 656c  age(.        sel
+00014b80: 662c 0a20 2020 2020 2020 2073 6f75 7263  f,.        sourc
+00014b90: 653a 2075 2e55 7365 722c 0a20 2020 2020  e: u.User,.     
+00014ba0: 2020 2069 6e74 656e 743a 2049 6e74 656e     intent: Inten
+00014bb0: 7441 5049 2c0a 2020 2020 2020 2020 6d65  tAPI,.        me
+00014bc0: 7373 6167 653a 2067 7261 7068 716c 2e4d  ssage: graphql.M
+00014bd0: 6573 7361 6765 2c0a 2020 2020 2020 2020  essage,.        
+00014be0: 6465 7465 726d 696e 6973 7469 635f 7265  deterministic_re
+00014bf0: 706c 795f 6964 3a20 626f 6f6c 203d 2046  ply_id: bool = F
+00014c00: 616c 7365 2c0a 2020 2020 2920 2d3e 206c  alse,.    ) -> l
+00014c10: 6973 745b 436f 6e76 6572 7465 644d 6573  ist[ConvertedMes
+00014c20: 7361 6765 5d3a 0a20 2020 2020 2020 2072  sage]:.        r
+00014c30: 6570 6c79 5f74 6f5f 6d73 6720 3d20 6d65  eply_to_msg = me
+00014c40: 7373 6167 652e 7265 706c 6965 645f 746f  ssage.replied_to
+00014c50: 5f6d 6573 7361 6765 2e6d 6573 7361 6765  _message.message
+00014c60: 2069 6620 6d65 7373 6167 652e 7265 706c   if message.repl
+00014c70: 6965 645f 746f 5f6d 6573 7361 6765 2065  ied_to_message e
+00014c80: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00014c90: 2063 6f6e 7665 7274 6564 3a20 6c69 7374   converted: list
+00014ca0: 5b43 6f6e 7665 7274 6564 4d65 7373 6167  [ConvertedMessag
+00014cb0: 655d 203d 205b 5d0a 2020 2020 2020 2020  e] = [].        
+00014cc0: 6966 206d 6573 7361 6765 2e73 7469 636b  if message.stick
+00014cd0: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00014ce0: 636f 6e76 6572 7465 642e 6170 7065 6e64  converted.append
+00014cf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014d00: 2020 6177 6169 7420 7365 6c66 2e5f 636f    await self._co
+00014d10: 6e76 6572 745f 6661 6365 626f 6f6b 5f73  nvert_facebook_s
+00014d20: 7469 636b 6572 280a 2020 2020 2020 2020  ticker(.        
+00014d30: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00014d40: 6365 2c20 696e 7465 6e74 2c20 696e 7428  ce, intent, int(
+00014d50: 6d65 7373 6167 652e 7374 6963 6b65 722e  message.sticker.
+00014d60: 6964 292c 2072 6570 6c79 5f74 6f5f 6d73  id), reply_to_ms
+00014d70: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+00014d80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00014d90: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+00014da0: 6e28 6d65 7373 6167 652e 626c 6f62 5f61  n(message.blob_a
+00014db0: 7474 6163 686d 656e 7473 2920 3e20 303a  ttachments) > 0:
+00014dc0: 0a20 2020 2020 2020 2020 2020 2061 7474  .            att
+00014dd0: 6163 686d 656e 745f 636f 6e74 656e 7473  achment_contents
+00014de0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+00014df0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
+00014e00: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+00014e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e20: 7365 6c66 2e5f 636f 6e76 6572 745f 6661  self._convert_fa
+00014e30: 6365 626f 6f6b 5f61 7474 6163 686d 656e  cebook_attachmen
+00014e40: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00014e50: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+00014e60: 6765 2e6d 6573 7361 6765 5f69 642c 2073  ge.message_id, s
+00014e70: 6f75 7263 652c 2069 6e74 656e 742c 2061  ource, intent, a
+00014e80: 7474 6163 686d 656e 742c 2072 6570 6c79  ttachment, reply
+00014e90: 5f74 6f5f 6d73 670a 2020 2020 2020 2020  _to_msg.        
+00014ea0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ec0: 2020 666f 7220 6174 7461 6368 6d65 6e74    for attachment
+00014ed0: 2069 6e20 6d65 7373 6167 652e 626c 6f62   in message.blob
+00014ee0: 5f61 7474 6163 686d 656e 7473 0a20 2020  _attachments.   
+00014ef0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+00014f00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00014f10: 2020 2020 2020 2020 2063 6f6e 7665 7274           convert
+00014f20: 6564 202b 3d20 5b63 2066 6f72 2063 2069  ed += [c for c i
+00014f30: 6e20 6174 7461 6368 6d65 6e74 5f63 6f6e  n attachment_con
+00014f40: 7465 6e74 7320 6966 2063 5d0a 0a20 2020  tents if c]..   
+00014f50: 2020 2020 2074 6578 7420 3d20 6d65 7373       text = mess
+00014f60: 6167 652e 6d65 7373 6167 652e 7465 7874  age.message.text
+00014f70: 2069 6620 6d65 7373 6167 652e 6d65 7373   if message.mess
+00014f80: 6167 6520 656c 7365 204e 6f6e 650a 2020  age else None.  
+00014f90: 2020 2020 2020 6966 206d 6573 7361 6765        if message
+00014fa0: 2e65 7874 656e 7369 626c 655f 6174 7461  .extensible_atta
+00014fb0: 6368 6d65 6e74 3a0a 2020 2020 2020 2020  chment:.        
+00014fc0: 2020 2020 7361 203d 206d 6573 7361 6765      sa = message
+00014fd0: 2e65 7874 656e 7369 626c 655f 6174 7461  .extensible_atta
+00014fe0: 6368 6d65 6e74 2e73 746f 7279 5f61 7474  chment.story_att
+00014ff0: 6163 686d 656e 740a 2020 2020 2020 2020  achment.        
+00015000: 2020 2020 636f 6e74 656e 7420 3d20 6177      content = aw
+00015010: 6169 7420 7365 6c66 2e5f 636f 6e76 6572  ait self._conver
+00015020: 745f 6578 7465 6e73 6962 6c65 5f6d 6564  t_extensible_med
+00015030: 6961 2873 6f75 7263 652c 2069 6e74 656e  ia(source, inten
+00015040: 742c 2073 612c 206d 6573 7361 6765 5f74  t, sa, message_t
+00015050: 6578 743d 7465 7874 290a 2020 2020 2020  ext=text).      
+00015060: 2020 2020 2020 6966 2063 6f6e 7465 6e74        if content
+00015070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015080: 2020 636f 6e76 6572 7465 642e 6170 7065    converted.appe
+00015090: 6e64 2828 4576 656e 7454 7970 652e 524f  nd((EventType.RO
+000150a0: 4f4d 5f4d 4553 5341 4745 2c20 636f 6e74  OM_MESSAGE, cont
+000150b0: 656e 7429 290a 2020 2020 2020 2020 6966  ent)).        if
+000150c0: 2074 6578 743a 0a20 2020 2020 2020 2020   text:.         
+000150d0: 2020 2063 6f6e 7665 7274 6564 2e61 7070     converted.app
+000150e0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+000150f0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00015100: 5f63 6f6e 7665 7274 5f66 6163 6562 6f6f  _convert_faceboo
+00015110: 6b5f 7465 7874 280a 2020 2020 2020 2020  k_text(.        
+00015120: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+00015130: 6167 652e 6d65 7373 6167 652c 2072 6570  age.message, rep
+00015140: 6c79 5f74 6f5f 6d73 672c 2064 6574 6572  ly_to_msg, deter
+00015150: 6d69 6e69 7374 6963 5f72 6570 6c79 5f69  ministic_reply_i
+00015160: 643d 6465 7465 726d 696e 6973 7469 635f  d=deterministic_
+00015170: 7265 706c 795f 6964 0a20 2020 2020 2020  reply_id.       
+00015180: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00015190: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000151a0: 2072 6574 7572 6e20 636f 6e76 6572 7465   return converte
+000151b0: 640a 0a20 2020 2061 7379 6e63 2064 6566  d..    async def
+000151c0: 205f 636f 6e76 6572 745f 6661 6365 626f   _convert_facebo
+000151d0: 6f6b 5f74 6578 7428 0a20 2020 2020 2020  ok_text(.       
+000151e0: 2073 656c 662c 0a20 2020 2020 2020 206d   self,.        m
+000151f0: 6573 7361 6765 3a20 6772 6170 6871 6c2e  essage: graphql.
+00015200: 4d65 7373 6167 6554 6578 7420 7c20 6d71  MessageText | mq
+00015210: 7474 2e4d 6573 7361 6765 2c0a 2020 2020  tt.Message,.    
+00015220: 2020 2020 7265 706c 795f 746f 3a20 6772      reply_to: gr
+00015230: 6170 6871 6c2e 4d69 6e69 6d61 6c4d 6573  aphql.MinimalMes
+00015240: 7361 6765 207c 206d 7174 742e 4d65 7373  sage | mqtt.Mess
+00015250: 6167 652c 0a20 2020 2020 2020 2064 6574  age,.        det
+00015260: 6572 6d69 6e69 7374 6963 5f72 6570 6c79  erministic_reply
+00015270: 5f69 643a 2062 6f6f 6c20 3d20 4661 6c73  _id: bool = Fals
+00015280: 652c 0a20 2020 2029 202d 3e20 436f 6e76  e,.    ) -> Conv
+00015290: 6572 7465 644d 6573 7361 6765 3a0a 2020  ertedMessage:.  
+000152a0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+000152b0: 6177 6169 7420 6661 6365 626f 6f6b 5f74  await facebook_t
+000152c0: 6f5f 6d61 7472 6978 286d 6573 7361 6765  o_matrix(message
+000152d0: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
+000152e0: 7365 6c66 2e5f 6164 645f 6661 6365 626f  self._add_facebo
+000152f0: 6f6b 5f72 6570 6c79 2863 6f6e 7465 6e74  ok_reply(content
+00015300: 2c20 7265 706c 795f 746f 2c20 6465 7465  , reply_to, dete
+00015310: 726d 696e 6973 7469 635f 6964 3d64 6574  rministic_id=det
+00015320: 6572 6d69 6e69 7374 6963 5f72 6570 6c79  erministic_reply
+00015330: 5f69 6429 0a20 2020 2020 2020 2072 6574  _id).        ret
+00015340: 7572 6e20 4576 656e 7454 7970 652e 524f  urn EventType.RO
+00015350: 4f4d 5f4d 4553 5341 4745 2c20 636f 6e74  OM_MESSAGE, cont
+00015360: 656e 740a 0a20 2020 2061 7379 6e63 2064  ent..    async d
+00015370: 6566 205f 636f 6e76 6572 745f 6661 6365  ef _convert_face
+00015380: 626f 6f6b 5f73 7469 636b 6572 280a 2020  book_sticker(.  
+00015390: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000153a0: 2020 2020 736f 7572 6365 3a20 752e 5573      source: u.Us
+000153b0: 6572 2c0a 2020 2020 2020 2020 696e 7465  er,.        inte
+000153c0: 6e74 3a20 496e 7465 6e74 4150 492c 0a20  nt: IntentAPI,. 
+000153d0: 2020 2020 2020 2073 7469 636b 6572 5f69         sticker_i
+000153e0: 643a 2069 6e74 2c0a 2020 2020 2020 2020  d: int,.        
+000153f0: 7265 706c 795f 746f 3a20 6772 6170 6871  reply_to: graphq
+00015400: 6c2e 4d69 6e69 6d61 6c4d 6573 7361 6765  l.MinimalMessage
+00015410: 207c 206d 7174 742e 4d65 7373 6167 652c   | mqtt.Message,
+00015420: 0a20 2020 2029 202d 3e20 436f 6e76 6572  .    ) -> Conver
+00015430: 7465 644d 6573 7361 6765 3a0a 2020 2020  tedMessage:.    
+00015440: 2020 2020 6173 7365 7274 2073 6f75 7263      assert sourc
+00015450: 652e 636c 6965 6e74 0a20 2020 2020 2020  e.client.       
+00015460: 2072 6573 7020 3d20 6177 6169 7420 736f   resp = await so
+00015470: 7572 6365 2e63 6c69 656e 742e 6665 7463  urce.client.fetc
+00015480: 685f 7374 6963 6b65 7273 285b 7374 6963  h_stickers([stic
+00015490: 6b65 725f 6964 5d2c 2073 7469 636b 6572  ker_id], sticker
+000154a0: 5f6c 6162 656c 735f 656e 6162 6c65 643d  _labels_enabled=
+000154b0: 5472 7565 290a 2020 2020 2020 2020 7374  True).        st
+000154c0: 6963 6b65 7220 3d20 7265 7370 2e6e 6f64  icker = resp.nod
+000154d0: 6573 5b30 5d0a 2020 2020 2020 2020 7572  es[0].        ur
+000154e0: 6c20 3d20 2873 7469 636b 6572 2e61 6e69  l = (sticker.ani
+000154f0: 6d61 7465 645f 696d 6167 6520 6f72 2073  mated_image or s
+00015500: 7469 636b 6572 2e74 6872 6561 645f 696d  ticker.thread_im
+00015510: 6167 6529 2e75 7269 0a20 2020 2020 2020  age).uri.       
+00015520: 206d 7863 2c20 696e 666f 2c20 6465 6372   mxc, info, decr
+00015530: 7970 7469 6f6e 5f69 6e66 6f20 3d20 6177  yption_info = aw
+00015540: 6169 7420 7365 6c66 2e5f 7265 7570 6c6f  ait self._reuplo
+00015550: 6164 5f66 625f 6669 6c65 280a 2020 2020  ad_fb_file(.    
+00015560: 2020 2020 2020 2020 7572 6c2c 2073 6f75          url, sou
+00015570: 7263 652c 2069 6e74 656e 742c 2065 6e63  rce, intent, enc
+00015580: 7279 7074 3d73 656c 662e 656e 6372 7970  rypt=self.encryp
+00015590: 7465 642c 2066 696e 645f 7369 7a65 3d54  ted, find_size=T
+000155a0: 7275 650a 2020 2020 2020 2020 290a 2020  rue.        ).  
+000155b0: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+000155c0: 4d65 6469 614d 6573 7361 6765 4576 656e  MediaMessageEven
+000155d0: 7443 6f6e 7465 6e74 280a 2020 2020 2020  tContent(.      
+000155e0: 2020 2020 2020 7572 6c3d 6d78 632c 0a20        url=mxc,. 
+000155f0: 2020 2020 2020 2020 2020 2066 696c 653d             file=
+00015600: 6465 6372 7970 7469 6f6e 5f69 6e66 6f2c  decryption_info,
+00015610: 0a20 2020 2020 2020 2020 2020 2069 6e66  .            inf
+00015620: 6f3d 696e 666f 2c0a 2020 2020 2020 2020  o=info,.        
+00015630: 2020 2020 6d73 6774 7970 653d 4d65 7373      msgtype=Mess
+00015640: 6167 6554 7970 652e 5354 4943 4b45 522c  ageType.STICKER,
+00015650: 0a20 2020 2020 2020 2020 2020 2062 6f64  .            bod
+00015660: 793d 7374 6963 6b65 722e 6c61 6265 6c20  y=sticker.label 
+00015670: 6f72 2022 222c 0a20 2020 2020 2020 2029  or "",.        )
+00015680: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+00015690: 656c 662e 5f61 6464 5f66 6163 6562 6f6f  elf._add_faceboo
+000156a0: 6b5f 7265 706c 7928 636f 6e74 656e 742c  k_reply(content,
+000156b0: 2072 6570 6c79 5f74 6f29 0a20 2020 2020   reply_to).     
+000156c0: 2020 2072 6574 7572 6e20 4576 656e 7454     return EventT
+000156d0: 7970 652e 5354 4943 4b45 522c 2063 6f6e  ype.STICKER, con
+000156e0: 7465 6e74 0a0a 2020 2020 6173 796e 6320  tent..    async 
+000156f0: 6465 6620 5f63 6f6e 7665 7274 5f66 6163  def _convert_fac
+00015700: 6562 6f6f 6b5f 6174 7461 6368 6d65 6e74  ebook_attachment
+00015710: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00015720: 2020 2020 2020 2020 6d73 675f 6964 3a20          msg_id: 
+00015730: 7374 722c 0a20 2020 2020 2020 2073 6f75  str,.        sou
+00015740: 7263 653a 2075 2e55 7365 722c 0a20 2020  rce: u.User,.   
+00015750: 2020 2020 2069 6e74 656e 743a 2049 6e74       intent: Int
+00015760: 656e 7441 5049 2c0a 2020 2020 2020 2020  entAPI,.        
+00015770: 6174 7461 6368 6d65 6e74 3a20 6772 6170  attachment: grap
+00015780: 6871 6c2e 4174 7461 6368 6d65 6e74 207c  hql.Attachment |
+00015790: 206d 7174 742e 4174 7461 6368 6d65 6e74   mqtt.Attachment
+000157a0: 2c0a 2020 2020 2020 2020 7265 706c 795f  ,.        reply_
+000157b0: 746f 3a20 6772 6170 6871 6c2e 4d69 6e69  to: graphql.Mini
+000157c0: 6d61 6c4d 6573 7361 6765 207c 206d 7174  malMessage | mqt
+000157d0: 742e 4d65 7373 6167 652c 0a20 2020 2020  t.Message,.     
+000157e0: 2020 206d 6573 7361 6765 5f74 6578 743a     message_text:
+000157f0: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00015800: 6e65 2c0a 2020 2020 2920 2d3e 2043 6f6e  ne,.    ) -> Con
+00015810: 7665 7274 6564 4d65 7373 6167 6520 7c20  vertedMessage | 
+00015820: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+00015830: 2069 7369 6e73 7461 6e63 6528 6174 7461   isinstance(atta
+00015840: 6368 6d65 6e74 2c20 6772 6170 6871 6c2e  chment, graphql.
+00015850: 4174 7461 6368 6d65 6e74 293a 0a20 2020  Attachment):.   
+00015860: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
+00015870: 203d 2061 7761 6974 2073 656c 662e 5f63   = await self._c
+00015880: 6f6e 7665 7274 5f67 7261 7068 716c 5f61  onvert_graphql_a
+00015890: 7474 6163 686d 656e 7428 6d73 675f 6964  ttachment(msg_id
+000158a0: 2c20 736f 7572 6365 2c20 696e 7465 6e74  , source, intent
+000158b0: 2c20 6174 7461 6368 6d65 6e74 290a 2020  , attachment).  
+000158c0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+000158d0: 7461 6e63 6528 6174 7461 6368 6d65 6e74  tance(attachment
+000158e0: 2c20 6d71 7474 2e41 7474 6163 686d 656e  , mqtt.Attachmen
+000158f0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00015900: 636f 6e74 656e 7420 3d20 6177 6169 7420  content = await 
+00015910: 7365 6c66 2e5f 636f 6e76 6572 745f 6d71  self._convert_mq
+00015920: 7474 5f61 7474 6163 686d 656e 7428 0a20  tt_attachment(. 
+00015930: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00015940: 7367 5f69 642c 2073 6f75 7263 652c 2069  sg_id, source, i
+00015950: 6e74 656e 742c 2061 7474 6163 686d 656e  ntent, attachmen
+00015960: 742c 206d 6573 7361 6765 5f74 6578 743d  t, message_text=
+00015970: 6d65 7373 6167 655f 7465 7874 0a20 2020  message_text.   
+00015980: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00015990: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000159a0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000159b0: 4572 726f 7228 6622 496e 7661 6c69 6420  Error(f"Invalid 
+000159c0: 6174 7461 6368 6d65 6e74 2074 7970 6520  attachment type 
+000159d0: 7b74 7970 6528 6174 7461 6368 6d65 6e74  {type(attachment
+000159e0: 292e 5f5f 6e61 6d65 5f5f 7d22 290a 2020  ).__name__}").  
+000159f0: 2020 2020 2020 6966 206e 6f74 2063 6f6e        if not con
+00015a00: 7465 6e74 3a0a 2020 2020 2020 2020 2020  tent:.          
+00015a10: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+00015a20: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00015a30: 2e5f 6164 645f 6661 6365 626f 6f6b 5f72  ._add_facebook_r
+00015a40: 6570 6c79 2863 6f6e 7465 6e74 2c20 7265  eply(content, re
+00015a50: 706c 795f 746f 290a 2020 2020 2020 2020  ply_to).        
+00015a60: 7265 7475 726e 2045 7665 6e74 5479 7065  return EventType
+00015a70: 2e52 4f4f 4d5f 4d45 5353 4147 452c 2063  .ROOM_MESSAGE, c
+00015a80: 6f6e 7465 6e74 0a0a 2020 2020 6173 796e  ontent..    asyn
+00015a90: 6320 6465 6620 5f63 6f6e 7665 7274 5f67  c def _convert_g
+00015aa0: 7261 7068 716c 5f61 7474 6163 686d 656e  raphql_attachmen
+00015ab0: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+00015ac0: 0a20 2020 2020 2020 206d 7367 5f69 643a  .        msg_id:
+00015ad0: 2073 7472 2c0a 2020 2020 2020 2020 736f   str,.        so
+00015ae0: 7572 6365 3a20 752e 5573 6572 2c0a 2020  urce: u.User,.  
+00015af0: 2020 2020 2020 696e 7465 6e74 3a20 496e        intent: In
+00015b00: 7465 6e74 4150 492c 0a20 2020 2020 2020  tentAPI,.       
+00015b10: 2061 7474 6163 686d 656e 743a 2067 7261   attachment: gra
+00015b20: 7068 716c 2e41 7474 6163 686d 656e 742c  phql.Attachment,
+00015b30: 0a20 2020 2029 202d 3e20 4d65 7373 6167  .    ) -> Messag
+00015b40: 6545 7665 6e74 436f 6e74 656e 743a 0a20  eEventContent:. 
+00015b50: 2020 2020 2020 2066 696c 656e 616d 6520         filename 
+00015b60: 3d20 6174 7461 6368 6d65 6e74 2e66 696c  = attachment.fil
+00015b70: 656e 616d 650a 2020 2020 2020 2020 6966  ename.        if
+00015b80: 2061 7474 6163 686d 656e 742e 6d69 6d65   attachment.mime
+00015b90: 7479 7065 2061 6e64 2022 2e22 206e 6f74  type and "." not
+00015ba0: 2069 6e20 6669 6c65 6e61 6d65 3a0a 2020   in filename:.  
+00015bb0: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
+00015bc0: 6d65 202b 3d20 6d69 6d65 7479 7065 732e  me += mimetypes.
+00015bd0: 6775 6573 735f 6578 7465 6e73 696f 6e28  guess_extension(
+00015be0: 6174 7461 6368 6d65 6e74 2e6d 696d 6574  attachment.mimet
+00015bf0: 7970 6529 0a20 2020 2020 2020 2072 6566  ype).        ref
+00015c00: 6572 6572 203d 2022 756e 6b6e 6f77 6e22  erer = "unknown"
+00015c10: 0a20 2020 2020 2020 2069 6620 6174 7461  .        if atta
+00015c20: 6368 6d65 6e74 2e74 7970 656e 616d 6520  chment.typename 
+00015c30: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
+00015c40: 2067 7261 7068 716c 2e41 7474 6163 686d   graphql.Attachm
+00015c50: 656e 7454 7970 652e 494d 4147 452c 0a20  entType.IMAGE,. 
+00015c60: 2020 2020 2020 2020 2020 2067 7261 7068             graph
+00015c70: 716c 2e41 7474 6163 686d 656e 7454 7970  ql.AttachmentTyp
+00015c80: 652e 414e 494d 4154 4544 5f49 4d41 4745  e.ANIMATED_IMAGE
+00015c90: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
+00015ca0: 2020 2020 2020 2020 206d 7367 7479 7065           msgtype
+00015cb0: 203d 204d 6573 7361 6765 5479 7065 2e49   = MessageType.I
+00015cc0: 4d41 4745 0a20 2020 2020 2020 2020 2020  MAGE.           
+00015cd0: 2069 6620 6174 7461 6368 6d65 6e74 2e74   if attachment.t
+00015ce0: 7970 656e 616d 6520 3d3d 2067 7261 7068  ypename == graph
+00015cf0: 716c 2e41 7474 6163 686d 656e 7454 7970  ql.AttachmentTyp
+00015d00: 652e 494d 4147 453a 0a20 2020 2020 2020  e.IMAGE:.       
+00015d10: 2020 2020 2020 2020 2069 6e66 6f20 3d20           info = 
+00015d20: 496d 6167 6549 6e66 6f28 0a20 2020 2020  ImageInfo(.     
+00015d30: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00015d40: 6964 7468 3d61 7474 6163 686d 656e 742e  idth=attachment.
+00015d50: 6f72 6967 696e 616c 5f64 696d 656e 7369  original_dimensi
+00015d60: 6f6e 732e 782c 0a20 2020 2020 2020 2020  ons.x,.         
+00015d70: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00015d80: 743d 6174 7461 6368 6d65 6e74 2e6f 7269  t=attachment.ori
+00015d90: 6769 6e61 6c5f 6469 6d65 6e73 696f 6e73  ginal_dimensions
+00015da0: 2e79 2c0a 2020 2020 2020 2020 2020 2020  .y,.            
+00015db0: 2020 2020 2020 2020 6d69 6d65 7479 7065          mimetype
+00015dc0: 3d61 7474 6163 686d 656e 742e 6d69 6d65  =attachment.mime
+00015dd0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+00015de0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00015df0: 2020 2020 2020 2020 6675 6c6c 5f73 6372          full_scr
+00015e00: 6565 6e20 3d20 6174 7461 6368 6d65 6e74  een = attachment
+00015e10: 2e69 6d61 6765 5f66 756c 6c5f 7363 7265  .image_full_scre
+00015e20: 656e 0a20 2020 2020 2020 2020 2020 2065  en.            e
+00015e30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00015e40: 2020 2020 2069 6e66 6f20 3d20 496d 6167       info = Imag
+00015e50: 6549 6e66 6f28 0a20 2020 2020 2020 2020  eInfo(.         
+00015e60: 2020 2020 2020 2020 2020 2077 6964 7468             width
+00015e70: 3d61 7474 6163 686d 656e 742e 616e 696d  =attachment.anim
+00015e80: 6174 6564 5f69 6d61 6765 5f6f 7269 6769  ated_image_origi
+00015e90: 6e61 6c5f 6469 6d65 6e73 696f 6e73 2e78  nal_dimensions.x
+00015ea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015eb0: 2020 2020 2020 6865 6967 6874 3d61 7474        height=att
+00015ec0: 6163 686d 656e 742e 616e 696d 6174 6564  achment.animated
+00015ed0: 5f69 6d61 6765 5f6f 7269 6769 6e61 6c5f  _image_original_
+00015ee0: 6469 6d65 6e73 696f 6e73 2e79 2c0a 2020  dimensions.y,.  
+00015ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f00: 2020 6d69 6d65 7479 7065 3d61 7474 6163    mimetype=attac
+00015f10: 686d 656e 742e 6d69 6d65 7479 7065 2c0a  hment.mimetype,.
+00015f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015f40: 2020 6675 6c6c 5f73 6372 6565 6e20 3d20    full_screen = 
+00015f50: 6174 7461 6368 6d65 6e74 2e61 6e69 6d61  attachment.anima
+00015f60: 7465 645f 696d 6167 655f 6675 6c6c 5f73  ted_image_full_s
+00015f70: 6372 6565 6e0a 2020 2020 2020 2020 2020  creen.          
+00015f80: 2020 7572 6c20 3d20 6675 6c6c 5f73 6372    url = full_scr
+00015f90: 6565 6e2e 7572 690a 2020 2020 2020 2020  een.uri.        
+00015fa0: 2020 2020 6966 2028 696e 666f 2e77 6964      if (info.wid
+00015fb0: 7468 2c20 696e 666f 2e68 6569 6768 7429  th, info.height)
+00015fc0: 203e 2066 756c 6c5f 7363 7265 656e 2e64   > full_screen.d
+00015fd0: 696d 656e 7369 6f6e 733a 0a20 2020 2020  imensions:.     
+00015fe0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+00015ff0: 2061 7761 6974 2073 6f75 7263 652e 636c   await source.cl
+00016000: 6965 6e74 2e67 6574 5f69 6d61 6765 5f75  ient.get_image_u
+00016010: 726c 286d 7367 5f69 642c 2061 7474 6163  rl(msg_id, attac
+00016020: 686d 656e 742e 6174 7461 6368 6d65 6e74  hment.attachment
+00016030: 5f66 6269 6429 206f 7220 7572 6c0a 2020  _fbid) or url.  
+00016040: 2020 2020 2020 2020 2020 7265 6665 7265            refere
+00016050: 7220 3d20 226d 6573 7365 6e67 6572 5f74  r = "messenger_t
+00016060: 6872 6561 645f 7068 6f74 6f22 0a20 2020  hread_photo".   
+00016070: 2020 2020 2065 6c69 6620 6174 7461 6368       elif attach
+00016080: 6d65 6e74 2e74 7970 656e 616d 6520 3d3d  ment.typename ==
+00016090: 2067 7261 7068 716c 2e41 7474 6163 686d   graphql.Attachm
+000160a0: 656e 7454 7970 652e 4155 4449 4f3a 0a20  entType.AUDIO:. 
+000160b0: 2020 2020 2020 2020 2020 206d 7367 7479             msgty
+000160c0: 7065 203d 204d 6573 7361 6765 5479 7065  pe = MessageType
+000160d0: 2e41 5544 494f 0a20 2020 2020 2020 2020  .AUDIO.         
+000160e0: 2020 2069 6e66 6f20 3d20 4175 6469 6f49     info = AudioI
+000160f0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00016100: 2020 2020 2064 7572 6174 696f 6e3d 6174       duration=at
+00016110: 7461 6368 6d65 6e74 2e70 6c61 7961 626c  tachment.playabl
+00016120: 655f 6475 7261 7469 6f6e 5f69 6e5f 6d73  e_duration_in_ms
+00016130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016140: 2020 6d69 6d65 7479 7065 3d61 7474 6163    mimetype=attac
+00016150: 686d 656e 742e 6d69 6d65 7479 7065 2c0a  hment.mimetype,.
+00016160: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00016170: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00016180: 6174 7461 6368 6d65 6e74 2e70 6c61 7961  attachment.playa
+00016190: 626c 655f 7572 6c0a 2020 2020 2020 2020  ble_url.        
+000161a0: 656c 6966 2061 7474 6163 686d 656e 742e  elif attachment.
+000161b0: 7479 7065 6e61 6d65 203d 3d20 6772 6170  typename == grap
+000161c0: 6871 6c2e 4174 7461 6368 6d65 6e74 5479  hql.AttachmentTy
+000161d0: 7065 2e56 4944 454f 3a0a 2020 2020 2020  pe.VIDEO:.      
+000161e0: 2020 2020 2020 6d73 6774 7970 6520 3d20        msgtype = 
+000161f0: 4d65 7373 6167 6554 7970 652e 5649 4445  MessageType.VIDE
+00016200: 4f0a 2020 2020 2020 2020 2020 2020 696e  O.            in
+00016210: 666f 203d 2056 6964 656f 496e 666f 280a  fo = VideoInfo(.
+00016220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016230: 6475 7261 7469 6f6e 3d61 7474 6163 686d  duration=attachm
+00016240: 656e 742e 706c 6179 6162 6c65 5f64 7572  ent.playable_dur
+00016250: 6174 696f 6e5f 696e 5f6d 732c 0a20 2020  ation_in_ms,.   
+00016260: 2020 2020 2020 2020 2020 2020 206d 696d               mim
+00016270: 6574 7970 653d 6174 7461 6368 6d65 6e74  etype=attachment
+00016280: 2e6d 696d 6574 7970 652c 0a20 2020 2020  .mimetype,.     
+00016290: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000162a0: 2020 2020 2075 726c 203d 2061 7474 6163       url = attac
+000162b0: 686d 656e 742e 6174 7461 6368 6d65 6e74  hment.attachment
+000162c0: 5f76 6964 656f 5f75 726c 0a20 2020 2020  _video_url.     
+000162d0: 2020 2065 6c69 6620 6174 7461 6368 6d65     elif attachme
+000162e0: 6e74 2e74 7970 656e 616d 6520 3d3d 2067  nt.typename == g
+000162f0: 7261 7068 716c 2e41 7474 6163 686d 656e  raphql.Attachmen
+00016300: 7454 7970 652e 4649 4c45 3a0a 2020 2020  tType.FILE:.    
+00016310: 2020 2020 2020 2020 6d73 6774 7970 6520          msgtype 
+00016320: 3d20 4d65 7373 6167 6554 7970 652e 4649  = MessageType.FI
+00016330: 4c45 0a20 2020 2020 2020 2020 2020 2075  LE.            u
+00016340: 726c 203d 2061 7761 6974 2073 6f75 7263  rl = await sourc
+00016350: 652e 636c 6965 6e74 2e67 6574 5f66 696c  e.client.get_fil
+00016360: 655f 7572 6c28 7365 6c66 2e66 6269 642c  e_url(self.fbid,
+00016370: 206d 7367 5f69 642c 2061 7474 6163 686d   msg_id, attachm
+00016380: 656e 742e 6174 7461 6368 6d65 6e74 5f66  ent.attachment_f
+00016390: 6269 6429 0a20 2020 2020 2020 2020 2020  bid).           
+000163a0: 2069 6e66 6f20 3d20 4669 6c65 496e 666f   info = FileInfo
+000163b0: 286d 696d 6574 7970 653d 6174 7461 6368  (mimetype=attach
+000163c0: 6d65 6e74 2e6d 696d 6574 7970 6529 0a20  ment.mimetype). 
+000163d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000163e0: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
+000163f0: 6c6f 6361 7469 6f6e 2061 7474 6163 686d  location attachm
+00016400: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+00016410: 206d 7367 203d 2066 2255 6e73 7570 706f   msg = f"Unsuppo
+00016420: 7274 6564 2061 7474 6163 686d 656e 7420  rted attachment 
+00016430: 7479 7065 207b 6174 7461 6368 6d65 6e74  type {attachment
+00016440: 2e74 7970 656e 616d 657d 220a 2020 2020  .typename}".    
+00016450: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00016460: 2e77 6172 6e69 6e67 286d 7367 290a 2020  .warning(msg).  
+00016470: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00016480: 2054 6578 744d 6573 7361 6765 4576 656e   TextMessageEven
+00016490: 7443 6f6e 7465 6e74 286d 7367 7479 7065  tContent(msgtype
+000164a0: 3d4d 6573 7361 6765 5479 7065 2e4e 4f54  =MessageType.NOT
+000164b0: 4943 452c 2062 6f64 793d 6d73 6729 0a20  ICE, body=msg). 
+000164c0: 2020 2020 2020 206d 7863 2c20 6164 6469         mxc, addi
+000164d0: 7469 6f6e 616c 5f69 6e66 6f2c 2064 6563  tional_info, dec
+000164e0: 7279 7074 696f 6e5f 696e 666f 203d 2061  ryption_info = a
+000164f0: 7761 6974 2073 656c 662e 5f72 6575 706c  wait self._reupl
+00016500: 6f61 645f 6662 5f66 696c 6528 0a20 2020  oad_fb_file(.   
+00016510: 2020 2020 2020 2020 2075 726c 2c0a 2020           url,.  
+00016520: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00016530: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00016540: 7465 6e74 2c0a 2020 2020 2020 2020 2020  tent,.          
+00016550: 2020 6669 6c65 6e61 6d65 3d66 696c 656e    filename=filen
+00016560: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00016570: 2065 6e63 7279 7074 3d73 656c 662e 656e   encrypt=self.en
+00016580: 6372 7970 7465 642c 0a20 2020 2020 2020  crypted,.       
+00016590: 2020 2020 2066 696e 645f 7369 7a65 3d46       find_size=F
+000165a0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+000165b0: 2020 7265 6665 7265 723d 7265 6665 7265    referer=refere
+000165c0: 722c 0a20 2020 2020 2020 2029 0a20 2020  r,.        ).   
+000165d0: 2020 2020 2069 6e66 6f2e 7369 7a65 203d       info.size =
+000165e0: 2061 6464 6974 696f 6e61 6c5f 696e 666f   additional_info
+000165f0: 2e73 697a 650a 2020 2020 2020 2020 7265  .size.        re
+00016600: 7475 726e 204d 6564 6961 4d65 7373 6167  turn MediaMessag
+00016610: 6545 7665 6e74 436f 6e74 656e 7428 0a20  eEventContent(. 
+00016620: 2020 2020 2020 2020 2020 2075 726c 3d6d             url=m
+00016630: 7863 2c20 6669 6c65 3d64 6563 7279 7074  xc, file=decrypt
+00016640: 696f 6e5f 696e 666f 2c20 6d73 6774 7970  ion_info, msgtyp
+00016650: 653d 6d73 6774 7970 652c 2062 6f64 793d  e=msgtype, body=
+00016660: 6669 6c65 6e61 6d65 2c20 696e 666f 3d69  filename, info=i
+00016670: 6e66 6f0a 2020 2020 2020 2020 290a 0a20  nfo.        ).. 
+00016680: 2020 2061 7379 6e63 2064 6566 205f 636f     async def _co
+00016690: 6e76 6572 745f 6661 6365 626f 6f6b 5f6c  nvert_facebook_l
+000166a0: 6f63 6174 696f 6e28 0a20 2020 2020 2020  ocation(.       
+000166b0: 2073 656c 662c 2073 6f75 7263 653a 2075   self, source: u
+000166c0: 2e55 7365 722c 2069 6e74 656e 743a 2049  .User, intent: I
+000166d0: 6e74 656e 7441 5049 2c20 6c6f 6361 7469  ntentAPI, locati
+000166e0: 6f6e 3a20 6772 6170 6871 6c2e 5374 6f72  on: graphql.Stor
+000166f0: 7954 6172 6765 740a 2020 2020 2920 2d3e  yTarget.    ) ->
+00016700: 204c 6f63 6174 696f 6e4d 6573 7361 6765   LocationMessage
+00016710: 4576 656e 7443 6f6e 7465 6e74 207c 2054  EventContent | T
+00016720: 6578 744d 6573 7361 6765 4576 656e 7443  extMessageEventC
+00016730: 6f6e 7465 6e74 3a0a 2020 2020 2020 2020  ontent:.        
+00016740: 6c6f 6e67 2c20 6c61 7420 3d20 6c6f 6361  long, lat = loca
+00016750: 7469 6f6e 2e63 6f6f 7264 696e 6174 6573  tion.coordinates
+00016760: 2e6c 6f6e 6769 7475 6465 2c20 6c6f 6361  .longitude, loca
+00016770: 7469 6f6e 2e63 6f6f 7264 696e 6174 6573  tion.coordinates
+00016780: 2e6c 6174 6974 7564 650a 2020 2020 2020  .latitude.      
+00016790: 2020 6966 206e 6f74 206c 6f6e 6720 6f72    if not long or
+000167a0: 206e 6f74 206c 6174 3a0a 2020 2020 2020   not lat:.      
+000167b0: 2020 2020 2020 2320 6966 206c 6f63 6174        # if locat
+000167c0: 696f 6e2e 6164 6472 6573 7320 6f72 206c  ion.address or l
+000167d0: 6f63 6174 696f 6e2e 7572 6c3a 0a20 2020  ocation.url:.   
+000167e0: 2020 2020 2020 2020 2023 2020 2020 2073           #     s
+000167f0: 656c 662e 6c6f 672e 7472 6163 6528 224c  elf.log.trace("L
+00016800: 6f63 6174 696f 6e20 6d65 7373 6167 6520  ocation message 
+00016810: 7769 7468 206e 6f20 636f 6f72 6469 6e61  with no coordina
+00016820: 7465 733a 2025 7322 2c20 6c6f 6361 7469  tes: %s", locati
+00016830: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00016840: 2320 2020 2020 7265 7475 726e 2054 6578  #     return Tex
+00016850: 744d 6573 7361 6765 4576 656e 7443 6f6e  tMessageEventCon
+00016860: 7465 6e74 286d 7367 7479 7065 3d4d 6573  tent(msgtype=Mes
+00016870: 7361 6765 5479 7065 2e54 4558 542c 0a20  sageType.TEXT,. 
+00016880: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168b0: 626f 6479 3d66 227b 6c6f 6361 7469 6f6e  body=f"{location
+000168c0: 2e61 6464 7265 7373 7d5c 6e7b 6c6f 6361  .address}\n{loca
+000168d0: 7469 6f6e 2e75 726c 7d22 290a 2020 2020  tion.url}").    
+000168e0: 2020 2020 2020 2020 2320 656c 7365 3a0a          # else:.
+000168f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00016900: 2e6c 6f67 2e77 6172 6e69 6e67 2822 556e  .log.warning("Un
+00016910: 7375 7070 6f72 7465 6420 4661 6365 626f  supported Facebo
+00016920: 6f6b 206c 6f63 6174 696f 6e20 6d65 7373  ok location mess
+00016930: 6167 6520 636f 6e74 656e 743a 2025 7322  age content: %s"
+00016940: 2c20 6c6f 6361 7469 6f6e 290a 2020 2020  , location).    
+00016950: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00016960: 6578 744d 6573 7361 6765 4576 656e 7443  extMessageEventC
+00016970: 6f6e 7465 6e74 280a 2020 2020 2020 2020  ontent(.        
+00016980: 2020 2020 2020 2020 6d73 6774 7970 653d          msgtype=
+00016990: 4d65 7373 6167 6554 7970 652e 4e4f 5449  MessageType.NOTI
+000169a0: 4345 2c0a 2020 2020 2020 2020 2020 2020  CE,.            
+000169b0: 2020 2020 626f 6479 3d22 4c6f 6361 7469      body="Locati
+000169c0: 6f6e 206d 6573 7361 6765 2077 6974 6820  on message with 
+000169d0: 756e 7375 7070 6f72 7465 6420 636f 6e74  unsupported cont
+000169e0: 656e 7422 2c0a 2020 2020 2020 2020 2020  ent",.          
+000169f0: 2020 290a 2020 2020 2020 2020 6c6f 6e67    ).        long
+00016a00: 5f63 6861 7220 3d20 2245 2220 6966 206c  _char = "E" if l
+00016a10: 6f6e 6720 3e20 3020 656c 7365 2022 5722  ong > 0 else "W"
+00016a20: 0a20 2020 2020 2020 206c 6174 5f63 6861  .        lat_cha
+00016a30: 7220 3d20 224e 2220 6966 206c 6174 203e  r = "N" if lat >
+00016a40: 2030 2065 6c73 6520 2253 220a 2020 2020   0 else "S".    
+00016a50: 2020 2020 6765 6f20 3d20 6622 7b72 6f75      geo = f"{rou
+00016a60: 6e64 286c 6174 2c20 3629 7d2c 7b72 6f75  nd(lat, 6)},{rou
+00016a70: 6e64 286c 6f6e 672c 2036 297d 220a 0a20  nd(long, 6)}".. 
+00016a80: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
+00016a90: 7b72 6f75 6e64 2861 6273 286c 6174 292c  {round(abs(lat),
+00016aa0: 2034 297d c2b0 207b 6c61 745f 6368 6172   4)}.. {lat_char
+00016ab0: 7d2c 207b 726f 756e 6428 6162 7328 6c6f  }, {round(abs(lo
+00016ac0: 6e67 292c 2034 297d c2b0 207b 6c6f 6e67  ng), 4)}.. {long
+00016ad0: 5f63 6861 727d 220a 2020 2020 2020 2020  _char}".        
+00016ae0: 7572 6c20 3d20 6622 6874 7470 733a 2f2f  url = f"https://
+00016af0: 6d61 7073 2e67 6f6f 676c 652e 636f 6d2f  maps.google.com/
+00016b00: 3f71 3d7b 6765 6f7d 220a 0a20 2020 2020  ?q={geo}"..     
+00016b10: 2020 2063 6f6e 7465 6e74 203d 204c 6f63     content = Loc
+00016b20: 6174 696f 6e4d 6573 7361 6765 4576 656e  ationMessageEven
+00016b30: 7443 6f6e 7465 6e74 280a 2020 2020 2020  tContent(.      
+00016b40: 2020 2020 2020 626f 6479 3d66 224c 6f63        body=f"Loc
+00016b50: 6174 696f 6e3a 207b 7465 7874 7d5c 6e7b  ation: {text}\n{
+00016b60: 7572 6c7d 222c 0a20 2020 2020 2020 2020  url}",.         
+00016b70: 2020 2067 656f 5f75 7269 3d66 2267 656f     geo_uri=f"geo
+00016b80: 3a7b 6c61 747d 2c7b 6c6f 6e67 7d22 2c0a  :{lat},{long}",.
+00016b90: 2020 2020 2020 2020 2020 2020 6d73 6774              msgt
+00016ba0: 7970 653d 4d65 7373 6167 6554 7970 652e  ype=MessageType.
+00016bb0: 4c4f 4341 5449 4f4e 2c0a 2020 2020 2020  LOCATION,.      
+00016bc0: 2020 290a 2020 2020 2020 2020 2320 536f    ).        # So
+00016bd0: 6d65 2063 6c69 656e 7473 2073 7570 706f  me clients suppo
+00016be0: 7274 2066 6f72 6d61 7474 6564 2062 6f64  rt formatted bod
+00016bf0: 7920 696e 206d 2e6c 6f63 6174 696f 6e2c  y in m.location,
+00016c00: 2073 6f20 6164 6420 7468 6174 2061 7320   so add that as 
+00016c10: 7765 6c6c 2e0a 2020 2020 2020 2020 636f  well..        co
+00016c20: 6e74 656e 745b 2266 6f72 6d61 7422 5d20  ntent["format"] 
+00016c30: 3d20 7374 7228 466f 726d 6174 2e48 544d  = str(Format.HTM
+00016c40: 4c29 0a20 2020 2020 2020 2063 6f6e 7465  L).        conte
+00016c50: 6e74 5b22 666f 726d 6174 7465 645f 626f  nt["formatted_bo
+00016c60: 6479 225d 203d 2066 223c 703e 4c6f 6361  dy"] = f"<p>Loca
+00016c70: 7469 6f6e 3a20 3c61 2068 7265 663d 277b  tion: <a href='{
+00016c80: 7572 6c7d 273e 7b74 6578 747d 3c2f 613e  url}'>{text}</a>
+00016c90: 3c2f 7022 0a20 2020 2020 2020 2023 2054  </p".        # T
+00016ca0: 4f44 4f20 6669 6e64 206f 7574 2069 6620  ODO find out if 
+00016cb0: 6c6f 6361 7469 6f6e 7320 7374 696c 6c20  locations still 
+00016cc0: 6861 7665 2061 6464 7265 7373 6573 0a20  have addresses. 
+00016cd0: 2020 2020 2020 2023 2069 6620 6c6f 6361         # if loca
+00016ce0: 7469 6f6e 2e61 6464 7265 7373 3a0a 2020  tion.address:.  
+00016cf0: 2020 2020 2020 2320 2020 2020 636f 6e74        #     cont
+00016d00: 656e 742e 626f 6479 203d 2066 227b 6c6f  ent.body = f"{lo
+00016d10: 6361 7469 6f6e 2e61 6464 7265 7373 7d5c  cation.address}\
+00016d20: 6e7b 636f 6e74 656e 742e 626f 6479 7d22  n{content.body}"
+00016d30: 0a20 2020 2020 2020 2023 2020 2020 2063  .        #     c
+00016d40: 6f6e 7465 6e74 5b22 666f 726d 6174 7465  ontent["formatte
+00016d50: 645f 626f 6479 225d 203d 2066 223c 703e  d_body"] = f"<p>
+00016d60: 7b6c 6f63 6174 696f 6e2e 6164 6472 6573  {location.addres
+00016d70: 737d 3c2f 703e 7b63 6f6e 7465 6e74 5b27  s}</p>{content['
+00016d80: 666f 726d 6174 7465 645f 626f 6479 275d  formatted_body']
+00016d90: 7d22 0a20 2020 2020 2020 2072 6574 7572  }".        retur
+00016da0: 6e20 636f 6e74 656e 740a 0a20 2020 2061  n content..    a
+00016db0: 7379 6e63 2064 6566 2068 616e 646c 655f  sync def handle_
+00016dc0: 6661 6365 626f 6f6b 5f75 6e73 656e 6428  facebook_unsend(
+00016dd0: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
+00016de0: 656e 6465 723a 2070 2e50 7570 7065 742c  ender: p.Puppet,
+00016df0: 206d 6573 7361 6765 5f69 643a 2073 7472   message_id: str
+00016e00: 2c20 7469 6d65 7374 616d 703a 2069 6e74  , timestamp: int
+00016e10: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00016e20: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00016e30: 656c 662e 6d78 6964 3a0a 2020 2020 2020  elf.mxid:.      
+00016e40: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00016e50: 2020 2020 2066 6f72 206d 6573 7361 6765       for message
+00016e60: 2069 6e20 6177 6169 7420 4442 4d65 7373   in await DBMess
+00016e70: 6167 652e 6765 745f 616c 6c5f 6279 5f66  age.get_all_by_f
+00016e80: 6269 6428 6d65 7373 6167 655f 6964 2c20  bid(message_id, 
+00016e90: 7365 6c66 2e66 625f 7265 6365 6976 6572  self.fb_receiver
+00016ea0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00016eb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00016ec0: 2020 2020 6177 6169 7420 7365 6e64 6572      await sender
+00016ed0: 2e69 6e74 656e 745f 666f 7228 7365 6c66  .intent_for(self
+00016ee0: 292e 7265 6461 6374 280a 2020 2020 2020  ).redact(.      
+00016ef0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00016f00: 7373 6167 652e 6d78 5f72 6f6f 6d2c 206d  ssage.mx_room, m
+00016f10: 6573 7361 6765 2e6d 7869 642c 2074 696d  essage.mxid, tim
+00016f20: 6573 7461 6d70 3d74 696d 6573 7461 6d70  estamp=timestamp
+00016f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016f40: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+00016f50: 7863 6570 7420 4d46 6f72 6269 6464 656e  xcept MForbidden
+00016f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016f70: 2020 6177 6169 7420 7365 6c66 2e6d 6169    await self.mai
+00016f80: 6e5f 696e 7465 6e74 2e72 6564 6163 7428  n_intent.redact(
+00016f90: 6d65 7373 6167 652e 6d78 5f72 6f6f 6d2c  message.mx_room,
+00016fa0: 206d 6573 7361 6765 2e6d 7869 642c 2074   message.mxid, t
+00016fb0: 696d 6573 7461 6d70 3d74 696d 6573 7461  imestamp=timesta
+00016fc0: 6d70 290a 2020 2020 2020 2020 2020 2020  mp).            
+00016fd0: 6177 6169 7420 6d65 7373 6167 652e 6465  await message.de
+00016fe0: 6c65 7465 2829 0a0a 2020 2020 6173 796e  lete()..    asyn
+00016ff0: 6320 6465 6620 6861 6e64 6c65 5f66 6163  c def handle_fac
+00017000: 6562 6f6f 6b5f 7365 656e 2873 656c 662c  ebook_seen(self,
+00017010: 2073 6f75 7263 653a 2075 2e55 7365 722c   source: u.User,
+00017020: 2073 656e 6465 723a 2070 2e50 7570 7065   sender: p.Puppe
+00017030: 742c 2074 696d 6573 7461 6d70 3a20 696e  t, timestamp: in
+00017040: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+00017050: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00017060: 6d78 6964 3a0a 2020 2020 2020 2020 2020  mxid:.          
+00017070: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00017080: 206d 7367 203d 2061 7761 6974 2044 424d   msg = await DBM
+00017090: 6573 7361 6765 2e67 6574 5f63 6c6f 7365  essage.get_close
+000170a0: 7374 5f62 6566 6f72 6528 7365 6c66 2e66  st_before(self.f
+000170b0: 6269 642c 2073 656c 662e 6662 5f72 6563  bid, self.fb_rec
+000170c0: 6569 7665 722c 2074 696d 6573 7461 6d70  eiver, timestamp
+000170d0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+000170e0: 206d 7367 3a0a 2020 2020 2020 2020 2020   msg:.          
+000170f0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00017100: 2069 6620 6e6f 7420 6177 6169 7420 7365   if not await se
+00017110: 6c66 2e5f 6272 6964 6765 5f6f 776e 5f6d  lf._bridge_own_m
+00017120: 6573 7361 6765 5f70 6d28 736f 7572 6365  essage_pm(source
+00017130: 2c20 7365 6e64 6572 2c20 2272 6561 6420  , sender, "read 
+00017140: 7265 6365 6970 7422 2c20 696e 7669 7465  receipt", invite
+00017150: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+00017160: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00017170: 2020 2020 2320 544f 444f 2063 616e 2077      # TODO can w
+00017180: 6520 7365 7420 6120 7469 6d65 7374 616d  e set a timestam
+00017190: 7020 7768 656e 2074 6865 2072 6561 6420  p when the read 
+000171a0: 7265 6365 6970 7420 6861 7070 656e 6564  receipt happened
+000171b0: 3f0a 2020 2020 2020 2020 6177 6169 7420  ?.        await 
+000171c0: 7365 6e64 6572 2e69 6e74 656e 745f 666f  sender.intent_fo
+000171d0: 7228 7365 6c66 292e 6d61 726b 5f72 6561  r(self).mark_rea
+000171e0: 6428 6d73 672e 6d78 5f72 6f6f 6d2c 206d  d(msg.mx_room, m
+000171f0: 7367 2e6d 7869 6429 0a20 2020 2020 2020  sg.mxid).       
+00017200: 2073 656c 662e 6c6f 672e 6465 6275 6728   self.log.debug(
+00017210: 0a20 2020 2020 2020 2020 2020 2066 2248  .            f"H
+00017220: 616e 646c 6564 204d 6573 7365 6e67 6572  andled Messenger
+00017230: 2072 6561 6420 7265 6365 6970 7420 6672   read receipt fr
+00017240: 6f6d 207b 7365 6e64 6572 2e66 6269 647d  om {sender.fbid}
+00017250: 2075 7020 746f 207b 7469 6d65 7374 616d   up to {timestam
+00017260: 707d 2f7b 6d73 672e 6d78 6964 7d22 0a20  p}/{msg.mxid}". 
+00017270: 2020 2020 2020 2029 0a0a 2020 2020 6173         )..    as
+00017280: 796e 6320 6465 6620 6861 6e64 6c65 5f66  ync def handle_f
+00017290: 6163 6562 6f6f 6b5f 7068 6f74 6f28 0a20  acebook_photo(. 
+000172a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000172b0: 2020 2020 2073 6f75 7263 653a 2075 2e55       source: u.U
+000172c0: 7365 722c 0a20 2020 2020 2020 2073 656e  ser,.        sen
+000172d0: 6465 723a 2070 2e50 7570 7065 742c 0a20  der: p.Puppet,. 
+000172e0: 2020 2020 2020 206e 6577 5f70 686f 746f         new_photo
+000172f0: 3a20 6d71 7474 2e41 7474 6163 686d 656e  : mqtt.Attachmen
+00017300: 742c 0a20 2020 2020 2020 206d 6573 7361  t,.        messa
+00017310: 6765 5f69 643a 2073 7472 2c0a 2020 2020  ge_id: str,.    
+00017320: 2020 2020 7469 6d65 7374 616d 703a 2069      timestamp: i
+00017330: 6e74 2c0a 2020 2020 2920 2d3e 204e 6f6e  nt,.    ) -> Non
+00017340: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
+00017350: 7420 7365 6c66 2e6d 7869 6420 6f72 2073  t self.mxid or s
+00017360: 656c 662e 6973 5f64 6972 6563 7420 6f72  elf.is_direct or
+00017370: 206d 6573 7361 6765 5f69 6420 696e 2073   message_id in s
+00017380: 656c 662e 5f64 6564 7570 3a0a 2020 2020  elf._dedup:.    
+00017390: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+000173a0: 2020 2020 2020 2073 656c 662e 5f64 6564         self._ded
+000173b0: 7570 2e61 7070 656e 646c 6566 7428 6d65  up.appendleft(me
+000173c0: 7373 6167 655f 6964 290a 2020 2020 2020  ssage_id).      
+000173d0: 2020 7068 6f74 6f5f 7572 6c20 3d20 6177    photo_url = aw
+000173e0: 6169 7420 736f 7572 6365 2e63 6c69 656e  ait source.clien
+000173f0: 742e 6765 745f 696d 6167 655f 7572 6c28  t.get_image_url(
+00017400: 6d65 7373 6167 655f 6964 2c20 6e65 775f  message_id, new_
+00017410: 7068 6f74 6f2e 6d65 6469 615f 6964 290a  photo.media_id).
+00017420: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+00017430: 686f 746f 5f75 726c 2061 6e64 206e 6577  hoto_url and new
+00017440: 5f70 686f 746f 2e69 6d61 6765 5f69 6e66  _photo.image_inf
+00017450: 6f2e 7572 695f 6d61 703a 0a20 2020 2020  o.uri_map:.     
+00017460: 2020 2020 2020 2070 686f 746f 5f75 726c         photo_url
+00017470: 203d 206c 6973 7428 6e65 775f 7068 6f74   = list(new_phot
+00017480: 6f2e 696d 6167 655f 696e 666f 2e75 7269  o.image_info.uri
+00017490: 5f6d 6170 2e76 616c 7565 7328 2929 5b2d  _map.values())[-
+000174a0: 315d 0a20 2020 2020 2020 2070 686f 746f  1].        photo
+000174b0: 5f69 6420 3d20 7365 6c66 2e67 6574 5f70  _id = self.get_p
+000174c0: 686f 746f 5f69 6428 7068 6f74 6f5f 7572  hoto_id(photo_ur
+000174d0: 6c29 0a20 2020 2020 2020 2069 6620 7365  l).        if se
+000174e0: 6c66 2e70 686f 746f 5f69 6420 3d3d 2070  lf.photo_id == p
+000174f0: 686f 746f 5f69 643a 0a20 2020 2020 2020  hoto_id:.       
+00017500: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00017510: 2020 2020 7365 6c66 2e70 686f 746f 5f69      self.photo_i
+00017520: 6420 3d20 7068 6f74 6f5f 6964 0a20 2020  d = photo_id.   
+00017530: 2020 2020 2073 656c 662e 6176 6174 6172       self.avatar
+00017540: 5f75 726c 2c20 2a5f 203d 2061 7761 6974  _url, *_ = await
+00017550: 2073 656c 662e 5f72 6575 706c 6f61 645f   self._reupload_
+00017560: 6662 5f66 696c 6528 7068 6f74 6f5f 7572  fb_file(photo_ur
+00017570: 6c2c 2073 6f75 7263 652c 2073 656e 6465  l, source, sende
+00017580: 722e 696e 7465 6e74 290a 2020 2020 2020  r.intent).      
+00017590: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000175a0: 2020 2065 7665 6e74 5f69 6420 3d20 6177     event_id = aw
+000175b0: 6169 7420 7365 6e64 6572 2e69 6e74 656e  ait sender.inten
+000175c0: 742e 7365 745f 726f 6f6d 5f61 7661 7461  t.set_room_avata
+000175d0: 7228 7365 6c66 2e6d 7869 642c 2073 656c  r(self.mxid, sel
+000175e0: 662e 6176 6174 6172 5f75 726c 290a 2020  f.avatar_url).  
+000175f0: 2020 2020 2020 6578 6365 7074 2049 6e74        except Int
+00017600: 656e 7445 7272 6f72 3a0a 2020 2020 2020  entError:.      
+00017610: 2020 2020 2020 6576 656e 745f 6964 203d        event_id =
+00017620: 2061 7761 6974 2073 656c 662e 6d61 696e   await self.main
+00017630: 5f69 6e74 656e 742e 7365 745f 726f 6f6d  _intent.set_room
+00017640: 5f61 7661 7461 7228 7365 6c66 2e6d 7869  _avatar(self.mxi
+00017650: 642c 2073 656c 662e 6176 6174 6172 5f75  d, self.avatar_u
+00017660: 726c 290a 2020 2020 2020 2020 6177 6169  rl).        awai
+00017670: 7420 7365 6c66 2e73 6176 6528 290a 2020  t self.save().  
+00017680: 2020 2020 2020 6177 6169 7420 4442 4d65        await DBMe
+00017690: 7373 6167 6528 0a20 2020 2020 2020 2020  ssage(.         
+000176a0: 2020 206d 7869 643d 6576 656e 745f 6964     mxid=event_id
+000176b0: 2c0a 2020 2020 2020 2020 2020 2020 6d78  ,.            mx
+000176c0: 5f72 6f6f 6d3d 7365 6c66 2e6d 7869 642c  _room=self.mxid,
+000176d0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+000176e0: 6578 3d30 2c0a 2020 2020 2020 2020 2020  ex=0,.          
+000176f0: 2020 7469 6d65 7374 616d 703d 7469 6d65    timestamp=time
+00017700: 7374 616d 702c 0a20 2020 2020 2020 2020  stamp,.         
+00017710: 2020 2066 6269 643d 6d65 7373 6167 655f     fbid=message_
+00017720: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00017730: 6662 5f63 6861 743d 7365 6c66 2e66 6269  fb_chat=self.fbi
+00017740: 642c 0a20 2020 2020 2020 2020 2020 2066  d,.            f
+00017750: 625f 7265 6365 6976 6572 3d73 656c 662e  b_receiver=self.
+00017760: 6662 5f72 6563 6569 7665 722c 0a20 2020  fb_receiver,.   
+00017770: 2020 2020 2020 2020 2066 625f 7365 6e64           fb_send
+00017780: 6572 3d73 656e 6465 722e 6662 6964 2c0a  er=sender.fbid,.
+00017790: 2020 2020 2020 2020 2020 2020 6662 5f74              fb_t
+000177a0: 786e 5f69 643d 4e6f 6e65 2c0a 2020 2020  xn_id=None,.    
+000177b0: 2020 2020 292e 696e 7365 7274 2829 0a20      ).insert(). 
+000177c0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+000177d0: 662e 7570 6461 7465 5f62 7269 6467 655f  f.update_bridge_
+000177e0: 696e 666f 2829 0a0a 2020 2020 6173 796e  info()..    asyn
+000177f0: 6320 6465 6620 6861 6e64 6c65 5f66 6163  c def handle_fac
+00017800: 6562 6f6f 6b5f 6e61 6d65 280a 2020 2020  ebook_name(.    
+00017810: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00017820: 2020 736f 7572 6365 3a20 752e 5573 6572    source: u.User
+00017830: 2c0a 2020 2020 2020 2020 7365 6e64 6572  ,.        sender
+00017840: 3a20 702e 5075 7070 6574 2c0a 2020 2020  : p.Puppet,.    
+00017850: 2020 2020 6e65 775f 6e61 6d65 3a20 7374      new_name: st
+00017860: 722c 0a20 2020 2020 2020 206d 6573 7361  r,.        messa
+00017870: 6765 5f69 643a 2073 7472 2c0a 2020 2020  ge_id: str,.    
+00017880: 2020 2020 7469 6d65 7374 616d 703a 2069      timestamp: i
+00017890: 6e74 2c0a 2020 2020 2920 2d3e 204e 6f6e  nt,.    ) -> Non
+000178a0: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
+000178b0: 6c66 2e6e 616d 6520 3d3d 206e 6577 5f6e  lf.name == new_n
+000178c0: 616d 6520 6f72 206d 6573 7361 6765 5f69  ame or message_i
+000178d0: 6420 696e 2073 656c 662e 5f64 6564 7570  d in self._dedup
+000178e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000178f0: 7475 726e 0a20 2020 2020 2020 2073 656c  turn.        sel
+00017900: 662e 5f64 6564 7570 2e61 7070 656e 646c  f._dedup.appendl
+00017910: 6566 7428 6d65 7373 6167 655f 6964 290a  eft(message_id).
+00017920: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
+00017930: 6520 3d20 6e65 775f 6e61 6d65 0a20 2020  e = new_name.   
+00017940: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00017950: 2e6d 7869 6420 6f72 2073 656c 662e 6973  .mxid or self.is
+00017960: 5f64 6972 6563 743a 0a20 2020 2020 2020  _direct:.       
+00017970: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00017980: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00017990: 2020 2020 2065 7665 6e74 5f69 6420 3d20       event_id = 
+000179a0: 6177 6169 7420 7365 6e64 6572 2e69 6e74  await sender.int
+000179b0: 656e 742e 7365 745f 726f 6f6d 5f6e 616d  ent.set_room_nam
+000179c0: 6528 7365 6c66 2e6d 7869 642c 2073 656c  e(self.mxid, sel
+000179d0: 662e 6e61 6d65 290a 2020 2020 2020 2020  f.name).        
+000179e0: 6578 6365 7074 2049 6e74 656e 7445 7272  except IntentErr
+000179f0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00017a00: 6576 656e 745f 6964 203d 2061 7761 6974  event_id = await
+00017a10: 2073 656c 662e 6d61 696e 5f69 6e74 656e   self.main_inten
+00017a20: 742e 7365 745f 726f 6f6d 5f6e 616d 6528  t.set_room_name(
+00017a30: 7365 6c66 2e6d 7869 642c 2073 656c 662e  self.mxid, self.
+00017a40: 6e61 6d65 290a 2020 2020 2020 2020 6177  name).        aw
+00017a50: 6169 7420 7365 6c66 2e73 6176 6528 290a  ait self.save().
+00017a60: 2020 2020 2020 2020 6177 6169 7420 4442          await DB
+00017a70: 4d65 7373 6167 6528 0a20 2020 2020 2020  Message(.       
+00017a80: 2020 2020 206d 7869 643d 6576 656e 745f       mxid=event_
+00017a90: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00017aa0: 6d78 5f72 6f6f 6d3d 7365 6c66 2e6d 7869  mx_room=self.mxi
+00017ab0: 642c 0a20 2020 2020 2020 2020 2020 2069  d,.            i
+00017ac0: 6e64 6578 3d30 2c0a 2020 2020 2020 2020  ndex=0,.        
+00017ad0: 2020 2020 7469 6d65 7374 616d 703d 7469      timestamp=ti
+00017ae0: 6d65 7374 616d 702c 0a20 2020 2020 2020  mestamp,.       
+00017af0: 2020 2020 2066 6269 643d 6d65 7373 6167       fbid=messag
+00017b00: 655f 6964 2c0a 2020 2020 2020 2020 2020  e_id,.          
+00017b10: 2020 6662 5f63 6861 743d 7365 6c66 2e66    fb_chat=self.f
+00017b20: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
+00017b30: 2066 625f 7265 6365 6976 6572 3d73 656c   fb_receiver=sel
+00017b40: 662e 6662 5f72 6563 6569 7665 722c 0a20  f.fb_receiver,. 
+00017b50: 2020 2020 2020 2020 2020 2066 625f 7365             fb_se
+00017b60: 6e64 6572 3d73 656e 6465 722e 6662 6964  nder=sender.fbid
+00017b70: 2c0a 2020 2020 2020 2020 2020 2020 6662  ,.            fb
+00017b80: 5f74 786e 5f69 643d 4e6f 6e65 2c0a 2020  _txn_id=None,.  
+00017b90: 2020 2020 2020 292e 696e 7365 7274 2829        ).insert()
+00017ba0: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+00017bb0: 656c 662e 7570 6461 7465 5f62 7269 6467  elf.update_bridg
+00017bc0: 655f 696e 666f 2829 0a0a 2020 2020 6173  e_info()..    as
+00017bd0: 796e 6320 6465 6620 6861 6e64 6c65 5f66  ync def handle_f
+00017be0: 6163 6562 6f6f 6b5f 7265 6163 7469 6f6e  acebook_reaction
+00017bf0: 5f61 6464 280a 2020 2020 2020 2020 7365  _add(.        se
+00017c00: 6c66 2c0a 2020 2020 2020 2020 736f 7572  lf,.        sour
+00017c10: 6365 3a20 752e 5573 6572 2c0a 2020 2020  ce: u.User,.    
+00017c20: 2020 2020 7365 6e64 6572 3a20 702e 5075      sender: p.Pu
+00017c30: 7070 6574 207c 2069 6e74 2c0a 2020 2020  ppet | int,.    
+00017c40: 2020 2020 6d65 7373 6167 655f 6964 3a20      message_id: 
+00017c50: 7374 722c 0a20 2020 2020 2020 2072 6561  str,.        rea
+00017c60: 6374 696f 6e3a 2073 7472 2c0a 2020 2020  ction: str,.    
+00017c70: 2020 2020 6578 6973 7469 6e67 3a20 4442      existing: DB
+00017c80: 5265 6163 7469 6f6e 207c 204e 6f6e 6520  Reaction | None 
+00017c90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00017ca0: 7461 7267 6574 5f6d 6573 7361 6765 3a20  target_message: 
+00017cb0: 4442 4d65 7373 6167 6520 7c20 4e6f 6e65  DBMessage | None
+00017cc0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00017cd0: 2074 696d 6573 7461 6d70 3a20 696e 7420   timestamp: int 
+00017ce0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00017cf0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00017d00: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00017d10: 6e63 6528 7365 6e64 6572 2c20 696e 7429  nce(sender, int)
+00017d20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00017d30: 6e64 6572 203d 2061 7761 6974 2070 2e50  nder = await p.P
+00017d40: 7570 7065 742e 6765 745f 6279 5f66 6269  uppet.get_by_fbi
+00017d50: 6428 7365 6e64 6572 290a 2020 2020 2020  d(sender).      
+00017d60: 2020 6465 6475 705f 6964 203d 2066 2272    dedup_id = f"r
+00017d70: 6561 6374 5f7b 6d65 7373 6167 655f 6964  eact_{message_id
+00017d80: 7d5f 7b73 656e 6465 722e 6662 6964 7d5f  }_{sender.fbid}_
+00017d90: 7b72 6561 6374 696f 6e7d 220a 2020 2020  {reaction}".    
+00017da0: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
+00017db0: 656c 662e 6f70 7469 6f6e 616c 5f73 656e  elf.optional_sen
+00017dc0: 645f 6c6f 636b 2873 656e 6465 722e 6662  d_lock(sender.fb
+00017dd0: 6964 293a 0a20 2020 2020 2020 2020 2020  id):.           
+00017de0: 2069 6620 6465 6475 705f 6964 2069 6e20   if dedup_id in 
+00017df0: 7365 6c66 2e5f 6465 6475 703a 0a20 2020  self._dedup:.   
+00017e00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00017e10: 662e 6c6f 672e 6465 6275 6728 6622 4967  f.log.debug(f"Ig
+00017e20: 6e6f 7269 6e67 2064 7570 6c69 6361 7465  noring duplicate
+00017e30: 2072 6561 6374 696f 6e20 6672 6f6d 207b   reaction from {
+00017e40: 7365 6e64 6572 2e66 6269 647d 2074 6f20  sender.fbid} to 
+00017e50: 7b6d 6573 7361 6765 5f69 647d 2229 0a20  {message_id}"). 
+00017e60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00017e70: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+00017e80: 2020 7365 6c66 2e5f 6465 6475 702e 6170    self._dedup.ap
+00017e90: 7065 6e64 6c65 6674 2864 6564 7570 5f69  pendleft(dedup_i
+00017ea0: 6429 0a0a 2020 2020 2020 2020 6966 206e  d)..        if n
+00017eb0: 6f74 2065 7869 7374 696e 673a 0a20 2020  ot existing:.   
+00017ec0: 2020 2020 2020 2020 2065 7869 7374 696e           existin
+00017ed0: 6720 3d20 6177 6169 7420 4442 5265 6163  g = await DBReac
+00017ee0: 7469 6f6e 2e67 6574 5f62 795f 6662 6964  tion.get_by_fbid
+00017ef0: 286d 6573 7361 6765 5f69 642c 2073 656c  (message_id, sel
+00017f00: 662e 6662 5f72 6563 6569 7665 722c 2073  f.fb_receiver, s
+00017f10: 656e 6465 722e 6662 6964 290a 2020 2020  ender.fbid).    
+00017f20: 2020 2020 2020 2020 6966 2065 7869 7374          if exist
+00017f30: 696e 6720 616e 6420 6578 6973 7469 6e67  ing and existing
+00017f40: 2e72 6561 6374 696f 6e20 3d3d 2072 6561  .reaction == rea
+00017f50: 6374 696f 6e3a 0a20 2020 2020 2020 2020  ction:.         
+00017f60: 2020 2020 2020 2073 656c 662e 6c6f 672e         self.log.
+00017f70: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00017f80: 2020 2020 2020 2020 2020 2066 2249 676e             f"Ign
+00017f90: 6f72 696e 6720 6475 706c 6963 6174 6520  oring duplicate 
+00017fa0: 7265 6163 7469 6f6e 2066 726f 6d20 7b73  reaction from {s
+00017fb0: 656e 6465 722e 6662 6964 7d20 746f 207b  ender.fbid} to {
+00017fc0: 6d65 7373 6167 655f 6964 7d20 2864 6220  message_id} (db 
+00017fd0: 6368 6563 6b29 220a 2020 2020 2020 2020  check)".        
+00017fe0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00017ff0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00018000: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00018010: 2061 7761 6974 2073 656c 662e 5f62 7269   await self._bri
+00018020: 6467 655f 6f77 6e5f 6d65 7373 6167 655f  dge_own_message_
+00018030: 706d 2873 6f75 7263 652c 2073 656e 6465  pm(source, sende
+00018040: 722c 2066 2272 6561 6374 696f 6e20 746f  r, f"reaction to
+00018050: 207b 6d65 7373 6167 655f 6964 7d22 293a   {message_id}"):
+00018060: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00018070: 7572 6e0a 0a20 2020 2020 2020 2069 6e74  urn..        int
+00018080: 656e 7420 3d20 7365 6e64 6572 2e69 6e74  ent = sender.int
+00018090: 656e 745f 666f 7228 7365 6c66 290a 0a20  ent_for(self).. 
+000180a0: 2020 2020 2020 2069 6620 6e6f 7420 7461         if not ta
+000180b0: 7267 6574 5f6d 6573 7361 6765 3a0a 2020  rget_message:.  
+000180c0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+000180d0: 5f6d 6573 7361 6765 203d 2061 7761 6974  _message = await
+000180e0: 2044 424d 6573 7361 6765 2e67 6574 5f62   DBMessage.get_b
+000180f0: 795f 6662 6964 286d 6573 7361 6765 5f69  y_fbid(message_i
+00018100: 642c 2073 656c 662e 6662 5f72 6563 6569  d, self.fb_recei
+00018110: 7665 7229 0a20 2020 2020 2020 2069 6620  ver).        if 
+00018120: 6e6f 7420 7461 7267 6574 5f6d 6573 7361  not target_messa
+00018130: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+00018140: 7365 6c66 2e6c 6f67 2e64 6562 7567 2866  self.log.debug(f
+00018150: 2249 676e 6f72 696e 6720 7265 6163 7469  "Ignoring reacti
+00018160: 6f6e 2066 726f 6d20 7b73 656e 6465 722e  on from {sender.
+00018170: 6662 6964 7d20 746f 2075 6e6b 6e6f 776e  fbid} to unknown
+00018180: 206d 6573 7361 6765 207b 6d65 7373 6167   message {messag
+00018190: 655f 6964 7d22 290a 2020 2020 2020 2020  e_id}").        
+000181a0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+000181b0: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+000181c0: 7469 6d65 7374 616d 7020 6f72 2069 6e74  timestamp or int
+000181d0: 2874 696d 652e 7469 6d65 2829 202a 2031  (time.time() * 1
+000181e0: 3030 3029 0a20 2020 2020 2020 206d 7869  000).        mxi
+000181f0: 6420 3d20 6177 6169 7420 696e 7465 6e74  d = await intent
+00018200: 2e72 6561 6374 280a 2020 2020 2020 2020  .react(.        
+00018210: 2020 2020 726f 6f6d 5f69 643d 7461 7267      room_id=targ
+00018220: 6574 5f6d 6573 7361 6765 2e6d 785f 726f  et_message.mx_ro
+00018230: 6f6d 2c0a 2020 2020 2020 2020 2020 2020  om,.            
+00018240: 6576 656e 745f 6964 3d74 6172 6765 745f  event_id=target_
+00018250: 6d65 7373 6167 652e 6d78 6964 2c0a 2020  message.mxid,.  
+00018260: 2020 2020 2020 2020 2020 6b65 793d 7661            key=va
+00018270: 7269 6174 696f 6e5f 7365 6c65 6374 6f72  riation_selector
+00018280: 2e61 6464 2872 6561 6374 696f 6e29 2c0a  .add(reaction),.
+00018290: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000182a0: 7374 616d 703d 7469 6d65 7374 616d 702c  stamp=timestamp,
+000182b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000182c0: 2020 2073 656c 662e 6c6f 672e 6465 6275     self.log.debu
+000182d0: 6728 6622 7b73 656e 6465 722e 6662 6964  g(f"{sender.fbid
+000182e0: 7d20 7265 6163 7465 6420 746f 207b 7461  } reacted to {ta
+000182f0: 7267 6574 5f6d 6573 7361 6765 2e6d 7869  rget_message.mxi
+00018300: 647d 2028 7b6d 6573 7361 6765 5f69 647d  d} ({message_id}
+00018310: 2920 2d3e 207b 6d78 6964 7d22 290a 0a20  ) -> {mxid}").. 
+00018320: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+00018330: 662e 5f75 7073 6572 745f 7265 6163 7469  f._upsert_reacti
+00018340: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00018350: 6578 6973 7469 6e67 2c20 696e 7465 6e74  existing, intent
+00018360: 2c20 6d78 6964 2c20 7461 7267 6574 5f6d  , mxid, target_m
+00018370: 6573 7361 6765 2c20 7365 6e64 6572 2c20  essage, sender, 
+00018380: 7265 6163 7469 6f6e 2c20 7469 6d65 7374  reaction, timest
+00018390: 616d 700a 2020 2020 2020 2020 290a 0a20  amp.        ).. 
+000183a0: 2020 2061 7379 6e63 2064 6566 205f 7570     async def _up
+000183b0: 7365 7274 5f72 6561 6374 696f 6e28 0a20  sert_reaction(. 
+000183c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000183d0: 2020 2020 2065 7869 7374 696e 673a 2044       existing: D
+000183e0: 4252 6561 6374 696f 6e20 7c20 4e6f 6e65  BReaction | None
+000183f0: 2c0a 2020 2020 2020 2020 696e 7465 6e74  ,.        intent
+00018400: 3a20 496e 7465 6e74 4150 492c 0a20 2020  : IntentAPI,.   
+00018410: 2020 2020 206d 7869 643a 2045 7665 6e74       mxid: Event
+00018420: 4944 2c0a 2020 2020 2020 2020 6d65 7373  ID,.        mess
+00018430: 6167 653a 2044 424d 6573 7361 6765 2c0a  age: DBMessage,.
+00018440: 2020 2020 2020 2020 7365 6e64 6572 3a20          sender: 
+00018450: 752e 5573 6572 207c 2070 2e50 7570 7065  u.User | p.Puppe
+00018460: 742c 0a20 2020 2020 2020 2072 6561 6374  t,.        react
+00018470: 696f 6e3a 2073 7472 2c0a 2020 2020 2020  ion: str,.      
+00018480: 2020 6d78 5f74 696d 6573 7461 6d70 3a20    mx_timestamp: 
+00018490: 696e 742c 0a20 2020 2029 202d 3e20 4e6f  int,.    ) -> No
+000184a0: 6e65 3a0a 2020 2020 2020 2020 6966 2065  ne:.        if e
+000184b0: 7869 7374 696e 673a 0a20 2020 2020 2020  xisting:.       
+000184c0: 2020 2020 2073 656c 662e 6c6f 672e 6465       self.log.de
+000184d0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+000184e0: 2020 2020 2066 225f 7570 7365 7274 5f72       f"_upsert_r
+000184f0: 6561 6374 696f 6e20 7265 6461 6374 696e  eaction redactin
+00018500: 6720 7b65 7869 7374 696e 672e 6d78 6964  g {existing.mxid
+00018510: 7d20 616e 6420 696e 7365 7274 696e 6720  } and inserting 
+00018520: 7b6d 7869 647d 220a 2020 2020 2020 2020  {mxid}".        
+00018530: 2020 2020 2020 2020 6622 2028 6d65 7373          f" (mess
+00018540: 6167 653a 207b 6d65 7373 6167 652e 6d78  age: {message.mx
+00018550: 6964 7d29 220a 2020 2020 2020 2020 2020  id})".          
+00018560: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00018570: 6177 6169 7420 696e 7465 6e74 2e72 6564  await intent.red
+00018580: 6163 7428 6578 6973 7469 6e67 2e6d 785f  act(existing.mx_
+00018590: 726f 6f6d 2c20 6578 6973 7469 6e67 2e6d  room, existing.m
+000185a0: 7869 6429 0a20 2020 2020 2020 2020 2020  xid).           
+000185b0: 2065 7869 7374 696e 672e 7265 6163 7469   existing.reacti
+000185c0: 6f6e 203d 2072 6561 6374 696f 6e0a 2020  on = reaction.  
+000185d0: 2020 2020 2020 2020 2020 6578 6973 7469            existi
+000185e0: 6e67 2e6d 7869 6420 3d20 6d78 6964 0a20  ng.mxid = mxid. 
+000185f0: 2020 2020 2020 2020 2020 2065 7869 7374             exist
+00018600: 696e 672e 6d78 5f72 6f6f 6d20 3d20 6d65  ing.mx_room = me
+00018610: 7373 6167 652e 6d78 5f72 6f6f 6d0a 2020  ssage.mx_room.  
+00018620: 2020 2020 2020 2020 2020 6578 6973 7469            existi
+00018630: 6e67 2e6d 785f 7469 6d65 7374 616d 7020  ng.mx_timestamp 
+00018640: 3d20 6d78 5f74 696d 6573 7461 6d70 0a20  = mx_timestamp. 
+00018650: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00018660: 2065 7869 7374 696e 672e 7361 7665 2829   existing.save()
+00018670: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00018680: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00018690: 6c6f 672e 6465 6275 6728 6622 5f75 7073  log.debug(f"_ups
+000186a0: 6572 745f 7265 6163 7469 6f6e 2069 6e73  ert_reaction ins
+000186b0: 6572 7469 6e67 207b 6d78 6964 7d20 286d  erting {mxid} (m
+000186c0: 6573 7361 6765 3a20 7b6d 6573 7361 6765  essage: {message
+000186d0: 2e6d 7869 647d 2922 290a 2020 2020 2020  .mxid})").      
+000186e0: 2020 2020 2020 6177 6169 7420 4442 5265        await DBRe
+000186f0: 6163 7469 6f6e 280a 2020 2020 2020 2020  action(.        
+00018700: 2020 2020 2020 2020 6d78 6964 3d6d 7869          mxid=mxi
+00018710: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00018720: 2020 206d 785f 726f 6f6d 3d6d 6573 7361     mx_room=messa
+00018730: 6765 2e6d 785f 726f 6f6d 2c0a 2020 2020  ge.mx_room,.    
+00018740: 2020 2020 2020 2020 2020 2020 6662 5f6d              fb_m
+00018750: 7367 6964 3d6d 6573 7361 6765 2e66 6269  sgid=message.fbi
+00018760: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00018770: 2020 2066 625f 7265 6365 6976 6572 3d73     fb_receiver=s
+00018780: 656c 662e 6662 5f72 6563 6569 7665 722c  elf.fb_receiver,
+00018790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000187a0: 2066 625f 7365 6e64 6572 3d73 656e 6465   fb_sender=sende
+000187b0: 722e 6662 6964 2c0a 2020 2020 2020 2020  r.fbid,.        
+000187c0: 2020 2020 2020 2020 7265 6163 7469 6f6e          reaction
+000187d0: 3d72 6561 6374 696f 6e2c 0a20 2020 2020  =reaction,.     
+000187e0: 2020 2020 2020 2020 2020 206d 785f 7469             mx_ti
+000187f0: 6d65 7374 616d 703d 6d78 5f74 696d 6573  mestamp=mx_times
+00018800: 7461 6d70 2c0a 2020 2020 2020 2020 2020  tamp,.          
+00018810: 2020 292e 696e 7365 7274 2829 0a0a 2020    ).insert()..  
+00018820: 2020 6173 796e 6320 6465 6620 6861 6e64    async def hand
+00018830: 6c65 5f66 6163 6562 6f6f 6b5f 7265 6163  le_facebook_reac
+00018840: 7469 6f6e 5f72 656d 6f76 6528 0a20 2020  tion_remove(.   
+00018850: 2020 2020 2073 656c 662c 2073 6f75 7263       self, sourc
+00018860: 653a 2075 2e55 7365 722c 2073 656e 6465  e: u.User, sende
+00018870: 723a 2070 2e50 7570 7065 7420 7c20 696e  r: p.Puppet | in
+00018880: 742c 2074 6172 6765 743a 2073 7472 207c  t, target: str |
+00018890: 2044 4252 6561 6374 696f 6e0a 2020 2020   DBReaction.    
+000188a0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000188b0: 2020 2069 6620 6e6f 7420 7365 6c66 2e6d     if not self.m
+000188c0: 7869 643a 0a20 2020 2020 2020 2020 2020  xid:.           
+000188d0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+000188e0: 6966 2069 7369 6e73 7461 6e63 6528 7365  if isinstance(se
+000188f0: 6e64 6572 2c20 696e 7429 3a0a 2020 2020  nder, int):.    
+00018900: 2020 2020 2020 2020 7365 6e64 6572 203d          sender =
+00018910: 2061 7761 6974 2070 2e50 7570 7065 742e   await p.Puppet.
+00018920: 6765 745f 6279 5f66 6269 6428 7365 6e64  get_by_fbid(send
+00018930: 6572 290a 2020 2020 2020 2020 6966 2069  er).        if i
+00018940: 7369 6e73 7461 6e63 6528 7461 7267 6574  sinstance(target
+00018950: 2c20 4442 5265 6163 7469 6f6e 293a 0a20  , DBReaction):. 
+00018960: 2020 2020 2020 2020 2020 2072 6561 6374             react
+00018970: 696f 6e20 3d20 7461 7267 6574 0a20 2020  ion = target.   
+00018980: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00018990: 2020 2020 2020 2072 6561 6374 696f 6e20         reaction 
+000189a0: 3d20 6177 6169 7420 4442 5265 6163 7469  = await DBReacti
+000189b0: 6f6e 2e67 6574 5f62 795f 6662 6964 2874  on.get_by_fbid(t
+000189c0: 6172 6765 742c 2073 656c 662e 6662 5f72  arget, self.fb_r
+000189d0: 6563 6569 7665 722c 2073 656e 6465 722e  eceiver, sender.
+000189e0: 6662 6964 290a 2020 2020 2020 2020 6966  fbid).        if
+000189f0: 2072 6561 6374 696f 6e3a 0a20 2020 2020   reaction:.     
+00018a00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00018a10: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00018a20: 7420 7365 6e64 6572 2e69 6e74 656e 745f  t sender.intent_
+00018a30: 666f 7228 7365 6c66 292e 7265 6461 6374  for(self).redact
+00018a40: 2872 6561 6374 696f 6e2e 6d78 5f72 6f6f  (reaction.mx_roo
+00018a50: 6d2c 2072 6561 6374 696f 6e2e 6d78 6964  m, reaction.mxid
+00018a60: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00018a70: 6365 7074 204d 466f 7262 6964 6465 6e3a  cept MForbidden:
+00018a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a90: 2061 7761 6974 2073 656c 662e 6d61 696e   await self.main
+00018aa0: 5f69 6e74 656e 742e 7265 6461 6374 2872  _intent.redact(r
+00018ab0: 6561 6374 696f 6e2e 6d78 5f72 6f6f 6d2c  eaction.mx_room,
+00018ac0: 2072 6561 6374 696f 6e2e 6d78 6964 290a   reaction.mxid).
+00018ad0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00018ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018af0: 2073 656c 662e 5f64 6564 7570 2e72 656d   self._dedup.rem
+00018b00: 6f76 6528 6622 7265 6163 745f 7b72 6561  ove(f"react_{rea
+00018b10: 6374 696f 6e2e 6662 5f6d 7367 6964 7d5f  ction.fb_msgid}_
+00018b20: 7b73 656e 6465 722e 6662 6964 7d5f 7b72  {sender.fbid}_{r
+00018b30: 6561 6374 696f 6e2e 7265 6163 7469 6f6e  eaction.reaction
+00018b40: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+00018b50: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
+00018b60: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00018b70: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00018b80: 2020 2020 6177 6169 7420 7265 6163 7469      await reacti
+00018b90: 6f6e 2e64 656c 6574 6528 290a 0a20 2020  on.delete()..   
+00018ba0: 2061 7379 6e63 2064 6566 2068 616e 646c   async def handl
+00018bb0: 655f 6661 6365 626f 6f6b 5f70 6f6c 6c28  e_facebook_poll(
+00018bc0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00018bd0: 2020 2020 2020 2073 656e 6465 723a 2070         sender: p
+00018be0: 2e50 7570 7065 742c 0a20 2020 2020 2020  .Puppet,.       
+00018bf0: 2074 6872 6561 645f 6368 616e 6765 3a20   thread_change: 
+00018c00: 6d71 7474 2e54 6872 6561 6443 6861 6e67  mqtt.ThreadChang
+00018c10: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+00018c20: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00018c30: 2073 656c 662e 6d78 6964 3a0a 2020 2020   self.mxid:.    
+00018c40: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00018c50: 2020 2020 2020 2020 6966 2074 6872 6561          if threa
+00018c60: 645f 6368 616e 6765 2e61 6374 696f 6e5f  d_change.action_
+00018c70: 6461 7461 5b22 6576 656e 745f 7479 7065  data["event_type
+00018c80: 225d 2021 3d20 2271 7565 7374 696f 6e5f  "] != "question_
+00018c90: 6372 6561 7469 6f6e 223a 0a20 2020 2020  creation":.     
+00018ca0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00018cb0: 2020 2020 2020 2071 7565 7374 696f 6e5f         question_
+00018cc0: 6a73 6f6e 203d 206a 736f 6e2e 6c6f 6164  json = json.load
+00018cd0: 7328 7468 7265 6164 5f63 6861 6e67 652e  s(thread_change.
+00018ce0: 6163 7469 6f6e 5f64 6174 612e 6765 7428  action_data.get(
+00018cf0: 2271 7565 7374 696f 6e5f 6a73 6f6e 2229  "question_json")
+00018d00: 290a 2020 2020 2020 2020 6f70 7469 6f6e  ).        option
+00018d10: 735f 6874 6d6c 203d 2022 222e 6a6f 696e  s_html = "".join
+00018d20: 2866 223c 6c69 3e7b 6f5b 2774 6578 7427  (f"<li>{o['text'
+00018d30: 5d7d 3c2f 6c69 3e22 2066 6f72 206f 2069  ]}</li>" for o i
+00018d40: 6e20 7175 6573 7469 6f6e 5f6a 736f 6e2e  n question_json.
+00018d50: 6765 7428 226f 7074 696f 6e73 2229 290a  get("options")).
+00018d60: 2020 2020 2020 2020 6874 6d6c 203d 2066          html = f
+00018d70: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+00018d80: 3c62 3e50 6f6c 6c3a 207b 7175 6573 7469  <b>Poll: {questi
+00018d90: 6f6e 5f6a 736f 6e2e 6765 7428 2274 6578  on_json.get("tex
+00018da0: 7422 297d 3c2f 623e 3c62 723e 0a20 2020  t")}</b><br>.   
+00018db0: 2020 2020 2020 2020 204f 7074 696f 6e73           Options
+00018dc0: 3a0a 2020 2020 2020 2020 2020 2020 3c75  :.            <u
+00018dd0: 6c3e 7b6f 7074 696f 6e73 5f68 746d 6c7d  l>{options_html}
+00018de0: 3c2f 756c 3e0a 2020 2020 2020 2020 2020  </ul>.          
+00018df0: 2020 4f70 656e 2046 6163 6562 6f6f 6b20    Open Facebook 
+00018e00: 4d65 7373 656e 6765 7220 746f 2076 6f74  Messenger to vot
+00018e10: 652e 0a20 2020 2020 2020 2022 2222 2e73  e..        """.s
+00018e20: 7472 6970 2829 0a0a 2020 2020 2020 2020  trip()..        
+00018e30: 6177 6169 7420 7365 6c66 2e5f 7365 6e64  await self._send
+00018e40: 5f6d 6573 7361 6765 280a 2020 2020 2020  _message(.      
+00018e50: 2020 2020 2020 7365 6e64 6572 2e69 6e74        sender.int
+00018e60: 656e 745f 666f 7228 7365 6c66 292c 0a20  ent_for(self),. 
+00018e70: 2020 2020 2020 2020 2020 2054 6578 744d             TextM
+00018e80: 6573 7361 6765 4576 656e 7443 6f6e 7465  essageEventConte
+00018e90: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+00018ea0: 2020 2020 6d73 6774 7970 653d 4d65 7373      msgtype=Mess
+00018eb0: 6167 6554 7970 652e 5445 5854 2c0a 2020  ageType.TEXT,.  
+00018ec0: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+00018ed0: 6479 3d61 7761 6974 2070 6172 7365 5f68  dy=await parse_h
+00018ee0: 746d 6c28 6874 6d6c 292c 0a20 2020 2020  tml(html),.     
+00018ef0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00018f00: 743d 466f 726d 6174 2e48 544d 4c2c 0a20  t=Format.HTML,. 
+00018f10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018f20: 6f72 6d61 7474 6564 5f62 6f64 793d 6874  ormatted_body=ht
+00018f30: 6d6c 2c0a 2020 2020 2020 2020 2020 2020  ml,.            
+00018f40: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+00018f50: 2020 7269 6e67 696e 673a 2062 6f6f 6c20    ringing: bool 
+00018f60: 3d20 4661 6c73 650a 0a20 2020 2061 7379  = False..    asy
+00018f70: 6e63 2064 6566 2068 616e 646c 655f 6661  nc def handle_fa
+00018f80: 6365 626f 6f6b 5f63 616c 6c28 7365 6c66  cebook_call(self
+00018f90: 2c20 7365 6e64 6572 3a20 702e 5075 7070  , sender: p.Pupp
+00018fa0: 6574 2920 2d3e 204e 6f6e 653a 0a20 2020  et) -> None:.   
+00018fb0: 2020 2020 2069 6620 7365 6c66 2e72 696e       if self.rin
+00018fc0: 6769 6e67 3a0a 2020 2020 2020 2020 2020  ging:.          
+00018fd0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00018fe0: 2020 7365 6c66 2e72 696e 6769 6e67 203d    self.ringing =
+00018ff0: 2054 7275 650a 2020 2020 2020 2020 6874   True.        ht
+00019000: 6d6c 203d 2066 223c 623e 5374 6172 7465  ml = f"<b>Starte
+00019010: 6420 6120 6361 6c6c 2e3c 2f62 3e20 4f70  d a call.</b> Op
+00019020: 656e 2046 6163 6562 6f6f 6b20 4d65 7373  en Facebook Mess
+00019030: 656e 6765 7220 746f 2061 6e73 7765 722e  enger to answer.
+00019040: 220a 2020 2020 2020 2020 6177 6169 7420  ".        await 
+00019050: 7365 6c66 2e5f 7365 6e64 5f6d 6573 7361  self._send_messa
+00019060: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
+00019070: 7365 6e64 6572 2e69 6e74 656e 745f 666f  sender.intent_fo
+00019080: 7228 7365 6c66 292c 0a20 2020 2020 2020  r(self),.       
+00019090: 2020 2020 2054 6578 744d 6573 7361 6765       TextMessage
+000190a0: 4576 656e 7443 6f6e 7465 6e74 280a 2020  EventContent(.  
+000190b0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+000190c0: 6774 7970 653d 4d65 7373 6167 6554 7970  gtype=MessageTyp
+000190d0: 652e 5445 5854 2c0a 2020 2020 2020 2020  e.TEXT,.        
+000190e0: 2020 2020 2020 2020 626f 6479 3d61 7761          body=awa
+000190f0: 6974 2070 6172 7365 5f68 746d 6c28 6874  it parse_html(ht
+00019100: 6d6c 292c 0a20 2020 2020 2020 2020 2020  ml),.           
+00019110: 2020 2020 2066 6f72 6d61 743d 466f 726d       format=Form
+00019120: 6174 2e48 544d 4c2c 0a20 2020 2020 2020  at.HTML,.       
+00019130: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
+00019140: 6564 5f62 6f64 793d 6874 6d6c 2c0a 2020  ed_body=html,.  
+00019150: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00019160: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+00019170: 6320 6465 6620 6861 6e64 6c65 5f66 6163  c def handle_fac
+00019180: 6562 6f6f 6b5f 6361 6c6c 5f68 616e 6775  ebook_call_hangu
+00019190: 7028 7365 6c66 2920 2d3e 204e 6f6e 653a  p(self) -> None:
+000191a0: 0a20 2020 2020 2020 2073 656c 662e 7269  .        self.ri
+000191b0: 6e67 696e 6720 3d20 4661 6c73 650a 0a20  nging = False.. 
+000191c0: 2020 2061 7379 6e63 2064 6566 2068 616e     async def han
+000191d0: 646c 655f 6661 6365 626f 6f6b 5f67 726f  dle_facebook_gro
+000191e0: 7570 5f63 616c 6c28 0a20 2020 2020 2020  up_call(.       
+000191f0: 2073 656c 662c 2073 656e 6465 723a 2070   self, sender: p
+00019200: 2e50 7570 7065 742c 2074 6872 6561 645f  .Puppet, thread_
+00019210: 6368 616e 6765 3a20 6d71 7474 2e54 6872  change: mqtt.Thr
+00019220: 6561 6443 6861 6e67 650a 2020 2020 2920  eadChange.    ) 
+00019230: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00019240: 2069 6620 6e6f 7420 7365 6c66 2e6d 7869   if not self.mxi
+00019250: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00019260: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
+00019270: 6620 7468 7265 6164 5f63 6861 6e67 652e  f thread_change.
+00019280: 6163 7469 6f6e 5f64 6174 615b 2265 7665  action_data["eve
+00019290: 6e74 225d 2021 3d20 2267 726f 7570 5f63  nt"] != "group_c
+000192a0: 616c 6c5f 7374 6172 7465 6422 3a0a 2020  all_started":.  
+000192b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000192c0: 0a0a 2020 2020 2020 2020 6361 6c6c 5f74  ..        call_t
+000192d0: 7970 6520 3d20 2276 6964 656f 2220 6966  ype = "video" if
+000192e0: 2074 6872 6561 645f 6368 616e 6765 2e61   thread_change.a
+000192f0: 6374 696f 6e5f 6461 7461 5b22 7669 6465  ction_data["vide
+00019300: 6f22 5d20 3d3d 2022 3122 2065 6c73 6520  o"] == "1" else 
+00019310: 2261 7564 696f 220a 2020 2020 2020 2020  "audio".        
+00019320: 6874 6d6c 203d 2066 223c 623e 5374 6172  html = f"<b>Star
+00019330: 7465 6420 6120 6772 6f75 7020 7b63 616c  ted a group {cal
+00019340: 6c5f 7479 7065 7d20 6361 6c6c 2e3c 2f62  l_type} call.</b
+00019350: 3e20 4f70 656e 2046 6163 6562 6f6f 6b20  > Open Facebook 
+00019360: 4d65 7373 656e 6765 7220 746f 2061 6e73  Messenger to ans
+00019370: 7765 722e 220a 0a20 2020 2020 2020 2061  wer."..        a
+00019380: 7761 6974 2073 656c 662e 5f73 656e 645f  wait self._send_
+00019390: 6d65 7373 6167 6528 0a20 2020 2020 2020  message(.       
+000193a0: 2020 2020 2073 656e 6465 722e 696e 7465       sender.inte
+000193b0: 6e74 5f66 6f72 2873 656c 6629 2c0a 2020  nt_for(self),.  
+000193c0: 2020 2020 2020 2020 2020 5465 7874 4d65            TextMe
+000193d0: 7373 6167 6545 7665 6e74 436f 6e74 656e  ssageEventConten
+000193e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000193f0: 2020 206d 7367 7479 7065 3d4d 6573 7361     msgtype=Messa
+00019400: 6765 5479 7065 2e54 4558 542c 0a20 2020  geType.TEXT,.   
+00019410: 2020 2020 2020 2020 2020 2020 2062 6f64               bod
+00019420: 793d 6177 6169 7420 7061 7273 655f 6874  y=await parse_ht
+00019430: 6d6c 2868 746d 6c29 2c0a 2020 2020 2020  ml(html),.      
+00019440: 2020 2020 2020 2020 2020 666f 726d 6174            format
+00019450: 3d46 6f72 6d61 742e 4854 4d4c 2c0a 2020  =Format.HTML,.  
+00019460: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019470: 726d 6174 7465 645f 626f 6479 3d68 746d  rmatted_body=htm
+00019480: 6c2c 0a20 2020 2020 2020 2020 2020 2029  l,.            )
+00019490: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000194a0: 2061 7379 6e63 2064 6566 2068 616e 646c   async def handl
+000194b0: 655f 6661 6365 626f 6f6b 5f6a 6f69 6e28  e_facebook_join(
+000194c0: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
+000194d0: 6f75 7263 653a 2075 2e55 7365 722c 2073  ource: u.User, s
+000194e0: 656e 6465 723a 2070 2e50 7570 7065 742c  ender: p.Puppet,
+000194f0: 2075 7365 7273 3a20 6c69 7374 5b70 2e50   users: list[p.P
+00019500: 7570 7065 745d 0a20 2020 2029 202d 3e20  uppet].    ) -> 
+00019510: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00019520: 6e64 6572 5f69 6e74 656e 7420 3d20 7365  nder_intent = se
+00019530: 6e64 6572 2e69 6e74 656e 745f 666f 7228  nder.intent_for(
+00019540: 7365 6c66 290a 2020 2020 2020 2020 666f  self).        fo
+00019550: 7220 7573 6572 2069 6e20 7573 6572 733a  r user in users:
+00019560: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00019570: 6974 2073 656e 6465 725f 696e 7465 6e74  it sender_intent
+00019580: 2e69 6e76 6974 655f 7573 6572 2873 656c  .invite_user(sel
+00019590: 662e 6d78 6964 2c20 7573 6572 2e6d 7869  f.mxid, user.mxi
+000195a0: 6429 0a20 2020 2020 2020 2020 2020 2061  d).            a
+000195b0: 7761 6974 2075 7365 722e 696e 7465 6e74  wait user.intent
+000195c0: 5f66 6f72 2873 656c 6629 2e6a 6f69 6e5f  _for(self).join_
+000195d0: 726f 6f6d 5f62 795f 6964 2873 656c 662e  room_by_id(self.
+000195e0: 6d78 6964 290a 2020 2020 2020 2020 2020  mxid).          
+000195f0: 2020 6966 206e 6f74 2075 7365 722e 6e61    if not user.na
+00019600: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
+00019610: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+00019620: 655f 7265 7379 6e63 2873 6f75 7263 652c  e_resync(source,
+00019630: 2075 7365 7229 0a0a 2020 2020 6173 796e   user)..    asyn
+00019640: 6320 6465 6620 6861 6e64 6c65 5f66 6163  c def handle_fac
+00019650: 6562 6f6f 6b5f 6c65 6176 6528 0a20 2020  ebook_leave(.   
+00019660: 2020 2020 2073 656c 662c 2073 6f75 7263       self, sourc
+00019670: 653a 2075 2e55 7365 722c 2073 656e 6465  e: u.User, sende
+00019680: 723a 2070 2e50 7570 7065 742c 2072 656d  r: p.Puppet, rem
+00019690: 6f76 6564 3a20 702e 5075 7070 6574 0a20  oved: p.Puppet. 
+000196a0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+000196b0: 2020 2020 2020 6966 2073 656e 6465 7220        if sender 
+000196c0: 3d3d 2072 656d 6f76 6564 3a0a 2020 2020  == removed:.    
+000196d0: 2020 2020 2020 2020 6177 6169 7420 7265          await re
+000196e0: 6d6f 7665 642e 696e 7465 6e74 5f66 6f72  moved.intent_for
+000196f0: 2873 656c 6629 2e6c 6561 7665 5f72 6f6f  (self).leave_roo
+00019700: 6d28 7365 6c66 2e6d 7869 6429 0a20 2020  m(self.mxid).   
+00019710: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00019720: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00019730: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00019740: 7420 7365 6e64 6572 2e69 6e74 656e 745f  t sender.intent_
+00019750: 666f 7228 7365 6c66 292e 6b69 636b 5f75  for(self).kick_u
+00019760: 7365 7228 7365 6c66 2e6d 7869 642c 2072  ser(self.mxid, r
+00019770: 656d 6f76 6564 2e6d 7869 6429 0a20 2020  emoved.mxid).   
+00019780: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00019790: 4d46 6f72 6269 6464 656e 3a0a 2020 2020  MForbidden:.    
+000197a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000197b0: 7420 7365 6c66 2e6d 6169 6e5f 696e 7465  t self.main_inte
+000197c0: 6e74 2e6b 6963 6b5f 7573 6572 280a 2020  nt.kick_user(.  
+000197d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000197e0: 2020 7365 6c66 2e6d 7869 642c 2072 656d    self.mxid, rem
+000197f0: 6f76 6564 2e6d 7869 642c 2072 6561 736f  oved.mxid, reaso
+00019800: 6e3d 6622 4b69 636b 6564 2062 7920 7b73  n=f"Kicked by {s
+00019810: 656e 6465 722e 6e61 6d65 7d22 0a20 2020  ender.name}".   
+00019820: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00019830: 2020 2020 2320 656e 6472 6567 696f 6e0a      # endregion.
+00019840: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
+00019850: 616e 646c 655f 666f 7263 6564 5f66 6574  andle_forced_fet
+00019860: 6368 2873 656c 662c 2073 6f75 7263 653a  ch(self, source:
+00019870: 2075 2e55 7365 722c 206d 6573 7361 6765   u.User, message
+00019880: 733a 206c 6973 745b 6772 6170 6871 6c2e  s: list[graphql.
+00019890: 4d65 7373 6167 655d 2920 2d3e 204e 6f6e  Message]) -> Non
+000198a0: 653a 0a20 2020 2020 2020 206d 6f73 745f  e:.        most_
+000198b0: 7265 6365 6e74 203d 2061 7761 6974 2044  recent = await D
+000198c0: 424d 6573 7361 6765 2e67 6574 5f6d 6f73  BMessage.get_mos
+000198d0: 745f 7265 6365 6e74 2873 656c 662e 6662  t_recent(self.fb
+000198e0: 6964 2c20 7365 6c66 2e66 625f 7265 6365  id, self.fb_rece
+000198f0: 6976 6572 290a 2020 2020 2020 2020 666f  iver).        fo
+00019900: 7220 6d65 7373 6167 6520 696e 206d 6573  r message in mes
+00019910: 7361 6765 733a 0a20 2020 2020 2020 2020  sages:.         
+00019920: 2020 2070 7570 7065 7420 3d20 6177 6169     puppet = awai
+00019930: 7420 702e 5075 7070 6574 2e67 6574 5f62  t p.Puppet.get_b
+00019940: 795f 6662 6964 286d 6573 7361 6765 2e6d  y_fbid(message.m
+00019950: 6573 7361 6765 5f73 656e 6465 722e 6964  essage_sender.id
+00019960: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00019970: 206d 6573 7361 6765 2e74 696d 6573 7461   message.timesta
+00019980: 6d70 203e 206d 6f73 745f 7265 6365 6e74  mp > most_recent
+00019990: 2e74 696d 6573 7461 6d70 3a0a 2020 2020  .timestamp:.    
+000199a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000199b0: 7420 7365 6c66 2e68 616e 646c 655f 6661  t self.handle_fa
+000199c0: 6365 626f 6f6b 5f6d 6573 7361 6765 2873  cebook_message(s
+000199d0: 6f75 7263 652c 2070 7570 7065 742c 206d  ource, puppet, m
+000199e0: 6573 7361 6765 290a 2020 2020 2020 2020  essage).        
+000199f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00019a00: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00019a10: 7365 6c66 2e5f 7472 795f 6861 6e64 6c65  self._try_handle
+00019a20: 5f67 7261 7068 716c 5f72 6561 6374 696f  _graphql_reactio
+00019a30: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
+00019a40: 2020 2020 2020 2020 736f 7572 6365 2c20          source, 
+00019a50: 6d65 7373 6167 652e 6d65 7373 6167 655f  message.message_
+00019a60: 6964 2c20 6d65 7373 6167 652e 6d65 7373  id, message.mess
+00019a70: 6167 655f 7265 6163 7469 6f6e 730a 2020  age_reactions.  
+00019a80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00019a90: 0a20 2020 2023 2072 6567 696f 6e20 4461  .    # region Da
+00019aa0: 7461 6261 7365 2067 6574 7465 7273 0a0a  tabase getters..
+00019ab0: 2020 2020 6173 796e 6320 6465 6620 706f      async def po
+00019ac0: 7374 696e 6974 2873 656c 6629 202d 3e20  stinit(self) -> 
+00019ad0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00019ae0: 6c66 2e62 795f 6662 6964 5b73 656c 662e  lf.by_fbid[self.
+00019af0: 6662 6964 5f66 756c 6c5d 203d 2073 656c  fbid_full] = sel
+00019b00: 660a 2020 2020 2020 2020 6966 2073 656c  f.        if sel
+00019b10: 662e 6d78 6964 3a0a 2020 2020 2020 2020  f.mxid:.        
+00019b20: 2020 2020 7365 6c66 2e62 795f 6d78 6964      self.by_mxid
+00019b30: 5b73 656c 662e 6d78 6964 5d20 3d20 7365  [self.mxid] = se
+00019b40: 6c66 0a20 2020 2020 2020 2073 656c 662e  lf.        self.
+00019b50: 5f6d 6169 6e5f 696e 7465 6e74 203d 2028  _main_intent = (
+00019b60: 0a20 2020 2020 2020 2020 2020 2028 6177  .            (aw
+00019b70: 6169 7420 7365 6c66 2e67 6574 5f64 6d5f  ait self.get_dm_
+00019b80: 7075 7070 6574 2829 292e 6465 6661 756c  puppet()).defaul
+00019b90: 745f 6d78 6964 5f69 6e74 656e 7420 6966  t_mxid_intent if
+00019ba0: 2073 656c 662e 6973 5f64 6972 6563 7420   self.is_direct 
+00019bb0: 656c 7365 2073 656c 662e 617a 2e69 6e74  else self.az.int
+00019bc0: 656e 740a 2020 2020 2020 2020 290a 0a20  ent.        ).. 
+00019bd0: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+00019be0: 2020 2020 4061 7379 6e63 5f67 6574 7465      @async_gette
+00019bf0: 725f 6c6f 636b 0a20 2020 2061 7379 6e63  r_lock.    async
+00019c00: 2064 6566 2067 6574 5f62 795f 6d78 6964   def get_by_mxid
+00019c10: 2863 6c73 2c20 6d78 6964 3a20 526f 6f6d  (cls, mxid: Room
+00019c20: 4944 2920 2d3e 2050 6f72 7461 6c20 7c20  ID) -> Portal | 
+00019c30: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
+00019c40: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
+00019c50: 6574 7572 6e20 636c 732e 6279 5f6d 7869  eturn cls.by_mxi
+00019c60: 645b 6d78 6964 5d0a 2020 2020 2020 2020  d[mxid].        
+00019c70: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00019c80: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00019c90: 730a 0a20 2020 2020 2020 2070 6f72 7461  s..        porta
+00019ca0: 6c20 3d20 6361 7374 2863 6c73 2c20 6177  l = cast(cls, aw
+00019cb0: 6169 7420 7375 7065 7228 292e 6765 745f  ait super().get_
+00019cc0: 6279 5f6d 7869 6428 6d78 6964 2929 0a20  by_mxid(mxid)). 
+00019cd0: 2020 2020 2020 2069 6620 706f 7274 616c         if portal
+00019ce0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00019cf0: 6169 7420 706f 7274 616c 2e70 6f73 7469  ait portal.posti
+00019d00: 6e69 7428 290a 2020 2020 2020 2020 2020  nit().          
+00019d10: 2020 7265 7475 726e 2070 6f72 7461 6c0a    return portal.
+00019d20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019d30: 4e6f 6e65 0a0a 2020 2020 4063 6c61 7373  None..    @class
+00019d40: 6d65 7468 6f64 0a20 2020 2040 6173 796e  method.    @asyn
+00019d50: 635f 6765 7474 6572 5f6c 6f63 6b0a 2020  c_getter_lock.  
+00019d60: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
+00019d70: 6279 5f66 6269 6428 0a20 2020 2020 2020  by_fbid(.       
+00019d80: 2063 6c73 2c0a 2020 2020 2020 2020 6662   cls,.        fb
+00019d90: 6964 3a20 696e 742c 0a20 2020 2020 2020  id: int,.       
+00019da0: 202a 2c0a 2020 2020 2020 2020 6662 5f72   *,.        fb_r
+00019db0: 6563 6569 7665 723a 2069 6e74 203d 2030  eceiver: int = 0
+00019dc0: 2c0a 2020 2020 2020 2020 6372 6561 7465  ,.        create
+00019dd0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00019de0: 2020 2020 2020 2066 625f 7479 7065 3a20         fb_type: 
+00019df0: 5468 7265 6164 5479 7065 207c 204e 6f6e  ThreadType | Non
+00019e00: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
+00019e10: 2d3e 2050 6f72 7461 6c20 7c20 4e6f 6e65  -> Portal | None
+00019e20: 3a0a 2020 2020 2020 2020 6966 2066 625f  :.        if fb_
+00019e30: 7479 7065 3a0a 2020 2020 2020 2020 2020  type:.          
+00019e40: 2020 6662 5f72 6563 6569 7665 7220 3d20    fb_receiver = 
+00019e50: 6662 5f72 6563 6569 7665 7220 6966 2066  fb_receiver if f
+00019e60: 625f 7479 7065 203d 3d20 5468 7265 6164  b_type == Thread
+00019e70: 5479 7065 2e55 5345 5220 656c 7365 2030  Type.USER else 0
+00019e80: 0a20 2020 2020 2020 2066 6269 645f 6675  .        fbid_fu
+00019e90: 6c6c 203d 2028 6662 6964 2c20 6662 5f72  ll = (fbid, fb_r
+00019ea0: 6563 6569 7665 7229 0a20 2020 2020 2020  eceiver).       
+00019eb0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00019ec0: 2020 7265 7475 726e 2063 6c73 2e62 795f    return cls.by_
+00019ed0: 6662 6964 5b66 6269 645f 6675 6c6c 5d0a  fbid[fbid_full].
+00019ee0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00019ef0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00019f00: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
+00019f10: 2020 2070 6f72 7461 6c20 3d20 6361 7374     portal = cast
+00019f20: 2863 6c73 2c20 6177 6169 7420 7375 7065  (cls, await supe
+00019f30: 7228 292e 6765 745f 6279 5f66 6269 6428  r().get_by_fbid(
+00019f40: 6662 6964 2c20 6662 5f72 6563 6569 7665  fbid, fb_receive
+00019f50: 7229 290a 2020 2020 2020 2020 6966 2070  r)).        if p
+00019f60: 6f72 7461 6c3a 0a20 2020 2020 2020 2020  ortal:.         
+00019f70: 2020 2061 7761 6974 2070 6f72 7461 6c2e     await portal.
+00019f80: 706f 7374 696e 6974 2829 0a20 2020 2020  postinit().     
+00019f90: 2020 2020 2020 2072 6574 7572 6e20 706f         return po
+00019fa0: 7274 616c 0a0a 2020 2020 2020 2020 6966  rtal..        if
+00019fb0: 2066 625f 7479 7065 2061 6e64 2063 7265   fb_type and cre
+00019fc0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00019fd0: 2070 6f72 7461 6c20 3d20 636c 7328 6662   portal = cls(fb
+00019fe0: 6964 3d66 6269 642c 2066 625f 7265 6365  id=fbid, fb_rece
+00019ff0: 6976 6572 3d66 625f 7265 6365 6976 6572  iver=fb_receiver
+0001a000: 2c20 6662 5f74 7970 653d 6662 5f74 7970  , fb_type=fb_typ
+0001a010: 6529 0a20 2020 2020 2020 2020 2020 2061  e).            a
+0001a020: 7761 6974 2070 6f72 7461 6c2e 696e 7365  wait portal.inse
+0001a030: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
+0001a040: 2061 7761 6974 2070 6f72 7461 6c2e 706f   await portal.po
+0001a050: 7374 696e 6974 2829 0a20 2020 2020 2020  stinit().       
+0001a060: 2020 2020 2072 6574 7572 6e20 706f 7274       return port
+0001a070: 616c 0a0a 2020 2020 2020 2020 7265 7475  al..        retu
+0001a080: 726e 204e 6f6e 650a 0a20 2020 2040 636c  rn None..    @cl
+0001a090: 6173 736d 6574 686f 640a 2020 2020 6173  assmethod.    as
+0001a0a0: 796e 6320 6465 6620 6765 745f 616c 6c5f  ync def get_all_
+0001a0b0: 6279 5f72 6563 6569 7665 7228 636c 732c  by_receiver(cls,
+0001a0c0: 2066 625f 7265 6365 6976 6572 3a20 696e   fb_receiver: in
+0001a0d0: 7429 202d 3e20 4173 796e 6347 656e 6572  t) -> AsyncGener
+0001a0e0: 6174 6f72 5b50 6f72 7461 6c2c 204e 6f6e  ator[Portal, Non
+0001a0f0: 655d 3a0a 2020 2020 2020 2020 706f 7274  e]:.        port
+0001a100: 616c 7320 3d20 6177 6169 7420 7375 7065  als = await supe
+0001a110: 7228 292e 6765 745f 616c 6c5f 6279 5f72  r().get_all_by_r
+0001a120: 6563 6569 7665 7228 6662 5f72 6563 6569  eceiver(fb_recei
+0001a130: 7665 7229 0a20 2020 2020 2020 2070 6f72  ver).        por
+0001a140: 7461 6c3a 2050 6f72 7461 6c0a 2020 2020  tal: Portal.    
+0001a150: 2020 2020 666f 7220 706f 7274 616c 2069      for portal i
+0001a160: 6e20 706f 7274 616c 733a 0a20 2020 2020  n portals:.     
+0001a170: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001a180: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0001a190: 6420 636c 732e 6279 5f66 6269 645b 2870  d cls.by_fbid[(p
+0001a1a0: 6f72 7461 6c2e 6662 6964 2c20 706f 7274  ortal.fbid, port
+0001a1b0: 616c 2e66 625f 7265 6365 6976 6572 295d  al.fb_receiver)]
+0001a1c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0001a1d0: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+0001a1e0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+0001a1f0: 6169 7420 706f 7274 616c 2e70 6f73 7469  ait portal.posti
+0001a200: 6e69 7428 290a 2020 2020 2020 2020 2020  nit().          
+0001a210: 2020 2020 2020 7969 656c 6420 706f 7274        yield port
+0001a220: 616c 0a0a 2020 2020 4063 6c61 7373 6d65  al..    @classme
+0001a230: 7468 6f64 0a20 2020 2061 7379 6e63 2064  thod.    async d
+0001a240: 6566 2061 6c6c 2863 6c73 2920 2d3e 2041  ef all(cls) -> A
+0001a250: 7379 6e63 4765 6e65 7261 746f 725b 506f  syncGenerator[Po
+0001a260: 7274 616c 2c20 4e6f 6e65 5d3a 0a20 2020  rtal, None]:.   
+0001a270: 2020 2020 2070 6f72 7461 6c73 203d 2061       portals = a
+0001a280: 7761 6974 2073 7570 6572 2829 2e61 6c6c  wait super().all
+0001a290: 2829 0a20 2020 2020 2020 2070 6f72 7461  ().        porta
+0001a2a0: 6c3a 2050 6f72 7461 6c0a 2020 2020 2020  l: Portal.      
+0001a2b0: 2020 666f 7220 706f 7274 616c 2069 6e20    for portal in 
+0001a2c0: 706f 7274 616c 733a 0a20 2020 2020 2020  portals:.       
+0001a2d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001a2e0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0001a2f0: 636c 732e 6279 5f66 6269 645b 2870 6f72  cls.by_fbid[(por
+0001a300: 7461 6c2e 6662 6964 2c20 706f 7274 616c  tal.fbid, portal
+0001a310: 2e66 625f 7265 6365 6976 6572 295d 0a20  .fb_receiver)]. 
+0001a320: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001a330: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+0001a340: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001a350: 7420 706f 7274 616c 2e70 6f73 7469 6e69  t portal.postini
+0001a360: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0001a370: 2020 2020 7969 656c 6420 706f 7274 616c      yield portal
+0001a380: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
+0001a390: 6f64 0a20 2020 2064 6566 2067 6574 5f62  od.    def get_b
+0001a3a0: 795f 7468 7265 6164 280a 2020 2020 2020  y_thread(.      
+0001a3b0: 2020 636c 732c 0a20 2020 2020 2020 206b    cls,.        k
+0001a3c0: 6579 3a20 6772 6170 6871 6c2e 5468 7265  ey: graphql.Thre
+0001a3d0: 6164 4b65 7920 7c20 6d71 7474 2e54 6872  adKey | mqtt.Thr
+0001a3e0: 6561 644b 6579 2c0a 2020 2020 2020 2020  eadKey,.        
+0001a3f0: 6662 5f72 6563 6569 7665 723a 2069 6e74  fb_receiver: int
+0001a400: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+0001a410: 2020 2020 2020 2020 6372 6561 7465 3a20          create: 
+0001a420: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+0001a430: 2029 202d 3e20 4177 6169 7461 626c 655b   ) -> Awaitable[
+0001a440: 506f 7274 616c 5d3a 0a20 2020 2020 2020  Portal]:.       
+0001a450: 2072 6574 7572 6e20 636c 732e 6765 745f   return cls.get_
+0001a460: 6279 5f66 6269 6428 0a20 2020 2020 2020  by_fbid(.       
+0001a470: 2020 2020 206b 6579 2e69 642c 0a20 2020       key.id,.   
+0001a480: 2020 2020 2020 2020 2066 625f 7265 6365           fb_rece
+0001a490: 6976 6572 3d66 625f 7265 6365 6976 6572  iver=fb_receiver
+0001a4a0: 2c0a 2020 2020 2020 2020 2020 2020 6372  ,.            cr
+0001a4b0: 6561 7465 3d63 7265 6174 652c 0a20 2020  eate=create,.   
+0001a4c0: 2020 2020 2020 2020 2066 625f 7479 7065           fb_type
+0001a4d0: 3d54 6872 6561 6454 7970 652e 6672 6f6d  =ThreadType.from
+0001a4e0: 5f74 6872 6561 645f 6b65 7928 6b65 7929  _thread_key(key)
+0001a4f0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0001a500: 2023 2065 6e64 7265 6769 6f6e 0a          # endregion.
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/presence.py` & `mautrix-facebook-0.5.0/mautrix_facebook/presence.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/puppet.py` & `mautrix-facebook-0.5.0/mautrix_facebook/puppet.py`

 * *Files 12% similar despite different names*

```diff
@@ -11,21 +11,21 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
-from typing import TYPE_CHECKING, AsyncGenerator, AsyncIterable, Awaitable, cast
+from typing import TYPE_CHECKING, Any, AsyncGenerator, AsyncIterable, Awaitable, cast
 from datetime import datetime, timedelta
 import asyncio
 
 from yarl import URL
 
-from maufbapi.types.graphql import Participant, Picture
+from maufbapi.types.graphql import Participant, ParticipantType, Picture
 from mautrix.appservice import IntentAPI
 from mautrix.bridge import BasePuppet, async_getter_lock
 from mautrix.types import ContentURI, RoomID, SyncToken, UserID
 from mautrix.util import magic
 from mautrix.util.simple_template import SimpleTemplate
 
 from . import matrix as m, portal as p, user as u
@@ -33,14 +33,15 @@
 from .db import Puppet as DBPuppet
 
 if TYPE_CHECKING:
     from .__main__ import MessengerBridge
 
 
 class Puppet(DBPuppet, BasePuppet):
+    bridge: MessengerBridge
     mx: m.MatrixHandler
     config: Config
     hs_domain: str
     mxid_template: SimpleTemplate[int]
 
     by_fbid: dict[int, Puppet] = {}
     by_custom_mxid: dict[UserID, Puppet] = {}
@@ -51,27 +52,29 @@
         self,
         fbid: int,
         name: str | None = None,
         photo_id: str | None = None,
         photo_mxc: ContentURI | None = None,
         name_set: bool = False,
         avatar_set: bool = False,
+        contact_info_set: bool = False,
         is_registered: bool = False,
         custom_mxid: UserID | None = None,
         access_token: str | None = None,
         next_batch: SyncToken | None = None,
         base_url: URL | None = None,
     ) -> None:
         super().__init__(
             fbid,
             name,
             photo_id,
             photo_mxc,
             name_set,
             avatar_set,
+            contact_info_set,
             is_registered,
             custom_mxid,
             access_token,
             next_batch,
             base_url,
         )
         self._last_info_sync = None
@@ -102,22 +105,21 @@
                 self.intent.ensure_joined(portal.mxid)
                 async for portal in p.Portal.get_all_by_receiver(self.fbid)
                 if portal.mxid
             ]
         )
 
     def intent_for(self, portal: p.Portal) -> IntentAPI:
-        if portal.fbid == self.fbid or (
-            portal.backfill_lock.locked and self.config["bridge.backfill.invite_own_puppet"]
-        ):
+        if portal.fbid == self.fbid:
             return self.default_mxid_intent
         return self.intent
 
     @classmethod
     def init_cls(cls, bridge: "MessengerBridge") -> AsyncIterable[Awaitable[None]]:
+        cls.bridge = bridge
         cls.config = bridge.config
         cls.loop = bridge.loop
         cls.mx = bridge.matrix
         cls.az = bridge.az
         cls.hs_domain = cls.config["homeserver.domain"]
         cls.mxid_template = SimpleTemplate(
             template=cls.config["bridge.username_template"],
@@ -149,34 +151,64 @@
         update_avatar: bool = True,
     ) -> Puppet:
         if not info:
             # if not self.should_sync:
             #     return self
             # FIXME
             # info = await source.client.fetch_thread_info([self.fbid]).__anext__()
-            print("no info to update puppet :(")
+            self.log.info("no info to update puppet :(")
             return self
         self._last_info_sync = datetime.now()
         try:
-            changed = await self._update_name(info)
+            changed = await self.update_contact_info(info)
+            changed = await self._update_name(info) or changed
             if update_avatar:
-                changed = await self._update_photo(source, info.profile_pic_large) or changed
+                changed = (
+                    await self._update_photo(
+                        source,
+                        info.profile_pic_large,
+                        allow_graph=info.typename != ParticipantType.INSTAGRAM,
+                    )
+                    or changed
+                )
             if changed:
                 await self.save()
         except Exception:
             self.log.exception(f"Failed to update info from source {source.fbid}")
         return self
 
+    async def update_contact_info(self, info: Participant | None = None) -> bool:
+        if not self.bridge.homeserver_software.is_hungry:
+            return False
+
+        if self.contact_info_set:
+            return False
+
+        try:
+            contact_info: dict[str, Any] = {
+                "com.beeper.bridge.remote_id": str(self.fbid),
+                "com.beeper.bridge.service": self.bridge.beeper_service_name,
+                "com.beeper.bridge.network": self.bridge.beeper_network_name,
+            }
+            if info and info.username:
+                contact_info["com.beeper.bridge.identifiers"] = [f"facebook:{info.username}"]
+            await self.default_mxid_intent.beeper_update_profile(contact_info)
+            self.contact_info_set = True
+        except Exception:
+            self.log.exception("Error updating contact info")
+            self.contact_info_set = False
+        return True
+
     @classmethod
     def _get_displayname(cls, info: Participant) -> str:
         sn = info.structured_name
         info = {
             "displayname": None,
             "id": info.id,
-            "name": info.name,
+            "name": info.name or "Facebook user",
             "phonetic_name": sn.phonetic_name if sn else None,
             "own_nickname": info.nickname_for_viewer,
             **(sn.to_dict() if sn else {}),
         }
         for preference in cls.config["bridge.displayname_preference"]:
             if info.get(preference):
                 info["displayname"] = info.get(preference)
@@ -206,36 +238,38 @@
         use_graph: bool = True,
     ) -> ContentURI:
         data = None
         if use_graph and source and source.state and source.state.session.access_token:
             graph_url = (source.client.graph_url / str(fbid) / "picture").with_query(
                 {"width": "1000", "height": "1000"}
             )
-            async with source.client.get(graph_url) as resp:
+            async with source.client.raw_http_get(graph_url) as resp:
                 if resp.status < 400:
                     data = await resp.read()
         if data is None:
-            async with source.client.get(url) as resp:
+            async with source.client.raw_http_get(url) as resp:
                 data = await resp.read()
         mime = magic.mimetype(data)
         return await intent.upload_media(
             data, mime_type=mime, async_upload=cls.config["homeserver.async_media"]
         )
 
-    async def _update_photo(self, source: u.User, photo: Picture) -> bool:
+    async def _update_photo(
+        self, source: u.User, photo: Picture, allow_graph: bool = True
+    ) -> bool:
         photo_id = p.Portal.get_photo_id(photo)
         if photo_id != self.photo_id or not self.avatar_set:
             self.photo_id = photo_id
             if photo:
                 self.photo_mxc = await self.reupload_avatar(
                     source,
                     self.default_mxid_intent,
                     photo.uri,
                     self.fbid,
-                    use_graph=(photo.height or 0) < 500,
+                    use_graph=allow_graph and (photo.height or 0) < 500,
                 )
             else:
                 self.photo_mxc = ContentURI("")
             try:
                 await self.default_mxid_intent.set_avatar_url(self.photo_mxc)
                 self.avatar_set = True
             except Exception:
@@ -311,9 +345,20 @@
         puppet: cls
         for puppet in puppets:
             try:
                 yield cls.by_fbid[puppet.fbid]
             except KeyError:
                 puppet._add_to_cache()
                 yield puppet
+
+    @classmethod
+    async def get_all(cls) -> AsyncGenerator[Puppet, None]:
+        puppets = await super().get_all()
+        puppet: cls
+        for puppet in puppets:
+            try:
+                yield cls.by_fbid[puppet.fbid]
+            except KeyError:
+                puppet._add_to_cache()
+                yield puppet
 
     # endregion
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/user.py` & `mautrix-facebook-0.5.0/mautrix_facebook/user.py`

 * *Files 14% similar despite different names*

```diff
@@ -11,60 +11,75 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 from __future__ import annotations
 
-from typing import TYPE_CHECKING, AsyncGenerator, AsyncIterable, Awaitable, TypeVar, cast
+from typing import TYPE_CHECKING, AsyncGenerator, AsyncIterable, Awaitable, Callable, TypeVar, cast
+from datetime import datetime, timedelta
+from functools import partial
 import asyncio
+import base64
 import hashlib
 import hmac
+import re
 import time
 
-from aiohttp import ClientConnectionError
-
-from maufbapi import AndroidAPI, AndroidMQTT, AndroidState, ProxyHandler
+from maufbapi import AndroidAPI, AndroidMQTT, AndroidState
 from maufbapi.http import InvalidAccessToken, ResponseError
-from maufbapi.mqtt import Connect, Disconnect, MQTTNotConnected, MQTTNotLoggedIn, ProxyUpdate
+from maufbapi.mqtt import (
+    Connect,
+    Disconnect,
+    MQTTNotConnected,
+    MQTTNotLoggedIn,
+    MQTTReconnectionError,
+    ProxyUpdate,
+)
 from maufbapi.types import graphql, mqtt as mqtt_t
+from maufbapi.types.graphql.responses import Message, Thread
 from mautrix.bridge import BaseUser, async_getter_lock
 from mautrix.errors import MNotFound
 from mautrix.types import (
     EventID,
     MessageType,
     PresenceState,
     PushActionType,
     PushRuleKind,
     PushRuleScope,
     RoomID,
     TextMessageEventContent,
     UserID,
 )
+from mautrix.util import background_task
 from mautrix.util.bridge_state import BridgeState, BridgeStateEvent
 from mautrix.util.opt_prometheus import Gauge, Summary, async_time
+from mautrix.util.proxy import RETRYABLE_PROXY_EXCEPTIONS, ProxyHandler
 from mautrix.util.simple_lock import SimpleLock
 
 from . import portal as po, puppet as pu
 from .commands import enter_2fa_code
 from .config import Config
-from .db import Message as DBMessage, ThreadType, User as DBUser, UserPortal
+from .db import Backfill, Message as DBMessage, ThreadType, User as DBUser, UserPortal
 from .presence import PresenceUpdater
 from .util.interval import get_interval
 
 METRIC_SYNC_THREADS = Summary("bridge_sync_threads", "calls to sync_threads")
 METRIC_RESYNC = Summary("bridge_on_resync", "calls to on_resync")
 METRIC_UNKNOWN_EVENT = Summary("bridge_on_unknown_event", "calls to on_unknown_event")
 METRIC_MEMBERS_ADDED = Summary("bridge_on_members_added", "calls to on_members_added")
 METRIC_MEMBER_REMOVED = Summary("bridge_on_member_removed", "calls to on_member_removed")
 METRIC_TYPING = Summary("bridge_on_typing", "calls to on_typing")
 METRIC_PRESENCE = Summary("bridge_on_presence", "calls to on_presence")
 METRIC_REACTION = Summary("bridge_on_reaction", "calls to on_reaction")
 METRIC_FORCED_FETCH = Summary("bridge_on_forced_fetch", "calls to on_forced_fetch")
 METRIC_MESSAGE_UNSENT = Summary("bridge_on_unsent", "calls to on_unsent")
+METRIC_DELTA_RTC_MULTIWAY_MESSAGE = Summary(
+    "bridge_on_metric_delta_rtc_multiway_message", "calls to on_delta_rtc_multiway_message"
+)
 METRIC_MESSAGE_SEEN = Summary("bridge_on_message_seen", "calls to on_message_seen")
 METRIC_TITLE_CHANGE = Summary("bridge_on_title_change", "calls to on_title_change")
 METRIC_AVATAR_CHANGE = Summary("bridge_on_avatar_change", "calls to on_avatar_change")
 METRIC_THREAD_CHANGE = Summary("bridge_on_thread_change", "calls to on_thread_change")
 METRIC_MESSAGE = Summary("bridge_on_message", "calls to on_message")
 METRIC_LOGGED_IN = Gauge("bridge_logged_in", "Users logged into the bridge")
 METRIC_CONNECTED = Gauge("bridge_connected", "Bridge users connected to Facebook")
@@ -102,14 +117,16 @@
 
     by_mxid: dict[UserID, User] = {}
     by_fbid: dict[int, User] = {}
 
     client: AndroidAPI | None
     mqtt: AndroidMQTT | None
     listen_task: asyncio.Task | None
+    _backfill_loop_task: asyncio.Task | None
+    _thread_sync_task: asyncio.Task | None
     seq_id: int | None
 
     _notice_room_lock: asyncio.Lock
     _notice_send_lock: asyncio.Lock
     is_admin: bool
     permission_level: str
     _is_logged_in: bool | None
@@ -129,22 +146,28 @@
         self,
         mxid: UserID,
         fbid: int | None = None,
         state: AndroidState | None = None,
         notice_room: RoomID | None = None,
         seq_id: int | None = None,
         connect_token_hash: bytes | None = None,
+        oldest_backfilled_thread_ts: int | None = None,
+        total_backfilled_portals: int | None = None,
+        thread_sync_completed: bool = False,
     ) -> None:
         super().__init__(
             mxid=mxid,
             fbid=fbid,
             state=state,
             notice_room=notice_room,
             seq_id=seq_id,
             connect_token_hash=connect_token_hash,
+            oldest_backfilled_thread_ts=oldest_backfilled_thread_ts,
+            total_backfilled_portals=total_backfilled_portals,
+            thread_sync_completed=thread_sync_completed,
         )
         BaseUser.__init__(self)
         self.notice_room = notice_room
         self._notice_room_lock = asyncio.Lock()
         self._notice_send_lock = asyncio.Lock()
         self.command_status = None
         (
@@ -154,14 +177,16 @@
             self.permission_level,
         ) = self.config.get_permissions(mxid)
         self._is_logged_in = None
         self._is_connected = None
         self._connection_time = time.monotonic()
         self._prev_thread_sync = -10
         self._prev_reconnect_fail_refresh = time.monotonic()
+        self._thread_sync_task = None
+        self._backfill_loop_task = None
         self._sync_lock = SimpleLock(
             "Waiting for thread sync to finish before handling %s", log=self.log
         )
         self._is_refreshing = False
         self._logged_in_info = None
         self._logged_in_info_time = 0
         self._last_seq_id_save = 0
@@ -279,39 +304,39 @@
 
     async def _load_session(self, is_startup: bool) -> bool:
         if self._is_logged_in and is_startup:
             return True
         elif not self.state:
             # If we have a user in the DB with no state, we can assume
             # FB logged us out and the bridge has restarted
-            await self.push_bridge_state(
-                BridgeStateEvent.BAD_CREDENTIALS,
-                error="logged-out",
-            )
+            await self.push_bridge_state(BridgeStateEvent.BAD_CREDENTIALS, error="logged-out")
             return False
         self.state.device.connection_type = self.config["facebook.connection_type"]
         self.state.carrier.name = self.config["facebook.carrier"]
         self.state.carrier.hni = self.config["facebook.hni"]
-        client = AndroidAPI(
+        self.client = AndroidAPI(
             self.state,
             log=self.log.getChild("api"),
             proxy_handler=self.proxy_handler,
+            on_proxy_update=self.on_proxy_update,
         )
-        user_info = await self.fetch_logged_in_user(client)
+        user_info = await self.fetch_logged_in_user()
         if user_info:
             self.log.info("Loaded session successfully")
-            self.client = client
             self._logged_in_info = user_info
             self._logged_in_info_time = time.monotonic()
             self._track_metric(METRIC_LOGGED_IN, True)
             self._is_logged_in = True
             self.is_connected = None
             self.stop_listen()
-            asyncio.create_task(self.post_login(is_startup=is_startup))
+            self.stop_backfill_tasks()
+            background_task.create(self.post_login(is_startup=is_startup))
             return True
+        # Unset the client if we failed to fetch the user
+        self.client = None
         return False
 
     async def _send_reset_notice(self, e: InvalidAccessToken, edit: EventID | None = None) -> None:
         await self.send_bridge_notice(
             "Got authentication error from Messenger:\n\n"
             f"> {e!s}\n\n"
             "If you changed your Facebook password or enabled two-factor authentication, this "
@@ -322,46 +347,32 @@
             error_code="fb-auth-error",
             error_message=str(e),
         )
         await self.logout(remove_fbid=False, from_auth_error=True)
 
     async def fetch_logged_in_user(
         self,
-        client: AndroidAPI | None = None,
         action: str = "restore session",
         refresh_proxy_on_failure: bool = False,
     ) -> None:
-        if not client:
-            client = self.client
         attempt = 0
         while True:
             try:
-                return await client.fetch_logged_in_user()
+                return await self.client.fetch_logged_in_user()
+            except RETRYABLE_PROXY_EXCEPTIONS as e:
+                # These are retried by the client up to 10 times, but we actually want to retry
+                # these indefinitely so we capture them here again and retry.
+                self.log.warning(
+                    f"Proxy error fetching user from Faecbook: {e}, retrying in 1 minute",
+                )
+                await asyncio.sleep(60)
             except InvalidAccessToken as e:
                 if action != "restore session":
                     await self._send_reset_notice(e)
                 raise
-            except (
-                ProxyError,
-                ProxyTimeoutError,
-                ProxyConnectionError,
-                ClientConnectionError,
-                ConnectionError,
-                asyncio.TimeoutError,
-            ) as e:
-                attempt += 1
-                wait = min(attempt * 10, 60)
-                self.log.warning(
-                    f"{e.__class__.__name__} while trying to {action}, "
-                    f"retrying in {wait} seconds: {e}"
-                )
-                await asyncio.sleep(wait)
-                if refresh_proxy_on_failure:
-                    self.proxy_handler.update_proxy_url()
-                    await self.on_proxy_update()
             except ResponseError:
                 if action != "restore session":
                     attempt += 1
                     wait = min(attempt * 30, 300)
                     self.log.warning(
                         f"Unknown response error while trying to {action}, "
                         f"retrying in {wait} seconds"
@@ -409,20 +420,21 @@
         if self.temp_disconnect_notices or force_notice:
             event_id = await self.send_bridge_notice(
                 "Refreshing session...",
                 edit=event_id,
                 state_event=BridgeStateEvent.TRANSIENT_DISCONNECT,
             )
         self.client = None
-        self.proxy_handler.update_proxy_url()
         await self.reload_session(event_id)
 
     async def reload_session(
         self, event_id: EventID | None = None, retries: int = 3, is_startup: bool = False
     ) -> None:
+        if is_startup:
+            await self.push_bridge_state(BridgeStateEvent.CONNECTING)
         try:
             await self._load_session(is_startup=is_startup)
         except InvalidAccessToken as e:
             await self._send_reset_notice(e, edit=event_id)
         except ResponseError as e:
             will_retry = retries > 0
             retry = "Retrying in 1 minute" if will_retry else "Not retrying"
@@ -449,150 +461,421 @@
                 edit=event_id,
                 state_event=BridgeStateEvent.UNKNOWN_ERROR,
                 error_code="fb-reconnection-error",
             )
         finally:
             self._is_refreshing = False
 
-    async def reconnect(self, fetch_user: bool = False) -> None:
+    async def reconnect(self, fetch_user: bool = False, update_proxy: bool = False) -> None:
         self._is_refreshing = True
         if self.mqtt:
             self.mqtt.disconnect()
         await self.listen_task
         self.listen_task = None
         self.mqtt = None
-        self.proxy_handler.update_proxy_url()
-        await self.on_proxy_update()
+        if update_proxy and self.proxy_handler.update_proxy_url(reason="reconnect"):
+            await self.on_proxy_update()
         if fetch_user:
             self.log.debug("Fetching current user after MQTT disconnection")
             await self.fetch_logged_in_user(
                 action="fetch current user after MQTT disconnection",
                 refresh_proxy_on_failure=True,  # safe because MQTT is dropped
             )
         self.start_listen()
         self._is_refreshing = False
 
     async def logout(self, remove_fbid: bool = True, from_auth_error: bool = False) -> bool:
         ok = True
         self.stop_listen()
+        self.stop_backfill_tasks()
         if self.state and self.client and not from_auth_error:
             try:
                 ok = await self.client.logout()
             except Exception:
                 self.log.warning("Error while sending logout request", exc_info=True)
         if remove_fbid:
             await self.push_bridge_state(BridgeStateEvent.LOGGED_OUT)
         self._track_metric(METRIC_LOGGED_IN, False)
         self.state = None
-        self._is_logged_in = False
+        self._is_logged_in = None
         self.is_connected = None
         self.client = None
         self.mqtt = None
         self.seq_id = None
         self.connect_token_hash = None
+        self.total_backfilled_portals = None
+        self.oldest_backfilled_thread_ts = None
+        self.thread_sync_completed = False
 
         if self.fbid and remove_fbid:
             await UserPortal.delete_all(self.fbid)
             del self.by_fbid[self.fbid]
             self.fbid = None
 
+            await Backfill.delete_all(self.mxid)
+
         await self.save()
         return ok
 
-    async def post_login(self, is_startup: bool) -> None:
-        self.log.info("Running post-login actions")
+    async def post_login(self, is_startup: bool, from_login: bool = False) -> None:
+        self.log.info(f"Running post-login actions ({is_startup=}, {from_login=}, {self.seq_id=})")
         self._add_to_cache()
 
         try:
             puppet = await pu.Puppet.get_by_fbid(self.fbid)
 
             if puppet.custom_mxid != self.mxid and puppet.can_auto_login(self.mxid):
-                self.log.info(f"Automatically enabling custom puppet")
+                self.log.info("Automatically enabling custom puppet")
                 await puppet.switch_mxid(access_token="auto", mxid=self.mxid)
         except Exception:
             self.log.exception("Failed to automatically enable custom puppet")
 
-        if self.config["bridge.sync_on_startup"] or not is_startup or not self.seq_id:
-            await self.sync_threads(start_listen=True)
+        # Backfill requests are handled synchronously so as not to overload the homeserver.
+        # Users can configure their backfill stages to be more or less aggressive with backfilling
+        # to try and avoid getting banned.
+        if not self._backfill_loop_task or self._backfill_loop_task.done():
+            self._backfill_loop_task = asyncio.create_task(self._handle_backfill_requests_loop())
+
+        if not is_startup or not self.seq_id:
+            await self.sync_recent_threads(from_login=from_login)
         else:
             self.start_listen()
 
+        if self.config["bridge.backfill.enable"]:
+            if self._thread_sync_task and not self._thread_sync_task.done():
+                self.log.warning("Cancelling existing background thread sync task")
+                self._thread_sync_task.cancel()
+            self._thread_sync_task = asyncio.create_task(self.backfill_threads())
+
+        if self.bridge.homeserver_software.is_hungry:
+            self.log.info("Updating contact info for all users")
+            asyncio.gather(*[puppet.update_contact_info() async for puppet in pu.Puppet.get_all()])
+
+    async def _handle_backfill_requests_loop(self) -> None:
+        if not self.config["bridge.backfill.enable"] or not self.config["bridge.backfill.msc2716"]:
+            return
+
+        while True:
+            await self._sync_lock.wait("backfill request")
+            req = await Backfill.get_next(self.mxid)
+            if not req:
+                await asyncio.sleep(30)
+                continue
+            self.log.info("Backfill request %s", req)
+            try:
+                portal = await po.Portal.get_by_fbid(
+                    req.portal_fbid, fb_receiver=req.portal_fb_receiver
+                )
+                await req.mark_dispatched()
+                await portal.backfill(self, req)
+                await req.mark_done()
+            except Exception as e:
+                self.log.exception("Failed to backfill portal %s", req.portal_fbid)
+
+                if isinstance(e, ResponseError):
+                    self.log.warning("ResponseError: %s %s", e, str(e.data))
+
+                # Don't try again to backfill this portal for a minute.
+                await req.set_cooldown_timeout(60)
+
     async def get_direct_chats(self) -> dict[UserID, list[RoomID]]:
         return {
             pu.Puppet.get_mxid_from_id(portal.fbid): [portal.mxid]
             async for portal in po.Portal.get_all_by_receiver(self.fbid)
             if portal.mxid
         }
 
+    async def run_with_sync_lock(self, func: Callable[[], Awaitable]):
+        with self._sync_lock:
+            retry_count = 0
+            while retry_count < 5:
+                try:
+                    retry_count += 1
+                    await func()
+
+                    # The sync was successful. Exit the loop.
+                    return
+                except InvalidAccessToken as e:
+                    await self.send_bridge_notice(
+                        f"Got authentication error from Messenger:\n\n> {e!s}\n\n",
+                        important=True,
+                        state_event=BridgeStateEvent.BAD_CREDENTIALS,
+                        error_code="fb-auth-error",
+                        error_message=str(e),
+                    )
+                    await self.logout(remove_fbid=False, from_auth_error=True)
+                    return
+                except Exception:
+                    self.log.exception(
+                        "Failed to sync threads. Waiting 30 seconds before retrying sync."
+                    )
+                    await asyncio.sleep(30)
+
+            # If we get here, it means that the sync has failed five times. If this happens, most
+            # likely something very bad has happened.
+            self.log.error("Failed to sync threads five times. Will not retry.")
+
     @async_time(METRIC_SYNC_THREADS)
-    async def sync_threads(self, start_listen: bool = False) -> bool:
+    async def sync_recent_threads(self, from_login: bool = False):
         if (
             self._prev_thread_sync + 10 > time.monotonic()
             and self.mqtt
             and self.mqtt.seq_id is not None
         ):
             self.log.debug("Previous thread sync was less than 10 seconds ago, not re-syncing")
-            if start_listen:
-                self.start_listen()
-            return True
+            self.start_listen()
+            return
         self._prev_thread_sync = time.monotonic()
-        try:
-            await self._sync_threads(start_listen=start_listen)
-            return True
-        except InvalidAccessToken as e:
-            await self.send_bridge_notice(
-                f"Got authentication error from Messenger:\n\n> {e!s}\n\n",
-                important=True,
-                state_event=BridgeStateEvent.BAD_CREDENTIALS,
-                error_code="fb-auth-error",
-                error_message=str(e),
-            )
-            await self.logout(remove_fbid=False, from_auth_error=True)
-        except Exception as e:
-            self.log.exception("Failed to sync threads")
-            await self.push_bridge_state(BridgeStateEvent.UNKNOWN_ERROR, message=str(e))
-        return False
 
-    async def _sync_threads(self, start_listen: bool) -> None:
-        sync_count = self.config["bridge.initial_chat_sync"]
-        self.log.debug("Fetching threads...")
-        # TODO paginate with 20 threads per request
-        resp = await self.client.fetch_thread_list(thread_count=sync_count)
+        await self.run_with_sync_lock(partial(self._sync_recent_threads, from_login))
+
+    async def _sync_recent_threads(self, increment_total_backfilled_portals: bool = False):
+        assert self.client
+        sync_count = min(
+            self.config["bridge.backfill.max_conversations"],
+            self.config["bridge.max_startup_thread_sync_count"],
+        )
+        self.log.debug(f"Fetching {sync_count} threads, 20 at a time...")
+
+        # We need to get the sequence ID before we start the listener task.
+        resp = await self.client.fetch_thread_list()
         self.seq_id = int(resp.sync_sequence_id)
+        thread_seq_ids = list(
+            {int(thread.sync_sequence_id) for thread in resp.nodes if thread.sync_sequence_id}
+        )
+        if len(thread_seq_ids) > 1 or (
+            len(thread_seq_ids) == 1 and thread_seq_ids[0] != self.seq_id
+        ):
+            self.seq_id = max(*thread_seq_ids, self.seq_id)
+            self.log.warning(
+                f"Got more than one sequence ID in thread list: primary={resp.sync_sequence_id}, "
+                f"threads={thread_seq_ids}. Using highest value ({self.seq_id})"
+            )
         if self.mqtt:
             self.mqtt.seq_id = self.seq_id
+        self.log.debug(f"Got new seq_id {self.seq_id}")
         await self.save_seq_id()
-        if start_listen:
-            self.start_listen()
-        if sync_count <= 0:
+        self.start_listen()
+
+        local_limit: int | None = sync_count
+        if sync_count == 0:
             return
-        await self.push_bridge_state(BridgeStateEvent.BACKFILLING)
-        for thread in resp.nodes:
-            try:
-                await self._sync_thread(thread)
-            except Exception:
-                self.log.exception("Failed to sync thread %s", thread.id)
+        elif sync_count < 0:
+            local_limit = None
+
+        await self._sync_threads_with_delay(
+            self.client.iter_thread_list(resp, local_limit=local_limit),
+            stop_when_threads_have_no_messages_to_backfill=True,
+            increment_total_backfilled_portals=increment_total_backfilled_portals,
+            local_limit=local_limit,
+        )
 
         await self.update_direct_chats()
 
-    async def _sync_thread(self, thread: graphql.Thread) -> None:
-        self.log.debug(f"Syncing thread {thread.thread_key.id}")
+    async def backfill_threads(self):
+        try:
+            await self.run_with_sync_lock(self._backfill_threads)
+        except Exception:
+            self.log.exception("Error in thread backfill loop")
+
+    async def _backfill_threads(self):
+        assert self.client
+        if not self.config["bridge.backfill.enable"]:
+            return
+
+        max_conversations = self.config["bridge.backfill.max_conversations"] or 0
+        if 0 <= max_conversations <= (self.total_backfilled_portals or 0):
+            self.log.info("Backfill max_conversations count reached, not syncing any more portals")
+            return
+        elif self.thread_sync_completed:
+            self.log.debug("Thread backfill is marked as completed, not syncing more portals")
+            return
+        local_limit = (
+            max_conversations - (self.total_backfilled_portals or 0)
+            if max_conversations >= 0
+            else None
+        )
+
+        timestamp = self.oldest_backfilled_thread_ts or int(time.time() * 1000)
+        backoff = self.config.get("bridge.backfill.backoff.thread_list", 300)
+        await self._sync_threads_with_delay(
+            self.client.iter_thread_list_from(
+                timestamp,
+                local_limit=local_limit,
+                rate_limit_exceeded_backoff=backoff,
+            ),
+            increment_total_backfilled_portals=True,
+            local_limit=local_limit,
+        )
+        await self.update_direct_chats()
+
+    async def _sync_threads_with_delay(
+        self,
+        threads: AsyncIterable[Thread],
+        increment_total_backfilled_portals: bool = False,
+        stop_when_threads_have_no_messages_to_backfill: bool = False,
+        local_limit: int | None = None,
+    ):
+        sync_delay = self.config["bridge.backfill.min_sync_thread_delay"]
+        last_thread_sync_ts = 0.0
+        found_thread_count = 0
+        async for thread in threads:
+            found_thread_count += 1
+            now = time.monotonic()
+            if last_thread_sync_ts is not None and now < last_thread_sync_ts + sync_delay:
+                delay = last_thread_sync_ts + sync_delay - now
+                self.log.debug("Thread sync is happening too quickly. Waiting for %ds", delay)
+                await asyncio.sleep(delay)
+
+            last_thread_sync_ts = time.monotonic()
+            had_new_messages = await self._sync_thread(thread)
+            if not had_new_messages and stop_when_threads_have_no_messages_to_backfill:
+                self.log.debug("Got to threads with no new messages. Stopping sync.")
+                return
+
+            if increment_total_backfilled_portals:
+                self.total_backfilled_portals = (self.total_backfilled_portals or 0) + 1
+            self.oldest_backfilled_thread_ts = min(
+                thread.updated_timestamp,
+                self.oldest_backfilled_thread_ts or int(time.time() * 1000),
+            )
+            await self.save()
+        if local_limit is None or found_thread_count < local_limit:
+            if local_limit is None:
+                self.log.info(
+                    "Reached end of thread list with no limit, marking thread sync as completed"
+                )
+            else:
+                self.log.info(
+                    f"Reached end of thread list (got {found_thread_count} with "
+                    f"limit {local_limit}), marking thread sync as completed"
+                )
+            self.thread_sync_completed = True
+        await self.save()
+
+    def _message_is_bridgable(self, message: Message) -> bool:
+        for tag in message.tags_list:
+            if tag.startswith("source:messenger_growth"):
+                # This excludes messages like the following:
+                # - X just joined messenger
+                # - You are now connected on Messenger
+                return False
+            if tag == "source:titan:web":
+                # Older "You are now connected on Messenger" messages
+                return False
+            if tag == "source:generic_admin_text":
+                return False
+        return True
+
+    async def _sync_thread(self, thread: graphql.Thread) -> bool:
+        """
+        Sync a specific thread. Returns whether the thread had messages after the last message in
+        the database before the sync.
+        """
+        self.log.debug(f"Syncing thread {thread.thread_key}")
+
+        # If the thread only contains unbridgable messages, then don't create a portal for it.
+        forward_messages = [m for m in thread.messages.nodes if self._message_is_bridgable(m)]
+        if not forward_messages and not thread.messages.page_info.has_previous_page:
+            self.log.debug(
+                f"Thread {thread.thread_key} only contains unbridgable messages, skipping"
+            )
+            return False
+
+        assert self.client
         portal = await po.Portal.get_by_thread(thread.thread_key, self.fbid)
 
+        # Create or update the Matrix room
         was_created = False
         if not portal.mxid:
             await portal.create_matrix_room(self, thread)
             was_created = True
         else:
             await portal.update_matrix_room(self, thread)
-            await portal.backfill(self, is_initial=False, thread=thread)
         if was_created or not self.config["bridge.tag_only_on_create"]:
-            await self._mute_room(portal, thread.mute_until)
+            await self.mute_room(portal, thread.mute_until)
+
+        last_message = await DBMessage.get_most_recent(portal.fbid, portal.fb_receiver)
+        if last_message:
+            original_number_of_messages = len(forward_messages)
+            new_messages = [m for m in forward_messages if last_message.timestamp < m.timestamp]
+            forward_messages = new_messages
+
+            portal.log.debug(
+                f"{len(new_messages)}/{original_number_of_messages} messages are after most recent"
+                " message."
+            )
 
-    async def _mute_room(self, portal: po.Portal, mute_until: int) -> None:
+            # Fetch more messages until we get back to messages that have been bridged already.
+            while len(new_messages) > 0 and len(new_messages) == original_number_of_messages:
+                await asyncio.sleep(self.config["bridge.backfill.incremental.page_delay"])
+
+                portal.log.debug("Fetching more messages for forward backfill")
+                resp = await self.client.fetch_messages(
+                    portal.fbid, forward_messages[0].timestamp - 1
+                )
+                if len(resp.nodes) == 0:
+                    break
+                original_number_of_messages = len(resp.nodes)
+                new_messages = [m for m in resp.nodes if last_message.timestamp < m.timestamp]
+                forward_messages = new_messages + forward_messages
+                portal.log.debug(
+                    f"{len(new_messages)}/{original_number_of_messages} messages are after most "
+                    "recent message."
+                )
+        elif not portal.first_event_id:
+            self.log.debug(
+                f"Skipping backfilling {portal.fbid_log} as the first event ID is not known"
+            )
+            return False
+
+        if forward_messages:
+            last_message_timestamp = (
+                forward_messages[0].timestamp if len(forward_messages) > 0 else None
+            )
+            mark_read = thread.unread_count == 0 or (
+                (hours := self.config["bridge.backfill.unread_hours_threshold"]) > 0
+                and last_message_timestamp
+                and (
+                    datetime.fromtimestamp(last_message_timestamp / 1000)
+                    < datetime.now() - timedelta(hours=hours)
+                )
+            )
+            (
+                _,
+                last_message_timestamp,
+                base_insertion_event_id,
+            ) = await portal.backfill_message_page(
+                self,
+                forward_messages,
+                forward=True,
+                last_message=last_message,
+                mark_read=mark_read,
+            )
+            if (
+                not self.bridge.homeserver_software.is_hungry
+                and self.config["bridge.backfill.msc2716"]
+            ):
+                await portal.send_post_backfill_dummy(
+                    last_message_timestamp, base_insertion_event_id=base_insertion_event_id
+                )
+            if (
+                mark_read
+                and not self.bridge.homeserver_software.is_hungry
+                and (puppet := await self.get_puppet())
+            ):
+                last_message = await DBMessage.get_most_recent(portal.fbid, portal.fb_receiver)
+                if last_message:
+                    await puppet.intent_for(portal).mark_read(portal.mxid, last_message.mxid)
+
+        if self.config["bridge.backfill.msc2716"]:
+            await portal.enqueue_immediate_backfill(self, 1)
+        return len(forward_messages) > 0
+
+    async def mute_room(self, portal: po.Portal, mute_until: int | None) -> None:
         if not self.config["bridge.mute_bridging"] or not portal or not portal.mxid:
             return
         puppet = await pu.Puppet.get_by_custom_mxid(self.mxid)
         if not puppet or not puppet.is_real_user:
             return
         if mute_until is not None and (mute_until < 0 or mute_until > int(time.time())):
             await puppet.intent.set_push_rule(
@@ -605,17 +888,14 @@
             try:
                 await puppet.intent.remove_push_rule(
                     PushRuleScope.GLOBAL, PushRuleKind.ROOM, portal.mxid
                 )
             except MNotFound:
                 pass
 
-    async def is_in_portal(self, portal: po.Portal) -> bool:
-        return await UserPortal.get(self.fbid, portal.fbid, portal.fb_receiver) is not None
-
     async def on_2fa_callback(self) -> str:
         if self.command_status and self.command_status.get("action", "") == "Login":
             future = self.loop.create_future()
             self.command_status["future"] = future
             self.command_status["next"] = enter_2fa_code
             await self.az.intent.send_notice(
                 self.command_status["room_id"],
@@ -706,14 +986,24 @@
         )
 
     # region Facebook event handling
 
     def start_listen(self) -> None:
         self.listen_task = asyncio.create_task(self._try_listen())
 
+    async def delayed_start_listen(self, sleep: int) -> None:
+        await asyncio.sleep(sleep)
+        if self.is_connected:
+            self.log.debug(
+                "Already reconnected before delay after MQTT reconnection error finished",
+            )
+        else:
+            self.log.debug("Reconnecting after MQTT connection error")
+            self.start_listen()
+
     def _disconnect_listener_after_error(self) -> None:
         try:
             self.mqtt.disconnect()
         except Exception:
             self.log.debug("Error disconnecting listener after error", exc_info=True)
 
     async def _save_seq_id_after_sleep(self) -> None:
@@ -733,15 +1023,15 @@
         else:
             self.log.trace("Not starting seq id save task (%s)", seq_id)
 
     def _update_region_hint(self, region_hint: str) -> None:
         self.log.debug(f"Got region hint {region_hint}")
         if region_hint:
             self.state.session.region_hint = region_hint
-            asyncio.create_task(self.save())
+            background_task.create(self.save())
 
     async def _try_listen(self) -> None:
         try:
             if not self.mqtt:
                 self.mqtt = AndroidMQTT(
                     self.state,
                     log=self.log.getChild("mqtt"),
@@ -753,14 +1043,17 @@
                 self.mqtt.connection_unauthorized_callback = self.on_connection_not_authorized
                 self.mqtt.enable_web_presence = self.config["bridge.presence_from_facebook"]
                 self.mqtt.add_event_handler(mqtt_t.Message, self.on_message)
                 self.mqtt.add_event_handler(mqtt_t.ExtendedMessage, self.on_message)
                 self.mqtt.add_event_handler(mqtt_t.NameChange, self.on_title_change)
                 self.mqtt.add_event_handler(mqtt_t.AvatarChange, self.on_avatar_change)
                 self.mqtt.add_event_handler(mqtt_t.UnsendMessage, self.on_message_unsent)
+                self.mqtt.add_event_handler(
+                    mqtt_t.DeltaRTCMultiwayMessage, self.on_delta_rtc_multiway_message
+                )
                 self.mqtt.add_event_handler(mqtt_t.ReadReceipt, self.on_message_seen)
                 self.mqtt.add_event_handler(mqtt_t.OwnReadReceipt, self.on_message_seen_self)
                 self.mqtt.add_event_handler(mqtt_t.Reaction, self.on_reaction)
                 self.mqtt.add_event_handler(mqtt_t.Presence, self.on_presence)
                 self.mqtt.add_event_handler(mqtt_t.AddMember, self.on_members_added)
                 self.mqtt.add_event_handler(mqtt_t.RemoveMember, self.on_member_removed)
                 self.mqtt.add_event_handler(mqtt_t.ThreadChange, self.on_thread_change)
@@ -774,14 +1067,27 @@
             self.is_connected = False
             if not self._is_refreshing and not self.shutdown:
                 await self.send_bridge_notice(
                     "Facebook Messenger connection closed without error",
                     state_event=BridgeStateEvent.UNKNOWN_ERROR,
                     error_code="fb-disconnected",
                 )
+        except MQTTReconnectionError as e:
+            self.log.warning(
+                f"Unexpected connection error: {e}, reconnecting in 1 minute",
+                exc_info=True,
+            )
+            await self.send_bridge_notice(
+                f"Error in listener: {e}",
+                important=True,
+                state_event=BridgeStateEvent.TRANSIENT_DISCONNECT,
+                error_code="fb-connection-error",
+            )
+            self._disconnect_listener_after_error()
+            background_task.create(self.delayed_start_listen(sleep=60))
         except (MQTTNotLoggedIn, MQTTNotConnected) as e:
             self.log.debug("Listen threw a Facebook error", exc_info=True)
             action = self.config["bridge.on_reconnection_fail.action"]
             action_name = "Not retrying!"
             if action == "reconnect":
                 action_name = "Retrying..."
             elif action == "refresh":
@@ -794,30 +1100,36 @@
             if action not in ("reconnect", "refresh"):
                 await self.send_bridge_notice(
                     message,
                     important=True,
                     state_event=BridgeStateEvent.UNKNOWN_ERROR,
                     error_code="fb-connection-error",
                 )
-            elif self.temp_disconnect_notices:
-                await self.send_bridge_notice(message)
+            else:
+                await self.send_bridge_notice(
+                    message,
+                    state_event=BridgeStateEvent.TRANSIENT_DISCONNECT,
+                    error_code="fb-no-mqtt",
+                )
+                if self.temp_disconnect_notices:
+                    await self.send_bridge_notice(message)
             if action in ("reconnect", "refresh"):
                 wait_for = self.config["bridge.on_reconnection_fail.wait_for"]
                 if wait_for:
                     await asyncio.sleep(get_interval(wait_for))
                 # Ensure a minimum of 120s between reconnection attempts, even if wait is disabled
                 sleep_time = self._prev_reconnect_fail_refresh + 120 - time.monotonic()
                 if not wait_for:
                     self.log.debug(f"Waiting {sleep_time:.3f} seconds before reconnecting")
                     await asyncio.sleep(sleep_time)
                 self._prev_reconnect_fail_refresh = time.monotonic()
                 if action == "refresh":
-                    asyncio.create_task(self.refresh())
+                    background_task.create(self.refresh())
                 else:
-                    asyncio.create_task(self.reconnect(fetch_user=True))
+                    background_task.create(self.reconnect(fetch_user=True))
             else:
                 self._disconnect_listener_after_error()
         except Exception:
             self.is_connected = False
             self.log.exception("Fatal error in listener")
             await self.send_bridge_notice(
                 "Fatal error in listener (see logs for more info)",
@@ -842,118 +1154,161 @@
         await self.push_bridge_state(BridgeStateEvent.CONNECTED)
 
     async def on_disconnect(self, evt: Disconnect) -> None:
         self.is_connected = False
         self._track_metric(METRIC_CONNECTED, False)
         if self.temp_disconnect_notices:
             await self.send_bridge_notice(f"Disconnected from Facebook Messenger: {evt.reason}")
-        await self.push_bridge_state(BridgeStateEvent.TRANSIENT_DISCONNECT, message=evt.reason)
 
     async def on_proxy_update(self, evt: ProxyUpdate | None = None) -> None:
         if self.client:
             self.client.setup_http()
+        if self.mqtt:
+            self.mqtt.setup_proxy()
+        if self.command_status:
+            self.command_status["api"].setup_http()
 
     def stop_listen(self) -> None:
         if self.mqtt:
             self.mqtt.disconnect()
         if self.listen_task:
             self.listen_task.cancel()
         self.mqtt = None
         self.listen_task = None
 
+    def stop_backfill_tasks(self) -> None:
+        if self._backfill_loop_task:
+            self._backfill_loop_task.cancel()
+            self._backfill_loop_task = None
+        if self._thread_sync_task:
+            self._thread_sync_task.cancel()
+            self._thread_sync_task = None
+
     async def on_logged_in(self, state: AndroidState) -> None:
         self.log.debug(f"Successfully logged in as {state.session.uid}")
         self.fbid = state.session.uid
         await self.push_bridge_state(BridgeStateEvent.CONNECTING)
         self.state = state
         self.client = AndroidAPI(
             state,
             log=self.log.getChild("api"),
             proxy_handler=self.proxy_handler,
+            on_proxy_update=self.on_proxy_update,
         )
         await self.save()
         try:
             self._logged_in_info = await self.client.fetch_logged_in_user(post_login=True)
             self._logged_in_info_time = time.monotonic()
+            self._is_logged_in = True
         except Exception:
             self.log.exception("Failed to fetch post-login info")
         self.stop_listen()
-        asyncio.create_task(self.post_login(is_startup=True))
+        self.stop_backfill_tasks()
+        background_task.create(self.post_login(is_startup=True, from_login=True))
 
     @async_time(METRIC_MESSAGE)
     async def on_message(self, evt: mqtt_t.Message | mqtt_t.ExtendedMessage) -> None:
         if isinstance(evt, mqtt_t.ExtendedMessage):
             reply_to = evt.reply_to_message
             evt = evt.message
         else:
             reply_to = None
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         puppet = await pu.Puppet.get_by_fbid(evt.metadata.sender)
-        await portal.backfill_lock.wait(evt.metadata.id)
         if not puppet.name:
             portal.schedule_resync(self, puppet)
         await portal.handle_facebook_message(self, puppet, evt, reply_to=reply_to)
 
     @async_time(METRIC_TITLE_CHANGE)
     async def on_title_change(self, evt: mqtt_t.NameChange) -> None:
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         sender = await pu.Puppet.get_by_fbid(evt.metadata.sender)
-        await portal.backfill_lock.wait("title change")
         await portal.handle_facebook_name(
             self, sender, evt.new_name, evt.metadata.id, evt.metadata.timestamp
         )
 
     @async_time(METRIC_AVATAR_CHANGE)
     async def on_avatar_change(self, evt: mqtt_t.AvatarChange) -> None:
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         sender = await pu.Puppet.get_by_fbid(evt.metadata.sender)
-        await portal.backfill_lock.wait("avatar change")
         await portal.handle_facebook_photo(
             self, sender, evt.new_avatar, evt.metadata.id, evt.metadata.timestamp
         )
 
     @async_time(METRIC_MESSAGE_SEEN)
     async def on_message_seen(self, evt: mqtt_t.ReadReceipt) -> None:
         puppet = await pu.Puppet.get_by_fbid(evt.user_id)
         portal = await po.Portal.get_by_thread(evt.thread, self.fbid, create=False)
         if portal and portal.mxid:
-            await portal.backfill_lock.wait(f"read receipt from {puppet.fbid}")
             await portal.handle_facebook_seen(self, puppet, evt.read_to)
 
     @async_time(METRIC_MESSAGE_SEEN)
     async def on_message_seen_self(self, evt: mqtt_t.OwnReadReceipt) -> None:
         puppet = await pu.Puppet.get_by_fbid(self.fbid)
         for thread in evt.threads:
             portal = await po.Portal.get_by_thread(thread, self.fbid, create=False)
             if portal:
-                await portal.backfill_lock.wait(f"read receipt from {puppet.fbid}")
                 await portal.handle_facebook_seen(self, puppet, evt.read_to)
 
     @async_time(METRIC_MESSAGE_UNSENT)
     async def on_message_unsent(self, evt: mqtt_t.UnsendMessage) -> None:
         portal = await po.Portal.get_by_thread(evt.thread, self.fbid, create=False)
         if portal and portal.mxid:
-            await portal.backfill_lock.wait(f"redaction of {evt.message_id}")
             puppet = await pu.Puppet.get_by_fbid(evt.user_id)
             await portal.handle_facebook_unsend(puppet, evt.message_id, timestamp=evt.timestamp)
 
+    peer_id_re = re.compile(r'"peer_id":"(\d+)"')
+    rtc_room_id_re = re.compile(r"ROOM:(\d+)")
+    rtc_room_id_to_peer_id: dict[str, int] = {}
+
+    @async_time(METRIC_DELTA_RTC_MULTIWAY_MESSAGE)
+    async def on_delta_rtc_multiway_message(self, evt: mqtt_t.DeltaRTCMultiwayMessage) -> None:
+        # The data is in a really annoying format (probably flatbuffers), so we are just parsing
+        # out the important bits manually.
+        decoded = base64.b64decode(evt.data).decode(encoding="unicode_escape")
+        rtc_room_id_match = self.rtc_room_id_re.search(decoded)
+        if not rtc_room_id_match:
+            return
+
+        if evt.event != "RING":
+            peer_id = self.rtc_room_id_to_peer_id.get(rtc_room_id_match.group(1))
+            if not peer_id:
+                return
+
+            portal = await po.Portal.get_by_fbid(peer_id, fb_receiver=self.fbid, create=False)
+            if portal and portal.mxid:
+                await portal.handle_facebook_call_hangup()
+
+            self.rtc_room_id_to_peer_id.pop(rtc_room_id_match.group(1), None)
+            return
+
+        peer_id_match = self.peer_id_re.search(decoded)
+        if not peer_id_match:
+            return
+        peer_id = int(peer_id_match.group(1))
+        self.rtc_room_id_to_peer_id[rtc_room_id_match.group(1)] = peer_id
+
+        portal = await po.Portal.get_by_fbid(peer_id, fb_receiver=self.fbid, create=False)
+        if portal and portal.mxid:
+            puppet = await pu.Puppet.get_by_fbid(peer_id)
+            await portal.handle_facebook_call(puppet)
+
     @async_time(METRIC_REACTION)
     async def on_reaction(self, evt: mqtt_t.Reaction) -> None:
         portal = await po.Portal.get_by_thread(evt.thread, self.fbid, create=False)
         if not portal or not portal.mxid:
             return
         puppet = await pu.Puppet.get_by_fbid(evt.reaction_sender_id)
-        await portal.backfill_lock.wait(f"reaction to {evt.message_id}")
         if evt.reaction is None:
             await portal.handle_facebook_reaction_remove(self, puppet, evt.message_id)
         else:
             await portal.handle_facebook_reaction_add(self, puppet, evt.message_id, evt.reaction)
 
     async def on_forced_fetch(self, evt: mqtt_t.ForcedFetch) -> None:
-        asyncio.create_task(self._try_on_forced_fetch(evt))
+        background_task.create(self._try_on_forced_fetch(evt))
 
     async def _try_on_forced_fetch(self, evt: mqtt_t.ForcedFetch) -> None:
         try:
             await self._on_forced_fetch(evt)
         except Exception:
             self.log.exception("Error in ForcedFetch handler")
 
@@ -979,36 +1334,32 @@
                 await PresenceUpdater.set_presence(
                     puppet, PresenceState.ONLINE if update.status == 2 else PresenceState.OFFLINE
                 )
 
     @async_time(METRIC_TYPING)
     async def on_typing(self, evt: mqtt_t.TypingNotification) -> None:
         portal = await po.Portal.get_by_fbid(evt.user_id, fb_receiver=self.fbid, create=False)
-        if portal and portal.mxid and not portal.backfill_lock.locked:
+        if portal and portal.mxid:
             puppet = await pu.Puppet.get_by_fbid(evt.user_id)
-            await puppet.intent.set_typing(
-                portal.mxid, is_typing=bool(evt.typing_status), timeout=10000
-            )
+            await puppet.intent.set_typing(portal.mxid, timeout=10000 if evt.typing_status else 0)
 
     @async_time(METRIC_MEMBERS_ADDED)
     async def on_members_added(self, evt: mqtt_t.AddMember) -> None:
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         if portal.mxid:
             sender = await pu.Puppet.get_by_fbid(evt.metadata.sender)
             users = [await pu.Puppet.get_by_fbid(user.id) for user in evt.users]
-            await portal.backfill_lock.wait("member add")
             await portal.handle_facebook_join(self, sender, users)
 
     @async_time(METRIC_MEMBER_REMOVED)
     async def on_member_removed(self, evt: mqtt_t.RemoveMember) -> None:
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         if portal.mxid:
             sender = await pu.Puppet.get_by_fbid(evt.metadata.sender)
             user = await pu.Puppet.get_by_fbid(evt.user_id)
-            await portal.backfill_lock.wait("member remove")
             await portal.handle_facebook_leave(self, sender, user)
 
     @async_time(METRIC_THREAD_CHANGE)
     async def on_thread_change(self, evt: mqtt_t.ThreadChange) -> None:
         portal = await po.Portal.get_by_thread(evt.metadata.thread, self.fbid)
         if not portal.mxid:
             return
@@ -1016,36 +1367,42 @@
         if evt.action == mqtt_t.ThreadChangeAction.NICKNAME:
             target = int(evt.action_data["participant_id"])
             puppet = await pu.Puppet.get_by_fbid(target)
             await portal.sync_per_room_nick(puppet, evt.action_data["nickname"])
         elif evt.action == mqtt_t.ThreadChangeAction.POLL:
             puppet = await pu.Puppet.get_by_fbid(evt.metadata.sender)
             await portal.handle_facebook_poll(puppet, evt)
+        elif evt.action == mqtt_t.ThreadChangeAction.CALL_LOG:
+            puppet = await pu.Puppet.get_by_fbid(evt.metadata.sender)
+            await portal.handle_facebook_group_call(puppet, evt)
 
         # TODO
         # elif evt.action == mqtt_t.ThreadChangeAction.ADMINS:
         #     sender = await pu.Puppet.get_by_fbid(evt.metadata.sender)
         #     user = await pu.Puppet.get_by_fbid(evt.action_data["TARGET_ID"])
         #     make_admin = evt.action_data["ADMIN_EVENT"] == "add_admin"
         #     # TODO does the ADMIN_TYPE data matter?
-        #     await portal.backfill_lock.wait("admin change")
         #     await portal.handle_facebook_admin(self, sender, user, make_admin)
         else:
             self.log.trace("Unhandled thread change: %s", evt)
 
     async def on_message_sync_error(self, evt: mqtt_t.MessageSyncError) -> None:
         self.stop_listen()
-        if evt == mqtt_t.MessageSyncError.QUEUE_NOT_FOUND:
+        if evt == mqtt_t.MessageSyncError.ERROR_QUEUE_TEMPORARY_NOT_AVAILABLE:
+            self.log.debug("Reconnecting in 30s after ERROR_QUEUE_TEMPORARY_NOT_AVAILABLE error")
+            await asyncio.sleep(30)
+            self.start_listen()
+        elif evt == mqtt_t.MessageSyncError.QUEUE_NOT_FOUND:
             self.log.debug("Resetting connect_token_hash due to QUEUE_NOT_FOUND error")
             self.connect_token_hash = None
             self.start_listen()
         else:
             self.log.error(f"Message sync error: {evt.value}, resyncing...")
             await self.send_bridge_notice(f"Message sync error: {evt.value}, resyncing...")
-            await self.sync_threads(start_listen=True)
+            await self.sync_recent_threads()
 
     def on_connection_not_authorized(self) -> None:
         self.log.debug("Stopping listener and reloading session after MQTT not authorized error")
         self.stop_listen()
-        asyncio.create_task(self.reload_session())
+        background_task.create(self.reload_session())
 
     # endregion
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/util/color_log.py` & `mautrix-facebook-0.5.0/mautrix_facebook/util/color_log.py`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/public.py` & `mautrix-facebook-0.5.0/mautrix_facebook/web/public.py`

 * *Files 4% similar despite different names*

```diff
@@ -27,37 +27,37 @@
 
 from maufbapi import AndroidAPI, AndroidState
 from maufbapi.http import IncorrectPassword, OAuthException, TwoFactorRequired
 from mautrix.types import UserID
 from mautrix.util.signed_token import verify_token
 
 from .. import puppet as pu, user as u
-from .segment_analytics import init as init_segment, track
+from ..segment_analytics import track
 
 
 class InvalidTokenError(Exception):
     pass
 
 
 class PublicBridgeWebsite:
     log: logging.Logger = logging.getLogger("mau.web.public")
     app: web.Application
     secret_key: str
     shared_secret: str
     ready_wait: asyncio.Future | None
 
     def __init__(
-        self, shared_secret: str, segment_key: str | None, loop: asyncio.AbstractEventLoop
+        self,
+        shared_secret: str,
+        loop: asyncio.AbstractEventLoop,
     ) -> None:
         self.app = web.Application()
         self.ready_wait = loop.create_future()
         self.secret_key = "".join(random.choices(string.ascii_lowercase + string.digits, k=64))
         self.shared_secret = shared_secret
-        if segment_key:
-            init_segment(segment_key)
         for path in (
             "whoami",
             "login",
             "login/prepare",
             "login/2fa",
             "login/check_approved",
             "login/approved",
@@ -171,14 +171,15 @@
     async def login_prepare(self, request: web.Request) -> web.Response:
         user = await self.check_token(request)
         state = user.generate_state()
         api = AndroidAPI(
             state,
             log=user.log.getChild("login-api"),
             proxy_handler=user.proxy_handler,
+            on_proxy_update=user.on_proxy_update,
         )
         user.command_status = {
             "action": "Login",
             "state": state,
             "api": api,
         }
         try:
@@ -230,14 +231,15 @@
             api: AndroidAPI = user.command_status["api"]
         else:
             state = user.generate_state()
             api = AndroidAPI(
                 state,
                 log=user.log.getChild("login-api"),
                 proxy_handler=user.proxy_handler,
+                on_proxy_update=user.on_proxy_update,
             )
             await api.mobile_config_sessionless()
 
         try:
             track(user, "$login_start")
             self.log.debug(f"Logging in as {email} for {user.mxid}")
             resp = await api.login(email, password=password, encrypted_password=encrypted_password)
@@ -250,14 +252,21 @@
                 f"Got 2-factor auth required login error with UID {e.uid} for {user.mxid}"
             )
             user.command_status = {
                 "action": "Login",
                 "state": state,
                 "api": api,
             }
+            track(
+                user,
+                "$login_2fa",
+                {
+                    "error_user_msg": e.user_message,
+                },
+            )
             return web.json_response(
                 {
                     "status": "two-factor",
                     "error": e.data,
                 },
                 headers=self._acao_headers,
             )
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/segment_analytics.py` & `mautrix-facebook-0.5.0/mautrix_facebook/segment_analytics.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,38 +1,41 @@
 from __future__ import annotations
 
-import asyncio
 import logging
 
 from yarl import URL
 import aiohttp
 
-from .. import user as u
+from mautrix.util import background_task
+
+from . import user as u
 
 log = logging.getLogger("mau.web.public.analytics")
 segment_url: URL = URL("https://api.segment.io/v1/track")
 http: aiohttp.ClientSession | None = None
 segment_key: str | None = None
+segment_user_id: str | None = None
 
 
 async def _track(user: u.User, event: str, properties: dict) -> None:
     await http.post(
         segment_url,
         json={
-            "userId": user.mxid,
+            "userId": segment_user_id or user.mxid,
             "event": event,
             "properties": {"bridge": "facebook", **properties},
         },
         auth=aiohttp.BasicAuth(login=segment_key, encoding="utf-8"),
     )
     log.debug(f"Tracked {event}")
 
 
 def track(user: u.User, event: str, properties: dict | None = None):
     if segment_key:
-        asyncio.create_task(_track(user, event, properties or {}))
+        background_task.create(_track(user, event, properties or {}))
 
 
-def init(key):
-    global segment_key, http
+def init(key, user_id: str | None = None):
+    global segment_key, segment_user_id, http
     segment_key = key
+    segment_user_id = user_id
     http = aiohttp.ClientSession()
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/asn1hex-1.1.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/asn1hex-1.1.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/htm-3.0.4.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/htm-3.0.4.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/jsbn.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/jsbn.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/milligram-1.4.1.min.css` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/milligram-1.4.1.min.css`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/normalize-8.0.1.min.css` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/normalize-8.0.1.min.css`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/preact-10.5.12.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/preact-10.5.12.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/rng.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/rng.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/rsa.min.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/rsa.min.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/lib/spinner.css` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/lib/spinner.css`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/api.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/api.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/app.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/app.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/login/crypto.js` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/login/crypto.js`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook/web/static/login.html` & `mautrix-facebook-0.5.0/mautrix_facebook/web/static/login.html`

 * *Files identical despite different names*

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook.egg-info/PKG-INFO` & `mautrix-facebook-0.5.0/mautrix_facebook.egg-info/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,17 +1,15 @@
 Metadata-Version: 2.1
 Name: mautrix-facebook
-Version: 0.4.1
+Version: 0.5.0
 Summary: A Matrix-Facebook Messenger puppeting bridge.
 Home-page: https://github.com/mautrix/facebook
 Author: Tulir Asokan
 Author-email: tulir@maunium.net
-License: UNKNOWN
 Project-URL: Changelog, https://github.com/mautrix/facebook/blob/master/CHANGELOG.md
-Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: License :: OSI Approved :: GNU Affero General Public License v3 or later (AGPLv3+)
 Classifier: Topic :: Communications :: Chat
 Classifier: Framework :: AsyncIO
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.8
@@ -49,9 +47,7 @@
 
 ### Features & Roadmap
 [ROADMAP.md](https://github.com/mautrix/facebook/blob/master/ROADMAP.md)
 contains a general overview of what is supported by the bridge.
 
 ## Discussion
 Matrix room: [`#facebook:maunium.net`](https://matrix.to/#/#facebook:maunium.net)
-
-
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook.egg-info/SOURCES.txt` & `mautrix-facebook-0.5.0/mautrix_facebook.egg-info/SOURCES.txt`

 * *Files 4% similar despite different names*

```diff
@@ -3,15 +3,14 @@
 MANIFEST.in
 README.md
 optional-requirements.txt
 pyproject.toml
 requirements.txt
 setup.py
 maufbapi/__init__.py
-maufbapi/proxy.py
 maufbapi/state.py
 maufbapi/http/__init__.py
 maufbapi/http/api.py
 maufbapi/http/base.py
 maufbapi/http/errors.py
 maufbapi/http/login.py
 maufbapi/http/post_login.py
@@ -44,51 +43,56 @@
 mautrix_facebook/config.py
 mautrix_facebook/example-config.yaml
 mautrix_facebook/get_version.py
 mautrix_facebook/matrix.py
 mautrix_facebook/portal.py
 mautrix_facebook/presence.py
 mautrix_facebook/puppet.py
+mautrix_facebook/segment_analytics.py
 mautrix_facebook/user.py
 mautrix_facebook/version.py
 mautrix_facebook.egg-info/PKG-INFO
 mautrix_facebook.egg-info/SOURCES.txt
 mautrix_facebook.egg-info/dependency_links.txt
 mautrix_facebook.egg-info/requires.txt
 mautrix_facebook.egg-info/top_level.txt
 mautrix_facebook/commands/__init__.py
 mautrix_facebook/commands/auth.py
 mautrix_facebook/commands/conn.py
 mautrix_facebook/commands/facebook.py
-mautrix_facebook/commands/handler.py
 mautrix_facebook/commands/typehint.py
 mautrix_facebook/db/__init__.py
+mautrix_facebook/db/backfill_queue.py
 mautrix_facebook/db/message.py
 mautrix_facebook/db/portal.py
 mautrix_facebook/db/puppet.py
 mautrix_facebook/db/reaction.py
 mautrix_facebook/db/user.py
 mautrix_facebook/db/user_portal.py
 mautrix_facebook/db/upgrade/__init__.py
 mautrix_facebook/db/upgrade/v01_initial_revision.py
 mautrix_facebook/db/upgrade/v02_message_oti.py
 mautrix_facebook/db/upgrade/v03_portal_meta_set.py
 mautrix_facebook/db/upgrade/v04_relay_mode.py
 mautrix_facebook/db/upgrade/v05_remove_communities.py
 mautrix_facebook/db/upgrade/v06_store_user_seq_id.py
 mautrix_facebook/db/upgrade/v07_store_reaction_timestamp.py
+mautrix_facebook/db/upgrade/v08_backfill_queue.py
+mautrix_facebook/db/upgrade/v09_portal_infinite_backfill.py
+mautrix_facebook/db/upgrade/v10_user_thread_sync_status.py
+mautrix_facebook/db/upgrade/v11_user_thread_sync_done_flag.py
+mautrix_facebook/db/upgrade/v12_puppet_contact_info_set.py
 mautrix_facebook/formatter/__init__.py
 mautrix_facebook/formatter/from_facebook.py
 mautrix_facebook/formatter/from_matrix.py
 mautrix_facebook/util/__init__.py
 mautrix_facebook/util/color_log.py
 mautrix_facebook/util/interval.py
 mautrix_facebook/web/__init__.py
 mautrix_facebook/web/public.py
-mautrix_facebook/web/segment_analytics.py
 mautrix_facebook/web/static/login.html
 mautrix_facebook/web/static/lib/asn1hex-1.1.min.js
 mautrix_facebook/web/static/lib/htm-3.0.4.min.js
 mautrix_facebook/web/static/lib/jsbn.min.js
 mautrix_facebook/web/static/lib/milligram-1.4.1.min.css
 mautrix_facebook/web/static/lib/normalize-8.0.1.min.css
 mautrix_facebook/web/static/lib/preact-10.5.12.min.js
```

### Comparing `mautrix-facebook-0.4.1/mautrix_facebook.egg-info/requires.txt` & `mautrix-facebook-0.5.0/mautrix_facebook.egg-info/requires.txt`

 * *Files 6% similar despite different names*

```diff
@@ -1,40 +1,40 @@
 aiohttp<4,>=3
 asyncpg<0.28,>=0.20
 commonmark<0.10,>=0.8
-mautrix<0.19,>=0.18.2
+mautrix<0.20,>=0.19.16
 paho-mqtt<2,>=1.5
 pycryptodome<4,>=3
 python-magic<0.5,>=0.4
 ruamel.yaml<0.18,>=0.15.94
 yarl<2,>=1
 zstandard
 
 [all]
 aiohttp-socks
-aiosqlite<0.18,>=0.16
+aiosqlite<0.20,>=0.16
 pillow<10,>=4
-prometheus_client<0.16,>=0.6
+prometheus_client<0.18,>=0.6
 pysocks
 python-olm<4,>=3
 setuptools
 unpaddedbase64<3,>=1
 
 [animated_stickers]
 pillow<10,>=4
 
 [e2be]
 python-olm<4,>=3
 unpaddedbase64<3,>=1
 
 [metrics]
-prometheus_client<0.16,>=0.6
+prometheus_client<0.18,>=0.6
 
 [proxy]
 aiohttp-socks
 pysocks
 
 [sqlite]
-aiosqlite<0.18,>=0.16
+aiosqlite<0.20,>=0.16
 
 [weblogin]
 setuptools
```

### Comparing `mautrix-facebook-0.4.1/setup.py` & `mautrix-facebook-0.5.0/setup.py`

 * *Files identical despite different names*

